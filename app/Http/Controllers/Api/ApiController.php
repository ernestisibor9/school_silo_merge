<?php

namespace App\Http\Controllers\Api;

use App\Http\Controllers\Controller;
use App\Mail\SSSMails;
use App\Models\announcements;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\Mail;
use Illuminate\Support\Facades\Storage;
use Illuminate\Support\Facades\Log;
use Tymon\JWTAuth\Facades\JWTAuth;
use Illuminate\Support\Str;
use App\Models\password_reset_tokens;
use App\Models\school;
use App\Models\User;
use App\Models\files;
use App\Models\msg;
use App\Models\msgthread;
use App\Models\partner_basic_data;
use App\Models\partner_financial_data;
use App\Models\partner_general_data;
use App\Models\school_basic_data;
use App\Models\school_web_data;
use App\Models\school_general_data;
use App\Models\school_prop_data;
use App\Models\school_app_fee;
use App\Models\silo_user;
use App\Models\pay;
use App\Models\payhead;
use App\Models\subaccount_split;
use App\Models\broadsheet_control;

use App\Models\clspay;
use App\Models\auto_comment_template;
use App\Models\accts;
use App\Models\afee;
use App\Models\afeerec;
use App\Models\acct_pref;
use App\Models\payments;
use App\Models\attendance;
use App\Models\sub_account;
use App\Models\cls;
use App\Models\staff_role;
use App\Models\sch_staff_role;
use App\Models\class_subj;
use App\Models\sch_grade;
use App\Models\sch_cls;
use App\Models\school_class;
use App\Models\sch_mark;
use App\Models\std_score;
use App\Models\arm_result_conf;
use App\Models\subj;
use App\Models\subject_dest;
use App\Models\payment_instruction;
use App\Models\student_subj;
use App\Models\result_meta;
use App\Models\staff_subj;
use App\Models\staff_class;
use App\Models\staff_class_arm;
use App\Models\sesn;
use App\Models\trm;
use App\Models\student;
use App\Models\old_student;
use App\Models\student_psy;
use App\Models\student_res;
use App\Models\student_sub_res;
use App\Models\old_staff;
use App\Models\student_basic_data;
use App\Models\student_medical_data;
use App\Models\student_parent_data;
use App\Models\student_academic_data;
use App\Models\staff;
use App\Models\alumni;
use App\Models\ex_staff;
use App\Models\curriculum;
use App\Models\lesson_plan;
use App\Models\lesson_note;
use App\Models\topic;
use App\Models\sub_topic;
use App\Models\cummulative_comment;

use App\Models\staff_basic_data;
use App\Models\staff_prof_data;
use App\Models\school_grade_data;
use App\Models\payment_refs;
use App\Models\acceptance_acct;
use App\Models\acceptance_sub_acct;
use App\Models\application_acct;
use App\Models\application_sub_acct;
use App\Models\vendor;
use App\Models\expense;
use App\Models\ext_expenditure;
use App\Models\in_expenditure;
use App\Models\school_news_data;
use Illuminate\Support\Facades\Http;
use Illuminate\Support\Facades\DB;
use Illuminate\Support\Facades\Auth;
use Illuminate\Support\Facades\Hash;



/**
 * @OA\Info(
 *    title="SCHOOLSILO API | Stable Shield Solutions",
 *    version="1.0.0",
 *    description="Backend for the SCHOOLSILO project. Powered by Stable Shield Solutions",
 *    @OA\Contact(
 *        email="support@stableshield.com",
 *        name="API Support"
 *    ),
 *    @OA\License(
 *        name="Stable Shield API License",
 *        url="http://stableshield.com/api-licenses"
 *    )
 * )
 */


class ApiController extends Controller
{

    /**
     * @OA\Post(
     *     path="/api/registerSchool",
     *     tags={"Unprotected"},
     *     summary="Register a new school",
     *     operationId="registerSchool",
     *     @OA\RequestBody(
     *         required=true,
     *         @OA\JsonContent(
     *             type="object",
     *             required={"email","name","sbd","sch3","password"},
     *             @OA\Property(property="email", type="string", format="email"),
     *             @OA\Property(property="name", type="string"),
     *             @OA\Property(property="sbd", type="string", description="Sub-Domain ID"),
     *             @OA\Property(property="sch3", type="string", description="3-letter acronym for the school"),
     *             @OA\Property(property="password", type="string", description="The password for the school")
     *         )
     *     ),
     *     @OA\Response(response=200, description="School registered successfully")
     * )
     */



    public function registerSchool(Request $request)
    {
        //Data validation
        $request->validate([
            "email" => "required|email|unique:users,email",
            "password" => "required",
            "name" => "required",
            "sbd" => "required",
            "sch3" => "required",
        ]);
        if (strlen($request->password) < 6) {
            return response()->json([
                "status" => false,
                "message" => "Password must be at least 6 char",
            ], 400);
        }
        $typ = 's';
        $usr = User::where("typ", $typ)->where("email", $request->email)->first();
        if (!$usr) {
            $usr = User::create([
                "email" => $request->email,
                "typ" => $typ,
                "verif" => '0',
                "password" => bcrypt($request->password),
            ]);
            $count = school::count() + 1;
            school::create([
                "sid" => strval($usr->id),
                "name" => $request->name,
                "sbd" => $request->sbd,
                "sch3" => $request->sch3,
                "count" => strval($count),
                "s_web" => '0',
                "s_info" => '0',

                "cssn" => '0',
                "ctrm" => '0',
                "ctrmn" => '0',
            ]);
            $code = Str::random(6);
            $eml = $request->email;
            password_reset_tokens::updateOrCreate(
                ['email' => $eml],
                ['token' => $code]
            );
            $schid = strval($usr->id);
            $lnk = env('API_URL') . '/api/verifyEmail/' . $typ . '/' . $code . '/' . $schid;
            // Wrap the email sending logic in a try-catch block
            try {
                $data = [
                    'name' => $request->name,
                    'subject' => 'Verify Your Email',
                    'body' => 'Please use the link below to verify your email. Welcome to School Silo. If the link isnt clickable, please copy the link to your browser. If this arrived in spam folder, please mark as Not Spam. ' . $lnk,
                    'link' => $lnk,
                ];
                Mail::to($eml)->send(new SSSMails($data));
            } catch (\Exception $e) {
                // Log the email error, but don't stop the process
                Log::error('Failed to send email: ' . $e->getMessage());
            }


            $token = JWTAuth::attempt([
                "email" => $request->email,
                "password" => $request->password,
            ]);
            return response()->json([
                "status" => true,
                "message" => "User created successfully",
                "token" => $token,
            ]);
        }
        return response()->json([
            "status" => false,
            "message" => "Account already exists",
        ], 400);
    }

    /**
     * @OA\Post(
     *     path="/api/schoolLogin",
     *     tags={"Unprotected"},
     *     summary="School Login to the application. NOTE:: You get both pld and sch (with sch containing more info)",
     *     @OA\RequestBody(
     *         required=true,
     *         @OA\JsonContent(
     *             type="object",
     *             @OA\Property(property="email", type="string", format="email"),
     *             @OA\Property(property="password", type="string"),
     *         )
     *     ),
     *     @OA\Response(
     *         response="200",
     *         description="Login successful",
     *         @OA\JsonContent(
     *             type="object",
     *             @OA\Property(property="token", type="string", example="your-jwt-token-here", description="This will contain a JWT token that must be passed with consequent request using bearer token"),
     *         )
     *     ),
     * )
     */
    public function schoolLogin(Request $request)
    {
        //Data validation
        $request->validate([
            "email" => "required|email",
            "password" => "required",
        ]);
        $typ = 's';
        $usr = User::where("typ", $typ)->where("email", $request->email)->first();
        if ($usr) {
            $token = JWTAuth::attempt([
                "email" => $request->email,
                "password" => $request->password,
            ]);
            if (!empty($token)) {
                return response()->json([
                    "status" => true,
                    "message" => "Login successful",
                    "token" => $token,
                    "pld" => $usr,
                ]);
            }
        }
        // Respond
        return response()->json([
            "status" => false,
            "message" => "Invalid login details",
        ], 400);
    }

    /**
     * @OA\Get(
     *     path="/api/getSchool/{uid}",
     *     tags={"Unprotected"},
     *     summary="Get a particular School by their ID",
     *     description="Use this endpoint to Get a particular School by their ID",
     *     @OA\Parameter(
     *         name="uid",
     *         in="path",
     *         required=true,
     *         description="ID of the school",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Response(response="200", description="Success", @OA\JsonContent()),
     *     @OA\Response(response="401", description="Unauthorized"),
     * )
     */
    public function getSchool($uid)
    {
        $sch = school::where('sid', $uid)->first();
        return response()->json([
            "status" => true,
            "message" => "Success",
            "pld" => $sch,
        ]);
    }

    /**
     * @OA\Get(
     *     path="/api/getSchoolBySBD/{sbd}",
     *     tags={"Unprotected"},
     *     summary="Get a particular School by their Subdomain ID",
     *     description="Use this endpoint to Get a particular School by their Subdomain ID",
     *     @OA\Parameter(
     *         name="sbd",
     *         in="path",
     *         required=true,
     *         description="SubDomain ID",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Response(response="200", description="Success", @OA\JsonContent()),
     *     @OA\Response(response="401", description="Unauthorized"),
     * )
     */
    public function getSchoolBySBD($sbd)
    {
        $sch = school::where('sbd', $sbd)->first();
        return response()->json([
            "status" => true,
            "message" => "Success",
            "pld" => $sch,
        ]);
    }

    /**
     * @OA\Post(
     *     path="/api/sendEmailVerificationLink",
     *     tags={"Api"},
     *     summary="Send a verification code to user email. Only call after user has logged in",
     *     description="Use this endpoint to verify user email. Only call after user has logged in",
     *     security={{"bearerAuth": {}}},
     *     @OA\RequestBody(
     *         required=true,
     *         @OA\JsonContent(
     *             type="object",
     *             @OA\Property(property="email", type="string"),
     *             @OA\Property(property="schid", type="string"),
     *             @OA\Property(property="typ", type="string"),
     *         )
     *     ),
     *     @OA\Response(response="200", description="Success"),
     *     @OA\Response(response="401", description="Unauthorized"),
     * )
     */
    public function sendEmailVerificationLink(Request $request)
    {
        $request->validate([
            "schid" => "required",
            "email" => "required",
            "typ" => "required",
        ]);
        $eml = $request->email;
        $typ = $request->typ;
        $code = Str::random(6);
        password_reset_tokens::updateOrCreate(
            ['email' => $eml],
            ['token' => $code]
        );
        $lnk = env('API_URL') . '/api/verifyEmail/' . $typ . '/' . $code . '/' . $request->schid;
        // Wrap the email sending logic in a try-catch block
        try {
            $data = [
                'name' => 'SCHOOL-SILO USER',
                'subject' => 'Verify Your Email',
                'body' => 'Please use the link below to verify your email. If the link isnt clickable, please copy the link to your browser. If this arrived in spam folder, please mark as Not Spam. ' . $lnk,
                'link' => $lnk,
            ];

            Mail::to($eml)->send(new SSSMails($data));
        } catch (\Exception $e) {
            // Log the email error, but don't stop the process
            Log::error('Failed to send email: ' . $e->getMessage());
        }


        return response()->json([
            "status" => true,
            "message" => "Link sent to mail",
        ]);
        return response()->json([
            "status" => false,
            "message" => "Must Login User First",
        ], 400);
    }

    /**
     * @OA\Get(
     *     path="/api/verifyEmail/{typ}/{code}/{schid}",
     *     tags={"Unprotected"},
     *     summary="Verify email",
     *     description="Verify email. Usually called by user from their mail",
     *     @OA\Parameter(
     *         name="typ",
     *         in="path",
     *         required=true,
     *         description="Type of user",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Parameter(
     *         name="code",
     *         in="path",
     *         required=true,
     *         description="The Code",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Parameter(
     *         name="schid",
     *         in="path",
     *         required=true,
     *         description="School ID",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Response(response="200", description="Password reset token sent to mail"),
     * )
     */
    public function verifyEmail($typ, $code, $schid)
    {
        $pld = password_reset_tokens::where("token", $code)->first();
        if ($pld) {
            $eml = $pld->email;
            $usr = User::where("email", $eml)->where('typ', $typ)->first();
            if ($usr) {
                $usr->update([
                    "verif" => '1',
                ]);
                $pld->delete();
                if ($typ == 'a') { //An Admin
                    return redirect()->away(env('PORTAL_URL') . '/adminLogin');
                }
                if ($typ == 'p') { //A Partner
                    return redirect()->away(env('PORTAL_URL') . '/partnerLogin');
                }
                if ($typ == 's') { //A School
                    return redirect()->away(env('PORTAL_URL') . '/schoolLogin');
                }
                if ($typ == 'z') { //A Student
                    return redirect()->away(env('PORTAL_URL') . '/studentLogin' . '/' . $schid);
                }
                if ($typ == 'w') { //A Staff
                    return redirect()->away(env('PORTAL_URL') . '/staffLogin' . '/' . $schid);
                }
                return response()->json([
                    "status" => true,
                    "message" => "Success. Please login again"
                ]);
            }
            return response()->json([
                "status" => false,
                "message" => "User not found",
            ], 400);
        }
        return response()->json([
            "status" => false,
            "message" => "Invalid Code. Please Try Login Again",
        ], 400);
    }

    /**
     * @OA\Post(
     *     path="/api/sendPasswordResetEmail",
     *     tags={"Unprotected"},
     *     summary="Send reset email",
     *     @OA\RequestBody(
     *         required=true,
     *         @OA\JsonContent(
     *             type="object",
     *             @OA\Property(property="email", type="string", format="email"),
     *             @OA\Property(property="schid", type="string"),
     *             @OA\Property(property="typ", type="string", description="For school, pass s"),
     *         )
     *     ),
     *     @OA\Response(response="200", description="Password reset token sent to mail"),
     * )
     */
    public function sendPasswordResetEmail(Request $request)
    {
        //Data validation
        $request->validate([
            "email" => "required",
            "typ" => "required",
            "schid" => "required",
        ]);
        $typ = $request->typ;
        $schid = $request->schid;
        $usr = User::where("email", $request->email)->where('typ', $typ)->first();
        if ($usr) {
            $eml = $usr->email;
            $token = Str::random(60); //Random reset token
            password_reset_tokens::updateOrCreate(
                ['email' => $eml],
                ['token' => $token]
            );
            // Wrap the email sending logic in a try-catch block
            try {
                $data = [
                    'name' => 'SCHOOLSILO USER',
                    'subject' => 'Reset your SCHOOLSILO password',
                    'body' => 'Please go to this link to reset your password. It will expire in 1 hour. . If the link isnt clickable, please copy the link to your browser. If this arrived in spam folder, please mark as Not Spam.',
                    'link' => env('PORTAL_URL') . '/resetPassword' . '/' . $request->typ . '/' . $token . '/' . $schid,
                ];

                Mail::to($eml)->send(new SSSMails($data));
            } catch (\Exception $e) {
                // Log the email error, but don't stop the process
                Log::error('Failed to send email: ' . $e->getMessage());
            }


            return response()->json([
                "status" => true,
                "message" => "Password reset link sent to mail",
            ]);
        }


        // Respond
        return response()->json([
            "status" => false,
            "message" => "User not found",
        ], 400);
    }

    /**
     * @OA\Post(
     *     path="/api/resetPassword",
     *     tags={"Unprotected"},
     *     summary="change user password",
     *     @OA\RequestBody(
     *         required=true,
     *         @OA\JsonContent(
     *             type="object",
     *             @OA\Property(property="token", type="string"),
     *             @OA\Property(property="password", type="string"),
     *             @OA\Property(property="typ", type="string", description="For school, pass s"),
     *         )
     *     ),
     *     @OA\Response(response="200", description="Password reset token sent to mail"),
     * )
     */
    public function resetPassword(Request $request)
    {
        //Data validation
        $request->validate([
            "token" => "required",
            "password" => "required",
            "typ" => "required",
        ]);
        $pld = password_reset_tokens::where("token", "=", $request->token)->first();
        if ($pld) {
            $email = $pld->email;
            $usr = User::where("email", $email)->where("typ", $request->typ)->first();
            if ($usr) {
                $usr->update([
                    "password" => bcrypt($request->password),
                ]);
                $pld->delete();
                return response()->json([
                    "status" => true,
                    "message" => "Success. Please login again"
                ]);
            }
            return response()->json([
                "status" => false,
                "message" => "User not found",
            ], 400);
        }
        return response()->json([
            "status" => false,
            "message" => "Denied. Invalid/Expired Token",
        ], 400);
    }



    /**
     * @OA\Post(
     *     path="/api/setSchoolWebData",
     *     tags={"Api"},
     *     security={{"bearerAuth": {}}},
     *     summary="Set school website data",
     *     @OA\RequestBody(
     *         required=true,
     *         @OA\JsonContent(
     *             type="object",
     *             @OA\Property(property="user_id", type="string"),
     *             @OA\Property(property="sname", type="string"),
     *             @OA\Property(property="color", type="string"),
     *             @OA\Property(property="addr", type="string"),
     *             @OA\Property(property="country", type="string"),
     *             @OA\Property(property="state", type="string"),
     *             @OA\Property(property="lga", type="string"),
     *             @OA\Property(property="phn", type="string"),
     *             @OA\Property(property="eml", type="string"),
     *             @OA\Property(property="vision", type="string"),
     *             @OA\Property(property="values", type="string"),
     *             @OA\Property(property="year", type="string"),
     *             @OA\Property(property="about", type="string"),
     *             @OA\Property(property="motto", type="string"),
     *             @OA\Property(property="fb", type="string"),
     *             @OA\Property(property="isg", type="string"),
     *             @OA\Property(property="yt", type="string"),
     *             @OA\Property(property="wh", type="string"),
     *             @OA\Property(property="lkd", type="string"),
     *             @OA\Property(property="tw", type="string"),
     *         )
     *     ),
     *     @OA\Response(response="200", description="School data set successfully"),
     *     @OA\Response(response="400", description="Validation error"),
     * )
     */
    public function setSchoolWebData(Request $request)
    {
        //Data validation
        $request->validate([
            "user_id" => "required",
            "sname" => "required",
            'color' => 'required',
            'addr' => 'required',
            'country' => 'required',
            'state' => 'required',
            'lga' => 'required',
            'phn' => 'required',
            'eml' => 'required',
            'vision' => 'required',
            'values' => 'required',
            'year' => 'required',
            'about' => 'required',
            'motto' => 'required',
            'fb' => 'required',
            'isg' => 'required',
            'yt' => 'required',
            'wh' => 'required',
            'lkd' => 'required',
            'tw' => 'required',
        ]);
        school_web_data::updateOrCreate(
            ["user_id" => $request->user_id,],
            [
                "sname" => $request->sname,
                "color" => $request->color,
                'addr' => $request->addr,
                'country' => $request->country,
                'state' => $request->state,
                'lga' => $request->lga,
                'phn' => $request->phn,
                'eml' => $request->eml,
                'vision' => $request->vision,
                'values' => $request->values,
                'year' => $request->year,
                'about' => $request->about,
                'motto' => $request->motto,
                'fb' => $request->fb,
                'isg' => $request->isg,
                'yt' => $request->yt,
                'wh' => $request->wh,
                'lkd' => $request->lkd,
                'tw' => $request->tw,
            ]
        );
        school::where('sid', $request->user_id)->update([
            "s_web" => '1'
        ]);
        return response()->json([
            "status" => true,
            "message" => "Success",
        ]);
    }

    /**
     * @OA\Get(
     *     path="/api/getSchoolWebInfo/{uid}",
     *     tags={"Unprotected"},
     *     summary="Get School Website Info",
     *     description="Use this endpoint to get website information about a school.",
     *     @OA\Parameter(
     *         name="uid",
     *         in="path",
     *         required=true,
     *         description="User Id of the School",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Response(response="200", description="Success", @OA\JsonContent()),
     *     @OA\Response(response="401", description="Unauthorized"),
     * )
     */
    public function getSchoolWebInfo($uid)
    {
        $pld = school_web_data::where("user_id", $uid)->first();
        return response()->json([
            "status" => true,
            "message" => "Success",
            "pld" => $pld,
        ]);
    }

    /**
     * @OA\Get(
     *     path="/api/getSchoolWebInfoBySBD/{sbd}",
     *     tags={"Unprotected"},
     *     summary="Get School Website Info using the subdomain ID",
     *     description="Use this endpoint to get website information about a school by SBD.",
     *     @OA\Parameter(
     *         name="sbd",
     *         in="path",
     *         required=true,
     *         description="Subdomain Id of the School",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Response(response="200", description="Success", @OA\JsonContent()),
     *     @OA\Response(response="401", description="Unauthorized"),
     * )
     */
    public function getSchoolWebInfoBySBD($sbd)
    {
        $sch = school::where('sbd', $sbd)->first();
        $pld = null;
        if ($sch) {
            $pld = school_web_data::where("user_id", $sch->sid)->first();
        }
        return response()->json([
            "status" => true,
            "message" => "Success",
            "pld" => $pld,
            "sch" => $sch,
        ]);
    }

    /**
     * @OA\Post(
     *     path="/api/setSchool",
     *     tags={"Api"},
     *     security={{"bearerAuth": {}}},
     *     summary="Set school data",
     *     @OA\RequestBody(
     *         required=true,
     *         @OA\JsonContent(
     *             type="object",
     *             @OA\Property(property="user_id", type="string"),
     *             @OA\Property(property="sname", type="string"),
     *             @OA\Property(property="phn", type="string"),
     *             @OA\Property(property="eml", type="string", format="email"),
     *             @OA\Property(property="pcode", type="string"),
     *             @OA\Property(property="pay", type="string", description="Has paid reg. fee? pass 0 or 1"),
     *             @OA\Property(property="state", type="string"),
     *             @OA\Property(property="lga", type="string"),
     *             @OA\Property(property="addr", type="string"),
     *             @OA\Property(property="vision", type="string"),
     *             @OA\Property(property="mission", type="string"),
     *             @OA\Property(property="values", type="string"),
     *             @OA\Property(property="pfname", type="string"),
     *             @OA\Property(property="pmname", type="string"),
     *             @OA\Property(property="plname", type="string"),
     *             @OA\Property(property="psex", type="string"),
     *             @OA\Property(property="pphn", type="string"),
     *             @OA\Property(property="paddr", type="string"),
     *             @OA\Property(property="peml", type="string", format="email"),
     *         )
     *     ),
     *     @OA\Response(response="200", description="School data set successfully"),
     *     @OA\Response(response="400", description="Validation error"),
     * )
     */
    public function setSchool(Request $request)
    {
        //Data validation
        $request->validate([
            "user_id" => "required",
            "sname" => "required",
            "phn" => "required",
            "eml" => "required",
            "pcode" => "required",
            "pay" => "required",
            "state" => "required",
            "lga" => "required",
            "addr" => "required",
            "vision" => "required",
            "mission" => "required",
            "values" => "required",
            "pfname" => "required",
            "plname" => "required",
            "psex" => "required",
            "pphn" => "required",
            "paddr" => "required",
            "peml" => "required|email",
        ]);
        school_basic_data::updateOrCreate(
            ["user_id" => $request->user_id,],
            [
                "sname" => $request->sname,
                "phn" => $request->phn,
                "eml" => $request->eml,
                "pcode" => $request->pcode,
                "pay" => $request->pay,
            ]
        );
        school_general_data::updateOrCreate(
            ["user_id" => $request->user_id,],
            [
                "state" => $request->state,
                "lga" => $request->lga,
                "addr" => $request->addr,
                "vision" => $request->vision,
                "mission" => $request->mission,
                "values" => $request->values,
            ]
        );
        school_prop_data::updateOrCreate(
            ["user_id" => $request->user_id,],
            [
                "pfname" => $request->pfname,
                "pmname" => $request->pmname,
                "plname" => $request->plname,
                "psex" => $request->psex,
                "pphn" => $request->pphn,
                "paddr" => $request->paddr,
                "peml" => $request->peml,
            ]
        );
        school::where('sid', $request->user_id)->update([
            "s_info" => '1'
        ]);
        return response()->json([
            "status" => true,
            "message" => "Success",
        ]);
    }


    /**
     * @OA\Get(
     *     path="/api/getSchoolBasicInfo/{uid}",
     *     tags={"Api"},
     *     security={{"bearerAuth": {}}},
     *     summary="Get School Basic Info",
     *     description="Use this endpoint to get basic information about a school.",
     *     @OA\Parameter(
     *         name="uid",
     *         in="path",
     *         required=true,
     *         description="User Id of the School",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Response(response="200", description="Success", @OA\JsonContent()),
     *     @OA\Response(response="401", description="Unauthorized"),
     * )
     */
    public function getSchoolBasicInfo($uid)
    {
        $pld = school_basic_data::where("user_id", $uid)->first();
        return response()->json([
            "status" => true,
            "message" => "Success",
            "pld" => $pld,
        ]);
    }

    /**
     * @OA\Post(
     *     path="/api/setSchoolLatestNews",
     *     tags={"Api"},
     *     security={{"bearerAuth": {}}},
     *     summary="Set school news data",
     *     @OA\RequestBody(
     *         required=true,
     *         @OA\JsonContent(
     *             type="object",
     *             @OA\Property(property="user_id", type="string"),
     *             @OA\Property(property="title", type="string"),
     *             @OA\Property(property="body", type="string"),
     *         )
     *     ),
     *     @OA\Response(response="200", description="School data set successfully"),
     *     @OA\Response(response="400", description="Validation error"),
     * )
     */
    public function setSchoolLatestNews(Request $request)
    {
        //Data validation
        $request->validate([
            "user_id" => "required",
            "title" => "required",
            "body" => "required",
        ]);
        school_news_data::updateOrCreate(
            ["user_id" => $request->user_id,],
            [
                "title" => $request->title,
                "body" => $request->body,
            ]
        );
        return response()->json([
            "status" => true,
            "message" => "Success",
        ]);
    }


    /**
     * @OA\Get(
     *     path="/api/getSchoolLatestNews/{uid}",
     *     tags={"Unprotected"},
     *     summary="Get School Latest News Info",
     *     description="Use this endpoint to get Latest News information about a school.",
     *     @OA\Parameter(
     *         name="uid",
     *         in="path",
     *         required=true,
     *         description="User Id of the School",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Response(response="200", description="Success", @OA\JsonContent()),
     *     @OA\Response(response="401", description="Unauthorized"),
     * )
     */
    public function getSchoolLatestNews($uid)
    {
        $pld = school_news_data::where("user_id", $uid)->first();
        return response()->json([
            "status" => true,
            "message" => "Success",
            "pld" => $pld,
        ]);
    }

    /**
     * @OA\Get(
     *     path="/api/getSchoolGeneralInfo/{uid}",
     *     tags={"Api"},
     *     summary="Get School General Info",
     *     description="Use this endpoint to get general information about a school.",
     *     security={{"bearerAuth": {}}},
     *     @OA\Parameter(
     *         name="uid",
     *         in="path",
     *         required=true,
     *         description="User Id",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Response(response="200", description="Success", @OA\JsonContent()),
     *     @OA\Response(response="401", description="Unauthorized"),
     * )
     */
    public function getSchoolGeneralInfo($uid)
    {
        $pld = school_general_data::where("user_id", $uid)->first();
        return response()->json([
            "status" => true,
            "message" => "Success",
            "pld" => $pld,
        ]);
    }

    /**
     * @OA\Post(
     *     path="/api/setSchoolAppFee",
     *     tags={"Api"},
     *     security={{"bearerAuth": {}}},
     *     summary="Set or update school application fee for a student (per session & term)",
     *
     *     @OA\RequestBody(
     *         required=true,
     *         @OA\JsonContent(
     *             type="object",
     *             required={"sid", "fee", "ssn", "trm"},
     *             @OA\Property(property="sid", type="string", example="22", description="Student ID"),
     *             @OA\Property(property="fee", type="string", example="5000", description="Application fee amount"),
     *             @OA\Property(property="ssn", type="string", example="2025", description="Session ID"),
     *             @OA\Property(property="trm", type="string", example="1", description="Term ID")
     *         )
     *     ),
     *
     *     @OA\Response(
     *         response=200,
     *         description="Application fee saved successfully",
     *         @OA\JsonContent(
     *             @OA\Property(property="status", type="boolean", example=true),
     *             @OA\Property(property="message", type="string", example="Success")
     *         )
     *     ),
     *
     *     @OA\Response(
     *         response=400,
     *         description="Validation error",
     *         @OA\JsonContent(
     *             @OA\Property(property="status", type="boolean", example=false),
     *             @OA\Property(property="message", type="string", example="Validation failed")
     *         )
     *     )
     * )
     */

    public function setSchoolAppFee(Request $request)
    {
        //Data validation
        $request->validate([
            "sid" => "required",
            "fee" => "required",
            "ssn" => "required",
            "trm" => "required",
        ]);
        school_app_fee::updateOrCreate(
            [
                "sid" => $request->sid,
                "ssn" => $request->ssn,
                "trm" => $request->trm,

            ],
            [
                "fee" => $request->fee,
            ]
        );
        return response()->json([
            "status" => true,
            "message" => "Success",
        ]);
    }

    /**
     * @OA\Get(
     *     path="/api/getSchoolAppFee/{uid}",
     *     summary="Get school application fee by school ID",
     *     description="Fetches the application fee for a school, with optional filtering by session (ssn) and term (trm).",
     *     operationId="getSchoolAppFee",
     *     tags={"Api"},
     *    security={{"bearerAuth": {}}},
     *
     *     @OA\Parameter(
     *         name="uid",
     *        in="path",
     *         required=true,
     *         description="School ID",
     *         @OA\Schema(type="integer")
     *     ),
     *
     *     @OA\Parameter(
     *         name="ssn",
     *         in="query",
     *         required=false,
     *         description="Session filter (optional)",
     *         @OA\Schema(type="integer", example=2025)
     *     ),
     *
     *     @OA\Parameter(
     *         name="trm",
     *         in="query",
     *         required=false,
     *         description="Term filter (optional)",
     *         @OA\Schema(type="integer", example=1)
     *     ),
     *
     *     @OA\Response(
     *         response=200,
     *         description="Successful Response",
     *         @OA\JsonContent(
     *             @OA\Property(property="status", type="boolean", example=true),
     *             @OA\Property(property="message", type="string", example="Success"),
     *             @OA\Property(
     *                 property="pld",
     *                 type="object",
     *                 description="Application fee record",
     *                 nullable=true,
     *                 @OA\Property(property="id", type="integer", example=12),
     *                 @OA\Property(property="sid", type="integer", example=3),
     *                 @OA\Property(property="amount", type="number", example=4500),
     *                 @OA\Property(property="ssn", type="integer", example=2025),
     *                 @OA\Property(property="trm", type="integer", example=1)
     *             )
     *         )
     *     ),
     *
     *     @OA\Response(
     *         response=404,
     *         description="Record not found",
     *         @OA\JsonContent(
     *             @OA\Property(property="status", type="boolean", example=false),
     *             @OA\Property(property="message", type="string", example="No records found")
     *         )
     *     ),
     *
     *     @OA\Response(
     *         response=401,
     *         description="Unauthenticated"
     *     )
     * )
     */
    // public function getSchoolAppFee($uid)
    // {
    //     $pld = school_app_fee::where("sid", $uid)->first();
    //     return response()->json([
    //         "status" => true,
    //         "message" => "Success",
    //         "pld" => $pld,
    //     ]);
    // }

    public function getSchoolAppFee(Request $request, $uid)
    {
        // Optional filters
        $ssn = $request->input('ssn', null);
        $trm = $request->input('trm', null);

        // Base query
        $query = school_app_fee::where("sid", $uid);

        // Apply optional filters
        if (!is_null($ssn)) {
            $query->where('ssn', $ssn);
        }

        if (!is_null($trm)) {
            $query->where('trm', $trm);
        }

        // Fetch first matching record
        $pld = $query->first();

        return response()->json([
            "status" => true,
            "message" => "Success",
            "pld" => $pld,
        ]);
    }


    /**
     * @OA\Get(
     *     path="/api/getSchoolPropInfo/{uid}",
     *     tags={"Api"},
     *     summary="Get School Proprietor Info",
     *     description="Use this endpoint to get general information about a proprietor.",
     *     security={{"bearerAuth": {}}},
     *     @OA\Parameter(
     *         name="uid",
     *         in="path",
     *         required=true,
     *         description="User Id",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Response(response="200", description="Success", @OA\JsonContent()),
     *     @OA\Response(response="401", description="Unauthorized"),
     * )
     */
    public function getSchoolPropInfo($uid)
    {
        $pld = school_prop_data::where("user_id", $uid)->first();
        return response()->json([
            "status" => true,
            "message" => "Success",
            "pld" => $pld,
        ]);
    }

    /**
     * @OA\Post(
     *     path="/api/registerPartner",
     *     tags={"Unprotected"},
     *     summary="Register a partner",
     *     @OA\RequestBody(
     *         required=true,
     *         @OA\JsonContent(
     *             type="object",
     *             @OA\Property(property="email", type="string", format="email"),
     *             @OA\Property(property="password", type="string"),
     *             @OA\Property(property="fname", type="string"),
     *             @OA\Property(property="mname", type="string"),
     *             @OA\Property(property="lname", type="string"),
     *             @OA\Property(property="phn", type="string"),
     *             @OA\Property(property="pcode", type="string",description="Partner Unique Code"),
     *             @OA\Property(property="verif", type="string"),
     *         )
     *     ),
     *     @OA\Response(response="200", description="Account created successfully"),
     * )
     */
    public function registerPartner(Request $request)
    {
        //Data validation
        $request->validate([
            "email" => "required|email",
            "password" => "required",
            "fname" => "required",
            "lname" => "required",
            "phn" => "required",
            "verif" => "required",
            "pcode" => "required|unique:partner_basic_data",
        ]);
        $typ = 'p';
        $usr = User::where("typ", $typ)->where("email", $request->email)->first();
        if (!$usr) {
            $usr = User::create([
                "email" => $request->email,
                "typ" => $typ,
                "verif" => "0",
                "password" => bcrypt($request->password),
            ]);
            partner_basic_data::create([
                "user_id" => strval($usr->id),
                "fname" => $request->fname,
                "lname" => $request->lname,
                "mname" => $request->mname ?? '',
                "phn" => $request->phn,
                "eml" => $request->email,
                "verif" => $request->verif,
                "pcode" => $request->pcode,
            ]);
            // Respond
            return response()->json([
                "status" => true,
                "message" => "Account created successfully",
            ]);
        }
        return response()->json([
            "status" => false,
            "message" => "Account already exists",
        ], 400);
    }

    /**
     * @OA\Post(
     *     path="/api/partnerLogin",
     *     tags={"Unprotected"},
     *     summary="Partner Login to the application",
     *     @OA\RequestBody(
     *         required=true,
     *         @OA\JsonContent(
     *             type="object",
     *             @OA\Property(property="email", type="string", format="email"),
     *             @OA\Property(property="password", type="string"),
     *         )
     *     ),
     *     @OA\Response(response="200", description="Partner Login Successfully"),
     * )
     */
    public function partnerLogin(Request $request)
    {
        //Data validation
        $request->validate([
            "email" => "required|email",
            "password" => "required",
        ]);
        $typ = 'p';
        $usr = User::where("typ", $typ)->where('email', $request->email)->first();
        if ($usr) {
            $token = JWTAuth::attempt([
                "email" => $request->email,
                "password" => $request->password,
            ]);
            if (!empty($token)) {
                return response()->json([
                    "status" => true,
                    "message" => "Partner login successfully",
                    "token" => $token,
                    "pld" => $usr
                ]);
            }
        }
        // Respond
        return response()->json([
            "status" => false,
            "message" => "Invalid login details",
        ], 400);
    }

    /**
     * @OA\Post(
     *     path="/api/setPartner",
     *     tags={"Api"},
     *     summary="Set Partner Data",
     *     description="This endpoint is used to set information about a partner.",
     *     security={{"bearerAuth": {}}},
     *     @OA\RequestBody(
     *         required=true,
     *         @OA\JsonContent(
     *             type="object",
     *             @OA\Property(property="user_id", type="string"),
     *             @OA\Property(property="eml", type="string", format="email"),
     *             @OA\Property(property="fname", type="string"),
     *             @OA\Property(property="mname", type="string"),
     *             @OA\Property(property="lname", type="string"),
     *             @OA\Property(property="phn", type="string"),
     *             @OA\Property(property="verif", type="string"),
     *             @OA\Property(property="pcode", type="string",description="Partner Unique Code"),
     *             @OA\Property(property="state", type="string", description="State"),
     *             @OA\Property(property="lga", type="string", description="Local Government Area"),
     *             @OA\Property(property="addr", type="string", description="Address"),
     *             @OA\Property(property="sex", type="string", description="Gender"),
     *             @OA\Property(property="bnk", type="string", description="Bank Code"),
     *             @OA\Property(property="anum", type="string", description="Account Number"),
     *             @OA\Property(property="aname", type="string", description="Acct Name"),
     *         )
     *     ),
     *     @OA\Response(response="200", description="Success"),
     *     @OA\Response(response="401", description="Unauthorized"),
     * )
     */
    public function setPartner(Request $request)
    {
        $request->validate([
            "user_id" => "required",
            "fname" => "required",
            "lname" => "required",
            "phn" => "required",
            "eml" => "required",
            "verif" => "required",
            "state" => "required",
            "lga" => "required",
            "addr" => "required",
            "sex" => "required",
            "bnk" => "required",
            "anum" => "required",
            "aname" => "required",
        ]);
        $dbd = partner_basic_data::where("user_id", $request->user_id)->first();
        if ($dbd) {
            $dbd->update([
                "fname" => $request->fname,
                "lname" => $request->lname,
                "mname" => $request->mname,
                "phn" => $request->phn,
                "eml" => $request->eml,
                "verif" => $request->verif,
            ]);
            partner_general_data::updateOrCreate(
                ["user_id" => $request->user_id,],
                [
                    "state" => $request->state,
                    "lga" => $request->lga,
                    "addr" => $request->addr,
                    "sex" => $request->sex,
                ]
            );
            partner_financial_data::updateOrCreate(
                ["user_id" => $request->user_id,],
                [
                    "bnk" => $request->bnk,
                    "anum" => $request->anum,
                    "aname" => $request->aname,
                ]
            );
            return response()->json([
                "status" => true,
                "message" => "Success"
            ]);
        }
        return response()->json([
            "status" => false,
            "message" => "Partner not found"
        ], 400);
    }


    /**
     * @OA\Get(
     *     path="/api/getPartnerByCode/{pcd}",
     *     tags={"Api"},
     *     summary="Get Partner Basic Info Using Their Code",
     *     description="Use this endpoint to get basic information about a partner.",
     *     security={{"bearerAuth": {}}},
     *     @OA\Parameter(
     *         name="pcd",
     *         in="path",
     *         required=true,
     *         description="Code of the Partner",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Response(response="200", description="Success", @OA\JsonContent()),
     *     @OA\Response(response="401", description="Unauthorized"),
     * )
     */
    public function getPartnerByCode($pcd)
    {
        $pld = partner_basic_data::where("pcode", $pcd)->first();
        return response()->json([
            "status" => true,
            "message" => "Success",
            "pld" => $pld,
        ]);
    }

    /**
     * @OA\Get(
     *     path="/api/getPartnerBasicInfo/{uid}",
     *     tags={"Api"},
     *     summary="Get Partner Basic Info",
     *     description="Use this endpoint to get basic information about a partner.",
     *     security={{"bearerAuth": {}}},
     *     @OA\Parameter(
     *         name="uid",
     *         in="path",
     *         required=true,
     *         description="User Id of the Partner. User ID, not partner code",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Response(response="200", description="Success", @OA\JsonContent()),
     *     @OA\Response(response="401", description="Unauthorized"),
     * )
     */
    public function getPartnerBasicInfo($uid)
    {
        $pld = partner_basic_data::where("user_id", $uid)->first();
        return response()->json([
            "status" => true,
            "message" => "Success",
            "pld" => $pld,
        ]);
    }

    /**
     * @OA\Get(
     *     path="/api/getPartnerGeneralInfo/{uid}",
     *     tags={"Api"},
     *     summary="Get Partner General Info",
     *     description="Use this endpoint to get general information about a partner.",
     *     security={{"bearerAuth": {}}},
     *     @OA\Parameter(
     *         name="uid",
     *         in="path",
     *         required=true,
     *         description="User Id",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Response(response="200", description="Success", @OA\JsonContent()),
     *     @OA\Response(response="401", description="Unauthorized"),
     * )
     */
    public function getPartnerGeneralInfo($uid)
    {
        $pld = partner_general_data::where("user_id", $uid)->first();
        return response()->json([
            "status" => true,
            "message" => "Success",
            "pld" => $pld,
        ]);
    }


    /**
     * @OA\Get(
     *     path="/api/getPartnerFinancialInfo/{uid}",
     *     tags={"Api"},
     *     summary="Get Partner Fiancial Info",
     *     description="Use this endpoint to get financial information about a partner.",
     *     security={{"bearerAuth": {}}},
     *     @OA\Parameter(
     *         name="uid",
     *         in="path",
     *         required=true,
     *         description="User Id",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Response(response="200", description="Success", @OA\JsonContent()),
     *     @OA\Response(response="401", description="Unauthorized"),
     * )
     */
    public function getPartnerFinancialInfo($uid)
    {
        $pld = partner_financial_data::where("user_id", $uid)->first();
        return response()->json([
            "status" => true,
            "message" => "Success",
            "pld" => $pld,
        ]);
    }

    /**
     * @OA\Get(
     *     path="/api/getAnnouncements",
     *     tags={"Api"},
     *     summary="Get Announcements",
     *     description="Use this endpoint to get information about announcements.",
     *     security={{"bearerAuth": {}}},
     *     @OA\Parameter(
     *         name="start",
     *         in="query",
     *         required=false,
     *         description="Index to start at",
     *         @OA\Schema(type="integer")
     *     ),
     *     @OA\Parameter(
     *         name="count",
     *         in="query",
     *         required=false,
     *         description="No of records to retrieve. Default is 5",
     *         @OA\Schema(type="integer")
     *     ),
     *     @OA\Response(response="200", description="Success", @OA\JsonContent()),
     *     @OA\Response(response="401", description="Unauthorized"),
     * )
     */
    public function getAnnouncements()
    {
        $start = 0;
        $count = 5;
        if (request()->has('start') && request()->has('count')) {
            $start = request()->input('start');
            $count = request()->input('count');
        }
        $anns = announcements::skip($start)->take($count)->get();
        return response()->json([
            "status" => true,
            "message" => "Success",
            "pld" => $anns,
        ]);
    }

    /**
     * @OA\Post(
     *     path="/api/setSchoolSession",
     *     tags={"Api"},
     *     summary="Set a school's Session. If new, no need for id param. Otherwise, specify",
     *     description="This endpoint is used to set information about a session.",
     *     security={{"bearerAuth": {}}},
     *     @OA\RequestBody(
     *         required=true,
     *         @OA\JsonContent(
     *             type="object",
     *             @OA\Property(property="schid", type="string"),
     *             @OA\Property(property="year", type="string"),
     *         )
     *     ),
     *     @OA\Response(response="200", description="Success"),
     *     @OA\Response(response="401", description="Unauthorized"),
     * )
     */
    public function setSchSesn(Request $request)
    {
        $request->validate([
            'schid' => 'required',
            'year' => 'required',
        ]);
        $sch = school::where('sid', $request->schid)->first();
        if ($sch) {
            $sch->update([
                'cssn' => $request->year,
            ]);
            return response()->json([
                "status" => true,
                "message" => "Success"
            ]);
        }
        return response()->json([
            "status" => false,
            "message" => "School Not Found"
        ], 400);
    }


    /**
     * @OA\Post(
     *     path="/api/setSchoolTerm",
     *     tags={"Api"},
     *     summary="Set a school's current Term",
     *     description="This endpoint is used to set current term",
     *     security={{"bearerAuth": {}}},
     *     @OA\RequestBody(
     *         required=true,
     *         @OA\JsonContent(
     *             type="object",
     *             @OA\Property(property="schid", type="string"),
     *             @OA\Property(property="no", type="string"),
     *             @OA\Property(property="name", type="string"),
     *         )
     *     ),
     *     @OA\Response(response="200", description="Success"),
     *     @OA\Response(response="401", description="Unauthorized"),
     * )
     */
    public function setSchTrm(Request $request)
    {
        $request->validate([
            'schid' => 'required',
            'no' => 'required',
            'name' => 'required',
        ]);
        $sch = school::where('sid', $request->schid)->first();
        if ($sch) {
            $sch->update([
                'ctrm' => $request->no,
                'ctrmn' => $request->name,
            ]);
            return response()->json([
                "status" => true,
                "message" => "Success"
            ]);
        }
        return response()->json([
            "status" => false,
            "message" => "School Not Found"
        ], 400);
    }


    /**
     * @OA\Post(
     *     path="/api/setSchoolClassArm",
     *     tags={"Api"},
     *     summary="Set A Schools Class. If new, no need for id param. Otherwise, specify",
     *     description="This endpoint is used to set information about a class.",
     *     security={{"bearerAuth": {}}},
     *     @OA\RequestBody(
     *         required=true,
     *         @OA\JsonContent(
     *             type="object",
     *             @OA\Property(property="id", type="integer"),
     *             @OA\Property(property="schid", type="string",),
     *             @OA\Property(property="cls_id", type="string",),
     *             @OA\Property(property="name", type="string",),
     *         )
     *     ),
     *     @OA\Response(response="200", description="Success"),
     *     @OA\Response(response="401", description="Unauthorized"),
     * )
     */
    public function setSchoolClassArm(Request $request)
    {
        $request->validate([
            'schid' => 'required',
            'cls_id' => 'required',
            'name' => 'required',
        ]);
        $data = [
            'schid' => $request->schid,
            'cls_id' => $request->cls_id,
            'name' => $request->name,
        ];
        $sch_cls = [];
        if ($request->has('id')) {
            $sch_cls = sch_cls::where('id', $request->id)->first();
            if ($sch_cls) {
                $sch_cls->update($data);
            } else {
                return response()->json([
                    "status" => false,
                    "message" => "Class Not Found",
                ]);
            }
        } else {
            $sch_cls = sch_cls::create($data);
        }
        return response()->json([
            "status" => true,
            "message" => "Success",
            "pld" => $sch_cls
        ]);
    }

    /**
     * @OA\Get(
     *     path="/api/getSchoolArms/{schid}",
     *     tags={"Api"},
     *     summary="Get All Class Arms for a particular school",
     *     description="Use this endpoint to get a list of classes",
     *
     *     @OA\Parameter(
     *         name="schid",
     *         in="path",
     *         required=true,
     *         description="School ID",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Response(response="200", description="Success", @OA\JsonContent()),
     *     @OA\Response(response="401", description="Unauthorized"),
     * )
     */
    public function getSchoolArms($schid)
    {
        $sch_cls = sch_cls::where('schid', $schid)->get();
        return response()->json([
            "status" => true,
            "message" => "Success",
            "pld" => $sch_cls,
        ]);
    }

    /**
     * @OA\Get(
     *     path="/api/getSchoolClassArms/{schid}/{clsid}",
     *     tags={"Api"},
     *     summary="Get Classes for a particular school",
     *     description="Use this endpoint to get a list of classes",
     *
     *     @OA\Parameter(
     *         name="schid",
     *         in="path",
     *         required=true,
     *         description="School ID",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Parameter(
     *         name="clsid",
     *         in="path",
     *         required=true,
     *         description="School ID",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Parameter(
     *         name="start",
     *         in="query",
     *         required=false,
     *         description="Index to start at",
     *         @OA\Schema(type="integer")
     *     ),
     *     @OA\Parameter(
     *         name="count",
     *         in="query",
     *         required=false,
     *         description="No of records to retrieve. Default is 5",
     *         @OA\Schema(type="integer")
     *     ),
     *     @OA\Response(response="200", description="Success", @OA\JsonContent()),
     *     @OA\Response(response="401", description="Unauthorized"),
     * )
     */
    public function getSchoolClassArms($schid, $clsid)
    {
        $start = 0;
        $count = 20;
        if (request()->has('start') && request()->has('count')) {
            $start = request()->input('start');
            $count = request()->input('count');
        }
        $sch_cls = sch_cls::where('schid', $schid)->where('cls_id', $clsid)->take($count)->skip($start)->get();
        return response()->json([
            "status" => true,
            "message" => "Success",
            "pld" => $sch_cls,
        ]);
    }

    /**
     * @OA\Get(
     *     path="/api/getSchoolArmsStat/{schid}/{clsid}",
     *     tags={"Api"},
     *     summary="Get total no for Classes for a particular school",
     *     description="Use this endpoint to get a total no of classes",
     *
     *     @OA\Parameter(
     *         name="schid",
     *         in="path",
     *         required=true,
     *         description="School ID",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Parameter(
     *         name="clsid",
     *         in="path",
     *         required=true,
     *         description="School ID",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Response(response="200", description="Success", @OA\JsonContent()),
     *     @OA\Response(response="401", description="Unauthorized"),
     * )
     */
    public function getSchoolArmsStat($schid, $clsid)
    {
        $total = sch_cls::where('schid', $schid)->where('cls_id', $clsid)->count();
        return response()->json([
            "status" => true,
            "message" => "Success",
            "pld" => [
                "total" => $total,
            ],
        ]);
    }

    /**
     * @OA\Get(
     *     path="/api/getASchoolClassArm/{cid}",
     *     tags={"Api"},
     *     summary="Get a particular class",
     *     description="Use this endpoint to get a particular class",
     *     security={{"bearerAuth": {}}},
     *     @OA\Parameter(
     *         name="cid",
     *         in="path",
     *         required=true,
     *         description="Unique Class ID",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Response(response="200", description="Success", @OA\JsonContent()),
     *     @OA\Response(response="401", description="Unauthorized"),
     * )
     */
    public function getASchoolClassArm($cid)
    {
        $cls = sch_cls::where('id', $cid)->first();
        return response()->json([
            "status" => true,
            "message" => "Success",
            "pld" => $cls,
        ]);
    }

    /**
     * @OA\Post(
     *     path="/api/setSchoolClass",
     *     tags={"Api"},
     *     summary="Set A Schools Class. If new, no need for id param. Otherwise, specify",
     *     description="This endpoint is used to set information about a class.",
     *     security={{"bearerAuth": {}}},
     *     @OA\RequestBody(
     *         required=true,
     *         @OA\JsonContent(
     *             type="object",
     *             @OA\Property(property="id", type="integer"),
     *             @OA\Property(property="schid", type="string",),
     *             @OA\Property(property="clsid", type="string",),
     *             @OA\Property(property="name", type="string",),
     *         )
     *     ),
     *     @OA\Response(response="200", description="Success"),
     *     @OA\Response(response="401", description="Unauthorized"),
     * )
     */
    public function setSchoolClass(Request $request)
    {
        $request->validate([
            'schid' => 'required',
            'clsid' => 'required',
            'name' => 'required',
        ]);
        $data = [
            'schid' => $request->schid,
            'clsid' => $request->clsid,
            'name' => $request->name,
        ];
        $school_class = [];
        if ($request->has('id')) {
            $school_class = school_class::where('id', $request->id)->first();
            if ($school_class) {
                $school_class->update($data);
            } else {
                return response()->json([
                    "status" => false,
                    "message" => "Class Not Found",
                ]);
            }
        } else {
            $school_class = school_class::create($data);
        }
        return response()->json([
            "status" => true,
            "message" => "Success",
            "pld" => $school_class
        ]);
    }

    /**
     * @OA\Get(
     *     path="/api/getSchoolClasses/{schid}",
     *     tags={"Api"},
     *     summary="Get All Classes for a particular school",
     *     description="Use this endpoint to get a list of classes",
     *
     *     @OA\Parameter(
     *         name="schid",
     *         in="path",
     *         required=true,
     *         description="School ID",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Response(response="200", description="Success", @OA\JsonContent()),
     *     @OA\Response(response="401", description="Unauthorized"),
     * )
     */
    public function getSchoolClasses($schid)
    {
        $school_class = school_class::where('schid', $schid)->get();
        return response()->json([
            "status" => true,
            "message" => "Success",
            "pld" => $school_class,
        ]);
    }


    /**
     * @OA\Post(
     *     path="/api/setSchoolGradeInfo",
     *     tags={"Api"},
     *     security={{"bearerAuth": {}}},
     *     summary="Set grading info about a school",
     *     @OA\RequestBody(
     *         required=true,
     *         @OA\JsonContent(
     *             type="object",
     *             @OA\Property(property="user_id", type="string"),
     *             @OA\Property(property="a_h", type="string"),
     *             @OA\Property(property="a_l", type="string"),
     *             @OA\Property(property="b2_h", type="string"),
     *             @OA\Property(property="b2_l", type="string"),
     *             @OA\Property(property="b3_h", type="string"),
     *             @OA\Property(property="b3_l", type="string"),
     *             @OA\Property(property="c4_h", type="string"),
     *             @OA\Property(property="c4_l", type="string"),
     *             @OA\Property(property="c5_h", type="string"),
     *             @OA\Property(property="c5_l", type="string"),
     *             @OA\Property(property="c6_h", type="string"),
     *             @OA\Property(property="c6_l", type="string"),
     *             @OA\Property(property="d7_h", type="string"),
     *             @OA\Property(property="d7_l", type="string"),
     *             @OA\Property(property="e8_h", type="string"),
     *             @OA\Property(property="e8_l", type="string"),
     *             @OA\Property(property="f_h", type="string"),
     *             @OA\Property(property="f_l", type="string"),
     *         )
     *     ),
     *     @OA\Response(response="200", description="staff data set successfully"),
     *     @OA\Response(response="400", description="Validation error"),
     * )
     */
    public function setSchoolGradeInfo(Request $request)
    {
        //Data validation
        $request->validate([
            "user_id" => "required",
            "a_h" => "required",
            "a_l" => "required",
            "b2_h" => "required",
            "b2_l" => "required",
            "b3_h" => "required",
            "b3_l" => "required",
            "c4_h" => "required",
            "c4_l" => "required",
            "c5_h" => "required",
            "c5_l" => "required",
            "c6_h" => "required",
            "c6_l" => "required",
            "d7_h" => "required",
            "d7_l" => "required",
            "e8_h" => "required",
            "e8_l" => "required",
            "f_h" => "required",
            "f_l" => "required",
        ]);
        school_grade_data::updateOrCreate(
            ["user_id" => $request->user_id,],
            [
                "a_h" => $request->a_h,
                "a_l" => $request->a_l,
                "b2_h" => $request->b2_h,
                "b2_l" => $request->b2_l,
                "b3_h" => $request->b3_h,
                "b3_l" => $request->b3_l,
                "c4_h" => $request->c4_h,
                "c4_l" => $request->c4_l,
                "c5_h" => $request->c5_h,
                "c5_l" => $request->c5_l,
                "c6_h" => $request->c6_h,
                "c6_l" => $request->c6_l,
                "d7_h" => $request->d7_h,
                "d7_l" => $request->d7_l,
                "e8_h" => $request->e8_h,
                "e8_l" => $request->e8_l,
                "f_h" => $request->f_h,
                "f_l" => $request->f_l,
            ]
        );
        return response()->json([
            "status" => true,
            "message" => "Success",
        ]);
    }


    /**
     * @OA\Get(
     *     path="/api/getSchoolGradeInfo/{uid}",
     *     tags={"Api"},
     *     security={{"bearerAuth": {}}},
     *     summary="Get a school's grading Info",
     *     description="Use this endpoint to get grading information about a staff.",
     *     @OA\Parameter(
     *         name="uid",
     *         in="path",
     *         required=true,
     *         description="User Id of the staff",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Response(response="200", description="Success", @OA\JsonContent()),
     *     @OA\Response(response="401", description="Unauthorized"),
     * )
     */
    public function getSchoolGradeInfo($uid)
    {
        $pld = school_grade_data::where("user_id", $uid)->first();
        return response()->json([
            "status" => true,
            "message" => "Success",
            "pld" => $pld,
        ]);
    }

    //--STUDENT

    /**
     * @OA\Post(
     *     path="/api/registerStudent",
     *     tags={"Unprotected"},
     *     summary="Register a new student",
     *     @OA\RequestBody(
     *         required=true,
     *         @OA\JsonContent(
     *             type="object",
     *             @OA\Property(property="schid", type="string", description="School ID which this student belongs"),
     *             @OA\Property(property="email", type="string", format="email"),
     *             @OA\Property(property="fname", type="string"),
     *             @OA\Property(property="lname", type="string"),
     *             @OA\Property(property="term", type="string"),
     *             @OA\Property(property="ssn", type="string"),
     *             @OA\Property(property="sch3", type="string"),
     *             @OA\Property(property="stat", type="string"),
     *             @OA\Property(property="password", type="string", description="The password for the student"),
     *         )
     *     ),
     *     @OA\Response(response="200", description="Password reset token sent to mail"),
     * )
     */


    public function registerStudent(Request $request)
    {
        //Data validation
        $request->validate([
            "schid" => "required",
            "email" => "required|email|unique:users,email",
            "password" => "required",
            "fname" => "required",
            "lname" => "required",
            "term" => "required",
            "ssn" => "required",
            "sch3" => "required",
            "stat" => "required",
            "cuid" => "nullable|unique:student,cuid",
        ]);
        if (strlen($request->password) < 6) {
            return response()->json([
                "status" => false,
                "message" => "Password must be at least 6 char",
            ], 400);
        }
        $typ = 'z';
        $usr = User::where("typ", $typ)->where("email", $request->email)->first();
        $tstd = null;
        if ($request->cuid) {
            $tstd = student::where("cuid", $request->cuid)->first();
        } else {
            if ($request->count) {
                $tstd = student::where("sch3", $request->sch3)->where("year", $request->ssn)
                    ->where("term", $request->term)->where("count", $request->count)->first();
            }
        }
        if (!$usr && !$tstd) {
            $usr = User::create([
                "email" => $request->email,
                "typ" => $typ,
                "verif" => '1',
                "password" => bcrypt($request->password),
            ]);
            $count = $request->count;
            if (!$count) {
                $count = student::where('schid', $request->schid)->count() + 1;
            }
            $ssn = $request->ssn;
            student::create([
                "sid" => strval($usr->id),
                "schid" => $request->schid,
                "fname" => $request->fname,
                "mname" => $request->mname,
                "lname" => $request->lname,
                "count" => strval($count),
                "year" => $ssn,
                "term" => $request->term,
                "sch3" => $request->sch3,
                "s_basic" => '0',
                "s_medical" => '0',
                "s_parent" => '0',
                "s_academic" => '0',
                "rfee" => $request->stat,
                "stat" => $request->stat,
                "cuid" => $request->cuid,
            ]);
            $sid = $request->sch3 . '/' . $ssn . '/' . $request->term . '/' . strval($count);
            // Wrap the email sending logic in a try-catch block
            try {
                if ($request->cuid) {
                    $data = [
                        'name' => $request->fname,
                        'subject' => 'Welcome Back, Your ID remains ' . $request->cuid,
                        'body' => "Welcome back to your school's platform. Your account was created successfully. If you havent already, please login to your dashboard using the link below and complete your student profile. If the link isnt clickable, please copy the link to your browser. If this arrived in spam folder, please mark as Not Spam. Your Student ID is " . $request->cuid,
                        'link' => env('PORTAL_URL') . '/studentLogin' . '/' . $request->schid,
                    ];
                    Mail::to($request->email)->send(new SSSMails($data));
                } else {
                    $data = [
                        'name' => $request->fname,
                        'subject' => 'Welcome, Your ID is ' . $sid,
                        'body' => "Welcome to your school's platform. Your account was created successfully. If you havent already, please login to your dashboard using the link below and complete your student profile. If the link isnt clickable, please copy the link to your browser. If this arrived in spam folder, please mark as Not Spam. Your Student ID is " . $sid,
                        'link' => env('PORTAL_URL') . '/studentLogin' . '/' . $request->schid,
                    ];
                    Mail::to($request->email)->send(new SSSMails($data));
                }
            } catch (\Exception $e) {
                // Log the email error, but don't stop the process
                Log::error('Failed to send email: ' . $e->getMessage());
            }

            // Respond
            $token = JWTAuth::attempt([
                "email" => $request->email,
                "password" => $request->password,
            ]);
            return response()->json([
                "status" => true,
                "message" => "User created successfully",
                "token" => $token,
                "sid" => $sid,
                "user_id" => strval($usr->id)
            ]);
        }
        return response()->json([
            "status" => false,
            "message" => "Account already exists",
        ], 400);
    }
    /**
     * @OA\Post(
     *     path="/api/studentLoginByEmail",
     *     tags={"Unprotected"},
     *     summary="Student Login to the application by Email",
     *     @OA\RequestBody(
     *         required=true,
     *         @OA\JsonContent(
     *             type="object",
     *             @OA\Property(property="email", type="string", format="email"),
     *             @OA\Property(property="password", type="string"),
     *         )
     *     ),
     *     @OA\Response(
     *         response="200",
     *         description="Login successful",
     *         @OA\JsonContent(
     *             type="object",
     *             @OA\Property(property="token", type="string", example="your-jwt-token-here", description="This will contain a JWT token that must be passed with consequent request using bearer token"),
     *         )
     *     ),
     * )
     */
    public function studentLoginByEmail(Request $request)
    {
        //Data validation
        $request->validate([
            "email" => "required|email",
            "password" => "required",
        ]);
        $typ = 'z';
        $usr = User::where("typ", $typ)->where("email", $request->email)->first();
        if ($usr) {
            $token = JWTAuth::attempt([
                "email" => $request->email,
                "password" => $request->password,
            ]);
            if (!empty($token)) {
                $std = student::where('sid', strval($usr->id))->first();
                return response()->json([
                    "status" => true,
                    "message" => "Login successful",
                    "token" => $token,
                    "pld" => $usr,
                    "std" => $std,
                ]);
            }
        }
        // Respond
        return response()->json([
            "status" => false,
            "message" => "Invalid login details",
        ], 400);
    }

    /**
     * @OA\Post(
     *     path="/api/studentLoginByID",
     *     tags={"Unprotected"},
     *     summary="Student Login to the application",
     *     @OA\RequestBody(
     *         required=true,
     *         @OA\JsonContent(
     *             type="object",
     *             @OA\Property(property="stid", type="string"),
     *             @OA\Property(property="schid", type="string"),
     *             @OA\Property(property="password", type="string"),
     *         )
     *     ),
     *     @OA\Response(
     *         response="200",
     *         description="Login successful",
     *         @OA\JsonContent(
     *             type="object",
     *             @OA\Property(property="token", type="string", example="your-jwt-token-here", description="This will contain a JWT token that must be passed with consequent request using bearer token"),
     *         )
     *     ),
     * )
     */
    public function studentLoginByID(Request $request)
    {
        //Data validation
        $request->validate([
            "stid" => "required",
            "schid" => "required",
            "password" => "required",
        ]);
        $typ = 'z';
        $std = [];
        $compo = explode("/", $request->stid);
        if (count($compo) == 4) {
            $sch3 = $compo[0];
            $year = $compo[1];
            $term = $compo[2];
            $count = $compo[3];
            $std = student::where("schid", $request->schid)->where("year", $year)->where("term", $term)
                ->where("count", $count)->first();
        } else {
            $std = student::where("cuid", $request->stid)->first();
        }
        if ($std) {
            $usr = User::where("typ", $typ)->where("id", $std->sid)->first();
            $token = JWTAuth::attempt([
                "email" => $usr->email,
                "password" => $request->password,
            ]);
            if (!empty($token)) {
                return response()->json([
                    "status" => true,
                    "message" => "Login successful",
                    "token" => $token,
                    "pld" => $usr,
                ]);
            }
        }
        // Respond
        return response()->json([
            "status" => false,
            "message" => "Invalid login details",
        ], 400);
    }

    /**
     * @OA\Post(
     *     path="/api/admitStudent",
     *     tags={"Api"},
     *     security={{"bearerAuth": {}}},
     *     summary="admit/reject a student",
     *     @OA\RequestBody(
     *         required=true,
     *         @OA\JsonContent(
     *             type="object",
     *             @OA\Property(property="stid", type="string"),
     *             @OA\Property(property="stat", type="string"),
     *             @OA\Property(property="schid", type="string"),
     *         )
     *     ),
     *     @OA\Response(response="200", description="Student data set successfully"),
     *     @OA\Response(response="400", description="Validation error"),
     * )
     */
    public function admitStudent(Request $request)
    {
        //Data validation
        $request->validate([
            "stid" => "required",
            "stat" => "required",
            "schid" => "required",
        ]);
        $std = student::where('sid', $request->stid)->first();
        if ($std) {
            $std->update([
                "stat" => $request->stat
            ]);
            $usr = User::where('id', $std->sid)->first();
            // Wrap the email sending logic in a try-catch block
            try {
                $data = [
                    'name' => $std->fname,
                    'subject' => 'Application ' . ($request->stat == '1' ? 'Approved' : 'Decline'),
                    'body' => "Your application to our school has been " . ($request->stat == '1' ? 'approved' : 'decline'),
                    'link' => env('PORTAL_URL') . '/studentLogin' . '/' . $request->schid,
                ];
                Mail::to($usr->email)->send(new SSSMails($data));
            } catch (\Exception $e) {
                // Log the email error, but don't stop the process
                Log::error('Failed to send email: ' . $e->getMessage());
            }

            return response()->json([
                "status" => true,
                "message" => "Success",
            ]);
        }
        return response()->json([
            "status" => false,
            "message" => "Student Not Found",
        ], 400);
    }

    /**
     * @OA\Post(
     *     path="/api/setAppFeePaid",
     *     tags={"Api"},
     *     security={{"bearerAuth": {}}},
     *     summary="set App Fee Paid",
     *     @OA\RequestBody(
     *         required=true,
     *         @OA\JsonContent(
     *             type="object",
     *             @OA\Property(property="stid", type="string"),
     *         )
     *     ),
     *     @OA\Response(response="200", description="Student data set successfully"),
     *     @OA\Response(response="400", description="Validation error"),
     * )
     */
    // public function setAppFeePaid(Request $request)
    // {
    //     //Data validation
    //     $request->validate([
    //         "stid" => "required",
    //     ]);
    //     student::where('sid', $request->stid)->update([
    //         "rfee" => '1'
    //     ]);
    //     return response()->json([
    //         "status" => false,
    //         "message" => "Student Not Found",
    //     ], 400);
    // }

    public function setAppFeePaid(Request $request)
    {
        // Validate request
        $request->validate([
            "stid" => "required",
        ]);

        // Find student
        $student = student::where('sid', $request->stid)->first();

        // If NOT found, return error
        if (!$student) {
            return response()->json([
                "status" => false,
                "message" => "Student Not Found",
            ], 400);
        }

        // If found, update rfee
        $student->update([
            "rfee" => '1',
        ]);

        return response()->json([
            "status" => true,
            "message" => "Application Fee Marked as Paid Successfully",
        ], 200);
    }


    /**
     * @OA\Get(
     *     path="/api/getStudentsByStatus/{stat}/{schid}",
     *     tags={"Api"},
     *     security={{"bearerAuth": {}}},
     *     summary="Get a list of students by thier status",
     *     description="Use this endpoint to get a list of students by thier status",
     *     @OA\Parameter(
     *         name="stat",
     *         in="path",
     *         required=true,
     *         description="Stat Id of the student",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Parameter(
     *         name="schid",
     *         in="path",
     *         required=true,
     *         description="School Id of the student",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Parameter(
     *         name="start",
     *         in="query",
     *         required=false,
     *         description="Index to start at",
     *         @OA\Schema(type="integer")
     *     ),
     *     @OA\Parameter(
     *         name="count",
     *         in="query",
     *         required=false,
     *         description="No of records to retrieve",
     *         @OA\Schema(type="integer")
     *     ),
     *     @OA\Response(response="200", description="Success", @OA\JsonContent()),
     *     @OA\Response(response="401", description="Unauthorized"),
     * )
     */
    public function getStudentsByStatus($stat, $schid)
    {
        $start = 0;
        $count = 20;
        if (request()->has('start') && request()->has('count')) {
            $start = request()->input('start');
            $count = request()->input('count');
        }
        $members = student::where('schid', $schid)->where('stat', $stat)->orderBy('sid', 'desc')->skip($start)->take($count)->get();
        $pld = [];
        foreach ($members as $member) {
            $user_id = $member->sid;
            $academicData = student_academic_data::where('user_id', $user_id)->first();
            $basicData = student_basic_data::where('user_id', $user_id)->first();
            $pld[] = [
                's' => $member,
                'b' => $basicData,
                'a' => $academicData,
            ];
        }
        return response()->json([
            "status" => true,
            "message" => "Success",
            "pld" => $pld,
        ]);
    }

    /**
     * @OA\Post(
     *     path="/api/setStudentAtOnce",
     *     tags={"Api"},
     *     security={{"bearerAuth": {}}},
     *     summary="Set all info about a student",
     *     @OA\RequestBody(
     *         required=true,
     *         @OA\JsonContent(
     *             type="object",
     *             @OA\Property(property="schid", type="string"),
     *             @OA\Property(property="last_school", type="string"),
     *             @OA\Property(property="last_class", type="string"),
     *             @OA\Property(property="new_class", type="string"),
     *             @OA\Property(property="new_class_main", type="string"),
     *             @OA\Property(property="dob", type="string"),
     *             @OA\Property(property="sex", type="string"),
     *             @OA\Property(property="height", type="string"),
     *             @OA\Property(property="country", type="string"),
     *             @OA\Property(property="state", type="string"),
     *             @OA\Property(property="lga", type="string"),
     *             @OA\Property(property="addr", type="string"),
     *             @OA\Property(property="email", type="string", format="email"),
     *             @OA\Property(property="fname", type="string"),
     *             @OA\Property(property="lname", type="string"),
     *             @OA\Property(property="term", type="string"),
     *             @OA\Property(property="ssn", type="string"),
     *             @OA\Property(property="sch3", type="string"),
     *             @OA\Property(property="stat", type="string"),
     *             @OA\Property(property="password", type="string", description="The password for the student"),
     *         )
     *     ),
     *     @OA\Response(response="200", description="Student data set successfully"),
     *     @OA\Response(response="400", description="Validation error"),
     * )
     */
    public function setStudentAtOnce(Request $request)
    {
        //Data validation
        $request->validate([
            "schid" => "required",
            "email" => "required|email",
            "password" => "required",
            "fname" => "required",
            "lname" => "required",
            "term" => "required",
            "ssn" => "required",
            "sch3" => "required",
            "stat" => "required",
            "schid" => "required",
            "last_school" => "required",
            "last_class" => "required",
            "new_class" => "required",
            "new_class_main" => "required",
            "dob" => "required",
            "sex" => "required",
            "height" => "required",
            "country" => "required",
            "state" => "required",
            "lga" => "required",
            "addr" => "required",
        ]);
        if (strlen($request->password) < 6) {
            return response()->json([
                "status" => false,
                "message" => "Password must be at least 6 characters",
            ], 400);
        }
        $typ = 'z';
        $usr = User::where("typ", $typ)->where("email", $request->email)->first();
        if (!$usr) {
            $usr = User::create([
                "email" => $request->email,
                "typ" => $typ,
                "verif" => '1',
                "password" => bcrypt($request->password),
            ]);
            $count = $request->count;
            if (!$count) {
                $count = student::where('schid', $request->schid)->count() + 1;
            }
            $ssn = $request->ssn;
            student::create([
                "sid" => strval($usr->id),
                "schid" => $request->schid,
                "fname" => $request->fname,
                "mname" => $request->mname,
                "lname" => $request->lname,
                "count" => strval($count),
                "year" => $ssn,
                "term" => $request->term,
                "sch3" => $request->sch3,
                "s_basic" => '0',
                "s_medical" => '0',
                "s_parent" => '0',
                "s_academic" => '0',
                "rfee" => $request->stat,
                "stat" => $request->stat,
                "cuid" => $request->cuid,
            ]);
            $sid = $request->sch3 . '/' . $ssn . '/' . $request->term . '/' . strval($count);
            // Wrap the email sending logic in a try-catch block
            try {
                if ($request->cuid) {
                    $data = [
                        'name' => $request->fname,
                        'subject' => 'Welcome Back, Your ID remains ' . $request->cuid,
                        'body' => "Welcome back to your school's platform. Your account was created successfully. If you havent already, please login to your dashboard using the link below and complete your student profile. If the link isnt clickable, please copy the link to your browser. If this arrived in spam folder, please mark as Not Spam. Your Student ID is " . $request->cuid,
                        'link' => env('PORTAL_URL') . '/studentLogin' . '/' . $request->schid,
                    ];
                    Mail::to($request->email)->send(new SSSMails($data));
                } else {
                    $data = [
                        'name' => $request->fname,
                        'subject' => 'Welcome, Your ID is ' . $sid,
                        'body' => "Welcome to your school's platform. Your account was created successfully. If you havent already, please login to your dashboard using the link below and complete your student profile. If the link isnt clickable, please copy the link to your browser. If this arrived in spam folder, please mark as Not Spam. Your Student ID is " . $sid,
                        'link' => env('PORTAL_URL') . '/studentLogin' . '/' . $request->schid,
                    ];
                    Mail::to($request->email)->send(new SSSMails($data));
                }
            } catch (\Exception $e) {
                // Log the email error, but don't stop the process
                Log::error('Failed to send email: ' . $e->getMessage());
            }
            $user_id = strval($usr->id);
            $refreshSubjects = false;
            $oldData = student_academic_data::where('user_id', $user_id)->first();
            if ($oldData) {
                $refreshSubjects = $oldData->new_class_main != $request->new_class_main;
            } else {
                $refreshSubjects = true;
            }
            student_academic_data::updateOrCreate(
                ["user_id" => $user_id,],
                [
                    "last_school" => $request->last_school,
                    "last_class" => $request->last_class,
                    "new_class" => $request->new_class,
                    "new_class_main" => $request->new_class_main,
                ]
            );
            if ($refreshSubjects) { //Delete all subjs and set new, comps ones
                student_subj::where('stid', $user_id)->delete();
                // $schid = $request->schid;
                // $clsid = $request->new_class_main;
                // $members = class_subj::where("schid", $schid)->where("clsid", $clsid)->where("comp", '1')->get();
                // $pld = [];
                // foreach ($members as $member) {
                //     $sbj = $member->subj_id;
                //     $stid = $user_id;
                //     student_subj::updateOrCreate(
                //         ["uid"=> $sbj.$stid],
                //         [
                //         "stid"=> $stid,
                //         "sbj"=> $sbj,
                //         "comp"=> $member->comp,
                //         "schid"=> $member->schid,
                //     ]);
                // }
            }
            student_basic_data::updateOrCreate(
                ["user_id" => $user_id,],
                [
                    "dob" => $request->dob,
                    "sex" => $request->sex,
                    "height" => $request->height,
                    "country" => $request->country,
                    "state" => $request->state,
                    "lga" => $request->lga,
                    "addr" => $request->addr,
                ]
            );
            student::where('sid', $user_id)->update([
                "s_basic" => '1',
                "s_academic" => '1'
            ]);
            //Set paid acceptance fee
            $uid = $user_id . $request->schid . $request->new_class_main;
            afeerec::updateOrCreate(
                ["uid" => $uid,],
                [
                    "stid" => $user_id,
                    "schid" => $request->schid,
                    "clsid" => $request->new_class_main,
                    "ssn" => $request->ssn,
                    "term" => $request->trm,
                    "amt" => 0,
                ]
            );
            return response()->json([
                "status" => true,
                "message" => "Success",
            ]);
        }
        return response()->json([
            "status" => false,
            "message" => "Account already exists",
        ], 400);
    }

    /**
     * @OA\Post(
     *     path="/api/setStudentBasicInfo",
     *     tags={"Api"},
     *     security={{"bearerAuth": {}}},
     *     summary="Set basic info about a student data. Pass 1/0 for stat depending of if application is approved/now",
     *     @OA\RequestBody(
     *         required=true,
     *         @OA\JsonContent(
     *             type="object",
     *             @OA\Property(property="user_id", type="string"),
     *             @OA\Property(property="dob", type="string"),
     *             @OA\Property(property="sex", type="string"),
     *             @OA\Property(property="height", type="string"),
     *             @OA\Property(property="country", type="string"),
     *             @OA\Property(property="state", type="string"),
     *             @OA\Property(property="lga", type="string"),
     *             @OA\Property(property="addr", type="string"),
     *             @OA\Property(property="fname", type="string"),
     *             @OA\Property(property="lname", type="string"),
     *             @OA\Property(property="mname", type="string"),
     *         )
     *     ),
     *     @OA\Response(response="200", description="Student data set successfully"),
     *     @OA\Response(response="400", description="Validation error"),
     * )
     */


    public function setStudentBasicInfo(Request $request)
    {
        // Data validation
        $request->validate([
            "user_id" => "required",
            "dob" => "required",
            "sex" => "required",
            "height" => "required",
            "country" => "required",
            "state" => "required",
            "lga" => "required",
            "addr" => "required",
            "fname" => "required",
            "lname" => "required",
        ]);

        // Update or Create student_basic_data
        student_basic_data::updateOrCreate(
            ["user_id" => $request->user_id],
            [
                "dob" => $request->dob,
                "sex" => $request->sex,
                "height" => $request->height,
                "country" => $request->country,
                "state" => $request->state,
                "lga" => $request->lga,
                "addr" => $request->addr,
            ]
        );

        // Update student table
        student::where('sid', $request->user_id)->update([
            "s_basic" => '1',
            "fname" => $request->fname,
            "lname" => $request->lname,
            "mname" => $request->mname,
        ]);

        // Update old_student table
        old_student::where('sid', $request->user_id)->update([
            "fname" => $request->fname,
            "mname" => $request->mname,
            "lname" => $request->lname,
        ]);

        return response()->json([
            "status" => true,
            "message" => "Success",
        ]);
    }




    /**
     * @OA\Get(
     *     path="/api/getStudentBasicInfo/{uid}",
     *     tags={"Api"},
     *     security={{"bearerAuth": {}}},
     *     summary="Get a student's Basic Info",
     *     description="Use this endpoint to get basic information about a student.",
     *     @OA\Parameter(
     *         name="uid",
     *         in="path",
     *         required=true,
     *         description="User Id of the student",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Response(response="200", description="Success", @OA\JsonContent()),
     *     @OA\Response(response="401", description="Unauthorized"),
     * )
     */
    public function getStudentBasicInfo($uid)
    {
        $pld = student_basic_data::where("user_id", $uid)->first();
        return response()->json([
            "status" => true,
            "message" => "Success",
            "pld" => $pld,
        ]);
    }

    /**
     * @OA\Post(
     *     path="/api/setStudentSubject",
     *     summary="Assign a subject to a student",
     *     description="This endpoint assigns a single subject to a single student. If the student-subject combination already exists, it will be skipped.",
     *     tags={"Api"},
     *     security={{"bearerAuth": {}}},
     *
     *     @OA\RequestBody(
     *         required=true,
     *         @OA\JsonContent(
     *             required={"uid","stid","sbj","comp","schid"},
     *             @OA\Property(property="uid", type="integer", example=1, description="User ID of the admin/teacher assigning the subject"),
     *             @OA\Property(property="stid", type="integer", example=101, description="Single student ID"),
     *             @OA\Property(property="sbj", type="integer", example=201, description="Single subject ID"),
     *             @OA\Property(property="comp", type="string", example="1", description="Compulsory or elective flag"),
     *             @OA\Property(property="schid", type="integer", example=12, description="School ID"),
     *             @OA\Property(property="clsid", type="integer", nullable=true, example=11, description="Class ID (optional)"),
     *             @OA\Property(property="trm", type="string", nullable=true, example="2", description="Term (optional)"),
     *             @OA\Property(property="ssn", type="string", nullable=true, example="2025", description="Session (optional)")
     *         )
     *     ),
     *
     *     @OA\Response(
     *         response=200,
     *         description="Subject assigned successfully",
     *         @OA\JsonContent(
     *             @OA\Property(property="status", type="boolean", example=true),
     *             @OA\Property(property="message", type="string", example="Subjects assignment completed."),
     *             @OA\Property(
     *                 property="assigned",
     *                 type="array",
     *                 @OA\Items(
     *                     @OA\Property(property="stid", type="integer", example=101),
     *                     @OA\Property(property="sbj", type="integer", example=201)
     *                 )
     *             ),
     *             @OA\Property(
     *                 property="skipped",
     *                 type="array",
     *                 @OA\Items(
     *                     @OA\Property(property="stid", type="integer", example=101),
     *                     @OA\Property(property="sbj", type="integer", example=202)
     *                 )
     *             )
     *         )
     *     ),
     *
     *     @OA\Response(
     *         response=422,
     *         description="Validation error",
     *         @OA\JsonContent(
     *             @OA\Property(property="message", type="string", example="The given data was invalid."),
     *             @OA\Property(property="errors", type="object")
     *         )
     *     )
     * )
     */


    public function setStudentSubject(Request $request)
    {
        // Validate request
        $request->validate([
            "uid" => "required",
            "stid" => "required", // single or array of student IDs
            "sbj" => "required", // single or array of subject IDs
            "comp" => "required",
            "schid" => "required",
            "clsid" => "nullable",
            "trm" => "nullable",
            "ssn" => "nullable"
        ]);

        $students = is_array($request->stid) ? $request->stid : [$request->stid];
        $subjects = is_array($request->sbj) ? $request->sbj : [$request->sbj];

        $assigned = [];
        $skipped = [];

        foreach ($students as $stid) {
            foreach ($subjects as $sbj) {
                // -----------------------------------
                // 1. Handle student_subj
                // -----------------------------------
                $exists = student_subj::where('stid', $stid)
                    ->where('sbj', $sbj)
                    ->where('schid', $request->schid)
                    ->when($request->clsid, fn($q) => $q->where('clsid', $request->clsid))
                    ->when($request->trm, fn($q) => $q->where('trm', $request->trm))
                    ->when($request->ssn, fn($q) => $q->where('ssn', $request->ssn))
                    ->exists();

                if (!$exists) {
                    student_subj::create([
                        "uid" => $request->uid,
                        "stid" => $stid,
                        "sbj" => $sbj,
                        "comp" => $request->comp,
                        "schid" => $request->schid,
                        "clsid" => $request->clsid,
                        "trm" => $request->trm,
                        "ssn" => $request->ssn
                    ]);
                    $assigned[] = ["stid" => $stid, "sbj" => $sbj];
                } else {
                    $skipped[] = ["stid" => $stid, "sbj" => $sbj];
                }

                // -----------------------------------
                // 2. Handle class_subj
                // -----------------------------------
                class_subj::updateOrCreate(
                    [
                        "subj_id" => $sbj,
                        "schid" => $request->schid,
                        "clsid" => $request->clsid,
                        "sesn" => $request->ssn,
                        "trm" => $request->trm,
                    ],
                    [
                        "uid" => $request->uid,
                        "comp" => $request->comp,
                        "name" => subj::find($sbj)?->name, // assuming Subject model exists
                    ]
                );
            }
        }

        return response()->json([
            "status" => true,
            "message" => "Subjects assignment completed.",
            "assigned" => $assigned,
            "skipped" => $skipped,
        ]);
    }


    /**
     * @OA\Get(
     *     path="/api/getStudentSubjects/{stid}",
     *     summary="Fetch student subjects by student ID, with optional session and term filters",
     *     description="Retrieve subjects assigned to a particular student. You can optionally filter by session (ssn) and term (trm), and also control pagination using start and count parameters.",
     *     operationId="getStudentSubjects",
     *     tags={"Api"},
     *   security={{"bearerAuth": {}}},
     *
     *     @OA\Parameter(
     *         name="stid",
     *         in="path",
     *         required=true,
     *         description="The ID of the student",
     *         @OA\Schema(type="integer", example=207)
     *     ),
     *
     *     @OA\Parameter(
     *         name="ssn",
     *         in="query",
     *         required=false,
     *         description="Filter by academic session (e.g., 2025)",
     *         @OA\Schema(type="string", example="2025")
     *     ),
     *
     *     @OA\Parameter(
     *         name="trm",
     *         in="query",
     *         required=false,
     *         description="Filter by academic term (e.g., 1 for first term, 2 for second term)",
     *         @OA\Schema(type="integer", example=1)
     *     ),
     *
     *     @OA\Parameter(
     *         name="start",
     *         in="query",
     *         required=false,
     *         description="Starting index for pagination",
     *         @OA\Schema(type="integer", example=0)
     *     ),
     *
     *     @OA\Parameter(
     *         name="count",
     *         in="query",
     *         required=false,
     *         description="Number of records to return (default: 20)",
     *         @OA\Schema(type="integer", example=20)
     *     ),
     *
     *     @OA\Response(
     *         response=200,
     *         description="Successful response",
     *         @OA\JsonContent(
     *             type="object",
     *             @OA\Property(property="status", type="boolean", example=true),
     *             @OA\Property(property="message", type="string", example="Success"),
     *             @OA\Property(
     *                 property="pld",
     *                 type="array",
     *                 @OA\Items(
     *                     type="object",
     *                     @OA\Property(property="id", type="integer", example=1),
     *                     @OA\Property(property="stid", type="integer", example=207),
     *                     @OA\Property(property="sbj", type="string", example="Mathematics"),
     *                     @OA\Property(property="comp", type="integer", example=1),
     *                     @OA\Property(property="trm", type="integer", example=1),
     *                     @OA\Property(property="ssn", type="string", example="2025"),
     *                     @OA\Property(property="schid", type="integer", example=13),
     *                     @OA\Property(property="clsid", type="integer", example=10),
     *                     @OA\Property(property="created_at", type="string", format="date-time", example="2025-03-04T14:04:57"),
     *                     @OA\Property(property="updated_at", type="string", format="date-time", example="2025-03-04T14:04:57")
     *                 )
     *             )
     *         )
     *     ),
     *
     *     @OA\Response(
     *         response=400,
     *         description="Invalid parameters"
     *     ),
     *
     *     @OA\Response(
     *         response=404,
     *         description="Student not found or no subjects found"
     *     )
     * )
     */

    public function getStudentSubjects($stid)
    {
        $start = request()->input('start', 0);
        $count = request()->input('count', 20);
        $ssn = request()->input('ssn'); // session (optional)
        $trm = request()->input('trm'); // term (optional)

        $query = student_subj::where('stid', $stid);

        // Filter by session if provided
        if (!empty($ssn)) {
            $query->where('ssn', $ssn);
        }

        // Filter by term if provided
        if (!empty($trm)) {
            $query->where('trm', $trm);
        }

        $pld = $query
            ->skip($start)
            ->take($count)
            ->orderBy('id', 'asc')
            ->get();

        return response()->json([
            "status" => true,
            "message" => "Success",
            "pld" => $pld,
        ]);
    }






    /**
     * @OA\Delete(
     *     path="/api/deleteStudentSubject/{uid}/{sbj}/{ssn}/{trm}",
     *     summary="Delete a student's subject if the score is 0 or null",
     *     description="Deletes a subject assigned to a student only if all related scores are 0 or null. If the subject has scores greater than 0, deletion is not allowed.",
     *     operationId="deleteStudentSubject",
     *     tags={"Api"},
     *     security={{"bearerAuth": {}}},
     *
     *     @OA\Parameter(
     *         name="uid",
     *         in="path",
     *         required=true,
     *         description="Unique user ID of the student",
     *         @OA\Schema(type="string", example="STU123")
     *     ),
     *     @OA\Parameter(
     *         name="sbj",
     *         in="path",
     *         required=true,
     *         description="Subject code or name to be deleted",
     *         @OA\Schema(type="string", example="ENG101")
     *     ),
     *     @OA\Parameter(
     *         name="ssn",
     *         in="path",
     *         required=true,
     *         description="Academic session for the subject (e.g., 2024/2025)",
     *         @OA\Schema(type="string", example="2025")
     *     ),
     *     @OA\Parameter(
     *         name="trm",
     *         in="path",
     *         required=true,
     *         description="Term for the subject (e.g., 1st, 2nd, 3rd)",
     *         @OA\Schema(type="string", example="1")
     *     ),
     *
     *     @OA\Response(
     *         response=200,
     *         description="Subject and related zero/null scores deleted successfully.",
     *         @OA\JsonContent(
     *             @OA\Property(property="status", type="boolean", example=true),
     *             @OA\Property(property="message", type="string", example="Subject and related zero/null scores deleted successfully.")
     *         )
     *     ),
     *     @OA\Response(
     *         response=404,
     *         description="Subject not found.",
     *         @OA\JsonContent(
     *             @OA\Property(property="status", type="boolean", example=false),
     *             @OA\Property(property="message", type="string", example="Subject not found.")
     *         )
     *     ),
     *     @OA\Response(
     *         response=400,
     *         description="Cannot delete subject because it has scores greater than 0.",
     *         @OA\JsonContent(
     *             @OA\Property(property="status", type="boolean", example=false),
     *             @OA\Property(property="message", type="string", example="Cannot delete subject. It has scores greater than 0.")
     *         )
     *     )
     * )
     */



    public function deleteStudentSubject($uid, $sbj, $ssn, $trm)
    {
        // Retrieve the specific subject assigned to the student
        $subject = student_subj::where('uid', $uid)
            ->where('sbj', $sbj)
            ->where('ssn', $ssn)
            ->where('trm', $trm)
            ->first();

        if (!$subject) {
            return response()->json([
                "status" => false,
                "message" => "Subject not found."
            ], 404);
        }

        // Check if the subject has any score that is NOT zero or null
        $hasValidScores = std_score::where('stid', $subject->stid)
            ->where('sbj', $sbj)
            ->where('ssn', $ssn)
            ->where('trm', $trm)
            ->where(function ($query) {
                $query->where('scr', '>', 0);
            })
            ->exists();

        if ($hasValidScores) {
            return response()->json([
                "status" => false,
                "message" => "Cannot delete subject. It has scores greater than 0."
            ], 400);
        }

        // Delete the student subject and any zero or null scores
        std_score::where('stid', $subject->stid)
            ->where('sbj', $sbj)
            ->where('ssn', $ssn)
            ->where('trm', $trm)
            ->where(function ($query) {
                $query->whereNull('scr')
                    ->orWhere('scr', '=', 0);
            })
            ->delete();

        $subject->delete();

        return response()->json([
            "status" => true,
            "message" => "Subject deleted successfully."
        ]);
    }




    /**
     * @OA\Post(
     *     path="/api/setResultMeta",
     *     tags={"Api"},
     *     security={{"bearerAuth": {}}},
     *     summary="Set metadata for results",
     *     @OA\RequestBody(
     *         required=true,
     *         @OA\JsonContent(
     *             type="object",
     *             @OA\Property(property="uid", type="string"),
     *             @OA\Property(property="schid", type="string"),
     *             @OA\Property(property="ssn", type="string"),
     *             @OA\Property(property="trm", type="string"),
     *             @OA\Property(property="ntrd", type="string"),
     *             @OA\Property(property="sdob", type="string"),
     *             @OA\Property(property="spos", type="string"),
     *             @OA\Property(property="subj_pos", type="string"),
     *             @OA\Property(property="num_of_days", type="string"),
     *         )
     *     ),
     *     @OA\Response(response="200", description="Student data set successfully"),
     *     @OA\Response(response="400", description="Validation error"),
     * )
     */
    public function setResultMeta(Request $request)
    {
        //Data validation
        $request->validate([
            "uid" => "required",
            "schid" => "required",
            "ssn" => "required",
            "trm" => "required",
            "ntrd" => "required",
            "sdob" => "required",
            "spos" => "required",
            "subj_pos" => "nullable",
            "num_of_days" => "nullable",
        ]);

        result_meta::updateOrCreate(
            ["uid" => $request->uid,],
            [
                "schid" => $request->schid,
                "ssn" => $request->ssn,
                "trm" => $request->trm,
                "ntrd" => $request->ntrd,
                "sdob" => $request->sdob,
                "spos" => $request->spos,
                "subj_pos" => $request->subj_pos ?? 'y',
                "num_of_days" => $request->num_of_days,
            ]
        );
        return response()->json([
            "status" => true,
            "message" => "Success",
        ]);
    }




    /**
     * @OA\Get(
     *     path="/api/getResultMeta/{schid}/{ssn}/{trm}",
     *     tags={"Api"},
     *     security={{"bearerAuth": {}}},
     *     summary="Get a student's subjects",
     *     description="Use this endpoint to get subjects of a student.",
     *     @OA\Parameter(
     *         name="schid",
     *         in="path",
     *         required=true,
     *         description="School Id",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Parameter(
     *         name="ssn",
     *         in="path",
     *         required=true,
     *         description="Session ID",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Parameter(
     *         name="trm",
     *         in="path",
     *         required=true,
     *         description="Term ID",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Response(response="200", description="Success", @OA\JsonContent()),
     *     @OA\Response(response="401", description="Unauthorized"),
     * )
     */
    public function getResultMeta($schid, $ssn, $trm)
    {
        $pld = result_meta::where("schid", $schid)->where("ssn", $ssn)->where("trm", $trm)->first();
        return response()->json([
            "status" => true,
            "message" => "Success",
            "pld" => $pld,
        ]);
    }



    /**
     * @OA\Post(
     *     path="/api/setClassSubject",
     *     tags={"Api"},
     *     security={{"bearerAuth": {}}},
     *     summary="Set class compulsory and elective subjects",
     *     @OA\RequestBody(
     *         required=true,
     *         @OA\JsonContent(
     *             type="object",
     *             @OA\Property(property="uid", type="string"),
     *             @OA\Property(property="schid", type="string"),
     *             @OA\Property(property="subj_id", type="string"),
     *             @OA\Property(property="name", type="string"),
     *             @OA\Property(property="comp", type="string"),
     *             @OA\Property(property="clsid", type="string"),
     *             @OA\Property(property="sesn", type="string"),
     *             @OA\Property(property="trm", type="string"),
     *         )
     *     ),
     *     @OA\Response(response="200", description="class data set successfully"),
     *     @OA\Response(response="400", description="Validation error"),
     * )
     */


    public function setClassSubject(Request $request)
    {
        // Data validation
        $request->validate([
            "schid" => "required",
            "subj_id" => "required",
            "name" => "required",
            "comp" => "required",
            "clsid" => "required",
            "sesn" => "required",
            "trm" => "required",
        ]);

        // Generate deterministic UID without random number
        $uid = $request->subj_id
            . $request->schid
            . $request->clsid
            . $request->sesn
            . $request->trm;

        // Insert or update subject
        $pld = class_subj::updateOrCreate(
            ["uid" => $uid],
            [
                "schid" => $request->schid,
                "subj_id" => $request->subj_id,
                "name" => $request->name,
                "comp" => $request->comp,
                "clsid" => $request->clsid,
                "sesn" => $request->sesn,
                "trm" => $request->trm,
            ]
        );

        return response()->json([
            "status" => true,
            "message" => "Subject added successfully",
            "pld" => $pld
        ]);
    }




    /**
     * @OA\Get(
     *     path="/api/getClassSubjects/{schid}/{clsid}/{sesn}/{trm}",
     *     tags={"Api"},
     *     security={{"bearerAuth": {}}},
     *     summary="Get a class's subjects",
     *     description="Use this endpoint to get subjects of a class.",
     *     @OA\Parameter(
     *         name="schid",
     *         in="path",
     *         required=true,
     *         description="School Id",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Parameter(
     *         name="clsid",
     *         in="path",
     *         required=true,
     *         description="Class Id",
     *         @OA\Schema(type="string")
     *     ),
     *       @OA\Parameter(
     *         name="sesn",
     *         in="path",
     *         description="Academic session",
     *         required=true,
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Parameter(
     *         name="trm",
     *         in="path",
     *         description="Academic term",
     *         required=true,
     *         @OA\Schema(type="string")
     *     ),
     *      @OA\Parameter(
     *         name="start",
     *         in="query",
     *         required=false,
     *         description="Index to start at",
     *         @OA\Schema(type="integer")
     *     ),
     *     @OA\Parameter(
     *         name="count",
     *         in="query",
     *         required=false,
     *         description="No of records to retrieve",
     *         @OA\Schema(type="integer")
     *     ),
     *     @OA\Response(response="200", description="Success", @OA\JsonContent()),
     *     @OA\Response(response="401", description="Unauthorized"),
     * )
     */


    public function getClassSubjects($schid, $clsid, $sesn, $trm)
    {
        $start = 0;
        $count = 30; // increased from 20 to 30

        if (request()->has('start') && request()->has('count')) {
            $start = request()->input('start');
            $count = request()->input('count');
        }

        $pld = class_subj::where("schid", $schid)
            ->where("clsid", $clsid)
            ->where("sesn", $sesn)
            ->where("trm", $trm)
            ->orderBy('created_at', 'asc') // optional, but helps maintain consistent order
            ->skip($start)
            ->take($count)
            ->get();

        return response()->json([
            "status" => true,
            "message" => "Success",
            "pld" => $pld,
        ]);
    }




    /**
     * @OA\Get(
     *     path="/api/getClassSubjectsByStaff/{schid}/{clsid}/{stid}",
     *     summary="Get subjects assigned to a staff for a class",
     *     description="Fetches all subjects that a staff member teaches for a specific class, session, and term.",
     *     tags={"Api"},
     *    security={{"bearerAuth": {}}},
     *     operationId="getClassSubjectsByStaff",
     *
     *     @OA\Parameter(
     *         name="schid",
     *         in="path",
     *         description="School ID",
     *         required=true,
     *         @OA\Schema(type="integer")
     *     ),
     *     @OA\Parameter(
     *         name="clsid",
     *         in="path",
     *         description="Class ID",
     *         required=true,
     *         @OA\Schema(type="integer")
     *     ),
     *     @OA\Parameter(
     *         name="stid",
     *         in="path",
     *         description="Staff ID",
     *         required=true,
     *         @OA\Schema(type="integer")
     *     ),
     *     @OA\Parameter(
     *         name="sesn",
     *         in="query",
     *         description="Session (e.g., 2024, 2025)",
     *         required=true,
     *         @OA\Schema(type="integer")
     *     ),
     *     @OA\Parameter(
     *         name="trm",
     *         in="query",
     *         description="Term (e.g., 1, 2, 3)",
     *         required=true,
     *         @OA\Schema(type="integer")
     *     ),
     *     @OA\Parameter(
     *         name="start",
     *         in="query",
     *         description="Pagination start index",
     *         required=false,
     *         @OA\Schema(type="integer", default=0)
     *     ),
     *     @OA\Parameter(
     *         name="count",
     *         in="query",
     *         description="Number of records to return",
     *         required=false,
     *         @OA\Schema(type="integer", default=20)
     *     ),
     *     @OA\Response(
     *         response=200,
     *         description="Successful response with subjects",
     *         @OA\JsonContent(
     *             type="object",
     *             @OA\Property(property="status", type="boolean", example=true),
     *             @OA\Property(property="message", type="string", example="Success"),
     *             @OA\Property(
     *                 property="pld",
     *                 type="array",
     *                 @OA\Items(
     *                     type="object",
     *                     @OA\Property(property="subj_id", type="integer", example=100),
     *                     @OA\Property(property="name", type="string", example="FRENCH"),
     *                     @OA\Property(property="comp", type="string", example="Core"),
     *                     @OA\Property(property="clsid", type="integer", example=11),
     *                     @OA\Property(property="schid", type="integer", example=31),
     *                     @OA\Property(property="sesn", type="integer", example=2024),
     *                     @OA\Property(property="trm", type="integer", example=1)
     *                 )
     *             )
     *         )
     *     ),
     *     @OA\Response(
     *         response=400,
     *         description="Bad request"
     *     ),
     *     @OA\Response(
     *         response=404,
     *         description="Data not found"
     *     )
     * )
     */


    public function getClassSubjectsByStaff($schid, $clsid, $stid)
    {
        $sesn = request()->input('sesn');
        $trm = request()->input('trm');
        $start = request()->input('start', 0);
        $count = request()->input('count', 20);

        $query = class_subj::join('staff_subj', 'class_subj.subj_id', '=', 'staff_subj.sbj')
            ->where('class_subj.schid', $schid)
            ->where('class_subj.clsid', $clsid)
            ->where('staff_subj.stid', $stid)
            ->when($sesn, function ($q) use ($sesn) {
                $q->where('class_subj.sesn', $sesn)
                    ->where('staff_subj.sesn', $sesn);
            })
            ->when($trm, function ($q) use ($trm) {
                $q->where('class_subj.trm', $trm)
                    ->where('staff_subj.trm', $trm);
            })
            ->select(
                'class_subj.subj_id',
                'class_subj.name',
                'class_subj.comp',
                'class_subj.clsid',
                'class_subj.schid',
                'class_subj.sesn',
                'class_subj.trm'
            )
            ->orderBy('class_subj.name', 'asc');

        $pld = $query->get();

        // Remove duplicates manually based on subj_id
        $pld = $pld->unique('subj_id')->values();

        // Paginate after deduplication
        $pld = $pld->slice($start, $count)->values();

        return response()->json([
            'status' => true,
            'message' => 'Success',
            'pld' => $pld,
        ]);
    }






    /**
     * @OA\Get(
     *     path="/api/getClassSubject/{schid}/{clsid}/{sbid}",
     *     tags={"Api"},
     *     security={{"bearerAuth": {}}},
     *     summary="Get a class's subjects",
     *     description="Use this endpoint to get subjects of a class.",
     *     @OA\Parameter(
     *         name="schid",
     *         in="path",
     *         required=true,
     *         description="School Id",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Parameter(
     *         name="clsid",
     *         in="path",
     *         required=true,
     *         description="Class Id",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Parameter(
     *         name="sbid",
     *         in="path",
     *         required=true,
     *         description="Subject Id",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Response(response="200", description="Success", @OA\JsonContent()),
     *     @OA\Response(response="401", description="Unauthorized"),
     * )
     */
    public function getClassSubject($schid, $clsid, $sbid)
    {
        $pld = class_subj::where("schid", $schid)->where("clsid", $clsid)->where('subj_id', $sbid)->first();
        return response()->json([
            "status" => true,
            "message" => "Success",
            "pld" => $pld,
        ]);
    }

    /**
     * @OA\Get(
     *     path="/api/deleteClassSubject/{uid}",
     *     tags={"Api"},
     *     summary="Delete a class subject",
     *     description="Use this endpoint to delete a class subject",
     *
     *     @OA\Parameter(
     *         name="uid",
     *         in="path",
     *         required=true,
     *         description="ID of the record",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Response(response="200", description="Success", @OA\JsonContent()),
     *     @OA\Response(response="401", description="Unauthorized"),
     * )
     */
    public function deleteClassSubject($uid)
    {
        $pld = class_subj::where('uid', $uid)->delete();
        return response()->json([
            "status" => true,
            "message" => "Success",
            "pld" => $pld,
        ]);
    }

    /**
     * @OA\Post(
     *     path="/api/setClassMark",
     *     tags={"Api"},
     *     summary="Set a Class Mark. If new, no need for id param. Otherwise, specify",
     *     description="This endpoint is used to set information about a class mark.",
     *     security={{"bearerAuth": {}}},
     *     @OA\RequestBody(
     *         required=true,
     *         @OA\JsonContent(
     *             type="object",
     *             @OA\Property(property="name", type="string"),
     *             @OA\Property(property="ise", type="string"),
     *             @OA\Property(property="pt", type="string"),
     *             @OA\Property(property="schid", type="string"),
     *             @OA\Property(property="clsid", type="string"),
     *             @OA\Property(property="ssn", type="string"),
     *             @OA\Property(property="trm", type="string"),
     *         )
     *     ),
     *     @OA\Response(response="200", description="Success"),
     *     @OA\Response(response="401", description="Unauthorized"),
     * )
     */
    public function setClassMark(Request $request)
    {
        $request->validate([
            'name' => 'required',
            'ise' => 'required',
            'pt' => 'required',
            'schid' => 'required',
            'clsid' => 'required',
            'ssn' => 'required',
            'trm' => 'required',
        ]);
        $data = [
            'name' => $request->name,
            'ise' => $request->ise,
            'pt' => $request->pt,
            'schid' => $request->schid,
            'clsid' => $request->clsid,
            'ssn' => $request->ssn,
            'trm' => $request->trm,
        ];
        $class_mark = [];
        if ($request->has('id')) {
            $class_mark = sch_mark::where('id', $request->id)->first();
            if ($class_mark) {
                $class_mark->update($data);
            } else {
                return response()->json([
                    "status" => false,
                    "message" => "Mark Not Found",
                ]);
            }
        } else {
            $class_mark = sch_mark::create($data);
        }
        return response()->json([
            "status" => true,
            "message" => "Success",
            "pld" => $class_mark
        ]);
    }

    /**
     * @OA\Get(
     *     path="/api/getClassMarks/{schid}/{clsid}/{ssn}/{trm}",
     *     tags={"Api"},
     *     summary="Get All Marks for this Class",
     *     description="Use this endpoint to get a list of class marks",
     *     @OA\Parameter(
     *         name="schid",
     *         in="path",
     *         required=true,
     *         description="School Id",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Parameter(
     *         name="clsid",
     *         in="path",
     *         required=true,
     *         description="Class Id",
     *         @OA\Schema(type="string")
     *     ),@OA\Parameter(
     *         name="ssn",
     *         in="path",
     *         required=true,
     *         description="Session Id",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Parameter(
     *         name="trm",
     *         in="path",
     *         required=true,
     *         description="Term Id",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Response(response="200", description="Success", @OA\JsonContent()),
     *     @OA\Response(response="401", description="Unauthorized"),
     * )
     */
    public function getClassMarks($schid, $clsid, $ssn, $trm)
    {
        $pld = sch_mark::where("schid", $schid)->where("clsid", $clsid)->where("ssn", $ssn)->where("trm", $trm)->get();
        return response()->json([
            "status" => true,
            "message" => "Success",
            "pld" => $pld,
        ]);
    }

    /**
     * @OA\Post(
     *     path="/api/setArmResultConf",
     *     tags={"Api"},
     *     summary="Confirm a result. If new, no need for id param. Otherwise, specify",
     *     description="This endpoint is used to confirm a class arm result.",
     *     security={{"bearerAuth": {}}},
     *     @OA\RequestBody(
     *         required=true,
     *         @OA\JsonContent(
     *             type="object",
     *             @OA\Property(property="arm", type="string"),
     *             @OA\Property(property="stid", type="string"),
     *             @OA\Property(property="schid", type="string"),
     *             @OA\Property(property="clsid", type="string"),
     *             @OA\Property(property="sbid", type="string"),
     *             @OA\Property(property="ssn", type="string"),
     *             @OA\Property(property="trm", type="string"),
     *             @OA\Property(property="rmk", type="string"),
     *             @OA\Property(property="stat", type="string"),
     *         )
     *     ),
     *     @OA\Response(response="200", description="Success"),
     *     @OA\Response(response="401", description="Unauthorized"),
     * )
     */
    public function setArmResultConf(Request $request)
    {
        $request->validate([
            'arm' => 'required',
            'stid' => 'required',
            'schid' => 'required',
            'clsid' => 'required',
            'sbid' => 'required',
            'ssn' => 'required',
            'trm' => 'required',
            'rmk' => 'required',
            'stat' => 'required',
        ]);
        $data = [
            'arm' => $request->arm,
            'stid' => $request->stid,
            'schid' => $request->schid,
            'clsid' => $request->clsid,
            'sbid' => $request->sbid,
            'ssn' => $request->ssn,
            'trm' => $request->trm,
            'rmk' => $request->rmk,
            'stat' => $request->stat,
        ];
        $arm_result_conf = [];
        if ($request->has('id')) {
            $arm_result_conf = arm_result_conf::where('id', $request->id)->first();
            if ($arm_result_conf) {
                $arm_result_conf->update($data);
            } else {
                return response()->json([
                    "status" => false,
                    "message" => "Result Conf Not Found",
                ]);
            }
        } else {
            $arm_result_conf = arm_result_conf::create($data);
        }
        return response()->json([
            "status" => true,
            "message" => "Success",
            // "pld"=> $arm_result_conf
        ]);
    }

    /**
     * @OA\Get(
     *     path="/api/getArmResultConf/{schid}/{clsid}/{sbid}/{ssn}/{trm}/{arm}",
     *     tags={"Api"},
     *     security={{"bearerAuth": {}}},
     *     summary="Get result conf for this session/term",
     *     description="Use this endpoint to get result conf for this session/term",
     *     @OA\Parameter(
     *         name="schid",
     *         in="path",
     *         required=true,
     *         description="School Id",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Parameter(
     *         name="clsid",
     *         in="path",
     *         required=true,
     *         description="Class Id",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Parameter(
     *         name="sbid",
     *         in="path",
     *         required=true,
     *         description="Subject Id",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Parameter(
     *         name="ssn",
     *         in="path",
     *         required=true,
     *         description="Session Id",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Parameter(
     *         name="trm",
     *         in="path",
     *         required=true,
     *         description="Term Id",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Parameter(
     *         name="arm",
     *         in="path",
     *         required=true,
     *         description="Arm Id",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Response(response="200", description="Success", @OA\JsonContent()),
     *     @OA\Response(response="401", description="Unauthorized"),
     * )
     */

    public function getArmResultConf($schid, $clsid, $sbid, $ssn, $trm, $arm)
    {
        $pld = arm_result_conf::join('student', 'arm_result_conf.stid', '=', 'student.sid')
            ->where('arm_result_conf.schid', $schid)
            ->where('arm_result_conf.clsid', $clsid)
            ->where('arm_result_conf.sbid', $sbid)
            ->where('arm_result_conf.ssn', $ssn)
            ->where('arm_result_conf.trm', $trm)
            ->where('arm_result_conf.arm', $arm)
            ->where('student.status', 'active')
            ->select('arm_result_conf.*')
            ->first();

        return response()->json([
            "status" => true,
            "message" => $pld ? "Success" : "Not Found",
            "pld" => $pld,
        ]);
    }


    /**
     * @OA\Get(
     *     path="/api/getStudentResultsByArm/{schid}/{clsid}/{ssn}/{trm}/{arm}",
     *     tags={"Api"},
     *
     *     summary="Get students result",
     *     description="Use this endpoint to get students result.",
     *     @OA\Parameter(
     *         name="schid",
     *         in="path",
     *         required=true,
     *         description="School Id",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Parameter(
     *         name="clsid",
     *         in="path",
     *         required=true,
     *         description="Class Id",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Parameter(
     *         name="ssn",
     *         in="path",
     *         required=true,
     *         description="Session Id",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Parameter(
     *         name="trm",
     *         in="path",
     *         required=true,
     *         description="Term Id",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Parameter(
     *         name="arm",
     *         in="path",
     *         required=true,
     *         description="Arm Id",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Response(response="200", description="Success", @OA\JsonContent()),
     *     @OA\Response(response="401", description="Unauthorized"),
     * )
     */



    // public function getStudentResultsByArm($schid, $clsid, $ssn, $trm, $arm)
    // {

    //     $user = auth()->user();

    //     // Check if results are published for this class/arm/term
    //     $isPublished = student_res::where([
    //         ['schid', $schid],
    //         ['ssn', $ssn],
    //         ['trm', $trm],
    //         ['clsm', $clsid],
    //         ['clsa', $arm],
    //         ['stat', 1], // PUBLISHED
    //     ])->exists();

    //     /**
    //      * IF NOT PUBLISHED:
    //      * - Only School Admin (a, s) can view (Bulk Result)
    //      * - Everyone else is blocked
    //      */
    //     if (!$isPublished) {
    //         if (!$user || !in_array($user->typ, ['a', 's'])) {
    //             return response()->json([
    //                 'status' => false,
    //                 'message' => 'Results have not been published yet.'
    //             ], 403);
    //         }
    //     }

    //     // Ensure we only fetch students for the selected session + class + arm + term
    //     $members = student::join('old_student', 'student.sid', '=', 'old_student.sid')
    //         ->where('student.schid', $schid)
    //         ->where('student.stat', "1")
    //         ->where('student.status', "active")
    //         ->where('old_student.ssn', $ssn)
    //         ->where('old_student.trm', $trm)   // filter by term
    //         ->where('old_student.clsm', $clsid)
    //         ->where('old_student.status', "active")
    //         ->where('old_student.clsa', $arm)
    //         ->select('student.*', 'old_student.uid as old_uid') // FIX: use uid instead of id
    //         ->distinct('student.sid') // one record per student
    //         ->get();

    //     $totalStd = count($members);
    //     $cstds = [];
    //     $relevantSubjects = [];
    //     $clsSbj = [];

    //     // Get class subjects (avoid duplicate sbj)
    //     $relevantClassSubjects = class_subj::join('staff_subj', 'class_subj.subj_id', '=', 'staff_subj.sbj')
    //         ->where('class_subj.schid', $schid)
    //         ->where('class_subj.clsid', $clsid)
    //         ->pluck('sbj')
    //         ->unique(); // prevent duplicates

    //     $nof = (int) (result_meta::where([
    //         ['schid', $schid],
    //         ['ssn', $ssn],
    //         ['trm', $trm],
    //     ])->value('num_of_days') ?? 0);

    //     foreach ($members as $member) {
    //         $user_id = $member->sid;

    //         $res = student_res::where("schid", $schid)
    //             ->where("ssn", $ssn)
    //             ->where("trm", $trm)
    //             ->where("clsm", $clsid)
    //             ->where("clsa", $arm)
    //             ->where("stid", $user_id)
    //             ->first();

    //         $academicData = student_academic_data::where('user_id', $user_id)->first();
    //         $basicData = student_basic_data::where('user_id', $user_id)->first();
    //         $psy = student_psy::where("schid", $schid)
    //             ->where("ssn", $ssn)
    //             ->where("trm", $trm)
    //             ->where("clsm", $clsid)
    //             ->where("clsa", $arm)
    //             ->where("stid", $user_id)
    //             ->first();

    //         $std = old_student::where("schid", $schid)
    //             ->where("ssn", $ssn)
    //             ->where("trm", $trm) // make sure it's the selected term
    //             ->where("clsm", $clsid)
    //             ->where("status", "active")
    //             ->where("clsa", $arm)
    //             ->where("sid", $user_id)
    //             ->first();

    //         $studentSubjects = student_subj::where('stid', $user_id)
    //             ->whereIn('sbj', $relevantClassSubjects)
    //             ->pluck('sbj');

    //         $allScores = std_score::where('stid', $user_id)
    //             ->where("schid", $schid)
    //             ->where("ssn", $ssn)
    //             ->where("trm", $trm)
    //             ->whereIn("sbj", $studentSubjects)
    //             ->where("clsid", $clsid)
    //             ->whereNotNull('scr')
    //             ->where('scr', '>', 0)
    //             ->get();

    //         $mySbjs = [];
    //         foreach ($allScores as $scr) {
    //             $sbid = $scr->sbj;
    //             if (!in_array($sbid, $mySbjs)) {
    //                 $mySbjs[] = $sbid;
    //             }
    //             if (!in_array($sbid, $relevantSubjects)) {
    //                 $schSbj = subj::where('id', $sbid)->first();
    //                 if ($schSbj) {
    //                     $clsSbj[$sbid] = $schSbj; // prevent duplicate subjects
    //                     $relevantSubjects[] = $sbid;
    //                 }
    //             }
    //         }

    //         $subjectScores = [];
    //         foreach ($mySbjs as $sbid) {
    //             $subjectScores[$sbid] = [];
    //         }

    //         $scores = [];
    //         foreach ($allScores as $scr) {
    //             $sbid = $scr->sbj;
    //             $subjectScores[$sbid][] = $scr;
    //         }

    //         $positions = [];
    //         foreach ($mySbjs as $sbid) {
    //             $scores[] = [
    //                 'sbid' => $sbid,
    //                 'scores' => $subjectScores[$sbid]
    //             ];
    //             $subjectPosition = student_sub_res::where('stid', $user_id)
    //                 ->where('sbj', $sbid)
    //                 ->where("schid", $schid)
    //                 ->where("ssn", $ssn)
    //                 ->where("trm", $trm)
    //                 ->where("clsm", $clsid)
    //                 ->where("clsa", $arm)
    //                 ->first();

    //             $positions[] = [
    //                 'sbid' => $sbid,
    //                 'pos' => $subjectPosition ? $subjectPosition->pos : null,
    //             ];
    //         }

    //         $psyexist = student_psy::where([
    //             ['schid', $schid],
    //             ['ssn', $ssn],
    //             ['trm', $trm],
    //             ['clsm', $clsid],
    //             ['stid', $user_id]
    //         ])->exists();

    //         $resexist = $res->stat ?? "0";

    //         // Individual attendance logic
    //         $presentCount = 0;
    //         $absentCount = 0;

    //         $attendanceQuery = \DB::table('attendances')
    //             ->where('schid', $schid)
    //             ->where('ssn', $ssn)
    //             ->where('trm', $trm)
    //             ->where('sid', $user_id);

    //         if ($attendanceQuery->exists()) {
    //             $presentCount = $attendanceQuery->where('status', '1')->count();
    //             $absentCount = max(0, $nof - $presentCount);
    //         }

    //         $studentres = [
    //             'std' => $std,
    //             'sbj' => $mySbjs,
    //             'scr' => $scores,
    //             'psy' => $psyexist,
    //             'res' => $resexist,
    //             'present_days' => $presentCount,
    //             'absent_days' => $absentCount,
    //         ];

    //         $cstds[] = [
    //             's' => $member,
    //             'b' => $basicData,
    //             'a' => $academicData,
    //             'p' => $psy,
    //             'r' => $res,
    //             'rs' => $studentres,
    //             'cnt' => $totalStd,
    //             'spos' => $positions
    //         ];
    //     }

    //     $pld = [
    //         'std-pld' => $cstds,
    //         'cls-sbj' => array_values($clsSbj), // return unique subjects only
    //         'num_of_days' => $nof,
    //     ];

    //     return response()->json([
    //         "status" => true,
    //         "message" => "Success",
    //         "pld" => $pld,
    //     ]);
    // }

    public function getStudentResultsByArm($schid, $clsid, $ssn, $trm, $arm)
    {
        // Ensure we only fetch students for the selected session + class + arm + term
        $members = student::join('old_student', 'student.sid', '=', 'old_student.sid')
            ->where('student.schid', $schid)
            ->where('student.stat', "1")
            ->where('student.status', "active")
            ->where('old_student.ssn', $ssn)
            ->where('old_student.trm', $trm)   // filter by term
            ->where('old_student.clsm', $clsid)
            ->where('old_student.status', "active")
            ->where('old_student.clsa', $arm)
            ->select('student.*', 'old_student.uid as old_uid') // FIX: use uid instead of id
            ->distinct('student.sid') // one record per student
            ->get();

        $totalStd = count($members);
        $cstds = [];
        $relevantSubjects = [];
        $clsSbj = [];

        // Get class subjects (avoid duplicate sbj)
        $relevantClassSubjects = class_subj::join('staff_subj', 'class_subj.subj_id', '=', 'staff_subj.sbj')
            ->where('class_subj.schid', $schid)
            ->where('class_subj.clsid', $clsid)
            ->pluck('sbj')
            ->unique(); // prevent duplicates

        $nof = (int) (result_meta::where([
            ['schid', $schid],
            ['ssn', $ssn],
            ['trm', $trm],
        ])->value('num_of_days') ?? 0);

        foreach ($members as $member) {
            $user_id = $member->sid;

            $res = student_res::where("schid", $schid)
                ->where("ssn", $ssn)
                ->where("trm", $trm)
                ->where("clsm", $clsid)
                ->where("clsa", $arm)
                ->where("stid", $user_id)
                ->first();

            $academicData = student_academic_data::where('user_id', $user_id)->first();
            $basicData = student_basic_data::where('user_id', $user_id)->first();
            $psy = student_psy::where("schid", $schid)
                ->where("ssn", $ssn)
                ->where("trm", $trm)
                ->where("clsm", $clsid)
                ->where("clsa", $arm)
                ->where("stid", $user_id)
                ->first();

            $std = old_student::where("schid", $schid)
                ->where("ssn", $ssn)
                ->where("trm", $trm) // make sure it's the selected term
                ->where("clsm", $clsid)
                ->where("status", "active")
                ->where("clsa", $arm)
                ->where("sid", $user_id)
                ->first();

            $studentSubjects = student_subj::where('stid', $user_id)
                ->whereIn('sbj', $relevantClassSubjects)
                ->pluck('sbj');

            $allScores = std_score::where('stid', $user_id)
                ->where("schid", $schid)
                ->where("ssn", $ssn)
                ->where("trm", $trm)
                ->whereIn("sbj", $studentSubjects)
                ->where("clsid", $clsid)
                ->whereNotNull('scr')
                ->where('scr', '>', 0)
                ->get();

            $mySbjs = [];
            foreach ($allScores as $scr) {
                $sbid = $scr->sbj;
                if (!in_array($sbid, $mySbjs)) {
                    $mySbjs[] = $sbid;
                }
                if (!in_array($sbid, $relevantSubjects)) {
                    $schSbj = subj::where('id', $sbid)->first();
                    if ($schSbj) {
                        $clsSbj[$sbid] = $schSbj; // prevent duplicate subjects
                        $relevantSubjects[] = $sbid;
                    }
                }
            }

            $subjectScores = [];
            foreach ($mySbjs as $sbid) {
                $subjectScores[$sbid] = [];
            }

            $scores = [];
            foreach ($allScores as $scr) {
                $sbid = $scr->sbj;
                $subjectScores[$sbid][] = $scr;
            }

            $positions = [];
            foreach ($mySbjs as $sbid) {
                $scores[] = [
                    'sbid' => $sbid,
                    'scores' => $subjectScores[$sbid]
                ];
                $subjectPosition = student_sub_res::where('stid', $user_id)
                    ->where('sbj', $sbid)
                    ->where("schid", $schid)
                    ->where("ssn", $ssn)
                    ->where("trm", $trm)
                    ->where("clsm", $clsid)
                    ->where("clsa", $arm)
                    ->first();

                $positions[] = [
                    'sbid' => $sbid,
                    'pos' => $subjectPosition ? $subjectPosition->pos : null,
                ];
            }

            $psyexist = student_psy::where([
                ['schid', $schid],
                ['ssn', $ssn],
                ['trm', $trm],
                ['clsm', $clsid],
                ['stid', $user_id]
            ])->exists();

            $resexist = $res->stat ?? "0";

            // Individual attendance logic
            $presentCount = 0;
            $absentCount = 0;

            $attendanceQuery = \DB::table('attendances')
                ->where('schid', $schid)
                ->where('ssn', $ssn)
                ->where('trm', $trm)
                ->where('sid', $user_id);

            if ($attendanceQuery->exists()) {
                $presentCount = $attendanceQuery->where('status', '1')->count();
                $absentCount = max(0, $nof - $presentCount);
            }

            $studentres = [
                'std' => $std,
                'sbj' => $mySbjs,
                'scr' => $scores,
                'psy' => $psyexist,
                'res' => $resexist,
                'present_days' => $presentCount,
                'absent_days' => $absentCount,
            ];

            $cstds[] = [
                's' => $member,
                'b' => $basicData,
                'a' => $academicData,
                'p' => $psy,
                'r' => $res,
                'rs' => $studentres,
                'cnt' => $totalStd,
                'spos' => $positions
            ];
        }

        $pld = [
            'std-pld' => $cstds,
            'cls-sbj' => array_values($clsSbj), // return unique subjects only
            'num_of_days' => $nof,
        ];

        return response()->json([
            "status" => true,
            "message" => "Success",
            "pld" => $pld,
        ]);
    }




    /**
     * @OA\Post(
     *     path="/api/setStudentScore",
     *     tags={"Api"},
     *     summary="Set a student score. If new, no need for id param. Otherwise, specify",
     *     description="This endpoint is used to set information about a student score.",
     *     security={{"bearerAuth": {}}},
     *     @OA\RequestBody(
     *         required=true,
     *         @OA\JsonContent(
     *             type="object",
     *             @OA\Property(property="stid", type="string"),
     *             @OA\Property(property="scr", type="integer"),
     *             @OA\Property(property="sbj", type="string"),
     *             @OA\Property(property="schid", type="string"),
     *             @OA\Property(property="clsid", type="string"),
     *             @OA\Property(property="ssn", type="string"),
     *             @OA\Property(property="trm", type="string"),
     *             @OA\Property(property="aid", type="string"),
     *         )
     *     ),
     *     @OA\Response(response="200", description="Success"),
     *     @OA\Response(response="401", description="Unauthorized"),
     * )
     */
    public function setStudentScore(Request $request)
    {
        $request->validate([
            'stid' => 'required',
            'scr' => 'required',
            'sbj' => 'required',
            'schid' => 'required',
            'clsid' => 'required',
            'ssn' => 'required',
            'trm' => 'required',
            'aid' => 'required',
        ]);
        $data = [
            'stid' => $request->stid,
            'scr' => $request->scr,
            'sbj' => $request->sbj,
            'schid' => $request->schid,
            'clsid' => $request->clsid,
            'ssn' => $request->ssn,
            'trm' => $request->trm,
            'aid' => $request->aid,
        ];
        $std_score = [];
        if ($request->has('id')) {
            $std_score = std_score::where('id', $request->id)->first();
            if ($std_score) {
                $std_score->update($data);
            } else {
                return response()->json([
                    "status" => false,
                    "message" => "Score Not Found",
                ]);
            }
        } else {
            $std_score = std_score::create($data);
        }
        return response()->json([
            "status" => true,
            "message" => "Success",
            "pld" => $std_score
        ]);
    }

    /**
     * @OA\Get(
     *     path="/api/studentHasExamRecord/{schid}/{clsid}/{ssn}/{trm}/{stid}",
     *     tags={"Api"},
     *     security={{"bearerAuth": {}}},
     *     summary="Check if a student has any exam record for this session/term",
     *     description="Use this endpoint to Check if a student has any exam record for this session/term",
     *     @OA\Parameter(
     *         name="schid",
     *         in="path",
     *         required=true,
     *         description="School Id",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Parameter(
     *         name="clsid",
     *         in="path",
     *         required=true,
     *         description="Class Id",
     *         @OA\Schema(type="string")
     *     ),@OA\Parameter(
     *         name="ssn",
     *         in="path",
     *         required=true,
     *         description="Session Id",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Parameter(
     *         name="trm",
     *         in="path",
     *         required=true,
     *         description="Term Id",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Parameter(
     *         name="stid",
     *         in="path",
     *         required=true,
     *         description="Student Id",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Response(response="200", description="Success", @OA\JsonContent()),
     *     @OA\Response(response="401", description="Unauthorized"),
     * )
     */
    public function studentHasExamRecord($schid, $clsid, $ssn, $trm, $stid)
    {
        $pld = std_score::where("stid", $stid)->where("schid", $schid)->where("clsid", $clsid)->where("ssn", $ssn)->where("trm", $trm)->first();
        return response()->json([
            "status" => true,
            "message" => "Success",
            "pld" => $pld,
        ]);
    }

    /**
     * @OA\Post(
     *     path="/api/setClassGrade",
     *     tags={"Api"},
     *     security={{"bearerAuth": {}}},
     *     summary="Set class grade",
     *     @OA\RequestBody(
     *         required=true,
     *         @OA\JsonContent(
     *             type="object",
     *             @OA\Property(property="grd", type="string"),
     *             @OA\Property(property="g0", type="string"),
     *             @OA\Property(property="g1", type="string"),
     *             @OA\Property(property="schid", type="string"),
     *             @OA\Property(property="clsid", type="string"),
     *             @OA\Property(property="ssn", type="string"),
     *             @OA\Property(property="trm", type="string"),
     *         )
     *     ),
     *     @OA\Response(response="200", description="class data set successfully"),
     *     @OA\Response(response="400", description="Validation error"),
     * )
     */
    public function setClassGrade(Request $request)
    {
        //Data validation
        $request->validate([
            "grd" => "required",
            "g0" => "required",
            "g1" => "required",
            "schid" => "required",
            "clsid" => "required",
            "ssn" => "required",
            "trm" => "required",
        ]);
        $uid = $request->schid . $request->clsid . $request->ssn . $request->trm . $request->grd;
        sch_grade::updateOrCreate(
            ["uid" => $uid,],
            [
                "grd" => $request->grd,
                "g0" => $request->g0,
                "g1" => $request->g1,
                "schid" => $request->schid,
                "clsid" => $request->clsid,
                "ssn" => $request->ssn,
                "trm" => $request->trm,
            ]
        );
        return response()->json([
            "status" => true,
            "message" => "Success",
        ]);
    }


    /**
     * @OA\Get(
     *     path="/api/getClassGrades/{schid}/{clsid}/{ssn}/{trm}",
     *     tags={"Api"},
     *     security={{"bearerAuth": {}}},
     *     summary="Get a class's grades",
     *     description="Use this endpoint to get grades of a class.",
     *     @OA\Parameter(
     *         name="schid",
     *         in="path",
     *         required=true,
     *         description="School Id",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Parameter(
     *         name="clsid",
     *         in="path",
     *         required=true,
     *         description="Class Id",
     *         @OA\Schema(type="string")
     *     ),@OA\Parameter(
     *         name="ssn",
     *         in="path",
     *         required=true,
     *         description="Session Id",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Parameter(
     *         name="trm",
     *         in="path",
     *         required=true,
     *         description="Term Id",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Response(response="200", description="Success", @OA\JsonContent()),
     *     @OA\Response(response="401", description="Unauthorized"),
     * )
     */
    public function getClassGrades($schid, $clsid, $ssn, $trm)
    {
        $pld = sch_grade::where("schid", $schid)->where("clsid", $clsid)->where("ssn", $ssn)->where("trm", $trm)->get();
        return response()->json([
            "status" => true,
            "message" => "Success",
            "pld" => $pld,
        ]);
    }

    /**
     * @OA\Get(
     *     path="/api/getStudent",
     *     tags={"Api"},
     *
     *     summary="Get a student",
     *     description="Use this endpoint to get a student.",
     *     @OA\Parameter(
     *         name="uid",
     *         in="query",
     *         required=true,
     *         description="User Id of the student",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Parameter(
     *         name="combined",
     *         in="query",
     *         required=false,
     *         description="should be combined?",
     *         @OA\Schema(type="boolean")
     *     ),
     *      @OA\Parameter(
     *         name="schid",
     *         in="query",
     *         required=true,
     *         description="School ID",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Response(response="200", description="Success", @OA\JsonContent()),
     *     @OA\Response(response="401", description="Unauthorized"),
     * )
     */

    public function getStudent()
    {
        $combined = false;
        if (request()->has('combined')) {
            $combined = request()->input('combined');
        }

        $uid = request()->input('uid', '');
        $schid = request()->input('schid', '');

        if ($uid === '' || $schid === '') {
            return response()->json([
                "status" => false,
                "message" => "No UID/School ID provided",
            ], 400);
        }

        if ($combined) {
            $pld = [];
            $compo = explode("/", $uid);
            $members = [];

            if (count($compo) == 4) {
                [$sch3, $year, $term, $count] = $compo;
                $members = student::where("schid", $schid)
                    ->where("stat", "1")
                    ->where("sch3", $sch3)
                    ->where("year", $year)
                    ->where("term", $term)
                    ->where("count", $count)
                    ->get();
            } else {
                $members = student::where("schid", $schid)
                    ->where("stat", "1")
                    ->where("cuid", $uid)
                    ->get();
            }

            foreach ($members as $member) {
                $user_id = $member->sid;
                $academicData = student_academic_data::where('user_id', $user_id)->first();
                $basicData = student_basic_data::where('user_id', $user_id)->first();

                $oldStudent = old_student::where('sid', $user_id)
                    ->where('schid', $schid)
                    ->first();
                $suid = $oldStudent ? $oldStudent->suid : null;

                $pld[] = [
                    's' => $member,
                    'b' => $basicData,
                    'a' => $academicData,
                    'suid' => $suid, // added suid here
                ];
            }
        } else {
            $student = student::where("schid", $schid)
                ->where("stat", "1")
                ->where("sid", $uid)
                ->first();

            $oldStudent = old_student::where('sid', $uid)
                ->where('schid', $schid)
                ->first();
            $suid = $oldStudent ? $oldStudent->suid : null;

            $pld = $student ? $student->toArray() : [];
            if ($student) {
                $pld['suid'] = $suid; // add suid to the response
            }
        }

        return response()->json([
            "status" => true,
            "message" => "Success",
            "pld" => $pld,
        ]);
    }


    /**
     * @OA\Post(
     *     path="/api/setStudentMedicalInfo",
     *     tags={"Api"},
     *     security={{"bearerAuth": {}}},
     *     summary="Set medical info about a student",
     *     @OA\RequestBody(
     *         required=true,
     *         @OA\JsonContent(
     *             type="object",
     *             @OA\Property(property="user_id", type="string"),
     *             @OA\Property(property="hospital", type="string"),
     *             @OA\Property(property="blood", type="string"),
     *             @OA\Property(property="geno", type="string"),
     *             @OA\Property(property="hiv", type="string"),
     *             @OA\Property(property="malaria", type="string"),
     *             @OA\Property(property="typha", type="string"),
     *             @OA\Property(property="tb", type="string"),
     *             @OA\Property(property="heart", type="string"),
     *             @OA\Property(property="liver", type="string"),
     *             @OA\Property(property="vdrl", type="string"),
     *             @OA\Property(property="hbp", type="string"),
     *         )
     *     ),
     *     @OA\Response(response="200", description="Student data set successfully"),
     *     @OA\Response(response="400", description="Validation error"),
     * )
     */
    public function setStudentMedicalInfo(Request $request)
    {
        //Data validation
        $request->validate([
            "user_id" => "required",
            "hospital" => "required",
            "blood" => "required",
            "geno" => "required",
            "hiv" => "required",
            "malaria" => "required",
            "typha" => "required",
            "tb" => "required",
            "heart" => "required",
            "liver" => "required",
            "vdrl" => "required",
            "hbp" => "required",
        ]);
        student_medical_data::updateOrCreate(
            ["user_id" => $request->user_id,],
            [
                "hospital" => $request->hospital,
                "blood" => $request->blood,
                "geno" => $request->geno,
                "hiv" => $request->hiv,
                "malaria" => $request->malaria,
                "typha" => $request->typha,
                "tb" => $request->tb,
                "heart" => $request->heart,
                "liver" => $request->liver,
                "vdrl" => $request->vdrl,
                "hbp" => $request->hbp,
            ]
        );
        student::where('sid', $request->user_id)->update([
            "s_medical" => '1'
        ]);
        return response()->json([
            "status" => true,
            "message" => "Success",
        ]);
    }


    /**
     * @OA\Get(
     *     path="/api/getStudentMedicalInfo/{uid}",
     *     tags={"Api"},
     *     security={{"bearerAuth": {}}},
     *     summary="Get a student's Medical Info",
     *     description="Use this endpoint to get medical information about a student.",
     *     @OA\Parameter(
     *         name="uid",
     *         in="path",
     *         required=true,
     *         description="User Id of the student",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Response(response="200", description="Success", @OA\JsonContent()),
     *     @OA\Response(response="401", description="Unauthorized"),
     * )
     */
    public function getStudentMedicalInfo($uid)
    {
        $pld = student_medical_data::where("user_id", $uid)->first();
        return response()->json([
            "status" => true,
            "message" => "Success",
            "pld" => $pld,
        ]);
    }


    /**
     * @OA\Post(
     *     path="/api/setStudentParentInfo",
     *     tags={"Api"},
     *     security={{"bearerAuth": {}}},
     *     summary="Set parent/guardian info about a student",
     *     @OA\RequestBody(
     *         required=true,
     *         @OA\JsonContent(
     *             type="object",
     *             @OA\Property(property="user_id", type="string"),
     *             @OA\Property(property="fname", type="string"),
     *             @OA\Property(property="lname", type="string"),
     *             @OA\Property(property="mname", type="string"),
     *             @OA\Property(property="sex", type="string"),
     *             @OA\Property(property="phn", type="string"),
     *             @OA\Property(property="eml", type="string"),
     *             @OA\Property(property="relation", type="string"),
     *             @OA\Property(property="job", type="string"),
     *             @OA\Property(property="addr", type="string"),
     *             @OA\Property(property="origin", type="string"),
     *             @OA\Property(property="residence", type="string"),
     *         )
     *     ),
     *     @OA\Response(response="200", description="Student data set successfully"),
     *     @OA\Response(response="400", description="Validation error"),
     * )
     */
    public function setStudentParentInfo(Request $request)
    {
        //Data validation
        $request->validate([
            "user_id" => "required",
            "fname" => "required",
            "lname" => "required",
            "mname" => "required",
            "sex" => "required",
            "phn" => "required",
            "eml" => "required",
            "relation" => "required",
            "job" => "required",
            "addr" => "required",
            "origin" => "required",
            "residence" => "required",
        ]);
        student_parent_data::updateOrCreate(
            ["user_id" => $request->user_id,],
            [
                "fname" => $request->fname,
                "lname" => $request->lname,
                "mname" => $request->mname,
                "sex" => $request->sex,
                "phn" => $request->phn,
                "eml" => $request->eml,
                "relation" => $request->relation,
                "job" => $request->job,
                "addr" => $request->addr,
                "origin" => $request->origin,
                "residence" => $request->residence,
            ]
        );
        student::where('sid', $request->user_id)->update([
            "s_parent" => '1'
        ]);
        return response()->json([
            "status" => true,
            "message" => "Success",
        ]);
    }


    /**
     * @OA\Get(
     *     path="/api/getStudentParentInfo/{uid}",
     *     tags={"Api"},
     *     security={{"bearerAuth": {}}},
     *     summary="Get a student's Medical Info",
     *     description="Use this endpoint to get medical information about a student.",
     *     @OA\Parameter(
     *         name="uid",
     *         in="path",
     *         required=true,
     *         description="User Id of the student",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Response(response="200", description="Success", @OA\JsonContent()),
     *     @OA\Response(response="401", description="Unauthorized"),
     * )
     */
    public function getStudentParentInfo($uid)
    {
        $pld = student_parent_data::where("user_id", $uid)->first();
        return response()->json([
            "status" => true,
            "message" => "Success",
            "pld" => $pld,
        ]);
    }


    /**
     * @OA\Post(
     *     path="/api/setStudentAcademicInfo",
     *     tags={"Api"},
     *     security={{"bearerAuth": {}}},
     *     summary="Set academic info about a student. Please pass an id for the classes as retrieved from getClasses. Dont just pass plain like JSS 1",
     *     @OA\RequestBody(
     *         required=true,
     *         @OA\JsonContent(
     *             type="object",
     *             @OA\Property(property="user_id", type="string"),
     *             @OA\Property(property="schid", type="string"),
     *             @OA\Property(property="last_school", type="string"),
     *             @OA\Property(property="last_class", type="string"),
     *             @OA\Property(property="new_class", type="string"),
     *             @OA\Property(property="new_class_main", type="string"),
     *             @OA\Property(property="ssn", type="string"),
     *             @OA\Property(property="suid", type="string"),
     *         )
     *     ),
     *     @OA\Response(response="200", description="Student data set successfully"),
     *     @OA\Response(response="400", description="Validation error"),
     * )
     */


    public function setStudentAcademicInfo(Request $request)
    {
        // Data validation
        $request->validate([
            "user_id" => "required",
            "schid" => "required",
            "last_school" => "required",
            "last_class" => "nullable",      // optional
            "new_class" => "nullable",      // optional
            "new_class_main" => "nullable",      // optional
            "ssn" => "required",
            "suid" => "required",
        ]);

        // Determine if we need to refresh subjects
        $refreshSubjects = false;
        $oldData = student_academic_data::where('user_id', $request->user_id)->first();
        if ($oldData) {
            $refreshSubjects = $oldData->new_class_main != ($request->new_class_main ?? null);
        } else {
            $refreshSubjects = true;
        }

        // Save/update student academic info
        student_academic_data::updateOrCreate(
            ["user_id" => $request->user_id],
            [
                "last_school" => $request->last_school,
                "last_class" => $request->last_class ?? null,
                "new_class" => $request->new_class ?? null,
                "new_class_main" => $request->new_class_main ?? null,
            ]
        );

        // If class changed, clear subjects
        if ($refreshSubjects) {
            student_subj::where('stid', $request->user_id)->delete();
        }

        // Fetch student
        $std = student::where('sid', $request->user_id)->first();
        if (!$std) {
            return response()->json([
                "status" => false,
                "message" => "Student not found",
            ], 404);
        }

        // Record in old_student only if new_class is provided
        if (!empty($request->new_class) && $request->new_class != 'NIL') {
            $uid = $request->ssn . $request->user_id;

            old_student::updateOrCreate(
                [
                    'sid' => $request->user_id,
                    'schid' => $request->schid,
                    'ssn' => $request->ssn,
                    'clsm' => $request->new_class_main,
                    'clsa' => $request->new_class,
                ],
                [
                    'uid' => $request->ssn . $request->user_id . $request->new_class_main,
                    'fname' => $std->fname,
                    'mname' => $std->mname,
                    'lname' => $std->lname,
                    'status' => 'active',
                    'suid' => $request->suid,
                    'more' => '',
                ]
            );
        }

        // Mark student academic record as set
        $std->update([
            "s_academic" => '1'
        ]);

        return response()->json([
            "status" => true,
            "message" => "Success",
        ]);
    }



    /**
     * @OA\Get(
     *     path="/api/getStudentAcademicInfo/{uid}",
     *     tags={"Api"},
     *     security={{"bearerAuth": {}}},
     *     summary="Get a student's Academic Info",
     *     description="Use this endpoint to get academic information about a student.",
     *     @OA\Parameter(
     *         name="uid",
     *         in="path",
     *         required=true,
     *         description="User Id of the student",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Response(response="200", description="Success", @OA\JsonContent()),
     *     @OA\Response(response="401", description="Unauthorized"),
     * )
     */
    public function getStudentAcademicInfo($uid)
    {
        $pld = student_academic_data::where("user_id", $uid)->first();
        return response()->json([
            "status" => true,
            "message" => "Success",
            "pld" => $pld,
        ]);
    }

    /**
     * @OA\Post(
     *     path="/api/setOldStudentInfo",
     *     tags={"Api"},
     *     security={{"bearerAuth": {}}},
     *     summary="Set info about an old student data. Specify id if you wish to update",
     *     @OA\RequestBody(
     *         required=true,
     *         @OA\JsonContent(
     *             type="object",
     *             @OA\Property(property="uid", type="string"),
     *             @OA\Property(property="sid", type="string"),
     *             @OA\Property(property="schid", type="string"),
     *             @OA\Property(property="fname", type="string"),
     *             @OA\Property(property="mname", type="string"),
     *             @OA\Property(property="lname", type="string"),
     *             @OA\Property(property="suid", type="string"),
     *             @OA\Property(property="ssn", type="string"),
     *             @OA\Property(property="clsm", type="string"),
     *             @OA\Property(property="clsa", type="string"),
     *             @OA\Property(property="more", type="string"),
     *         )
     *     ),
     *     @OA\Response(response="200", description="Student old data set successfully"),
     *     @OA\Response(response="400", description="Validation error"),
     * )
     */
    public function setOldStudentInfo(Request $request)
    {
        //  Data validation
        $request->validate([
            "uid" => "required|string",
            "sid" => "required|integer",
            "schid" => "required|integer",
            "fname" => "required|string",
            "mname" => "nullable|string",
            "lname" => "required|string",
            "suid" => "required|string",
            "ssn" => "required|integer",
            "clsm" => "required|integer",
            "clsa" => "required|integer",
            "more" => "nullable|string",
        ]);

        /**
         *  UPDATE OR CREATE USING MULTIPLE KEYS
         * This ensures:
         * - Same student
         * - Same school
         * - Same session
         * - Same UID
         */
        old_student::updateOrCreate(
            [
                'sid' => $request->sid,
                'schid' => $request->schid,
                'ssn' => $request->ssn,
            ],
            [
                'fname' => $request->fname,
                'mname' => $request->mname,
                'lname' => $request->lname,
                'status' => 'active',
                'suid' => $request->suid,
                'clsm' => $request->clsm,
                'clsa' => $request->clsa,
                'more' => $request->more,
            ]
        );

        return response()->json([
            "status" => true,
            "message" => "Old student record saved successfully"
        ]);
    }



    /**
     * @OA\Get(
     *     path="/api/getOldStudents/{schid}/{ssn}/{trm}/{clsm}/{clsa}",
     *     summary="Get old students history (with pagination)",
     *     description="Fetch old students by school, session, term, main class, and class arm.
     *                  Use '-1' for trm, clsm, or clsa to fetch all.
     *                  Supports pagination using 'start' and 'count'.",
     *     operationId="getOldStudents",
     *     tags={"Api"},
     *     security={{"bearerAuth": {}}},
     *
     *     @OA\Parameter(
     *         name="schid",
     *         in="path",
     *         required=true,
     *         description="School ID",
     *         @OA\Schema(type="integer", example=12)
     *     ),
     *     @OA\Parameter(
     *         name="ssn",
     *         in="path",
     *         required=true,
     *         description="Academic Session",
     *         @OA\Schema(type="string", example="2024")
     *     ),
     *     @OA\Parameter(
     *         name="trm",
     *         in="path",
     *         required=true,
     *         description="Term ID ('-1' to fetch all terms)",
     *         @OA\Schema(type="string", example="1")
     *     ),
     *     @OA\Parameter(
     *         name="clsm",
     *         in="path",
     *         required=true,
     *         description="Main class (e.g., JSS1, SS2; '-1' to fetch all)",
     *         @OA\Schema(type="string", example="JSS1")
     *     ),
     *     @OA\Parameter(
     *         name="clsa",
     *         in="path",
     *         required=true,
     *         description="Class arm ('-1' to fetch all)",
     *         @OA\Schema(type="string", example="A")
     *     ),
     *
     *     @OA\Parameter(
     *         name="start",
     *         in="query",
     *         required=false,
     *         description="Offset for pagination (default: 0)",
     *         @OA\Schema(type="integer", example=0)
     *     ),
     *     @OA\Parameter(
     *         name="count",
     *         in="query",
     *         required=false,
     *         description="Number of records to return (default: 20)",
     *         @OA\Schema(type="integer", example=20)
     *     ),
     *
     *     @OA\Response(
     *         response=200,
     *         description="Successful Response",
     *         @OA\JsonContent(
     *             type="object",
     *             @OA\Property(property="status", type="boolean", example=true),
     *             @OA\Property(property="message", type="string", example="Success"),
     *             @OA\Property(property="total", type="integer", example=150),
     *             @OA\Property(property="start", type="integer", example=0),
     *             @OA\Property(property="count", type="integer", example=20),
     *             @OA\Property(property="returned", type="integer", example=20),
     *
     *             @OA\Property(
     *                 property="pld",
     *                 type="array",
     *                 @OA\Items(
     *                     type="object",
     *                     @OA\Property(property="sid", type="integer", example=101),
     *                     @OA\Property(property="suid", type="integer", example=5001),
     *                     @OA\Property(property="fname", type="string", example="John"),
     *                     @OA\Property(property="mname", type="string", example="Michael"),
     *                     @OA\Property(property="lname", type="string", example="Smith"),
     *                     @OA\Property(property="ssn", type="string", example="2024"),
     *                     @OA\Property(property="trm", type="string", example="1"),
     *                     @OA\Property(property="clsm", type="string", example="JSS1"),
     *                     @OA\Property(property="clsa", type="string", example="A"),
     *                     @OA\Property(property="last_school", type="string", example="St. Mary's School"),
     *                     @OA\Property(property="last_class", type="string", example="Primary 6"),
     *                     @OA\Property(property="new_class", type="string", example="JSS1"),
     *                     @OA\Property(property="new_class_main", type="string", example="Junior Secondary"),
     *                     @OA\Property(property="adm_ssn", type="string", example="U123/2023/001"),
     *                     @OA\Property(property="adm_trm", type="integer", example=1),
     *                     @OA\Property(property="cls_of_adm", type="string", example="JSS1"),
     *                     @OA\Property(property="date_of_adm", type="string", example="2023-09-01"),
     *                     @OA\Property(property="adm_status", type="string", example="active")
     *                 )
     *             )
     *         )
     *     ),
     *
     *     @OA\Response(
     *         response=404,
     *         description="No records found",
     *         @OA\JsonContent(
     *             type="object",
     *             @OA\Property(property="status", type="boolean", example=false),
     *             @OA\Property(property="message", type="string", example="No records found")
     *         )
     *     )
     * )
     */


    public function getOldStudents($schid, $ssn, $trm = '-1', $clsm = '-1', $clsa = '-1')
    {
        //  Pagination
        $start = request()->input('start', 0);   // default 0
        $count = request()->input('count', 20);  // default 20

        //  Base query
        $query = old_student::with(['academicData'])
            ->where("schid", $schid)
            ->where("ssn", $ssn)
            ->where("status", "active");

        //  Filter by term if not "-1"
        if ($trm !== '-1') {
            $query->where("trm", $trm);
        }

        //  Filter by main class if not "-1"
        if ($clsm !== '-1') {
            $query->where("clsm", $clsm);
        }

        //  Filter by arm if not "-1"
        if ($clsa !== '-1') {
            $query->where("clsa", $clsa);
        }

        //  Total count of unique students BEFORE pagination
        $total = $query->distinct('sid')->count('sid');

        //  Fetch paginated students
        $students = $query->select(
            'sid',
            'suid',
            'fname',
            'mname',
            'lname',
            'ssn',
            'trm',
            'clsm',
            'clsa',
            'adm_ssn',
            'adm_trm',
            'cls_of_adm',
            'date_of_adm',
            'adm_status'
        )
            ->orderBy('lname', 'asc')
            ->skip($start)
            ->take($count)
            ->get();

        //  Remove duplicates by 'sid'
        $uniqueStudents = $students->unique('sid')->values();

        //  Map payload
        // $pld = $uniqueStudents->map(function ($student) {
        //     return [
        //         "sid" => $student->sid,
        //         "suid" => $student->suid,
        //         "fname" => $student->fname,
        //         "mname" => $student->mname,
        //         "lname" => $student->lname,
        //         "ssn" => $student->ssn,
        //         "trm" => $student->trm,
        //         "clsm" => $student->clsm,
        //         "clsa" => $student->clsa,
        //         "last_school" => $student->academicData?->last_school,
        //         "last_class" => $student->academicData?->last_class,
        //         "new_class" => $student->academicData?->new_class,
        //         "new_class_main" => $student->academicData?->new_class_main,
        //         "adm_ssn" => $student->adm_ssn,
        //         "adm_trm" => $student->adm_trm,
        //         "cls_of_adm" => $student->cls_of_adm,
        //         "date_of_adm" => $student->date_of_adm,
        //         "adm_status" => $student->adm_status,
        //     ];
        // });

        $pld = $uniqueStudents->map(function ($student) use ($schid, $ssn, $trm) {

            //  Check if student has subjects assigned
            $hasSubjects = \DB::table('student_subj')
                ->where('stid', $student->sid)
                ->where('schid', $schid)
                ->where('ssn', $ssn)
                ->exists();

            //  Update only if needed
            $newValue = $hasSubjects ? 1 : 0;

            if ($student->cls_sbj_students != $newValue) {
                \DB::table('old_student')
                    ->where('sid', $student->sid)
                    ->where('schid', $schid)
                    ->update(['cls_sbj_students' => $newValue]);
            }

            return [
                "sid" => $student->sid,
                "suid" => $student->suid,
                "fname" => $student->fname,
                "mname" => $student->mname,
                "lname" => $student->lname,
                "ssn" => $student->ssn,
                "trm" => $student->trm,
                "clsm" => $student->clsm,
                "clsa" => $student->clsa,
                "cls_sbj_students" => $newValue,  //  INCLUDED IN RESPONSE
                "last_school" => $student->academicData?->last_school,
                "last_class" => $student->academicData?->last_class,
                "new_class" => $student->academicData?->new_class,
                "new_class_main" => $student->academicData?->new_class_main,
                "adm_ssn" => $student->adm_ssn,
                "adm_trm" => $student->adm_trm,
                "cls_of_adm" => $student->cls_of_adm,
                "date_of_adm" => $student->date_of_adm,
                "adm_status" => $student->adm_status,
            ];
        });


        return response()->json([
            "status" => true,
            "message" => "Success",
            "total" => $total,      // total unique students
            "start" => $start,      // current start
            "count" => $count,      // number of records returned
            "returned" => $pld->count(), // for frontend UI
            "pld" => $pld,
        ]);
    }





    /**
     * @OA\Get(
     *     path="/api/getOldStudent/{schid}/{ssn}/{stid}",
     *     tags={"Api"},
     *     security={{"bearerAuth": {}}},
     *     summary="Get an old student's Basic Info",
     *     description="Use this endpoint to get basic information about an old student.",
     *     @OA\Parameter(
     *         name="schid",
     *         in="path",
     *         required=true,
     *         description="Id of the school",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Parameter(
     *         name="ssn",
     *         in="path",
     *         required=true,
     *         description="Id of the session",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Parameter(
     *         name="stid",
     *         in="path",
     *         required=true,
     *         description="Id of the student",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Response(response="200", description="Success", @OA\JsonContent()),
     *     @OA\Response(response="401", description="Unauthorized"),
     * )
     */
    public function getOldStudent($schid, $ssn, $stid)
    {
        $pld = [];
        $pld = old_student::where("schid", $schid)->where("ssn", $ssn)->where("sid", $stid)->first();
        return response()->json([
            "status" => true,
            "message" => "Success",
            "pld" => $pld,
        ]);
    }

    /**
     * @OA\Get(
     *     path="/api/getOldStudentsStat/{schid}/{ssn}",
     *     tags={"Api"},
     *     security={{"bearerAuth": {}}},
     *     summary="Get old students statistics",
     *     description="Fetch male and female counts of old students based on optional filters for term, main class, and class arm.",
     *     @OA\Parameter(
     *         name="schid",
     *         in="path",
     *         required=true,
     *         description="ID of the school",
     *         @OA\Schema(type="integer")
     *     ),
     *     @OA\Parameter(
     *         name="ssn",
     *         in="path",
     *         required=true,
     *         description="ID of the session",
     *         @OA\Schema(type="integer")
     *     ),
     *     @OA\Parameter(
     *         name="trm",
     *         in="query",
     *         required=false,
     *         description="Term ID (optional). Default is '-1' for all terms.",
     *         @OA\Schema(type="string", default="-1", nullable=true)
     *     ),
     *     @OA\Parameter(
     *         name="clsm",
     *         in="query",
     *         required=false,
     *         description="Main class ID (optional). Default is '-1' for all classes.",
     *         @OA\Schema(type="string", default="-1", nullable=true)
     *     ),
     *     @OA\Parameter(
     *         name="clsa",
     *         in="query",
     *         required=false,
     *         description="Class arm ID (optional). Default is '-1' for all arms.",
     *         @OA\Schema(type="string", default="-1", nullable=true)
     *     ),
     *     @OA\Response(
     *         response=200,
     *         description="Success",
     *         @OA\JsonContent(
     *             type="object",
     *             @OA\Property(property="status", type="boolean", example=true),
     *             @OA\Property(property="message", type="string", example="Success"),
     *             @OA\Property(
     *                 property="pld",
     *                 type="object",
     *                 @OA\Property(property="male", type="integer", example=10),
     *                 @OA\Property(property="female", type="integer", example=8)
     *             )
     *         )
     *     ),
     *     @OA\Response(response=401, description="Unauthorized")
     * )
     */



    public function getOldStudentsStat($schid, $ssn, $trm = '-1', $clsm = '-1', $clsa = '-1')
    {
        // Base query for male students
        $maleQuery = old_student::join('student_basic_data', 'old_student.sid', '=', 'student_basic_data.user_id')
            ->where('old_student.schid', $schid)
            ->where('old_student.ssn', $ssn)
            ->where('old_student.status', 'active')
            ->where('student_basic_data.sex', 'M');

        // Base query for female students
        $femaleQuery = old_student::join('student_basic_data', 'old_student.sid', '=', 'student_basic_data.user_id')
            ->where('old_student.schid', $schid)
            ->where('old_student.ssn', $ssn)
            ->where('old_student.status', 'active')
            ->where('student_basic_data.sex', 'F');

        // Apply optional filters only if they are not "-1"
        if ($trm !== '-1') {
            $maleQuery->where('old_student.trm', $trm);
            $femaleQuery->where('old_student.trm', $trm);
        }

        if ($clsm !== '-1') {
            $maleQuery->where('old_student.clsm', $clsm);
            $femaleQuery->where('old_student.clsm', $clsm);
        }

        if ($clsa !== '-1') {
            $maleQuery->where('old_student.clsa', $clsa);
            $femaleQuery->where('old_student.clsa', $clsa);
        }

        // Get counts of distinct students
        $maleCount = $maleQuery->distinct('old_student.sid')->count('old_student.sid');
        $femaleCount = $femaleQuery->distinct('old_student.sid')->count('old_student.sid');

        return response()->json([
            "status" => true,
            "message" => "Success",
            "pld" => [
                "male" => $maleCount,
                "female" => $femaleCount,
            ]
        ]);
    }



    /**
     * @OA\Get(
     *     path="/api/getOldStudentInfo/{uid}",
     *     tags={"Api"},
     *     security={{"bearerAuth": {}}},
     *     summary="Get an old student's Basic Info",
     *     description="Use this endpoint to get basic information about an old student.",
     *     @OA\Parameter(
     *         name="uid",
     *         in="path",
     *         required=true,
     *         description="uid of the record",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Response(response="200", description="Success", @OA\JsonContent()),
     *     @OA\Response(response="401", description="Unauthorized"),
     * )
     */
    public function getOldStudentInfo($uid)
    {
        $pld = old_student::where("uid", $uid)->first();
        return response()->json([
            "status" => true,
            "message" => "Success",
            "pld" => $pld,
        ]);
    }

    /**
     * @OA\Post(
     *     path="/api/setStudentPsy",
     *     tags={"Api"},
     *     security={{"bearerAuth": {}}},
     *     summary="Set info about an student psychometry. Specify id if you wish to update",
     *     @OA\RequestBody(
     *         required=true,
     *         @OA\JsonContent(
     *             type="object",
     *             @OA\Property(property="uid", type="string"),
     *             @OA\Property(property="punc", type="string"),
     *             @OA\Property(property="hon", type="string"),
     *             @OA\Property(property="pol", type="string"),
     *             @OA\Property(property="neat", type="string"),
     *             @OA\Property(property="pers", type="string"),
     *             @OA\Property(property="rel", type="string"),
     *             @OA\Property(property="dil", type="string"),
     *             @OA\Property(property="cre", type="string"),
     *             @OA\Property(property="pat", type="string"),
     *             @OA\Property(property="verb", type="string"),
     *             @OA\Property(property="gam", type="string"),
     *             @OA\Property(property="musc", type="string"),
     *             @OA\Property(property="drw", type="string"),
     *             @OA\Property(property="wrt", type="string"),
     *             @OA\Property(property="stid", type="string"),
     *             @OA\Property(property="schid", type="string"),
     *             @OA\Property(property="ssn", type="string"),
     *             @OA\Property(property="trm", type="string"),
     *             @OA\Property(property="clsm", type="string"),
     *             @OA\Property(property="clsa", type="string"),
     *         )
     *     ),
     *     @OA\Response(response="200", description="Student old data set successfully"),
     *     @OA\Response(response="400", description="Validation error"),
     * )
     */
    public function setStudentPsy(Request $request)
    {
        //Data validation
        $request->validate([
            "uid" => "required",
            "punc" => "required",
            "hon" => "required",
            "pol" => "required",
            "neat" => "required",
            "pers" => "required",
            "rel" => "required",
            "dil" => "required",
            "cre" => "required",
            "pat" => "required",
            "verb" => "required",
            "gam" => "required",
            "musc" => "required",
            "drw" => "required",
            "wrt" => "required",
            "stid" => "required",
            "schid" => "required",
            "ssn" => "required",
            "trm" => "required",
            "clsm" => "required",
            "clsa" => "required",
        ]);
        student_psy::updateOrCreate(
            ["uid" => $request->uid,],
            [
                'punc' => $request->punc,
                'hon' => $request->hon,
                'pol' => $request->pol,
                'neat' => $request->neat,
                'pers' => $request->pers,
                'rel' => $request->rel,
                'dil' => $request->dil,
                'cre' => $request->cre,
                'pat' => $request->pat,
                'verb' => $request->verb,
                'gam' => $request->gam,
                'musc' => $request->musc,
                'drw' => $request->drw,
                'wrt' => $request->wrt,
                'stid' => $request->stid,
                'schid' => $request->schid,
                'ssn' => $request->ssn,
                'trm' => $request->trm,
                'clsm' => $request->clsm,
                'clsa' => $request->clsa,
            ]
        );
        return response()->json([
            "status" => true,
            "message" => "Info Updated"
        ]);
    }

    /**
     * @OA\Get(
     *     path="/api/getStudentPsy/{schid}/{ssn}/{trm}/{clsm}/{clsa}/{stid}",
     *     tags={"Api"},
     *     security={{"bearerAuth": {}}},
     *     summary="Get a student's psychometry",
     *     description="Use this endpoint to get ...",
     *     @OA\Parameter(
     *         name="schid",
     *         in="path",
     *         required=true,
     *         description="Id of the school",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Parameter(
     *         name="ssn",
     *         in="path",
     *         required=true,
     *         description="Id of the session",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Parameter(
     *         name="trm",
     *         in="path",
     *         required=true,
     *         description="Id of the term",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Parameter(
     *         name="clsm",
     *         in="path",
     *         required=true,
     *         description="Id of the main class",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Parameter(
     *         name="clsa",
     *         in="path",
     *         required=true,
     *         description="Id of the class arm",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Parameter(
     *         name="stid",
     *         in="path",
     *         required=true,
     *         description="Id of the student",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Response(response="200", description="Success", @OA\JsonContent()),
     *     @OA\Response(response="401", description="Unauthorized"),
     * )
     */
    public function getStudentPsy($schid, $ssn, $trm, $clsm, $clsa, $stid)
    {
        $pld = student_psy::where("schid", $schid)->where("ssn", $ssn)->where("trm", $trm)->where("clsm", $clsm)->where("clsa", $clsa)->where("stid", $stid)->first();
        return response()->json([
            "status" => true,
            "message" => "Success",
            "pld" => $pld,
        ]);
    }





    //////////////////////////////////////////////////////////////////////////////////////////////////



    /**
     * @OA\Post(
     *     path="/api/setStudentRes",
     *     tags={"Api"},
     *     security={{"bearerAuth": {}}},
     *     summary="Set info about an student result. Specify id if you wish to update",
     *     @OA\RequestBody(
     *         required=true,
     *         @OA\JsonContent(
     *             type="object",
     *             @OA\Property(property="uid", type="string"),
     *             @OA\Property(property="stat", type="string"),
     *             @OA\Property(property="com", type="string"),
     *             @OA\Property(property="stid", type="string"),
     *             @OA\Property(property="schid", type="string"),
     *             @OA\Property(property="ssn", type="string"),
     *             @OA\Property(property="trm", type="string"),
     *             @OA\Property(property="clsm", type="string"),
     *             @OA\Property(property="clsa", type="string"),
     *             @OA\Property(property="pos", type="string"),
     *             @OA\Property(property="avg", type="string"),
     *             @OA\Property(property="cavg", type="string"),
     *         )
     *     ),
     *     @OA\Response(response="200", description="Student old data set successfully"),
     *     @OA\Response(response="400", description="Validation error"),
     * )
     */




    public function setStudentRes(Request $request)
    {
        // Retrieve the authenticated user
        $user = auth()->user();

        // Allow School Admin (typ = 'a' or 's') to add comments
        if (in_array($user->typ, ['a', 's'])) {
            return $this->saveStudentRes($request);
        }

        // Find the corresponding staff record
        $staff = staff::where('sid', $user->id)->first();

        if (!$staff) {
            return response()->json([
                "status" => false,
                "message" => "Unauthorized: Staff not found."
            ], 403);
        }

        // Retrieve the role names from the staff_role table
        $roleNames = staff_role::whereIn('id', [$staff->role, $staff->role2])
            ->pluck('name')
            ->toArray();

        // Allow Form Teachers, Head Teacher, Class Teachers, and Principals to comment
        $allowedRoles = ['Form Teacher', 'Head Teacher', 'Class Teacher', 'Principal'];

        if (!array_intersect($allowedRoles, $roleNames)) {
            return response()->json([
                "status" => false,
                "message" => "Unauthorized: Only Form Teachers, Head Teacher, Class Teachers, Principals, or Admins can add comments."
            ], 403);
        }

        // If the staff is a Class Teacher, ensure they are assigned to the correct class arm
        if (in_array('Class Teacher', $roleNames)) {
            $assignedClassArm = staff_class_arm::where('stid', $staff->sid)
                ->where('cls', $request->clsm) // Ensure same class
                ->where('arm', $request->clsa) // Ensure same class arm
                ->exists();

            if (!$assignedClassArm) {
                return response()->json([
                    "status" => false,
                    "message" => "Unauthorized: You are not assigned to this class arm."
                ], 403);
            }
        }

        return $this->saveStudentRes($request);
    }


    /**
     * Save or update student results
     */
    private function saveStudentRes(Request $request)
    {
        $request->validate([
            "uid" => "required",
            "stat" => "required",
            "com" => "required",
            "stid" => "required",
            "schid" => "required",
            "ssn" => "required",
            "trm" => "required",
            "clsm" => "required",
            "clsa" => "required",
            "pos" => "numeric",
            'avg' => 'numeric|min:0|max:100',
            'cavg' => 'numeric|min:0|max:100',
        ]);

        student_res::updateOrCreate(
            [
                'uid' => $request->uid, // only match on UID, don't update it
            ],
            [
                'stat' => $request->stat,
                'com' => $request->com,
                'stid' => $request->stid,
                'schid' => $request->schid,
                'ssn' => $request->ssn,
                'trm' => $request->trm,
                'clsm' => $request->clsm,
                'clsa' => $request->clsa,
                'pos' => $request->pos,
                'avg' => $request->avg,
                'cavg' => $request->cavg,
            ]
        );

        return response()->json([
            "status" => true,
            "message" => "Info Updated"
        ]);
    }



    /**
     * @OA\Post(
     *     path="/api/setCummulativeResultStatus",
     *     summary="Lock or unlock a class broadsheet or a specific student (set status 0 or 1)",
     *     tags={"Api"},
     *     security={{"bearerAuth":{}}},
     *     @OA\RequestBody(
     *         required=true,
     *         @OA\JsonContent(
     *             required={"schid","ssn","clsm","clsa","stat"},
     *             @OA\Property(property="schid", type="string", example="12"),
     *             @OA\Property(property="ssn", type="string", example="2025"),
     *             @OA\Property(property="clsm", type="string", example="11"),
     *             @OA\Property(property="clsa", type="string", example="2"),
     *             @OA\Property(
     *                 property="stat",
     *                 type="integer",
     *                 enum={0,1},
     *                 example=1,
     *                 description="0 = unlock, 1 = lock"
     *             ),
     *             @OA\Property(
     *                 property="sid",
     *                 type="string",
     *                 nullable=true,
     *                 example="ST123",
     *                 description="Optional student ID. If provided, only this student's broadsheet will be locked/unlocked. If omitted, the whole class is affected."
     *             )
     *         )
     *     ),
     *     @OA\Response(
     *         response=200,
     *         description="Broadsheet status updated successfully.",
     *         @OA\JsonContent(
     *             @OA\Property(property="status", type="boolean", example=true),
     *             @OA\Property(property="message", type="string", example="Broadsheet UNLOCKED successfully")
     *         )
     *     ),
     *     @OA\Response(
     *         response=403,
     *         description="Unauthorized action",
     *         @OA\JsonContent(
     *             @OA\Property(property="status", type="boolean", example=false),
     *             @OA\Property(property="message", type="string", example="Unauthorized: Only Principal, Head Teacher, School Admin or System Admin can lock/unlock broadsheet.")
     *         )
     *     ),
     *     @OA\Response(
     *         response=422,
     *         description="Validation error",
     *         @OA\JsonContent(
     *             @OA\Property(property="message", type="string", example="The given data was invalid."),
     *             @OA\Property(
     *                 property="errors",
     *                 type="object",
     *                 example={
     *                     "schid": {"The schid field is required."},
     *                     "stat": {"The selected stat is invalid."}
     *                 }
     *             )
     *         )
     *     )
     * )
     */


    public function setCummulativeResultStatus(Request $request)
    {
        // Validate input
        $request->validate([
            'schid' => 'required|string',
            'ssn' => 'required|string',
            'clsm' => 'required|string',
            'clsa' => 'required|string',
            'stat' => 'required|in:0,1',
            'sid' => 'required|string',
        ]);

        $user = auth()->user();

        // School Admin can always set
        if (in_array($user->typ, ['a', 's'])) {
            return $this->saveBroadsheetStatus($request);
        }

        $staff = staff::where('sid', $user->id)->first();

        if (!$staff) {
            return response()->json([
                'status' => false,
                'message' => 'Unauthorized: Staff not found.'
            ], 403);
        }

        $roleNames = staff_role::whereIn('id', [$staff->role, $staff->role2])
            ->pluck('name')
            ->toArray();

        $allowedRoles = ['Principal', 'Head Teacher', 'School Admin'];

        if (!array_intersect($allowedRoles, $roleNames)) {
            return response()->json([
                'status' => false,
                'message' => 'Unauthorized: Only Principal, Head Teacher, or School Admin can lock/unlock broadsheet.'
            ], 403);
        }

        return $this->saveBroadsheetStatus($request);
    }

    /**
     * Save or update broadsheet status
     */
    private function saveBroadsheetStatus(Request $request)
    {
        $broadsheet = broadsheet_control::updateOrCreate(
            [
                'schid' => $request->schid,
                'ssn' => $request->ssn,
                'clsm' => $request->clsm,
                'clsa' => $request->clsa,
                'sid' => $request->sid, // make sure this is a string matching table.
            ],
            [
                'stat' => (int) $request->stat,
            ]
        );

        return response()->json([
            'status' => true,
            'message' => $request->stat == 1
                ? 'Broadsheet UNLOCKED successfully'
                : 'Broadsheet LOCKED successfully'
        ]);
    }




    /**
     * @OA\Get(
     *     path="/api/getStudentRes/{schid}/{ssn}/{trm}/{clsm}/{clsa}/{stid}",
     *     tags={"Api"},
     *     security={{"bearerAuth": {}}},
     *     summary="Get a student's psychometry",
     *     description="Use this endpoint to get ...",
     *     @OA\Parameter(
     *         name="schid",
     *         in="path",
     *         required=true,
     *         description="Id of the school",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Parameter(
     *         name="ssn",
     *         in="path",
     *         required=true,
     *         description="Id of the session",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Parameter(
     *         name="trm",
     *         in="path",
     *         required=true,
     *         description="Id of the term",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Parameter(
     *         name="clsm",
     *         in="path",
     *         required=true,
     *         description="Id of the main class",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Parameter(
     *         name="clsa",
     *         in="path",
     *         required=true,
     *         description="Id of the class arm",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Parameter(
     *         name="stid",
     *         in="path",
     *         required=true,
     *         description="Id of the student",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Response(response="200", description="Success", @OA\JsonContent()),
     *     @OA\Response(response="401", description="Unauthorized"),
     * )
     */
    public function getStudentRes($schid, $ssn, $trm, $clsm, $clsa, $stid)
    {
        $pld = student_res::where("schid", $schid)->where("ssn", $ssn)->where("trm", $trm)->where("clsm", $clsm)->where("clsa", $clsa)->where("stid", $stid)->first();
        return response()->json([
            "status" => true,
            "message" => "Success",
            "pld" => $pld,
        ]);
    }

    /**
     * @OA\Post(
     *     path="/api/setStudentSubjPos",
     *     tags={"Api"},
     *     security={{"bearerAuth": {}}},
     *     summary="Set info about an student subject position.",
     *     @OA\RequestBody(
     *         required=true,
     *         @OA\JsonContent(
     *             type="object",
     *             @OA\Property(property="uidprfx", type="string"),
     *             @OA\Property(property="stid", type="string"),
     *             @OA\Property(property="schid", type="string"),
     *             @OA\Property(property="ssn", type="string"),
     *             @OA\Property(property="trm", type="string"),
     *             @OA\Property(property="clsm", type="string"),
     *             @OA\Property(property="clsa", type="string"),
     *             @OA\Property(property="sbjpos", type="string"),
     *         )
     *     ),
     *     @OA\Response(response="200", description="Student old data set successfully"),
     *     @OA\Response(response="400", description="Validation error"),
     * )
     */
    public function setStudentSubjPos(Request $request)
    {
        //Data validation
        $request->validate([
            "uidprfx" => "required",
            "stid" => "required",
            "schid" => "required",
            "ssn" => "required",
            "trm" => "required",
            "clsm" => "required",
            "clsa" => "required",
            "sbjpos" => "nullable",
        ]);
        $sbjPosCombo = explode('~', $request->sbjpos);
        foreach ($sbjPosCombo as $spc) {
            if (strlen($spc) > 2) {
                $meta = explode('-', $spc);
                $sbid = $meta[0];
                $sbPos = $meta[1];
                student_sub_res::updateOrCreate(
                    ["uid" => $request->uidprfx . $sbid,],
                    [
                        "stid" => $request->stid,
                        "schid" => $request->schid,
                        "ssn" => $request->ssn,
                        "trm" => $request->trm,
                        "clsm" => $request->clsm,
                        "clsa" => $request->clsa,
                        "sbj" => $sbid,
                        "pos" => $sbPos,
                    ]
                );
            }
        }
        return response()->json([
            "status" => true,
            "message" => "Info Updated"
        ]);
    }

    /**
     * @OA\Get(
     *     path="/api/getStudentSubjPos/{schid}/{ssn}/{trm}/{clsm}/{clsa}/{stid}",
     *     tags={"Api"},
     *     security={{"bearerAuth": {}}},
     *     summary="Get a student's Subject Positions",
     *     description="Use this endpoint to get a student's Subject Positions",
     *     @OA\Parameter(
     *         name="schid",
     *         in="path",
     *         required=true,
     *         description="Id of the school",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Parameter(
     *         name="ssn",
     *         in="path",
     *         required=true,
     *         description="Id of the session",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Parameter(
     *         name="trm",
     *         in="path",
     *         required=true,
     *         description="Term ID",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Parameter(
     *         name="clsm",
     *         in="path",
     *         required=true,
     *         description="Id of the main class",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Parameter(
     *         name="clsa",
     *         in="path",
     *         required=true,
     *         description="Id of the class arm",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Parameter(
     *         name="stid",
     *         in="path",
     *         required=true,
     *         description="Student ID",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Response(response="200", description="Success", @OA\JsonContent()),
     *     @OA\Response(response="401", description="Unauthorized"),
     * )
     */
    public function getStudentSubjPos($schid, $ssn, $trm, $clsm, $clsa, $stid)
    {
        $studentSubjects = student_subj::join('class_subj', 'student_subj.sbj', '=', 'class_subj.subj_id')
            ->where('class_subj.schid', $schid)
            ->where('class_subj.clsid', $clsm)
            ->where('student_subj.stid', $stid)
            ->get();
        $positions = [];
        foreach ($studentSubjects as $sbj) {
            $sbid = $sbj->sbj;
            $subjectPosition = student_sub_res::where('stid', $stid)->where('sbj', $sbid)
                ->where("schid", $schid)->where("ssn", $ssn)->where("trm", $trm)->where("clsm", $clsm)
                ->where("clsa", $clsa)->first();
            if ($subjectPosition) {
                $positions[] = [
                    'sbid' => $sbid,
                    'pos' => $subjectPosition->pos,
                ];
            }
        }
        return response()->json([
            "status" => true,
            "message" => "Success",
            "pld" => $positions,
        ]);
    }


    //---STAFF

    /**
     * @OA\Post(
     *     path="/api/registerStaff",
     *     tags={"Unprotected"},
     *     summary="Register a new staff for a school",
     *     @OA\RequestBody(
     *         required=true,
     *         @OA\JsonContent(
     *             type="object",
     *             @OA\Property(property="schid", type="string", description="School ID which this staff belongs"),
     *             @OA\Property(property="email", type="string", format="email"),
     *             @OA\Property(property="fname", type="string"),
     *             @OA\Property(property="mname", type="string"),
     *             @OA\Property(property="lname", type="string"),
     *             @OA\Property(property="sch3", type="string"),
     *             @OA\Property(property="stat", type="string"),
     *             @OA\Property(property="role", type="string"),
     *             @OA\Property(property="password", type="string", description="The password for the staff"),
     *         )
     *     ),
     *     @OA\Response(response="200", description="Password reset token sent to mail"),
     * )
     */

    public function registerStaff(Request $request)
    {
        //Data validation
        $request->validate([
            "schid" => "required",
            "email" => "required|email|unique:users,email",
            "password" => "required",
            "fname" => "required",
            "lname" => "required",
            "sch3" => "required",
            "year" => "nullable",
            "trm" => "nullable",
            "stat" => "required",
            "role" => "required",
        ]);
        if (strlen($request->password) < 6) {
            return response()->json([
                "status" => false,
                "message" => "Password must be at least 6 char",
            ], 400);
        }
        $typ = 'w';
        $usr = User::where("typ", $typ)->where("email", $request->email)->first();
        if (!$usr) {
            $usr = User::create([
                "email" => $request->email,
                "typ" => $typ,
                "verif" => $request->stat,
                "password" => bcrypt($request->password),
            ]);
            $count = $request->count;
            if (!$count) {
                $count = staff::where('schid', $request->schid)->count() + 1;
            }
            staff::create([
                "sid" => strval($usr->id),
                "schid" => $request->schid,
                "fname" => $request->fname,
                "mname" => $request->mname,
                "lname" => $request->lname,
                "count" => strval($count),
                "sch3" => $request->sch3,
                "stat" => $request->stat,
                "year" => $request->year,
                "trm" => $request->trm,
                "cuid" => $request->cuid,
                "role" => "*" . $request->role,
                "role2" => '-1',
                "s_basic" => '0',
                "s_prof" => '0',
            ]);
            $sid = $request->sch3 . '/' . 'STAFF' . '/' . strval($count);
            // Wrap the email sending logic in a try-catch block
            try {
                if ($request->cuid) {
                    $data = [
                        'name' => $request->fname,
                        'subject' => 'Welcome Back, Your ID remains ' . $request->cuid,
                        'body' => "Welcome back to your school's platform. Your account was created successfully. If you havent already, please login to your dashboard using the link below and complete your staff profile. If the link isnt clickable, please copy the link to your browser. If this arrived in spam folder, please mark as Not Spam. Your Staff ID is " . $request->cuid,
                        'link' => env('PORTAL_URL') . '/staffLogin' . '/' . $request->schid,
                    ];
                    Mail::to($request->email)->send(new SSSMails($data));
                } else {
                    $data = [
                        'name' => $request->fname,
                        'subject' => 'Welcome, Your ID is ' . $sid,
                        'body' => "Welcome to your school's platform. Your account was created successfully. If you havent already, please login to your dashboard using the link below and complete your staff profile. If the link isnt clickable, please copy the link to your browser. If this arrived in spam folder, please mark as Not Spam. Your Staff ID is " . $sid,
                        'link' => env('PORTAL_URL') . '/staffLogin' . '/' . $request->schid,
                    ];
                    Mail::to($request->email)->send(new SSSMails($data));
                }
            } catch (\Exception $e) {
                // Log the email error, but don't stop the process
                Log::error('Failed to send email: ' . $e->getMessage());
            }
            // Respond
            $token = JWTAuth::attempt([
                "email" => $request->email,
                "password" => $request->password,
            ]);
            return response()->json([
                "status" => true,
                "message" => "User created successfully",
                "token" => $token,
                "sid" => $sid,
                "user_id" => strval($usr->id)
            ]);
        }
        return response()->json([
            "status" => false,
            "message" => "Account already exists",
        ], 400);
    }

    /**
     * @OA\Post(
     *     path="/api/staffLoginByEmail",
     *     tags={"Unprotected"},
     *     summary="Staff Login to the application by Email",
     *     @OA\RequestBody(
     *         required=true,
     *         @OA\JsonContent(
     *             type="object",
     *             @OA\Property(property="email", type="string", format="email"),
     *             @OA\Property(property="password", type="string"),
     *         )
     *     ),
     *     @OA\Response(
     *         response="200",
     *         description="Login successful",
     *         @OA\JsonContent(
     *             type="object",
     *             @OA\Property(property="token", type="string", example="your-jwt-token-here", description="This will contain a JWT token that must be passed with consequent request using bearer token"),
     *         )
     *     ),
     * )
     */


    public function staffLoginByEmail(Request $request)
    {
        //Data validation
        $request->validate([
            "email" => "required|email",
            "password" => "required",
        ]);
        $typ = 'w';
        $usr = User::where("typ", $typ)->where("email", $request->email)->first();
        if ($usr) {
            $token = JWTAuth::attempt([
                "email" => $request->email,
                "password" => $request->password,
            ]);
            if (!empty($token)) {
                $stf = staff::where('sid', strval($usr->id))->first();
                return response()->json([
                    "status" => true,
                    "message" => "Login successful",
                    "token" => $token,
                    "pld" => $usr,
                    "std" => $stf,
                ]);
            }
        }
        // Respond
        return response()->json([
            "status" => false,
            "message" => "Invalid login details",
        ], 400);
    }

    /**
     * @OA\Post(
     *     path="/api/staffLoginByID",
     *     tags={"Unprotected"},
     *     summary="Staff Login to the application",
     *     @OA\RequestBody(
     *         required=true,
     *         @OA\JsonContent(
     *             type="object",
     *             @OA\Property(property="stid", type="string"),
     *             @OA\Property(property="schid", type="string"),
     *             @OA\Property(property="password", type="string"),
     *         )
     *     ),
     *     @OA\Response(
     *         response="200",
     *         description="Login successful",
     *         @OA\JsonContent(
     *             type="object",
     *             @OA\Property(property="token", type="string", example="your-jwt-token-here", description="This will contain a JWT token that must be passed with consequent request using bearer token"),
     *         )
     *     ),
     * )
     */


    public function staffLoginByID(Request $request)
    {
        //Data validation
        $request->validate([
            "stid" => "required",
            "schid" => "required",
            "password" => "required",
        ]);
        $typ = 'w';
        $stf = [];
        $compo = explode("/", $request->stid);
        if (count($compo) == 3) {
            $sch3 = $compo[0];
            $count = $compo[2];
            $stf = staff::where("schid", $request->schid)->where("count", $count)->where("status", "active")->first();
        } else {
            $stf = staff::where("cuid", $request->stid)->where("status", "active")->first();
        }
        if ($stf) {
            $usr = User::where("typ", $typ)->where("id", $stf->sid)->first();
            $token = JWTAuth::attempt([
                "email" => $usr->email,
                "password" => $request->password,
            ]);
            if (!empty($token)) {
                return response()->json([
                    "status" => true,
                    "message" => "Login successful",
                    "token" => $token,
                    "pld" => $usr,
                ]);
            }
        }
        // Respond
        return response()->json([
            "status" => false,
            "message" => "Invalid login details",
        ], 400);
    }

    /**
     * @OA\Post(
     *     path="/api/admitStaff",
     *     tags={"Api"},
     *     security={{"bearerAuth": {}}},
     *     summary="admit/reject a staff",
     *     @OA\RequestBody(
     *         required=true,
     *         @OA\JsonContent(
     *             type="object",
     *             @OA\Property(property="stid", type="string"),
     *             @OA\Property(property="stat", type="string"),
     *             @OA\Property(property="role", type="string"),
     *             @OA\Property(property="role2", type="string"),
     *             @OA\Property(property="role_name", type="string"),
     *             @OA\Property(property="role2_name", type="string"),
     *             @OA\Property(property="schid", type="string"),
     *         )
     *     ),
     *     @OA\Response(response="200", description="Student data set successfully"),
     *     @OA\Response(response="400", description="Validation error"),
     * )
     */

    public function admitStaff(Request $request)
    {
        // Data validation
        $request->validate([
            "stid" => "required",
            "stat" => "required",
            "role" => "required",
            "role2" => "required",
            "role_name" => "required",
            "role2_name" => "required",
            "schid" => "required",
        ]);

        $stf = staff::where('sid', $request->stid)->first();

        if ($stf) {
            // Update staff table
            $stf->update([
                "stat" => $request->stat,
                "role" => $request->role,
                "role2" => $request->role2,
            ]);

            // Update old_staff table
            old_staff::where('sid', $request->stid)
                ->where('schid', $request->schid)
                ->update([
                    'role' => $request->role,
                    'role2' => $request->role2,
                ]);

            // Get user email
            $usr = User::where('id', $stf->sid)->first();

            // Wrap the email sending logic in a try-catch block
            try {
                $data = [
                    'name' => $stf->fname,
                    'subject' => 'Application ' . ($request->stat == '1' ? 'Approved' : 'Decline'),
                    'body' => "Your application to our school as a " . $request->role_name . " has been "
                        . ($request->stat == '1' ? 'approved' : 'decline')
                        . ($request->role2 != '-1' ? '. We also assigned you the role: ' . $request->role2_name : '.'),
                    'link' => env('PORTAL_URL') . '/staffLogin/' . $request->schid,
                ];
                Mail::to($usr->email)->send(new SSSMails($data));
            } catch (\Exception $e) {
                Log::error('Failed to send email: ' . $e->getMessage());
            }

            return response()->json([
                "status" => true,
                "message" => "Success",
            ]);
        }

        return response()->json([
            "status" => false,
            "message" => "Staff Not Found",
        ], 400);
    }


    /**
     * @OA\Post(
     *     path="/api/setStaffBasicInfo",
     *     tags={"Api"},
     *     security={{"bearerAuth": {}}},
     *     summary="Set basic info about a staff data. Pass 1/0 for stat depending of if application is approved/now",
     *     @OA\RequestBody(
     *         required=true,
     *         @OA\JsonContent(
     *             type="object",
     *             @OA\Property(property="user_id", type="string"),
     *             @OA\Property(property="dob", type="string"),
     *             @OA\Property(property="sex", type="string"),
     *             @OA\Property(property="town", type="string"),
     *             @OA\Property(property="country", type="string"),
     *             @OA\Property(property="state", type="string"),
     *             @OA\Property(property="lga", type="string"),
     *             @OA\Property(property="addr", type="string"),
     *             @OA\Property(property="phn", type="string"),
     *             @OA\Property(property="kin_name", type="string"),
     *             @OA\Property(property="kin_phn", type="string"),
     *             @OA\Property(property="kin_relation", type="string"),
     *             @OA\Property(property="stat", type="string"),
     *         )
     *     ),
     *     @OA\Response(response="200", description="staff data set successfully"),
     *     @OA\Response(response="400", description="Validation error"),
     * )
     */
    public function setStaffBasicInfo(Request $request)
    {
        //Data validation
        $request->validate([
            "user_id" => "required",
            "dob" => "required",
            "sex" => "required",
            "town" => "required",
            "country" => "required",
            "state" => "required",
            "lga" => "required",
            "addr" => "required",
            "phn" => "required",
            "kin_name" => "required",
            "kin_phn" => "required",
            "kin_relation" => "required",
        ]);
        staff_basic_data::updateOrCreate(
            ["user_id" => $request->user_id,],
            [
                "dob" => $request->dob,
                "sex" => $request->sex,
                "town" => $request->town,
                "country" => $request->country,
                "state" => $request->state,
                "lga" => $request->lga,
                "addr" => $request->addr,
                "phn" => $request->phn,
                "kin_name" => $request->kin_name,
                "kin_phn" => $request->kin_phn,
                "kin_relation" => $request->kin_relation,
            ]
        );
        staff::where('sid', $request->user_id)->update([
            "s_basic" => '1'
        ]);
        return response()->json([
            "status" => true,
            "message" => "Success",
        ]);
    }


    /**
     * @OA\Get(
     *     path="/api/getStaffBasicInfo/{uid}",
     *     tags={"Api"},
     *     security={{"bearerAuth": {}}},
     *     summary="Get a staff's Basic Info",
     *     description="Use this endpoint to get basic information about a staff.",
     *     @OA\Parameter(
     *         name="uid",
     *         in="path",
     *         required=true,
     *         description="User Id of the staff",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Response(response="200", description="Success", @OA\JsonContent()),
     *     @OA\Response(response="401", description="Unauthorized"),
     * )
     */
    public function getStaffBasicInfo($uid)
    {
        $pld = staff_basic_data::where("user_id", $uid)->first();
        return response()->json([
            "status" => true,
            "message" => "Success",
            "pld" => $pld,
        ]);
    }

    /**
     * @OA\Post(
     *     path="/api/setStaffProfInfo",
     *     tags={"Api"},
     *     security={{"bearerAuth": {}}},
     *     summary="Set professional info about a staff data. Pass 1/0 for stat depending of if application is approved/now",
     *     @OA\RequestBody(
     *         required=true,
     *         @OA\JsonContent(
     *             type="object",
     *             @OA\Property(property="user_id", type="string"),
     *             @OA\Property(property="grad_date", type="string"),
     *             @OA\Property(property="univ", type="string"),
     *             @OA\Property(property="area", type="string"),
     *             @OA\Property(property="qual", type="string"),
     *             @OA\Property(property="trcn", type="string"),
     *             @OA\Property(property="hqual", type="string"),
     *             @OA\Property(property="place_first_appt", type="string"),
     *             @OA\Property(property="last_employment", type="string"),
     *         )
     *     ),
     *     @OA\Response(response="200", description="staff data set successfully"),
     *     @OA\Response(response="400", description="Validation error"),
     * )
     */
    public function setStaffProfInfo(Request $request)
    {
        //Data validation
        $request->validate([
            "user_id" => "required",
            //"grad_date" => "nullable",
            // "univ" => "nullable",
            "area" => "required",
            // "qual" => "nullable",
            // "trcn" => "nullable",
            // "hqual" => "nullable",
            "place_first_appt" => "required",
            "last_employment" => "required",
        ]);
        staff_prof_data::updateOrCreate(
            ["user_id" => $request->user_id,],
            [
                "grad_date" => $request->grad_date,
                "univ" => $request->univ,
                "area" => $request->area,
                "qual" => $request->qual,
                "trcn" => $request->trcn,
                "hqual" => $request->hqual,
                "place_first_appt" => $request->place_first_appt,
                "last_employment" => $request->last_employment,
            ]
        );
        staff::where('sid', $request->user_id)->update([
            "s_prof" => '1'
        ]);
        return response()->json([
            "status" => true,
            "message" => "Success",
        ]);
    }


    /**
     * @OA\Get(
     *     path="/api/getStaffProfInfo/{uid}",
     *     tags={"Api"},
     *     security={{"bearerAuth": {}}},
     *     summary="Get a staff's Professional Info",
     *     description="Use this endpoint to get professional information about a staff.",
     *     @OA\Parameter(
     *         name="uid",
     *         in="path",
     *         required=true,
     *         description="User Id of the staff",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Response(response="200", description="Success", @OA\JsonContent()),
     *     @OA\Response(response="401", description="Unauthorized"),
     * )
     */
    public function getStaffProfInfo($uid)
    {
        $pld = staff_prof_data::where("user_id", $uid)->first();
        return response()->json([
            "status" => true,
            "message" => "Success",
            "pld" => $pld,
        ]);
    }

    /**
     * @OA\Post(
     *     path="/api/setStaffSubjects",
     *     tags={"Api"},
     *     security={{"bearerAuth": {}}},
     *     summary="Assign subject(s) to staff",
     *     description="Creates or updates a staff subject assignment with a unique UID for the given session and term.",
     *     @OA\RequestBody(
     *         required=true,
     *         @OA\JsonContent(
     *             type="object",
     *             required={"stid","sbj","schid","sesn","trm"},
     *             @OA\Property(property="stid", type="integer", example=1929, description="Staff ID"),
     *             @OA\Property(property="sbj", type="integer", example=101, description="Subject ID"),
     *             @OA\Property(property="schid", type="integer", example=12, description="School ID"),
     *             @OA\Property(property="sesn", type="integer", example=2024, description="Academic Session"),
     *             @OA\Property(property="trm", type="integer", example=1, description="Academic Term")
     *         )
     *     ),
     *     @OA\Response(
     *         response=200,
     *         description="Subject successfully assigned to staff",
     *         @OA\JsonContent(
     *             type="object",
     *             @OA\Property(property="status", type="boolean", example=true),
     *             @OA\Property(property="message", type="string", example="Success"),
     *             @OA\Property(
     *                 property="pld",
     *                 type="object",
     *                 @OA\Property(property="uid", type="string", example="20241192956789"),
     *                 @OA\Property(property="stid", type="integer", example=1929),
     *                 @OA\Property(property="sbj", type="integer", example=101),
     *                 @OA\Property(property="schid", type="integer", example=12),
     *                 @OA\Property(property="sesn", type="integer", example=2024),
     *                 @OA\Property(property="trm", type="integer", example=1),
     *                 @OA\Property(property="created_at", type="string", example="2024-11-27 04:25:03"),
     *                 @OA\Property(property="updated_at", type="string", example="2024-11-27 04:25:03")
     *             )
     *         )
     *     ),
     *     @OA\Response(
     *         response=422,
     *         description="Validation error"
     *     )
     * )
     */

    public function setStaffSubject(Request $request)
    {
        // Data validation
        $request->validate([
            "stid" => "required",
            "sbj" => "required",
            "schid" => "required",
            "sesn" => "required",
            "trm" => "required",
        ]);

        // Generate unique UID
        $uid = $request->sesn . $request->trm . $request->stid . $request->sbj;

        // Update or create based on UID only
        $pld = staff_subj::updateOrCreate(
            ["uid" => $uid],
            [
                "stid" => $request->stid,
                "sbj" => $request->sbj,
                "schid" => $request->schid,
                "sesn" => $request->sesn,
                "trm" => $request->trm,
            ]
        );

        return response()->json([
            "status" => true,
            "message" => "Success",
            "pld" => $pld
        ]);
    }



    /**
     * @OA\Get(
     *     path="/api/getOldStudentsAndSubject/{schid}/{ssn}/{trm}/{clsm}/{clsa}/{stf}",
     *     tags={"Api"},
     *     security={{"bearerAuth": {}}},
     *     summary="Get an old student's Basic Info",
     *     description="Use this endpoint to get basic information about an old student.",
     *     @OA\Parameter(
     *         name="schid",
     *         in="path",
     *         required=true,
     *         description="Id of the school",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Parameter(
     *         name="ssn",
     *         in="path",
     *         required=true,
     *         description="Id of the session",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Parameter(
     *         name="trm",
     *         in="path",
     *         required=true,
     *         description="Term ID",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Parameter(
     *         name="clsm",
     *         in="path",
     *         required=true,
     *         description="Id of the main class",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Parameter(
     *         name="clsa",
     *         in="path",
     *         required=true,
     *         description="Id of the class arm",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Parameter(
     *         name="stf",
     *         in="path",
     *         required=true,
     *         description="Staff ID",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Response(response="200", description="Success", @OA\JsonContent()),
     *     @OA\Response(response="401", description="Unauthorized"),
     * )
     */


    public function getOldStudentsAndSubject($schid, $ssn, $trm, $clsm, $clsa, $stf)
    {
        // Fetch students based on class and arm
        $ostd = old_student::where("schid", $schid)
            ->where("status", "active")
            ->where("ssn", $ssn)
            ->where("clsm", $clsm)
            ->where("trm", $trm); //  filter by term


        if ($clsa != '-1') {
            $ostd = $ostd->where("clsa", $clsa);
        }

        //  Ensure unique students by sid
        $ostd = $ostd->get()->unique('sid')->values();

        $stdPld = [];
        $allSubjects = []; // Track unique subjects for cls-sbj

        foreach ($ostd as $std) {
            $user_id = $std->sid;

            // Get all subjects assigned to the student
            $studentSubjects = student_subj::where('stid', $user_id)
                ->get();

            $mySbjs = [];
            $scores = [];
            $totalScore = 0;
            $scoreCount = 0;
            $studentSubjectIds = [];

            foreach ($studentSubjects as $sbj) {
                if (in_array($sbj->sbj, $studentSubjectIds)) {
                    continue;
                }
                $studentSubjectIds[] = $sbj->sbj;

                // Save only subject ID
                $mySbjs[] = (string) $sbj->sbj;

                // Track unique subjects for class-wide subjects list
                if (!isset($allSubjects[$sbj->sbj])) {
                    $allSubjects[$sbj->sbj] = (string) $sbj->sbj;
                }

                // Fetch scores
                $subjectScores = std_score::where('stid', $user_id)
                    ->where('sbj', $sbj->sbj)
                    ->where('schid', $schid)
                    ->where('ssn', $ssn)
                    ->where('trm', $trm)
                    ->where('clsid', $clsm)
                    ->get()
                    ->map(fn($s) => $s->toArray())
                    ->values();

                foreach ($subjectScores as $s) {
                    if (!empty($s['scr']) && is_numeric($s['scr'])) {
                        $totalScore += $s['scr'];
                        $scoreCount++;
                    }
                }

                $scores[] = [
                    'sbid' => (string) $sbj->sbj,
                    'scores' => $subjectScores,
                ];
            }

            $avgScore = $scoreCount > 0 ? round($totalScore / $scoreCount, 2) : 0;
            $grade = $this->gradeFromAvg2($avgScore);

            // Check for psychological evaluation
            $psy = false;
            if ($stf == "-2") {
                $psy = student_psy::where("schid", $schid)
                    ->where("ssn", $ssn)
                    ->where("trm", $trm)
                    ->where("clsm", $clsm)
                    ->where("stid", $user_id)
                    ->exists();
            }

            // Fetch student result info
            $res = "0";
            $rinfoModel = student_res::where("schid", $schid)
                ->where("ssn", $ssn)
                ->where("trm", $trm)
                ->where("clsm", $clsm)
                ->where("clsa", $clsa)
                ->where("stid", $user_id)
                ->first();

            $rinfo = new \stdClass(); // Ensure object
            if ($rinfoModel) {
                $res = $rinfoModel->stat;
                $rinfo = [
                    'uid' => $rinfoModel->uid,
                    'stat' => $rinfoModel->stat,
                    'com' => $rinfoModel->com,
                    'stid' => $rinfoModel->stid,
                    'schid' => $rinfoModel->schid,
                    'ssn' => $rinfoModel->ssn,
                    'trm' => $rinfoModel->trm,
                    'clsm' => $rinfoModel->clsm,
                    'clsa' => $rinfoModel->clsa,
                    'pos' => $rinfoModel->pos,
                    'avg' => $rinfoModel->avg,
                    'cavg' => $rinfoModel->cavg,
                    'created_at' => $rinfoModel->created_at,
                    'updated_at' => $rinfoModel->updated_at,
                    'grade' => isset($rinfoModel->avg) ? $this->gradeFromAvg2($rinfoModel->avg) : null,
                ];
            }

            // Build student payload
            $stdPld[] = [
                'std' => $std->toArray(),
                'sbj' => $mySbjs,
                'scr' => $scores,
                'avg_score' => $avgScore,
                'grade' => $grade,
                'psy' => $psy,
                'res' => $res,
                'rinfo' => $rinfo,
            ];
        }

        // Prepare class subjects list
        $clsSbj = array_values($allSubjects);

        $pld = [
            'std-pld' => $stdPld,
            'cls-sbj' => $clsSbj,
        ];

        return response()->json([
            "status" => true,
            "message" => "Success",
            "pld" => $pld,
        ]);
    }




    private function gradeFromAvg2($avg)
    {
        if ($avg >= 70)
            return 'A';
        elseif ($avg >= 60)
            return 'B';
        elseif ($avg >= 50)
            return 'C';
        elseif ($avg >= 45)
            return 'D';
        elseif ($avg >= 40)
            return 'E';
        else
            return 'F';
    }





    //////////////////////////////////////////////////////////////////////////////////////

    /**
     * @OA\Get(
     *     path="/api/getOldStudentsAndSubjectScoreSheet/{schid}/{ssn}/{trm}/{clsm}/{clsa}/{stf}",
     *     summary="Get old students and subject score sheet",
     *     description="Fetches active old students for a given school, session, term, and class, along with their subject enrollments, scores, psychomotor info, and results.",
     *     tags={"Api"},
     *     security={{"bearerAuth": {}}},
     *
     *     @OA\Parameter(
     *         name="schid",
     *         in="path",
     *         required=true,
     *         description="School ID",
     *         @OA\Schema(type="integer")
     *     ),
     *     @OA\Parameter(
     *         name="ssn",
     *         in="path",
     *         required=true,
     *         description="Session identifier",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Parameter(
     *         name="trm",
     *         in="path",
     *         required=true,
     *         description="Term identifier",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Parameter(
     *         name="clsm",
     *         in="path",
     *         required=true,
     *         description="Class main ID",
     *         @OA\Schema(type="integer")
     *     ),
     *     @OA\Parameter(
     *         name="clsa",
     *         in="path",
     *         required=true,
     *         description="Class arm ID (use -1 for all arms)",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Parameter(
     *         name="stf",
     *         in="path",
     *         required=true,
     *         description="Staff ID (-1 for all subjects, -2 for psychomotor)",
     *         @OA\Schema(type="string")
     *     ),
     *
     *     @OA\Response(
     *         response=200,
     *         description="Successful response with old students and their subject scores",
     *         @OA\JsonContent(
     *             type="object",
     *             @OA\Property(property="status", type="boolean", example=true),
     *             @OA\Property(property="message", type="string", example="Success"),
     *             @OA\Property(
     *                 property="pld",
     *                 type="object",
     *                 @OA\Property(
     *                     property="std-pld",
     *                     type="array",
     *                     description="List of students with their subjects and scores",
     *                     @OA\Items(
     *                         type="object",
     *                         @OA\Property(property="std", type="object", description="Old student record"),
     *                         @OA\Property(property="sbj", type="array", @OA\Items(type="integer"), description="List of subject IDs"),
     *                         @OA\Property(
     *                             property="scr",
     *                             type="array",
     *                             description="Scores per subject",
     *                             @OA\Items(
     *                                 type="object",
     *                                 @OA\Property(property="sbid", type="integer", description="Subject ID"),
     *                                 @OA\Property(property="scores", type="array", @OA\Items(type="object"), description="List of scores for the subject")
     *                             )
     *                         ),
     *                         @OA\Property(property="psy", type="boolean", description="Psychomotor record exists"),
     *                         @OA\Property(property="res", type="string", description="Result status"),
     *                         @OA\Property(property="rinfo", type="object", description="Student result info")
     *                     )
     *                 ),
     *                 @OA\Property(
     *                     property="cls-sbj",
     *                     type="array",
     *                     description="List of class subjects",
     *                     @OA\Items(type="object")
     *                 )
     *             )
     *         )
     *     ),
     *     @OA\Response(
     *         response=400,
     *         description="Bad request"
     *     )
     * )
     */


    public function getOldStudentsAndSubjectScoreSheet($schid, $ssn, $trm, $clsm, $clsa, $stf)
    {
        // 1. Fetch only students that match EXACTLY the session, term, class, and arm
        $ostd = old_student::where("schid", $schid)
            ->where("status", "active")
            ->where("ssn", $ssn)
            ->where("trm", $trm)
            ->where("clsm", $clsm)
            ->when($clsa != "-1", function ($q) use ($clsa) {
                $q->where("clsa", $clsa);
            })
            ->distinct("sid") // prevent duplicate rows for same student
            ->get();

        // 2. Fetch relevant subjects
        if ($stf == "-1" || $stf == "-2") {
            // No staff filter
            $relevantSubjects = class_subj::where('class_subj.schid', $schid)
                ->where('class_subj.clsid', $clsm)
                ->where('sesn', $ssn)
                ->distinct()
                ->pluck('subj_id');
        } else {
            // Staff-specific subjects
            $relevantSubjects = class_subj::join('staff_subj', 'class_subj.subj_id', '=', 'staff_subj.sbj')
                ->where('class_subj.schid', $schid)
                ->where('class_subj.clsid', $clsm)
                ->where('class_subj.sesn', $ssn)
                ->where('staff_subj.stid', $stf)
                ->distinct()
                ->pluck('sbj');
        }

        $stdPld = [];

        foreach ($ostd as $std) {
            $user_id = $std->sid;

            // 3. Fetch unique subjects for the student
            $studentSubjects = student_subj::where('stid', $user_id)
                ->whereIn('sbj', $relevantSubjects)
                ->where('ssn', $ssn) // filter by session
                ->distinct('sbj')
                ->get();

            $mySbjs = [];
            $scores = [];

            foreach ($studentSubjects as $sbj) {
                $sbid = (string) $sbj->sbj;
                $mySbjs[] = $sbid;

                // 4. Fetch scores (filtered by session, term, class)
                // $subjectScores = std_score::where('stid', $user_id)
                //     ->where('sbj', $sbid)
                //     ->where("schid", $schid)
                //     ->where("ssn", $ssn)
                //     ->where("trm", $trm)
                //     ->where("clsid", $clsm)
                //     ->get();

                // $scores[] = [
                //     'sbid' => $sbid,
                //     'scores' => $subjectScores
                // ];

                $subjectScores = std_score::where('stid', $user_id)
                    ->where('sbj', $sbid)
                    ->where("schid", $schid)
                    ->where("ssn", $ssn)
                    ->where("trm", $trm)
                    ->where("clsid", $clsm)
                    ->get();

                // If no score record exists, assign scr = 0
                if ($subjectScores->isEmpty()) {
                    $subjectScores = collect([
                        [
                            "stid" => $user_id,
                            "sbj" => $sbid,
                            "scr" => 0,
                            "schid" => $schid,
                            "clsid" => $clsm,
                            "ssn" => $ssn,
                            "trm" => $trm,
                        ]
                    ]);
                }

                $scores[] = [
                    'sbid' => $sbid,
                    'scores' => $subjectScores
                ];

            }

            // 5. Extra info for staff = -2
            $psy = false;
            $res = "0";
            $rinfo = [];

            if ($stf == "-2") {
                $psy = student_psy::where("schid", $schid)
                    ->where("ssn", $ssn)
                    ->where("trm", $trm)
                    ->where("clsm", $clsm)
                    ->where("stid", $user_id)
                    ->exists();

                $rinfo = student_res::where("schid", $schid)
                    ->where("ssn", $ssn)
                    ->where("trm", $trm)
                    ->where("clsm", $clsm)
                    ->where("stid", $user_id)
                    ->first();

                if ($rinfo) {
                    $res = $rinfo->stat;
                }
            }

            // 6. Push result (no duplicate sbj/scr)
            $stdPld[] = [
                'std' => $std,
                'sbj' => array_values(array_unique($mySbjs)),
                'scr' => collect($scores)->unique('sbid')->values(),
                'psy' => $psy,
                'res' => $res,
                'rinfo' => $rinfo ?: []
            ];
        }

        // 7. Build unique class subjects using subj model
        $clsSbj = subj::whereIn('id', $relevantSubjects)->get();

        return response()->json([
            "status" => true,
            "message" => "Success",
            "pld" => [
                'std-pld' => $stdPld,
                'cls-sbj' => $clsSbj
            ],
        ]);
    }





    /**
     * @OA\Get(
     *     path="/api/getOldStudentsAndSubjectHistory/{schid}/{ssn}/{trm}/{clsm}/{clsa}/{stf}",
     *     tags={"Api"},
     *     security={{"bearerAuth": {}}},
     *     summary="Get an old student's score from past session",
     *     description="Use this endpoint to get basic information about an old student.",
     *     @OA\Parameter(
     *         name="schid",
     *         in="path",
     *         required=true,
     *         description="Id of the school",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Parameter(
     *         name="ssn",
     *         in="path",
     *         required=true,
     *         description="Id of the session",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Parameter(
     *         name="trm",
     *         in="path",
     *         required=true,
     *         description="Term ID",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Parameter(
     *         name="clsm",
     *         in="path",
     *         required=true,
     *         description="Id of the main class",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Parameter(
     *         name="clsa",
     *         in="path",
     *         required=true,
     *         description="Id of the class arm",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Parameter(
     *         name="stf",
     *         in="path",
     *         required=true,
     *         description="Staff ID",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Response(response="200", description="Success", @OA\JsonContent()),
     *     @OA\Response(response="401", description="Unauthorized"),
     * )
     */


    // public function getOldStudentsAndSubjectHistory($schid, $ssn, $trm, $clsm, $clsa, $stf)
    // {
    //     $ostd = [];
    //     if ($clsa == '-1') {
    //         $ostd = old_student::where("schid", $schid)
    //             ->where("ssn", $ssn)
    //             ->where("trm", $trm)
    //             ->where('status', 'active')
    //             ->where("clsm", $clsm)
    //             ->get();
    //     } else {
    //         $ostd = old_student::where("schid", $schid)
    //             ->where("ssn", $ssn)
    //             ->where("trm", $trm)
    //             ->where('status', 'active')
    //             ->where("clsm", $clsm)
    //             ->where("clsa", $clsa)
    //             ->get();
    //     }

    //     $stdPld = [];
    //     $relevantSubjects = [];
    //     $clsSbj = [];

    //     foreach ($ostd as $std) {
    //         $user_id = $std->sid;
    //         $mySbjs = [];

    //         // Get all scores where score > 0
    //         $allScores = std_score::where('stid', $user_id)
    //             ->where("schid", $schid)
    //             ->where("ssn", $ssn)
    //             ->where("trm", $trm)
    //             ->where("clsid", $clsm)
    //             ->whereNotNull('scr')
    //             ->where('scr', '>', 0)
    //             ->get();



    //         foreach ($allScores as $scr) {
    //             if (!in_array($scr->sbj, $mySbjs)) {
    //                 $mySbjs[] = $scr->sbj;
    //             }
    //             if (!in_array($scr->sbj, $relevantSubjects)) {
    //                 $schSbj = subj::select('id', 'name', 'created_at', 'updated_at')
    //                     ->where('id', $scr->sbj)
    //                     ->first();
    //                 if ($schSbj) {
    //                     $clsSbj[] = $schSbj;
    //                     $relevantSubjects[] = $scr->sbj;
    //                 }
    //             }
    //         }

    //         // Organize scores by subject
    //         $subjectScores = [];
    //         foreach ($mySbjs as $sbid) {
    //             $subjectScores[$sbid] = [];
    //         }

    //         foreach ($allScores as $scr) {
    //             $subjectScores[$scr->sbj][] = $scr;
    //         }

    //         $scores = [];
    //         foreach ($mySbjs as $sbid) {
    //             $scores[] = [
    //                 'sbid' => $sbid,
    //                 'scores' => $subjectScores[$sbid]
    //             ];
    //         }

    //         $psy = false;
    //         $res = "0";
    //         $rinfo = [];

    //         if ($stf == "-2") {
    //             $psy = student_psy::where("schid", $schid)
    //                 ->where("ssn", $ssn)
    //                 ->where("trm", $trm)
    //                 ->where("clsm", $clsm)
    //                 ->where("stid", $user_id)
    //                 ->exists();

    //             $rinfo = student_res::where("schid", $schid)
    //                 ->where("ssn", $ssn)
    //                 ->where("trm", $trm)
    //                 ->where("clsm", $clsm)
    //                 ->where("stid", $user_id)
    //                 ->first();

    //             if ($rinfo) {
    //                 $res = $rinfo->stat;
    //             }
    //         }

    //         $stdPld[] = [
    //             'std' => $std,
    //             'sbj' => $mySbjs,
    //             'scr' => $scores,
    //             'psy' => $psy,
    //             'res' => $res,
    //             'rinfo' => $rinfo,
    //         ];
    //     }

    //     // Remove duplicate subjects
    //     $clsSbj = collect($clsSbj)->unique('id')->values();

    //     $pld = [
    //         'std-pld' => $stdPld,
    //         'cls-sbj' => $clsSbj
    //     ];

    //     return response()->json([
    //         "status" => true,
    //         "message" => "Success",
    //         "pld" => $pld,
    //     ]);
    // }


    public function getOldStudentsAndSubjectHistory($schid, $ssn, $trm, $clsm, $clsa, $stf)
    {
        $ostd = [];
        if ($clsa == '-1') {
            $ostd = old_student::where("schid", $schid)
                ->where("ssn", $ssn)
                ->where("trm", $trm)
                ->where('status', 'active')
                ->where("clsm", $clsm)
                ->get();
        } else {
            $ostd = old_student::where("schid", $schid)
                ->where("ssn", $ssn)
                ->where("trm", $trm)
                ->where('status', 'active')
                ->where("clsm", $clsm)
                ->where("clsa", $clsa)
                ->get();
        }

        $stdPld = [];
        $relevantSubjects = [];
        $clsSbj = [];

        foreach ($ostd as $std) {
            $user_id = $std->sid;
            $mySbjs = [];

            $allScores = std_score::where('stid', $user_id)
                ->where("schid", $schid)
                ->where("ssn", $ssn)
                ->where("trm", $trm)
                ->where("clsid", $clsm)
                ->whereNotNull('scr')
                ->where('scr', '>', 0)
                ->get();

            /* ===================== CORRECT AVERAGE & GRADE LOGIC ===================== */
            $subjectTotals = [];

            foreach ($allScores as $score) {
                $sbj = $score->sbj;

                if (!isset($subjectTotals[$sbj])) {
                    $subjectTotals[$sbj] = 0;
                }

                // SUM all scores per subject (CA + Exam)
                $subjectTotals[$sbj] += $score->scr;
            }

            // Average of SUBJECT TOTALS (NOT raw scores)
            $average = 0;
            if (count($subjectTotals) > 0) {
                $average = array_sum($subjectTotals) / count($subjectTotals);
            }

            $avgForGrade = (int) floor($average);

            $grade = \DB::table('sch_grade')
                ->where('schid', $schid)
                ->where('clsid', $clsm)
                ->where('ssn', $ssn)
                ->where('trm', $trm)
                ->where('g0', '<=', $avgForGrade)
                ->where('g1', '>=', $avgForGrade)
                ->value('grd');

            /* ===================== END CORRECT LOGIC ===================== */

            foreach ($allScores as $scr) {
                if (!in_array($scr->sbj, $mySbjs)) {
                    $mySbjs[] = $scr->sbj;
                }
                if (!in_array($scr->sbj, $relevantSubjects)) {
                    $schSbj = subj::select('id', 'name', 'created_at', 'updated_at')
                        ->where('id', $scr->sbj)
                        ->first();
                    if ($schSbj) {
                        $clsSbj[] = $schSbj;
                        $relevantSubjects[] = $scr->sbj;
                    }
                }
            }

            $subjectScores = [];
            foreach ($mySbjs as $sbid) {
                $subjectScores[$sbid] = [];
            }

            foreach ($allScores as $scr) {
                $subjectScores[$scr->sbj][] = $scr;
            }

            $scores = [];
            foreach ($mySbjs as $sbid) {
                $scores[] = [
                    'sbid' => $sbid,
                    'scores' => $subjectScores[$sbid]
                ];
            }

            $psy = false;
            $res = "0";
            $rinfo = [];

            if ($stf == "-2") {
                $psy = student_psy::where("schid", $schid)
                    ->where("ssn", $ssn)
                    ->where("trm", $trm)
                    ->where("clsm", $clsm)
                    ->where("stid", $user_id)
                    ->exists();

                $rinfo = student_res::where("schid", $schid)
                    ->where("ssn", $ssn)
                    ->where("trm", $trm)
                    ->where("clsm", $clsm)
                    ->where("stid", $user_id)
                    ->first();

                if ($rinfo) {
                    $res = $rinfo->stat;
                }
            }

            $stdPld[] = [
                'std' => $std,
                'sbj' => $mySbjs,
                'scr' => $scores,
                'avg' => round($average, 2),
                'grade' => $grade,
                'psy' => $psy,
                'res' => $res,
                'rinfo' => $rinfo,
            ];
        }

        $clsSbj = collect($clsSbj)->unique('id')->values();

        $pld = [
            'std-pld' => $stdPld,
            'cls-sbj' => $clsSbj
        ];

        return response()->json([
            "status" => true,
            "message" => "Success",
            "pld" => $pld,
        ]);
    }



    /**
     * @OA\Get(
     *     path="/api/getOldStudentsAndSubjectWithoutScore/{schid}/{ssn}/{trm}/{clsm}/{clsa}/{stf}",
     *     tags={"Api"},
     *     security={{"bearerAuth": {}}},
     *     summary="Get an old student's Basic Info",
     *     description="Use this endpoint to get basic information about an old student.",
     *     @OA\Parameter(
     *         name="schid",
     *         in="path",
     *         required=true,
     *         description="Id of the school",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Parameter(
     *         name="ssn",
     *         in="path",
     *         required=true,
     *         description="Id of the session",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Parameter(
     *         name="trm",
     *         in="path",
     *         required=true,
     *         description="Term ID",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Parameter(
     *         name="clsm",
     *         in="path",
     *         required=true,
     *         description="Id of the main class",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Parameter(
     *         name="clsa",
     *         in="path",
     *         required=true,
     *         description="Id of the class arm",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Parameter(
     *         name="stf",
     *         in="path",
     *         required=true,
     *         description="Staff ID",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Response(response="200", description="Success", @OA\JsonContent()),
     *     @OA\Response(response="401", description="Unauthorized"),
     * )
     */


    public function getOldStudentsAndSubjectWithoutScore($schid, $ssn, $trm, $clsm, $clsa, $stf)
    {
        // Get old students
        if ($clsa == '-1') {
            $ostd = old_student::where("schid", $schid)
                ->where("ssn", $ssn)
                ->where("trm", $trm)
                ->where("clsm", $clsm)
                ->where("status", "active")
                ->orderBy('lname', 'asc')
                ->get();
        } else {
            $ostd = old_student::where("schid", $schid)
                ->where("ssn", $ssn)
                ->where("trm", $trm)
                ->where("clsm", $clsm)
                ->where("clsa", $clsa)
                ->where("status", "active")
                ->orderBy('lname', 'asc')
                ->get();
        }

        $stdPld = [];

        // Get all subjects for this class (for cls-sbj) and rename subj_id to id
        $clsSbj = class_subj::where("schid", $schid)
            ->where("clsid", $clsm)
            ->where("sesn", $ssn)
            ->where("trm", $trm)
            ->get()
            ->map(function ($item) {
                return [
                    'id' => $item->subj_id,  // changed from subj_id to id
                    'name' => $item->name,
                    'comp' => $item->comp
                ];
            });

        foreach ($ostd as $std) {
            $user_id = $std->sid;
            $mySbjs = [];

            // Get all scores for student
            $allScores = std_score::where('stid', $user_id)
                ->where("schid", $schid)
                ->where("ssn", $ssn)
                ->where("trm", $trm)
                ->where("clsid", $clsm)
                ->pluck('sbj');

            if ($allScores->isNotEmpty()) {
                // Remove duplicates
                $mySbjs = $allScores->unique()->values()->toArray();
            } else {
                // Otherwise, use subjects assigned in student_subj
                $studentSubjects = student_subj::where('stid', $user_id)
                    ->where("schid", $schid)
                    ->where("ssn", $ssn)
                    ->where("trm", $trm)
                    ->where("clsid", $clsm)
                    ->pluck('sbj');

                // Remove duplicates
                $mySbjs = $studentSubjects->unique()->values()->toArray();
            }

            $stdPld[] = [
                'std' => $std,
                'sbj' => $mySbjs,
            ];
        }


        $pld = [
            'std-pld' => $stdPld,
            'cls-sbj' => $clsSbj,
        ];

        return response()->json([
            "status" => true,
            "message" => "Success",
            "pld" => $pld,
        ]);
    }



    /**
     * @OA\Get(
     *     path="/api/getStudentResult/{schid}/{ssn}/{trm}/{clsm}/{clsa}/{stid}",
     *     tags={"Api"},
     *     security={{"bearerAuth": {}}},
     *     summary="Get a student's result",
     *     description="Use this endpoint to get basic information about a student's result.",
     *     @OA\Parameter(
     *         name="schid",
     *         in="path",
     *         required=true,
     *         description="Id of the school",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Parameter(
     *         name="ssn",
     *         in="path",
     *         required=true,
     *         description="Id of the session",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Parameter(
     *         name="trm",
     *         in="path",
     *         required=true,
     *         description="Term ID",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Parameter(
     *         name="clsm",
     *         in="path",
     *         required=true,
     *         description="Id of the main class",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Parameter(
     *         name="clsa",
     *         in="path",
     *         required=true,
     *         description="Id of the class arm",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Parameter(
     *         name="stid",
     *         in="path",
     *         required=true,
     *         description="Student ID",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Response(response="200", description="Success", @OA\JsonContent()),
     *     @OA\Response(response="401", description="Unauthorized"),
     * )
     */


    // public function getStudentResult($schid, $ssn, $trm, $clsm, $clsa, $stid)
    // {

    //             $user = auth()->user();

    //     // Check if results are published for this class/arm/term
    //     $isPublished = student_res::where([
    //         ['schid', $schid],
    //         ['ssn', $ssn],
    //         ['trm', $trm],
    //         ['clsm', $clsm],
    //         ['clsa', $clsa],
    //         ['stat', 1], // PUBLISHED
    //     ])->exists();

    //     /**
    //      * IF NOT PUBLISHED:
    //      * - Only School Admin (a, s) can view (Bulk Result)
    //      * - Everyone else is blocked
    //      */
    //     if (!$isPublished) {
    //         if (!$user || !in_array($user->typ, ['a', 's'])) {
    //             return response()->json([
    //                 'status' => false,
    //                 'message' => 'Results have not been published yet.'
    //             ], 403);
    //         }
    //     }

    //     $totalStd = student::join('old_student', 'student.sid', '=', 'old_student.sid')
    //         ->where('student.schid', $schid)
    //         ->where('student.stat', "1")
    //         ->where('old_student.ssn', $ssn)
    //         ->where('old_student.clsm', $clsm)
    //         ->where('old_student.clsa', $clsa)
    //         ->count();

    //     $std = old_student::where("schid", $schid)->where("ssn", $ssn)
    //         ->where("clsm", $clsm)
    //         ->where("clsa", $clsa)->where("sid", $stid)->first();

    //     if (!$std) {
    //         return response()->json([
    //             "status" => false,
    //             "message" => "Student has been exited",
    //             "pld" => []
    //         ], 404);
    //     }

    //     $user_id = $std->sid;
    //     $scores = [];
    //     $mySbjs = [];

    //     // Get the relevant subjects for the student
    //     $relevantSubjects = class_subj::join('staff_subj', 'class_subj.subj_id', '=', 'staff_subj.sbj')
    //         ->where('class_subj.schid', $schid)
    //         ->where('class_subj.clsid', $clsm)
    //         ->pluck('sbj');

    //     // Get subjects the student is registered for
    //     $studentSubjects = student_subj::where('stid', $user_id)
    //         ->whereIn('sbj', $relevantSubjects)
    //         ->pluck('sbj');

    //     // Get all scores, excluding subjects with zero or null scores
    //     $allScores = std_score::where('stid', $user_id)
    //         ->where("schid", $schid)
    //         ->where("ssn", $ssn)
    //         ->where("trm", $trm)
    //         ->where("clsid", $clsm)
    //         ->whereIn("sbj", $studentSubjects)
    //         ->whereNotNull('scr')
    //         ->where('scr', '>', 0) // Ensure only subjects with scores > 0 are considered
    //         ->get();

    //     // Populate subjects that have scores
    //     foreach ($allScores as $scr) {
    //         $sbid = $scr->sbj;
    //         if (!in_array($sbid, $mySbjs)) {
    //             $mySbjs[] = $sbid;
    //         }
    //     }

    //     $subjectScores = [];
    //     foreach ($mySbjs as $sbid) {
    //         $subjectScores[$sbid] = [];
    //     }

    //     // Assign scores to subjects
    //     foreach ($allScores as $scr) {
    //         $sbid = $scr->sbj;
    //         $subjectScores[$sbid][] = $scr;
    //     }

    //     $positions = [];
    //     foreach ($mySbjs as $sbid) {
    //         $scores[] = [
    //             'sbid' => $sbid,
    //             'scores' => $subjectScores[$sbid]
    //         ];

    //         // Get subject position, excluding zero/null score subjects
    //         $subjectPosition = student_sub_res::where('stid', $user_id)
    //             ->where('sbj', $sbid)
    //             ->where("schid", $schid)
    //             ->where("ssn", $ssn)
    //             ->where("trm", $trm)
    //             ->where("clsm", $clsm)
    //             ->where("clsa", $clsa)
    //             ->first();

    //         if ($subjectPosition) {
    //             $positions[] = [
    //                 'sbid' => $sbid,
    //                 'pos' => $subjectPosition->pos,
    //             ];
    //         }
    //     }

    //     // Check for student psychological result
    //     $psy = student_psy::where([
    //         ['schid', $schid],
    //         ['ssn', $ssn],
    //         ['trm', $trm],
    //         ['clsm', $clsm],
    //         ['stid', $user_id]
    //     ])->exists();

    //     // Get student result info
    //     $rinfo = student_res::where("schid", $schid)
    //         ->where("ssn", $ssn)
    //         ->where("trm", $trm)
    //         ->where("clsm", $clsm)
    //         ->where("stid", $user_id)
    //         ->first();

    //     $res = student_res::where([
    //         ['schid', $schid],
    //         ['ssn', $ssn],
    //         ['trm', $trm],
    //         ['clsm', $clsm],
    //         ['stid', $user_id]
    //     ])->value('stat') ?? "0";


    //     // Get the number of fails (nof) from the result_meta table
    //     $nof = result_meta::where([
    //         ['schid', $schid],
    //         ['ssn', $ssn],
    //         ['trm', $trm],
    //     ])->value('num_of_days') ?? 0;

    //     $presentCountQuery = \DB::table('attendances')
    //         ->where('schid', $schid)
    //         ->where('ssn', $ssn)
    //         ->where('trm', $trm)
    //         ->where('sid', $std->sid);



    //     // Check if any attendance exists for this student
    //     $attendanceExists = $presentCountQuery->exists();

    //     if ($attendanceExists) {
    //         Log::info('Success:' . $attendanceExists . 'yes it is');
    //         $presentCount = $presentCountQuery->where('status', 1)->count();
    //         $absentCount = max(0, $nof - $presentCount);
    //     } else {
    //         Log::info('Error' . 'no attendance');
    //         $presentCount = null;
    //         $absentCount = null;
    //     }


    //     $pld = [
    //         'std' => $std,
    //         'sbj' => $mySbjs,  // List of subjects with valid scores
    //         'scr' => $scores,  // List of scores
    //         'psy' => $psy,
    //         'res' => $res,
    //         'rinfo' => $rinfo,
    //         'cnt' => $totalStd,
    //         'num_of_days' => $nof,
    //         'present_days' => $presentCount,
    //         'absent_days' => $absentCount,
    //         'spos' => $positions, // Subject positions
    //     ];

    //     return response()->json([
    //         "status" => true,
    //         "message" => "Success",
    //         "pld" => $pld,
    //     ]);
    // }


    public function getStudentResult($schid, $ssn, $trm, $clsm, $clsa, $stid)
    {
        try {
            $user = auth()->user();
            $userType = $user->typ ?? null; // null-safe

            // Check if results are published for this class/arm/term
            $isPublished = student_res::where([
                ['schid', $schid],
                ['ssn', $ssn],
                ['trm', $trm],
                ['clsm', $clsm],
                ['clsa', $clsa],
                ['stat', 1], // PUBLISHED
            ])->exists();

            /**
             * IF NOT PUBLISHED:
             * - Only School Admin (a, s) can view (Bulk Result)
             * - Everyone else is blocked
             */
            if (!$isPublished) {
                if (!$userType || !in_array($userType, ['a', 's'])) {
                    return response()->json([
                        'status' => false,
                        'message' => 'Results have not been published yet.'
                    ], 403);
                }
            }

            $totalStd = student::join('old_student', 'student.sid', '=', 'old_student.sid')
                ->where('student.schid', $schid)
                ->where('student.stat', "1")
                ->where('old_student.ssn', $ssn)
                ->where('old_student.clsm', $clsm)
                ->where('old_student.clsa', $clsa)
                ->count();

            $std = old_student::where("schid", $schid)
                ->where("ssn", $ssn)
                ->where("clsm", $clsm)
                ->where("clsa", $clsa)
                ->where("sid", $stid)
                ->first();

            if (!$std) {
                return response()->json([
                    "status" => false,
                    "message" => "Student has been exited",
                    "pld" => []
                ], 404);
            }

            $user_id = $std->sid;
            $scores = [];
            $mySbjs = [];

            // Get the relevant subjects for the student
            $relevantSubjects = class_subj::join('staff_subj', 'class_subj.subj_id', '=', 'staff_subj.sbj')
                ->where('class_subj.schid', $schid)
                ->where('class_subj.clsid', $clsm)
                ->pluck('sbj');

            // Get subjects the student is registered for
            $studentSubjects = student_subj::where('stid', $user_id)
                ->whereIn('sbj', $relevantSubjects)
                ->pluck('sbj');

            // Get all scores, excluding subjects with zero or null scores
            $allScores = std_score::where('stid', $user_id)
                ->where("schid", $schid)
                ->where("ssn", $ssn)
                ->where("trm", $trm)
                ->where("clsid", $clsm)
                ->whereIn("sbj", $studentSubjects)
                ->whereNotNull('scr')
                ->where('scr', '>', 0)
                ->get();

            // Populate subjects that have scores
            foreach ($allScores as $scr) {
                $sbid = $scr->sbj;
                if (!in_array($sbid, $mySbjs)) {
                    $mySbjs[] = $sbid;
                }
            }

            $subjectScores = [];
            foreach ($mySbjs as $sbid) {
                $subjectScores[$sbid] = [];
            }

            // Assign scores to subjects
            foreach ($allScores as $scr) {
                $sbid = $scr->sbj;
                $subjectScores[$sbid][] = $scr;
            }

            $positions = [];
            foreach ($mySbjs as $sbid) {
                $scores[] = [
                    'sbid' => $sbid,
                    'scores' => $subjectScores[$sbid]
                ];

                // Get subject position, excluding zero/null score subjects
                $subjectPosition = student_sub_res::where('stid', $user_id)
                    ->where('sbj', $sbid)
                    ->where("schid", $schid)
                    ->where("ssn", $ssn)
                    ->where("trm", $trm)
                    ->where("clsm", $clsm)
                    ->where("clsa", $clsa)
                    ->first();

                if ($subjectPosition) {
                    $positions[] = [
                        'sbid' => $sbid,
                        'pos' => $subjectPosition->pos,
                    ];
                }
            }

            // Check for student psychological result
            $psy = student_psy::where([
                ['schid', $schid],
                ['ssn', $ssn],
                ['trm', $trm],
                ['clsm', $clsm],
                ['stid', $user_id]
            ])->exists();

            // Get student result info
            $rinfo = student_res::where("schid", $schid)
                ->where("ssn", $ssn)
                ->where("trm", $trm)
                ->where("clsm", $clsm)
                ->where("stid", $user_id)
                ->when($userType && !in_array($userType, ['a', 's']), function ($q) {
                    $q->where('stat', 1); // enforce published for non-admin/public
                })
                ->first();

            $res = $rinfo ? $rinfo->stat : "0";

            // Get the number of fails (nof) from the result_meta table
            $nof = result_meta::where([
                ['schid', $schid],
                ['ssn', $ssn],
                ['trm', $trm],
            ])->value('num_of_days') ?? 0;

            $presentCountQuery = \DB::table('attendances')
                ->where('schid', $schid)
                ->where('ssn', $ssn)
                ->where('trm', $trm)
                ->where('sid', $std->sid);

            // Check if any attendance exists for this student
            $attendanceExists = (clone $presentCountQuery)->exists();

            if ($attendanceExists) {
                Log::info('Success:' . $attendanceExists . ' yes it is');
                $presentCount = (clone $presentCountQuery)->where('status', 1)->count();
                $absentCount = max(0, $nof - $presentCount);
            } else {
                Log::info('Error: no attendance');
                $presentCount = null;
                $absentCount = null;
            }

            $pld = [
                'std' => $std,
                'sbj' => $mySbjs,  // List of subjects with valid scores
                'scr' => $scores,  // List of scores
                'psy' => $psy,
                'res' => $res,
                'rinfo' => $rinfo,
                'cnt' => $totalStd,
                'num_of_days' => $nof,
                'present_days' => $presentCount,
                'absent_days' => $absentCount,
                'spos' => $positions, // Subject positions
            ];

            return response()->json([
                "status" => true,
                "message" => "Success",
                "pld" => $pld,
            ]);
        } catch (Throwable $e) {
            Log::error($e->getMessage() . "\n" . $e->getTraceAsString());
            return response()->json([
                "status" => false,
                "message" => "Server Error: " . $e->getMessage(),
                "pld" => []
            ], 500);
        }
    }
    /////////////////////////////////////



    /**
     * @OA\Get(
     *     path="/api/getStaffSubjects/{stid}/{sesn}/{trm}",
     *     summary="Get staff subjects by staff ID, session, and term",
     *     description="Fetches subjects assigned to a staff filtered by staff ID, session, and term with pagination support.",
     *     tags={"Api"},
     *      security={{"bearerAuth": {}}},
     *
     *     @OA\Parameter(
     *         name="stid",
     *         in="path",
     *         required=true,
     *         description="Staff ID",
     *         @OA\Schema(type="integer")
     *     ),
     *     @OA\Parameter(
     *         name="sesn",
     *         in="path",
     *         required=true,
     *         description="Academic session (e.g. 2024)",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Parameter(
     *         name="trm",
     *         in="path",
     *         required=true,
     *         description="Term (e.g. 1, 2, or 3)",
     *         @OA\Schema(type="integer")
     *     ),
     *     @OA\Parameter(
     *         name="start",
     *         in="query",
     *         required=false,
     *         description="Offset for pagination (default 0)",
     *         @OA\Schema(type="integer", default=0)
     *     ),
     *     @OA\Parameter(
     *         name="count",
     *         in="query",
     *         required=false,
     *         description="Number of records to return (default 20)",
     *         @OA\Schema(type="integer", default=20)
     *     ),
     *
     *     @OA\Response(
     *         response=200,
     *         description="Successful response",
     *         @OA\JsonContent(
     *             type="object",
     *             @OA\Property(property="status", type="boolean", example=true),
     *             @OA\Property(property="message", type="string", example="Success"),
     *             @OA\Property(
     *                 property="pld",
     *                 type="array",
     *                 @OA\Items(type="object")
     *             )
     *         )
     *     ),
     *     @OA\Response(
     *         response=404,
     *         description="Staff subjects not found"
     *     )
     * )
     */


    public function getStaffSubjects($stid, $sesn, $trm)
    {
        $start = request()->input('start', 0);   // default 0
        $count = request()->input('count', 20);  // default 20

        // Join staff_subj with staff to retrieve staff names
        $pld = staff_subj::where("staff_subj.stid", $stid)
            ->where("staff_subj.sesn", $sesn)
            ->where("staff_subj.trm", $trm)
            ->join("staff", "staff.sid", "=", "staff_subj.stid")
            ->select(
                "staff_subj.*",
                "staff.lname",
                "staff.fname",
                "staff.mname"
            )
            ->skip($start)
            ->take($count)
            ->get();

        return response()->json([
            "status" => true,
            "message" => "Success",
            "pld" => $pld,
        ]);
    }




    /**
     * @OA\Get(
     *     path="/api/deleteStaffSubject/{uid}",
     *     tags={"Api"},
     *     summary="Delete a staff subject",
     *     description="Use this endpoint to delete a staff subject",
     *
     *     @OA\Parameter(
     *         name="uid",
     *         in="path",
     *         required=true,
     *         description="ID of the record",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Response(response="200", description="Success", @OA\JsonContent()),
     *     @OA\Response(response="401", description="Unauthorized"),
     * )
     */
    public function deleteStaffSubject($uid)
    {
        $pld = staff_subj::where('uid', $uid)->delete();
        return response()->json([
            "status" => true,
            "message" => "Success",
            "pld" => $pld,
        ]);
    }

    /**
     * @OA\Post(
     *     path="/api/setStaffClass",
     *     summary="Assign staff to a class and save old staff info",
     *     description="This endpoint assigns a staff member to a class and also saves their information into old_staff with a generated UID.",
     *     operationId="setStaffClass",
     *     tags={"Api"},
     *     security={{"bearerAuth": {}}},
     *
     *     @OA\RequestBody(
     *         required=true,
     *         @OA\JsonContent(
     *             required={"stid","cls","schid","ssn","trm","fname","lname","suid","role","role2"},
     *             @OA\Property(property="stid", type="integer", example=1929, description="Staff ID"),
     *             @OA\Property(property="cls", type="string", example="SS1A", description="Class assigned"),
     *             @OA\Property(property="schid", type="integer", example=12, description="School ID"),
     *             @OA\Property(property="ssn", type="string", example="2024", description="Session"),
     *             @OA\Property(property="trm", type="string", example="1", description="Term"),
     *             @OA\Property(property="fname", type="string", example="John", description="First name of staff"),
     *             @OA\Property(property="lname", type="string", example="Doe", description="Last name of staff"),
     *             @OA\Property(property="mname", type="string", example="Michael", description="Middle name of staff (optional)"),
     *             @OA\Property(property="suid", type="string", example="STF123", description="Staff unique identifier"),
     *             @OA\Property(property="role", type="string", example="Teacher", description="Primary role"),
     *             @OA\Property(property="role2", type="string", example="Class Advisor", description="Secondary role")
     *         )
     *     ),
     *
     *     @OA\Response(
     *         response=200,
     *         description="Success response",
     *         @OA\JsonContent(
     *             @OA\Property(property="status", type="boolean", example=true),
     *             @OA\Property(property="message", type="string", example="Success"),
     *             @OA\Property(
     *                 property="pld",
     *                 type="object",
     *                 @OA\Property(
     *                     property="staff_class",
     *                     type="object",
     *                     description="Saved staff_class data"
     *                 ),
     *                 @OA\Property(
     *                     property="old_staff",
     *                     type="object",
     *                     description="Saved old_staff data"
     *                 )
     *             )
     *         )
     *     ),
     *
     *     @OA\Response(
     *         response=422,
     *         description="Validation error",
     *         @OA\JsonContent(
     *             @OA\Property(property="message", type="string", example="The given data was invalid."),
     *             @OA\Property(
     *                 property="errors",
     *                 type="object",
     *                 example={
     *                     "stid": {"The stid field is required."},
     *                     "cls": {"The cls field is required."}
     *                 }
     *             )
     *         )
     *     )
     * )
     */

    public function setStaffClass(Request $request)
    {
        $request->validate([
            "stid" => "required",
            "cls" => "required",
            "schid" => "required",
            "ssn" => "required",
            "trm" => "required",
            "fname" => "required",
            "lname" => "required",
            "mname" => "nullable",
            "suid" => "required",
            "role" => "required",
            "role2" => "required",
        ]);

        // Deterministic UID
        $uid = $request->ssn . $request->trm . $request->stid . $request->cls;

        // Save staff_class
        $pld = staff_class::updateOrCreate(
            ["uid" => $uid],
            [
                "stid" => $request->stid,
                "cls" => $request->cls,
                "schid" => $request->schid,
                "ssn" => $request->ssn,
                "trm" => $request->trm,
            ]
        );

        //  CHECK FOR DUPLICATES IN old_staff
        $exists = old_staff::where([
            "sid" => $request->stid,
            "ssn" => $request->ssn,
            "trm" => $request->trm,
            "clsm" => $request->cls,
        ])->exists();

        if (!$exists) {

            // INSERT ONLY IF NOT EXISTS
            $old = old_staff::create([
                'uid' => $uid,
                'sid' => $request->stid,
                'schid' => $request->schid,
                'fname' => $request->fname,
                'mname' => $request->mname,
                'lname' => $request->lname,
                'suid' => $request->suid,
                'ssn' => $request->ssn,
                'trm' => $request->trm,
                'clsm' => $request->cls,
                'role' => $request->role,
                'role2' => $request->role2,
                'more' => "",
            ]);

        } else {
            // Do NOT insert
            $old = "Old staff exists already  no insert!";
        }

        return response()->json([
            "status" => true,
            "message" => "Success",
            "pld" => [
                "staff_class" => $pld,
                "old_staff" => $old,
            ]
        ]);
    }




    /**
     * @OA\Get(
     *     path="/api/getStaffClasses/{stid}",
     *     tags={"Api"},
     *     security={{"bearerAuth": {}}},
     *     summary="Retrieve staff classes for a specific staff ID",
     *     description="Fetch staff class records for a given staff ID, with optional filters for session (ssn) and term (trm). Supports pagination with start and count.",
     *
     *     @OA\Parameter(
     *         name="stid",
     *         in="path",
     *         required=true,
     *         description="Staff ID",
     *         @OA\Schema(type="string", example="1929")
     *     ),
     *     @OA\Parameter(
     *         name="ssn",
     *         in="query",
     *         required=false,
     *         description="Filter by academic session",
     *         @OA\Schema(type="string", example="2025")
     *     ),
     *     @OA\Parameter(
     *         name="trm",
     *         in="query",
     *         required=false,
     *         description="Filter by term",
     *         @OA\Schema(type="string", example="2")
     *     ),
     *     @OA\Parameter(
     *         name="start",
     *         in="query",
     *         required=false,
     *         description="Pagination start offset (default 0)",
     *         @OA\Schema(type="integer", example=0)
     *     ),
     *     @OA\Parameter(
     *         name="count",
     *         in="query",
     *         required=false,
     *         description="Number of records to return (default 20)",
     *         @OA\Schema(type="integer", example=10)
     *     ),
     *
     *     @OA\Response(
     *         response=200,
     *         description="Successful response",
     *         @OA\JsonContent(
     *             type="object",
     *             @OA\Property(property="status", type="boolean", example=true),
     *             @OA\Property(property="message", type="string", example="Success"),
     *             @OA\Property(
     *                 property="pld",
     *                 type="array",
     *                 @OA\Items(
     *                     @OA\Property(property="uid", type="string", example="SETSTAFFCLASS52205"),
     *                     @OA\Property(property="stid", type="string", example="1929"),
     *                     @OA\Property(property="cls", type="string", example="11"),
     *                     @OA\Property(property="schid", type="string", example="12"),
     *                     @OA\Property(property="ssn", type="string", example="2025"),
     *                     @OA\Property(property="trm", type="string", example="2"),
     *                     @OA\Property(property="created_at", type="string", format="date-time"),
     *                     @OA\Property(property="updated_at", type="string", format="date-time")
     *                 )
     *             )
     *         )
     *     ),
     *     @OA\Response(
     *         response=400,
     *         description="Invalid request"
     *     )
     * )
     */


    public function getStaffClasses($stid)
    {
        $start = request()->input('start', 0);
        $count = request()->input('count', 20);
        $ssn = request()->input('ssn');
        $trm = request()->input('trm');

        $query = staff_class::query()
            ->join('old_staff', 'staff_class.stid', '=', 'old_staff.sid')
            ->where('staff_class.stid', $stid)
            ->select([
                DB::raw('MAX(staff_class.uid) as uid'), // latest UID
                'staff_class.stid',
                'staff_class.cls',
                'staff_class.schid',
                DB::raw('MAX(staff_class.ssn) as ssn'),
                DB::raw('MAX(staff_class.trm) as trm'),
                'old_staff.fname',
                'old_staff.mname',
                'old_staff.lname',
            ])
            ->groupBy([
                'staff_class.stid',
                'staff_class.cls',
                'staff_class.schid',
                'old_staff.fname',
                'old_staff.mname',
                'old_staff.lname',
            ])
            ->orderBy('ssn', 'desc')
            ->orderBy('trm', 'desc');

        // Apply filters only if provided
        if (!empty($ssn)) {
            $query->where('staff_class.ssn', $ssn);
        }

        if (!empty($trm)) {
            $query->where('staff_class.trm', $trm);
        }

        // Apply pagination
        $pld = $query->skip($start)->take($count)->get();

        // Remove duplicate class entries if any
        $pld = $pld->unique(fn($item) => $item->cls . '-' . $item->ssn)->values();

        return response()->json([
            'status' => true,
            'message' => 'Success',
            'pld' => $pld,
        ]);
    }



    /**
     * @OA\Get(
     *     path="/api/deleteStaffClass/{uid}",
     *     tags={"Api"},
     *     summary="Delete a staff class",
     *     description="Use this endpoint to delete a staff class",
     *
     *     @OA\Parameter(
     *         name="uid",
     *         in="path",
     *         required=true,
     *         description="ID of the record",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Response(response="200", description="Success", @OA\JsonContent()),
     *     @OA\Response(response="401", description="Unauthorized"),
     * )
     */
    public function deleteStaffClass($uid)
    {
        $pld = staff_class::where('uid', $uid)->first();
        $act1 = staff_class_arm::where("stid", $pld->stid)->where("cls", $pld->cls)->delete();
        $act2 = old_staff::where("sid", $pld->stid)->where("clsm", $pld->cls)->delete();
        //TODO Delete subjects too
        $pld->delete();
        return response()->json([
            "status" => true,
            "message" => "Success",
            "pld" => $pld,
        ]);
    }

    /**
     * @OA\Post(
     *     path="/api/setStaffClassArm",
     *     summary="Assign staff to a class arm",
     *     description="Creates or updates the staff class arm assignment for a given session and term.",
     *     tags={"Api"},
     *     security={{"bearerAuth": {}}},
     *
     *     @OA\RequestBody(
     *         required=true,
     *         @OA\JsonContent(
     *             required={"stid","cls","arm","schid","sesn","trm"},
     *             @OA\Property(property="stid", type="integer", example=12, description="Staff ID"),
     *             @OA\Property(property="cls", type="string", example="11", description="Class name"),
     *             @OA\Property(property="arm", type="string", example="1", description="Class arm"),
     *             @OA\Property(property="schid", type="integer", example=101, description="School ID"),
     *             @OA\Property(property="sesn", type="integer", example=2024, description="Academic session"),
     *             @OA\Property(property="trm", type="integer", example=1, description="Term number (1, 2, or 3)")
     *         )
     *     ),
     *
     *     @OA\Response(
     *         response=200,
     *         description="Successful assignment",
     *         @OA\JsonContent(
     *             @OA\Property(property="status", type="boolean", example=true),
     *             @OA\Property(property="message", type="string", example="Success"),
     *             @OA\Property(
     *                 property="pld",
     *                 type="object",
     *                 @OA\Property(property="uid", type="string", example="2024112101234"),
     *                 @OA\Property(property="stid", type="integer", example=12),
     *                 @OA\Property(property="cls", type="string", example="SS1"),
     *                 @OA\Property(property="arm", type="string", example="A"),
     *                 @OA\Property(property="schid", type="integer", example=101),
     *                 @OA\Property(property="sesn", type="integer", example=2024),
     *                 @OA\Property(property="trm", type="integer", example=1)
     *             )
     *         )
     *     ),
     *
     *     @OA\Response(
     *         response=422,
     *         description="Validation error",
     *         @OA\JsonContent(
     *             @OA\Property(property="message", type="string", example="The given data was invalid."),
     *             @OA\Property(
     *                 property="errors",
     *                 type="object",
     *                 @OA\Property(property="stid", type="array", @OA\Items(type="string", example="The stid field is required."))
     *             )
     *         )
     *     )
     * )
     */


    public function setStaffClassArm(Request $request)
    {
        // Data validation
        $request->validate([
            "stid" => "required",
            "cls" => "required",
            "arm" => "required",
            "schid" => "required",
            "sesn" => "required",
            "trm" => "required",
        ]);

        // Generate deterministic UID (no random numbers)
        $uid = $request->sesn . $request->trm . $request->stid . $request->cls . $request->arm;

        // Update or create staff class arm record
        $pld = staff_class_arm::updateOrCreate(
            ["uid" => $uid],
            [
                "stid" => $request->stid,
                "cls" => $request->cls,
                "arm" => $request->arm,
                "schid" => $request->schid,
                "sesn" => $request->sesn,
                "trm" => $request->trm,
            ]
        );

        // Return JSON response
        return response()->json([
            "status" => true,
            "message" => "Success",
            "pld" => $pld
        ]);
    }



    /**
     * @OA\Get(
     *     path="/api/getStaffClassArms/{stid}/{cls}",
     *     summary="Get Staff Class Arms",
     *     description="Fetch class arms assigned to a staff for a given session and term",
     *     tags={"Api"},
     *     security={{"bearerAuth": {}}},
     *
     *     @OA\Parameter(
     *         name="stid",
     *         in="path",
     *         required=true,
     *         description="Staff ID",
     *         @OA\Schema(type="integer", example=1929)
     *     ),
     *     @OA\Parameter(
     *         name="cls",
     *         in="path",
     *         required=true,
     *         description="Class ID",
     *         @OA\Schema(type="integer", example=15)
     *     ),
     *     @OA\Parameter(
     *         name="start",
     *         in="query",
     *         required=false,
     *         description="Pagination start offset",
     *         @OA\Schema(type="integer", example=0)
     *     ),
     *     @OA\Parameter(
     *         name="count",
     *         in="query",
     *         required=false,
     *         description="Number of records to fetch",
     *         @OA\Schema(type="integer", example=20)
     *     ),
     *
     *     @OA\Response(
     *         response=200,
     *         description="Successful response",
     *         @OA\JsonContent(
     *             type="object",
     *             @OA\Property(property="status", type="boolean", example=true),
     *             @OA\Property(property="message", type="string", example="Success"),
     *             @OA\Property(
     *                 property="pld",
     *                 type="array",
     *                 @OA\Items(type="object")
     *             )
     *         )
     *     ),
     *     @OA\Response(
     *         response=400,
     *         description="Invalid input"
     *     )
     * )
     */

    public function getStaffClassArms($stid, $cls)
    {
        $start = 0;
        $count = 20;
        if (request()->has('start') && request()->has('count')) {
            $start = request()->input('start');
            $count = request()->input('count');
        }
        $pld = staff_class_arm::where("stid", $stid)->where("cls", $cls)->skip($start)->take($count)->get();
        return response()->json([
            "status" => true,
            "message" => "Success",
            "pld" => $pld,
        ]);
    }

    /**
     * @OA\Get(
     *     path="/api/getClassArmsByStaffClass/{stid}/{cls}",
     *     tags={"Api"},
     *     security={{"bearerAuth": {}}},
     *     summary="Get a staff's class arms",
     *     description="Use this endpoint to get class arms of a staff.",
     *     @OA\Parameter(
     *         name="stid",
     *         in="path",
     *         required=true,
     *         description="User Id of the staff",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Parameter(
     *         name="cls",
     *         in="path",
     *         required=true,
     *         description="The Class Id",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Response(response="200", description="Success", @OA\JsonContent()),
     *     @OA\Response(response="401", description="Unauthorized"),
     * )
     */
    public function getClassArmsByStaffClass($stid, $cls)
    {
        $arms = staff_class_arm::where("stid", $stid)
            ->where("cls", $cls)
            ->pluck('arm')
            ->map(fn($arm) => (int) $arm); // Ensure the array is of integers
        $pld = sch_cls::whereIn('id', $arms)->get();
        return response()->json([
            "status" => true,
            "message" => "Success",
            "pld" => $pld,
        ]);
    }

    /**
     * @OA\Get(
     *     path="/api/getStaffByClassArms/{schid}/{arm}",
     *     tags={"Api"},
     *     security={{"bearerAuth": {}}},
     *     summary="Get staff by class arms",
     *     description="Use this endpoint to get staff by class arm.",
     *     @OA\Parameter(
     *         name="schid",
     *         in="path",
     *         required=true,
     *         description="School Id of the staff",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Parameter(
     *         name="arm",
     *         in="path",
     *         required=true,
     *         description="The Class Arm Id",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Parameter(
     *         name="start",
     *         in="query",
     *         required=false,
     *         description="Index to start at",
     *         @OA\Schema(type="integer")
     *     ),
     *     @OA\Parameter(
     *         name="count",
     *         in="query",
     *         required=false,
     *         description="No of records to retrieve",
     *         @OA\Schema(type="integer")
     *     ),
     *     @OA\Response(response="200", description="Success", @OA\JsonContent()),
     *     @OA\Response(response="401", description="Unauthorized"),
     * )
     */
    public function getStaffByClassArms($schid, $arm)
    {
        $start = 0;
        $count = 20;
        if (request()->has('start') && request()->has('count')) {
            $start = request()->input('start');
            $count = request()->input('count');
        }
        $pld = staff_class_arm::where("schid", $schid)->where("arm", $arm)->skip($start)->take($count)->get();
        return response()->json([
            "status" => true,
            "message" => "Success",
            "pld" => $pld,
        ]);
    }

    /**
     * @OA\Get(
     *     path="/api/deleteStaffClassArm/{uid}",
     *     tags={"Api"},
     *     summary="Delete a staff class arm",
     *     description="Use this endpoint to delete a staff class arm",
     *
     *     @OA\Parameter(
     *         name="uid",
     *         in="path",
     *         required=true,
     *         description="ID of the record",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Response(response="200", description="Success", @OA\JsonContent()),
     *     @OA\Response(response="401", description="Unauthorized"),
     * )
     */
    public function deleteStaffClassArm($uid)
    {
        $pld = staff_class_arm::where('uid', $uid)->delete();
        return response()->json([
            "status" => true,
            "message" => "Success",
            "pld" => $pld,
        ]);
    }

    /**
     * @OA\Get(
     *     path="/api/getStaffByClassArmAndSubject/{schid}/{arm}/{sbid}",
     *     tags={"Api"},
     *     security={{"bearerAuth": {}}},
     *     summary="Get a staff by class arm and subject",
     *     description="Use this endpoint to get a staff by class arm and subject.",
     *     @OA\Parameter(
     *         name="schid",
     *         in="path",
     *         required=true,
     *         description="School Id of the staff",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Parameter(
     *         name="arm",
     *         in="path",
     *         required=true,
     *         description="The Class Arm Id",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Parameter(
     *         name="sbid",
     *         in="path",
     *         required=true,
     *         description="Subject Id",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Response(response="200", description="Success", @OA\JsonContent()),
     *     @OA\Response(response="401", description="Unauthorized"),
     * )
     */
    public function getStaffByClassArmAndSubject($schid, $arm, $sbid)
    {
        $pld = staff_class_arm::join('staff_subj', 'staff_class_arm.stid', '=', 'staff_subj.stid')
            ->where('staff_class_arm.schid', $schid)
            ->where('staff_class_arm.arm', $arm)
            ->where('staff_subj.sbj', $sbid)
            ->first();
        return response()->json([
            "status" => true,
            "message" => "Success",
            "pld" => $pld,
        ]);
    }

    /**
     * @OA\Post(
     *     path="/api/setOldStaffInfo",
     *     tags={"Api"},
     *     security={{"bearerAuth": {}}},
     *     summary="Create or update old staff info",
     *     description="This endpoint creates or updates old staff information. Uniqueness is enforced using the `uid` field only.",
     *     @OA\RequestBody(
     *         required=true,
     *         @OA\JsonContent(
     *             required={"sid","schid","fname","mname","lname","suid","ssn","trm","clsm","role","role2","more"},
     *             @OA\Property(property="sid", type="string", example="12345"),
     *             @OA\Property(property="schid", type="string", example="6789"),
     *             @OA\Property(property="fname", type="string", example="John"),
     *             @OA\Property(property="mname", type="string", example="Michael"),
     *             @OA\Property(property="lname", type="string", example="Doe"),
     *             @OA\Property(property="suid", type="string", example="STF001"),
     *             @OA\Property(property="ssn", type="string", example="2024"),
     *             @OA\Property(property="trm", type="string", example="1"),
     *             @OA\Property(property="clsm", type="string", example="SS2A"),
     *             @OA\Property(property="role", type="string", example="Class Teacher"),
     *             @OA\Property(property="role2", type="string", example="Exam Officer"),
     *             @OA\Property(property="more", type="string", example="Additional notes or duties"),
     *         )
     *     ),
     *     @OA\Response(
     *         response=200,
     *         description="Old staff info successfully created or updated",
     *         @OA\JsonContent(
     *             @OA\Property(property="status", type="boolean", example=true),
     *             @OA\Property(property="message", type="string", example="Info Updated"),
     *             @OA\Property(
     *                 property="pld",
     *                 type="object",
     *                 description="The created/updated staff record",
     *                 @OA\Property(property="uid", type="string", example="202411234512345"),
     *                 @OA\Property(property="sid", type="string", example="12345"),
     *                 @OA\Property(property="schid", type="string", example="6789"),
     *                 @OA\Property(property="fname", type="string", example="John"),
     *                 @OA\Property(property="mname", type="string", example="Michael"),
     *                 @OA\Property(property="lname", type="string", example="Doe"),
     *                 @OA\Property(property="suid", type="string", example="STF001"),
     *                 @OA\Property(property="ssn", type="string", example="2024"),
     *                 @OA\Property(property="trm", type="string", example="1"),
     *                 @OA\Property(property="clsm", type="string", example="SS2A"),
     *                 @OA\Property(property="role", type="string", example="Class Teacher"),
     *                 @OA\Property(property="role2", type="string", example="Exam Officer"),
     *                 @OA\Property(property="more", type="string", example="Additional notes or duties"),
     *             )
     *         )
     *     ),
     *     @OA\Response(
     *         response=422,
     *         description="Validation error",
     *         @OA\JsonContent(
     *             @OA\Property(property="message", type="string", example="The given data was invalid."),
     *             @OA\Property(property="errors", type="object")
     *         )
     *     )
     * )
     */


    public function setOldStaffInfo(Request $request)
    {
        // Data validation
        $request->validate([
            "sid" => "required",
            "schid" => "required",
            "fname" => "required",
            "mname" => "required",
            "lname" => "required",
            "suid" => "required",
            "ssn" => "required",
            "trm" => "required",
            "clsm" => "required",
            "role" => "required",
            "role2" => "required",
            "more" => "required",
        ]);

        // Generate deterministic UID (no random numbers)
        $uid = $request->ssn . $request->trm . $request->sid . $request->clsm;

        // Update or create record based only on uid
        $pld = old_staff::updateOrCreate(
            ["uid" => $uid],  // uniqueness check is ONLY on uid
            [
                "sid" => $request->sid,
                "schid" => $request->schid,
                "fname" => $request->fname,
                "mname" => $request->mname,
                "lname" => $request->lname,
                "suid" => $request->suid,
                "ssn" => $request->ssn,
                "trm" => $request->trm,
                "clsm" => $request->clsm,
                "role" => $request->role,
                "role2" => $request->role2,
                "more" => $request->more,
            ]
        );

        return response()->json([
            "status" => true,
            "message" => "Info Updated",
            "pld" => $pld
        ]);
    }


    /**
     * @OA\Get(
     *     path="/api/getOldStaff/{schid}/{ssn}/{trm}/{clsm}/{role}",
     *     tags={"Api"},
     *     security={{"bearerAuth": {}}},
     *     summary="Get an old staff's Basic Info",
     *     description="Use this endpoint to get basic information about an old staff.",
     *     @OA\Parameter(
     *         name="schid",
     *         in="path",
     *         required=true,
     *         description="Id of the school",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Parameter(
     *         name="ssn",
     *         in="path",
     *         required=true,
     *         description="Id of the session",
     *         @OA\Schema(type="string")
     *     ),
     *       @OA\Parameter(
     *         name="trm",
     *         in="path",
     *         required=true,
     *         description="Id of the term",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Parameter(
     *         name="clsm",
     *         in="path",
     *         required=true,
     *         description="Id of the main class",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Parameter(
     *         name="role",
     *         in="path",
     *         required=true,
     *         description="Role Id of the staff",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Response(response="200", description="Success", @OA\JsonContent()),
     *     @OA\Response(response="401", description="Unauthorized"),
     * )
     */


    public function getOldStaff($schid, $ssn, $trm, $clsm, $role)
    {
        $query = DB::table('old_staff')
            ->where('old_staff.schid', $schid)
            ->where('old_staff.ssn', $ssn)
            ->where('old_staff.trm', $trm)
            ->where('old_staff.status', 'active')
            ->where('old_staff.clsm', $clsm);

        // Clean "*" when filtering
        if ($role != '-1') {
            $query->where(function ($q) use ($role) {
                $q->whereRaw("REPLACE(old_staff.role, '*', '') = ?", [$role])
                    ->orWhereRaw("REPLACE(old_staff.role2, '*', '') = ?", [$role]);
            });
        }

        // Join to get role names
        $pld = $query
            ->leftJoin('staff_role as r1', DB::raw("REPLACE(old_staff.role, '*', '')"), '=', 'r1.id')
            ->leftJoin('staff_role as r2', DB::raw("REPLACE(old_staff.role2, '*', '')"), '=', 'r2.id')
            ->select(
                'old_staff.*',
                'r1.name as role_name',
                'r2.name as role2_name'
            )
            ->get();

        return response()->json([
            "status" => true,
            "message" => "Success",
            "pld" => $pld,
        ]);
    }


    /**
     * @OA\Get(
     *     path="/api/getOldStaffStat/{schid}/{ssn}/{trm}/{clsm}/{role}",
     *     tags={"Api"},
     *     security={{"bearerAuth": {}}},
     *     summary="Get an old staff's stats",
     *     description="Use this endpoint to get stats information about an old staff.",
     *     @OA\Parameter(
     *         name="schid",
     *         in="path",
     *         required=true,
     *         description="Id of the school",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Parameter(
     *         name="ssn",
     *         in="path",
     *         required=true,
     *         description="Id of the session",
     *         @OA\Schema(type="string")
     *     ),
     *      @OA\Parameter(
     *         name="trm",
     *         in="path",
     *         required=true,
     *         description="Id of the trm",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Parameter(
     *         name="clsm",
     *         in="path",
     *         required=true,
     *         description="Id of the main class",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Parameter(
     *         name="role",
     *         in="path",
     *         required=true,
     *         description="Role Id of the staff",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Response(response="200", description="Success", @OA\JsonContent()),
     *     @OA\Response(response="401", description="Unauthorized"),
     * )
     */
    public function getOldStaffStat($schid, $ssn, $trm, $clsm, $role)
    {
        $male = 0;
        $female = 0;

        if ($role == '-1') {
            // No role filter
            $male = old_staff::join('staff_basic_data', 'old_staff.sid', '=', 'staff_basic_data.user_id')
                ->where('old_staff.schid', $schid)
                ->where('old_staff.ssn', $ssn)
                ->where('old_staff.trm', $trm)
                ->where('old_staff.status', 'active')
                ->where('old_staff.clsm', $clsm)
                ->where('staff_basic_data.sex', 'M')
                ->count();

            $female = old_staff::join('staff_basic_data', 'old_staff.sid', '=', 'staff_basic_data.user_id')
                ->where('old_staff.schid', $schid)
                ->where('old_staff.ssn', $ssn)
                ->where('old_staff.trm', $trm)
                ->where('old_staff.status', 'active')
                ->where('old_staff.clsm', $clsm)
                ->where('staff_basic_data.sex', 'F')
                ->count();
        } else {
            // Clean "*" before comparing roles
            $male = old_staff::join('staff_basic_data', 'old_staff.sid', '=', 'staff_basic_data.user_id')
                ->where('old_staff.schid', $schid)
                ->where('old_staff.ssn', $ssn)
                ->where('old_staff.trm', $trm)
                ->where('old_staff.status', 'active')
                ->where('old_staff.clsm', $clsm)
                ->where(function ($query) use ($role) {
                    $query->whereRaw("REPLACE(old_staff.role, '*', '') = ?", [$role])
                        ->orWhereRaw("REPLACE(old_staff.role2, '*', '') = ?", [$role]);
                })
                ->where('staff_basic_data.sex', 'M')
                ->count();

            $female = old_staff::join('staff_basic_data', 'old_staff.sid', '=', 'staff_basic_data.user_id')
                ->where('old_staff.schid', $schid)
                ->where('old_staff.ssn', $ssn)
                ->where('old_staff.trm', $trm)
                ->where('old_staff.status', 'active')
                ->where('old_staff.clsm', $clsm)
                ->where(function ($query) use ($role) {
                    $query->whereRaw("REPLACE(old_staff.role, '*', '') = ?", [$role])
                        ->orWhereRaw("REPLACE(old_staff.role2, '*', '') = ?", [$role]);
                })
                ->where('staff_basic_data.sex', 'F')
                ->count();
        }

        return response()->json([
            "status" => true,
            "message" => "Success",
            "pld" => [
                "male" => $male,
                "female" => $female,
            ]
        ]);
    }


    /**
     * @OA\Get(
     *     path="/api/getOldStaffInfo/{uid}",
     *     tags={"Api"},
     *     security={{"bearerAuth": {}}},
     *     summary="Get an old staff's Basic Info",
     *     description="Use this endpoint to get basic information about an old staff.",
     *     @OA\Parameter(
     *         name="uid",
     *         in="path",
     *         required=true,
     *         description="uid of the record",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Response(response="200", description="Success", @OA\JsonContent()),
     *     @OA\Response(response="401", description="Unauthorized"),
     * )
     */
    public function getOldStaffInfo($uid)
    {
        $pld = old_staff::where("uid", $uid)->first();
        return response()->json([
            "status" => true,
            "message" => "Success",
            "pld" => $pld,
        ]);
    }



    //---messaging


    /**
     * @OA\Get(
     *     path="/api/searchMsgThread",
     *     tags={"Api"},
     *     summary="Full text search on subjects",
     *     description=" Use this endpoint for Full text search on message subjects",
     *     security={{"bearerAuth": {}}},
     *     @OA\Parameter(
     *         name="search",
     *         in="query",
     *         required=true,
     *         description="Search term",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Response(response="200", description="Success", @OA\JsonContent()),
     *     @OA\Response(response="401", description="Unauthorized"),
     * )
     */
    public function searchMsgThread()
    {
        $search = null;
        if (request()->has('search')) {
            $search = request()->input('search');
        }
        if ($search) {
            $pld = msgthread::whereRaw("MATCH(subject) AGAINST(? IN BOOLEAN MODE)", [$search])
                ->orderByRaw("MATCH(subject) AGAINST(? IN BOOLEAN MODE) DESC", [$search])
                ->take(2)
                ->get();
            return response()->json([
                "status" => true,
                "message" => "Success",
                "pld" => $pld
            ]);
        }
        return response()->json([
            "status" => false,
            "message" => "The Search param is required"
        ]);
    }



    /**
     * @OA\Get(
     *     path="/api/getMyMessagesStat/{uid}",
     *     tags={"Api"},
     *     summary="Get Message Count by UID",
     *     description="Use this endpoint to get messages count for this `uid`",
     *     security={{"bearerAuth": {}}},
     *     @OA\Parameter(
     *         name="uid",
     *         in="path",
     *         required=true,
     *         description="User ID",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Response(response="200", description="Success", @OA\JsonContent()),
     *     @OA\Response(response="401", description="Unauthorized"),
     * )
     */
    public function getMyMessagesStat($uid)
    {
        $totalMessages = msgthread::where('from_uid', $uid)->orWhere('to_uid', $uid)->count();
        return response()->json([
            "status" => true,
            "message" => "Success",
            "pld" => [
                "totalMessages" => $totalMessages,
            ],
        ]);
    }


    /**
     * @OA\Get(
     *     path="/api/getMyMessages/{uid}",
     *     tags={"Api"},
     *     summary="Get Message Threads by UID",
     *     description="Use this endpoint to get messages Threads for this `uid`",
     *     security={{"bearerAuth": {}}},
     *     @OA\Parameter(
     *         name="uid",
     *         in="path",
     *         required=true,
     *         description="User ID",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Parameter(
     *         name="start",
     *         in="query",
     *         required=false,
     *         description="Index to start at",
     *         @OA\Schema(type="integer")
     *     ),
     *     @OA\Parameter(
     *         name="count",
     *         in="query",
     *         required=false,
     *         description="No of records to retrieve",
     *         @OA\Schema(type="integer")
     *     ),
     *     @OA\Response(response="200", description="Success", @OA\JsonContent()),
     *     @OA\Response(response="401", description="Unauthorized"),
     * )
     */
    public function getMyMessages($uid)
    {
        $start = 0;
        $count = 20;
        if (request()->has('start') && request()->has('count')) {
            $start = request()->input('start');
            $count = request()->input('count');
        }
        $pld = msgthread::where('from_uid', $uid)->orWhere('to_uid', $uid)
            ->orderBy('updated_at', 'desc')->skip($start)->take($count)->get();
        return response()->json([
            "status" => true,
            "message" => "Success",
            "pld" => $pld,
        ]);
    }

    /**
     * @OA\Get(
     *     path="/api/getMessageThread/{tid}",
     *     tags={"Api"},
     *     summary="Get Messages by thread id",
     *     description="Use this endpoint to get messages for this `tid`",
     *     security={{"bearerAuth": {}}},
     *     @OA\Parameter(
     *         name="tid",
     *         in="path",
     *         required=true,
     *         description="Thread ID",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Parameter(
     *         name="start",
     *         in="query",
     *         required=false,
     *         description="Index to start at",
     *         @OA\Schema(type="integer")
     *     ),
     *     @OA\Parameter(
     *         name="count",
     *         in="query",
     *         required=false,
     *         description="No of records to retrieve",
     *         @OA\Schema(type="integer")
     *     ),
     *     @OA\Response(response="200", description="Success", @OA\JsonContent()),
     *     @OA\Response(response="401", description="Unauthorized"),
     * )
     */
    public function getMessageThread($tid)
    {
        $start = 0;
        $count = 20;
        if (request()->has('start') && request()->has('count')) {
            $start = request()->input('start');
            $count = request()->input('count');
        }
        $pld = msg::where('tid', $tid)->skip($start)->take($count)->get();
        return response()->json([
            "status" => true,
            "message" => "Success",
            "pld" => $pld,
        ]);
    }

    /**
     * @OA\Post(
     *     path="/api/createMsgThread",
     *     tags={"Api"},
     *     summary="Create a new message thread",
     *     description="Use this endpoint to create a new message thread.",
     *     security={{"bearerAuth": {}}},
     *     @OA\RequestBody(
     *         required=true,
     *         @OA\JsonContent(
     *             type="object",
     *             @OA\Property(property="from", type="string", description="Name of the person sending"),
     *             @OA\Property(property="from_uid", type="string", description="User ID of the person sending"),
     *             @OA\Property(property="to", type="string", description="Name of the person receiving"),
     *             @OA\Property(property="to_uid", type="string", description="User ID of the person receiving"),
     *             @OA\Property(property="subject", type="string", description="Message Subject"),
     *             @OA\Property(property="from_mail", type="string", description=",,"),
     *             @OA\Property(property="to_mail", type="string", description=",,"),
     *             @OA\Property(property="last_msg", type="string", description="Last Message (First in this case) - Shown in preview"),
     *         )
     *     ),
     *     @OA\Response(response="200", description="Success"),
     *     @OA\Response(response="401", description="Unauthorized"),
     * )
     */
    public function createMsgThread(Request $request)
    {
        $request->validate([
            "from" => "required",
            "from_uid" => "required",
            "to" => "required",
            "to_uid" => "required",
            "last_msg" => "required",
            "subject" => "required",
            "from_mail" => "required",
            "to_mail" => "required"
        ]);
        $mt = msgthread::create([
            "from" => $request->from,
            "from_uid" => $request->from_uid,
            "to" => $request->to,
            "to_uid" => $request->to_uid,
            "last_msg" => $request->last_msg,
            "subject" => $request->subject,
            "from_mail" => $request->from_mail,
            "to_mail" => $request->to_mail,
        ]);
        return response()->json([
            "status" => true,
            "message" => "Success",
            "pld" => $mt
        ]);
    }

    /**
     * @OA\Post(
     *     path="/api/sendMsg",
     *     tags={"Api"},
     *     summary="Send a message",
     *     description="Use this endpoint to send a chat. You may also notify by mail",
     *     security={{"bearerAuth": {}}},
     *     @OA\RequestBody(
     *         required=true,
     *         @OA\JsonContent(
     *             type="object",
     *             @OA\Property(property="body", type="string", description="Message content"),
     *             @OA\Property(property="who", type="string", description="User ID of the person sending"),
     *             @OA\Property(property="tid", type="string", description="Thread ID of the message"),
     *             @OA\Property(property="mail", type="string", description="If not empty, user will be mailed"),
     *             @OA\Property(property="art", type="string", description="Document ID"),
     *         )
     *     ),
     *     @OA\Response(response="200", description="Success"),
     *     @OA\Response(response="401", description="Unauthorized"),
     * )
     */
    public function sendMsg(Request $request)
    {
        $request->validate([
            "body" => "required",
            "who" => "required",
            "tid" => "required",
            "mail" => "required",
            "art" => "required",
        ]);
        $trd = msgthread::where('id', intval($request->tid))->first();
        if ($trd) {
            $ms = msg::create([
                "tid" => $request->tid,
                "body" => $request->body,
                "who" => $request->who,
                "art" => $request->art,
            ]);
            $trd->update([
                "last_msg" => $request->body,
            ]);
            if ($request->mail != '') {
                $isPerson1 = $request->who == $trd->from_uid;
                $from = null;
                $to = null;
                if ($isPerson1) {
                    $from = $trd->from;
                    $to = $trd->to;
                } else {
                    $from = $trd->to;
                    $to = $trd->from;
                }
                // Wrap the email sending logic in a try-catch block
                try {
                    $data = [
                        'name' => $from . ' -> ' . $to,
                        'subject' => $trd->subject,
                        'body' => $request->body,
                        'link' => $request->art != '_' ? env('API_URL') . '/getFile/msg/' . $request->art : env('PORTAL_URL')
                    ];

                    Mail::to($request->mail)->send(new SSSMails($data));
                } catch (\Exception $e) {
                    // Log the email error, but don't stop the process
                    Log::error('Failed to send email: ' . $e->getMessage());
                }

                return response()->json([
                    "status" => true,
                    "message" => "Success (User was also mailed)",
                    "pld" => $ms
                ]);
            }
            // Respond
            return response()->json([
                "status" => true,
                "message" => "Success",
                "pld" => $ms
            ]);
        }
        return response()->json([
            "status" => false,
            "message" => "Thread not found"
        ]);
    }




    //--- FILE UPLOAD

    /**
     * @OA\Post(
     *     path="/api/uploadFile",
     *     tags={"File"},
     *     security={{"bearerAuth": {}}},
     *     summary="Upload a file",
     *     @OA\RequestBody(
     *         required=true,
     *         @OA\MediaType(
     *             mediaType="multipart/form-data",
     *             @OA\Schema(
     *                 type="object",
     *                 @OA\Property(
     *                     property="file",
     *                     type="string",
     *                     format="binary"
     *                 ),
     *                 @OA\Property(
     *                     property="filename",
     *                     type="string"
     *                 ),
     *                 @OA\Property(
     *                     property="folder",
     *                     type="string"
     *                 ),
     *                 @OA\Property(
     *                     property="user_id",
     *                     type="string"
     *                 ),
     *                 required={"file", "filename", "folder", "user_id"}
     *             )
     *         )
     *     ),
     *     @OA\Response(response="200", description="Success"),
     *     @OA\Response(response="401", description="Unauthorized"),
     * )
     */



    public function uploadFile(Request $request)
    {
        $request->validate([
            'file' => 'required', //|mimes:jpeg,png,jpg,gif,svg|max:2048
            'filename' => 'required',
            'folder' => 'required',
            'user_id' => 'required',
        ]);
        if ($request->hasFile('file')) {
            $file = $request->file('file');
            $filename = $request->filename;
            $folder = $request->folder;
            if (!Storage::disk('public')->exists($folder)) {
                // If it doesn't exist, create the directory
                Storage::disk('public')->makeDirectory($folder);
            }
            Storage::disk('public')->put($folder . '/' . $filename, file_get_contents($file));
            // Log It
            files::create([
                'user_id' => $request->user_id,
                'file' => $filename,
                'folder' => $folder,
            ]);
            return response()->json([
                "status" => true,
                "message" => "Success"
            ]);
        } else {
            return response()->json([
                "status" => false,
                "message" => "No file provided"
            ]);
        }
    }


    /**
     * @OA\Get(
     *     path="/api/getFiles/{user_id}",
     *     tags={"File"},
     *     summary="Get all Files belonging to a user ",
     *     description="API: Use this endpoint to get all files by a user",
     *     security={{"bearerAuth": {}}},
     *     @OA\Parameter(
     *         name="user_id",
     *         in="path",
     *         required=true,
     *         description="user ID",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Response(
     *          response="200",
     *          description="Success",
     *      ),
     *     @OA\Response(response="401", description="Unauthorized"),
     * )
     */
    public function getFiles($uid)
    {
        $pld = files::where('user_id', $uid)->get();
        // Respond
        return response()->json([
            "status" => true,
            "message" => "Success",
            "pld" => $pld,
        ]);
    }

    /**
     * @OA\Get(
     *     path="/api/getFile/{folder}/{filename}",
     *     tags={"Unprotected"},
     *     summary="Get File",
     *     description="API: Use this endpoint to get a file by providing the folder and filename as path parameters.",
     *     @OA\Parameter(
     *         name="folder",
     *         in="path",
     *         required=true,
     *         description="Name of the folder",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Parameter(
     *         name="filename",
     *         in="path",
     *         required=true,
     *         description="Name of the file",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Response(
     *          response="200",
     *          description="Success",
     *          @OA\MediaType(
     *              mediaType="application/octet-stream",
     *              @OA\Schema(type="file")
     *          )
     *      ),
     *     @OA\Response(response="401", description="Unauthorized"),
     *     @OA\Response(response="404", description="File not found"),
     * )
     */
    public function getFile($folder, $filename)
    {
        if (Storage::disk('public')->exists($folder . '/' . $filename)) {
            return response()->file(Storage::disk('public')->path($folder . '/' . $filename));
        } else {
            return response()->json([
                "status" => false,
                "message" => "File not found",
            ], 404);
        }
    }




    /**
     * @OA\Get(
     *     path="/api/fileExists/{folder}/{filename}",
     *     tags={"File"},
     *     summary="Check if File Exists",
     *     description="API: Use this endpoint to check if a file exists by providing the folder and filename as path parameters.",
     *     security={{"bearerAuth": {}}},
     *     @OA\Parameter(
     *         name="folder",
     *         in="path",
     *         required=true,
     *         description="Name of the folder",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Parameter(
     *         name="filename",
     *         in="path",
     *         required=true,
     *         description="Name of the file",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Response(response="200", description="Success", @OA\JsonContent()),
     *     @OA\Response(response="401", description="Unauthorized"),
     * )
     */
    public function fileExists($folder, $filename)
    {
        if (Storage::disk('public')->exists($folder . '/' . $filename)) {
            return response()->json([
                "status" => true,
                "message" => "Yes, it does",
            ]);
        } else {
            return response()->json([
                "status" => false,
                "message" => "File not found",
            ]);
        }
    }






    //------------------------- PAYMENT

    /**
     * @OA\Get(
     *     path="/api/resolveAccountNumber",
     *     tags={"General"},
     *     summary="Validate an account Number using paystack",
     *     description="Validate an account Number using paystack",
     *     security={{"bearerAuth": {}}},
     *     @OA\Parameter(
     *         name="anum",
     *         in="path",
     *         required=true,
     *         description="Account Number",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Parameter(
     *         name="bnk",
     *         in="path",
     *         required=true,
     *         description="Bank Code",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Response(response="200", description="Success", @OA\JsonContent()),
     *     @OA\Response(response="401", description="Unauthorized"),
     * )
     */
    public function resolveAccountNumber($anum, $bnk)
    {
        $response = Http::withHeaders([
            'Authorization' => 'Bearer ' . env('PAYSTACK_SECRET'),
        ])->get('https://api.paystack.co/bank/resolve', [
                    'account_number' => $anum,
                    'bank_code' => $bnk,
                ]);

        if ($response->successful()) {
            $data = $response->json();
            // Output or use the resolved data
            return response()->json([
                "status" => true,
                "message" => "Success",
                "pld" => $data
            ]);
        } else {
            // Handle error
            $error = $response->body();
            return response()->json([
                "status" => false,
                "message" => "Failed",
                "pld" => $error
            ], 400);
        }
    }

    /**
     * @OA\Post(
     *     path="/api/setPayRecord",
     *     tags={"Payments"},
     *     summary="Record a payment",
     *     security={{"bearerAuth": {}}},
     *     @OA\RequestBody(
     *         required=true,
     *         @OA\JsonContent(
     *             type="object",
     *             @OA\Property(property="sid", type="string", example="123"),
     *             @OA\Property(property="rid", type="string", example="456"),
     *             @OA\Property(property="sname", type="string", example="John Doe"),
     *             @OA\Property(property="amt", type="integer", example="1500"),
     *             @OA\Property(property="time", type="integer", example=1625097600000),
     *             @OA\Property(property="ref", type="string", example="ABC123XYZ"),
     *             @OA\Property(property="typ", type="string", example="1"),
     *             @OA\Property(property="pid", type="string", example="10"),
     *         )
     *     ),
     *     @OA\Response(
     *         response=200,
     *         description="Payment Recorded",
     *         @OA\JsonContent(
     *             type="object",
     *             @OA\Property(property="status", type="boolean", example=true),
     *             @OA\Property(property="message", type="string", example="Payment Recorded")
     *         )
     *     ),
     *     @OA\Response(
     *         response=400,
     *         description="Validation Error",
     *         @OA\JsonContent(
     *             type="object",
     *             @OA\Property(property="status", type="boolean", example=false),
     *             @OA\Property(property="message", type="string", example="Validation Error")
     *         )
     *     )
     * )
     */
    public function setPayRecord(Request $request)
    {
        $request->validate([
            'sid' => 'required',
            'rid' => 'required',
            'sname' => 'required',
            'amt' => 'required',
            'time' => 'required',
            'ref' => 'required',
            'typ' => 'required',
            'pid' => 'required',
        ]);
        pay::create([
            'sid' => $request->sid,
            'rid' => $request->rid,
            'sname' => $request->sname,
            'amt' => $request->amt,
            'time' => $request->time,
            'ref' => $request->ref,
            'typ' => $request->typ,
            'pid' => $request->pid,
        ]);
        return response()->json([
            "status" => true,
            "message" => "Payment Recorded"
        ]);
    }

    /**
     * @OA\Get(
     *     path="/api/getPaysByReceiver/{uid}",
     *     tags={"Payments"},
     *     summary="Get Payment records by Receiver",
     *     description="Use this endpoint to get Payment records by Receiver",
     *     security={{"bearerAuth": {}}},
     *     @OA\Parameter(
     *         name="rid",
     *         in="path",
     *         required=true,
     *         description="User ID of the receiver",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Parameter(
     *         name="start",
     *         in="query",
     *         required=false,
     *         description="Index to start at",
     *         @OA\Schema(type="integer")
     *     ),
     *     @OA\Parameter(
     *         name="count",
     *         in="query",
     *         required=false,
     *         description="No of records to retrieve",
     *         @OA\Schema(type="integer")
     *     ),
     *     @OA\Response(response="200", description="Success", @OA\JsonContent()),
     *     @OA\Response(response="401", description="Unauthorized"),
     * )
     */
    public function getPaysByReceiver($rid)
    {
        $start = 0;
        $count = 20;
        if (request()->has('start') && request()->has('count')) {
            $start = request()->input('start');
            $count = request()->input('count');
        }
        $pld = pay::where('rid', $rid)->skip($start)->take($count)->get();
        // Respond
        return response()->json([
            "status" => true,
            "message" => "Success",
            "pld" => $pld,
        ]);
    }

    /**
     * @OA\Get(
     *     path="/api/getPaysBySender/{sid}",
     *     tags={"Payments"},
     *     summary="Get Payment records by Sender",
     *     description="Use this endpoint to get Payment records by Sender",
     *     security={{"bearerAuth": {}}},
     *     @OA\Parameter(
     *         name="sid",
     *         in="path",
     *         required=true,
     *         description="User ID of the sender",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Parameter(
     *         name="start",
     *         in="query",
     *         required=false,
     *         description="Index to start at",
     *         @OA\Schema(type="integer")
     *     ),
     *     @OA\Parameter(
     *         name="count",
     *         in="query",
     *         required=false,
     *         description="No of records to retrieve",
     *         @OA\Schema(type="integer")
     *     ),
     *     @OA\Response(response="200", description="Success", @OA\JsonContent()),
     *     @OA\Response(response="401", description="Unauthorized"),
     * )
     */
    public function getPaysBySender($sid)
    {
        $start = 0;
        $count = 20;
        if (request()->has('start') && request()->has('count')) {
            $start = request()->input('start');
            $count = request()->input('count');
        }
        $pld = pay::where('sid', $sid)->skip($start)->take($count)->get();
        // Respond
        return response()->json([
            "status" => true,
            "message" => "Success",
            "pld" => $pld,
        ]);
    }

    /**
     * @OA\Get(
     *     path="/api/getPaysBySenderAndReceiver/{sid}/{rid}",
     *     tags={"Payments"},
     *     summary="Get Payment records by Sender And Receiver",
     *     description="Use this endpoint to get Payment records by Sender And Receiver",
     *     security={{"bearerAuth": {}}},
     *     @OA\Parameter(
     *         name="sid",
     *         in="path",
     *         required=true,
     *         description="User ID of the sender",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Parameter(
     *         name="rid",
     *         in="path",
     *         required=true,
     *         description="User ID of the receiver",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Parameter(
     *         name="start",
     *         in="query",
     *         required=false,
     *         description="Index to start at",
     *         @OA\Schema(type="integer")
     *     ),
     *     @OA\Parameter(
     *         name="count",
     *         in="query",
     *         required=false,
     *         description="No of records to retrieve",
     *         @OA\Schema(type="integer")
     *     ),
     *     @OA\Response(response="200", description="Success", @OA\JsonContent()),
     *     @OA\Response(response="401", description="Unauthorized"),
     * )
     */
    public function getPaysBySenderAndReceiver($sid, $rid)
    {
        $start = 0;
        $count = 20;
        if (request()->has('start') && request()->has('count')) {
            $start = request()->input('start');
            $count = request()->input('count');
        }
        $pld = pay::where('rid', $rid)->where('sid', $sid)->skip($start)->take($count)->get();
        // Respond
        return response()->json([
            "status" => true,
            "message" => "Success",
            "pld" => $pld,
        ]);
    }

    /**
     * @OA\Get(
     *     path="/api/getPaymentStat/{schid}/{clsid}/{ssnid}/{trmid}",
     *     tags={"Api"},
     *     summary="Get how many payments are available",
     *     description="Use this endpoint to get ow many payments are available",
     *
     *     @OA\Parameter(
     *         name="schid",
     *         in="path",
     *         required=true,
     *         description="School ID",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Parameter(
     *         name="clsid",
     *         in="path",
     *         required=true,
     *         description="Class ID",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Parameter(
     *         name="ssnid",
     *         in="path",
     *         required=true,
     *         description="Session ID",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Parameter(
     *         name="trmid",
     *         in="path",
     *         required=true,
     *         description="Term ID",
     *         @OA\Schema(type="string")
     *     ),
     *
     *     @OA\Response(response="200", description="Success", @OA\JsonContent()),
     *     @OA\Response(response="401", description="Unauthorized"),
     * )
     */
    public function getPaymentStat($schid, $clsid, $ssnid, $trmid)
    {
        $query = payments::query();

        if ($schid !== "-1") {
            $query->where('schid', $schid);
        }

        if ($clsid !== "-1") {
            $query->where('clsid', $clsid);
        }

        if ($ssnid !== "-1") {
            $query->where('ssnid', $ssnid);
        }

        if ($trmid !== "-1") {
            $query->where('trmid', $trmid);
        }

        $total = $query->count();

        return response()->json([
            "status" => true,
            "message" => "Success",
            "pld" => [
                "total" => $total,
            ],
        ]);
    }

    /**
     * @OA\Get(
     *     path="/api/getPayments/{schid}/{clsid}/{ssnid}/{trmid}",
     *     tags={"Payments"},
     *     security={{"bearerAuth": {}}},
     *     summary="Get Payments by School",
     *     description="Use this endpoint to get Payments by School",
     *
     *     @OA\Parameter(
     *         name="schid",
     *         in="path",
     *         required=true,
     *         description="School ID",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Parameter(
     *         name="clsid",
     *         in="path",
     *         required=true,
     *         description="Class ID",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Parameter(
     *         name="ssnid",
     *         in="path",
     *         required=true,
     *         description="Session ID",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Parameter(
     *         name="trmid",
     *         in="path",
     *         required=true,
     *         description="Term ID",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Parameter(
     *         name="start",
     *         in="query",
     *         required=false,
     *         description="Index to start at",
     *         @OA\Schema(type="integer")
     *     ),
     *     @OA\Parameter(
     *         name="count",
     *         in="query",
     *         required=false,
     *         description="No of records to retrieve",
     *         @OA\Schema(type="integer")
     *     ),
     *     @OA\Response(response="200", description="Success", @OA\JsonContent()),
     *     @OA\Response(response="401", description="Unauthorized"),
     * )
     */


    public function getPayments($schid, $clsid, $ssnid, $trmid)
    {
        $start = 0;
        $count = 20;

        if (request()->has('start') && request()->has('count')) {
            $start = request()->input('start');
            $count = request()->input('count');
        }

        $query = payments::query();

        if ($schid !== "-1") {
            $query->where('schid', $schid);
        }

        if ($clsid !== "-1") {
            $query->where('clsid', $clsid);
        }

        if ($ssnid !== "-1") {
            $query->where('ssnid', $ssnid);
        }

        if ($trmid !== "-1") {
            $query->where('trmid', $trmid);
        }

        // Clone query to get total amount
        $totalAmount = (clone $query)->sum('amt');

        // Get paginated payment data
        $pld = $query->skip($start)->take($count)->get();

        // Check if there are any payments that match the query
        $paymentsExist = (clone $query)->exists();

        $paidStudentsCount = 0;
        $notPaidStudentsCount = 0;

        if ($paymentsExist) {
            $paidStudentsCount = student::where('schid', $schid)
                ->whereExists(function ($subQuery) use ($schid, $ssnid, $trmid) {
                    $subQuery->select(DB::raw(1))
                        ->from('payments')
                        ->whereColumn('payments.stid', 'student.sid')
                        ->where('payments.schid', $schid)
                        ->where('payments.ssnid', $ssnid)
                        ->where('payments.trmid', $trmid);
                })
                ->count();

            $notPaidStudentsCount = student::where('schid', $schid)
                ->whereNotExists(function ($subQuery) use ($schid, $ssnid, $trmid) {
                    $subQuery->select(DB::raw(1))
                        ->from('payments')
                        ->whereColumn('payments.stid', 'student.sid')
                        ->where('payments.schid', $schid)
                        ->where('payments.ssnid', $ssnid)
                        ->where('payments.trmid', $trmid);
                })
                ->count();
        }

        // Return structured JSON response
        return response()->json([
            "status" => true,
            "message" => "Success",
            "total_revenue_amount" => $totalAmount,
            "paid_students_count" => $paidStudentsCount,
            "not_paid_students_count" => $notPaidStudentsCount,
            "pld" => $pld,
        ]);
    }


    /**
     * @OA\Get(
     *     path="/api/getStudentPayments/{stid}",
     *     tags={"Payments"},
     *     security={{"bearerAuth": {}}},
     *     summary="get a student payments",
     *     description="Use this endpoint to get payments by a student",
     *     @OA\Parameter(
     *         name="stid",
     *         in="path",
     *         required=true,
     *         description="Student ID",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Parameter(
     *         name="start",
     *         in="query",
     *         required=false,
     *         description="Index to start at",
     *         @OA\Schema(type="integer")
     *     ),
     *     @OA\Parameter(
     *         name="count",
     *         in="query",
     *         required=false,
     *         description="No of records to retrieve",
     *         @OA\Schema(type="integer")
     *     ),
     *     @OA\Response(response="200", description="Success", @OA\JsonContent()),
     *     @OA\Response(response="401", description="Unauthorized"),
     * )
     */


    public function getStudentPayments($stid)
    {
        try {
            // Get latest record where total_split_amount is NOT NULL
            $latestNonNull = payments::where('stid', $stid)
                ->whereNotNull('total_split_amount')
                ->latest()
                ->first();

            // Get all records where total_split_amount IS NULL
            $nullRecords = payments::where('stid', $stid)
                ->whereNull('total_split_amount')
                ->orderByDesc('created_at')
                ->get();

            // Combine them into one payload
            $pld = collect();

            if ($latestNonNull) {
                $pld->push($latestNonNull);
            }

            if ($nullRecords->isNotEmpty()) {
                $pld = $pld->merge($nullRecords);
            }

            // Return response with everything inside `pld`
            return response()->json([
                "status" => true,
                "message" => "Success",
                "pld" => $pld,
            ]);
        } catch (\Exception $e) {
            Log::error('Error fetching student payments: ' . $e->getMessage());
            return response()->json([
                "status" => false,
                "message" => "Failed to fetch records",
                "error" => $e->getMessage(),
            ], 500);
        }
    }


    /**
     * @OA\Get(
     *     path="/api/getStudentPaymentStat/{stid}",
     *     tags={"Payments"},
     *      security={{"bearerAuth": {}}},
     *     summary="get stats for student payments",
     *     description="Use this endpoint to get stats for payments by a student",
     *     @OA\Parameter(
     *         name="stid",
     *         in="path",
     *         required=true,
     *         description="Student ID",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Response(response="200", description="Success", @OA\JsonContent()),
     *     @OA\Response(response="401", description="Unauthorized"),
     * )
     */
    public function getStudentPaymentStat($stid)
    {
        $total = payments::where('stid', $stid)->count();
        // Respond
        return response()->json([
            "status" => true,
            "message" => "Success",
            "pld" => [
                "total" => $total
            ],
        ]);
    }

    /**
     * @OA\Get(
     *     path="/api/confirmPayment/{schid}/{clsid}/{ssnid}/{trmid}/{stid}",
     *     tags={"Payments"},
     *     security={{"bearerAuth": {}}},
     *     summary="Returns null if no payment",
     *     description="Use this endpoint to confirm payment",
     *
     *     @OA\Parameter(
     *         name="schid",
     *         in="path",
     *         required=true,
     *         description="School ID",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Parameter(
     *         name="clsid",
     *         in="path",
     *         required=true,
     *         description="Class ID",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Parameter(
     *         name="ssnid",
     *         in="path",
     *         required=true,
     *         description="Session ID",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Parameter(
     *         name="trmid",
     *         in="path",
     *         required=true,
     *         description="Term ID",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Parameter(
     *         name="stid",
     *         in="path",
     *         required=true,
     *         description="Student ID",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Response(response="200", description="Success", @OA\JsonContent()),
     *     @OA\Response(response="401", description="Unauthorized"),
     * )
     */


    public function confirmPayment($schid, $clsid, $ssnid, $trmid, $stid)
    {
        $pld = payments::where('schid', $schid)
            ->where('clsid', $clsid)
            ->where('ssnid', $ssnid)
            ->where('trmid', $trmid)
            ->where('stid', $stid)
            ->orderBy('created_at', 'desc') //  get the latest by creation time
            ->first();

        return response()->json([
            "status" => true,
            "message" => "Success",
            "pld" => $pld,
        ]);
    }


    /**
     * @OA\Get(
     *     path="/api/confirmAcceptancePayment/{schid}/{clsid}/{stid}",
     *     tags={"Payments"},
     *     summary="Returns null if no payment",
     *     description="Use this endpoint to confirm payment of acceptance fee",
     *
     *     @OA\Parameter(
     *         name="schid",
     *         in="path",
     *         required=true,
     *         description="School ID",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Parameter(
     *         name="clsid",
     *         in="path",
     *         required=true,
     *         description="Class ID",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Parameter(
     *         name="stid",
     *         in="path",
     *         required=true,
     *         description="Student ID",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Response(response="200", description="Success", @OA\JsonContent()),
     *     @OA\Response(response="401", description="Unauthorized"),
     * )
     */
    public function confirmAcceptancePayment($schid, $clsid, $stid)
    {
        $pld = afeerec::where('schid', $schid)->where('clsid', $clsid)->where('stid', $stid)->first();
        // Respond
        return response()->json([
            "status" => true,
            "message" => "Success",
            "pld" => $pld,
        ]);
    }

    /**
     * @OA\Post(
     *     path="/api/setAFeeRecord",
     *     tags={"Payments"},
     *     summary="Record an acceptance fee payment",
     *     security={{"bearerAuth": {}}},
     *     @OA\RequestBody(
     *         required=true,
     *         @OA\JsonContent(
     *             type="object",
     *             @OA\Property(property="stid", type="string", example="123"),
     *             @OA\Property(property="schid", type="string", example="456"),
     *             @OA\Property(property="clsid", type="string", example="11"),
     *             @OA\Property(property="ssn", type="string", example="2025"),
     *             @OA\Property(property="trm", type="string", example="1"),
     *             @OA\Property(property="amt", type="integer", example="1500"),
     *         )
     *     ),
     *     @OA\Response(
     *         response=200,
     *         description="Payment Recorded",
     *         @OA\JsonContent(
     *             type="object",
     *             @OA\Property(property="status", type="boolean", example=true),
     *             @OA\Property(property="message", type="string", example="Payment Recorded")
     *         )
     *     ),
     *     @OA\Response(
     *         response=400,
     *         description="Validation Error",
     *         @OA\JsonContent(
     *             type="object",
     *             @OA\Property(property="status", type="boolean", example=false),
     *             @OA\Property(property="message", type="string", example="Validation Error")
     *         )
     *     )
     * )
     */
    public function setAFeeRecord(Request $request)
    {
        $request->validate([
            'stid' => 'required',
            'schid' => 'required',
            'clsid' => 'required',
            'amt' => 'required',
            'ssn' => 'required',
            'trm' => 'required',
        ]);
        $stid = $request->stid;
        $schid = $request->schid;
        $clsid = $request->clsid;
        $amt = $request->amt;
        $ssn = $request->ssn;
        $trm = $request->trm;
        $uid = $stid . $schid . $clsid;
        afeerec::updateOrCreate(
            ["uid" => $uid,],
            [
                "stid" => $stid,
                "schid" => $schid,
                "clsid" => $clsid,
                "ssn" => $ssn,
                "trm" => $trm,
                "amt" => $amt,
            ]
        );
        return response()->json([
            "status" => true,
            "message" => "Payment Recorded"
        ]);
    }

    /**
     * @OA\Get(
     *     path="/api/getAcceptancePaymentStat/{schid}/{clsid}",
     *     tags={"Api"},
     *     security={{"bearerAuth": {}}},
     *     summary="Get Acceptance Fee Payment Statistics",
     *     description="Retrieve total count and total amount of acceptance fee payments with optional session and term filters.",
     *
     *     @OA\Parameter(
     *         name="schid",
     *         in="path",
     *         required=true,
     *         description="School ID",
     *         @OA\Schema(type="integer")
     *     ),
     *     @OA\Parameter(
     *         name="clsid",
     *         in="path",
     *         required=true,
     *         description="Class ID",
     *         @OA\Schema(type="integer")
     *     ),
     *
     *     @OA\Parameter(
     *         name="ssn",
     *         in="query",
     *         required=false,
     *         description="Session (e.g., 2025)",
     *         @OA\Schema(type="string", example="2025")
     *     ),
     *
     *     @OA\Parameter(
     *         name="trm",
     *         in="query",
     *         required=false,
     *         description="Term (1, 2, or 3)",
     *         @OA\Schema(type="integer", example=1)
     *     ),
     *
     *     @OA\Response(
     *         response=200,
     *         description="Success",
     *         @OA\JsonContent(
     *             @OA\Property(property="status", type="boolean", example=true),
     *             @OA\Property(property="message", type="string", example="Success"),
     *             @OA\Property(
     *                 property="pld",
     *                 type="object",
     *                 @OA\Property(property="total", type="integer", example=150),
     *                 @OA\Property(property="totalAmt", type="number", example=450000)
     *             )
     *         )
     *     ),
     *
     *     @OA\Response(response=401, description="Unauthorized")
     * )
     */

    public function getAcceptancePaymentStat(Request $request, $schid, $clsid)
    {
        // Optional filters
        $ssn = $request->input('ssn', null);
        $trm = $request->input('trm', null);

        // Base query
        $query = afeerec::where('schid', $schid)->where('clsid', $clsid);

        // Apply optional filters
        if (!is_null($ssn)) {
            $query->where('ssn', $ssn); // same pattern as getAcctAccept()
        }

        if (!is_null($trm)) {
            $query->where('trm', $trm); // same pattern as getAcctAccept()
        }

        // Count & Sum
        $total = $query->count();
        $totalAmt = $query->sum('amt');

        return response()->json([
            "status" => true,
            "message" => "Success",
            "pld" => [
                "total" => $total,
                "totalAmt" => $totalAmt,
            ],
        ]);
    }


    /**
     * @OA\Get(
     *     path="/api/getAcceptancePayments/{schid}/{clsid}",
     *     tags={"Payments"},
     *    security={{"bearerAuth": {}}},
     *     summary="Get Acceptance Fee Payments by School and Class",
     *     description="Retrieve acceptance fee payment records filtered by school, class, session, and term.",
     *
     *     @OA\Parameter(
     *         name="schid",
     *         in="path",
     *         required=true,
     *         description="School ID",
     *         @OA\Schema(type="integer")
     *     ),
     *     @OA\Parameter(
     *         name="clsid",
     *         in="path",
     *         required=true,
     *         description="Class ID",
     *         @OA\Schema(type="integer")
     *     ),
     *     @OA\Parameter(
     *         name="start",
     *         in="query",
     *         required=false,
     *         description="Index to start retrieving records (pagination)",
     *         @OA\Schema(type="integer", default=0)
     *     ),
     *     @OA\Parameter(
     *         name="count",
     *         in="query",
     *         required=false,
     *         description="Number of records to retrieve (pagination)",
     *         @OA\Schema(type="integer", default=20)
     *     ),
     *     @OA\Parameter(
     *         name="ssn",
     *         in="query",
     *         required=false,
     *         description="Session filter (e.g. 2024, 2025)",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Parameter(
     *         name="trm",
     *         in="query",
     *         required=false,
     *         description="Term filter (e.g. 1, 2, 3)",
     *         @OA\Schema(type="string")
     *     ),
     *
     *     @OA\Response(
     *         response=200,
     *         description="Success",
     *         @OA\JsonContent(
     *             @OA\Property(property="status", type="boolean", example=true),
     *             @OA\Property(property="message", type="string", example="Success"),
     *             @OA\Property(
     *                 property="pld",
     *                 type="array",
     *                 @OA\Items(type="object")
     *             )
     *         )
     *     ),
     *
     *     @OA\Response(
     *         response=401,
     *         description="Unauthorized"
     *     )
     * )
     */


    public function getAcceptancePayments(Request $request, $schid, $clsid)
    {
        // Pagination
        $start = $request->input('start', 0);
        $count = $request->input('count', 20);

        // Optional filters
        $ssn = $request->input('ssn', null);
        $trm = $request->input('trm', null);

        // Base query
        $query = afeerec::where('schid', $schid)->where('clsid', $clsid);

        // Apply optional filters
        if (!is_null($ssn)) {
            $query->where('ssn', $ssn);
        }

        if (!is_null($trm)) {
            $query->where('trm', $trm);
        }

        // Pagination
        $pld = $query->skip($start)->take($count)->get();

        // Response
        return response()->json([
            "status" => true,
            "message" => "Success",
            "pld" => $pld,
        ]);
    }


    /**
     * @OA\Get(
     *     path="/api/getRegFeePaymentStat/{schid}/{rfee}",
     *     tags={"Payments"},
     *     summary="Get Registration Fee Payment Statistics by School",
     *     description="Retrieve the total numbers of registration fee payments for a school, with optional session (ssn) and term (trm) filters.",
     *     security={{"bearerAuth": {}}},
     *
     *     @OA\Parameter(
     *         name="schid",
     *         in="path",
     *         required=true,
     *         description="School ID",
     *         @OA\Schema(type="integer")
     *     ),
     *     @OA\Parameter(
     *         name="rfee",
     *         in="path",
     *         required=true,
     *         description="Registration Fee status (0 = Not Paid, 1 = Paid)",
     *         @OA\Schema(type="integer")
     *     ),
     *     @OA\Parameter(
     *         name="ssn",
     *         in="query",
     *         required=false,
     *         description="Session/Academic Year (e.g., 2025)",
     *         @OA\Schema(type="string", example="2025")
     *     ),
     *     @OA\Parameter(
     *         name="trm",
     *         in="query",
     *         required=false,
     *         description="Term (1, 2, or 3)",
     *         @OA\Schema(type="integer", example=1)
     *     ),
     *
     *     @OA\Response(
     *         response=200,
     *         description="Success",
     *         @OA\JsonContent(
     *             @OA\Property(property="status", type="boolean", example=true),
     *             @OA\Property(property="message", type="string", example="Success"),
     *             @OA\Property(
     *                 property="pld",
     *                 type="object",
     *                 @OA\Property(property="total", type="integer", example=120)
     *             )
     *         )
     *     ),
     *     @OA\Response(response=401, description="Unauthorized")
     * )
     */


    public function getRegFeePaymentStat(Request $request, $schid, $rfee)
    {
        // Optional filters
        $ssn = $request->input('ssn', null);
        $trm = $request->input('trm', null);

        // Base query
        $query = student::where('schid', $schid)->where('rfee', $rfee);

        // Apply optional filters
        if (!is_null($ssn)) {
            $query->where('year', $ssn); // assuming 'year' column holds session
        }

        if (!is_null($trm)) {
            $query->where('term', $trm); // assuming 'term' column
        }

        // Count the records
        $total = $query->count();

        return response()->json([
            "status" => true,
            "message" => "Success",
            "pld" => [
                "total" => $total,
            ],
        ]);
    }


    /**
     * @OA\Get(
     *     path="/api/getRegFeePayments/{schid}/{rfee}",
     *     tags={"Payments"},
     *     security={{"bearerAuth": {}}},
     *     summary="Get Registration Fee Payments by School",
     *     description="Retrieve registration fee payment records for a school with optional session (year) and term filters.",
     *
     *     @OA\Parameter(
     *         name="schid",
     *         in="path",
     *         required=true,
     *         description="School ID",
     *         @OA\Schema(type="integer")
     *     ),
     *
     *     @OA\Parameter(
     *         name="rfee",
     *         in="path",
     *         required=true,
     *         description="Registration Fee Status (0 = Not Paid, 1 = Paid)",
     *         @OA\Schema(type="integer")
     *     ),
     *
     *     @OA\Parameter(
     *         name="start",
     *         in="query",
     *         required=false,
     *         description="Start index for pagination",
     *         @OA\Schema(type="integer", example=0)
     *     ),
     *
     *     @OA\Parameter(
     *         name="count",
     *         in="query",
     *         required=false,
     *         description="Number of records to retrieve",
     *         @OA\Schema(type="integer", example=20)
     *     ),
     *
     *     @OA\Parameter(
     *         name="ssn",
     *         in="query",
     *         required=false,
     *         description="Session (stored as `year` in database). Example: 2025",
     *         @OA\Schema(type="string", example="2025")
     *     ),
     *
     *     @OA\Parameter(
     *         name="trm",
     *         in="query",
     *         required=false,
     *         description="Term (stored as `term` in database). Example: 1",
     *         @OA\Schema(type="integer", example=1)
     *     ),
     *
     *     @OA\Response(
     *         response=200,
     *         description="Success",
     *         @OA\JsonContent(
     *             @OA\Property(property="status", type="boolean", example=true),
     *             @OA\Property(property="message", type="string", example="Success"),
     *             @OA\Property(
     *                 property="pld",
     *                 type="array",
     *                 @OA\Items(
     *                     type="object",
     *                     example={
     *                         "sid": 100,
     *                         "fname": "John",
     *                         "lname": "Doe",
     *                         "year": 2025,
     *                         "term": 1,
     *                         "rfee": 1
     *                     }
     *                 )
     *             )
     *         )
     *     ),
     *
     *     @OA\Response(
     *         response=401,
     *         description="Unauthorized"
     *     )
     * )
     */

    public function getRegFeePayments(Request $request, $schid, $rfee)
    {
        // Pagination
        $start = $request->input('start', 0);
        $count = $request->input('count', 20);

        // Optional filters
        $ssn = $request->input('ssn', null);
        $trm = $request->input('trm', null);

        // Base query
        $query = student::where('schid', $schid)->where('rfee', $rfee);

        // Apply optional filters
        if (!is_null($ssn)) {
            $query->where('year', $ssn); // FIXED
        }

        if (!is_null($trm)) {
            $query->where('term', $trm); // FIXED
        }

        // Pagination
        $pld = $query->skip($start)->take($count)->get();

        return response()->json([
            "status" => true,
            "message" => "Success",
            "pld" => $pld,
        ]);
    }


    /**
     * @OA\Post(
     *     path="/api/setAcctPref",
     *     tags={"Payments"},
     *     summary="Set Acct Preference (0= By class, 1 = By payment heading)",
     *     security={{"bearerAuth": {}}},
     *     @OA\RequestBody(
     *         required=true,
     *         @OA\JsonContent(
     *             type="object",
     *             @OA\Property(property="sid", type="string", example="123"),
     *             @OA\Property(property="pref", type="string", example="456"),
     *             @OA\Property(property="ssn", type="string", example="2025"),
     *             @OA\Property(property="trm", type="integer", example="1"),
     *         )
     *     ),
     *     @OA\Response(
     *         response=200,
     *         description="Preference Recorded",
     *         @OA\JsonContent(
     *             type="object",
     *             @OA\Property(property="status", type="boolean", example=true),
     *             @OA\Property(property="message", type="string", example="Payment Recorded")
     *         )
     *     ),
     *     @OA\Response(
     *         response=400,
     *         description="Validation Error",
     *         @OA\JsonContent(
     *             type="object",
     *             @OA\Property(property="status", type="boolean", example=false),
     *             @OA\Property(property="message", type="string", example="Validation Error")
     *         )
     *     )
     * )
     */
    public function setAcctPref(Request $request)
    {
        $request->validate([
            'sid' => 'required',
            'pref' => 'required',
            'ssn' => 'required',
            'trm' => 'required',
        ]);

        acct_pref::updateOrCreate(
            [
                "sid" => $request->sid,
                "ssn" => $request->ssn,
                "trm" => $request->trm,
            ],
            [
                "pref" => $request->pref
            ]
        );

        return response()->json([
            "status" => true,
            "message" => "Preference Recorded"
        ]);
    }

    /**
     * @OA\Get(
     *     path="/api/getAcctPref/{schid}/{ssn}/{trm}",
     *     tags={"Api"},
     * security={{"bearerAuth": {}}},
     *     summary="Get preference for account number",
     *     description="Use this endpoint to get preference settings for account numbers.",
     *
     *     @OA\Parameter(
     *         name="schid",
     *         in="path",
     *         required=true,
     *         description="School ID",
     *         @OA\Schema(type="string", example="12")
     *     ),
     *     @OA\Parameter(
     *         name="ssn",
     *         in="path",
     *         required=true,
     *         description="Session ID",
     *         @OA\Schema(type="string", example="2025")
     *     ),
     *     @OA\Parameter(
     *         name="trm",
     *         in="path",
     *         required=true,
     *         description="Term ID",
     *         @OA\Schema(type="string", example="1")
     *     ),
     *
     *     @OA\Response(
     *         response=200,
     *         description="Success",
     *         @OA\JsonContent()
     *     ),
     *
     *     @OA\Response(
     *         response=401,
     *         description="Unauthorized"
     *     )
     * )
     */
    public function getAcctPref($schid, $ssn, $trm)
    {
        $pld = acct_pref::where('sid', $schid)
            ->where('ssn', $ssn)
            ->where('trm', $trm)
            ->first();

        return response()->json([
            "status" => true,
            "message" => "Success",
            "pld" => $pld,
        ]);
    }




    /**
     * @OA\Post(
     *     path="/api/setAccount",
     *     summary="Create or Update an Account with Paystack Subaccount",
     *     description="Creates a new account and registers a Paystack subaccount. If 'id' is provided, it updates an existing account.",
     *     operationId="setAccount",
     *     security={{"bearerAuth": {}}},
     *     tags={"Accounts"},
     *
     *     @OA\RequestBody(
     *         required=true,
     *         @OA\JsonContent(
     *             required={"schid", "clsid", "ssnid", "trmid", "anum", "bnk", "aname"},
     *             @OA\Property(property="schid", type="integer", example=1, description="School ID"),
     *             @OA\Property(property="clsid", type="integer", example=10, description="Class ID"),
     *             @OA\Property(property="anum", type="string", example="1234567890", description="Account Number"),
     *             @OA\Property(property="bnk", type="string", example="058", description="Bank Code (e.g., GTBank: 058)"),
     *             @OA\Property(property="aname", type="string", example="John Doe", description="Account Holder Name"),
     *             @OA\Property(property="id", type="integer", example=5, description="(Optional) ID for updating an existing account")
     *         )
     *     ),
     *
     *     @OA\Response(
     *         response=200,
     *         description="Success Response",
     *         @OA\JsonContent(
     *             oneOf={
     *                 @OA\Schema(
     *                     @OA\Property(property="status", type="boolean", example=true),
     *                     @OA\Property(property="message", type="string", example="Account Updated")
     *                 ),
     *                 @OA\Schema(
     *                     @OA\Property(property="status", type="boolean", example=true),
     *                     @OA\Property(property="message", type="string", example="Account and Paystack Subaccount Created Successfully"),
     *                     @OA\Property(property="paystack_data", type="object",
     *                         @OA\Property(property="subaccount_code", type="string", example="SUB_ACCT_ABC123"),
     *                         @OA\Property(property="business_name", type="string", example="Business_65f9b0d4"),
     *                         @OA\Property(property="settlement_bank", type="string", example="058"),
     *                         @OA\Property(property="percentage_charge", type="number", example=0)
     *                     )
     *                 )
     *             }
     *         )
     *     ),
     *
     *     @OA\Response(
     *         response=400,
     *         description="Failed to Create Paystack Subaccount",
     *         @OA\JsonContent(
     *             @OA\Property(property="status", type="boolean", example=false),
     *             @OA\Property(property="message", type="string", example="Failed to Create Paystack Subaccount"),
     *             @OA\Property(property="error", type="object", example={"status": false, "message": "Invalid Bank Code", "type": "validation_error"})
     *         )
     *     ),
     *
     *     @OA\Response(
     *         response=404,
     *         description="Account Not Found (When updating an account with an invalid ID)",
     *         @OA\JsonContent(
     *             @OA\Property(property="status", type="boolean", example=false),
     *             @OA\Property(property="message", type="string", example="Account Not Found")
     *         )
     *     ),
     *
     *     @OA\Response(
     *         response=422,
     *         description="Validation Error",
     *         @OA\JsonContent(
     *             @OA\Property(property="status", type="boolean", example=false),
     *             @OA\Property(property="message", type="string", example="Validation Error"),
     *             @OA\Property(property="errors", type="object",
     *                 @OA\Property(property="anum", type="array", @OA\Items(type="string", example="The account number field is required.")),
     *                 @OA\Property(property="bnk", type="array", @OA\Items(type="string", example="The bank code field is required."))
     *             )
     *         )
     *     )
     * )
     */


    // public function setAcct(Request $request)
    // {
    //     $request->validate([
    //         'schid' => 'required',
    //         'clsid' => 'required',
    //         'anum' => 'required',
    //         'bnk' => 'required',
    //         'aname' => 'required',
    //         'ssn' => 'required',
    //         'trm' => 'required',
    //         'pay_head_id' => 'nullable',
    //     ]);

    //     $data = [
    //         'schid' => $request->schid,
    //         'clsid' => $request->clsid,
    //         'anum' => $request->anum,
    //         'bnk' => $request->bnk,
    //         'aname' => $request->aname,
    //         'ssn' => $request->ssn,
    //         'trm' => $request->trm,
    //         'pay_head_id' => $request->pay_head_id ?? null,
    //     ];

    //     // If updating existing account
    //     if ($request->has('id')) {
    //         $acct = accts::find($request->id);
    //         if ($acct) {
    //             $acct->update($data);
    //             return response()->json([
    //                 "status" => true,
    //                 "message" => "Account Updated",
    //             ]);
    //         } else {
    //             return response()->json([
    //                 "status" => false,
    //                 "message" => "Account Not Found",
    //             ], 404);
    //         }
    //     }

    //     // Check if this schid & clsid already has a subaccount
    //     $existingSubAcct = sub_account::where('schid', $request->schid)
    //         ->where('clsid', $request->clsid)
    //         ->where('ssn', $request->ssn)
    //         ->where('trm', $request->trm)
    //         ->where('pay_head_id', $request->pay_head_id)
    //         ->first();

    //     if ($existingSubAcct) {
    //         return response()->json([
    //             "status" => false,
    //             "message" => "A subaccount already exists for this school and class.",
    //         ], 409);
    //     }

    //     // Create main account
    //     $acct = accts::create($data);

    //     // Generate Paystack-required fields
    //     $business_name = "Business_" . uniqid();
    //     $percentage_charge = 0;
    //     $settlement_bank = $request->bnk;

    //     // Step 1: Create Paystack subaccount
    //     $response = Http::withHeaders([
    //         'Authorization' => 'Bearer ' . env('PAYSTACK_SECRET'),
    //         'Content-Type' => 'application/json',
    //     ])->post('https://api.paystack.co/subaccount', [
    //                 'business_name' => $business_name,
    //                 'account_number' => $request->anum,
    //                 'bank_code' => $request->bnk,
    //                 'percentage_charge' => $percentage_charge,
    //                 'settlement_bank' => $settlement_bank,
    //             ]);

    //     if ($response->successful()) {
    //         $data = $response->json();

    //         // Step 2: Store subaccount details
    //         sub_account::create([
    //             'acct_id' => $acct->id,
    //             'schid' => $request->schid,
    //             'clsid' => $request->clsid,
    //             'ssn' => $request->ssn,
    //             'trm' => $request->trm,
    //             'pay_head_id' => $request->pay_head_id ?? null,
    //             'subaccount_code' => $data['data']['subaccount_code'],
    //             'percentage_charge' => $percentage_charge,
    //         ]);

    //         return response()->json([
    //             "status" => true,
    //             "message" => "Account and Paystack Subaccount Created Successfully",
    //             "paystack_data" => $data,
    //         ]);
    //     } else {
    //         // Rollback main account creation if Paystack fails
    //         $acct->delete();

    //         return response()->json([
    //             "status" => false,
    //             "message" => "Failed to Create Paystack Subaccount",
    //             "error" => $response->body(),
    //         ], 400);
    //     }
    // }


    public function setAcct(Request $request)
    {
        $request->validate([
            'schid' => 'required',
            'clsid' => 'required',
            'anum' => 'required',
            'bnk' => 'required',
            'aname' => 'required',
            'ssn' => 'required',
            'trm' => 'required',
            'pay_head_id' => 'nullable',
        ]);

        $data = [
            'schid' => $request->schid,
            'clsid' => $request->clsid,
            'anum' => $request->anum,
            'bnk' => $request->bnk,
            'aname' => $request->aname,
            'ssn' => $request->ssn,
            'trm' => $request->trm,
            'pay_head_id' => $request->pay_head_id ?? null,
        ];

        /*
        |--------------------------------------------------------------------------
        | DUPLICATE CHECK (clsid + pay_head_id)
        |--------------------------------------------------------------------------
        */
        $dupQuery = accts::where('clsid', $request->clsid)
            ->where('pay_head_id', $request->pay_head_id);

        // If updating, ignore the current record
        if ($request->has('id')) {
            $dupQuery->where('id', '!=', $request->id);
        }

        if ($dupQuery->exists()) {
            return response()->json([
                'status' => false,
                'message' => 'This pay head has already been assigned to this class.'
            ], 409);
        }

        /*
        |--------------------------------------------------------------------------
        | UPDATE MODE
        |--------------------------------------------------------------------------
        */
        if ($request->has('id')) {
            $acct = accts::find($request->id);

            if (!$acct) {
                return response()->json([
                    'status' => false,
                    'message' => 'Account Not Found'
                ], 404);
            }

            $acct->update($data);

            return response()->json([
                'status' => true,
                'message' => 'Account Updated Successfully'
            ]);
        }

        /*
        |--------------------------------------------------------------------------
        | CREATE MAIN ACCOUNT
        |--------------------------------------------------------------------------
        */
        $acct = accts::create($data);

        /*
        |--------------------------------------------------------------------------
        | CREATE PAYSTACK SUBACCOUNT
        |--------------------------------------------------------------------------
        */
        $response = Http::withHeaders([
            'Authorization' => 'Bearer ' . env('PAYSTACK_SECRET'),
            'Content-Type' => 'application/json',
        ])->post('https://api.paystack.co/subaccount', [
                    'business_name' => 'Business_' . uniqid(),
                    'account_number' => $request->anum,
                    'bank_code' => $request->bnk,
                    'percentage_charge' => 0,
                    'settlement_bank' => $request->bnk,
                ]);

        if (!$response->successful()) {
            $acct->delete();

            return response()->json([
                'status' => false,
                'message' => 'Failed to Create Paystack Subaccount',
                'error' => $response->body(),
            ], 400);
        }

        $paystack = $response->json();

        sub_account::create([
            'acct_id' => $acct->id,
            'schid' => $request->schid,
            'clsid' => $request->clsid,
            'ssn' => $request->ssn,
            'trm' => $request->trm,
            'pay_head_id' => $request->pay_head_id ?? null,
            'subaccount_code' => $paystack['data']['subaccount_code'],
            'percentage_charge' => 0,
        ]);

        return response()->json([
            'status' => true,
            'message' => 'Account and Paystack Subaccount Created Successfully',
            'paystack_data' => $paystack,
        ]);
    }





    /**
     * @OA\Get(
     *     path="/api/getSubAccount/{acctid}",
     *     summary="Fetch or create a subaccount for a given account ID",
     *     description="Retrieves the subaccount details for the given account ID. If a subaccount does not exist, a new one is created using Paystack API.",
     *     tags={"Accounts"},
     * security={{"bearerAuth": {}}},
     *     @OA\Parameter(
     *         name="acctid",
     *         in="path",
     *         required=true,
     *         description="Account ID to fetch the subaccount for",
     *         @OA\Schema(type="integer")
     *     ),
     *     @OA\Response(
     *         response=200,
     *         description="Subaccount retrieved successfully",
     *         @OA\JsonContent(
     *             type="object",
     *             @OA\Property(property="status", type="boolean", example=true),
     *             @OA\Property(property="message", type="string", example="Subaccount retrieved successfully"),
     *             @OA\Property(
     *                 property="subaccount",
     *                 type="object",
     *                 @OA\Property(property="acct_id", type="integer", example=123),
     *                 @OA\Property(property="schid", type="integer", example=456),
     *                 @OA\Property(property="clsid", type="integer", example=789),
     *                 @OA\Property(property="subaccount_code", type="string", example="SUB_ABC123XYZ"),
     *                 @OA\Property(property="percentage_charge", type="number", example=0)
     *             )
     *         )
     *     ),
     *     @OA\Response(
     *         response=404,
     *         description="Account not found",
     *         @OA\JsonContent(
     *             type="object",
     *             @OA\Property(property="status", type="boolean", example=false),
     *             @OA\Property(property="message", type="string", example="Account not found")
     *         )
     *     ),
     *     @OA\Response(
     *         response=400,
     *         description="Failed to create subaccount",
     *         @OA\JsonContent(
     *             type="object",
     *             @OA\Property(property="status", type="boolean", example=false),
     *             @OA\Property(property="message", type="string", example="Failed to create subaccount"),
     *             @OA\Property(property="error", type="string", example="Invalid bank details")
     *         )
     *     )
     * )
     */


    public function getSubAccount($acctid)
    {
        // Step 1: Fetch the existing subaccount linked to the account
        $subaccount = sub_account::where('acct_id', $acctid)->first();

        if (!$subaccount) {
            // Step 2: Check if the account exists
            $account = accts::where('id', $acctid)->first();

            if (!$account) {
                return response()->json([
                    "status" => false,
                    "message" => "Account not found",
                ], 404);
            }

            // Step 3: Generate unique business name
            $business_name = "Business_" . uniqid();

            // Step 4: Prepare subaccount data for Paystack
            $percentage_charge = 0;
            $subaccountData = [
                'business_name' => $business_name,
                'account_number' => $account->anum,
                'bank_code' => $account->bnk,
                'percentage_charge' => $percentage_charge,
                'settlement_bank' => $account->bnk,
            ];

            // Step 5: Create Paystack subaccount
            $response = Http::withHeaders([
                'Authorization' => 'Bearer ' . env('PAYSTACK_SECRET'),
                'Content-Type' => 'application/json',
            ])->post('https://api.paystack.co/subaccount', $subaccountData);

            if ($response->successful()) {
                $data = $response->json();

                // Step 6: Store subaccount details in the database
                $subaccount = sub_account::create([
                    'acct_id' => $account->id,
                    'schid' => $account->schid,
                    'clsid' => $account->clsid,
                    'ssn' => $account->ssn,
                    'trm' => $account->trm,
                    'pay_head_id' => $account->pay_head_id,
                    'subaccount_code' => $data['data']['subaccount_code'],
                    'percentage_charge' => $percentage_charge,
                ]);
            } else {
                return response()->json([
                    "status" => false,
                    "message" => "Failed to create subaccount",
                    "error" => $response->json()['message'] ?? 'Unknown error',
                ], 400);
            }
        }

        // Step 7: Fetch related data (account and class)
        $account = accts::find($subaccount->acct_id);
        $class = DB::table('cls')->where('id', $subaccount->clsid)->first();

        // Step 8: Combine all data
        $responseData = [
            "id" => $subaccount->id,
            "acct_id" => $subaccount->acct_id,
            "schid" => $subaccount->schid,
            "clsid" => $subaccount->clsid,
            "subaccount_code" => $subaccount->subaccount_code,
            "percentage_charge" => $subaccount->percentage_charge,
            "pay_head_id" => $subaccount->pay_head_id,
            "account_name" => $account->aname ?? null,
            "account_number" => $account->anum ?? null,
            "class_name" => $class->name ?? null,
            "bank_id" => $account->bnk ?? null,
            "created_at" => $subaccount->created_at,
            "updated_at" => $subaccount->updated_at,
        ];

        // Step 9: Return the response
        return response()->json([
            "status" => true,
            "message" => "Subaccount retrieved successfully",
            "subaccount" => $responseData,
        ]);
    }

    /**
     * @OA\Post(
     *     path="/api/getSplitCode",
     *     summary="Get or create a split code for subaccounts",
     *     description="Creates a new split code or retrieves an existing one for the specified school, class, and subaccount codes.",
     *     operationId="getSplitCode",
     *     tags={"Payments"},
     *      security={{"bearerAuth": {}}},
     *     @OA\RequestBody(
     *         required=true,
     *         @OA\JsonContent(
     *             type="object",
     *             required={"schid","clsid","subaccount_code"},
     *             @OA\Property(
     *                 property="schid",
     *                 type="integer",
     *                 example=12,
     *                 description="School ID"
     *             ),
     *             @OA\Property(
     *                 property="clsid",
     *                 type="integer",
     *                 example=11,
     *                 description="Class ID"
     *             ),
     *             @OA\Property(
     *                 property="subaccount_code",
     *                 type="array",
     *                 @OA\Items(type="string"),
     *                 description="Array of subaccount codes"
     *             )
     *         )
     *     ),
     *     @OA\Response(
     *         response=200,
     *         description="Split code retrieved successfully",
     *         @OA\JsonContent(
     *             type="object",
     *             @OA\Property(property="status", type="boolean", example=true),
     *             @OA\Property(property="split_code", type="string", example="SPLIT12345"),
     *             @OA\Property(
     *                 property="subaccounts",
     *                 type="array",
     *                 @OA\Items(
     *                     type="object",
     *                     @OA\Property(property="id", type="integer", example=1),
     *                     @OA\Property(property="code", type="string", example="SUB001"),
     *                     @OA\Property(property="name", type="string", example="Sub Account Name")
     *                 )
     *             )
     *         )
     *     ),
     *     @OA\Response(
     *         response=422,
     *         description="Validation Error",
     *         @OA\JsonContent(
     *             type="object",
     *             @OA\Property(property="message", type="string", example="The schid field is required."),
     *             @OA\Property(property="errors", type="object")
     *         )
     *     )
     * )
     */
    public function getSplitCode(Request $request)
    {
        $request->validate([
            'schid' => 'required|integer',
            'clsid' => 'required|integer',
            'subaccount_code' => 'required|array|min:1'
        ]);

        $splitData = $this->createOrGetSplit($request->schid, $request->clsid, $request->subaccount_code);

        return response()->json([
            'status' => true,
            'split_code' => $splitData['split_code'],
            'subaccounts' => $splitData['subaccounts']
        ]);
    }



    public function createOrGetSplit(int $schid, int $clsid, array $subaccounts): array
    {
        $MAX_SUBACCOUNT_SHARE = 99.0;

        /* =====================================================
         * 1. CHECK IF VALID SPLIT EXISTS (VERIFY AT PAYSTACK)
         * ===================================================== */
        $existing = subaccount_split::where('schid', $schid)
            ->where('clsid', $clsid)
            ->first();

        if ($existing && $existing->split_code) {
            $verify = Http::withToken(env('PAYSTACK_SECRET'))
                ->get("https://api.paystack.co/split/{$existing->split_code}");

            if ($verify->successful()) {
                $psSubs = $verify->json('data.subaccounts') ?? [];
                if (!empty($psSubs)) {
                    return [
                        'split_code' => $existing->split_code,
                        'subaccounts' => json_decode($existing->subaccounts, true),
                    ];
                }
            }

            //  Broken split  delete
            $existing->delete();
        }

        /* =====================================================
         * 2. MERGE & VALIDATE SUBACCOUNTS
         * ===================================================== */
        $merged = [];
        foreach ($subaccounts as $acc) {
            if (
                empty($acc['subaccount']) ||
                !isset($acc['share']) ||
                floatval($acc['share']) <= 0
            ) {
                throw new \Exception('Invalid subaccount payload');
            }

            $merged[$acc['subaccount']] = ($merged[$acc['subaccount']] ?? 0) + floatval($acc['share']);
        }

        if (empty($merged)) {
            throw new \Exception('No valid subaccounts supplied');
        }

        /* =====================================================
         * 3. VALIDATE TOTAL  99%
         * ===================================================== */
        $total = array_sum($merged);
        if ($total <= 0 || $total > $MAX_SUBACCOUNT_SHARE) {
            throw new \Exception("Invalid split percentage (max 99%)");
        }

        /* =====================================================
         * 4. NORMALIZE
         * ===================================================== */
        $normalized = [];
        foreach ($merged as $code => $share) {
            $normalized[] = [
                'subaccount' => $code,
                'share' => round($share, 2),
            ];
        }

        /* =====================================================
         * 5. CREATE SPLIT AT PAYSTACK
         * ===================================================== */
        $response = Http::withToken(env('PAYSTACK_SECRET'))
            ->post('https://api.paystack.co/split', [
                'name' => "Split-{$schid}-{$clsid}",
                'type' => 'percentage',
                'currency' => 'NGN',
                'subaccounts' => $normalized,
                'bearer_type' => 'account', //  CORRECT
            ]);

        if (!$response->successful()) {
            Log::error('Paystack split creation failed', [
                'body' => $response->body(),
            ]);
            throw new \Exception('Unable to create Paystack split');
        }

        $splitCode = $response->json('data.split_code');

        /* =====================================================
         * 6. VERIFY SPLIT EXISTS AT PAYSTACK (CRITICAL)
         * ===================================================== */
        $verify = Http::withToken(env('PAYSTACK_SECRET'))
            ->get("https://api.paystack.co/split/{$splitCode}");

        if (!$verify->successful() || empty($verify->json('data.subaccounts'))) {
            throw new \Exception('Split verification failed at Paystack');
        }

        /* =====================================================
         * 7. STORE LOCALLY
         * ===================================================== */
        subaccount_split::create([
            'schid' => $schid,
            'clsid' => $clsid,
            'split_code' => $splitCode,
            'subaccounts' => json_encode($normalized),
        ]);

        return [
            'split_code' => $splitCode,
            'subaccounts' => $normalized,
        ];
    }



    public function handleCallback(Request $request)
    {
        $reference = $request->query('reference');

        if (!$reference) {
            return redirect()->to(url('/studentPortal?status=error'));
        }

        // Get school subdomain
        $refParts = explode('-', $reference);
        $schid = $refParts[1] ?? null;

        $school = \DB::table('school')->where('sid', $schid)->first();
        $subdomain = $school->sbd ?? 'www';

        // Redirect user with reference to frontend
        $url = request()->getScheme() . "://{$subdomain}.schoolsilomerge.top/studentPortal?status=processing&ref={$reference}";
        return redirect()->to($url);
    }


    private function redirectToError(): \Illuminate\Http\RedirectResponse
    {
        return redirect()->to(url('/studentPortal?status=error'));
    }


    public function initializePayment(Request $request)
    {
        $request->validate([
            'email' => 'required|email',
            'amount' => 'required|numeric|min:100',
            'schid' => 'required|integer',
            'clsid' => 'required|integer',
            'subaccount_code' => 'required|array|min:1',
            'subaccount_code.*.subaccount' => 'required|string',
            'subaccount_code.*.share' => 'required|numeric|min:0.01',
            'metadata' => 'required|array',
            'payhead_ids' => 'required|array|min:1',
        ]);

        $email = $request->email;
        $amount = (float) $request->amount;
        $schid = (int) $request->schid;
        $clsid = (int) $request->clsid;
        $subaccounts = $request->subaccount_code;
        $metadata = $request->metadata;
        $payheadIds = $request->payhead_ids;

        $totalShare = collect($subaccounts)->sum('share');

        if ($totalShare <= 0 || $totalShare > 99) {
            return response()->json([
                'status' => false,
                'message' => 'Total split percentage must be between 0.01% and 99%',
            ], 422);
        }

        try {
            $totalAmountKobo = (int) round($amount * 100);

            /** -------------------------------------------------
             * Validate subaccounts exist for this school/class
             * ------------------------------------------------*/
            foreach ($subaccounts as $acc) {
                $exists = \DB::table('sub_accounts')
                    ->where('schid', $schid)
                    ->where('clsid', $clsid)
                    ->where('subaccount_code', $acc['subaccount'])
                    ->exists();

                if (!$exists) {
                    return response()->json([
                        'status' => false,
                        'message' => "Invalid subaccount: {$acc['subaccount']}",
                    ], 400);
                }
            }

            /** -------------------------------------------------
             * Create or reuse Paystack split
             * ------------------------------------------------*/
            $splitData = $this->createOrGetSplit($schid, $clsid, $subaccounts);
            $splitCode = $splitData['split_code'] ?? null;
            $subaccountsData = $splitData['subaccounts'] ?? [];

            /** -------------------------------------------------
             * Build reference
             * ------------------------------------------------*/
            $host = preg_replace('/^api\./', '', $request->getHost());
            $typ = (int) ($request->typ ?? 0);
            $stid = (int) ($request->stid ?? 0);
            $ssnid = (int) ($request->ssnid ?? 0);
            $trmid = (int) ($request->trmid ?? 0);

            $ref = "{$host}-{$schid}-{$amount}-{$typ}-{$stid}-{$ssnid}-{$trmid}-{$clsid}-" . uniqid('', true);

            /** -------------------------------------------------
             * Merge metadata safely
             * ------------------------------------------------*/
            $metadata = array_merge($metadata, [
                'stid' => $stid,
                'ssnid' => $ssnid,
                'trmid' => $trmid,
                'clsid' => $clsid,
                'schid' => $schid,
                'typ' => $typ,
                'name' => $metadata['name'] ?? '',
                'exp' => $metadata['exp'] ?? '',
                'eml' => $email,
                'lid' => $metadata['lid'] ?? '',
                'payhead_ids' => $payheadIds,
                'time' => now()->timestamp,
            ]);

            /** -------------------------------------------------
             * Paystack initialize payload
             * ------------------------------------------------*/
            $payload = [
                'email' => $email,
                'amount' => $totalAmountKobo,
                'currency' => 'NGN',
                'reference' => $ref,
                'callback_url' => $this->getFrontendUrl($schid, '/studentPortal'),
                'metadata' => $metadata,
                'channels' => ['card', 'bank', 'ussd'],
            ];

            if (!empty($splitCode)) {
                $payload['split_code'] = $splitCode;
            }

            $response = Http::withToken(env('PAYSTACK_SECRET'))
                ->post('https://api.paystack.co/transaction/initialize', $payload);

            if (!$response->successful()) {
                Log::error('Paystack Init Failed', [
                    'payload' => $payload,
                    'response' => $response->body(),
                ]);

                return response()->json([
                    'status' => false,
                    'message' => 'Payment Initialization Failed',
                ], 400);
            }

            $paystackData = $response->json();

            /** -------------------------------------------------
             * Store reference for callback/webhook
             * ------------------------------------------------*/
            payment_refs::updateOrCreate(
                ['ref' => $ref],
                [
                    'split_code' => $splitCode,
                    'subaccounts' => json_encode($subaccountsData),
                    'amt' => $amount,
                    'time' => now(),
                ]
            );

            return response()->json([
                'status' => true,
                'message' => 'Payment Initialized Successfully',
                'data' => $paystackData,
                'ref' => $ref,
                'split_code' => $splitCode,
                'subaccounts' => $subaccountsData,
            ]);

        } catch (\Throwable $e) {
            Log::error('Initialize Payment Exception', [
                'error' => $e->getMessage(),
            ]);

            return response()->json([
                'status' => false,
                'message' => 'Server Error: Unable to initialize payment',
            ], 500);
        }
    }




    private function getFrontendUrl(int $schid, string $path = ''): string
    {
        // Lookup school subdomain
        $school = \DB::table('school')->where('sid', $schid)->first();
        $subdomain = $school->sbd ?? 'www'; // fallback to www if missing

        // Get request scheme
        $scheme = request()->getScheme();

        // Remove "api." if present (important fix)
        $host = preg_replace('/^api\./', '', "{$subdomain}.schoolsilomerge.top");

        // Return full URL
        return "{$scheme}://{$host}{$path}";
    }


    /**
     * @OA\Get(
     *     path="/api/payment/status",
     *     summary="Check payment status by reference",
     *     description="Returns whether the payment associated with the given reference has been confirmed.",
     *     tags={"Payments"},
     *     @OA\Parameter(
     *         name="ref",
     *         in="query",
     *         description="Payment reference to check",
     *         required=true,
     *         @OA\Schema(
     *             type="string",
     *             example="schoolsilomerge.top-2436-1478-0-2455-2025-1-13-69493ab65f3aa"
     *         )
     *     ),
     *     @OA\Response(
     *         response=200,
     *         description="Payment status retrieved successfully",
     *         @OA\JsonContent(
     *             type="object",
     *             @OA\Property(
     *                 property="confirmed",
     *                 type="boolean",
     *                 description="Whether the payment has been confirmed",
     *                 example=true
     *             ),
     *             @OA\Property(
     *                 property="confirmed_at",
     *                 type="string",
     *                 format="date-time",
     *                 description="Timestamp when payment was confirmed",
     *                 example="2025-12-23T09:00:00Z"
     *             )
     *         )
     *     ),
     *     @OA\Response(
     *         response=422,
     *         description="Validation error",
     *         @OA\JsonContent(
     *             type="object",
     *             @OA\Property(
     *                 property="message",
     *                 type="string",
     *                 example="The ref field is required."
     *             )
     *         )
     *     ),
     *     @OA\Response(
     *         response=404,
     *         description="Reference not found",
     *         @OA\JsonContent(
     *             type="object",
     *             @OA\Property(
     *                 property="confirmed",
     *                 type="boolean",
     *                 example=false
     *             ),
     *             @OA\Property(
     *                 property="message",
     *                 type="string",
     *                 example="Reference not found"
     *             )
     *         )
     *     )
     * )
     */
    public function checkPaymentStatus(Request $request)
    {
        $request->validate(['ref' => 'required|string']);

        $refRow = payment_refs::where('ref', $request->ref)->first();

        if (!$refRow) {
            return response()->json(['confirmed' => false, 'message' => 'Reference not found']);
        }

        return response()->json([
            'confirmed' => !is_null($refRow->confirmed_at),
            'confirmed_at' => $refRow->confirmed_at,
        ]);
    }



    /**
     * @OA\Get(
     *     path="/api/getAccountStat/{schid}/{ssn}/{trm}",
     *     tags={"Api"},
     *     security={{"bearerAuth": {}}},
     *     summary="Get how many accounts are available",
     *     description="Use this endpoint to get the total number of available accounts for a school, session, and term.",
     *
     *     @OA\Parameter(
     *         name="schid",
     *         in="path",
     *         required=true,
     *         description="School ID",
     *         @OA\Schema(type="string", example="12")
     *     ),
     *     @OA\Parameter(
     *         name="ssn",
     *         in="path",
     *         required=true,
     *         description="Session ID",
     *         @OA\Schema(type="string", example="2025")
     *     ),
     *     @OA\Parameter(
     *         name="trm",
     *         in="path",
     *         required=true,
     *         description="Term ID",
     *         @OA\Schema(type="string", example="1")
     *     ),
     *
     *     @OA\Response(
     *         response=200,
     *         description="Success",
     *         @OA\JsonContent(
     *             @OA\Property(property="status", type="boolean", example=true),
     *             @OA\Property(property="message", type="string", example="Success"),
     *             @OA\Property(
     *                 property="pld",
     *                 type="object",
     *                 @OA\Property(property="total", type="integer", example=128)
     *             )
     *         )
     *     ),
     *
     *     @OA\Response(response=401, description="Unauthorized")
     * )
     */
    public function getAccountStat($schid, $ssn, $trm)
    {
        $total = accts::where('schid', $schid)
            ->where('ssn', $ssn)
            ->where('trm', $trm)
            ->count();

        return response()->json([
            "status" => true,
            "message" => "Success",
            "pld" => [
                "total" => $total,
            ],
        ]);
    }


    /**
     * @OA\Get(
     *     path="/api/getAccountsBySchool/{schid}/{ssn}/{trm}",
     *     tags={"Payments"},
     *     security={{"bearerAuth": {}}},
     *     summary="Get all Accounts by School",
     *     description="Retrieve all accounts for a school, session, and term, including sub-account details.",
     *
     *     @OA\Parameter(
     *         name="schid",
     *         in="path",
     *         required=true,
     *         description="School ID",
     *         @OA\Schema(type="string", example="12")
     *     ),
     *     @OA\Parameter(
     *         name="ssn",
     *         in="path",
     *         required=true,
     *         description="Session ID",
     *         @OA\Schema(type="string", example="2025")
     *     ),
     *     @OA\Parameter(
     *         name="trm",
     *         in="path",
     *         required=true,
     *         description="Term ID",
     *         @OA\Schema(type="string", example="1")
     *     ),
     *     @OA\Parameter(
     *         name="start",
     *         in="query",
     *         required=false,
     *         description="Index to start at",
     *         @OA\Schema(type="integer", example=0)
     *     ),
     *     @OA\Parameter(
     *         name="count",
     *         in="query",
     *         required=false,
     *         description="Number of records to retrieve",
     *         @OA\Schema(type="integer", example=20)
     *     ),
     *
     *     @OA\Response(
     *         response=200,
     *         description="Success",
     *         @OA\JsonContent(
     *             @OA\Property(property="status", type="boolean", example=true),
     *             @OA\Property(property="message", type="string", example="Success"),
     *             @OA\Property(
     *                 property="pld",
     *                 type="array",
     *                 @OA\Items(
     *                     type="object",
     *                     @OA\Property(property="id", type="integer", example=10),
     *                     @OA\Property(property="name", type="string", example="School Fees"),
     *                     @OA\Property(property="amount", type="number", format="float", example=15000),
     *                     @OA\Property(property="schid", type="integer", example=12),
     *                     @OA\Property(property="ssn", type="string", example="2025"),
     *                     @OA\Property(property="trm", type="string", example="1"),
     *                     @OA\Property(
     *                         property="subAccounts",
     *                         type="array",
     *                         description="Related sub-account breakdown",
     *                         @OA\Items(
     *                             @OA\Property(property="id", type="integer", example=1),
     *                             @OA\Property(property="accts_id", type="integer", example=10),
     *                             @OA\Property(property="name", type="string", example="Development Levy"),
     *                             @OA\Property(property="amount", type="number", example=2000)
     *                         )
     *                     )
     *                 )
     *             )
     *         )
     *     ),
     *
     *     @OA\Response(response=401, description="Unauthorized")
     * )
     */

    public function getAccountsBySchool($schid, $ssn, $trm)
    {
        $start = request()->input('start', 0);
        $count = request()->input('count', 20);

        // Retrieve accounts with subaccount details
        $pld = accts::where('schid', $schid)
            ->where('ssn', $ssn)
            ->where('trm', $trm)
            ->with('subAccounts') // Load subAccounts relationship
            ->skip($start)
            ->take($count)
            ->get();

        return response()->json([
            "status" => true,
            "message" => "Success",
            "pld" => $pld,
        ]);
    }





    /**
     * @OA\Get(
     *     path="/api/getAccountsBySchoolAndClass/{schid}/{clsid}",
     *     tags={"Payments"},
     *     summary="Get Accounts by School And Class",
     *     description="Use this endpoint to get Accounts records by School And Class",
     *
     *     @OA\Parameter(
     *         name="schid",
     *         in="path",
     *         required=true,
     *         description="School ID",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Parameter(
     *         name="clsid",
     *         in="path",
     *         required=true,
     *         description="Class ID",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Parameter(
     *         name="start",
     *         in="query",
     *         required=false,
     *         description="Index to start at",
     *         @OA\Schema(type="integer")
     *     ),
     *     @OA\Parameter(
     *         name="count",
     *         in="query",
     *         required=false,
     *         description="No of records to retrieve",
     *         @OA\Schema(type="integer")
     *     ),
     *     @OA\Response(response="200", description="Success", @OA\JsonContent()),
     *     @OA\Response(response="401", description="Unauthorized"),
     * )
     */
    public function getAccountsBySchoolAndClass($schid, $clsid)
    {
        $start = 0;
        $count = 20;
        if (request()->has('start') && request()->has('count')) {
            $start = request()->input('start');
            $count = request()->input('count');
        }
        $pld = accts::where('schid', $schid)->where('clsid', $clsid)->skip($start)->take($count)->get();
        // Respond
        return response()->json([
            "status" => true,
            "message" => "Success",
            "pld" => $pld,
        ]);
    }

    /**
     * @OA\Get(
     *     path="/api/deleteAccount/{schid}/{clsid}",
     *     tags={"Payments"},
     *     summary="Delete an Account",
     *     description="Use this endpoint to delete an Account",
     *
     *     @OA\Parameter(
     *         name="schid",
     *         in="path",
     *         required=true,
     *         description="School ID",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Parameter(
     *         name="clsid",
     *         in="path",
     *         required=true,
     *         description="Class ID",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Response(response="200", description="Success", @OA\JsonContent()),
     *     @OA\Response(response="401", description="Unauthorized"),
     * )
     */
    public function deleteAcct($schid, $clsid)
    {
        $pld = accts::where('schid', $schid)->where('clsid', $clsid)->delete();
        // Respond
        return response()->json([
            "status" => true,
            "message" => "Success",
            "pld" => $pld,
        ]);
    }

    /**
     * @OA\Post(
     *     path="/api/setAFee",
     *     tags={"Payments"},
     *       security={{"bearerAuth": {}}},
     *     summary="Create/Update acceptance Fee",
     *
     *     @OA\RequestBody(
     *         required=true,
     *         @OA\JsonContent(
     *             type="object",
     *             @OA\Property(property="schid", type="string"),
     *             @OA\Property(property="clsid", type="string"),
     *             @OA\Property(property="ssn", type="string"),
     *             @OA\Property(property="trm", type="string"),
     *             @OA\Property(property="amt", type="string"),
     *         )
     *     ),
     *     @OA\Response(
     *         response=200,
     *         description="Fee Updated",
     *         @OA\JsonContent(
     *             type="object",
     *             @OA\Property(property="status", type="boolean", example=true),
     *             @OA\Property(property="message", type="string", example="Account Updated")
     *         )
     *     ),
     *     @OA\Response(
     *         response=400,
     *         description="Validation Error",
     *         @OA\JsonContent(
     *             type="object",
     *             @OA\Property(property="status", type="boolean", example=false),
     *             @OA\Property(property="message", type="string", example="Validation Error")
     *         )
     *     )
     * )
     */


    public function setAFee(Request $request)
    {
        $request->validate([
            'schid' => 'required',
            'clsid' => 'required',
            'amt' => 'required',
            'ssn' => 'required',
            'trm' => 'required',
        ]);

        afee::updateOrCreate(
            [
                'schid' => $request->schid,
                'clsid' => $request->clsid,
                'ssn' => $request->ssn,
                'trm' => $request->trm,
            ],
            [
                'amt' => $request->amt
            ]
        );

        return response()->json([
            "status" => true,
            "message" => "Account Updated"
        ]);
    }



    /**
     * @OA\Get(
     *     path="/api/getAFeeStat/{schid}",
     *     tags={"Payments"},
     *    security={{"bearerAuth": {}}},
     *     summary="Get the number of acceptance fees available",
     *     description="Retrieve the total count of acceptance fees for a specific school with optional filters for session (ssn) and term (trm).",
     *
     *     @OA\Parameter(
     *         name="schid",
     *         in="path",
     *         required=true,
     *         description="School ID",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Parameter(
     *         name="ssn",
     *         in="query",
     *         required=false,
     *         description="Session filter (e.g., 2025)",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Parameter(
     *         name="trm",
     *         in="query",
     *         required=false,
     *         description="Term filter (e.g., 1, 2, or 3)",
     *         @OA\Schema(type="integer")
     *     ),
     *
     *     @OA\Response(
     *         response=200,
     *         description="Success",
     *         @OA\JsonContent(
     *             @OA\Property(property="status", type="boolean", example=true),
     *             @OA\Property(property="message", type="string", example="Success"),
     *             @OA\Property(
     *                 property="pld",
     *                 type="object",
     *                 @OA\Property(property="total", type="integer", example=25)
     *             )
     *         )
     *     ),
     *     @OA\Response(response=401, description="Unauthorized"),
     * )
     */

    // public function getAFeeStat($schid)
    // {
    //     $total = afee::where('schid', $schid)->count();
    //     return response()->json([
    //         "status" => true,
    //         "message" => "Success",
    //         "pld" => [
    //             "total" => $total,
    //         ],
    //     ]);
    // }

    public function getAFeeStat(Request $request, $schid)
    {
        // Optional filters
        $ssn = $request->input('ssn', null);
        $trm = $request->input('trm', null);

        // Base query
        $query = afee::where('schid', $schid);

        // Apply optional filters
        if (!is_null($ssn)) {
            $query->where('ssn', $ssn);
        }

        if (!is_null($trm)) {
            $query->where('trm', $trm);
        }

        // Count the records
        $total = $query->count();

        return response()->json([
            "status" => true,
            "message" => "Success",
            "pld" => [
                "total" => $total,
            ],
        ]);
    }


    /**
     * @OA\Get(
     *     path="/api/getAFeeBySchool/{schid}",
     *     tags={"Payments"},
     *    security={{"bearerAuth": {}}},
     *     summary="Get all acceptance fee by School",
     *     description="Retrieve acceptance fee records for a specific school with optional filters for session (ssn) and term (trm).",
     *
     *     @OA\Parameter(
     *         name="schid",
     *         in="path",
     *         required=true,
     *         description="School ID",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Parameter(
     *         name="start",
     *         in="query",
     *         required=false,
     *         description="Index to start at",
     *         @OA\Schema(type="integer", default=0)
     *     ),
     *     @OA\Parameter(
     *         name="count",
     *         in="query",
     *         required=false,
     *         description="Number of records to retrieve",
     *         @OA\Schema(type="integer", default=20)
     *     ),
     *     @OA\Parameter(
     *         name="ssn",
     *         in="query",
     *         required=false,
     *         description="Session filter (e.g., 2025)",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Parameter(
     *         name="trm",
     *         in="query",
     *         required=false,
     *         description="Term filter (e.g., 1, 2, or 3)",
     *         @OA\Schema(type="integer")
     *     ),
     *
     *     @OA\Response(
     *         response=200,
     *         description="Success",
     *         @OA\JsonContent(
     *              @OA\Property(property="status", type="boolean", example=true),
     *              @OA\Property(property="message", type="string", example="Success"),
     *              @OA\Property(property="pld", type="array", @OA\Items())
     *         )
     *     ),
     *     @OA\Response(response=404, description="No records found"),
     *     @OA\Response(response=401, description="Unauthorized"),
     * )
     */


    public function getAFeeBySchool(Request $request, $schid)
    {
        // Pagination
        $start = $request->input('start', 0);
        $count = $request->input('count', 20);

        // Optional filters
        $ssn = $request->input('ssn', null);
        $trm = $request->input('trm', null);

        // Base query
        $query = afee::where('schid', $schid);

        // Apply optional filters
        if (!is_null($ssn)) {
            $query->where('ssn', $ssn);
        }

        if (!is_null($trm)) {
            $query->where('trm', $trm);
        }

        // Pagination
        $pld = $query->skip($start)->take($count)->get();

        if ($pld->isEmpty()) {
            return response()->json([
                "status" => false,
                "message" => "No records found",
                "pld" => $pld,
            ], 404);
        }

        return response()->json([
            "status" => true,
            "message" => "Success",
            "pld" => $pld,
        ]);
    }


    /**
     * @OA\Get(
     *     path="/api/getAFee/{schid}/{clsid}",
     *     tags={"Payments"},
     *   security={{"bearerAuth": {}}},
     *     summary="Get acceptance fee for a specific class",
     *     description="Retrieve acceptance fee record filtered by school, class, and optional session (ssn) and term (trm).",
     *
     *     @OA\Parameter(
     *         name="schid",
     *         in="path",
     *         required=true,
     *         description="School ID",
     *         @OA\Schema(type="integer")
     *     ),
     *
     *     @OA\Parameter(
     *         name="clsid",
     *         in="path",
     *         required=true,
     *         description="Class ID",
     *         @OA\Schema(type="integer")
     *     ),
     *
     *     @OA\Parameter(
     *         name="ssn",
     *         in="query",
     *         required=false,
     *         description="Session / Academic year (e.g. 2025)",
     *         @OA\Schema(type="string", example="2025")
     *     ),
     *
     *     @OA\Parameter(
     *         name="trm",
     *         in="query",
     *         required=false,
     *         description="Term (1, 2, or 3)",
     *         @OA\Schema(type="integer", example=1)
     *     ),
     *
     *     @OA\Response(
     *         response=200,
     *         description="Success",
     *         @OA\JsonContent()
     *     ),
     *
     *     @OA\Response(
     *         response=401,
     *         description="Unauthorized"
     *     )
     * )
     */

    // public function getAFee($schid, $clsid)
    // {
    //     $pld = afee::where('schid', $schid)->where('clsid', $clsid)->first();
    //     // Respond
    //     return response()->json([
    //         "status" => true,
    //         "message" => "Success",
    //         "pld" => $pld,
    //     ]);
    // }

    public function getAFee(Request $request, $schid, $clsid)
    {
        // Optional filters
        $ssn = $request->input('ssn', null);
        $trm = $request->input('trm', null);

        // Base query
        $query = afee::where('schid', $schid)->where('clsid', $clsid);

        // Apply optional filters
        if (!is_null($ssn)) {
            $query->where('ssn', $ssn);
        }

        if (!is_null($trm)) {
            $query->where('trm', $trm);
        }

        // Fetch first record
        $pld = $query->first();

        return response()->json([
            "status" => true,
            "message" => "Success",
            "pld" => $pld,
        ]);
    }


    /**
     * @OA\Get(
     *     path="/api/deleteAFee/{schid}/{clsid}",
     *     tags={"Payments"},
     *     summary="Delete an Accpt. Fee",
     *     description="Use this endpoint to delete an Accpt. Fee",
     *
     *     @OA\Parameter(
     *         name="schid",
     *         in="path",
     *         required=true,
     *         description="School ID",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Parameter(
     *         name="clsid",
     *         in="path",
     *         required=true,
     *         description="Class ID",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Response(response="200", description="Success", @OA\JsonContent()),
     *     @OA\Response(response="401", description="Unauthorized"),
     * )
     */
    public function deleteAFee($schid, $clsid)
    {
        $pld = afee::where('schid', $schid)->where('clsid', $clsid)->delete();
        // Respond
        return response()->json([
            "status" => true,
            "message" => "Success",
            "pld" => $pld,
        ]);
    }


    /**
     * @OA\Post(
     *     path="/api/setPayHead",
     *     tags={"Payments"},
     *     summary="Create/Update payment heading",
     *
     *     @OA\RequestBody(
     *         required=true,
     *         @OA\JsonContent(
     *             type="object",
     *             @OA\Property(property="name", type="string"),
     *             @OA\Property(property="comp", type="string"),
     *             @OA\Property(property="schid", type="string"),
     *         )
     *     ),
     *     @OA\Response(
     *         response=200,
     *         description="PH Updated",
     *         @OA\JsonContent(
     *             type="object",
     *             @OA\Property(property="status", type="boolean", example=true),
     *             @OA\Property(property="message", type="string", example="Account Updated")
     *         )
     *     ),
     *     @OA\Response(
     *         response=400,
     *         description="Validation Error",
     *         @OA\JsonContent(
     *             type="object",
     *             @OA\Property(property="status", type="boolean", example=false),
     *             @OA\Property(property="message", type="string", example="Validation Error")
     *         )
     *     )
     * )
     */
    public function setPayHead(Request $request)
    {
        $request->validate([
            'name' => 'required',
            'comp' => 'required',
            'schid' => 'required',
        ]);
        $data = [
            'name' => $request->name,
            'comp' => $request->comp,
            'schid' => $request->schid,
        ];
        $ph = [];
        if ($request->has('id')) {
            $ph = payhead::where('id', $request->id)->first();
            if ($ph) {
                $ph->update($data);
            } else {
                return response()->json([
                    "status" => false,
                    "message" => "PH Not Found",
                ]);
            }
        } else {
            $ph = payhead::create($data);
        }
        return response()->json([
            "status" => true,
            "message" => "PH Updated"
        ]);
    }

    /**
     * @OA\Get(
     *     path="/api/getPayHeadStat/{schid}",
     *     tags={"Api"},
     *     summary="Get how many pay heads are available",
     *     description="Use this endpoint to get how many pay heads are available",
     *
     *     @OA\Parameter(
     *         name="schid",
     *         in="path",
     *         required=true,
     *         description="School ID",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Response(response="200", description="Success", @OA\JsonContent()),
     *     @OA\Response(response="401", description="Unauthorized"),
     * )
     */
    public function getPayHeadStat($schid)
    {
        $total = payhead::where('schid', $schid)->count();
        return response()->json([
            "status" => true,
            "message" => "Success",
            "pld" => [
                "total" => $total,
            ],
        ]);
    }

    /**
     * @OA\Get(
     *     path="/api/getPayHeadsBySchool/{schid}",
     *     tags={"Payments"},
     *     summary="Get all pay heads by School",
     *     description="Use this endpoint to get all pay heads by School",
     *      security={{"bearerAuth":{}}},
     *
     *     @OA\Parameter(
     *         name="schid",
     *         in="path",
     *         required=true,
     *         description="School ID",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Parameter(
     *         name="start",
     *         in="query",
     *         required=false,
     *         description="Index to start at",
     *         @OA\Schema(type="integer")
     *     ),
     *     @OA\Parameter(
     *         name="count",
     *         in="query",
     *         required=false,
     *         description="No of records to retrieve",
     *         @OA\Schema(type="integer")
     *     ),
     *     @OA\Response(response="200", description="Success", @OA\JsonContent()),
     *     @OA\Response(response="401", description="Unauthorized"),
     * )
     */
    public function getPayHeadsBySchool($schid)
    {
        $start = 0;
        $count = 20;
        if (request()->has('start') && request()->has('count')) {
            $start = request()->input('start');
            $count = request()->input('count');
        }
        $pld = payhead::where('schid', $schid)->skip($start)->take($count)->get();
        // Respond
        return response()->json([
            "status" => true,
            "message" => "Success",
            "pld" => $pld,
        ]);
    }

    /**
     * @OA\Get(
     *     path="/api/deletePayHead/{uid}",
     *     tags={"Payments"},
     *     summary="Delete a payment heading",
     *     description="Use this endpoint to delete a pay head",
     *
     *     @OA\Parameter(
     *         name="uid",
     *         in="path",
     *         required=true,
     *         description="ID of the record",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Response(response="200", description="Success", @OA\JsonContent()),
     *     @OA\Response(response="401", description="Unauthorized"),
     * )
     */
    public function deletePayHead($uid)
    {
        $pld = payhead::where('id', $uid)->delete();
        // Respond
        return response()->json([
            "status" => true,
            "message" => "Success",
            "pld" => $pld,
        ]);
    }

    /**
     * @OA\Post(
     *     path="/api/setClassPay",
     *     tags={"Payments"},
     *     summary="Link a pay heading to a class",
     *
     *     @OA\RequestBody(
     *         required=true,
     *         @OA\JsonContent(
     *             type="object",
     *             @OA\Property(property="schid", type="string"),
     *             @OA\Property(property="clsid", type="string"),
     *             @OA\Property(property="amt", type="string"),
     *             @OA\Property(property="phid", type="string"),
     *             @OA\Property(property="sesid", type="string"),
     *             @OA\Property(property="trmid", type="string"),
     *         )
     *     ),
     *     @OA\Response(
     *         response=200,
     *         description="Record Updated",
     *         @OA\JsonContent(
     *             type="object",
     *             @OA\Property(property="status", type="boolean", example=true),
     *             @OA\Property(property="message", type="string", example="Account Updated")
     *         )
     *     ),
     *     @OA\Response(
     *         response=400,
     *         description="Validation Error",
     *         @OA\JsonContent(
     *             type="object",
     *             @OA\Property(property="status", type="boolean", example=false),
     *             @OA\Property(property="message", type="string", example="Validation Error")
     *         )
     *     )
     * )
     */
    public function setClassPay(Request $request)
    {
        $request->validate([
            'schid' => 'required',
            'clsid' => 'required',
            'amt' => 'required',
            'phid' => 'required',
            'sesid' => 'required',
            'trmid' => 'required',
        ]);
        $data = [
            'schid' => $request->schid,
            'clsid' => $request->clsid,
            'amt' => $request->amt,
            'phid' => $request->phid,
            'sesid' => $request->sesid,
            'trmid' => $request->trmid,
        ];
        $clspay = [];
        if ($request->has('id')) {
            $clspay = clspay::where('id', $request->id)->first();
            if ($clspay) {
                $clspay->update($data);
            } else {
                return response()->json([
                    "status" => false,
                    "message" => "Record Not Found",
                ]);
            }
        } else {
            $clspay = clspay::create($data);
        }
        return response()->json([
            "status" => true,
            "message" => "Record Updated"
        ]);
    }

    /**
     * @OA\Get(
     *     path="/api/getClassPays/{schid}/{clsid}/{sesid}/{trmid}",
     *     tags={"Payments"},
     *     summary="Get payments by School And Class",
     *     security={{"bearerAuth": {}}},
     *     description="Use this endpoint to get payments heads by School And Class",
     *
     *     @OA\Parameter(
     *         name="schid",
     *         in="path",
     *         required=true,
     *         description="School ID",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Parameter(
     *         name="clsid",
     *         in="path",
     *         required=true,
     *         description="Class ID",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Parameter(
     *         name="sesid",
     *         in="path",
     *         required=true,
     *         description="Session ID",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Parameter(
     *         name="trmid",
     *         in="path",
     *         required=true,
     *         description="Term ID",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Parameter(
     *         name="start",
     *         in="query",
     *         required=false,
     *         description="Index to start at",
     *         @OA\Schema(type="integer")
     *     ),
     *     @OA\Parameter(
     *         name="count",
     *         in="query",
     *         required=false,
     *         description="No of records to retrieve",
     *         @OA\Schema(type="integer")
     *     ),
     *     @OA\Response(response="200", description="Success", @OA\JsonContent()),
     *     @OA\Response(response="401", description="Unauthorized"),
     * )
     */
    // public function getClassPays($schid, $clsid, $sesid, $trmid)
    // {
    //     $start = 0;
    //     $count = 20;
    //     if (request()->has('start') && request()->has('count')) {
    //         $start = request()->input('start');
    //         $count = request()->input('count');
    //     }
    //     $pld = clspay::where('schid', $schid)->where('clsid', $clsid)
    //         ->where('sesid', $sesid)->where('trmid', $trmid)->skip($start)->take($count)->get();
    //     // Respond
    //     return response()->json([
    //         "status" => true,
    //         "message" => "Success",
    //         "pld" => $pld,
    //     ]);
    // }

    public function getClassPays($schid, $clsid, $sesid, $trmid)
    {
        $start = request()->input('start', 0);
        $count = request()->input('count', 20);

        $pld = clspay::join('payhead', 'clspay.phid', '=', 'payhead.id')
            ->where('clspay.schid', $schid)
            ->where('clspay.clsid', $clsid)
            ->where('clspay.sesid', $sesid)
            ->where('clspay.trmid', $trmid)
            ->select(
                'clspay.id',
                'clspay.schid',
                'clspay.clsid',
                'clspay.amt',
                'clspay.phid',
                'clspay.sesid',
                'clspay.trmid',
                'clspay.created_at',
                'clspay.updated_at',
                'payhead.name' //  THIS IS THE ONLY ADDITION
            )
            ->skip($start)
            ->take($count)
            ->get();

        return response()->json([
            "status" => true,
            "message" => "Success",
            "pld" => $pld,
        ]);
    }


    /**
     * @OA\Get(
     *     path="/api/deleteClassPay/{uid}",
     *     tags={"Payments"},
     *     summary="Delete a class payment",
     *     description="Use this endpoint to delete a class pay head",
     *
     *     @OA\Parameter(
     *         name="uid",
     *         in="path",
     *         required=true,
     *         description="ID of the record",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Response(response="200", description="Success", @OA\JsonContent()),
     *     @OA\Response(response="401", description="Unauthorized"),
     * )
     */
    public function deleteClassPay($uid)
    {
        $pld = clspay::where('id', $uid)->delete();
        // Respond
        return response()->json([
            "status" => true,
            "message" => "Success",
            "pld" => $pld,
        ]);
    }




    /**
     * @OA\Post(
     *     path="/api/paystackConf",
     *     summary="Process a payment reference and update records",
     *     description="This endpoint processes a payment reference, updates related records based on the type of payment, and sends an email confirmation.",
     *     tags={"Payments"},
     *     security={{"bearerAuth": {}}},
     *     @OA\RequestBody(
     *         required=true,
     *         @OA\JsonContent(
     *             required={"ref", "data"},
     *             @OA\Property(property="ref", type="string", example="PAY-123456-5000-0-98765-2024-1-10"),
     *             @OA\Property(property="data", type="object",
     *                 @OA\Property(property="metadata", type="object",
     *                     @OA\Property(property="name", type="string", example="John Doe"),
     *                     @OA\Property(property="time", type="string", format="date-time", example="2024-03-07 10:00:00"),
     *                     @OA\Property(property="exp", type="string", example="2024-12-31"),
     *                     @OA\Property(property="eml", type="string", format="email", example="johndoe@example.com"),
     *                     @OA\Property(property="lid", type="string", example="LID-123456")
     *                 )
     *             )
     *         )
     *     ),
     *     @OA\Response(
     *         response=200,
     *         description="Payment processed successfully",
     *         @OA\JsonContent(
     *             @OA\Property(property="status", type="string", example="success")
     *         )
     *     ),
     *     @OA\Response(
     *         response=400,
     *         description="Invalid request or missing parameters",
     *         @OA\JsonContent(
     *             @OA\Property(property="status", type="string", example="error"),
     *             @OA\Property(property="message", type="string", example="Invalid reference")
     *         )
     *     ),
     *     @OA\Response(
     *         response=500,
     *         description="Internal server error",
     *         @OA\JsonContent(
     *             @OA\Property(property="status", type="string", example="error"),
     *             @OA\Property(property="message", type="string", example="Something went wrong")
     *         )
     *     )
     * )
     */

    //Paystack Webhook (POST, formdata)
    // public function paystackConf(Request $request){
    //     Log::info('------------ARRIVED-----------');
    //     $payload = json_decode($request->input('payload'), true);
    //     if($payload['event'] == "charge.success"){
    //         $ref = $payload['data']['reference'];
    //         Log::info($ref);
    //         $pld = payment_refs::where("ref","=", $ref)->first();
    //         if(!$pld){ // Its unique
    //             $payinfo = explode('-',$ref);
    //             $amt = $payinfo[2];
    //             $schid = $payinfo[1];
    //             $typ = $payinfo[3];
    //             $stid = $payinfo[4];
    //             $ssnid = $payinfo[5];
    //             $trmid = $payinfo[6];
    //             $clsid = $payinfo[7];
    //             $nm = $payload['data']['metadata']['name'];
    //             $tm = $payload['data']['metadata']['time'];
    //             $exp = $payload['data']['metadata']['exp'];
    //             $eml = $payload['data']['metadata']['eml'];
    //             $lid = $payload['data']['metadata']['lid'];
    //             $pid = $payload['data']['metadata']['pid'];
    //             $what = '';
    //             if($typ =='0'){ //School-Student Payment
    //                 payments::create([
    //                     'schid'=>$schid,
    //                     'stid'=>$stid,
    //                     'ssnid'=>$ssnid,
    //                     'trmid'=>$trmid,
    //                     'clsid'=>$clsid,
    //                     'name'=>$nm,
    //                     'exp'=>$exp,
    //                     'amt'=>$amt,
    //                     'lid'=>$lid,
    //                 ]);
    //                 $what = 'School Fees';
    //             }
    //             if($typ =='1'){ //Application Fee Paid
    //                 //WARN: ClassID will be a placeholder in this case, so dont use it
    //                 student::where('sid',$stid)->update([
    //                     "rfee"=>'1'
    //                 ]);
    //                 $what = 'Application Fee';
    //             }
    //             if($typ =='2'){ //Acceptance Fee Paid
    //                 $uid = $stid.$schid.$clsid;
    //                 afeerec::updateOrCreate(
    //                     ["uid"=> $uid,],
    //                     [
    //                     "stid"=> $stid,
    //                     "schid"=> $schid,
    //                     "clsid"=> $clsid,
    //                     "amt"=> intval($amt),
    //                 ]);
    //                 $what = 'Acceptance Fee';
    //             }
    //             // Wrap the email sending logic in a try-catch block
    //             try {
    //                 $data = [
    //                     'name' => $nm,
    //                     'subject' => 'Payment Received',
    //                     'body' => 'Your '.$what.' payment was received',
    //                     'link'=>env('PORTAL_URL').'/studentLogin'.'/'.$schid,
    //                 ];
    //                 Mail::to($eml)->send(new SSSMails($data));
    //             } catch (\Exception $e) {
    //                 // Log the email error, but don't stop the process
    //                 Log::error('Failed to send email: ' . $e->getMessage());
    //             }

    //             payment_refs::create([
    //                 "ref"=> $ref,
    //                 "amt"=> $amt,
    //                 "time"=> $tm,
    //             ]);
    //             Log::info('SUCCESS');
    //         }else{
    //             Log::info('PLD EXISTS'.json_encode($pld));
    //         }
    //     }else{
    //         Log::info('EVENTS BAD '.$payload['event']);
    //     }
    //     return response()->json(['status' => 'success'], 200);
    // }



    //Paystack Webhook (POST, formdata)
    // public function paystackConf(Request $request)
    // {
    //     Log::info('------------ARRIVED-----------');
    //     $payload = json_decode($request->input('payload'), true);
    //     if ($payload['event'] == "charge.success") {
    //         $ref = $payload['data']['reference'];
    //         $pld = payment_refs::where("ref", "=", $ref)->first();
    //         if (!$pld) { // Its unique
    //             $payinfo = explode('-', $ref);
    //             $amt = $payinfo[2];
    //             $schid = $payinfo[1];
    //             $typ = $payinfo[3];
    //             $stid = $payinfo[4];
    //             $ssnid = $payinfo[5];
    //             $trmid = $payinfo[6];
    //             $clsid = $payinfo[7];
    //             $nm = $payload['data']['metadata']['name'];
    //             $tm = $payload['data']['metadata']['time'];
    //             $exp = $payload['data']['metadata']['exp'];
    //             $eml = $payload['data']['metadata']['eml'];
    //             $lid = $payload['data']['metadata']['lid'];

    //             $what = '';
    //             if ($typ == '0') { //School-Student Payment
    //                 payments::create([
    //                     'schid' => $schid,
    //                     'stid' => $stid,
    //                     'ssnid' => $ssnid,
    //                     'trmid' => $trmid,
    //                     'clsid' => $clsid,
    //                     'name' => $nm,
    //                     'exp' => $exp,
    //                     'amt' => $amt,
    //                     'lid' => $lid,
    //                 ]);
    //                 $what = 'School Fees';
    //             }
    //             if ($typ == '1') { //Application Fee Paid
    //                 //WARN: ClassID will be a placeholder in this case, so dont use it
    //                 student::where('sid', $stid)->update([
    //                     "rfee" => '1'
    //                 ]);
    //                 $what = 'Application Fee';
    //             }
    //             if ($typ == '2') { //Acceptance Fee Paid
    //                 $uid = $stid . $schid . $clsid;
    //                 afeerec::updateOrCreate(
    //                     ["uid" => $uid,],
    //                     [
    //                         "stid" => $stid,
    //                         "schid" => $schid,
    //                         "clsid" => $clsid,
    //                         "amt" => intval($amt),
    //                     ]
    //                 );
    //                 $what = 'Acceptance Fee';
    //             }
    //             // Wrap the email sending logic in a try-catch block
    //             try {
    //                 $data = [
    //                     'name' => $nm,
    //                     'subject' => 'Payment Received',
    //                     'body' => 'Your ' . $what . ' payment was received',
    //                     'link' => env('PORTAL_URL') . '/studentLogin' . '/' . $schid,
    //                 ];
    //                 Mail::to($eml)->send(new SSSMails($data));
    //             } catch (\Exception $e) {
    //                 // Log the email error, but don't stop the process
    //                 Log::error('Failed to send email: ' . $e->getMessage());
    //             }

    //             payment_refs::create([
    //                 "ref" => $ref,
    //                 "amt" => $amt,
    //                 "time" => $tm,
    //             ]);
    //             Log::info('SUCCESS');
    //         } else {
    //             Log::info('PLD EXISTS' . json_encode($pld));
    //         }
    //     } else {
    //         Log::info('EVENTS BAD ' . $payload['event']);
    //     }
    //     return response()->json(['status' => 'success'], 200);
    // }


    // public function paystackConf(Request $request)
    // {
    //     Log::info('------------ARRIVED-----------');
    //     $payload = json_decode($request->input('payload'), true);

    //     if ($payload['event'] == "charge.success") {
    //         $ref = $payload['data']['reference'];
    //         $pld = payment_refs::where("ref", "=", $ref)->first();

    //         if (!$pld) { // Unique reference
    //             $payinfo = explode('-', $ref);
    //             $amt   = $payinfo[2];
    //             $schid = $payinfo[1];
    //             $typ   = $payinfo[3];
    //             $stid  = $payinfo[4];
    //             $ssnid = $payinfo[5];
    //             $trmid = $payinfo[6];
    //             $clsid = $payinfo[7];

    //             $metadata = $payload['data']['metadata'];
    //             $nm  = $metadata['name'] ?? '';
    //             $tm  = $metadata['time'] ?? now()->timestamp;
    //             $exp = $metadata['exp'] ?? '';
    //             $eml = $metadata['eml'] ?? '';
    //             $lid = $metadata['lid'] ?? '';

    //             $what = '';
    //             if ($typ == '0') {
    //                 $what = 'School Fees';
    //             } elseif ($typ == '1') {
    //                 $what = 'Application Fee';
    //                 student::where('sid', $stid)->update(["rfee" => '1']);
    //             } elseif ($typ == '2') {
    //                 $what = 'Acceptance Fee';
    //                 $uid = $stid . $schid . $clsid;
    //                 afeerec::updateOrCreate(
    //                     ["uid" => $uid],
    //                     [
    //                         "stid"  => $stid,
    //                         "schid" => $schid,
    //                         "clsid" => $clsid,
    //                         "amt"   => intval($amt),
    //                     ]
    //                 );
    //             }

    //             // If split exists, save each subaccount payment separately
    //             if (!empty($payload['data']['split']['shares']['subaccounts'])) {
    //                 foreach ($payload['data']['split']['shares']['subaccounts'] as $sub) {
    //                     payments::create([
    //                         'schid'           => $schid,
    //                         'stid'            => $stid,
    //                         'ssnid'           => $ssnid,
    //                         'trmid'           => $trmid,
    //                         'clsid'           => $clsid,
    //                         'name'            => $nm,
    //                         'exp'             => $exp,
    //                         'amt'             => $sub['amount'] / 100, // convert kobo to Naira
    //                         'lid'             => $lid,
    //                         'subaccount_code' => $sub['subaccount_code'], // added
    //                         'main_ref'        => $ref, // added
    //                     ]);
    //                 }
    //             } else {
    //                 // If no split, save total payment
    //                 payments::create([
    //                     'schid'    => $schid,
    //                     'stid'     => $stid,
    //                     'ssnid'    => $ssnid,
    //                     'trmid'    => $trmid,
    //                     'clsid'    => $clsid,
    //                     'name'     => $nm,
    //                     'exp'      => $exp,
    //                     'amt'      => $amt,
    //                     'lid'      => $lid,
    //                     'main_ref' => $ref, // added
    //                 ]);
    //             }

    //             // Send email (optional)
    //             try {
    //                 $data = [
    //                     'name'    => $nm,
    //                     'subject' => 'Payment Received',
    //                     'body'    => 'Your ' . $what . ' payment was received',
    //                     'link'    => env('PORTAL_URL') . '/studentLogin/' . $schid,
    //                 ];
    //                 Mail::to($eml)->send(new SSSMails($data));
    //             } catch (\Exception $e) {
    //                 Log::error('Failed to send email: ' . $e->getMessage());
    //             }

    //             // Save reference
    //             payment_refs::create([
    //                 "ref"  => $ref,
    //                 "amt"  => $amt,
    //                 "time" => $tm,
    //             ]);

    //             Log::info('SUCCESS');
    //         } else {
    //             Log::info('PLD EXISTS: ' . json_encode($pld));
    //         }
    //     } else {
    //         Log::info('EVENTS BAD: ' . $payload['event']);
    //     }

    //     return response()->json(['status' => 'success'], 200);;
    // }



    //     public function paystackConf(Request $request)
//     {
//         Log::info('------------ PAYSTACK CALLBACK ARRIVED -----------');

    //         //   $payload = json_decode($request->getContent(), true);
//         $payload = json_decode($request->input('payload'), true);

    //         // Verify Paystack event type
//         if (!isset($payload['event']) || $payload['event'] !== "charge.success") {
//             Log::warning('Invalid Paystack event received.');
//             return response()->json(['status' => 'ignored'], 200);
//         }

    //         //  Extract reference
//         $ref = $payload['data']['reference'] ?? null;
//         if (!$ref) {
//             Log::error('Missing payment reference.');
//             return response()->json(['status' => 'error', 'message' => 'Missing reference'], 400);
//         }

    //         //  Prevent duplicate webhook saves
//         if (payments::where('main_ref', $ref)->exists()) {
//             Log::info("Duplicate webhook ignored for ref {$ref}");
//             return response()->json(['status' => 'duplicate'], 200);
//         }

    //         //  Parse identifiers from reference
//         $payinfo = explode('-', $ref);
//         [$host, $schid, $amt, $typ, $stid, $ssnid, $trmid, $clsid] = $payinfo;
//         $totalAmountPaid = ($payload['data']['amount'] ?? ($amt * 100)) / 100;

    //         $what = '';

    //         if ($typ == '0') {
//             $what = 'School Fees';

    //         } elseif ($typ == '1') {
//             $what = 'Application Fee';

    //             // Mark registration fee as paid
//             student::where('sid', $stid)->update([
//                 'rfee' => '1'
//             ]);

    //         } elseif ($typ == '2') {
//             $what = 'Acceptance Fee';

    //             // Unique acceptance fee record
//             $uid = $stid . $schid . $clsid;

    //             afeerec::updateOrCreate(
//                 ['uid' => $uid],
//                 [
//                     'stid' => $stid,
//                     'schid' => $schid,
//                     'clsid' => $clsid,
//                     'ssn' => $ssnid,
//                     'trm' => $trmid,
//                     'amt' => intval($totalAmountPaid),
//                 ]
//             );

    //         }

    //         //  Extract metadata
//         $metadata = $payload['data']['metadata'] ?? [];
//         $payheads = $metadata['payheads'] ?? [];
//         $nm = $metadata['name'] ?? '';
//         $exp = $metadata['exp'] ?? '';
//         $lid = $metadata['lid'] ?? '';
//         $eml = $metadata['eml'] ?? '';
//         $tm = $metadata['time'] ?? now()->timestamp;

    //         // $totalAmountPaid = ($payload['data']['amount'] ?? ($amt * 100)) / 100;

    //         //  Get split data (from webhook or stored reference)
//         $splitData = $payload['data']['split']['subaccounts'] ?? [];

    //         if (!$splitData || !is_array($splitData)) {
//             $stored = payment_refs::where('ref', $ref)->first();
//             if ($stored && $stored->subaccounts) {
//                 $splitData = json_decode($stored->subaccounts, true);
//             }
//         }

    //         //  Record payments (split or non-split)
//         if ($splitData && is_array($splitData) && count($splitData) > 0) {
//             Log::info('Split Data detected:', $splitData);

    //             $totalSplitAmount = $totalAmountPaid;
//             $hasRealShares = false;

    //             // Check if there are valid share values
//             foreach ($splitData as $sub) {
//                 if (isset($sub['share']) && floatval($sub['share']) > 0) {
//                     $hasRealShares = true;
//                     break;
//                 }
//             }

    //             // Insert payments
// foreach ($payheads as $ph) {
//     foreach ($splitData as $sub) {

    //         $subCode = $sub['subaccount'] ?? null;
//         $subShare = 0;

    //         if ($hasRealShares) {
//             $shareValue = floatval($sub['share'] ?? 0);
//             $subShare = ($shareValue <= 100)
//                 ? ($totalSplitAmount * $shareValue) / 100
//                 : $shareValue;
//         } else {
//             $subShare = $totalSplitAmount / count($splitData);
//         }

    //         payments::create([
//             'schid' => $schid,
//             'stid' => $stid,
//             'ssnid' => $ssnid,
//             'trmid' => $trmid,
//             'clsid' => $clsid,
//             'name' => $nm,
//             'exp' => $exp,
//             'amt' => $ph['amount'],        //  amount per payhead
//             'share' => $subShare,
//             'pay_head' => $ph['id'],       //  PAYHEAD ID
//             'lid' => $lid,
//             'subaccount_code' => $subCode,
//             'main_ref' => $ref,
//             'total_split_amount' => $totalAmountPaid,
//         ]);
//     }
// }


    //             Log::info("Split payment recorded successfully for ref {$ref}");
//         } else {
//             // Non-split transaction
// foreach ($payheads as $ph) {
//     payments::create([
//         'schid' => $schid,
//         'stid' => $stid,
//         'ssnid' => $ssnid,
//         'trmid' => $trmid,
//         'clsid' => $clsid,
//         'name' => $nm,
//         'exp' => $exp,
//         'pay_head' => $ph['id'],     //  PAYHEAD ID
//         'amt' => $ph['amount'],     //  PAYHEAD AMOUNT
//         'lid' => $lid,
//         'main_ref' => $ref
//     ]);
// }

    //             Log::info("Non-split payment recorded for ref {$ref}");
//         }

    //         //  Update payment_refs
//         payment_refs::updateOrCreate(
//             ['ref' => $ref],
//             [
//                 'amt' => $totalAmountPaid,
//                 'time' => $tm,
//                 'metadata' => json_encode($metadata),
//                 'subaccounts' => json_encode($splitData), // store the actual subaccounts array
//                 'confirmed_at' => now(),
//             ]
//         );

    //         //  Send confirmation email
//         try {
//             $data = [
//                 'name' => $nm,
//                 'subject' => 'Payment Received',
//                 'body' => "Your {$what} payment of {$totalAmountPaid} was received successfully.",
//                 'link' => env('PORTAL_URL') . '/studentLogin/' . $schid,
//             ];
//             Mail::to($eml)->send(new SSSMails($data));
//         } catch (\Exception $e) {
//             Log::error('Failed to send email: ' . $e->getMessage());
//         }

    //         return response()->json(['status' => 'success'], 200);
//     }

    public function paystackConf(Request $request)
    {
        Log::info('------------ PAYSTACK WEBHOOK ARRIVED -----------');

        try {
            $payloadRaw = $request->getContent();
            Log::info('Raw Paystack payload', ['payload' => $payloadRaw]);

            // Decode payload
            $payload = json_decode($payloadRaw, true);
            if (!$payload) {
                Log::error('Failed to decode JSON payload', ['raw' => $payloadRaw]);
                return response()->json(['status' => 'error', 'message' => 'Invalid JSON payload'], 400);
            }

            // Decode nested payload if exists
            if (isset($payload['payload'])) {
                $nested = json_decode($payload['payload'], true);
                if ($nested) {
                    $payload = $nested;
                } else {
                    Log::warning('Failed to decode nested payload, using original');
                }
            }

            // Signature verification
            if (env('APP_ENV') !== 'local') {
                $signature = $request->header('x-paystack-signature');
                if (!$signature || hash_hmac('sha512', $payloadRaw, env('PAYSTACK_SECRET')) !== $signature) {
                    Log::warning('Invalid Paystack signature');
                    return response()->json(['status' => 'unauthorized'], 401);
                }
            }

            // Accept only successful charge events
            $event = $payload['event'] ?? '';
            if (!in_array($event, ['charge.success', 'payment.success'])) {
                Log::info('Ignored Paystack event', ['event' => $event]);
                return response()->json(['status' => 'ignored'], 200);
            }

            $trx = $payload['data'] ?? [];
            $ref = $trx['reference'] ?? null;
            if (!$ref) {
                Log::error('Missing reference', ['payload' => $payload]);
                return response()->json(['status' => 'error', 'message' => 'Missing reference'], 400);
            }

            Log::info('Processing reference', ['ref' => $ref]);

            // Idempotency check
            $refRow = payment_refs::where('ref', $ref)->first();
            if ($refRow && $refRow->confirmed_at) {
                Log::info("Duplicate webhook detected for {$ref}");
                return response()->json(['status' => 'duplicate'], 200);
            }

            // Parse reference
            $parts = explode('-', $ref);
            if (count($parts) < 8) {
                Log::error('Reference format invalid', ['ref' => $ref]);
                return response()->json(['status' => 'error', 'message' => 'Invalid reference format'], 400);
            }
            [$host, $schid, $amt, $typ, $stid, $ssnid, $trmid, $clsid] = $parts;

            // Metadata
            $metadata = $trx['metadata'] ?? [];
            $nm = $metadata['name'] ?? '';
            $exp = $metadata['exp'] ?? '';
            $lid = $metadata['lid'] ?? '';
            $eml = $metadata['eml'] ?? '';
            $payheadIds = $metadata['payhead_ids'] ?? [];
            $tm = $metadata['time'] ?? now()->timestamp;

            // Amount
            $totalAmountPaid = ($trx['amount'] ?? 0) / 100;

            // Payment type
            $what = 'School Fees';
            if ($typ == '1') {
                $what = 'Application Fee';
                student::where('sid', $stid)->update(['rfee' => 1]);
            } elseif ($typ == '2') {
                $what = 'Acceptance Fee';
                $uid = $stid . $schid . $clsid;
                afeerec::updateOrCreate(
                    ['uid' => $uid],
                    [
                        'stid' => $stid,
                        'schid' => $schid,
                        'clsid' => $clsid,
                        'ssn' => $ssnid,
                        'trm' => $trmid,
                        'amt' => intval($totalAmountPaid),
                    ]
                );
            }

            // -------------------------
            // Resolve split data
            // -------------------------
            $splitData = [];

            // Case 1: Stored split from init transaction
            if ($refRow && $refRow->subaccounts) {
                $splitData = json_decode($refRow->subaccounts, true) ?? [];
            }
            // Case 2: Paystack multiple subaccount split
            elseif (!empty($trx['split']['subaccounts'])) {
                $splitData = $trx['split']['subaccounts'];
            }
            // Case 3: Paystack single subaccount payment
            elseif (!empty($trx['subaccount']['subaccount_code'])) {
                $splitData[] = [
                    'subaccount' => $trx['subaccount']['subaccount_code'],
                    'share' => 100,
                ];
            }

            // Case 4: Default subaccount for non-split payments
            if (empty($splitData)) {
                $defaultSub = \DB::table('sub_accounts')
                    ->where('schid', $schid)
                    ->where('clsid', $clsid)
                    ->first();

                if ($defaultSub) {
                    $splitData[] = [
                        'subaccount' => $defaultSub->subaccount_code,
                        'share' => 100,
                    ];
                }
            }

            Log::info('Resolved split data', ['ref' => $ref, 'split' => $splitData]);

            // Record payments
            foreach ($splitData as $sub) {
                try {
                    $subAmount = ($totalAmountPaid * $sub['share']) / 100;
                    payments::create([
                        'schid' => $schid,
                        'stid' => $stid,
                        'ssnid' => $ssnid,
                        'trmid' => $trmid,
                        'clsid' => $clsid,
                        'name' => $nm,
                        'exp' => $exp,
                        'amt' => $totalAmountPaid,
                        'share' => $subAmount,
                        'subaccount_code' => $sub['subaccount'],
                        'main_ref' => $ref,
                        'pay_head' => implode(',', $payheadIds),
                        'total_split_amount' => $totalAmountPaid,
                        'email' => $eml,
                        'lid' => $lid,
                    ]);
                } catch (\Exception $e) {
                    Log::error('Failed to create payment', ['ref' => $ref, 'sub' => $sub, 'error' => $e->getMessage()]);
                }
            }

            // Update payment_refs
            payment_refs::updateOrCreate(
                ['ref' => $ref],
                [
                    'amt' => $totalAmountPaid,
                    'time' => $tm,
                    'metadata' => json_encode($metadata),
                    'subaccounts' => json_encode($splitData),
                    'confirmed_at' => now(),
                ]
            );

            // Send email (non-blocking)
            try {
                Mail::to($eml)->send(new SSSMails([
                    'name' => $nm,
                    'subject' => 'Payment Received',
                    'body' => "Your {$what} payment of {$totalAmountPaid} was received successfully.",
                    'link' => env('PORTAL_URL') . '/studentLogin/' . $schid,
                ]));
            } catch (\Exception $e) {
                Log::error('Failed to send email', ['error' => $e->getMessage()]);
            }

            return response()->json(['status' => 'success'], 200);

        } catch (\Exception $e) {
            Log::error('paystackConf unexpected error', ['error' => $e->getMessage(), 'trace' => $e->getTraceAsString()]);
            return response()->json(['status' => 'error', 'message' => $e->getMessage()], 500);
        }
    }




    //--VENDORS.

    /**
     * @OA\Post(
     *     path="/api/setVendor",
     *     tags={"Accounting"},
     *     summary="Create/Update vendor details",
     *
     *     @OA\RequestBody(
     *         required=true,
     *         @OA\JsonContent(
     *             type="object",
     *             @OA\Property(property="name", type="string"),
     *             @OA\Property(property="phn", type="string"),
     *             @OA\Property(property="addr", type="string"),
     *             @OA\Property(property="bnk", type="string"),
     *             @OA\Property(property="anum", type="string"),
     *             @OA\Property(property="aname", type="string"),
     *             @OA\Property(property="goods", type="string"),
     *             @OA\Property(property="schid", type="string"),
     *         )
     *     ),
     *     @OA\Response(
     *         response=200,
     *         description="Vendor Updated",
     *         @OA\JsonContent(
     *             type="object",
     *             @OA\Property(property="status", type="boolean", example=true),
     *             @OA\Property(property="message", type="string", example="Account Updated")
     *         )
     *     ),
     *     @OA\Response(
     *         response=400,
     *         description="Validation Error",
     *         @OA\JsonContent(
     *             type="object",
     *             @OA\Property(property="status", type="boolean", example=false),
     *             @OA\Property(property="message", type="string", example="Validation Error")
     *         )
     *     )
     * )
     */
    public function setVendor(Request $request)
    {
        $request->validate([
            'name' => 'required',
            'phn' => 'required',
            'addr' => 'required',
            'bnk' => 'required',
            'anum' => 'required',
            'aname' => 'required',
            'goods' => 'required',
            'schid' => 'required',
        ]);
        $data = [
            'name' => $request->name,
            'phn' => $request->phn,
            'addr' => $request->addr,
            'bnk' => $request->bnk,
            'anum' => $request->anum,
            'aname' => $request->aname,
            'goods' => $request->goods,
            'schid' => $request->schid,
        ];
        $vendor = [];
        if ($request->has('id')) {
            $vendor = vendor::where('id', $request->id)->first();
            if ($vendor) {
                $vendor->update($data);
            } else {
                return response()->json([
                    "status" => false,
                    "message" => "Vendor Not Found",
                ]);
            }
        } else {
            $vendor = vendor::create($data);
        }
        return response()->json([
            "status" => true,
            "message" => "Vendor Updated"
        ]);
    }

    /**
     * @OA\Get(
     *     path="/api/getVendorStat/{schid}",
     *     tags={"Accounting"},
     *     summary="Get how many vendors are available",
     *     description="Use this endpoint to get how many vendors are available",
     *
     *     @OA\Parameter(
     *         name="schid",
     *         in="path",
     *         required=true,
     *         description="School ID",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Response(response="200", description="Success", @OA\JsonContent()),
     *     @OA\Response(response="401", description="Unauthorized"),
     * )
     */
    public function getVendorStat($schid)
    {
        $total = vendor::where('schid', $schid)->count();
        return response()->json([
            "status" => true,
            "message" => "Success",
            "pld" => [
                "total" => $total,
            ],
        ]);
    }

    /**
     * @OA\Get(
     *     path="/api/getVendorsBySchool/{schid}",
     *     tags={"Accounting"},
     *     summary="Get all Vendors by School",
     *     description="Use this endpoint to get all Vendors by School",
     *
     *     @OA\Parameter(
     *         name="schid",
     *         in="path",
     *         required=true,
     *         description="School ID",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Parameter(
     *         name="start",
     *         in="query",
     *         required=false,
     *         description="Index to start at",
     *         @OA\Schema(type="integer")
     *     ),
     *     @OA\Parameter(
     *         name="count",
     *         in="query",
     *         required=false,
     *         description="No of records to retrieve",
     *         @OA\Schema(type="integer")
     *     ),
     *     @OA\Response(response="200", description="Success", @OA\JsonContent()),
     *     @OA\Response(response="401", description="Unauthorized"),
     * )
     */
    public function getVendorsBySchool($schid)
    {
        $start = 0;
        $count = 20;
        if (request()->has('start') && request()->has('count')) {
            $start = request()->input('start');
            $count = request()->input('count');
        }
        $pld = vendor::where('schid', $schid)->skip($start)->take($count)->get();
        // Respond
        return response()->json([
            "status" => true,
            "message" => "Success",
            "pld" => $pld,
        ]);
    }

    /**
     * @OA\Get(
     *     path="/api/deleteVendor/{vid}",
     *     tags={"Accounting"},
     *     summary="Delete a Vendor",
     *     description="Use this endpoint to delete a vendor",
     *
     *     @OA\Parameter(
     *         name="vid",
     *         in="path",
     *         required=true,
     *         description="Vendor ID",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Response(response="200", description="Success", @OA\JsonContent()),
     *     @OA\Response(response="401", description="Unauthorized"),
     * )
     */
    public function deleteVendor($vid)
    {
        $pld = vendor::where('id', $vid)->delete();
        // Respond
        return response()->json([
            "status" => true,
            "message" => "Success",
            "pld" => $pld,
        ]);
    }

    /**
     * @OA\Get(
     *     path="/api/getVendor/{vid}",
     *     tags={"Accounting"},
     *     summary="Get a Vendor",
     *     description="Use this endpoint to get a vendor",
     *
     *     @OA\Parameter(
     *         name="vid",
     *         in="path",
     *         required=true,
     *         description="Vendor ID",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Response(response="200", description="Success", @OA\JsonContent()),
     *     @OA\Response(response="401", description="Unauthorized"),
     * )
     */
    public function getVendor($vid)
    {
        $pld = vendor::where('id', $vid)->first();
        // Respond
        return response()->json([
            "status" => true,
            "message" => "Success",
            "pld" => $pld,
        ]);
    }

    /**
     * @OA\Post(
     *     path="/api/setExpense",
     *     tags={"Accounting"},
     *     summary="Create/Update expense details",
     *
     *     @OA\RequestBody(
     *         required=true,
     *         @OA\JsonContent(
     *             type="object",
     *             @OA\Property(property="desc", type="string"),
     *             @OA\Property(property="tang", type="string"),
     *             @OA\Property(property="schid", type="string"),
     *         )
     *     ),
     *     @OA\Response(
     *         response=200,
     *         description="Expense Updated",
     *         @OA\JsonContent(
     *             type="object",
     *             @OA\Property(property="status", type="boolean", example=true),
     *             @OA\Property(property="message", type="string", example="Account Updated")
     *         )
     *     ),
     *     @OA\Response(
     *         response=400,
     *         description="Validation Error",
     *         @OA\JsonContent(
     *             type="object",
     *             @OA\Property(property="status", type="boolean", example=false),
     *             @OA\Property(property="message", type="string", example="Validation Error")
     *         )
     *     )
     * )
     */
    public function setExpense(Request $request)
    {
        $request->validate([
            'desc' => 'required',
            'tang' => 'required',
            'schid' => 'required',
        ]);
        $data = [
            'desc' => $request->desc,
            'tang' => $request->tang,
            'schid' => $request->schid,
        ];
        $expense = [];
        if ($request->has('id')) {
            $expense = expense::where('id', $request->id)->first();
            if ($expense) {
                $expense->update($data);
            } else {
                return response()->json([
                    "status" => false,
                    "message" => "expense Not Found",
                ]);
            }
        } else {
            $expense = expense::create($data);
        }
        return response()->json([
            "status" => true,
            "message" => "expense Updated"
        ]);
    }

    /**
     * @OA\Get(
     *     path="/api/getExpenseStat/{schid}",
     *     tags={"Accounting"},
     *     summary="Get how many expenses are available",
     *     description="Use this endpoint to get how many expense are available",
     *
     *     @OA\Parameter(
     *         name="schid",
     *         in="path",
     *         required=true,
     *         description="School ID",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Response(response="200", description="Success", @OA\JsonContent()),
     *     @OA\Response(response="401", description="Unauthorized"),
     * )
     */
    public function getExpenseStat($schid)
    {
        $total = expense::where('schid', $schid)->count();
        return response()->json([
            "status" => true,
            "message" => "Success",
            "pld" => [
                "total" => $total,
            ],
        ]);
    }

    /**
     * @OA\Get(
     *     path="/api/getExpensesBySchool/{schid}",
     *     tags={"Accounting"},
     *     summary="Get all expenses by School",
     *     description="Use this endpoint to get all expenses by School",
     *
     *     @OA\Parameter(
     *         name="schid",
     *         in="path",
     *         required=true,
     *         description="School ID",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Parameter(
     *         name="start",
     *         in="query",
     *         required=false,
     *         description="Index to start at",
     *         @OA\Schema(type="integer")
     *     ),
     *     @OA\Parameter(
     *         name="count",
     *         in="query",
     *         required=false,
     *         description="No of records to retrieve",
     *         @OA\Schema(type="integer")
     *     ),
     *     @OA\Response(response="200", description="Success", @OA\JsonContent()),
     *     @OA\Response(response="401", description="Unauthorized"),
     * )
     */
    public function getExpensesBySchool($schid)
    {
        $start = 0;
        $count = 20;
        if (request()->has('start') && request()->has('count')) {
            $start = request()->input('start');
            $count = request()->input('count');
        }
        $pld = expense::where('schid', $schid)->skip($start)->take($count)->get();
        // Respond
        return response()->json([
            "status" => true,
            "message" => "Success",
            "pld" => $pld,
        ]);
    }

    /**
     * @OA\Get(
     *     path="/api/deleteExpense/{eid}",
     *     tags={"Accounting"},
     *     summary="Delete an Expense",
     *     description="Use this endpoint to delete a expense",
     *
     *     @OA\Parameter(
     *         name="eid",
     *         in="path",
     *         required=true,
     *         description="Expense ID",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Response(response="200", description="Success", @OA\JsonContent()),
     *     @OA\Response(response="401", description="Unauthorized"),
     * )
     */
    public function deleteExpense($eid)
    {
        $pld = expense::where('id', $eid)->delete();
        // Respond
        return response()->json([
            "status" => true,
            "message" => "Success",
            "pld" => $pld,
        ]);
    }

    /**
     * @OA\Get(
     *     path="/api/getExpense/{eid}",
     *     tags={"Accounting"},
     *     summary="Get an expense",
     *     description="Use this endpoint to get an expense",
     *
     *     @OA\Parameter(
     *         name="eid",
     *         in="path",
     *         required=true,
     *         description="expense ID",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Response(response="200", description="Success", @OA\JsonContent()),
     *     @OA\Response(response="401", description="Unauthorized"),
     * )
     */
    public function getExpense($eid)
    {
        $pld = expense::where('id', $eid)->first();
        // Respond
        return response()->json([
            "status" => true,
            "message" => "Success",
            "pld" => $pld,
        ]);
    }

    /**
     * @OA\Post(
     *     path="/api/setExternalExpenditure",
     *     tags={"Accounting"},
     *     summary="Create/Update expenditure details",
     *
     *     @OA\RequestBody(
     *         required=true,
     *         @OA\JsonContent(
     *             type="object",
     *             @OA\Property(property="vendor", type="string"),
     *             @OA\Property(property="item", type="string"),
     *             @OA\Property(property="pv", type="string"),
     *             @OA\Property(property="name", type="string"),
     *             @OA\Property(property="phn", type="string"),
     *             @OA\Property(property="unit", type="string"),
     *             @OA\Property(property="qty", type="integer"),
     *             @OA\Property(property="mode", type="string"),
     *             @OA\Property(property="schid", type="string"),
     *             @OA\Property(property="time", type="integer"),
     *             @OA\Property(property="ssn", type="string"),
     *             @OA\Property(property="trm", type="string"),
     *         )
     *     ),
     *     @OA\Response(
     *         response=200,
     *         description="expenditure Updated",
     *         @OA\JsonContent(
     *             type="object",
     *             @OA\Property(property="status", type="boolean", example=true),
     *             @OA\Property(property="message", type="string", example="Account Updated")
     *         )
     *     ),
     *     @OA\Response(
     *         response=400,
     *         description="Validation Error",
     *         @OA\JsonContent(
     *             type="object",
     *             @OA\Property(property="status", type="boolean", example=false),
     *             @OA\Property(property="message", type="string", example="Validation Error")
     *         )
     *     )
     * )
     */
    public function setExternalExpenditure(Request $request)
    {
        $request->validate([
            'vendor' => 'required',
            'item' => 'required',
            'pv' => 'required',
            'dets' => 'required',
            'name' => 'required',
            'phn' => 'required',
            'unit' => 'required',
            'qty' => 'required',
            'mode' => 'required',
            'schid' => 'required',
            'time' => 'required',
            'ssn' => 'required',
            'trm' => 'required',
        ]);
        $data = [
            'vendor' => $request->vendor,
            'item' => $request->item,
            'pv' => $request->pv,
            'dets' => $request->dets,
            'name' => $request->name,
            'phn' => $request->phn,
            'unit' => $request->unit,
            'qty' => $request->qty,
            'mode' => $request->mode,
            'ext' => $request->ext,
            'schid' => $request->schid,
            'time' => $request->time,
            'ssn' => $request->ssn,
            'trm' => $request->trm,
        ];
        $expenditure = [];
        if ($request->has('id')) {
            $expenditure = ext_expenditure::where('id', $request->id)->first();
            if ($expenditure) {
                $expenditure->update($data);
            } else {
                return response()->json([
                    "status" => false,
                    "message" => "expenditure Not Found",
                ]);
            }
        } else {
            $expenditure = ext_expenditure::create($data);
        }
        return response()->json([
            "status" => true,
            "message" => "expenditure Updated"
        ]);
    }

    /**
     * @OA\Get(
     *     path="/api/getExternalExpenditureStat/{schid}/{ssn}/{trm}",
     *     tags={"Accounting"},
     *     summary="Get how many expenditure are available",
     *     description="Use this endpoint to get how many expenditure are available",
     *
     *     @OA\Parameter(
     *         name="schid",
     *         in="path",
     *         required=true,
     *         description="School ID",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Parameter(
     *         name="ssn",
     *         in="path",
     *         required=true,
     *         description="Session ID",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Parameter(
     *         name="trm",
     *         in="path",
     *         required=true,
     *         description="Term ID",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Response(response="200", description="Success", @OA\JsonContent()),
     *     @OA\Response(response="401", description="Unauthorized"),
     * )
     */
    public function getExternalExpenditureStat($schid, $ssn, $trm)
    {
        $query = ext_expenditure::query();
        $query->where('schid', $schid);
        if ($ssn !== '0') {
            $query->where('ssn', $ssn);
        }
        if ($trm !== '0') {
            $query->where('trm', $trm);
        }
        $total = $query->count();
        return response()->json([
            "status" => true,
            "message" => "Success",
            "pld" => [
                "total" => $total,
            ],
        ]);
    }

    /**
     * @OA\Get(
     *     path="/api/getExternalExpenditures/{schid}/{ssn}/{trm}",
     *     tags={"Accounting"},
     *     summary="Get all expenditures by School, Session and Term",
     *     description="Use this endpoint to get all expenditures by School",
     *
     *     @OA\Parameter(
     *         name="schid",
     *         in="path",
     *         required=true,
     *         description="School ID",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Parameter(
     *         name="ssn",
     *         in="path",
     *         required=true,
     *         description="Session ID",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Parameter(
     *         name="trm",
     *         in="path",
     *         required=true,
     *         description="Term ID",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Parameter(
     *         name="start",
     *         in="query",
     *         required=false,
     *         description="Index to start at",
     *         @OA\Schema(type="integer")
     *     ),
     *     @OA\Parameter(
     *         name="count",
     *         in="query",
     *         required=false,
     *         description="No of records to retrieve",
     *         @OA\Schema(type="integer")
     *     ),
     *     @OA\Response(response="200", description="Success", @OA\JsonContent()),
     *     @OA\Response(response="401", description="Unauthorized"),
     * )
     */
    public function getExternalExpenditures($schid, $ssn, $trm)
    {
        $start = 0;
        $count = 20;
        if (request()->has('start') && request()->has('count')) {
            $start = request()->input('start');
            $count = request()->input('count');
        }
        $query = ext_expenditure::query();
        $query->where('schid', $schid);
        if ($ssn !== '0') {
            $query->where('ssn', $ssn);
        }
        if ($trm !== '0') {
            $query->where('trm', $trm);
        }
        $pld = $query->skip($start)->take($count)->get();
        // Respond
        return response()->json([
            "status" => true,
            "message" => "Success",
            "pld" => $pld,
        ]);
    }

    /**
     * @OA\Get(
     *     path="/api/deleteExternalExpenditure/{eid}",
     *     tags={"Accounting"},
     *     summary="Delete an expenditure",
     *     description="Use this endpoint to delete an expenditure",
     *
     *     @OA\Parameter(
     *         name="eid",
     *         in="path",
     *         required=true,
     *         description="expenditure ID",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Response(response="200", description="Success", @OA\JsonContent()),
     *     @OA\Response(response="401", description="Unauthorized"),
     * )
     */
    public function deleteExternalExpenditure($eid)
    {
        $pld = ext_expenditure::where('id', $eid)->delete();
        // Respond
        return response()->json([
            "status" => true,
            "message" => "Success",
            "pld" => $pld,
        ]);
    }

    /**
     * @OA\Get(
     *     path="/api/getExternalExpenditure/{eid}",
     *     tags={"Accounting"},
     *     summary="Get an expenditure",
     *     description="Use this endpoint to get an expenditure",
     *
     *     @OA\Parameter(
     *         name="eid",
     *         in="path",
     *         required=true,
     *         description="expenditure ID",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Response(response="200", description="Success", @OA\JsonContent()),
     *     @OA\Response(response="401", description="Unauthorized"),
     * )
     */
    public function getExternalExpenditure($eid)
    {
        $pld = ext_expenditure::where('id', $eid)->first();
        // Respond
        return response()->json([
            "status" => true,
            "message" => "Success",
            "pld" => $pld,
        ]);
    }

    /**
     * @OA\Get(
     *     path="/api/getExternalExpendituresByFilter/{schid}/{ssn}/{trm}",
     *     tags={"Accounting"},
     *     summary="Get all expenditures by School, Session and Term",
     *     description="Use this endpoint to get all expenditures by School",
     *
     *     @OA\Parameter(
     *         name="schid",
     *         in="path",
     *         required=true,
     *         description="School ID",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Parameter(
     *         name="ssn",
     *         in="path",
     *         required=true,
     *         description="Session ID",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Parameter(
     *         name="trm",
     *         in="path",
     *         required=true,
     *         description="Term ID",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Parameter(
     *         name="start",
     *         in="query",
     *         required=false,
     *         description="Index to start at",
     *         @OA\Schema(type="integer")
     *     ),
     *     @OA\Parameter(
     *         name="count",
     *         in="query",
     *         required=false,
     *         description="No of records to retrieve",
     *         @OA\Schema(type="integer")
     *     ),
     *     @OA\Parameter(
     *         name="vendor",
     *         in="query",
     *         required=false,
     *         description="Filter by vendor",
     *         @OA\Schema(type="integer")
     *     ),
     *     @OA\Parameter(
     *         name="item",
     *         in="query",
     *         required=false,
     *         description="Filter by expense heading",
     *         @OA\Schema(type="integer")
     *     ),
     *     @OA\Parameter(
     *         name="time",
     *         in="query",
     *         required=false,
     *         description="Filter by time",
     *         @OA\Schema(type="integer")
     *     ),
     *     @OA\Parameter(
     *         name="pv",
     *         in="query",
     *         required=false,
     *         description="Filter by pv",
     *         @OA\Schema(type="integer")
     *     ),
     *     @OA\Parameter(
     *         name="mode",
     *         in="query",
     *         required=false,
     *         description="Filter by mode",
     *         @OA\Schema(type="integer")
     *     ),
     *     @OA\Parameter(
     *         name="unit",
     *         in="query",
     *         required=false,
     *         description="Filter by unit",
     *         @OA\Schema(type="integer")
     *     ),
     *     @OA\Parameter(
     *         name="qty",
     *         in="query",
     *         required=false,
     *         description="Filter by qty",
     *         @OA\Schema(type="integer")
     *     ),
     *     @OA\Response(response="200", description="Success", @OA\JsonContent()),
     *     @OA\Response(response="401", description="Unauthorized"),
     * )
     */
    public function getExternalExpendituresByFilter($schid, $ssn, $trm)
    {
        $start = request()->input('start', 0); // Default start
        $count = request()->input('count', 20); // Default count

        $query = ext_expenditure::query();

        // Base filters
        $query->where('schid', $schid);

        if ($ssn !== '0') {
            $query->where('ssn', $ssn);
        }

        if ($trm !== '0') {
            $query->where('trm', $trm);
        }

        // Filter and sort for fields: time, vendor, pv, mode, unit, qty
        $fields = ['time', 'vendor', 'pv', 'mode', 'unit', 'qty', 'item'];
        foreach ($fields as $field) {
            $qValue = request()->input($field, null);
            if ($qValue !== null && $qValue !== '-1') {
                if ($field === 'time') {
                    if (strpos($qValue, '-') !== false) {
                        $compo = explode("-", $qValue);
                        if (count($compo) == 2) {
                            $frm = $compo[0];
                            $to = $compo[1];
                            $query->where($field, '>=', $frm);
                            $query->where($field, '<=', $to);
                        }
                    }
                } else {
                    $query->where($field, $qValue);
                }
            }
        }

        // Pagination
        $pld = $query->skip($start)->take($count)->get();

        // Respond
        return response()->json([
            "status" => true,
            "message" => "Success",
            "pld" => $pld,
        ]);
    }

    /**
     * @OA\Post(
     *     path="/api/setInternalExpenditure",
     *     tags={"Accounting"},
     *     summary="Create/Update expenditure details",
     *
     *     @OA\RequestBody(
     *         required=true,
     *         @OA\JsonContent(
     *             type="object",
     *             @OA\Property(property="name", type="string"),
     *             @OA\Property(property="purp", type="string"),
     *             @OA\Property(property="amt", type="string"),
     *             @OA\Property(property="mode", type="string"),
     *             @OA\Property(property="schid", type="string"),
     *             @OA\Property(property="time", type="integer"),
     *             @OA\Property(property="ssn", type="string"),
     *             @OA\Property(property="trm", type="string"),
     *         )
     *     ),
     *     @OA\Response(
     *         response=200,
     *         description="expenditure Updated",
     *         @OA\JsonContent(
     *             type="object",
     *             @OA\Property(property="status", type="boolean", example=true),
     *             @OA\Property(property="message", type="string", example="Account Updated")
     *         )
     *     ),
     *     @OA\Response(
     *         response=400,
     *         description="Validation Error",
     *         @OA\JsonContent(
     *             type="object",
     *             @OA\Property(property="status", type="boolean", example=false),
     *             @OA\Property(property="message", type="string", example="Validation Error")
     *         )
     *     )
     * )
     */
    public function setInternalExpenditure(Request $request)
    {
        $request->validate([
            'name' => 'required',
            'purp' => 'required',
            'amt' => 'required',
            'mode' => 'required',
            'schid' => 'required',
            'time' => 'required',
            'ssn' => 'required',
            'trm' => 'required',
        ]);
        $data = [
            'name' => $request->name,
            'purp' => $request->purp,
            'amt' => $request->amt,
            'mode' => $request->mode,
            'ext' => $request->ext,
            'schid' => $request->schid,
            'time' => $request->time,
            'ssn' => $request->ssn,
            'trm' => $request->trm,
        ];
        $expenditure = [];
        if ($request->has('id')) {
            $expenditure = in_expenditure::where('id', $request->id)->first();
            if ($expenditure) {
                $expenditure->update($data);
            } else {
                return response()->json([
                    "status" => false,
                    "message" => "expenditure Not Found",
                ]);
            }
        } else {
            $expenditure = in_expenditure::create($data);
        }
        return response()->json([
            "status" => true,
            "message" => "expenditure Updated"
        ]);
    }

    /**
     * @OA\Get(
     *     path="/api/getInternalExpenditureStat/{schid}/{ssn}/{trm}",
     *     tags={"Accounting"},
     *     summary="Get how many expenditure are available",
     *     description="Use this endpoint to get how many expenditure are available",
     *
     *     @OA\Parameter(
     *         name="schid",
     *         in="path",
     *         required=true,
     *         description="School ID",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Parameter(
     *         name="ssn",
     *         in="path",
     *         required=true,
     *         description="Session ID",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Parameter(
     *         name="trm",
     *         in="path",
     *         required=true,
     *         description="Term ID",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Response(response="200", description="Success", @OA\JsonContent()),
     *     @OA\Response(response="401", description="Unauthorized"),
     * )
     */
    public function getInternalExpenditureStat($schid, $ssn, $trm)
    {
        $query = in_expenditure::query();
        if ($ssn !== '0') {
            $query->where('ssn', $ssn);
        }
        if ($trm !== '0') {
            $query->where('trm', $trm);
        }
        $total = $query->count();
        return response()->json([
            "status" => true,
            "message" => "Success",
            "pld" => [
                "total" => $total,
            ],
        ]);
    }

    /**
     * @OA\Get(
     *     path="/api/getInternalExpenditures/{schid}/{ssn}/{trm}",
     *     tags={"Accounting"},
     *     summary="Get all expenditures by School, Session and Term",
     *     description="Use this endpoint to get all expenditures by School",
     *
     *     @OA\Parameter(
     *         name="schid",
     *         in="path",
     *         required=true,
     *         description="School ID",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Parameter(
     *         name="ssn",
     *         in="path",
     *         required=true,
     *         description="Session ID",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Parameter(
     *         name="trm",
     *         in="path",
     *         required=true,
     *         description="Term ID",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Parameter(
     *         name="start",
     *         in="query",
     *         required=false,
     *         description="Index to start at",
     *         @OA\Schema(type="integer")
     *     ),
     *     @OA\Parameter(
     *         name="count",
     *         in="query",
     *         required=false,
     *         description="No of records to retrieve",
     *         @OA\Schema(type="integer")
     *     ),
     *     @OA\Response(response="200", description="Success", @OA\JsonContent()),
     *     @OA\Response(response="401", description="Unauthorized"),
     * )
     */
    public function getInternalExpenditures($schid, $ssn, $trm)
    {
        $start = 0;
        $count = 20;
        if (request()->has('start') && request()->has('count')) {
            $start = request()->input('start');
            $count = request()->input('count');
        }
        $query = in_expenditure::query();
        if ($ssn !== '0') {
            $query->where('ssn', $ssn);
        }
        if ($trm !== '0') {
            $query->where('trm', $trm);
        }
        $pld = $query->skip($start)->take($count)->get();
        // Respond
        return response()->json([
            "status" => true,
            "message" => "Success",
            "pld" => $pld,
        ]);
    }

    /**
     * @OA\Get(
     *     path="/api/deleteInternalExpenditure/{eid}",
     *     tags={"Accounting"},
     *     summary="Delete an expenditure",
     *     description="Use this endpoint to delete an expenditure",
     *
     *     @OA\Parameter(
     *         name="eid",
     *         in="path",
     *         required=true,
     *         description="expenditure ID",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Response(response="200", description="Success", @OA\JsonContent()),
     *     @OA\Response(response="401", description="Unauthorized"),
     * )
     */
    public function deleteInternalExpenditure($eid)
    {
        $pld = in_expenditure::where('id', $eid)->delete();
        // Respond
        return response()->json([
            "status" => true,
            "message" => "Success",
            "pld" => $pld,
        ]);
    }

    /**
     * @OA\Get(
     *     path="/api/getInternalExpenditure/{eid}",
     *     tags={"Accounting"},
     *     summary="Get an expenditure",
     *     description="Use this endpoint to get an expenditure",
     *
     *     @OA\Parameter(
     *         name="eid",
     *         in="path",
     *         required=true,
     *         description="expenditure ID",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Response(response="200", description="Success", @OA\JsonContent()),
     *     @OA\Response(response="401", description="Unauthorized"),
     * )
     */
    public function getInternalExpenditure($eid)
    {
        $pld = in_expenditure::where('id', $eid)->first();
        // Respond
        return response()->json([
            "status" => true,
            "message" => "Success",
            "pld" => $pld,
        ]);
    }

    /**
     * @OA\Get(
     *     path="/api/getInternalExpendituresByFilter/{schid}/{ssn}/{trm}",
     *     tags={"Accounting"},
     *     summary="Get all expenditures by School, Session and Term",
     *     description="Use this endpoint to get all expenditures by School",
     *
     *     @OA\Parameter(
     *         name="schid",
     *         in="path",
     *         required=true,
     *         description="School ID",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Parameter(
     *         name="ssn",
     *         in="path",
     *         required=true,
     *         description="Session ID",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Parameter(
     *         name="trm",
     *         in="path",
     *         required=true,
     *         description="Term ID",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Parameter(
     *         name="start",
     *         in="query",
     *         required=false,
     *         description="Index to start at",
     *         @OA\Schema(type="integer")
     *     ),
     *     @OA\Parameter(
     *         name="count",
     *         in="query",
     *         required=false,
     *         description="No of records to retrieve",
     *         @OA\Schema(type="integer")
     *     ),
     *     @OA\Parameter(
     *         name="amt",
     *         in="query",
     *         required=false,
     *         description="Filter by amount",
     *         @OA\Schema(type="integer")
     *     ),
     *     @OA\Parameter(
     *         name="time",
     *         in="query",
     *         required=false,
     *         description="Filter by time",
     *         @OA\Schema(type="integer")
     *     ),
     *     @OA\Parameter(
     *         name="mode",
     *         in="query",
     *         required=false,
     *         description="Filter by mode",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Response(response="200", description="Success", @OA\JsonContent()),
     *     @OA\Response(response="401", description="Unauthorized"),
     * )
     */
    public function getInternalExpendituresByFilter($schid, $ssn, $trm)
    {
        $start = request()->input('start', 0); // Default start
        $count = request()->input('count', 20); // Default count

        $query = in_expenditure::query();

        // Filter by session and term
        if ($ssn !== '0') {
            $query->where('ssn', $ssn);
        }

        if ($trm !== '0') {
            $query->where('trm', $trm);
        }

        // Handle sorting for amt, time, and mode
        $fields = ['time', 'mode'];
        foreach ($fields as $field) {
            $qValue = request()->input($field, null);
            if ($qValue !== null && $qValue !== '-1') {
                if ($field === 'time') {
                    if (strpos($qValue, '-') !== false) {
                        $compo = explode("-", $qValue);
                        if (count($compo) == 2) {
                            $frm = $compo[0];
                            $to = $compo[1];
                            $query->where($field, '>=', $frm);
                            $query->where($field, '<=', $to);
                        }
                    }
                } else {
                    $query->where($field, $qValue);
                }
            }
        }

        // Pagination
        $pld = $query->skip($start)->take($count)->get();

        // Respond
        return response()->json([
            "status" => true,
            "message" => "Success",
            "pld" => $pld,
        ]);
    }



    /**
     * @OA\Get(
     *     path="/api/getSchoolHighlights/{schid}/{ssnid}/{trmid}",
     *     tags={"Api"},
     *     summary="Get a particular school's highlighs",
     *     description="Use this endpoint to get a ...",
     *     security={{"bearerAuth": {}}},
     *     @OA\Parameter(
     *         name="schid",
     *         in="path",
     *         required=true,
     *         description="School ID",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Parameter(
     *         name="ssnid",
     *         in="path",
     *         required=true,
     *         description="Session ID",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Parameter(
     *         name="trmid",
     *         in="path",
     *         required=true,
     *         description="Term ID",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Response(response="200", description="Success", @OA\JsonContent()),
     *     @OA\Response(response="401", description="Unauthorized"),
     * )
     */
    public function getSchoolHighlights($schid, $ssnid, $trmid)
    {
        $pendingStudents = student::where('schid', $schid)->where('stat', '0')->count();

        $approvedStudentsMale = student::join('student_basic_data', 'student.sid', '=', 'student_basic_data.user_id')
            ->where('student.schid', $schid)
            ->where('student.stat', '1')
            ->where('student_basic_data.sex', 'M')
            ->count();
        $approvedStudentsFemale = student::join('student_basic_data', 'student.sid', '=', 'student_basic_data.user_id')
            ->where('student.schid', $schid)
            ->where('student.stat', '1')
            ->where('student_basic_data.sex', 'F')
            ->count();


        $activeStudentsMale = old_student::join('student_basic_data', 'old_student.sid', '=', 'student_basic_data.user_id')
            ->where('old_student.schid', $schid)
            ->where('old_student.status', 'active')
            ->where('old_student.ssn', $ssnid)
            ->where('student_basic_data.sex', 'M')
            ->distinct('old_student.sid')
            ->count();

        $activeStudentsFemale = old_student::join('student_basic_data', 'old_student.sid', '=', 'student_basic_data.user_id')
            ->where('old_student.schid', $schid)
            ->where('old_student.status', 'active')
            ->where('old_student.ssn', $ssnid)
            ->where('student_basic_data.sex', 'F')
            ->distinct('old_student.sid')
            ->count();



        // Alumni
        $alumniStudentsMale = alumni::join('old_student', 'alumnis.stid', '=', 'old_student.sid')
            ->join('student_basic_data', 'alumnis.stid', '=', 'student_basic_data.user_id')
            ->where('alumnis.schid', $schid)
            ->where('old_student.status', 'inactive')
            ->where('old_student.ssn', $ssnid)     // filter by SSN
            ->where('student_basic_data.sex', 'M')
            ->distinct('alumnis.stid')
            ->count();


        $alumniStudentsFemale = alumni::join('old_student', 'alumnis.stid', '=', 'old_student.sid')
            ->join('student_basic_data', 'alumnis.stid', '=', 'student_basic_data.user_id')
            ->where('alumnis.schid', $schid)
            ->where('old_student.status', 'inactive')
            ->where('old_student.ssn', $ssnid)     // filter by SSN
            ->where('student_basic_data.sex', 'F')
            ->distinct('alumnis.stid')
            ->count();


        $alumniStudents = alumni::join('old_student', 'alumnis.stid', '=', 'old_student.sid')
            ->where('alumnis.schid', $schid)
            ->where('old_student.status', 'inactive')
            ->where('old_student.ssn', $ssnid)     // filter by SSN
            ->distinct('alumnis.stid')
            ->count();



        $activeLearners = old_student::join('student_basic_data', 'old_student.sid', '=', 'student_basic_data.user_id')
            ->where('old_student.schid', $schid)
            ->where('old_student.status', 'active')
            ->where('old_student.ssn', $ssnid)
            ->distinct('old_student.sid')
            ->count();

        $declinedStudents = student::where('schid', $schid)->where('stat', '2')->count();
        $deletedStudents = student::where('schid', $schid)->where('stat', '3')->count();

        $pendingStaff = staff::where('schid', $schid)->where('stat', '0')->count();

        $approvedStaffMale = staff::join('staff_basic_data', 'staff.sid', '=', 'staff_basic_data.user_id')
            ->where('staff.schid', $schid)
            ->where('staff.stat', '1')
            ->where('staff_basic_data.sex', 'M')
            ->count();
        $approvedStaffFemale = staff::join('staff_basic_data', 'staff.sid', '=', 'staff_basic_data.user_id')
            ->where('staff.schid', $schid)
            ->where('staff.stat', '1')
            ->where('staff_basic_data.sex', 'F')
            ->count();



        $activeStaffMale = old_staff::join('staff_basic_data', 'old_staff.sid', '=', 'staff_basic_data.user_id')
            ->where('old_staff.schid', $schid)
            ->where('old_staff.status', 'active')
            ->where('staff_basic_data.sex', 'M')
            ->where('old_staff.ssn', $ssnid)
            ->distinct('old_staff.sid')
            ->count();
        $activeStaffFemale = old_staff::join('staff_basic_data', 'old_staff.sid', '=', 'staff_basic_data.user_id')
            ->where('old_staff.schid', $schid)
            ->where('old_staff.status', 'active')
            ->where('old_staff.ssn', $ssnid)
            ->where('staff_basic_data.sex', 'F')
            ->distinct('old_staff.sid')
            ->count();

        $activeStaff = old_staff::join('staff_basic_data', 'old_staff.sid', '=', 'staff_basic_data.user_id')
            ->where('old_staff.schid', $schid)
            ->where('old_staff.status', 'active')
            ->where('old_staff.ssn', $ssnid)
            ->distinct('old_staff.sid')
            ->count();

        $declinedStaff = staff::where('schid', $schid)->where('stat', '2')->count();
        $deletedStaff = staff::where('schid', $schid)->where('stat', '3')->count();

        $totalStudentPaidRegFee = student::where('schid', $schid)->where('rfee', "1")->count();
        $totalStudentNotPaidRegFee = student::where('schid', $schid)->where('rfee', '!=', "1")->count();

        $totalRevenueOthers = payments::where('schid', $schid)
            ->select(DB::raw("COALESCE(SUM(CAST(amt AS DECIMAL(15,2))), 0) as total"))
            ->value('total');

        $paidStudentsCount = student::where('schid', $schid)
            ->whereExists(function ($query) use ($schid, $ssnid, $trmid) {
                $query->select(DB::raw(1))
                    ->from('payments')
                    ->whereColumn('payments.stid', 'student.sid')
                    ->where('payments.schid', $schid)
                    ->where('payments.ssnid', $ssnid)
                    ->where('payments.trmid', $trmid);
            })
            ->count();

        $notPaidStudentsCount = student::where('schid', $schid)
            ->whereNotExists(function ($query) use ($schid, $ssnid, $trmid) {
                $query->select(DB::raw(1))
                    ->from('payments')
                    ->whereColumn('payments.stid', 'student.sid')
                    ->where('payments.schid', $schid)
                    ->where('payments.ssnid', $ssnid)
                    ->where('payments.trmid', $trmid);
            })
            ->count();

        // $totalAmountPaidSchoolFees = student::where('student.schid', $schid)
        // ->whereExists(function ($query) use ($schid, $ssnid, $trmid) {
        //     $query->select(DB::raw(1))
        //         ->from('payments')
        //         ->whereColumn('payments.stid', 'student.sid')
        //         ->where('payments.schid', $schid)
        //         ->where('payments.ssnid', $ssnid)
        //         ->where('payments.trmid', $trmid);
        // })
        // ->join('payments', 'payments.stid', '=', 'student.sid')
        // ->join('clspay', function($join) use ($schid, $ssnid, $trmid) {
        //     $join->on('clspay.clsid', '=', 'payments.clsid')
        //         ->where('clspay.schid', $schid)
        //         ->where('clspay.sesid', $ssnid)
        //         ->where('clspay.trmid', $trmid);
        // })
        // ->sum(DB::raw('IFNULL(CAST(clspay.amt AS DECIMAL(10, 2)), 0)'));

        // $totalAmountUnpaidSchoolFees = student::where('student.schid', $schid)
        // ->whereNotExists(function ($query) use ($schid, $ssnid, $trmid) {
        //     $query->select(DB::raw(1))
        //         ->from('payments')
        //         ->whereColumn('payments.stid', 'student.sid')
        //         ->where('payments.schid', $schid)
        //         ->where('payments.ssnid', $ssnid)
        //         ->where('payments.trmid', $trmid);
        // })
        // ->leftJoin('student_academic_data', 'student.sid', '=', 'student_academic_data.user_id')  // Left join with student_academic_data
        // ->leftJoin('clspay', function($join) use ($schid, $ssnid, $trmid) {
        //     $join->on('clspay.clsid', '=', 'student_academic_data.new_class_main')  // Left join with clspay using new_class_main
        //         ->where('clspay.schid', $schid)
        //         ->where('clspay.sesid', $ssnid)
        //         ->where('clspay.trmid', $trmid);
        // })
        // ->sum(DB::raw('IFNULL(CAST(clspay.amt AS DECIMAL(10, 2)), 0)'));

        return response()->json([
            "status" => true,
            "message" => "Success",
            "pld" => [
                "pendingStudents" => $pendingStudents,
                "approvedStudentsMale" => $approvedStudentsMale,
                "approvedStudentsFemale" => $approvedStudentsFemale,
                "activeStudentsMale" => $activeStudentsMale,
                "activeStudentsFemale" => $activeStudentsFemale,
                "declinedStudents" => $declinedStudents,
                "deletedStudents" => $deletedStudents,
                "totalActiveLearners" => $activeLearners,
                "alumniStudentsMale" => $alumniStudentsMale,
                "alumniStudentsFemale" => $alumniStudentsFemale,
                "totalAlumniStudents" => $alumniStudents,

                "pendingStaff" => $pendingStaff,
                "approvedStaffMale" => $approvedStaffMale,
                "approvedStaffFemale" => $approvedStaffFemale,
                "activeStaffMale" => $activeStaffMale,
                "activeStaffFemale" => $activeStaffFemale,
                "declinedStaff" => $declinedStaff,
                "deletedStaff" => $deletedStaff,
                "totalActiveStaff" => $activeStaff,

                "totalStudentPaidRegFee" => $totalStudentPaidRegFee,
                "totalStudentNotPaidRegFee" => $totalStudentNotPaidRegFee,
                "totalRevenueOthers" => $totalRevenueOthers,
                "paidStudentsCount" => $paidStudentsCount,
                "notPaidStudentsCount" => $notPaidStudentsCount,

            ],
        ]);
    }

    //-- ADMIN

    /**
     * @OA\Post(
     *     path="/api/resetDefaultPassword",
     *     tags={"Admin"},
     *     security={{"bearerAuth": {}}},
     *     summary="change user password to default",
     *     @OA\RequestBody(
     *         required=true,
     *         @OA\JsonContent(
     *             type="object",
     *             @OA\Property(property="uid", type="string"),
     *         )
     *     ),
     *     @OA\Response(response="200", description="Password reset token sent to mail"),
     * )
     */
    public function resetDefaultPassword(Request $request)
    {
        //Data validation
        $request->validate([
            "uid" => "required",
        ]);
        $usr = User::where("id", $request->uid)->first();
        if ($usr) {
            $usr->update([
                "password" => bcrypt("123456"),
            ]);
            return response()->json([
                "status" => true,
                "message" => "Success. Please tell user to login again"
            ]);
        }
        return response()->json([
            "status" => false,
            "message" => "User not found",
        ], 400);
    }

    /**
     * @OA\Post(
     *     path="/api/setAdmin",
     *     tags={"Admin"},
     *     summary="Set or update admin details",
     *     description="Set or update admin details. `uid` is unique to each person occupying that particular role. Its a way for you to differentiate people that occupy that office",
     *     security={{"bearerAuth": {}}},
     *     @OA\RequestBody(
     *         required=true,
     *         @OA\JsonContent(
     *             type="object",
     *             @OA\Property(property="uid", type="string", description="A unique ID for the user. "),
     *             @OA\Property(property="meml", type="string", format="email",),
     *             @OA\Property(property="eml", type="string", format="email",),
     *             @OA\Property(property="lname", type="string", example="Doe"),
     *             @OA\Property(property="oname", type="string", example="John"),
     *             @OA\Property(property="zone", type="string", example="A zone ID"),
     *             @OA\Property(property="dob", type="string", format="string", example="1625097600000"),
     *             @OA\Property(property="state", type="string", example="Lagos"),
     *             @OA\Property(property="lga", type="string", example="Ikeja"),
     *             @OA\Property(property="phn", type="string", example="08012345678"),
     *             @OA\Property(property="role", type="string", example="Manager"),
     *             @OA\Property(property="addr", type="string", example="123 Main St"),
     *             @OA\Property(property="prev", type="string", example="Previous Role"),
     *             @OA\Property(property="date", type="string", format="string", example="1625097600000"),
     *             @OA\Property(property="level", type="string", example="1"),
     *             @OA\Property(property="verif", type="string", example="0")
     *         )
     *     ),
     *     @OA\Response(
     *         response=200,
     *         description="Admin Added",
     *         @OA\JsonContent(
     *             type="object",
     *             @OA\Property(property="status", type="boolean", example=true),
     *             @OA\Property(property="message", type="string", example="Admin Added")
     *         )
     *     ),
     *     @OA\Response(
     *         response=400,
     *         description="Validation Error",
     *         @OA\JsonContent(
     *             type="object",
     *             @OA\Property(property="status", type="boolean", example=false),
     *             @OA\Property(property="message", type="string", example="Validation Error")
     *         )
     *     )
     * )
     */
    public function setAdmin(Request $request)
    {
        $request->validate([
            "uid" => "required",
            "meml" => "required",
            "eml" => "required",
            "lname" => "required",
            "oname" => "required",
            "zone" => "required",
            "dob" => "required",
            "state" => "required",
            "lga" => "required",
            "phn" => "required",
            "role" => "required",
            "addr" => "required",
            "prev" => "required",
            "date" => "required",
            "level" => "required|integer",
            "verif" => "required",
        ]);
        $typ = 'a';
        $main_email = $request->meml;
        $usr = User::where("email", $main_email)->where("typ", $typ)->first();
        if (!$usr) {
            $usr = User::create([
                "email" => $main_email,
                "typ" => $typ,
                "password" => bcrypt('123456'),
            ]);
        }
        silo_user::updateOrCreate(
            ["uid" => $request->uid,],
            [
                "eml" => $request->eml,
                "lname" => $request->lname,
                "oname" => $request->oname,
                "zone" => $request->zone,
                "dob" => $request->dob,
                "state" => $request->state,
                "lga" => $request->lga,
                "phn" => $request->phn,
                "role" => $request->role,
                "addr" => $request->addr,
                "prev" => $request->prev,
                "date" => $request->date,
                "level" => $request->level,
                "verif" => $request->verif,
            ]
        );
        // Respond
        return response()->json([
            "status" => true,
            "message" => "Admin Added"
        ]);
    }

    /**
     * @OA\Post(
     *     path="/api/adminLogin",
     *     tags={"Unprotected"},
     *     summary="Login as admin",
     *     @OA\RequestBody(
     *         required=true,
     *         @OA\JsonContent(
     *             type="object",
     *             @OA\Property(property="email", type="string", format="email"),
     *             @OA\Property(property="password", type="string"),
     *         )
     *     ),
     *     @OA\Response(response="200", description="Login Successfully"),
     * )
     */
    public function adminLogin(Request $request)
    {
        //Data validation
        $request->validate([
            "email" => "required|email",
            "password" => "required",
        ]);
        $typ = 'a';
        $usr = User::where("email", $request->email)->where('typ', $typ)->first();
        if ($usr) {
            $token = JWTAuth::attempt([
                "email" => $request->email,
                "password" => $request->password,
            ]);
            if (!empty($token)) {
                return response()->json([
                    "status" => true,
                    "message" => "User login successfully",
                    "token" => $token,
                    "pld" => $usr
                ]);
            }
        } else {
            $portalUrl = env('PORTAL_URL');
            $adminEml = 'admin@' . substr($portalUrl, 14);
            if ($request->email == $adminEml) {
                $usr = User::create([
                    "email" => $adminEml,
                    "typ" => $typ,
                    "verif" => '1',
                    "password" => bcrypt('123456'),
                ]);
                return response()->json([
                    "status" => false,
                    "message" => "Please try again",
                ], 400);
            }
        }
        return response()->json([
            "status" => false,
            "message" => "Invalid login details",
        ], 400);
    }

    /**
     * @OA\Post(
     *     path="/api/resolveIDtoEmail",
     *     tags={"Unprotected"},
     *     summary="Resolve Staff/Student/Partner ID to their email",
     *     @OA\RequestBody(
     *         required=true,
     *         @OA\JsonContent(
     *             type="object",
     *             @OA\Property(property="stid", type="string"),
     *             @OA\Property(property="typ", type="string"),
     *             @OA\Property(property="schid", type="string"),
     *         )
     *     ),
     *     @OA\Response(
     *         response="200",
     *         description="Action successful",
     *     ),
     * )
     */
    public function resolveIDtoEmail(Request $request)
    {
        //Data validation
        $request->validate([
            "stid" => "required",
            "typ" => "required",
            "schid" => "required",
        ]);
        $typ = $request->typ;
        if ($typ == 'w') {
            $stf = [];
            $compo = explode("/", $request->stid);
            if (count($compo) == 3) {
                $sch3 = $compo[0];
                $count = $compo[2];
                $stf = staff::where("schid", $request->schid)->where("count", $count)->first();
            } else {
                $stf = staff::where("cuid", $request->stid)->first();
            }
            if ($stf) {
                $usr = User::where("typ", $typ)->where("id", $stf->sid)->first();
                return response()->json([
                    "status" => true,
                    "message" => "successful",
                    "pld" => $usr,
                ]);
            }
        }
        if ($typ == 'z') {
            $std = [];
            $compo = explode("/", $request->stid);
            if (count($compo) == 4) {
                $sch3 = $compo[0];
                $year = $compo[1];
                $term = $compo[2];
                $count = $compo[3];
                $std = student::where("schid", $request->schid)->where("year", $year)->where("term", $term)
                    ->where("count", $count)->first();
            } else {
                $std = student::where("cuid", $request->stid)->first();
            }
            if ($std) {
                $usr = User::where("typ", $typ)->where("id", $std->sid)->first();
                return response()->json([
                    "status" => true,
                    "message" => "successful",
                    "pld" => $usr,
                ]);
            }
        }
        return response()->json([
            "status" => false,
            "message" => "Invalid ID",
        ], 400);
    }

    /**
     * @OA\Post(
     *     path="/api/setSubject",
     *     tags={"Admin"},
     *     summary="Set A General Subject. If new, no need for id param. Otherwise, specify",
     *     description="This endpoint is used to set information about a subject.",
     *     security={{"bearerAuth": {}}},
     *     @OA\RequestBody(
     *         required=true,
     *         @OA\JsonContent(
     *             type="object",
     *             @OA\Property(property="id", type="integer"),
     *             @OA\Property(property="name", type="string",),
     *         )
     *     ),
     *     @OA\Response(response="200", description="Success"),
     *     @OA\Response(response="401", description="Unauthorized"),
     * )
     */
    public function setSubj(Request $request)
    {
        $request->validate([
            'name' => 'required',
        ]);
        $data = [
            'name' => $request->name,
        ];
        $subj = [];
        if ($request->has('id')) {
            $subj = subj::where('id', $request->id)->first();
            if ($subj) {
                $subj->update($data);
            } else {
                return response()->json([
                    "status" => false,
                    "message" => "Subject Not Found",
                ]);
            }
        } else {
            $subj = subj::create($data);
        }
        return response()->json([
            "status" => true,
            "message" => "Success",
            "pld" => $subj
        ]);
    }

    /**
     * @OA\Get(
     *     path="/api/searchAdminSubjects",
     *     tags={"Admin"},
     *     summary="Full text search on admin subjects",
     *     description=" Use this endpoint for Full text search on subjects",
     *     security={{"bearerAuth": {}}},
     *     @OA\Parameter(
     *         name="search",
     *         in="query",
     *         required=true,
     *         description="Search term",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Response(response="200", description="Success", @OA\JsonContent()),
     *     @OA\Response(response="401", description="Unauthorized"),
     * )
     */
    public function searchAdminSubjects()
    {
        $search = null;
        if (request()->has('search')) {
            $search = request()->input('search');
        }
        if ($search) {
            $pld = subj::whereRaw("MATCH(name) AGAINST(? IN BOOLEAN MODE)", [$search])
                ->orderByRaw("MATCH(name) AGAINST(? IN BOOLEAN MODE) DESC", [$search])
                ->take(3)
                ->get();
            return response()->json([
                "status" => true,
                "message" => "Success",
                "pld" => $pld
            ]);
        }
        return response()->json([
            "status" => false,
            "message" => "The Search param is required"
        ]);
    }

    /**
     * @OA\Get(
     *     path="/api/getSubjectsStat",
     *     tags={"Admin"},
     *     summary="Get Subjects Stat",
     *     description="Use this endpoint to get stats of subjects",
     *     security={{"bearerAuth": {}}},
     *     @OA\Response(response="200", description="Success", @OA\JsonContent()),
     *     @OA\Response(response="401", description="Unauthorized"),
     * )
     */
    public function getSubjsStat()
    {
        $total = subj::count();
        return response()->json([
            "status" => true,
            "message" => "Success",
            "pld" => [
                "total" => $total
            ],
        ]);
    }

    /**
     * @OA\Get(
     *     path="/api/getSubjects",
     *     tags={"Admin"},
     *     summary="Get Subjects",
     *     description="Use this endpoint to get a list of Subjects",
     *     security={{"bearerAuth": {}}},
     *     @OA\Parameter(
     *         name="start",
     *         in="query",
     *         required=false,
     *         description="Index to start at",
     *         @OA\Schema(type="integer")
     *     ),
     *     @OA\Parameter(
     *         name="count",
     *         in="query",
     *         required=false,
     *         description="No of records to retrieve. Default is 5",
     *         @OA\Schema(type="integer")
     *     ),
     *     @OA\Response(response="200", description="Success", @OA\JsonContent()),
     *     @OA\Response(response="401", description="Unauthorized"),
     * )
     */
    public function getSubjs()
    {
        $start = 0;
        $count = 20;
        if (request()->has('start') && request()->has('count')) {
            $start = request()->input('start');
            $count = request()->input('count');
        }
        $subj = subj::skip($start)->take($count)->get();
        return response()->json([
            "status" => true,
            "message" => "Success",
            "pld" => $subj,
        ]);
    }

    /**
     * @OA\Get(
     *     path="/api/getSubject/{sbid}",
     *     tags={"Admin"},
     *     summary="Get a particular subject",
     *     description="Use this endpoint to get a particular subject",
     *     security={{"bearerAuth": {}}},
     *     @OA\Parameter(
     *         name="sbid",
     *         in="path",
     *         required=true,
     *         description="Unique Subject ID",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Response(response="200", description="Success", @OA\JsonContent()),
     *     @OA\Response(response="401", description="Unauthorized"),
     * )
     */
    public function getSubj($sbid)
    {
        $sbj = subj::where('id', $sbid)->first();
        return response()->json([
            "status" => true,
            "message" => "Success",
            "pld" => $sbj,
        ]);
    }

    /**
     * @OA\Post(
     *     path="/api/setClass",
     *     tags={"Admin"},
     *     summary="Set The General Class. If new, no need for id param. Otherwise, specify",
     *     description="This endpoint is used to set information about a class.",
     *     security={{"bearerAuth": {}}},
     *     @OA\RequestBody(
     *         required=true,
     *         @OA\JsonContent(
     *             type="object",
     *             @OA\Property(property="id", type="integer"),
     *             @OA\Property(property="name", type="string",),
     *         )
     *     ),
     *     @OA\Response(response="200", description="Success"),
     *     @OA\Response(response="401", description="Unauthorized"),
     * )
     */
    public function setCls(Request $request)
    {
        $request->validate([
            'name' => 'required',
        ]);
        $data = [
            'name' => $request->name,
        ];
        $cls = [];
        if ($request->has('id')) {
            $cls = cls::where('id', $request->id)->first();
            if ($cls) {
                $cls->update($data);
            } else {
                return response()->json([
                    "status" => false,
                    "message" => "Class Not Found",
                ]);
            }
        } else {
            $cls = cls::create($data);
        }
        return response()->json([
            "status" => true,
            "message" => "Success",
            "pld" => $cls
        ]);
    }

    /**
     * @OA\Get(
     *     path="/api/searchAdminClasses",
     *     tags={"Admin"},
     *     summary="Full text search on admin classes",
     *     description=" Use this endpoint for Full text search on classes",
     *     security={{"bearerAuth": {}}},
     *     @OA\Parameter(
     *         name="search",
     *         in="query",
     *         required=true,
     *         description="Search term",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Response(response="200", description="Success", @OA\JsonContent()),
     *     @OA\Response(response="401", description="Unauthorized"),
     * )
     */
    public function searchAdminClasses()
    {
        $search = null;
        if (request()->has('search')) {
            $search = request()->input('search');
        }
        if ($search) {
            $pld = cls::whereRaw("MATCH(name) AGAINST(? IN BOOLEAN MODE)", [$search])
                ->orderByRaw("MATCH(name) AGAINST(? IN BOOLEAN MODE) DESC", [$search])
                ->take(3)
                ->get();
            return response()->json([
                "status" => true,
                "message" => "Success",
                "pld" => $pld
            ]);
        }
        return response()->json([
            "status" => false,
            "message" => "The Search param is required"
        ]);
    }

    /**
     * @OA\Get(
     *     path="/api/getClassesStat",
     *     tags={"Admin"},
     *     summary="Get Classes Stat",
     *     description="Use this endpoint to get stats of classes",
     *     security={{"bearerAuth": {}}},
     *     @OA\Response(response="200", description="Success", @OA\JsonContent()),
     *     @OA\Response(response="401", description="Unauthorized"),
     * )
     */
    public function getClssStat()
    {
        $total = cls::count();
        return response()->json([
            "status" => true,
            "message" => "Success",
            "pld" => [
                "total" => $total
            ],
        ]);
    }

    /**
     * @OA\Get(
     *     path="/api/getClasses",
     *     tags={"Admin"},
     *     summary="Get Classes",
     *     description="Use this endpoint to get a list of classes",
     *     security={{"bearerAuth": {}}},
     *     @OA\Parameter(
     *         name="start",
     *         in="query",
     *         required=false,
     *         description="Index to start at",
     *         @OA\Schema(type="integer")
     *     ),
     *     @OA\Parameter(
     *         name="count",
     *         in="query",
     *         required=false,
     *         description="No of records to retrieve. Default is 5",
     *         @OA\Schema(type="integer")
     *     ),
     *     @OA\Response(response="200", description="Success", @OA\JsonContent()),
     *     @OA\Response(response="401", description="Unauthorized"),
     * )
     */
    public function getClss()
    {
        $start = 0;
        $count = 20;
        if (request()->has('start') && request()->has('count')) {
            $start = request()->input('start');
            $count = request()->input('count');
        }
        $cls = cls::skip($start)->take($count)->get();
        return response()->json([
            "status" => true,
            "message" => "Success",
            "pld" => $cls,
        ]);
    }

    /**
     * @OA\Get(
     *     path="/api/getClass/{cid}",
     *     tags={"Admin"},
     *     summary="Get a particular class",
     *     description="Use this endpoint to get a particular class",
     *     security={{"bearerAuth": {}}},
     *     @OA\Parameter(
     *         name="cid",
     *         in="path",
     *         required=true,
     *         description="Unique Class ID",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Response(response="200", description="Success", @OA\JsonContent()),
     *     @OA\Response(response="401", description="Unauthorized"),
     * )
     */
    public function getCls($cid)
    {
        $cls = cls::where('id', $cid)->first();
        return response()->json([
            "status" => true,
            "message" => "Success",
            "pld" => $cls,
        ]);
    }

    /**
     * @OA\Post(
     *     path="/api/setSession",
     *     tags={"Admin"},
     *     summary="Set a General Session",
     *     description="This endpoint is used to set information about a session.",
     *     security={{"bearerAuth": {}}},
     *     @OA\RequestBody(
     *         required=true,
     *         @OA\JsonContent(
     *             type="object",
     *             @OA\Property(property="year", type="string"),
     *             @OA\Property(property="name", type="string"),
     *         )
     *     ),
     *     @OA\Response(response="200", description="Success"),
     *     @OA\Response(response="401", description="Unauthorized"),
     * )
     */
    public function setSesn(Request $request)
    {
        $request->validate([
            'year' => 'required',
            'name' => 'required',
        ]);
        $ssn = sesn::updateOrCreate([
            'year' => $request->year
        ], [
            'name' => $request->name,
        ]);
        return response()->json([
            "status" => true,
            "message" => "Success",
            "pld" => $ssn
        ]);
    }

    /**
     * @OA\Get(
     *     path="/api/getSessions",
     *     tags={"Admin"},
     *     summary="Get Session",
     *     description="Use this endpoint to get a list of sessions",
     *     security={{"bearerAuth": {}}},
     *     @OA\Parameter(
     *         name="start",
     *         in="query",
     *         required=false,
     *         description="Index to start at",
     *         @OA\Schema(type="integer")
     *     ),
     *     @OA\Parameter(
     *         name="count",
     *         in="query",
     *         required=false,
     *         description="No of records to retrieve. Default is 5",
     *         @OA\Schema(type="integer")
     *     ),
     *     @OA\Response(response="200", description="Success", @OA\JsonContent()),
     *     @OA\Response(response="401", description="Unauthorized"),
     * )
     */
    public function getSesns()
    {
        $start = 0;
        $count = 20;
        if (request()->has('start') && request()->has('count')) {
            $start = request()->input('start');
            $count = request()->input('count');
        }
        $ssn = sesn::skip($start)->take($count)->get();
        return response()->json([
            "status" => true,
            "message" => "Success",
            "pld" => $ssn,
        ]);
    }

    /**
     * @OA\Post(
     *     path="/api/setTerm",
     *     tags={"Admin"},
     *     summary="Set a General Term",
     *     description="This endpoint is used to set information about a general term.",
     *     security={{"bearerAuth": {}}},
     *     @OA\RequestBody(
     *         required=true,
     *         @OA\JsonContent(
     *             type="object",
     *             required={"name"},
     *             @OA\Property(property="no", type="string"),
     *             @OA\Property(property="name", type="string",),
     *         )
     *     ),
     *     @OA\Response(response="200", description="Success"),
     *     @OA\Response(response="401", description="Unauthorized"),
     * )
     */
    public function setTrm(Request $request)
    {
        $request->validate([
            'no' => 'required',
            'name' => 'required',
        ]);
        $trm = trm::updateOrCreate([
            'no' => $request->no
        ], [
            'name' => $request->name,
        ]);
        return response()->json([
            "status" => true,
            "message" => "Success",
            "pld" => $trm
        ]);
    }

    /**
     * @OA\Get(
     *     path="/api/getTerms",
     *     tags={"Admin"},
     *     summary="Get Terms",
     *     description="Use this endpoint to get a list of terms",
     *     security={{"bearerAuth": {}}},
     *     @OA\Response(response="200", description="Success", @OA\JsonContent()),
     *     @OA\Response(response="401", description="Unauthorized"),
     * )
     */
    public function getTrms()
    {
        $trm = trm::get();
        return response()->json([
            "status" => true,
            "message" => "Success",
            "pld" => $trm,
        ]);
    }

    /**
     * @OA\Get(
     *     path="/api/getTerm/{no}",
     *     tags={"Admin"},
     *     summary="Get a particular Term",
     *     description="Use this endpoint to get a term",
     *     security={{"bearerAuth": {}}},
     *     @OA\Parameter(
     *         name="no",
     *         in="path",
     *         required=true,
     *         description="Term ID",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Response(response="200", description="Success", @OA\JsonContent()),
     *     @OA\Response(response="401", description="Unauthorized"),
     * )
     */
    public function getTrm($no)
    {
        $trm = trm::where('no', $no)->first();
        return response()->json([
            "status" => true,
            "message" => "Success",
            "pld" => $trm,
        ]);
    }

    /**
     * @OA\Post(
     *     path="/api/setAdminStaffRole",
     *     tags={"Admin"},
     *     summary="Set Staff Role. If new, no need for id param. Otherwise, specify",
     *     description="This endpoint is used to set staff role.",
     *     @OA\RequestBody(
     *         required=true,
     *         @OA\JsonContent(
     *             type="object",
     *             @OA\Property(property="id", type="integer"),
     *             @OA\Property(property="name", type="string",),
     *         )
     *     ),
     *     @OA\Response(response="200", description="Success"),
     *     @OA\Response(response="401", description="Unauthorized"),
     * )
     */
    public function setAdminStaffRole(Request $request)
    {
        $request->validate([
            'name' => 'required',
        ]);
        $data = [
            'name' => $request->name,
        ];
        $staff_role = [];
        if ($request->has('id')) {
            $staff_role = staff_role::where('id', $request->id)->first();
            if ($staff_role) {
                $staff_role->update($data);
            } else {
                return response()->json([
                    "status" => false,
                    "message" => "Class Not Found",
                ]);
            }
        } else {
            $staff_role = staff_role::create($data);
        }
        return response()->json([
            "status" => true,
            "message" => "Success",
            "pld" => $staff_role
        ]);
    }

    /**
     * @OA\Get(
     *     path="/api/searchAdminStaffRole",
     *     tags={"Admin"},
     *     summary="Full text search on admin staff roles",
     *     description=" Use this endpoint for Full text search on staff roles",
     *     @OA\Parameter(
     *         name="search",
     *         in="query",
     *         required=true,
     *         description="Search term",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Response(response="200", description="Success", @OA\JsonContent()),
     *     @OA\Response(response="401", description="Unauthorized"),
     * )
     */
    public function searchAdminStaffRole()
    {
        $search = null;
        if (request()->has('search')) {
            $search = request()->input('search');
        }
        if ($search) {
            $pld = staff_role::whereRaw("MATCH(name) AGAINST(? IN BOOLEAN MODE)", [$search])
                ->orderByRaw("MATCH(name) AGAINST(? IN BOOLEAN MODE) DESC", [$search])
                ->take(3)
                ->get();
            return response()->json([
                "status" => true,
                "message" => "Success",
                "pld" => $pld
            ]);
        }
        return response()->json([
            "status" => false,
            "message" => "The Search param is required"
        ]);
    }

    /**
     * @OA\Get(
     *     path="/api/getAdminStaffRoleStat",
     *     tags={"Admin"},
     *     summary="Get Staff Roles Stat",
     *     description="Use this endpoint to get stats of staff roles",
     *     @OA\Response(response="200", description="Success", @OA\JsonContent()),
     *     @OA\Response(response="401", description="Unauthorized"),
     * )
     */
    public function getAdminStaffRoleStat()
    {
        $total = staff_role::count();
        return response()->json([
            "status" => true,
            "message" => "Success",
            "pld" => [
                "total" => $total
            ],
        ]);
    }

    /**
     * @OA\Get(
     *     path="/api/getAdminStaffRoles",
     *     tags={"Admin"},
     *     summary="Get Staff Roles",
     *     description="Use this endpoint to get a list of staff roles",
     *     @OA\Parameter(
     *         name="start",
     *         in="query",
     *         required=false,
     *         description="Index to start at",
     *         @OA\Schema(type="integer")
     *     ),
     *     @OA\Parameter(
     *         name="count",
     *         in="query",
     *         required=false,
     *         description="No of records to retrieve. Default is 5",
     *         @OA\Schema(type="integer")
     *     ),
     *     @OA\Response(response="200", description="Success", @OA\JsonContent()),
     *     @OA\Response(response="401", description="Unauthorized"),
     * )
     */
    public function getAdminStaffRoles()
    {
        $start = 0;
        $count = 20;
        if (request()->has('start') && request()->has('count')) {
            $start = request()->input('start');
            $count = request()->input('count');
        }
        $staff_role = staff_role::skip($start)->take($count)->get();
        return response()->json([
            "status" => true,
            "message" => "Success",
            "pld" => $staff_role,
        ]);
    }

    /**
     * @OA\Get(
     *     path="/api/getAdminStaffRole/{rid}",
     *     tags={"Admin"},
     *     summary="Get a particular staff role",
     *     description="Use this endpoint to get a particular staff role",
     *     @OA\Parameter(
     *         name="rid",
     *         in="path",
     *         required=true,
     *         description="Unique Staff Role ID",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Response(response="200", description="Success", @OA\JsonContent()),
     *     @OA\Response(response="401", description="Unauthorized"),
     * )
     */
    public function getAdminStaffRole($rid)
    {
        $staff_role = staff_role::where('id', $rid)->first();
        return response()->json([
            "status" => true,
            "message" => "Success",
            "pld" => $staff_role,
        ]);
    }

    /**
     * @OA\Post(
     *     path="/api/setSchoolStaffRole",
     *     tags={"Admin"},
     *     summary="Set Staff Role for a particular school.",
     *     description="This endpoint is used to set staff role for a school.",
     *     @OA\RequestBody(
     *         required=true,
     *         @OA\JsonContent(
     *             type="object",
     *             @OA\Property(property="name", type="string",),
     *             @OA\Property(property="role", type="string",),
     *             @OA\Property(property="schid", type="string",),
     *         )
     *     ),
     *     @OA\Response(response="200", description="Success"),
     *     @OA\Response(response="401", description="Unauthorized"),
     * )
     */
    public function setSchoolStaffRole(Request $request)
    {
        $request->validate([
            'name' => 'required',
            'role' => 'required',
            'schid' => 'required',
        ]);
        $staff_role = sch_staff_role::create([
            'name' => $request->name,
            'role' => $request->role,
            'schid' => $request->schid,
        ]);
        return response()->json([
            "status" => true,
            "message" => "Success",
            "pld" => $staff_role
        ]);
    }

    /**
     * @OA\Get(
     *     path="/api/getSchoolStaffRoles/{schid}",
     *     tags={"Admin"},
     *     summary="Get Staff Roles",
     *     description="Use this endpoint to get a list of staff roles",
     *     @OA\Parameter(
     *         name="schid",
     *         in="path",
     *         required=true,
     *         description="school ID",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Response(response="200", description="Success", @OA\JsonContent()),
     *     @OA\Response(response="401", description="Unauthorized"),
     * )
     */
    public function getSchoolStaffRoles($schid)
    {
        $staff_role = sch_staff_role::where('schid', $schid)->get();
        return response()->json([
            "status" => true,
            "message" => "Success",
            "pld" => $staff_role,
        ]);
    }

    /**
     * @OA\Get(
     *     path="/api/getSchoolStaffRole/{rid}",
     *     tags={"Admin"},
     *     summary="Get a particular staff role",
     *     description="Use this endpoint to get a particular staff role",
     *     @OA\Parameter(
     *         name="rid",
     *         in="path",
     *         required=true,
     *         description="Unique Staff Role ID",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Response(response="200", description="Success", @OA\JsonContent()),
     *     @OA\Response(response="401", description="Unauthorized"),
     * )
     */
    public function getSchoolStaffRole($rid)
    {
        $staff_role = sch_staff_role::where('role', $rid)->first();
        return response()->json([
            "status" => true,
            "message" => "Success",
            "pld" => $staff_role,
        ]);
    }

    /**
     * @OA\Get(
     *     path="/api/getStaffRoleByClass/{stid}/{schid}/{clsid}/{ssn}",
     *     tags={"Admin"},
     *     summary="Get a particular staff role",
     *     description="Use this endpoint to get a particular staff role",
     *     @OA\Parameter(
     *         name="stid",
     *         in="path",
     *         required=true,
     *         description="Staff ID",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Parameter(
     *         name="schid",
     *         in="path",
     *         required=true,
     *         description="School ID",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Parameter(
     *         name="clsid",
     *         in="path",
     *         required=true,
     *         description="Class ID",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Parameter(
     *         name="ssn",
     *         in="path",
     *         required=true,
     *         description="Session ID",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Response(response="200", description="Success", @OA\JsonContent()),
     *     @OA\Response(response="401", description="Unauthorized"),
     * )
     */
    public function getStaffRoleByClass($stid, $schid, $clsid, $ssn)
    {
        $pld = old_staff::where("sid", $stid)
            ->where("schid", $schid)
            ->where("clsm", $clsid)
            ->where("ssn", $ssn)
            ->first();
        return response()->json([
            "status" => true,
            "message" => "Success",
            "pld" => $pld,
        ]);
    }



    /**
     * @OA\Get(
     *     path="/api/getSchoolsByPartner/{uid}",
     *     tags={"Admin"},
     *     summary="Get Partner's Schools",
     *     description="Use this endpoint to get a Partner's Schools.",
     *     security={{"bearerAuth": {}}},
     *     @OA\Parameter(
     *         name="pid",
     *         in="path",
     *         required=true,
     *         description="ID of the partner. User ID, not partner code",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Parameter(
     *         name="start",
     *         in="query",
     *         required=false,
     *         description="Index to start at",
     *         @OA\Schema(type="integer")
     *     ),
     *     @OA\Parameter(
     *         name="count",
     *         in="query",
     *         required=false,
     *         description="No of records to retrieve",
     *         @OA\Schema(type="integer")
     *     ),
     *     @OA\Response(response="200", description="Success", @OA\JsonContent()),
     *     @OA\Response(response="401", description="Unauthorized"),
     * )
     */
    public function getSchoolsByPartner($pid)
    {
        $start = 0;
        $count = 20;
        if (request()->has('start') && request()->has('count')) {
            $start = request()->input('start');
            $count = request()->input('count');
        }
        $members = school_basic_data::where('pcode', $pid)->skip($start)->take($count)->get();
        $pld = [];
        foreach ($members as $member) {
            $user_id = $member->user_id;
            $genData = school_general_data::where('user_id', $user_id)->first();
            $mergedData = array_merge($member->toArray(), $genData->toArray());
            $pld[] = $mergedData;
        }
        return response()->json([
            "status" => true,
            "message" => "Success",
            "pld" => $pld,
        ]);
    }

    /**
     * @OA\Get(
     *     path="/api/searchSchools",
     *     tags={"Admin"},
     *     summary="Full text search on school names",
     *     description=" Use this endpoint for Full text search on school names",
     *     security={{"bearerAuth": {}}},
     *     @OA\Parameter(
     *         name="search",
     *         in="query",
     *         required=true,
     *         description="Search term",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Response(response="200", description="Success", @OA\JsonContent()),
     *     @OA\Response(response="401", description="Unauthorized"),
     * )
     */
    public function searchSchools()
    {
        $search = null;
        if (request()->has('search')) {
            $search = request()->input('search');
        }
        if ($search) {
            $members = school_basic_data::whereRaw("MATCH(sname) AGAINST(? IN BOOLEAN MODE)", [$search])
                ->orderByRaw("MATCH(sname) AGAINST(? IN BOOLEAN MODE) DESC", [$search])
                ->take(2)
                ->get();
            $pld = [];
            foreach ($members as $member) {
                $user_id = $member->user_id;
                $genData = school_general_data::where('user_id', $user_id)->first();
                $mergedData = array_merge($member->toArray(), $genData->toArray());
                $pld[] = $mergedData;
            }
            return response()->json([
                "status" => true,
                "message" => "Success",
                "pld" => $pld
            ]);
        }
        return response()->json([
            "status" => false,
            "message" => "The Search param is required"
        ]);
    }

    /**
     * @OA\Get(
     *     path="/api/searchPartners",
     *     tags={"Admin"},
     *     summary="Full text search on partner names",
     *     description=" Use this endpoint for Full text search on partner names",
     *     security={{"bearerAuth": {}}},
     *     @OA\Parameter(
     *         name="search",
     *         in="query",
     *         required=true,
     *         description="Search term",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Response(response="200", description="Success", @OA\JsonContent()),
     *     @OA\Response(response="401", description="Unauthorized"),
     * )
     */
    public function searchPartners()
    {
        $search = null;
        if (request()->has('search')) {
            $search = request()->input('search');
        }
        if ($search) {
            $members = partner_basic_data::whereRaw("MATCH(fname, lname, mname) AGAINST(? IN BOOLEAN MODE)", [$search])
                ->orderByRaw("MATCH(fname, lname, mname) AGAINST(? IN BOOLEAN MODE) DESC", [$search])
                ->take(2)
                ->get();
            $pld = [];
            foreach ($members as $member) {
                $user_id = $member->user_id;
                $genData = school_general_data::where('user_id', $user_id)->first();
                $mergedData = array_merge($member->toArray(), $genData->toArray());
                $pld[] = $mergedData;
            }
            return response()->json([
                "status" => true,
                "message" => "Success",
                "pld" => $pld
            ]);
        }
        return response()->json([
            "status" => false,
            "message" => "The Search param is required"
        ]);
    }


    /**
     * @OA\Get(
     *     path="/api/getSchoolsByPay/{pid}",
     *     tags={"Admin"},
     *     summary="ADMIN: Get Schools by pay id",
     *     description="Use this endpoint to get schools",
     *     security={{"bearerAuth": {}}},
     *     @OA\Parameter(
     *         name="pid",
     *         in="path",
     *         required=true,
     *         description="pay ID - 0 or 1",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Parameter(
     *         name="start",
     *         in="query",
     *         required=false,
     *         description="Index to start at",
     *         @OA\Schema(type="integer")
     *     ),
     *     @OA\Parameter(
     *         name="count",
     *         in="query",
     *         required=false,
     *         description="No of records to retrieve",
     *         @OA\Schema(type="integer")
     *     ),
     *     @OA\Response(response="200", description="Success. The response is split into b:BASIC_DATA and g:GENERAL_DATA", @OA\JsonContent()),
     *     @OA\Response(response="401", description="Unauthorized"),
     * )
     */
    public function getSchoolsByPay($pid)
    {
        $start = 0;
        $count = 20;
        if (request()->has('start') && request()->has('count')) {
            $start = request()->input('start');
            $count = request()->input('count');
        }
        $members = school_basic_data::where('pay', $pid)->skip($start)->take($count)->get();
        $pld = [];
        foreach ($members as $member) {
            $user_id = $member->user_id;
            $genData = school_general_data::where('user_id', $user_id)->first();
            $pld[] = [
                'b' => $member,
                'g' => $genData,
            ];
        }
        // Respond
        return response()->json([
            "status" => true,
            "message" => "Success",
            "pld" => $pld,
        ]);
    }

    /**
     * @OA\Get(
     *     path="/api/getSchoolsByStat/{stat}",
     *     tags={"Admin"},
     *     summary="ADMIN: Get Schools by stat id",
     *     description="Use this endpoint to get schools",
     *     security={{"bearerAuth": {}}},
     *     @OA\Parameter(
     *         name="stat",
     *         in="path",
     *         required=true,
     *         description="Stat ID - 0 or 1",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Parameter(
     *         name="start",
     *         in="query",
     *         required=false,
     *         description="Index to start at",
     *         @OA\Schema(type="integer")
     *     ),
     *     @OA\Parameter(
     *         name="count",
     *         in="query",
     *         required=false,
     *         description="No of records to retrieve",
     *         @OA\Schema(type="integer")
     *     ),
     *     @OA\Response(response="200", description="Success", @OA\JsonContent()),
     *     @OA\Response(response="401", description="Unauthorized"),
     * )
     */
    public function getSchoolsByStat($stat)
    {
        $start = 0;
        $count = 20;
        if (request()->has('start') && request()->has('count')) {
            $start = request()->input('start');
            $count = request()->input('count');
        }
        $members = school::where('stat', $stat)->skip($start)->take($count)->get();
        $pld = [];
        foreach ($members as $member) {
            $user_id = $member->user_id;
            $basicData = school_basic_data::where('user_id', $user_id)->first();
            $genData = school_general_data::where('user_id', $user_id)->first();
            $pld[] = [
                'b' => $basicData,
                'g' => $genData,
            ];
        }
        // Respond
        return response()->json([
            "status" => true,
            "message" => "Success",
            "pld" => $pld,
        ]);
    }

    /**
     * @OA\Get(
     *     path="/api/getSchools",
     *     tags={"Admin"},
     *     summary="ADMIN: Get a list of Schools ",
     *     description="Use this endpoint to get a list of schools",
     *     security={{"bearerAuth": {}}},
     *     @OA\Parameter(
     *         name="start",
     *         in="query",
     *         required=false,
     *         description="Index to start at",
     *         @OA\Schema(type="integer")
     *     ),
     *     @OA\Parameter(
     *         name="count",
     *         in="query",
     *         required=false,
     *         description="No of records to retrieve",
     *         @OA\Schema(type="integer")
     *     ),
     *     @OA\Response(response="200", description="Success", @OA\JsonContent()),
     *     @OA\Response(response="401", description="Unauthorized"),
     * )
     */
    public function getSchools()
    {
        $start = 0;
        $count = 20;
        if (request()->has('start') && request()->has('count')) {
            $start = request()->input('start');
            $count = request()->input('count');
        }
        $members = school::take($count)->skip($start)->get();
        $pld = [];
        foreach ($members as $member) {
            $user_id = $member->sid;
            $webData = school_web_data::where('user_id', $user_id)->first();
            $pld[] = [
                's' => $member,
                'w' => $webData,
            ];
        }
        // Respond
        return response()->json([
            "status" => true,
            "message" => "Success",
            "pld" => $pld,
        ]);
    }

    /**
     * @OA\Get(
     *     path="/api/getSchoolsStat",
     *     tags={"Admin"},
     *     summary="ADMIN: Get total no. of Schools",
     *     description="Use this endpoint to Get total no. of Schools",
     *     security={{"bearerAuth": {}}},
     *     @OA\Response(response="200", description="Success", @OA\JsonContent()),
     *     @OA\Response(response="401", description="Unauthorized"),
     * )
     */
    public function getSchoolsStat()
    {
        $total = school::count();
        // Respond
        return response()->json([
            "status" => true,
            "message" => "Success",
            "pld" => [
                "total" => $total
            ],
        ]);
    }

    /**
     * @OA\Get(
     *     path="/api/getStudentsBySchool/{schid}/{stat}",
     *     summary="Get students by school ID and status",
     *     description="Fetch a paginated list of active students filtered by school, status, class, term, and year.",
     *     operationId="getStudentsBySchool",
     *     tags={"Api"},
     *     security={{"bearerAuth": {}}},
     *
     *     @OA\Parameter(
     *         name="schid",
     *         in="path",
     *         required=true,
     *         description="School ID",
     *         @OA\Schema(type="integer", example=12)
     *     ),
     *     @OA\Parameter(
     *         name="stat",
     *         in="path",
     *         required=true,
     *         description="Student status (numeric or code)",
     *         @OA\Schema(type="string", example="1")
     *     ),
     *     @OA\Parameter(
     *         name="start",
     *         in="query",
     *         required=false,
     *         description="Offset for pagination",
     *         @OA\Schema(type="integer", example=0)
     *     ),
     *     @OA\Parameter(
     *         name="count",
     *         in="query",
     *         required=false,
     *         description="Number of records to return",
     *         @OA\Schema(type="integer", example=20)
     *     ),
     *     @OA\Parameter(
     *         name="cls",
     *         in="query",
     *         required=false,
     *         description="Class ID filter; use 'zzz' to fetch all classes",
     *         @OA\Schema(type="string", example="13")
     *     ),
     *     @OA\Parameter(
     *         name="year",
     *         in="query",
     *         required=false,
     *         description="Year filter (from student table)",
     *         @OA\Schema(type="integer", example=2024)
     *     ),
     *
     *     @OA\Response(
     *         response=200,
     *         description="Successful operation",
     *         @OA\JsonContent(
     *             @OA\Property(property="status", type="boolean", example=true),
     *             @OA\Property(property="message", type="string", example="Success"),
     *             @OA\Property(
     *                 property="pld",
     *                 type="array",
     *                 @OA\Items(
     *                     @OA\Property(property="sid", type="integer", example=101),
     *                     @OA\Property(property="lname", type="string", example="Doe"),
     *                     @OA\Property(property="fname", type="string", example="John"),
     *                     @OA\Property(property="term", type="integer", example=3),
     *                     @OA\Property(property="year", type="integer", example=2024),
     *                     @OA\Property(property="new_class_main", type="string", example="13")
     *                 )
     *             )
     *         )
     *     ),
     *     @OA\Response(
     *         response=400,
     *         description="Invalid request"
     *     )
     * )
     */

    public function getStudentsBySchool(Request $request, $schid, $stat)
    {
        $start = $request->input('start', 0);
        $count = $request->input('count', 20);
        $year = $request->input('year');   // optional
        $cls = $request->input('cls', 'zzz'); // "zzz" = ALL classes
        $term = $request->input('term');   // optional

        // Base query: join latest student_academic_data
        $query = student::query()
            ->leftJoin('student_academic_data as sad', function ($join) {
                $join->on('student.sid', '=', 'sad.user_id')
                    ->whereRaw('sad.created_at = (
                     SELECT MAX(created_at)
                     FROM student_academic_data
                     WHERE user_id = student.sid
                 )');
            })
            ->where('student.schid', $schid)
            ->where('student.stat', $stat);

        // Filter by class if not "ALL"
        if ($cls !== 'zzz') {
            $query->where('sad.new_class_main', $cls);
        }

        // Optional filters
        if ($year) {
            $query->where('student.year', $year);
        }
        if ($term) {
            $query->where('student.term', $term);
        }

        // Clone query for total count
        $total = (clone $query)->distinct('student.sid')->count('student.sid');

        // Fetch paginated results
        $students = $query->select('student.*', 'sad.new_class_main')
            ->distinct('student.sid')
            ->orderBy('student.lname', 'asc')
            ->skip($start)
            ->take($count)
            ->get();

        // Format payload
        $pld = $students->map(function ($student) {
            return [
                's' => $student,
                'b' => student_basic_data::where('user_id', $student->sid)->first(),
                'a' => student_academic_data::where('user_id', $student->sid)
                    ->orderBy('created_at', 'desc')
                    ->first(),
            ];
        });

        return response()->json([
            "status" => true,
            "message" => "Success",
            "total" => $total,
            "pld" => $pld,
        ]);
    }




    /**
     * @OA\Get(
     *     path="/api/searchStudents",
     *     tags={"Api"},
     *     summary="Full text search on students",
     *     description=" Use this endpoint for Full text search on students",
     *     security={{"bearerAuth": {}}},
     *     @OA\Parameter(
     *         name="search",
     *         in="query",
     *         required=true,
     *         description="Search term",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Parameter(
     *         name="stat",
     *         in="query",
     *         required=true,
     *         description="Status of the student",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Parameter(
     *         name="schid",
     *         in="query",
     *         required=true,
     *         description="School ID",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Parameter(
     *         name="cls",
     *         in="query",
     *         required=false,
     *         description="Filter by class",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Response(response="200", description="Success", @OA\JsonContent()),
     *     @OA\Response(response="401", description="Unauthorized"),
     * )
     */
    public function searchStudents()
    {
        $search = null;
        if (request()->has('search')) {
            $search = request()->input('search');
        }
        $schid = request()->input('schid');
        $stat = request()->input('stat');
        $cls = '-1';
        if (request()->has('cls')) {
            $cls = request()->input('cls');
        }
        if ($search) {
            $members = [];
            if ($cls != '-1') {
                $members = student::join('student_academic_data', 'student.sid', '=', 'student_academic_data.user_id')
                    ->where('student.schid', $schid)
                    ->where('student_academic_data.new_class_main', $cls)
                    ->whereRaw("MATCH(fname, lname) AGAINST(?)", [$search])
                    ->orderByRaw("MATCH(fname, lname) AGAINST('$search') DESC")
                    ->take(3)
                    ->get();
            } else {
                $members = student::where('schid', $schid)->where('stat', $stat)
                    ->whereRaw("MATCH(fname, lname) AGAINST(?)", [$search])
                    ->orderByRaw("MATCH(fname, lname) AGAINST('$search') DESC")
                    ->take(3)
                    ->get();
            }
            $pld = [];
            foreach ($members as $member) {
                $user_id = $member->sid;
                $academicData = student_academic_data::where('user_id', $user_id)->first();
                $basicData = student_basic_data::where('user_id', $user_id)->first();
                $pld[] = [
                    's' => $member,
                    'b' => $basicData,
                    'a' => $academicData,
                ];
            }
            return response()->json([
                "status" => true,
                "message" => "Success",
                "pld" => $pld
            ]);
        }
        return response()->json([
            "status" => false,
            "message" => "The Search param is required"
        ]);
    }

    /**
     * @OA\Get(
     *     path="/api/searchOldStudents",
     *     tags={"Api"},
     *     summary="Full text search on old students",
     *     description=" Use this endpoint for Full text search on students",
     *     security={{"bearerAuth": {}}},
     *     @OA\Parameter(
     *         name="search",
     *         in="query",
     *         required=true,
     *         description="Search term",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Parameter(
     *         name="schid",
     *         in="query",
     *         required=true,
     *         description="School ID",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Parameter(
     *         name="cls",
     *         in="query",
     *         required=true,
     *         description="Filter by class",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Parameter(
     *         name="arm",
     *         in="query",
     *         required=true,
     *         description="Filter by class arm",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Parameter(
     *         name="ssn",
     *         in="query",
     *         required=true,
     *         description="Filter by Session",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Response(response="200", description="Success", @OA\JsonContent()),
     *     @OA\Response(response="401", description="Unauthorized"),
     * )
     */
    public function searchOldStudents()
    {
        $search = null;
        if (request()->has('search')) {
            $search = request()->input('search');
        }
        $schid = request()->input('schid');
        $cls = request()->input('cls');
        $arm = request()->input('arm');
        $ssn = request()->input('ssn');
        if ($search) {
            $pld = [];
            if ($arm != "-1") {
                $pld = old_student::where('schid', $schid)
                    ->where('clsm', $cls)
                    ->where('clsa', $arm)
                    ->where('ssn', $ssn)
                    ->whereRaw("MATCH(fname, lname) AGAINST(?)", [$search])
                    ->orderByRaw("MATCH(fname, lname) AGAINST('$search') DESC")
                    ->take(3)
                    ->get();
            } else {
                $pld = old_student::where('schid', $schid)
                    ->where('clsm', $cls)
                    ->where('ssn', $ssn)
                    ->whereRaw("MATCH(fname, lname) AGAINST(?)", [$search])
                    ->orderByRaw("MATCH(fname, lname) AGAINST('$search') DESC")
                    ->take(3)
                    ->get();
            }
            return response()->json([
                "status" => true,
                "message" => "Success",
                "pld" => $pld
            ]);
        }
        return response()->json([
            "status" => false,
            "message" => "The Search param is required"
        ]);
    }



    /**
     * @OA\Get(
     *     path="/api/getStudentsStatBySchool",
     *     summary="Get total count of active students for a school",
     *     description="Returns the total number of active students for the given school, optionally filtered by class, year, and term. Students from the 'old_student' table who also exist in the 'student' table are excluded to avoid duplicates.",
     *     tags={"Api"},
     *     security={{"bearerAuth": {}}},
     *
     *     @OA\Parameter(
     *         name="schid",
     *         in="query",
     *         description="School ID (required)",
     *         required=true,
     *         @OA\Schema(type="integer")
     *     ),
     *       @OA\Parameter(
     *         name="stat",
     *         in="query",
     *         description="Student status filter (optional, e.g., 'HGC')",
     *         required=false,
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Parameter(
     *         name="cls",
     *         in="query",
     *         description="Class filter (optional, default 'zzz')",
     *         required=false,
     *         @OA\Schema(type="string", default="zzz")
     *     ),
     *     @OA\Parameter(
     *         name="year",
     *         in="query",
     *         description="Academic year filter (optional)",
     *         required=false,
     *         @OA\Schema(type="string", example="2024")
     *     ),
     *     @OA\Parameter(
     *         name="term",
     *         in="query",
     *         description="Term filter (optional)",
     *         required=false,
     *         @OA\Schema(type="integer", example=1)
     *     ),
     *
     *     @OA\Response(
     *         response=200,
     *         description="Success",
     *         @OA\JsonContent(
     *             type="object",
     *             @OA\Property(property="status", type="boolean", example=true),
     *             @OA\Property(property="message", type="string", example="Success"),
     *             @OA\Property(
     *                 property="pld",
     *                 type="object",
     *                 @OA\Property(property="total", type="integer", example=42)
     *             )
     *         )
     *     ),
     *     @OA\Response(
     *         response=400,
     *         description="Bad request (missing required parameter)",
     *         @OA\JsonContent(
     *             type="object",
     *             @OA\Property(property="status", type="boolean", example=false),
     *             @OA\Property(property="message", type="string", example="schid is required"),
     *             @OA\Property(property="pld", type="object", example={})
     *         )
     *     )
     * )
     */


    public function getStudentsStatBySchool(Request $request)
    {
        // Required
        $schid = $request->query('schid');
        $stat = $request->query('stat');

        if (!$schid) {
            return response()->json([
                'status' => false,
                'message' => 'schid and stat are required',
                'pld' => []
            ], 400);
        }

        // Optional filters
        $cls = $request->query('cls', 'zzz');
        $term = $request->query('term', null);
        $year = $request->query('year', null);

        // Base query
        $query = student::where('schid', $schid)
            ->where('status', 'active')
            ->where('stat', $stat);

        // Join with academic data if class filter is specified
        if ($cls !== 'zzz') {
            $query->join('student_academic_data', 'student.sid', '=', 'student_academic_data.user_id')
                ->where('student_academic_data.new_class_main', $cls);
        }

        // Apply optional term filter
        if (!is_null($term)) {
            $query->where('term', $term);
        }

        // Apply optional year filter
        if (!is_null($year)) {
            $query->where('year', $year);
        }

        // Count distinct students to avoid duplicates caused by join
        $total = $query->distinct('student.sid')->count('student.sid');

        return response()->json([
            'status' => true,
            'message' => 'Success',
            'pld' => ['total' => $total],
        ]);
    }



    /**
     * @OA\Get(
     *     path="/api/getStudents",
     *     tags={"Admin"},
     *     summary="ADMIN: Get Students",
     *     description="Use this endpoint to get students",
     *     security={{"bearerAuth": {}}},
     *     @OA\Parameter(
     *         name="start",
     *         in="query",
     *         required=false,
     *         description="Index to start at",
     *         @OA\Schema(type="integer")
     *     ),
     *     @OA\Parameter(
     *         name="count",
     *         in="query",
     *         required=false,
     *         description="No of records to retrieve",
     *         @OA\Schema(type="integer")
     *     ),
     *     @OA\Response(response="200", description="Success", @OA\JsonContent()),
     *     @OA\Response(response="401", description="Unauthorized"),
     * )
     */
    public function getStudents()
    {
        $start = 0;
        $count = 20;
        if (request()->has('start') && request()->has('count')) {
            $start = request()->input('start');
            $count = request()->input('count');
        }
        $members = student::take($count)->skip($start)->get();
        $pld = [];
        foreach ($members as $member) {
            $user_id = $member->sid;
            $academicData = student_academic_data::where('user_id', $user_id)->first();
            $basicData = student_basic_data::where('user_id', $user_id)->first();
            $pld[] = [
                's' => $member,
                'b' => $basicData,
                'a' => $academicData,
            ];
        }
        // Respond
        return response()->json([
            "status" => true,
            "message" => "Success",
            "pld" => $pld,
        ]);
    }

    /**
     * @OA\Get(
     *     path="/api/getStaff",
     *     tags={"Admin"},
     *
     *     summary="Get a staff",
     *     description="Use this endpoint to get a staff.",
     *     @OA\Parameter(
     *         name="uid",
     *         in="query",
     *         required=true,
     *         description="User Id of the student",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Parameter(
     *         name="combined",
     *         in="query",
     *         required=false,
     *         description="should be combined?",
     *         @OA\Schema(type="boolean")
     *     ),
     *      @OA\Parameter(
     *         name="uid",
     *         in="query",
     *         required=true,
     *         description="UID of the student",
     *         @OA\Schema(type="boolean")
     *     ),
     *     @OA\Response(response="200", description="Success", @OA\JsonContent()),
     *     @OA\Response(response="401", description="Unauthorized"),
     * )
     */

    public function getStaff()
    {
        $combined = false;
        if (request()->has('combined')) {
            $combined = request()->input('combined');
        }

        $uid = '';
        if (request()->has('uid')) {
            $uid = request()->input('uid');
        }

        if ($uid == '') {
            return response()->json([
                "status" => false,
                "message" => "No UID provided",
            ], 400);
        }

        $pld = [];

        if ($combined) {
            $members = [];
            $compo = explode("/", $uid);

            if (count($compo) == 4) {
                $sch3 = $compo[0];
                $count = $compo[2];
                $members = staff::where("sch3", $sch3)->where("count", $count)->get();
            } else {
                $members = staff::where("cuid", $uid)->get();
            }

            foreach ($members as $member) {

                //  Remove asterisk from role
                if (!empty($member->role)) {
                    $member->role = ltrim($member->role, '*');
                }

                $user_id = $member->sid;
                $profData = staff_prof_data::where('user_id', $user_id)->first();
                $basicData = staff_basic_data::where('user_id', $user_id)->first();

                $pld[] = [
                    's' => $member,
                    'b' => $basicData,
                    'p' => $profData,
                ];
            }
        } else {
            $pld = staff::where("sid", $uid)->first();

            //  Remove asterisk from role
            if ($pld && !empty($pld->role)) {
                $pld->role = ltrim($pld->role, '*');
            }
        }

        return response()->json([
            "status" => true,
            "message" => "Success",
            "pld" => $pld,
        ]);
    }


    /**
     * @OA\Get(
     *     path="/api/getStaffBySchool/{schid}/{stat}/{cls?}",
     *     tags={"Admin"},
     *     summary="ADMIN: Get staff by school id",
     *     description="Use this endpoint to get staff by school, with optional filters for class, year, term, and pagination.",
     *     security={{"bearerAuth": {}}},
     *
     *     @OA\Parameter(
     *         name="schid",
     *         in="path",
     *         required=true,
     *         description="School ID",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Parameter(
     *         name="stat",
     *         in="path",
     *         required=true,
     *         description="Status of the staff (e.g., active, inactive)",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Parameter(
     *         name="cls",
     *         in="path",
     *         required=false,
     *         description="Optional class assigned to staff (default = 'zzz')",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Parameter(
     *         name="start",
     *         in="query",
     *         required=false,
     *         description="Index to start at (pagination start offset)",
     *         @OA\Schema(type="integer", default=0)
     *     ),
     *     @OA\Parameter(
     *         name="count",
     *         in="query",
     *         required=false,
     *         description="Number of records to retrieve (pagination limit)",
     *         @OA\Schema(type="integer", default=20)
     *     ),
     *     @OA\Parameter(
     *         name="term",
     *         in="query",
     *         required=false,
     *         description="Academic term filter",
     *         @OA\Schema(type="string", example="1")
     *     ),
     *     @OA\Parameter(
     *         name="year",
     *         in="query",
     *         required=false,
     *         description="Academic year filter",
     *         @OA\Schema(type="string", example="2024")
     *     ),
     *
     *     @OA\Response(
     *         response="200",
     *         description="Success",
     *         @OA\JsonContent()
     *     ),
     *     @OA\Response(
     *         response="401",
     *         description="Unauthorized"
     *     ),
     *     @OA\Response(
     *         response="404",
     *         description="Not Found"
     *     )
     * )
     */

    public function getStaffBySchool($schid, $stat, $cls = 'zzz')
    {
        $start = 0;
        $count = 20;
        if (request()->has('start') && request()->has('count')) {
            $start = request()->input('start');
            $count = request()->input('count');
        }
        $members = [];
        if ($cls !== 'zzz') {
            $members = []; //TODO DO it join...
        } else {
            $members = staff::where('schid', $schid)->where('stat', $stat)->orderBy('fname', 'asc')->skip($start)->take($count)->get();
        }
        $pld = [];
        foreach ($members as $member) {
            $user_id = $member->sid;
            $basicData = staff_basic_data::where('user_id', $user_id)->first();
            $pld[] = [
                's' => $member,
                'b' => $basicData,
            ];
        }
        // Respond
        return response()->json([
            "status" => true,
            "message" => "Success",
            "pld" => $pld,
        ]);
    }


    /**
     * @OA\Get(
     *     path="/api/searchStaff",
     *     tags={"Api"},
     *     summary="Full text search on staff",
     *     description=" Use this endpoint for Full text search on staff",
     *     security={{"bearerAuth": {}}},
     *     @OA\Parameter(
     *         name="search",
     *         in="query",
     *         required=true,
     *         description="Search term",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Parameter(
     *         name="schid",
     *         in="query",
     *         required=true,
     *         description="School ID",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Response(response="200", description="Success", @OA\JsonContent()),
     *     @OA\Response(response="401", description="Unauthorized"),
     * )
     */
    public function searchStaff()
    {
        $search = null;
        if (request()->has('search')) {
            $search = request()->input('search');
        }
        $schid = request()->input('schid');
        if ($search) {
            $members = staff::where('schid', $schid)
                ->whereRaw("MATCH(fname, lname) AGAINST(? IN BOOLEAN MODE)", [$search])
                ->orderByRaw("MATCH(fname, lname) AGAINST(? IN BOOLEAN MODE) DESC", [$search])
                ->take(3)
                ->get();
            $pld = [];
            foreach ($members as $member) {
                $user_id = $member->sid;
                $basicData = staff_basic_data::where('user_id', $user_id)->first();
                $pld[] = [
                    's' => $member,
                    'b' => $basicData,
                ];
            }
            return response()->json([
                "status" => true,
                "message" => "Success",
                "pld" => $pld
            ]);
        }
        return response()->json([
            "status" => false,
            "message" => "The Search param is required"
        ]);
    }

    /**
     * @OA\Get(
     *     path="/api/getStaffStatBySchool/{schid}/{stat}/{cls?}",
     *     tags={"Admin"},
     *     summary="ADMIN: Get total number of Staff by school id",
     *     description="Use this endpoint to get the total number of staff by school, with optional filters for class, term, and year.",
     *     security={{"bearerAuth": {}}},
     *
     *     @OA\Parameter(
     *         name="schid",
     *         in="path",
     *         required=true,
     *         description="School ID",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Parameter(
     *         name="stat",
     *         in="path",
     *         required=true,
     *         description="Status of the staff (e.g., active, inactive)",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Parameter(
     *         name="cls",
     *         in="path",
     *         required=false,
     *         description="Optional class filter (currently placeholder)",
     *         @OA\Schema(type="string", example="11")
     *     ),
     *     @OA\Parameter(
     *         name="term",
     *         in="query",
     *         required=false,
     *         description="Optional academic term filter",
     *         @OA\Schema(type="string", example="1")
     *     ),
     *     @OA\Parameter(
     *         name="year",
     *         in="query",
     *         required=false,
     *         description="Optional academic year filter",
     *         @OA\Schema(type="string", example="2024")
     *     ),
     *
     *     @OA\Response(
     *         response="200",
     *         description="Success",
     *         @OA\JsonContent(
     *             type="object",
     *             @OA\Property(property="status", type="boolean", example=true),
     *             @OA\Property(property="message", type="string", example="Success"),
     *             @OA\Property(
     *                 property="pld",
     *                 type="object",
     *                 @OA\Property(property="total", type="integer", example=57)
     *             )
     *         )
     *     ),
     *     @OA\Response(
     *         response="401",
     *         description="Unauthorized"
     *     )
     * )
     */


    public function getStaffStatBySchool(Request $request, $schid, $stat, $cls = 'zzz')
    {
        $term = $request->query('term', null);
        $year = $request->query('year', null);

        $query = staff::where('schid', $schid)
            ->where('stat', $stat);

        // Optional class filter (currently placeholder, only works if column exists)
        if ($cls !== 'zzz') {
            // TODO: Add class filtering if staff table has class column or join with staff_academic_data
        }

        if (!empty($term)) {
            $query->where('term', $term);
        }

        if (!empty($year)) {
            $query->where('year', $year);
        }

        $total = $query->count();

        return response()->json([
            "status" => true,
            "message" => "Success",
            "pld" => [
                "total" => $total,
            ],
        ]);
    }




    /**
     * @OA\Post(
     *     path="/api/setAnnouncements",
     *     tags={"Admin"},
     *     summary="Create Announcement",
     *     description="ADMIN: Use this endpoint to create an announcement.",
     *     security={{"bearerAuth": {}}},
     *     @OA\RequestBody(
     *         required=true,
     *         @OA\JsonContent(
     *             type="object",
     *             @OA\Property(property="title", type="string", description="Title of the announcement"),
     *             @OA\Property(property="msg", type="string", description="Message content of the announcement"),
     *             @OA\Property(property="time", type="string", description="Time of the announcement"),
     *         )
     *     ),
     *     @OA\Response(response="200", description="Announcement created successfully"),
     *     @OA\Response(response="401", description="Unauthorized"),
     * )
     */
    public function setAnnouncements(Request $request)
    {
        $request->validate([
            "title" => "required",
            "msg" => "required",
            "time" => "required",
        ]);
        announcements::create([
            "title" => $request->title,
            "msg" => $request->msg,
            "time" => $request->time,
        ]);
        // Respond
        return response()->json([
            "status" => true,
            "message" => "Announcement Added"
        ]);
    }

    /**
     * @OA\Post(
     *     path="/api/sendMail",
     *     tags={"Admin"},
     *     summary="Send an email",
     *     description="ADMIN: Use this endpoint to create an announcement.",
     *     security={{"bearerAuth": {}}},
     *     @OA\RequestBody(
     *         required=true,
     *         @OA\JsonContent(
     *             type="object",
     *             @OA\Property(property="name", type="string"),
     *             @OA\Property(property="email", type="string", format="email"),
     *             @OA\Property(property="subject", type="string"),
     *             @OA\Property(property="body", type="string"),
     *             @OA\Property(property="link", type="string"),
     *         )
     *     ),
     *     @OA\Response(response="200", description="Announcement created successfully"),
     *     @OA\Response(response="401", description="Unauthorized"),
     * )
     */
    public function sendMail(Request $request)
    {
        $request->validate([
            "name" => "required",
            "email" => "required",
            "subject" => "required",
            "body" => "required",
            "link" => "required",
        ]);
        $data = [
            'name' => $request->name,
            'subject' => $request->subject,
            'body' => $request->body,
            'link' => $request->link,
        ];

        Mail::to($request->email)->send(new SSSMails($data));

        return response()->json([
            "status" => true,
            "message" => "Mailed Successfully",
        ]);
    }



    //-- General

    /**
     * @OA\Get(
     *     path="/api/checkTokenValidity",
     *     tags={"General"},
     *     summary="Check if user is still logged in",
     *     description="No params needed except bearer token. If you get a 200, the token is still valid",
     *     security={{"bearerAuth": {}}},
     *     @OA\Response(response="200", description="Success", @OA\JsonContent()),
     *     @OA\Response(response="401", description="Unauthorized"),
     * )
     */
    public function checkTokenValidity()
    {
        return response()->json([
            "status" => true,
            "message" => "Token OK",
        ]);
    }

    /**
     * @OA\Get(
     *     path="/api/logout",
     *     tags={"General"},
     *     summary="Logout a user",
     *     description="No params needed",
     *     security={{"bearerAuth": {}}},
     *     @OA\Response(response="200", description="Success", @OA\JsonContent()),
     * )
     */
    public function logout()
    {
        auth()->logout();
        return response()->json([
            "status" => true,
            "message" => "Logout successful",
        ]);
    }

    //--- Only for mess handling---

    public function mgetSchools()
    {
        $pld = school::all();
        return response()->json([
            "status" => true,
            "message" => "Success",
            "pld" => $pld,
        ]);
    }

    public function mgetSchoolClasses($schid)
    {
        $pld = school_class::where('schid', $schid)->get();
        return response()->json([
            "status" => true,
            "message" => "Success",
            "pld" => $pld,
        ]);
    }

    public function mgetStudentInSchoolAndClass($schid, $cls)
    {
        $pld = student::join('student_academic_data', 'student.sid', '=', 'student_academic_data.user_id')
            ->where('student.schid', $schid)
            ->where('student_academic_data.new_class_main', $cls)
            ->get();
        return response()->json([
            "status" => true,
            "message" => "Success",
            "pld" => $pld,
        ]);
    }

    public function mgetStudentSubjects($stid)
    {
        $pld = student_subj::where("stid", $stid)->get();
        return response()->json([
            "status" => true,
            "message" => "Success",
            "pld" => $pld,
        ]);
    }

    ////////////////////////////////////////////////////////////

    /**
     * @OA\Post(
     *     path="/api/setAcceptanceAcct",
     *     summary="Create or update an acceptance account and integrate with Paystack subaccount",
     *     tags={"Accounts"},
     *
     *     @OA\RequestBody(
     *         required=true,
     *         @OA\JsonContent(
     *             required={"schid", "clsid", "ssn", "trm", "anum", "bnk", "aname"},
     *
     *             @OA\Property(property="schid", type="string", example="6822"),
     *             @OA\Property(property="clsid", type="string", example="JSS1"),
     *             @OA\Property(property="ssn", type="string", example="2024"),
     *             @OA\Property(property="trm", type="string", example="1"),
     *
     *             @OA\Property(property="anum", type="string", example="0123456789"),
     *             @OA\Property(property="bnk", type="string", example="044"),
     *             @OA\Property(property="aname", type="string", example="John Doe")
     *         )
     *     ),
     *
     *     @OA\Response(
     *         response=200,
     *         description="Account Updated Successfully"
     *     ),
     *
     *     @OA\Response(
     *         response=201,
     *         description="Account and Paystack Subaccount Created Successfully"
     *     ),
     *
     *     @OA\Response(
     *         response=400,
     *         description="Failed to create Paystack subaccount"
     *     ),
     *
     *     @OA\Response(
     *         response=422,
     *         description="Validation error"
     *     ),
     *
     *     security={{"bearerAuth":{}}}
     * )
     */


    public function setAcceptanceAcct(Request $request)
    {
        $request->validate([
            'schid' => 'required',
            'anum' => 'required',
            'bnk' => 'required',
            'aname' => 'required',
            'clsid' => 'required',
            'ssn' => 'required',
            'trm' => 'required',
        ]);

        // Fields used to match an existing record
        $match = [
            'schid' => $request->schid,
            'clsid' => $request->clsid,
            'ssn' => $request->ssn,
            'trm' => $request->trm,
        ];

        // Fields used to update or create record
        $data = [
            'anum' => $request->anum,
            'bnk' => $request->bnk,
            'aname' => $request->aname,
        ];

        // Create or update acceptance account
        $acct = acceptance_acct::updateOrCreate($match, $data);

        // If this is a new record, proceed to create Paystack Subaccount
        if ($acct->wasRecentlyCreated) {

            $business_name = "Business_" . uniqid();
            $percentage_charge = 0;
            $settlement_bank = $request->bnk;

            // PAYSTACK SUBACCOUNT CREATION
            $response = Http::withHeaders([
                'Authorization' => 'Bearer ' . env('PAYSTACK_SECRET'),
                'Content-Type' => 'application/json',
            ])->post('https://api.paystack.co/subaccount', [
                        'business_name' => $business_name,
                        'account_number' => $request->anum,
                        'bank_code' => $request->bnk,
                        'percentage_charge' => $percentage_charge,
                        'settlement_bank' => $settlement_bank,
                    ]);

            if ($response->successful()) {

                $data = $response->json();

                // STORE SUBACCOUNT DETAILS
                acceptance_sub_acct::create([
                    'acct_id' => $acct->id,
                    'schid' => $request->schid,
                    'subaccount_code' => $data['data']['subaccount_code'],
                    'percentage_charge' => $percentage_charge,
                ]);

                return response()->json([
                    "status" => true,
                    "message" => "Account and Paystack Subaccount Created Successfully",
                    "paystack_data" => $data,
                ]);
            }

            // If Paystack failed  rollback new record
            $acct->delete();

            return response()->json([
                "status" => false,
                "message" => "Failed to Create Paystack Subaccount",
                "error" => $response->body(),
            ], 400);
        }

        // If record was updated (not created)
        return response()->json([
            "status" => true,
            "message" => "Account Updated Successfully",
        ]);
    }




    /**
     * @OA\Post(
     *     path="/api/setApplicationAcct",
     *     tags={"Accounts"},
     *     summary="Create or update an application account with Paystack subaccount integration",
     *     description="This endpoint automatically creates or updates an application account based on schid, class, session, and term. If the record is newly created, the system creates a Paystack subaccount.",
     *     security={{"bearerAuth": {}}},

     *     @OA\RequestBody(
     *         required=true,
     *         @OA\JsonContent(
     *             required={"schid", "anum", "bnk", "aname", "ssn", "trm"},

     *             @OA\Property(property="schid", type="integer", example=6822, description="School ID"),
     *             @OA\Property(property="anum", type="string", example="0123456789", description="Account Number"),
     *             @OA\Property(property="bnk", type="string", example="044", description="Bank Code (e.g Access Bank = 044)"),
     *             @OA\Property(property="aname", type="string", example="John Doe", description="Account Name"),
     *             @OA\Property(property="ssn", type="string", example="2024/2025", description="Session"),
     *             @OA\Property(property="trm", type="string", example="1", description="Term")
     *         )
     *     ),

     *     @OA\Response(
     *         response=200,
     *         description="Account created or updated successfully",
     *         @OA\JsonContent(
     *             @OA\Property(property="status", type="boolean", example=true),
     *             @OA\Property(property="message", type="string", example="Account Updated Successfully")
     *         )
     *     ),

     *     @OA\Response(
     *         response=201,
     *         description="New account and Paystack subaccount created",
     *         @OA\JsonContent(
     *             @OA\Property(property="status", type="boolean", example=true),
     *             @OA\Property(property="message", type="string", example="Account and Paystack Subaccount Created Successfully"),
     *             @OA\Property(
     *                 property="paystack_data",
     *                 type="object",
     *                 example={
     *                     "status": true,
     *                     "message": "Subaccount created",
     *                     "data": {
     *                         "subaccount_code": "SUB_31920DSK",
     *                         "business_name": "Business_67A9283"
     *                     }
     *                 }
     *             )
     *         )
     *     ),

     *     @OA\Response(
     *         response=400,
     *         description="Paystack subaccount creation failed",
     *         @OA\JsonContent(
     *             @OA\Property(property="status", type="boolean", example=false),
     *             @OA\Property(property="message", type="string", example="Failed to Create Paystack Subaccount"),
     *             @OA\Property(property="error", type="string", example="Paystack error response message")
     *         )
     *     ),

     *     @OA\Response(
     *         response=422,
     *         description="Validation Error",
     *         @OA\JsonContent(
     *             @OA\Property(property="status", type="boolean", example=false),
     *             @OA\Property(property="message", type="string", example="Validation Error"),
     *             @OA\Property(
     *                 property="errors",
     *                 type="object",
     *                 example={"schid": {"The schid field is required."}}
     *             )
     *         )
     *     )
     * )
     *
     */


    public function setApplicationAcct(Request $request)
    {
        $request->validate([
            'schid' => 'required',
            'anum' => 'required',
            'bnk' => 'required',
            'aname' => 'required',
            'ssn' => 'required',
            'trm' => 'required',
        ]);

        // Unique fields for update
        $match = [
            'schid' => $request->schid,
            'ssn' => $request->ssn,
            'trm' => $request->trm,
        ];

        // Values to update
        $data = [
            'anum' => $request->anum,
            'bnk' => $request->bnk,
            'aname' => $request->aname,
        ];

        // Create or update the application account
        $acct = application_acct::updateOrCreate($match, $data);

        // If created (new)
        if ($acct->wasRecentlyCreated) {

            // PAYSTACK SUBACCOUNT CREATION
            $business_name = "Business_" . uniqid();
            $percentage_charge = 0;
            $settlement_bank = $request->bnk;

            $response = Http::withHeaders([
                'Authorization' => 'Bearer ' . env('PAYSTACK_SECRET'),
                'Content-Type' => 'application/json',
            ])->post('https://api.paystack.co/subaccount', [
                        'business_name' => $business_name,
                        'account_number' => $request->anum,
                        'bank_code' => $request->bnk,
                        'percentage_charge' => $percentage_charge,
                        'settlement_bank' => $settlement_bank,
                    ]);

            if ($response->successful()) {
                // Save subaccount details
                $data = $response->json();

                application_sub_acct::create([
                    'acct_id' => $acct->id,
                    'schid' => $request->schid,
                    'subaccount_code' => $data['data']['subaccount_code'],
                    'percentage_charge' => $percentage_charge,
                ]);

                return response()->json([
                    "status" => true,
                    "message" => "Account and Paystack Subaccount Created Successfully",
                    "paystack_data" => $data,
                ]);
            } else {
                // If subaccount creation fails, delete the account
                $acct->delete();

                return response()->json([
                    "status" => false,
                    "message" => "Failed to Create Paystack Subaccount",
                    "error" => $response->body(),
                ], 400);
            }
        }

        // If updated
        return response()->json([
            "status" => true,
            "message" => "Account Updated Successfully",
        ]);
    }



    /**
     * @OA\Get(
     *     path="/api/getAcctApp/{schid}",
     *     tags={"Accounts"},
     *     security={{"bearerAuth": {}}},
     *     summary="Get all Application Accounts by School",
     *     description="Use this endpoint to get all Application Accounts by School with optional filters",
     *
     *     @OA\Parameter(
     *         name="schid",
     *         in="path",
     *         required=true,
     *         description="School ID",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Parameter(
     *         name="ssn",
     *         in="query",
     *         required=false,
     *         description="Session",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Parameter(
     *         name="trm",
     *         in="query",
     *         required=false,
     *         description="Term",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Parameter(
     *         name="start",
     *         in="query",
     *         required=false,
     *         description="Index to start at",
     *         @OA\Schema(type="integer", default=0)
     *     ),
     *     @OA\Parameter(
     *         name="count",
     *         in="query",
     *         required=false,
     *         description="Number of records to retrieve",
     *         @OA\Schema(type="integer", default=20)
     *     ),
     *
     *     @OA\Response(
     *         response=200,
     *         description="Success",
     *         @OA\JsonContent(
     *             @OA\Property(property="status", type="boolean", example=true),
     *             @OA\Property(property="message", type="string", example="Success"),
     *             @OA\Property(property="pld", type="array",
     *                 @OA\Items(
     *                     type="object",
     *                     @OA\Property(property="id", type="integer", example=1),
     *                     @OA\Property(property="schid", type="string", example="12345"),
     *                     @OA\Property(property="anum", type="string", example="1234567890"),
     *                     @OA\Property(property="bnk", type="string", example="Bank XYZ"),
     *                     @OA\Property(property="aname", type="string", example="John Doe"),
     *                     @OA\Property(property="ssn", type="string", example="2024/2025"),
     *                     @OA\Property(property="trm", type="string", example="1st"),
     *                     @OA\Property(property="subAccounts", type="array",
     *                         @OA\Items(
     *                             type="object",
     *                             @OA\Property(property="subaccount_code", type="string", example="SUB_98765"),
     *                             @OA\Property(property="percentage_charge", type="integer", example=0)
     *                         )
     *                     )
     *                 )
     *             )
     *         )
     *     ),
     *
     *     @OA\Response(response="401", description="Unauthorized"),
     *
     *     @OA\Response(
     *         response=404,
     *         description="No records found",
     *         @OA\JsonContent(
     *             @OA\Property(property="status", type="boolean", example=false),
     *             @OA\Property(property="message", type="string", example="No records found"),
     *             @OA\Property(property="pld", type="array", @OA\Items(type="object"))
     *         )
     *     )
     * )
     */


    public function getAcctApp(Request $request, $schid)
    {
        $start = $request->input('start', 0);
        $count = $request->input('count', 20);

        // Optional filters
        $ssn = $request->input('ssn', null);
        $trm = $request->input('trm', null);

        // Base query
        $query = application_acct::where('schid', $schid)->with('subAccounts');

        // Apply optional filters
        if (!is_null($ssn)) {
            $query->where('ssn', $ssn);
        }

        if (!is_null($trm)) {
            $query->where('trm', $trm);
        }

        // Pagination
        $pld = $query->skip($start)->take($count)->get();

        if ($pld->isEmpty()) {
            return response()->json([
                "status" => false,
                "message" => "No records found",
                "pld" => $pld,
            ], 404);
        }

        return response()->json([
            "status" => true,
            "message" => "Success",
            "pld" => $pld,
        ]);
    }





    /**
     * @OA\Get(
     *     path="/api/getAcctAccept/{schid}",
     *     tags={"Accounts"},
     *     security={{"bearerAuth": {}}},
     *     summary="Get all Accounts by School",
     *     description="Use this endpoint to get all Accounts by School with optional filters",
     *
     *     @OA\Parameter(
     *         name="schid",
     *         in="path",
     *         required=true,
     *         description="School ID",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Parameter(
     *         name="clsid",
     *         in="query",
     *         required=false,
     *         description="Class ID (-1 for all classes)",
     *         @OA\Schema(type="integer", default=-1)
     *     ),
     *     @OA\Parameter(
     *         name="ssn",
     *         in="query",
     *         required=false,
     *         description="Session",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Parameter(
     *         name="trm",
     *         in="query",
     *         required=false,
     *         description="Term",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Parameter(
     *         name="start",
     *         in="query",
     *         required=false,
     *         description="Index to start at",
     *         @OA\Schema(type="integer", default=0)
     *     ),
     *     @OA\Parameter(
     *         name="count",
     *         in="query",
     *         required=false,
     *         description="Number of records to retrieve",
     *         @OA\Schema(type="integer", default=20)
     *     ),
     *
     *     @OA\Response(
     *         response=200,
     *         description="Success",
     *         @OA\JsonContent(
     *             @OA\Property(property="status", type="boolean", example=true),
     *             @OA\Property(property="message", type="string", example="Success"),
     *             @OA\Property(property="pld", type="array",
     *                 @OA\Items(
     *                     type="object",
     *                     @OA\Property(property="id", type="integer", example=1),
     *                     @OA\Property(property="schid", type="string", example="12345"),
     *                     @OA\Property(property="clsid", type="string", example="67890"),
     *                     @OA\Property(property="anum", type="string", example="1234567890"),
     *                     @OA\Property(property="bnk", type="string", example="Bank XYZ"),
     *                     @OA\Property(property="aname", type="string", example="John Doe"),
     *                     @OA\Property(property="ssn", type="string", example="2024/2025"),
     *                     @OA\Property(property="trm", type="string", example="1st"),
     *                     @OA\Property(property="subAccounts", type="array",
     *                         @OA\Items(
     *                             type="object",
     *                             @OA\Property(property="subaccount_code", type="string", example="SUB_98765"),
     *                             @OA\Property(property="percentage_charge", type="integer", example=0)
     *                         )
     *                     )
     *                 )
     *             )
     *         )
     *     ),
     *
     *     @OA\Response(response="401", description="Unauthorized"),
     *
     *     @OA\Response(
     *         response=404,
     *         description="No records found",
     *         @OA\JsonContent(
     *             @OA\Property(property="status", type="boolean", example=false),
     *             @OA\Property(property="message", type="string", example="No records found"),
     *             @OA\Property(property="pld", type="array", @OA\Items(type="object"))
     *         )
     *     )
     * )
     */


    public function getAcctAccept(Request $request, $schid)
    {
        $start = $request->input('start', 0);
        $count = $request->input('count', 20);

        // Optional filters
        $clsid = $request->input('clsid', -1); // -1 means all classes
        $ssn = $request->input('ssn', null);
        $trm = $request->input('trm', null);

        // Base query
        $query = acceptance_acct::where('schid', $schid)->with('subAccounts');

        // Apply optional filters
        if ($clsid != -1) {
            $query->where('clsid', $clsid);
        }

        if (!is_null($ssn)) {
            $query->where('ssn', $ssn);
        }

        if (!is_null($trm)) {
            $query->where('trm', $trm);
        }

        // Pagination
        $pld = $query->skip($start)->take($count)->get();

        if ($pld->isEmpty()) {
            return response()->json([
                "status" => false,
                "message" => "No records found",
                "pld" => $pld,
            ], 404);
        }

        return response()->json([
            "status" => true,
            "message" => "Success",
            "pld" => $pld,
        ]);
    }


    /**
     * @OA\Post(
     *     path="/api/setChangePassword",
     *     summary="Change User Password",
     *     description="Allows an authenticated user to change their password by providing the old password, a new password, and the school ID.",
     *     operationId="setChangePassword",
     *     tags={"Api"},
     *     security={{ "bearerAuth": {} }},
     *     @OA\RequestBody(
     *         required=true,
     *         @OA\JsonContent(
     *             required={"old_password", "new_password", "new_password_confirmation", "schid"},
     *             @OA\Property(property="old_password", type="string", example="currentPassword123"),
     *             @OA\Property(property="new_password", type="string", example="newSecurePassword456"),
     *             @OA\Property(property="new_password_confirmation", type="string", example="newSecurePassword456"),
     *             @OA\Property(property="schid", type="integer", example=101)
     *         )
     *     ),
     *     @OA\Response(
     *         response=200,
     *         description="Password updated successfully",
     *         @OA\JsonContent(
     *             @OA\Property(property="status", type="string", example="success"),
     *             @OA\Property(property="message", type="string", example="Password updated successfully."),
     *             @OA\Property(property="token", type="string", example="new_jwt_token"),
     *             @OA\Property(property="schid", type="integer", example=101)
     *         )
     *     ),
     *     @OA\Response(
     *         response=400,
     *         description="Old password does not match",
     *         @OA\JsonContent(
     *             @OA\Property(property="status", type="string", example="error"),
     *             @OA\Property(property="message", type="string", example="Old password does not match")
     *         )
     *     ),
     *     @OA\Response(
     *         response=401,
     *         description="Unauthorized",
     *         @OA\JsonContent(
     *             @OA\Property(property="status", type="string", example="error"),
     *             @OA\Property(property="message", type="string", example="Unauthorized")
     *         )
     *     )
     * )
     */

    public function setChangePassword(Request $request)
    {
        // Validate input
        $request->validate([
            'old_password' => 'required',
            'new_password' => 'required|confirmed',
            'schid' => 'required' // Validate school ID
        ]);

        // Get authenticated user
        $user = auth()->user();

        // Verify old password
        if (!Hash::check($request->old_password, $user->password)) {
            return response()->json([
                'status' => 'error',
                'message' => 'Old password does not match'
            ], 400);
        }

        // Retrieve school ID from the request
        $schoolId = $request->schid;

        // Update password
        $user->update([
            'password' => Hash::make($request->new_password),
        ]);

        // Generate a new JWT token for continued authentication
        $newToken = auth()->refresh();

        return response()->json([
            'status' => 'success',
            'message' => 'Password updated successfully.',
            'token' => $newToken,  // Send the new token to the frontend
            'schid' => $schoolId    // Return school ID if needed
        ], 200);
    }


    /**
     * @OA\Post(
     *     path="/api/exitStaff/{schid}/{stid}",
     *     summary="Exit a staff member and move them to the exstaffs table",
     *     description="Marks a staff member as inactive and transfers their data to the exstaffs table along with session and exit details.",
     *     operationId="exitStaff",
     *     tags={"Api"},
     *     security={{"bearerAuth": {}}},
     *     @OA\Parameter(
     *         name="schid",
     *         in="path",
     *         required=true,
     *         description="School ID of the staff",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Parameter(
     *         name="stid",
     *         in="path",
     *         required=true,
     *         description="Staff ID",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\RequestBody(
     *         required=true,
     *         @OA\JsonContent(
     *             required={"reason_for_exit"},
     *             @OA\Property(property="reason_for_exit", type="string", example="Retirement")
     *         )
     *     ),
     *     @OA\Response(
     *         response=200,
     *         description="Staff successfully exited and moved to exstaffs",
     *         @OA\JsonContent(
     *             @OA\Property(property="status", type="boolean", example=true),
     *             @OA\Property(property="message", type="string", example="Staff has been exited successfully and moved to exstaffs.")
     *         )
     *     ),
     *     @OA\Response(
     *         response=400,
     *         description="Staff has already been moved to exstaffs",
     *         @OA\JsonContent(
     *             @OA\Property(property="status", type="boolean", example=false),
     *             @OA\Property(property="message", type="string", example="Staff has already been moved to exstaffs.")
     *         )
     *     ),
     *     @OA\Response(
     *         response=404,
     *         description="Staff not found",
     *         @OA\JsonContent(
     *             @OA\Property(property="status", type="boolean", example=false),
     *             @OA\Property(property="message", type="string", example="Staff not found.")
     *         )
     *     ),
     *     @OA\Response(
     *         response=422,
     *         description="Validation error",
     *         @OA\JsonContent(
     *             @OA\Property(property="status", type="boolean", example=false),
     *             @OA\Property(property="message", type="string", example="The reason_for_exit field is required.")
     *         )
     *     )
     * )
     */



    public function exitStaff(Request $request, $schid, $stid)
    {
        // Validate the request
        $request->validate([
            'reason_for_exit' => 'required|string|max:555',
        ]);

        // Find the staff
        $staff = staff::where('schid', $schid)->where('sid', $stid)->first();

        if (!$staff) {
            return response()->json([
                'status' => false,
                'message' => 'Staff not found.',
            ], 404);
        }

        // Check if staff is already in the ex_staff table
        if (ex_staff::where('stid', $stid)->where('schid', $schid)->exists()) {
            return response()->json([
                'status' => false,
                'message' => 'Staff has already been moved to ex_staffs.',
            ], 400);
        }

        // Retrieve session_of_entry and term_of_entry from old_staff
        $oldStaff = old_staff::where('sid', $stid)->where('schid', $schid)->first();
        $sessionOfEntry = $oldStaff ? $oldStaff->ssn : ($staff->created_at ? $staff->created_at->year : null);

        // Generate the `suid`
        $count = $staff->count;
        $suid = $staff->sch3 . '/STAFF/' . strval($count);

        // Start Transaction
        DB::beginTransaction();

        try {
            // Update staff status
            $staff->update([
                'status' => 'inactive',
                'exit_status' => 'exited'
            ]);

            // Ensure old_staff table reflects the status change
            if (DB::table('old_staff')->where('schid', $schid)->where('sid', $stid)->exists()) {
                DB::table('old_staff')
                    ->where('schid', $schid)
                    ->where('sid', $stid)
                    ->update(['status' => 'inactive']);
            }

            // Refresh staff to ensure status change
            $staff->refresh();

            // Move to ex_staff table only if status is inactive
            if ($staff->status === 'inactive') {
                ex_staff::create([
                    'stid' => $staff->sid,
                    'schid' => $staff->schid,
                    'suid' => $suid,
                    'lname' => $staff->lname,
                    'fname' => $staff->fname,
                    'mname' => $staff->mname,
                    'sch3' => $staff->sch3,
                    'count' => strval($count),
                    'session_of_entry' => $sessionOfEntry,
                    'date_of_entry' => $staff->created_at->toDateString(),
                    'session_of_exit' => now()->year,
                    'date_of_exit' => now()->toDateString(),
                    'reason_for_exit' => $request->input('reason_for_exit'),
                ]);
            }

            // Commit Transaction
            DB::commit();

            return response()->json([
                'status' => true,
                'message' => 'Staff has been exited successfully and moved to ex_staffs.',
            ], 200);
        } catch (\Exception $e) {
            // Rollback on failure
            DB::rollBack();

            return response()->json([
                'status' => false,
                'message' => 'Failed to exit staff. Please try again.',
                'error' => $e->getMessage()
            ], 500);
        }
    }





    /**
     * @OA\Get(
     *     path="/api/getAlumni/{schid}",
     *     tags={"Api"},
     *     security={{"bearerAuth": {}}},
     *     summary="Get all Alumni by School",
     *     description="Retrieve a list of alumni for a given school with optional filtering by exit class and exit class arm.",
     *
     *     @OA\Parameter(
     *         name="schid",
     *         in="path",
     *         required=true,
     *         description="School ID",
     *         @OA\Schema(type="integer")
     *     ),
     *     @OA\Parameter(
     *         name="start",
     *         in="query",
     *         required=false,
     *         description="Index to start at",
     *         @OA\Schema(type="integer", default=0)
     *     ),
     *     @OA\Parameter(
     *         name="count",
     *         in="query",
     *         required=false,
     *         description="Number of records to retrieve",
     *         @OA\Schema(type="integer", default=20)
     *     ),
     *     @OA\Parameter(
     *         name="exit_class",
     *         in="query",
     *         required=false,
     *         description="Exit class of the alumni (e.g., SS3, JSS3)",
     *         @OA\Schema(type="string", example="SS3")
     *     ),
     *     @OA\Parameter(
     *         name="exit_class_arm",
     *         in="query",
     *         required=false,
     *         description="Exit class arm of the alumni (e.g., A, B, C)",
     *         @OA\Schema(type="string", example="A")
     *     ),
     *
     *     @OA\Response(
     *         response=200,
     *         description="Success",
     *         @OA\JsonContent(
     *             @OA\Property(property="status", type="boolean", example=true),
     *             @OA\Property(property="message", type="string", example="Success"),
     *             @OA\Property(property="total", type="integer", example=5),
     *             @OA\Property(property="pld", type="array",
     *                 @OA\Items(
     *                     @OA\Property(property="id", type="integer", example=1),
     *                     @OA\Property(property="name", type="string", example="John Doe"),
     *                     @OA\Property(property="schid", type="integer", example=101),
     *                     @OA\Property(property="exit_class", type="string", example="SS3"),
     *                     @OA\Property(property="exit_class_arm", type="string", example="A"),
     *                     @OA\Property(property="year_graduated", type="integer", example=2020)
     *                 )
     *             )
     *         )
     *     ),
     *
     *     @OA\Response(response="401", description="Unauthorized"),
     *     @OA\Response(
     *         response=404,
     *         description="No alumni found",
     *         @OA\JsonContent(
     *             @OA\Property(property="status", type="boolean", example=false),
     *             @OA\Property(property="message", type="string", example="No alumni found"),
     *             @OA\Property(property="total", type="integer", example=0),
     *             @OA\Property(property="pld", type="array", @OA\Items())
     *         )
     *     )
     * )
     */


    public function getAlumni($schid)
    {
        $start = 0;
        $count = 20;

        // Check if 'start' and 'count' query parameters are provided
        if (request()->has('start') && request()->has('count')) {
            $start = request()->input('start');
            $count = request()->input('count');
        }

        // Retrieve additional filters from query parameters
        $exitClass = request()->input('exit_class');
        $exitClassArm = request()->input('exit_class_arm');

        // Query alumni table with optional filtering
        $query = alumni::where('schid', $schid);

        if (!empty($exitClass)) {
            $query->where('exit_class', $exitClass);
        }
        if (!empty($exitClassArm)) {
            $query->where('exit_class_arm', $exitClassArm);
        }

        // Sort alphabetically by fname (A  Z)
        $query->orderBy('lname', 'asc');

        // Get total count before pagination.
        $totalAlumni = $query->count();

        // Apply pagination
        $alumni = $query->skip($start)->take($count)->get();

        return response()->json([
            "status" => true,
            "message" => "Success",
            "total" => $totalAlumni,
            "pld" => $alumni,
        ]);
    }






    /**
     * @OA\Get(
     *     path="/api/getExStaff/{schid}",
     *     tags={"Api"},
     *     security={{"bearerAuth": {}}},
     *     summary="Get all ex-staff by school",
     *     description="Use this endpoint to retrieve all ex-staff members from a specific school, with optional pagination.",
     *
     *     @OA\Parameter(
     *         name="schid",
     *         in="path",
     *         required=true,
     *         description="School ID",
     *         @OA\Schema(type="integer")
     *     ),
     *     @OA\Parameter(
     *         name="start",
     *         in="query",
     *         required=false,
     *         description="Index to start at (for pagination)",
     *         @OA\Schema(type="integer", default=0)
     *     ),
     *     @OA\Parameter(
     *         name="count",
     *         in="query",
     *         required=false,
     *         description="Number of records to retrieve",
     *         @OA\Schema(type="integer", default=20)
     *     ),
     *
     *     @OA\Response(
     *         response=200,
     *         description="Success",
     *         @OA\JsonContent(
     *             @OA\Property(property="status", type="boolean", example=true),
     *             @OA\Property(property="message", type="string", example="Success"),
     *             @OA\Property(property="data", type="array",
     *                 @OA\Items(
     *                     @OA\Property(property="id", type="integer", example=1),
     *                     @OA\Property(property="fname", type="string", example="John"),
     *                     @OA\Property(property="lname", type="string", example="Doe"),
     *                     @OA\Property(property="schid", type="integer", example=101),
     *                     @OA\Property(property="session_of_exit", type="integer", example=2022),
     *                     @OA\Property(property="date_of_exit", type="string", format="date", example="2022-05-15"),
     *                     @OA\Property(property="reason_for_exit", type="string", example="Retired")
     *                 )
     *             )
     *         )
     *     ),
     *
     *     @OA\Response(response="401", description="Unauthorized"),
     *     @OA\Response(
     *         response=404,
     *         description="No ex-staff found",
     *         @OA\JsonContent(
     *             @OA\Property(property="status", type="boolean", example=false),
     *             @OA\Property(property="message", type="string", example="No ex-staff found"),
     *             @OA\Property(property="data", type="array", @OA\Items())
     *         )
     *     )
     * )
     */


    public function getExStaff($schid)
    {
        $start = request()->input('start', 0);
        $count = request()->input('count', 20);

        // Get total count of ex-staff in the school
        $totalExStaff = ex_staff::where('schid', $schid)->count();

        // Retrieve ex-staff with pagination
        $pld = ex_staff::where('schid', $schid)
            ->skip($start)
            ->take($count)
            ->get();

        if ($pld->isEmpty()) {
            return response()->json([
                "status" => false,
                "message" => "No ex-staff found",
                "total" => 0,
                "pld" => [],
            ], 404);
        }

        return response()->json([
            "status" => true,
            "message" => "Success",
            "total" => $totalExStaff, // Total number of ex-staff
            "pld" => $pld,
        ]);
    }



    /**
     * @OA\Get(
     *     path="/api/getExStaff/{schid}",
     *     tags={"Api"},
     *     security={{"bearerAuth": {}}},
     *     summary="Get all ex-staff by School",
     *     description="Use this endpoint to get all ex-staff by School",
     *
     *     @OA\Parameter(
     *         name="schid",
     *         in="path",
     *         required=true,
     *         description="School ID",
     *         @OA\Schema(type="integer")
     *     ),
     *     @OA\Parameter(
     *         name="start",
     *         in="query",
     *         required=false,
     *         description="Index to start at",
     *         @OA\Schema(type="integer", default=0)
     *     ),
     *     @OA\Parameter(
     *         name="count",
     *         in="query",
     *         required=false,
     *         description="Number of records to retrieve",
     *         @OA\Schema(type="integer", default=20)
     *     ),
     *
     *     @OA\Response(
     *         response=200,
     *         description="Success",
     *         @OA\JsonContent(
     *             @OA\Property(property="status", type="boolean", example=true),
     *             @OA\Property(property="message", type="string", example="Success"),
     *             @OA\Property(property="pld", type="array",
     *                 @OA\Items(
     *                     @OA\Property(property="sid", type="integer", example=1),
     *                     @OA\Property(property="lname", type="string", example="Doe"),
     *                     @OA\Property(property="fname", type="string", example="John"),
     *                     @OA\Property(property="mname", type="string", example="Michael"),
     *                     @OA\Property(property="schid", type="integer", example=101),
     *                     @OA\Property(property="date_of_entry", type="string", format="date", example="2022-03-01"),
     *                     @OA\Property(property="date_of_exit", type="string", format="date", example="2024-09-15"),
     *                     @OA\Property(property="reason_for_exit", type="string", example="Retirement")
     *                 )
     *             )
     *         )
     *     ),
     *
     *     @OA\Response(response="401", description="Unauthorized"),
     *     @OA\Response(
     *         response=404,
     *         description="No ex-staff found",
     *         @OA\JsonContent(
     *             @OA\Property(property="status", type="boolean", example=false),
     *             @OA\Property(property="message", type="string", example="No ex-staff found"),
     *             @OA\Property(property="pld", type="array", @OA\Items())
     *         )
     *     )
     * )
     */


    /**
     * @OA\Post(
     *     path="/api/restoreStudent/{schid}/{stid}",
     *     summary="Restore an inactive student",
     *     description="Changes the status of a student from 'inactive' to 'active' based on school ID and student ID.",
     *     tags={"Api"},
     *     security={{"bearerAuth": {}}},
     *     @OA\Parameter(
     *         name="schid",
     *         in="path",
     *         required=true,
     *         description="School ID",
     *         @OA\Schema(type="integer")
     *     ),
     *     @OA\Parameter(
     *         name="stid",
     *         in="path",
     *         required=true,
     *         description="Student ID",
     *         @OA\Schema(type="integer")
     *     ),
     *     @OA\Response(
     *         response=200,
     *         description="Student restored successfully",
     *         @OA\JsonContent(
     *             type="object",
     *             @OA\Property(property="status", type="boolean", example=true),
     *             @OA\Property(property="message", type="string", example="Student restored successfully"),
     *             @OA\Property(property="data", type="object",
     *                 @OA\Property(property="id", type="integer", example=1),
     *                 @OA\Property(property="schid", type="integer", example=101),
     *                 @OA\Property(property="sid", type="integer", example=5001),
     *                 @OA\Property(property="status", type="string", example="active")
     *             )
     *         )
     *     ),
     *     @OA\Response(
     *         response=404,
     *         description="Student not found or already active",
     *         @OA\JsonContent(
     *             type="object",
     *             @OA\Property(property="status", type="boolean", example=false),
     *             @OA\Property(property="message", type="string", example="Student not found or already active")
     *         )
     *     )
     * )
     */

    // restore
    public function restoreStudent($schid, $stid)
    {
        // Start transaction for atomic operations
        DB::beginTransaction();

        try {
            // Find inactive student in old_student table
            $pld = DB::table('old_student')
                ->where('schid', $schid)
                ->where('sid', $stid)
                ->where('status', 'inactive')
                ->first();

            if (!$pld) {
                DB::rollBack(); // Rollback transaction if student is not found
                return response()->json([
                    'status' => false,
                    'message' => 'Student not found or already active in old_student.',
                ], 404);
            }

            // Restore student in old_student table
            DB::table('old_student')
                ->where('schid', $schid)
                ->where('sid', $stid)
                ->update([
                    'status' => 'active'
                ]);

            // Restore student in student table (if exists)
            $studentExists = DB::table('student')
                ->where('schid', $schid)
                ->where('sid', $stid)
                ->exists();

            if ($studentExists) {
                DB::table('student')
                    ->where('schid', $schid)
                    ->where('sid', $stid)
                    ->update([
                        'status' => 'active',
                        'exit_status' => NULL // Set exit_status to NULL
                    ]);
            }

            // Remove the student from the alumni table
            alumni::where('schid', $schid)->where('stid', $stid)->delete();

            // Commit transaction
            DB::commit();

            return response()->json([
                'status' => true,
                'message' => 'Student restored successfully in old_student and removed from alumni.',
            ], 200);
        } catch (\Exception $e) {
            // Rollback changes if anything fails
            DB::rollBack();

            return response()->json([
                'status' => false,
                'message' => 'Failed to restore student. Please try again.',
                'error' => $e->getMessage()
            ], 500);
        }
    }





    /**
     * @OA\Post(
     *     path="/api/restoreStaff/{schid}/{stid}",
     *     summary="Restore a staff member",
     *     description="Restores a staff member by setting their status to active and removing their record from the ex-staff table.",
     *     tags={"Api"},
     *     security={{"bearerAuth": {}}},
     *     @OA\Parameter(
     *         name="schid",
     *         in="path",
     *         description="School ID",
     *         required=true,
     *         @OA\Schema(type="integer")
     *     ),
     *     @OA\Parameter(
     *         name="stid",
     *         in="path",
     *         description="Staff ID",
     *         required=true,
     *         @OA\Schema(type="integer")
     *     ),
     *     @OA\Response(
     *         response=200,
     *         description="Staff restored successfully and removed from ex-staff.",
     *         @OA\JsonContent(
     *             type="object",
     *             @OA\Property(property="status", type="boolean", example=true),
     *             @OA\Property(property="message", type="string", example="Staff restored successfully and removed from ex-staff."),
     *             @OA\Property(property="pld", type="object",
     *                 @OA\Property(property="sid", type="integer", example=123),
     *                 @OA\Property(property="status", type="string", example="active"),
     *                 @OA\Property(property="exit_status", type="string", example=null)
     *             )
     *         )
     *     ),
     *     @OA\Response(
     *         response=404,
     *         description="Staff not found or already active.",
     *         @OA\JsonContent(
     *             type="object",
     *             @OA\Property(property="status", type="boolean", example=false),
     *             @OA\Property(property="message", type="string", example="Staff not found or already active.")
     *         )
     *     )
     * )
     */

    public function restoreStaff($schid, $stid)
    {
        // Start transaction for atomic operations
        DB::beginTransaction();

        try {
            // Find inactive staff in old_staff table
            $pld = DB::table('old_staff')
                ->where('schid', $schid)
                ->where('sid', $stid)
                ->where('status', 'inactive')
                ->first();

            if (!$pld) {
                DB::rollBack(); // Rollback transaction if staff is not found
                return response()->json([
                    'status' => false,
                    'message' => 'Staff not found or already active in old_staff.',
                ], 404);
            }

            // Restore staff in old_staff table
            DB::table('old_staff')
                ->where('schid', $schid)
                ->where('sid', $stid)
                ->update([
                    'status' => 'active'
                ]);

            // Restore staff in staff table (if exists)
            $staffExists = DB::table('staff')
                ->where('schid', $schid)
                ->where('sid', $stid)
                ->exists();

            if ($staffExists) {
                DB::table('staff')
                    ->where('schid', $schid)
                    ->where('sid', $stid)
                    ->update([
                        'status' => 'active',
                        'exit_status' => NULL // Set exit_status to NULL
                    ]);
            }

            // Remove the staff from the ex_staff table
            ex_staff::where('schid', $schid)->where('stid', $stid)->delete();

            // Commit transaction
            DB::commit();

            return response()->json([
                'status' => true,
                'message' => 'Staff restored successfully in old_staff and removed from ex_staff.',
            ], 200);
        } catch (\Exception $e) {
            // Rollback changes if anything fails
            DB::rollBack();

            return response()->json([
                'status' => false,
                'message' => 'Failed to restore staff. Please try again.',
                'error' => $e->getMessage()
            ], 500);
        }
    }




    /**
     * @OA\Post(
     *     path="/api/setPaymentInstruction",
     *     summary="Create or Update Payment Instruction",
     *     description="This endpoint creates a new payment instruction or updates an existing one if an ID is provided.",
     *     tags={"Api"},
     *     security={{"bearerAuth": {}}},
     *     @OA\RequestBody(
     *         required=true,
     *         @OA\JsonContent(
     *             required={"schid", "clsid", "sesid", "trmid", "payment_ins"},
     *             @OA\Property(property="id", type="integer", example=1, description="Optional: ID for updating an existing record"),
     *             @OA\Property(property="schid", type="integer", example=101, description="School ID"),
     *             @OA\Property(property="clsid", type="integer", example=5, description="Class ID"),
     *             @OA\Property(property="sesid", type="integer", example=2024, description="Session ID"),
     *             @OA\Property(property="trmid", type="integer", example=2, description="Term ID"),
     *             @OA\Property(property="payment_ins", type="string", example="Pay before 10th of the month", description="Payment instructions"),
     *         ),
     *     ),
     *     @OA\Response(
     *         response=200,
     *         description="Success",
     *         @OA\JsonContent(
     *             @OA\Property(property="status", type="boolean", example=true),
     *             @OA\Property(property="message", type="string", example="Payment Instruction Updated")
     *         ),
     *     ),
     *     @OA\Response(
     *         response=404,
     *         description="Record Not Found",
     *         @OA\JsonContent(
     *             @OA\Property(property="status", type="boolean", example=false),
     *             @OA\Property(property="message", type="string", example="Record Not Found")
     *         ),
     *     ),
     *     @OA\Response(
     *         response=422,
     *         description="Validation Error",
     *         @OA\JsonContent(
     *             @OA\Property(property="status", type="boolean", example=false),
     *             @OA\Property(property="message", type="string", example="The given data was invalid.")
     *         ),
     *     ),
     * )
     */

    // Set Payment Instruction
    public function setPaymentInstruction(Request $request)
    {
        $request->validate([
            'schid' => 'required',
            'clsid' => 'required',
            'sesid' => 'required',
            'trmid' => 'required',
            'payment_ins' => 'required',
        ]);
        $data = [
            'schid' => $request->schid,
            'clsid' => $request->clsid,
            'sesid' => $request->sesid,
            'trmid' => $request->trmid,
            'payment_ins' => $request->payment_ins,
        ];
        $clspay = [];
        if ($request->has('id')) {
            $payment_instruction = payment_instruction::where('id', $request->id)->first();
            if ($payment_instruction) {
                $payment_instruction->update($data);
            } else {
                return response()->json([
                    "status" => false,
                    "message" => "Record Not Found",
                ]);
            }
        } else {
            $payment_instruction = payment_instruction::create($data);
        }
        return response()->json([
            "status" => true,
            "message" => "Payment Instruction Updated"
        ]);
    }



    /**
     * @OA\Get(
     *     path="/api/getPaymentInstruction/{schid}/{clsid}/{sesid}/{trmid}",
     *     tags={"Api"},
     *     security={{"bearerAuth": {}}},
     *     summary="Get Payment Instruction",
     *     description="Retrieve the payment instruction for a specific class, term, session, and school.",
     *
     *     @OA\Parameter(
     *         name="schid",
     *         in="path",
     *         required=true,
     *         description="School ID",
     *         @OA\Schema(type="integer")
     *     ),
     *     @OA\Parameter(
     *         name="clsid",
     *         in="path",
     *         required=true,
     *         description="Class ID",
     *         @OA\Schema(type="integer")
     *     ),
     *     @OA\Parameter(
     *         name="sesid",
     *         in="path",
     *         required=true,
     *         description="Session ID",
     *         @OA\Schema(type="integer")
     *     ),
     *     @OA\Parameter(
     *         name="trmid",
     *         in="path",
     *         required=true,
     *         description="Term ID",
     *         @OA\Schema(type="integer")
     *     ),
     *
     *     @OA\Response(
     *         response=200,
     *         description="Success",
     *         @OA\JsonContent(
     *             @OA\Property(property="status", type="boolean", example=true),
     *             @OA\Property(property="message", type="string", example="Success"),
     *             @OA\Property(property="payment_ins", type="string", example="Payment should be made before 10th of the month")
     *         )
     *     ),
     *
     *     @OA\Response(
     *         response=404,
     *         description="No payment instruction available",
     *         @OA\JsonContent(
     *             @OA\Property(property="status", type="boolean", example=false),
     *             @OA\Property(property="message", type="string", example="No payment instruction available")
     *         )
     *     ),
     *
     *     @OA\Response(response="401", description="Unauthorized")
     * )
     */


    public function getPaymentInstruction($schid, $clsid, $sesid, $trmid)
    {
        $query = payment_instruction::query();

        if ($schid !== "-1") {
            $query->where('schid', $schid);
        }

        if ($clsid !== "-1") {
            $query->where('clsid', $clsid);
        }

        if ($sesid !== "-1") {
            $query->where('sesid', $sesid);
        }

        if ($trmid !== "-1") {
            $query->where('trmid', $trmid);
        }

        $payment_instructions = $query->get()->map(function ($payment) {
            return [
                "schid" => $payment->schid,
                "clsid" => $payment->clsid,
                "trmid" => $payment->trmid,
                "sesid" => $payment->sesid,
                "payment_ins" => $payment->payment_ins,
                "class_name" => cls::where('id', $payment->clsid)->value('name'),
                "term_name" => trm::where('no', $payment->trmid)->value('name'),
                "session_name" => sesn::where('year', $payment->sesid)->value('name'),
            ];
        });

        if ($payment_instructions->isEmpty()) {
            return response()->json([
                "status" => false,
                "message" => "No payment instructions available",
                "pld" => []
            ]);
        }

        return response()->json([
            "status" => true,
            "message" => "Success",
            "pld" => $payment_instructions, // Returns both IDs and names
        ]);
    }




    /**
     * @OA\Delete(
     *     path="/api/deletePaymentInstruction/{schid}/{clsid}/{sesid}/{trmid}",
     *     summary="Delete a payment instruction",
     *     description="Deletes payment instructions based on the provided school ID, class ID, session ID, and term ID.",
     *     operationId="deletePaymentInstruction",
     *     tags={"Api"},
     *      security={{"bearerAuth": {}}},
     *
     *     @OA\Parameter(
     *         name="schid",
     *         in="path",
     *         required=true,
     *         description="School ID",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Parameter(
     *         name="clsid",
     *         in="path",
     *         required=true,
     *         description="Class ID",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Parameter(
     *         name="sesid",
     *         in="path",
     *         required=true,
     *         description="Session ID",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Parameter(
     *         name="trmid",
     *         in="path",
     *         required=true,
     *         description="Term ID",
     *         @OA\Schema(type="string")
     *     ),
     *
     *     @OA\Response(
     *         response=200,
     *         description="Payment instruction(s) deleted successfully",
     *         @OA\JsonContent(
     *             @OA\Property(property="status", type="boolean", example=true),
     *             @OA\Property(property="message", type="string", example="Payment instruction(s) deleted successfully")
     *         )
     *     ),
     *     @OA\Response(
     *         response=404,
     *         description="No matching payment instruction(s) found",
     *         @OA\JsonContent(
     *             @OA\Property(property="status", type="boolean", example=false),
     *             @OA\Property(property="message", type="string", example="No matching payment instruction(s) found")
     *         )
     *     ),
     *     @OA\Response(
     *         response=500,
     *         description="Internal server error",
     *         @OA\JsonContent(
     *             @OA\Property(property="status", type="boolean", example=false),
     *             @OA\Property(property="message", type="string", example="An error occurred while deleting payment instruction(s).")
     *         )
     *     )
     * )
     */


    // Delete
    public function deletePaymentInstruction($schid, $clsid, $sesid, $trmid)
    {
        $query = payment_instruction::query();

        if ($schid !== "-1") {
            $query->where('schid', $schid);
        }

        if ($clsid !== "-1") {
            $query->where('clsid', $clsid);
        }

        if ($sesid !== "-1") {
            $query->where('sesid', $sesid);
        }

        if ($trmid !== "-1") {
            $query->where('trmid', $trmid);
        }

        $deletedRows = $query->delete();

        if ($deletedRows > 0) {
            return response()->json([
                "status" => true,
                "message" => "Payment instruction(s) deleted successfully",
            ]);
        }

        return response()->json([
            "status" => false,
            "message" => "No matching payment instruction(s) found",
        ], 404);
    }




    /////////////////////////

    /**
     * @OA\Post(
     *     path="/api/setAttendanceMark",
     *     summary="Set attendance for multiple students",
     *     description="Allows Admin or Form Teacher to set or update attendance status for students for a specific term, class, week, and day.",
     *     tags={"Api"},
     *     security={{"bearerAuth": {}}},
     *     @OA\RequestBody(
     *         required=true,
     *         @OA\JsonContent(
     *             required={"schid", "ssn", "trm", "clsm", "clsa", "stid", "week", "day", "students"},
     *             @OA\Property(property="schid", type="string", example="SCH123"),
     *             @OA\Property(property="ssn", type="string", example="SSN001"),
     *             @OA\Property(property="trm", type="string", example="2024/2025"),
     *             @OA\Property(property="clsm", type="string", example="JSS1"),
     *             @OA\Property(property="clsa", type="string", example="A"),
     *             @OA\Property(property="stid", type="string", example="STAFF001"),
     *             @OA\Property(property="week", type="integer", example=3, minimum=1, maximum=14),
     *             @OA\Property(property="day", type="string", enum={"monday", "tuesday", "wednesday", "thursday", "friday"}, example="monday"),
     *             @OA\Property(
     *                 property="students",
     *                 type="array",
     *                 @OA\Items(
     *                     @OA\Property(property="sid", type="string", example="STU001"),
     *                     @OA\Property(property="status", type="integer", enum={0,1,2}, example=1, description="0 = Draft, 1 = Present, 2 = Absent")
     *                 )
     *             )
     *         )
     *     ),
     *     @OA\Response(
     *         response=200,
     *         description="Attendance marked successfully",
     *         @OA\JsonContent(
     *             @OA\Property(property="status", type="string", example="success"),
     *             @OA\Property(property="message", type="string", example="Attendance marked successfully for students."),
     *             @OA\Property(property="data", type="array", @OA\Items(type="object"))
     *         )
     *     ),
     *     @OA\Response(
     *         response=403,
     *         description="Unauthorized or staff not found",
     *         @OA\JsonContent(
     *             @OA\Property(property="status", type="string", example="error"),
     *             @OA\Property(property="message", type="string", example="Unauthorized")
     *         )
     *     )
     * )
     */


    public function setAttendanceMark(Request $request)
    {
        $validated = $request->validate([
            'schid' => 'required|string',
            'ssn' => 'required|string',
            'trm' => 'required|string',
            'clsm' => 'required|string',
            'clsa' => 'required|string',
            'stid' => 'nullable|string', // stid is now optional
            'week' => 'required|integer|min:1|max:14',
            'day' => 'required|in:monday,tuesday,wednesday,thursday,friday',
            'students' => 'required|array',
            'students.*.sid' => 'required|string',
            'students.*.status' => 'required|in:0,1,2',
        ]);

        // Check staff only if stid is provided
        if (!empty($validated['stid'])) {
            $staff = staff::where('sid', $validated['stid'])->first();

            if (!$staff) {
                return response()->json(['status' => 'error', 'message' => 'Staff not found'], 403);
            }

            $roles = staff_role::whereIn('id', [$staff->role, $staff->role2])->pluck('name')->toArray();
            if (!array_intersect(['Admin', 'Form Teacher'], $roles)) {
                return response()->json(['status' => 'error', 'message' => 'Unauthorized'], 403);
            }
        }

        $marked = [];

        foreach ($validated['students'] as $student) {
            $existing = attendance::where([
                'schid' => $validated['schid'],
                'ssn' => $validated['ssn'],
                'trm' => $validated['trm'],
                'clsm' => $validated['clsm'],
                'clsa' => $validated['clsa'],
                'sid' => $student['sid'],
                'week' => $validated['week'],
                'day' => $validated['day'],
            ])->first();

            if ($existing) {
                $existing->update([
                    'status' => $student['status'],
                    'stid' => $validated['stid'] ?? null,
                ]);
                $marked[] = $existing;
            } else {
                $marked[] = attendance::create([
                    'schid' => $validated['schid'],
                    'ssn' => $validated['ssn'],
                    'trm' => $validated['trm'],
                    'clsm' => $validated['clsm'],
                    'clsa' => $validated['clsa'],
                    'sid' => $student['sid'],
                    'stid' => $validated['stid'] ?? null, // Safe nullable fallback
                    'week' => $validated['week'],
                    'day' => $validated['day'],
                    'status' => $student['status'],
                ]);
            }
        }

        return response()->json([
            'status' => 'success',
            'message' => 'Attendance marked successfully for students.',
            'pld' => $marked
        ]);
    }



    ///
    /**
     * @OA\Post(
     *     path="/api/submitAttendance",
     *     summary="Submit attendance for students",
     *     description="Allows Admin or Form Teacher to submit attendance for students for a specific week and day.",
     *     tags={"Api"},
     *     security={{"bearerAuth": {}}},
     *     @OA\RequestBody(
     *         required=true,
     *         @OA\JsonContent(
     *             required={"schid", "ssn", "trm", "clsm", "clsa", "stid", "week", "day", "students"},
     *             @OA\Property(property="schid", type="string", example="SCH123", description="School ID"),
     *             @OA\Property(property="ssn", type="string", example="2024", description="Session"),
     *             @OA\Property(property="trm", type="string", example="2024/2025", description="Term"),
     *             @OA\Property(property="clsm", type="string", example="SSS3", description="Class Main"),
     *             @OA\Property(property="clsa", type="string", example="A", description="Class Arm"),
     *             @OA\Property(property="stid", type="string", example="STAFF001", description="Staff ID"),
     *             @OA\Property(property="week", type="integer", example=1, description="Week number (1 to 14)"),
     *             @OA\Property(property="day", type="string", example="Monday", description="Day of the week (e.g., Monday, Tuesday, etc.)"),
     *             @OA\Property(
     *                 property="students",
     *                 type="array",
     *                 @OA\Items(
     *                     @OA\Property(property="sid", type="string", example="STU001", description="Student ID"),
     *                     @OA\Property(property="status", type="integer", enum={0, 1, 2}, example=1, description="0 = Draft, 1 = Present, 2 = Absent")
     *                 )
     *             )
     *         )
     *     ),
     *     @OA\Response(
     *         response=200,
     *         description="Attendance submitted successfully",
     *         @OA\JsonContent(
     *             @OA\Property(property="status", type="string", example="success"),
     *             @OA\Property(property="message", type="string", example="Attendance submitted successfully."),
     *             @OA\Property(
     *                 property="pld",
     *                 type="array",
     *                 @OA\Items(
     *                     @OA\Property(property="sid", type="string", example="STU001"),
     *                     @OA\Property(property="week", type="integer", example=1),
     *                     @OA\Property(property="day", type="string", example="Monday"),
     *                     @OA\Property(property="status", type="string", example="Present")
     *                 )
     *             )
     *         )
     *     ),
     *     @OA\Response(
     *         response=403,
     *         description="Unauthorized: Only Admin or Form Teachers can submit attendance",
     *         @OA\JsonContent(
     *             @OA\Property(property="status", type="string", example="error"),
     *             @OA\Property(property="message", type="string", example="Unauthorized: Only Admin or Form Teachers can submit attendance.")
     *         )
     *     ),
     *     @OA\Response(
     *         response=404,
     *         description="Staff not found",
     *         @OA\JsonContent(
     *             @OA\Property(property="status", type="string", example="error"),
     *             @OA\Property(property="message", type="string", example="Unauthorized: Staff not found.")
     *         )
     *     )
     * )
     */



    // Submit attendance (for admin, form teachers)
    // Submit attendance (for admin, form teachers)
    public function submitAttendance(Request $request)
    {
        // Validate request
        $validated = $request->validate([
            'schid' => 'required|string',
            'ssn' => 'required|string',
            'trm' => 'required|string',
            'clsm' => 'required|string',
            'clsa' => 'required|string',
            'stid' => 'nullable|string', // Now optional
            'week' => 'required|integer|between:1,14',
            'day' => 'required|string',
            'students' => 'required|array',
            'students.*.sid' => 'required|string',
            'students.*.status' => 'required|in:0,1,2',
        ]);

        // If stid is provided, check the staff role
        if (!empty($validated['stid'])) {
            $staff = staff::where('sid', $validated['stid'])->first();

            if (!$staff) {
                return response()->json([
                    "status" => "error",
                    "message" => "Unauthorized: Staff not found."
                ], 403);
            }

            // Retrieve the role names from the staff_role table
            $roleNames = staff_role::whereIn('id', [$staff->role, $staff->role2])
                ->pluck('name')
                ->toArray();

            // Allow Form Teachers, Admin to submit attendance
            $allowedRoles = ['Form Teacher', 'Admin'];

            if (empty(array_intersect($allowedRoles, $roleNames))) {
                return response()->json([
                    "status" => "error",
                    "message" => "Unauthorized: Only Admin or Form Teachers can submit attendance."
                ], 403);
            }
        }

        // Proceed with saving attendance (even if stid is null)
        return $this->saveAttendanceSubmission($validated);
    }

    // Save the attendance submission records to the database
    private function saveAttendanceSubmission($validated)
    {
        $attendanceData = [];

        foreach ($validated['students'] as $studentData) {
            // Check if attendance already exists for this student in the specified week and day
            $existingAttendance = attendance::where('schid', $validated['schid'])
                ->where('ssn', $validated['ssn'])
                ->where('trm', $validated['trm'])
                ->where('clsm', $validated['clsm'])
                ->where('clsa', $validated['clsa'])
                ->where('sid', $studentData['sid'])
                ->where('week', $validated['week'])
                ->where('day', $validated['day'])
                ->first();

            // If attendance exists, update it
            if ($existingAttendance) {
                $existingAttendance->status = $studentData['status'];
                $existingAttendance->stid = $validated['stid'] ?? null;

                $existingAttendance->save();

                $attendanceData[] = $existingAttendance;
            } else {
                // If attendance doesn't exist, create a new record
                $attendance = attendance::create([
                    'schid' => $validated['schid'],
                    'ssn' => $validated['ssn'],
                    'trm' => $validated['trm'], // Store the term
                    'clsm' => $validated['clsm'],
                    'clsa' => $validated['clsa'],
                    'sid' => $studentData['sid'],
                    'status' => $studentData['status'],
                    'stid' => $validated['stid'] ?? null,
                    'week' => $validated['week'], // Add the week
                    'day' => $validated['day'],  // Use the day provided in the request
                ]);

                $attendanceData[] = $attendance;
            }
        }

        // Create the response format to include week and day breakdown for each student
        $responseData = [];
        foreach ($attendanceData as $attendance) {
            $responseData[] = [
                'sid' => $attendance->sid,
                'week' => $attendance->week,
                'day' => $attendance->day,  // Return the day as passed in the request
                'status' => $attendance->status == 0 ? 'Draft' : ($attendance->status == 1 ? 'Present' : 'Absent'),
            ];
        }

        return response()->json([
            "status" => "success",
            "message" => "Attendance submitted successfully.",
            "pld" => $responseData // Return the detailed breakdown for each student
        ], 200);
    }



    ////
    /**
     * @OA\Get(
     *     path="/api/getAttendance/{week}/{schid}/{trm}/{ssn}/{clsm}/{clsa}",
     *     summary="Retrieve attendance records for a given week",
     *     description="Fetches all attendance records for a specified school, term, session, class main, and class arm for the given week (excluding day).",
     *     operationId="getAttendance",
     *     tags={"Api"},
     *     security={{"bearerAuth": {}}},
     *
     *     @OA\Parameter(
     *         name="week",
     *         in="path",
     *         required=true,
     *         description="Week number (1-14)",
     *         @OA\Schema(type="integer", example=2)
     *     ),
     *     @OA\Parameter(
     *         name="schid",
     *         in="path",
     *         required=true,
     *         description="School ID",
     *         @OA\Schema(type="string", example="SCH12345")
     *     ),
     *     @OA\Parameter(
     *         name="trm",
     *         in="path",
     *         required=true,
     *         description="Term (e.g., First, Second, Third)",
     *         @OA\Schema(type="string", example="First")
     *     ),
     *     @OA\Parameter(
     *         name="ssn",
     *         in="path",
     *         required=true,
     *         description="Session (e.g., 2024/2025)",
     *         @OA\Schema(type="string", example="2024/2025")
     *     ),
     *     @OA\Parameter(
     *         name="clsm",
     *         in="path",
     *         required=true,
     *         description="Class Main (e.g., JSS1)",
     *         @OA\Schema(type="string", example="JSS1")
     *     ),
     *     @OA\Parameter(
     *         name="clsa",
     *         in="path",
     *         required=true,
     *         description="Class Arm (e.g., A, B, C)",
     *         @OA\Schema(type="string", example="A")
     *     ),
     *
     *     @OA\Response(
     *         response=200,
     *         description="Attendance records retrieved successfully",
     *         @OA\JsonContent(
     *             @OA\Property(property="status", type="string", example="success"),
     *             @OA\Property(property="message", type="string", example="Attendance records retrieved successfully."),
     *             @OA\Property(
     *                 property="pld",
     *                 type="array",
     *                 @OA\Items(
     *                     @OA\Property(property="sid", type="string", example="STU001"),
     *                     @OA\Property(property="student_name", type="string", example="John Doe"),
     *                     @OA\Property(property="status", type="string", example="Present"),
     *                     @OA\Property(property="week", type="integer", example=2),
     *                     @OA\Property(property="day", type="string", example="Monday")
     *                 )
     *             )
     *         )
     *     ),
     *
     *     @OA\Response(
     *         response=404,
     *         description="No attendance records found",
     *         @OA\JsonContent(
     *             @OA\Property(property="status", type="string", example="error"),
     *             @OA\Property(property="message", type="string", example="No attendance records found for this week.")
     *         )
     *     )
     * )
     */


    // Get attendance for a student
    public function getAttendance($week, $schid, $trm, $ssn, $clsm, $clsa)
    {
        // Retrieve the attendance records for the specified week (day removed)
        $attendances = attendance::where('week', $week)
            ->where('schid', $schid)
            ->where('ssn', $ssn)
            ->where('trm', $trm)
            ->where('clsm', $clsm)
            ->where('clsa', $clsa)
            ->get();

        // Check if no attendance records are found
        if ($attendances->isEmpty()) {
            return response()->json([
                'status' => 'error',
                'message' => 'No attendance records found for this week.',
            ], 404);
        }

        // Format the attendance details for each student
        $attendanceDetails = $attendances->map(function ($attendance) {
            // Retrieve student details (e.g., name, id)
            $student = student::where('sid', $attendance->sid)->first();

            // Concatenate first, middle, and last names
            $fullName = $student ? trim($student->fname . ' ' . $student->mname . ' ' . $student->lname) : 'Unknown';

            return [
                'sid' => $attendance->sid,
                'student_name' => $fullName,
                'status' => $attendance->status == 0 ? 'Draft' : ($attendance->status == 1 ? 'Present' : 'Absent'),
                'week' => $attendance->week,
                'day' => $attendance->day, // Still returning day in result if available
            ];
        });

        return response()->json([
            'status' => 'success',
            'message' => 'Attendance records retrieved successfully.',
            'pld' => $attendanceDetails,
        ], 200);
    }



    ////

    /**
     * @OA\Get(
     *     path="/api/calculateAttendanceForClass/{schid}/{ssn}/{clsm}/{clsa}",
     *     summary="Calculate attendance for a class",
     *     description="Retrieve the attendance statistics (days present and absent) for students in a specific class.",
     *     tags={"Api"},
     *     security={{"bearerAuth": {}}},
     *     @OA\Parameter(
     *         name="schid",
     *         in="path",
     *         required=true,
     *         description="School ID",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Parameter(
     *         name="ssn",
     *         in="path",
     *         required=true,
     *         description="Student ID Number",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Parameter(
     *         name="clsm",
     *         in="path",
     *         required=true,
     *         description="Class",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Parameter(
     *         name="clsa",
     *         in="path",
     *         required=true,
     *         description="Class Section",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Response(
     *         response=200,
     *         description="Attendance statistics retrieved successfully",
     *         @OA\JsonContent(
     *             @OA\Property(property="status", type="integer", example=1),
     *             @OA\Property(property="attendance_counts", type="object", additionalProperties={
     *                 @OA\Property(type="object",
     *                               @OA\Property(property="days_present", type="integer", example=10),
     *                               @OA\Property(property="days_absent", type="integer", example=2)
     *                 )
     *             })
     *         )
     *     )
     * )
     */


    public function calculateAttendanceForClass($schid, $ssn, $clsm, $clsa)
    {
        // Get all attendance records for the class
        $attendance = Attendance::where('schid', $schid)
            ->where('ssn', $ssn)
            ->where('clsm', $clsm)
            ->where('clsa', $clsa)
            ->get();

        // Initialize an array to store attendance counts for each student
        $attendanceCounts = [];

        // Loop through the attendance records and count the days present/absent for each student
        foreach ($attendance as $record) {
            // If the student already exists in the array, increment the counts
            if (!isset($attendanceCounts[$record->sid])) {
                $attendanceCounts[$record->sid] = [
                    'days_present' => 0,
                    'days_absent' => 0
                ];
            }

            // Count present or absent days for this student
            if ($record->status == Attendance::STATUS_PRESENT) {
                $attendanceCounts[$record->sid]['days_present']++;
            } elseif ($record->status == Attendance::STATUS_ABSENT) {
                $attendanceCounts[$record->sid]['days_absent']++;
            }
        }

        // Return the attendance counts for all students
        return response()->json([
            'status' => true,
            'attendance_counts' => $attendanceCounts,
        ]);
    }


    //////////////////////////////////

    /**
     * @OA\Get(
     *     path="/api/getAttendanceByWeek/{week}/{schid}",
     *     summary="Retrieve attendance records grouped by day for a specific week",
     *     description="Fetches attendance records for a specified week and school ID, grouping the data by day and returning student attendance details for each day.",
     *     tags={"Api"},
     *     security={{"bearerAuth": {}}},
     *     @OA\Parameter(
     *         name="week",
     *         in="path",
     *         required=true,
     *         @OA\Schema(type="integer", example=1, description="Week number (1 to 14)")
     *     ),
     *     @OA\Parameter(
     *         name="schid",
     *         in="path",
     *         required=true,
     *         @OA\Schema(type="string", example="SCH123", description="School ID")
     *     ),
     *     @OA\Response(
     *         response=200,
     *         description="Attendance records grouped by day retrieved successfully",
     *         @OA\JsonContent(
     *             @OA\Property(property="status", type="string", example="success"),
     *             @OA\Property(property="message", type="string", example="Attendance records grouped by day for the selected week."),
     *             @OA\Property(property="week", type="integer", example=1),
     *             @OA\Property(
     *                 property="attendance_by_day",
     *                 type="array",
     *                 @OA\Items(
     *                     @OA\Property(property="day", type="string", example="Monday"),
     *                     @OA\Property(property="total_present", type="integer", example=20),
     *                     @OA\Property(property="total_absent", type="integer", example=5),
     *                     @OA\Property(
     *                         property="students",
     *                         type="array",
     *                         @OA\Items(
     *                             @OA\Property(property="sid", type="string", example="STU001"),
     *                             @OA\Property(property="student_name", type="string", example="Doe John Smith"),
     *                             @OA\Property(property="status", type="string", example="Present")
     *                         )
     *                     )
     *                 )
     *             )
     *         )
     *     ),
     *     @OA\Response(
     *         response=404,
     *         description="No attendance records found for this week",
     *         @OA\JsonContent(
     *             @OA\Property(property="status", type="string", example="error"),
     *             @OA\Property(property="message", type="string", example="No attendance records found for this week.")
     *         )
     *     )
     * )
     */


    public function getAttendanceByWeek($week, $schid)
    {
        // Fetch attendance for the specified school and week
        $attendances = attendance::where('week', $week)
            ->where('schid', $schid)
            ->get();

        if ($attendances->isEmpty()) {
            return response()->json([
                'status' => 'error',
                'message' => 'No attendance records found for this week.',
            ], 404);
        }

        // Group attendance records by day (e.g., monday, tuesday...)
        $groupedByDay = $attendances->groupBy('day')->map(function ($records, $day) {
            $students = $records->map(function ($attendance) {
                // Try to find student in current or old student table
                $student = student::where('sid', $attendance->sid)->first()
                    ?? old_student::where('sid', $attendance->sid)->first();

                $fullName = $student ? trim($student->lname . ' ' . $student->fname . ' ' . $student->mname) : 'Unknown';

                return [
                    'sid' => $attendance->sid,
                    'student_name' => $fullName,
                    'status' => match ($attendance->status) {
                        0 => 'Draft',
                        1 => 'Present',
                        2 => 'Absent',
                        default => 'Unknown'
                    },
                ];
            });

            // You can also include totals if you want
            $presentCount = $records->where('status', 1)->count();
            $absentCount = $records->where('status', 2)->count();

            return [
                'day' => ucfirst($day),
                'total_present' => $presentCount,
                'total_absent' => $absentCount,
                'students' => $students,
            ];
        })->values();

        return response()->json([
            'status' => 'success',
            'message' => 'Attendance records grouped by day for the selected week.',
            'week' => $week,
            'attendance_by_day' => $groupedByDay
        ], 200);
    }


    ////////////////

    /**
     * @OA\Get(
     *     path="/api/getFilteredAttendanceSummary/{schid}/{ssn}/{trm}/{clsm}/{clsa}",
     *     summary="Get filtered attendance summary",
     *     description="Retrieve weekly and overall attendance summary based on specified school, session, term, and class filters.",
     *     tags={"Api"},
     *     security={{"bearerAuth": {}}},
     *
     *     @OA\Parameter(
     *         name="schid",
     *         in="path",
     *         required=true,
     *         @OA\Schema(type="string", example="SCH123"),
     *         description="School ID"
     *     ),
     *     @OA\Parameter(
     *         name="ssn",
     *         in="path",
     *         required=true,
     *         @OA\Schema(type="string", example="2024"),
     *         description="Session"
     *     ),
     *     @OA\Parameter(
     *         name="trm",
     *         in="path",
     *         required=true,
     *         @OA\Schema(type="string", example="1"),
     *         description="Term"
     *     ),
     *     @OA\Parameter(
     *         name="clsm",
     *         in="path",
     *         required=true,
     *         @OA\Schema(type="string", example="JSS1"),
     *         description="Class Main (e.g., JSS1)"
     *     ),
     *     @OA\Parameter(
     *         name="clsa",
     *         in="path",
     *         required=true,
     *         @OA\Schema(type="string", example="A"),
     *         description="Class Arm (e.g., A, B, C)"
     *     ),
     *
     *     @OA\Response(
     *         response=200,
     *         description="Attendance summary retrieved successfully",
     *         @OA\JsonContent(
     *             @OA\Property(property="status", type="string", example="success"),
     *             @OA\Property(property="message", type="string", example="Attendance summary retrieved successfully."),
     *             @OA\Property(
     *                 property="summary",
     *                 type="array",
     *                 @OA\Items(
     *                     @OA\Property(property="week", type="integer", example=1),
     *                     @OA\Property(property="days_recorded", type="integer", example=5),
     *                     @OA\Property(property="present_count", type="integer", example=120),
     *                     @OA\Property(property="absent_count", type="integer", example=15)
     *                 )
     *             ),
     *             @OA\Property(
     *                 property="overall",
     *                 type="object",
     *                 @OA\Property(property="total_weeks", type="integer", example=14),
     *                 @OA\Property(property="total_present", type="integer", example=950),
     *                 @OA\Property(property="total_absent", type="integer", example=50),
     *                 @OA\Property(property="total_students", type="integer", example=100)
     *             )
     *         )
     *     ),
     *
     *     @OA\Response(
     *         response=404,
     *         description="No attendance records found",
     *         @OA\JsonContent(
     *             @OA\Property(property="status", type="string", example="error"),
     *             @OA\Property(property="message", type="string", example="No attendance records found for the specified filters.")
     *         )
     *     )
     * )
     */


    public function getFilteredAttendanceSummary($schid, $ssn, $trm, $clsm, $clsa)
    {
        // Fetch attendance records for specified filters
        $records = attendance::where('schid', $schid)
            ->where('ssn', $ssn)
            ->where('trm', $trm)
            ->where('clsm', $clsm)
            ->where('clsa', $clsa)
            ->get();

        // Get total number of students from the attendance table (unique student IDs)
        $totalStudents = $records->unique('sid')->count();

        if ($records->isEmpty()) {
            return response()->json([
                'status' => 'error',
                'message' => 'No attendance records found for the specified filters.'
            ], 404);
        }

        // Group by week and generate per-week summaries
        $weeklySummary = collect(range(1, 14))->map(function ($week) use ($records) {
            $weekRecords = $records->where('week', $week);
            $uniqueDays = $weekRecords->groupBy('day')->count();
            $present = $weekRecords->where('status', 1)->count();
            $absent = $weekRecords->where('status', 2)->count();

            return [
                'week' => $week,
                'days_recorded' => $uniqueDays,
                'present_count' => $present,
                'absent_count' => $absent,
            ];
        });

        // Calculate overall totals
        $totalPresent = $records->where('status', 1)->count();
        $totalAbsent = $records->where('status', 2)->count();
        $totalWeeksWithData = $records->pluck('week')->unique()->count();

        return response()->json([
            'status' => 'success',
            'message' => 'Attendance summary retrieved successfully.',
            'summary' => $weeklySummary,
            'overall' => [
                'total_weeks' => $totalWeeksWithData,
                'total_present' => $totalPresent,
                'total_absent' => $totalAbsent,
                'total_students' => $totalStudents,
            ]
        ]);
    }



    ///////////////////////////////////////////////////

    /**
     * @OA\Post(
     *     path="/api/setLessonPlan",
     *     summary="Create or update a lesson plan",
     *     description="Stores or updates a lesson plan based on school, session, term, class, subject, and date.",
     *     tags={"Api"},
     *     security={{"bearerAuth": {}}},
     *     @OA\RequestBody(
     *         required=true,
     *         @OA\JsonContent(
     *             required={
     *                 "schid", "clsm", "date", "ssn", "trm", "sbj",
     *                 "no_of_class", "average_age", "topic",
     *                 "time_from", "time_to", "duration"
     *             },
     *             @OA\Property(property="schid", type="string", example="SCH001"),
     *             @OA\Property(property="clsm", type="string", example="1"),
     *             @OA\Property(property="date", type="string", format="date", example="2025-05-09"),
     *             @OA\Property(property="ssn", type="string", example="2025"),
     *             @OA\Property(property="trm", type="string", example="2"),
     *             @OA\Property(property="sbj", type="string", example="Mathematics"),
     *             @OA\Property(property="no_of_class", type="integer", example=2),
     *             @OA\Property(property="average_age", type="number", format="float", example=10.5),
     *             @OA\Property(property="topic", type="string", example="Addition and Subtraction"),
     *             @OA\Property(
     *                 property="sub_topic",
     *                 type="array",
     *                 @OA\Items(type="string", example="Two-digit addition")
     *             ),
     *             @OA\Property(property="time_from", type="string", format="time", example="09:00"),
     *             @OA\Property(property="time_to", type="string", format="time", example="10:00"),
     *             @OA\Property(property="duration", type="string", example="1 hour"),
     *             @OA\Property(
     *                 property="learning_materials",
     *                 type="array",
     *                 @OA\Items(type="string", example="Flashcards")
     *             ),
     *  *             @OA\Property(
     *                 property="lesson_objectives",
     *                 type="array",
     *                 @OA\Items(type="string", example="At the end of the lesson, students should be able to count numbers")
     *             ),
     *         )
     *     ),
     *     @OA\Response(
     *         response=200,
     *         description="Lesson plan saved successfully",
     *         @OA\JsonContent(
     *             @OA\Property(property="status", type="boolean", example=true),
     *             @OA\Property(property="message", type="string", example="Lesson plan saved successfully"),
     *             @OA\Property(property="pld", type="object")
     *         )
     *     ),
     *     @OA\Response(
     *         response=422,
     *         description="Validation error",
     *         @OA\JsonContent(
     *             @OA\Property(property="message", type="string", example="The given data was invalid."),
     *             @OA\Property(
     *                 property="errors",
     *                 type="object",
     *                 additionalProperties=@OA\Property(type="array", @OA\Items(type="string"))
     *             )
     *         )
     *     )
     * )
     */


    public function setLessonPlan(Request $request)
    {
        $request->validate([
            "schid" => "required|string",
            "clsm" => "required|string",
            'date' => 'required|date',
            "ssn" => "required|string",
            "trm" => "required",
            "sbj" => "required|string",
            'no_of_class' => 'required|integer',
            'average_age' => 'required|numeric',
            'topic' => 'required|string',
            'sub_topic' => 'nullable|array',
            'time_from' => 'required|date_format:H:i',
            'time_to' => 'required|date_format:H:i|after:time_from',
            'duration' => 'required|string',
            'learning_materials' => 'nullable|array',
            'lesson_objectives' => 'required|array',
        ]);

        $data = $request->only([
            'date',
            'no_of_class',
            'average_age',
            'topic',
            'time_from',
            'time_to',
            'duration',
            "ssn",
            "trm",
            "sbj",
            "schid",
            "clsm",
        ]);

        $data['sub_topic'] = $request->sub_topic;
        $data['learning_materials'] = $request->learning_materials;
        $data['lesson_objectives'] = $request->lesson_objectives;

        $lessonPlan = lesson_plan::updateOrCreate(
            [
                'date' => $request->date,
                "schid" => $request->schid,
                "clsm" => $request->clsm,
                "ssn" => $request->ssn,
                "trm" => $request->trm,
                "sbj" => $request->sbj,
                "no_of_class" => $request->no_of_class,
                "time_from" => $request->time_from,
                "time_to" => $request->time_to,
                "topic" => $request->topic,
                "average_age" => $request->average_age
            ],
            $data
        );

        return response()->json([
            'status' => true,
            'message' => 'Lesson plan saved successfully',
            'pld' => $lessonPlan,
        ], 200);
    }



    //////////////////////////////////////////////////
    /**
     * @OA\Put(
     *     path="/api/updateLessonPlan",
     *     summary="Update a lesson plan",
     *     description="Updates an existing lesson plan record based on schid, clsm, ssn, and trm. Only provided fields will be updated.",
     *     operationId="updateLessonPlan",
     *     tags={"Api"},
     *     security={{"bearerAuth": {}}},
     *     @OA\RequestBody(
     *         required=true,
     *         @OA\JsonContent(
     *             required={"schid", "clsm", "ssn", "trm"},
     *             @OA\Property(property="schid", type="string", example="SCH001"),
     *             @OA\Property(property="clsm", type="string", example="1"),
     *             @OA\Property(property="ssn", type="string", example="2025"),
     *             @OA\Property(property="trm", type="string", example="2"),
     *             @OA\Property(property="sbj", type="string", example="Mathematics"),
     *             @OA\Property(property="no_of_class", type="integer", example=5),
     *             @OA\Property(property="average_age", type="integer", example=10),
     *             @OA\Property(property="topic", type="string", example="Multiplication"),
     *             @OA\Property(property="date", type="string", format="date", example="2025-05-15"),
     *             @OA\Property(property="sub_topic", type="array", @OA\Items(type="string"), example={"Introduction", "Examples"}),
     *             @OA\Property(property="time_from", type="string", format="time", example="08:00:00"),
     *             @OA\Property(property="time_to", type="string", format="time", example="09:00:00"),
     *             @OA\Property(property="duration", type="string", example="1 hour"),
     *             @OA\Property(property="learning_materials", type="array", @OA\Items(type="string"), example={"Chalkboard", "Chart"}),
     *             @OA\Property(property="lesson_objectives", type="array", @OA\Items(type="string"), example={"Understand concept", "Apply in daily life"})
     *         )
     *     ),
     *
     *     @OA\Response(
     *         response=200,
     *         description="Lesson Plan updated successfully",
     *         @OA\JsonContent(
     *             @OA\Property(property="status", type="boolean", example=true),
     *             @OA\Property(property="message", type="string", example="Lesson Plan updated successfully"),
     *             @OA\Property(property="data", type="object")
     *         )
     *     ),
     *
     *     @OA\Response(
     *         response=400,
     *         description="No valid fields provided for update",
     *         @OA\JsonContent(
     *             @OA\Property(property="status", type="boolean", example=false),
     *             @OA\Property(property="message", type="string", example="No valid fields provided for update")
     *         )
     *     ),
     *
     *     @OA\Response(
     *         response=404,
     *         description="Lesson Plan not found",
     *         @OA\JsonContent(
     *             @OA\Property(property="status", type="boolean", example=false),
     *             @OA\Property(property="message", type="string", example="Lesson Plan not found")
     *         )
     *     )
     * )
     */


    public function updateLessonPlan(Request $request)
    {
        $request->validate([
            "schid" => "required",
            "clsm" => "required",
            "ssn" => "required",
            "trm" => "required",

            // Optional fields for update
            "sbj" => "nullable",
            "no_of_class" => "nullable|integer",
            "average_age" => "nullable|integer",
            "topic" => "nullable|string",
            "date" => "nullable|date",
            "sub_topic" => "nullable|array",
            "time_from" => "nullable|date_format:H:i:s",
            "time_to" => "nullable|date_format:H:i:s",
            "duration" => "nullable|string",
            "learning_materials" => "nullable|array",
            "lesson_objectives" => "nullable|array",
        ]);

        $lessonPlan = lesson_plan::where("schid", $request->schid)
            ->where("clsm", $request->clsm)
            ->where("ssn", $request->ssn)
            ->where("trm", $request->trm)
            ->first();

        if (!$lessonPlan) {
            return response()->json([
                "status" => false,
                "message" => "Lesson Plan not found",
            ], 404);
        }

        // Fields allowed for update
        $fieldsToUpdate = collect($request->only([
            "sbj",
            "no_of_class",
            "average_age",
            "topic",
            "sub_topic",
            "date",
            "time_from",
            "time_to",
            "duration",
            "learning_materials",
            "lesson_objectives"
        ]))->filter(fn($value) => !is_null($value))->toArray();

        if (empty($fieldsToUpdate)) {
            return response()->json([
                "status" => false,
                "message" => "No valid fields provided for update",
            ], 400);
        }

        $lessonPlan->update($fieldsToUpdate);

        return response()->json([
            "status" => true,
            "message" => "Lesson Plan updated successfully",
            "data" => $lessonPlan
        ], 200);
    }




    ///////////////////////////////////////////////////

    /**
     * @OA\Get(
     *     path="/api/getLessonPlan/{schid}/{ssn}/{trm}/{clsm}",
     *     summary="Get lesson plans for a specific school, session, term, and class",
     *     description="Fetches lesson plans using school ID, session, term, and class with optional pagination parameters.",
     *     tags={"Api"},
     *     security={{"bearerAuth": {}}},
     *     @OA\Parameter(
     *         name="schid",
     *         in="path",
     *         required=true,
     *         description="School ID",
     *         @OA\Schema(type="string"),
     *         example="SCH001"
     *     ),
     *     @OA\Parameter(
     *         name="ssn",
     *         in="path",
     *         required=true,
     *         description="Session",
     *         @OA\Schema(type="string"),
     *         example="2025"
     *     ),
     *     @OA\Parameter(
     *         name="trm",
     *         in="path",
     *         required=true,
     *         description="Term ID",
     *         @OA\Schema(type="string"),
     *         example="2"
     *     ),
     *     @OA\Parameter(
     *         name="clsm",
     *         in="path",
     *         required=true,
     *         description="Class ID",
     *         @OA\Schema(type="string"),
     *         example="2"
     *     ),
     *     @OA\Parameter(
     *         name="start",
     *         in="query",
     *         required=false,
     *         description="Pagination start index",
     *         @OA\Schema(type="integer"),
     *         example=0
     *     ),
     *     @OA\Parameter(
     *         name="count",
     *         in="query",
     *         required=false,
     *         description="Number of lesson plans to retrieve",
     *         @OA\Schema(type="integer"),
     *         example=20
     *     ),
     *     @OA\Response(
     *         response=200,
     *         description="List of lesson plans retrieved successfully",
     *         @OA\JsonContent(
     *             @OA\Property(property="status", type="boolean", example=true),
     *             @OA\Property(property="message", type="string", example="Success"),
     *             @OA\Property(property="pld", type="array", @OA\Items(type="object"))
     *         )
     *     )
     * )
     */


    public function getLessonPlan($schid, $ssn, $trm, $clsm)
    {
        $start = 0;
        $count = 20;
        if (request()->has('start') && request()->has('count')) {
            $start = request()->input('start');
            $count = request()->input('count');
        }

        $lessonPlan = lesson_plan::where('schid', $schid)
            ->where("clsm", $clsm)
            ->where("ssn", $ssn)
            ->where("trm", $trm)
            ->take($count)->skip($start)->get();

        return response()->json([
            "status" => true,
            "message" => "Success",
            "pld" => $lessonPlan,
        ]);
    }




    //////////////////////////////////////////
    /**
     * @OA\Get(
     *     path="/api/getLessonPlanBySubject/{schid}/{ssn}/{trm}/{clsm}/{sbj}",
     *     summary="Get lesson plans by subject",
     *     description="Fetch lesson plans based on school ID, session, term, class, and subject with optional pagination.",
     *     tags={"Api"},
     *     security={{"bearerAuth": {}}},
     *     @OA\Parameter(
     *         name="schid",
     *         in="path",
     *         required=true,
     *         description="School ID",
     *         @OA\Schema(type="string"),
     *         example="SCH001"
     *     ),
     *     @OA\Parameter(
     *         name="ssn",
     *         in="path",
     *         required=true,
     *         description="Session",
     *         @OA\Schema(type="string"),
     *         example="2025"
     *     ),
     *     @OA\Parameter(
     *         name="trm",
     *         in="path",
     *         required=true,
     *         description="Term ID",
     *         @OA\Schema(type="string"),
     *         example="2"
     *     ),
     *     @OA\Parameter(
     *         name="clsm",
     *         in="path",
     *         required=true,
     *         description="Class ID",
     *         @OA\Schema(type="string"),
     *         example="2"
     *     ),
     *     @OA\Parameter(
     *         name="sbj",
     *         in="path",
     *         required=true,
     *         description="Subject name",
     *         @OA\Schema(type="string"),
     *         example="Mathematics"
     *     ),
     *     @OA\Parameter(
     *         name="start",
     *         in="query",
     *         required=false,
     *         description="Pagination start index",
     *         @OA\Schema(type="integer"),
     *         example=0
     *     ),
     *     @OA\Parameter(
     *         name="count",
     *         in="query",
     *         required=false,
     *         description="Number of records to retrieve",
     *         @OA\Schema(type="integer"),
     *         example=20
     *     ),
     *     @OA\Response(
     *         response=200,
     *         description="Lesson plans retrieved successfully",
     *         @OA\JsonContent(
     *             @OA\Property(property="status", type="boolean", example=true),
     *             @OA\Property(property="message", type="string", example="Success"),
     *             @OA\Property(property="pld", type="array", @OA\Items(type="object"))
     *         )
     *     )
     * )
     */

    public function getLessonPlanBySubject($schid, $ssn, $trm, $clsm, $sbj)
    {
        $start = 0;
        $count = 20;
        if (request()->has('start') && request()->has('count')) {
            $start = request()->input('start');
            $count = request()->input('count');
        }

        $lessonPlan = lesson_plan::where('schid', $schid)
            ->where("clsm", $clsm)
            ->where("ssn", $ssn)
            ->where("trm", $trm)
            ->where("sbj", $sbj)
            ->take($count)->skip($start)->get();

        return response()->json([
            "status" => true,
            "message" => "Success",
            "pld" => $lessonPlan,
        ]);
    }




    /**
     * @OA\Get(
     *     path="/api/getSingleLessonPlan/{schid}/{ssn}/{trm}/{clsm}/{sbj}/{id}",
     *     summary="Get a single lesson plan by school ID, session, term ID, class, subject, and plan ID",
     *     tags={"Api"},
     *     security={{"bearerAuth": {}}},
     *     @OA\Parameter(
     *         name="schid",
     *         in="path",
     *         required=true,
     *         description="School ID",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Parameter(
     *         name="ssn",
     *         in="path",
     *         required=true,
     *         description="Academic session (e.g. 2024/2025)",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Parameter(
     *         name="trm",
     *         in="path",
     *         required=true,
     *         description="Term ID (e.g. 1, 2, 3)",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Parameter(
     *         name="clsm",
     *         in="path",
     *         required=true,
     *         description="11",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Parameter(
     *         name="sbj",
     *         in="path",
     *         required=true,
     *         description="Subject (e.g. Mathematics, English)",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Parameter(
     *         name="id",
     *         in="path",
     *         required=true,
     *         description="Lesson plan ID",
     *         @OA\Schema(type="integer")
     *     ),
     *     @OA\Response(
     *         response=200,
     *         description="Lesson plan retrieved successfully",
     *         @OA\JsonContent(
     *             @OA\Property(property="status", type="boolean", example=true),
     *             @OA\Property(property="message", type="string", example="Success"),
     *             @OA\Property(property="pld", type="object")
     *         )
     *     ),
     *     @OA\Response(
     *         response=404,
     *         description="Lesson plan not found",
     *         @OA\JsonContent(
     *             @OA\Property(property="status", type="boolean", example=false),
     *             @OA\Property(property="message", type="string", example="Lesson plan not found")
     *         )
     *     )
     * )
     */

    public function getSingleLessonPlan($schid, $ssn, $trm, $clsm, $sbj, $id)
    {
        $lessonPlan = lesson_plan::where('schid', $schid)
            ->where('clsm', $clsm)
            ->where('ssn', $ssn)
            ->where('trm', $trm)
            ->where('sbj', $sbj)
            ->where('id', $id) // This line fetches the individual lesson plan
            ->first();

        if (!$lessonPlan) {
            return response()->json([
                "status" => false,
                "message" => "Lesson plan not found",
            ], 404);
        }

        return response()->json([
            "status" => true,
            "message" => "Success",
            "pld" => $lessonPlan,
        ], 200);
    }



    ////////////////////////////////////////////////////
    /**
     * @OA\Post(
     *     path="/api/setCurriculum",
     *     summary="Create or update a curriculum",
     *     tags={"Api"},
     *     security={{"bearerAuth": {}}},
     *     @OA\RequestBody(
     *         required=true,
     *         @OA\JsonContent(
     *             required={"schid", "clsm", "week", "topic", "ssn", "trm", "sbj"},
     *             @OA\Property(property="schid", type="string", example="SCH123"),
     *             @OA\Property(property="clsm", type="string", example="JSS1"),
     *             @OA\Property(property="week", type="string", example="Week 1"),
     *             @OA\Property(property="topic", type="string", example="Introduction to Biology"),
     *             @OA\Property(
     *                 property="description",
     *                 type="array",
     *                 @OA\Items(type="string"),
     *                 example={"Explain cells", "Use chart", "Ask questions"}
     *             ),
     *             @OA\Property(
     *                 property="teaching_aids",
     *                 type="array",
     *                 @OA\Items(type="string"),
     *                 example={"Whiteboard", "Projector"}
     *             ),
     *             @OA\Property(property="ssn", type="string", example="2024"),
     *             @OA\Property(property="trm", type="string", example="1st Term"),
     *             @OA\Property(property="sbj", type="string", example="Biology"),
     *             @OA\Property(property="group", type="string", nullable=true, example="Science"),
     *             @OA\Property(property="url_link", type="string", format="url", nullable=true, example="https://example.com")
     *         )
     *     ),
     *     @OA\Response(
     *         response=200,
     *         description="Curriculum saved successfully",
     *         @OA\JsonContent(
     *             @OA\Property(property="status", type="boolean", example=true),
     *             @OA\Property(property="message", type="string", example="Curriculum saved successfully"),
     *             @OA\Property(property="pld", type="object")
     *         )
     *     ),
     *     @OA\Response(
     *         response=422,
     *         description="Validation error"
     *     )
     * )
     */


    public function setCurriculum(Request $request)
    {
        $request->validate([
            "schid" => "required|string",
            "clsm" => "required|string",
            "week" => "required|string",
            "topic" => "required|string",
            "description" => "nullable|array",
            "teaching_aids" => "nullable|array",
            "ssn" => "required|string",
            "trm" => "required|string",
            "sbj" => "required|string",
            "group" => "nullable|string",
            "url_link" => "nullable|url",
        ]);

        $data = $request->only([
            "schid",
            "clsm",
            "week",
            "topic",
            "ssn",
            "trm",
            "sbj",
            "group",
            "url_link"
        ]);

        $data['description'] = $request->description;
        $data['teaching_aids'] = $request->teaching_aids;



        $curriculum = curriculum::updateOrCreate(
            [
                "schid" => $request->schid,
                "clsm" => $request->clsm,
                "ssn" => $request->ssn,
                "trm" => $request->trm,
                "week" => $request->week,
                "sbj" => $request->sbj,
            ],
            $data
        );

        return response()->json([
            "status" => true,
            "message" => "Curriculum saved successfully",
            "pld" => $curriculum
        ], 200);
    }




    /**
     * @OA\Get(
     *     path="/api/getCurriculum/{schid}/{ssn}/{trm}/{clsm}",
     *     tags={"Api"},
     *     security={{"bearerAuth": {}}},
     *     summary="Get Curriculum records",
     *     description="Use this endpoint to fetch curriculum records for a specific school, class, session, term, and subject.",
     *
     *     @OA\Parameter(
     *         name="schid",
     *         in="path",
     *         required=true,
     *         description="School ID",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Parameter(
     *         name="clsm",
     *         in="path",
     *         required=true,
     *         description="Class ID",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Parameter(
     *         name="ssn",
     *         in="path",
     *         required=true,
     *         description="Session",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Parameter(
     *         name="trm",
     *         in="path",
     *         required=true,
     *         description="Term",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Parameter(
     *         name="start",
     *         in="query",
     *         required=false,
     *         description="Starting index for pagination",
     *         @OA\Schema(type="integer", default=0)
     *     ),
     *     @OA\Parameter(
     *         name="count",
     *         in="query",
     *         required=false,
     *         description="Number of records to fetch",
     *         @OA\Schema(type="integer", default=20)
     *     ),
     *     @OA\Response(
     *         response=200,
     *         description="Success",
     *         @OA\JsonContent(
     *             @OA\Property(property="status", type="boolean", example=true),
     *             @OA\Property(property="message", type="string", example="Success"),
     *             @OA\Property(property="pld", type="array", @OA\Items(type="object"))
     *         )
     *     ),
     *     @OA\Response(response=400, description="Bad Request"),
     *     @OA\Response(response=401, description="Unauthorized"),
     * )
     */

    public function getCurriculum($schid, $ssn, $trm, $clsm)
    {
        $start = 0;
        $count = 20;
        if (request()->has('start') && request()->has('count')) {
            $start = request()->input('start');
            $count = request()->input('count');
        }

        $curriculum = curriculum::where('schid', $schid)
            ->where("clsm", $clsm)
            ->where("ssn", $ssn)
            ->where("trm", $trm)
            ->take($count)->skip($start)->get();

        return response()->json([
            "status" => true,
            "message" => "Success",
            "pld" => $curriculum,
        ]);
    }




    /**
     * @OA\Get(
     *     path="/api/getCurriculumBySubject/{schid}/{ssn}/{trm}/{clsm}/{sbj}",
     *     tags={"Api"},
     *     security={{"bearerAuth": {}}},
     *     summary="Get Curriculum records",
     *     description="Use this endpoint to fetch curriculum records for a specific school, class, session, term, and subject.",
     *
     *     @OA\Parameter(
     *         name="schid",
     *         in="path",
     *         required=true,
     *         description="School ID",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Parameter(
     *         name="clsm",
     *         in="path",
     *         required=true,
     *         description="Class ID",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Parameter(
     *         name="ssn",
     *         in="path",
     *         required=true,
     *         description="Session",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Parameter(
     *         name="trm",
     *         in="path",
     *         required=true,
     *         description="Term",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Parameter(
     *         name="sbj",
     *         in="path",
     *         required=true,
     *         description="Subject",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Parameter(
     *         name="start",
     *         in="query",
     *         required=false,
     *         description="Starting index for pagination",
     *         @OA\Schema(type="integer", default=0)
     *     ),
     *     @OA\Parameter(
     *         name="count",
     *         in="query",
     *         required=false,
     *         description="Number of records to fetch",
     *         @OA\Schema(type="integer", default=20)
     *     ),
     *     @OA\Response(
     *         response=200,
     *         description="Success",
     *         @OA\JsonContent(
     *             @OA\Property(property="status", type="boolean", example=true),
     *             @OA\Property(property="message", type="string", example="Success"),
     *             @OA\Property(property="pld", type="array", @OA\Items(type="object"))
     *         )
     *     ),
     *     @OA\Response(response=400, description="Bad Request"),
     *     @OA\Response(response=401, description="Unauthorized"),
     * )
     */

    public function getCurriculumBySubject($schid, $ssn, $trm, $clsm, $sbj)
    {
        $start = 0;
        $count = 20;
        if (request()->has('start') && request()->has('count')) {
            $start = request()->input('start');
            $count = request()->input('count');
        }

        $curriculum = curriculum::where('schid', $schid)
            ->where("clsm", $clsm)
            ->where("ssn", $ssn)
            ->where("trm", $trm)
            ->where("sbj", $sbj)
            ->take($count)->skip($start)->get();

        return response()->json([
            "status" => true,
            "message" => "Success",
            "pld" => $curriculum,
        ]);
    }





    /**
     * @OA\Get(
     *     path="/api/getcurriculumByStudent/{schid}/{ssn}/{trm}/{clsm}/{sbj}/{sid}",
     *     tags={"Api"},
     *     security={{"bearerAuth": {}}},
     *     summary="Get Curriculum for a specific student",
     *     description="Fetch curriculum details for a given student based on school ID, session, term, class, subject, and student ID.",
     *
     *     @OA\Parameter(
     *         name="schid",
     *         in="path",
     *         required=true,
     *         description="School ID",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Parameter(
     *         name="ssn",
     *         in="path",
     *         required=true,
     *         description="Session",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Parameter(
     *         name="trm",
     *         in="path",
     *         required=true,
     *         description="Term",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Parameter(
     *         name="clsm",
     *         in="path",
     *         required=true,
     *         description="Class",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Parameter(
     *         name="sbj",
     *         in="path",
     *         required=true,
     *         description="Subject",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Parameter(
     *         name="sid",
     *         in="path",
     *         required=true,
     *         description="Student ID",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Parameter(
     *         name="start",
     *         in="query",
     *         required=false,
     *         description="Starting index for pagination",
     *         @OA\Schema(type="integer", default=0)
     *     ),
     *     @OA\Parameter(
     *         name="count",
     *         in="query",
     *         required=false,
     *         description="Number of records to fetch",
     *         @OA\Schema(type="integer", default=20)
     *     ),
     *     @OA\Response(
     *         response=200,
     *         description="Success",
     *         @OA\JsonContent(
     *             @OA\Property(property="status", type="boolean", example=true),
     *             @OA\Property(property="message", type="string", example="Success"),
     *             @OA\Property(property="pld", type="array", @OA\Items(type="object"))
     *         )
     *     ),
     *     @OA\Response(
     *         response=404,
     *         description="Curriculum not found",
     *         @OA\JsonContent(
     *             @OA\Property(property="status", type="boolean", example=false),
     *             @OA\Property(property="message", type="string", example="Curriculum not found")
     *         )
     *     ),
     *     @OA\Response(response=401, description="Unauthorized"),
     * )
     */

    public function getcurriculumByStudent($schid, $ssn, $trm, $clsm, $sbj, $sid)
    {
        $start = 0;
        $count = 20;
        if (request()->has('start') && request()->has('count')) {
            $start = request()->input('start');
            $count = request()->input('count');
        }
        $pld = curriculum::from('curricula as c')
            ->join('student', 'c.schid', '=', 'student.schid')
            ->where('c.schid', $schid)
            ->where('c.clsm', $clsm)
            ->where('c.ssn', $ssn)
            ->where('c.trm', $trm)
            ->where('c.sbj', $sbj)
            ->where('student.sid', $sid)
            ->skip($start)->take($count)->get();


        if (!$pld) {
            return response()->json([
                "status" => false,
                "message" => "Curriculum not found",
            ]);
        }

        return response()->json([
            "status" => true,
            "message" => "Success",
            "pld" => $pld,
        ]);
    }




    /**
     * @OA\Put(
     *     path="/api/updateCurriculum",
     *     tags={"Api"},
     *     security={{"bearerAuth": {}}},
     *     summary="Update an existing curriculum record",
     *     description="Updates one or more fields of a curriculum using schid, clsm, ssn, trm, and sbj to identify the record.",
     *     operationId="updateCurriculum",
     *     @OA\RequestBody(
     *         required=true,
     *         @OA\JsonContent(
     *             required={"schid", "clsm", "ssn", "trm", "sbj"},
     *             @OA\Property(property="schid", type="integer", example=1),
     *             @OA\Property(property="clsm", type="string", example="JSS1"),
     *             @OA\Property(property="ssn", type="integer", example=2024),
     *             @OA\Property(property="trm", type="string", example="First Term"),
     *             @OA\Property(property="sbj", type="string", example="Biology"),
     *             @OA\Property(property="topic", type="string", example="Introduction to Cells"),
     *             @OA\Property(property="description", type="string", example="Basic cell structure and function."),
     *             @OA\Property(property="teaching_aids", type="string", example="Charts, Microscope"),
     *             @OA\Property(property="group", type="string", example="Group A"),
     *             @OA\Property(property="url_link", type="string", format="url", example="https://example.com/resource"),
     *             @OA\Property(property="week", type="string", example="Week 2"),
     *         )
     *     ),
     *     @OA\Response(
     *         response=200,
     *         description="Curriculum updated successfully",
     *         @OA\JsonContent(
     *             @OA\Property(property="status", type="boolean", example=true),
     *             @OA\Property(property="message", type="string", example="Curriculum updated successfully"),
     *             @OA\Property(property="pld", type="object")
     *         )
     *     ),
     *     @OA\Response(
     *         response=404,
     *         description="Curriculum not found",
     *         @OA\JsonContent(
     *             @OA\Property(property="status", type="boolean", example=false),
     *             @OA\Property(property="message", type="string", example="Curriculum not found")
     *         )
     *     ),
     *     @OA\Response(
     *         response=400,
     *         description="No valid fields provided for update",
     *         @OA\JsonContent(
     *             @OA\Property(property="status", type="boolean", example=false),
     *             @OA\Property(property="message", type="string", example="No valid fields provided for update")
     *         )
     *     )
     * )
     */

    public function updateCurriculum(Request $request)
    {
        $request->validate([
            "schid" => "required",
            "clsm" => "required",
            "ssn" => "required",
            "trm" => "required",

            // The fields below are optional for partial updates
            "sbj" => "nullable",
            "topic" => "nullable",
            "description" => "nullable",
            "teaching_aids" => "nullable",
            "group" => "nullable",
            "url_link" => "nullable",
            "week" => "nullable",
        ]);
        Log::info($request->all());

        $curriculum = curriculum::where("schid", $request->schid)
            ->where("clsm", $request->clsm)
            ->where("ssn", $request->ssn)
            ->where("trm", $request->trm)
            ->first();

        if (!$curriculum) {
            return response()->json([
                "status" => false,
                "message" => "Curriculum not found",
            ], 404);
        }

        // Only update fields present in the request
        $fieldsToUpdate = collect($request->only([
            "topic",
            "description",
            "teaching_aids",
            "sbj",
            "group",
            "url_link"
        ]))->filter(fn($value) => !is_null($value))->toArray();

        if (empty($fieldsToUpdate)) {
            return response()->json([
                "status" => false,
                "message" => "No valid fields provided for update",
            ], 400);
        }

        $curriculum->update($fieldsToUpdate);

        return response()->json([
            "status" => true,
            "message" => "Curriculum updated successfully",
            "pld" => $curriculum
        ], 200);
    }

    /////////////////////////////////////////////////////////////

    /**
     * @OA\Get(
     *     path="/api/getAllSubjectPositions/{schid}/{clsm}/{ssn}/{trm}",
     *     operationId="getAllSubjectPositions",
     *     tags={"Api"},
     *     security={{"bearerAuth": {}}},
     *     summary="Get all subject positions for students in a specific school/class/session/term",
     *     description="Returns a list of students with subject positions filtered by school, class, session, and term.",
     *
     *     @OA\Parameter(
     *         name="schid",
     *         in="path",
     *         description="School ID",
     *         required=true,
     *         @OA\Schema(type="integer")
     *     ),
     *     @OA\Parameter(
     *         name="clsm",
     *         in="path",
     *         description="Class ID",
     *         required=true,
     *         @OA\Schema(type="string")
     *     ),
     *  *     @OA\Parameter(
     *         name="clsa",
     *         in="path",
     *         description="Class arm",
     *         required=true,
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Parameter(
     *         name="ssn",
     *         in="path",
     *         description="Session",
     *         required=true,
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Parameter(
     *         name="trm",
     *         in="path",
     *         description="Term",
     *         required=true,
     *         @OA\Schema(type="integer")
     *     ),

     *     @OA\Response(
     *         response=200,
     *         description="Successful response",
     *         @OA\JsonContent(
     *             type="object",
     *             @OA\Property(property="status", type="boolean", example=true),
     *             @OA\Property(
     *                 property="data",
     *                 type="array",
     *                 @OA\Items(
     *                     type="object",
     *                     @OA\Property(property="stid", type="string", example="ST1234"),
     *                     @OA\Property(property="sbj", type="string", example="Mathematics"),
     *                     @OA\Property(property="pos", type="integer", example=2)
     *                 )
     *             )
     *         )
     *     ),
     *     @OA\Response(
     *         response=400,
     *         description="Bad Request"
     *     ),
     *     @OA\Response(
     *         response=404,
     *         description="Not Found"
     *     )
     * )
     */


    public function getAllSubjectPositions($schid, $ssn, $trm, $clsm, $clsa)
    {
        // Fetch filtered student subject results with position
        $results = student_sub_res::where('schid', $schid)
            ->where('clsm', $clsm)
            ->where('ssn', $ssn)
            ->where('trm', $trm)
            ->where('clsa', $clsa)
            ->orderBy('stid')
            ->get();

        return response()->json([
            'status' => true,
            'pld' => $results
        ]);
    }




    /**
     * @OA\Get(
     *     path="/api/getStudentSubjectPositions/{schid}/{ssn}/{trm}/{clsm}/{clsa}/{stid}",
     *     operationId="getStudentSubjectPositions",
     *     tags={"Api"},
     *     security={{"bearerAuth": {}}},
     *     summary="Get subject positions for a student",
     *     description="Retrieve all subject positions for a given student filtered by school, session, term, class, and arm.",
     *
     *     @OA\Parameter(name="schid", in="path", required=true, @OA\Schema(type="integer"), description="School ID"),
     *     @OA\Parameter(name="ssn", in="path", required=true, @OA\Schema(type="string"), description="Session (e.g. 2024/2025)"),
     *     @OA\Parameter(name="trm", in="path", required=true, @OA\Schema(type="string"), description="Term"),
     *     @OA\Parameter(name="clsm", in="path", required=true, @OA\Schema(type="string"), description="Class (e.g. JSS1)"),
     *     @OA\Parameter(name="clsa", in="path", required=true, @OA\Schema(type="string"), description="Class arm (e.g. A, B)"),
     *     @OA\Parameter(name="stid", in="path", required=true, @OA\Schema(type="string"), description="Student ID"),
     *
     *     @OA\Response(
     *         response=200,
     *         description="Subject positions found",
     *         @OA\JsonContent(
     *             type="object",
     *             @OA\Property(property="status", type="boolean", example=true),
     *             @OA\Property(
     *                 property="pld",
     *                 type="array",
     *                 @OA\Items(
     *                     @OA\Property(property="sbj", type="string", example="Mathematics"),
     *                     @OA\Property(property="pos", type="integer", example=2)
     *                 )
     *             )
     *         )
     *     ),
     *     @OA\Response(
     *         response=404,
     *         description="No subject positions found for this student",
     *         @OA\JsonContent(
     *             type="object",
     *             @OA\Property(property="status", type="boolean", example=false),
     *             @OA\Property(property="message", type="string", example="No subject positions found for this student.")
     *         )
     *     )
     * )
     */


    public function getStudentSubjectPositions($schid, $ssn, $trm, $clsm, $clsa, $stid)
    {
        $results = student_sub_res::where('schid', $schid)
            ->where('clsm', $clsm)
            ->where('clsa', $clsa)
            ->where('ssn', $ssn)
            ->where('trm', $trm)
            ->where('stid', $stid)
            ->get();

        if ($results->isEmpty()) {
            return response()->json([
                'status' => false,
                'message' => 'No subject positions found for this student.'
            ], 404);
        }

        return response()->json([
            'status' => true,
            'pld' => $results
        ]);
    }


    /////////////////////////////////////////////////////////////

    /**
     * @OA\Post(
     *     path="/api/setLessonNote",
     *     summary="Create a new lesson note with topics and subtopics",
     *     tags={"Api"},
     *     security={{"bearerAuth": {}}},
     *     @OA\RequestBody(
     *         required=true,
     *         @OA\JsonContent(
     *             required={"sch_id", "session", "term", "class", "week", "subject", "topics"},
     *             @OA\Property(property="sch_id", type="string", example="SCH002"),
     *             @OA\Property(property="session", type="string", example="2025"),
     *             @OA\Property(property="term", type="string", example="2"),
     *             @OA\Property(property="clsm", type="string", example="1"),
     *             @OA\Property(property="week", type="string", example="Week 1"),
     *             @OA\Property(property="subject", type="string", example="Mathematics"),
     *             @OA\Property(
     *                 property="topics",
     *                 type="array",
     *                 @OA\Items(
     *                     required={"title"},
     *                     @OA\Property(property="title", type="string", example="Fractions"),
     *                     @OA\Property(property="references", type="array", @OA\Items(type="string"), example={"Book A", "Book B"}),
     *                     @OA\Property(property="content", type="array", @OA\Items(type="string"), example={"Introduction to fractions", "Examples"}),
     *                     @OA\Property(property="general_evaluation", type="array", @OA\Items(type="string"), example={"Question 1", "Question 2"}),
     *                     @OA\Property(property="weekend_assignment", type="array", @OA\Items(type="string"), example={"Assignment 1", "Assignment 2"}),
     *                     @OA\Property(property="theory", type="array", @OA\Items(type="string"), example={"Explain fractions", "Draw examples"}),
     *                     @OA\Property(
     *                         property="sub_topics",
     *                         type="array",
     *                         @OA\Items(
     *                             required={"title"},
     *                             @OA\Property(property="title", type="string", example="Proper and Improper Fractions"),
     *                             @OA\Property(property="sub_topic_content_one", type="string", example="Explanation with examples"),
     *                             @OA\Property(property="sub_topic_content_two", type="string", example="More examples"),
     *                             @OA\Property(property="sub_topic_content_three", type="string", example="Practice questions"),
     *                             @OA\Property(property="sub_topic_content_four", type="string", example="Practice questions"),
     *                             @OA\Property(property="sub_topic_content_five", type="string", example="Practice questions"),
     *                             @OA\Property(property="sub_topic_content_six", type="string", example="Practice questions"),
     *                             @OA\Property(property="sub_topic_content_seven", type="string", example="Practice questions"),
     *                             @OA\Property(property="sub_topic_content_eight", type="string", example="Practice questions"),
     *                             @OA\Property(property="sub_topic_content_nine", type="string", example="Practice questions"),
     *                             @OA\Property(property="sub_topic_content_ten", type="string", example="Practice questions"),
     *                             @OA\Property(property="sub_topic_evaluation", type="array", @OA\Items(type="string"), example={"Q1", "Q2"})
     *                         )
     *                     )
     *                 )
     *             )
     *         )
     *     ),
     *     @OA\Response(
     *         response=201,
     *         description="Lesson note created successfully",
     *         @OA\JsonContent(
     *             @OA\Property(property="message", type="string", example="Lesson note created successfully"),
     *             @OA\Property(
     *                 property="pld",
     *                 type="object",
     *                 @OA\Property(property="id", type="integer", example=1),
     *                 @OA\Property(property="session", type="string", example="2025"),
     *                 @OA\Property(property="term", type="string", example="2"),
     *                 @OA\Property(property="clsm", type="string", example="1"),
     *                 @OA\Property(property="week", type="string", example="Week 1"),
     *                 @OA\Property(property="subject", type="string", example="Mathematics"),
     *                 @OA\Property(
     *                     property="topics",
     *                     type="array",
     *                     @OA\Items(
     *                         @OA\Property(property="title", type="string", example="Fractions"),
     *                         @OA\Property(
     *                             property="sub_topics",
     *                             type="array",
     *                             @OA\Items(
     *                                 @OA\Property(property="title", type="string", example="Improper Fractions")
     *                             )
     *                         )
     *                     )
     *                 )
     *             )
     *         )
     *     ),
     *     @OA\Response(
     *         response=422,
     *         description="Validation failed"
     *     )
     * )
     */


    public function setLessonNote(Request $request)
    {
        $request->validate([
            'sch_id' => 'required',
            'session' => 'required',
            'term' => 'required',
            'clsm' => 'required',
            'week' => 'required',
            'subject' => 'required',
            'topics' => 'required|array',
        ]);

        $lessonNote = lesson_note::create($request->only(['sch_id', 'session', 'term', 'clsm', 'week', 'subject']));

        foreach ($request->topics as $topicData) {
            $topic = $lessonNote->topics()->create([
                'title' => $topicData['title'],
                'references' => $topicData['references'] ?? [],
                'content' => $topicData['content'] ?? [],
                'general_evaluation' => $topicData['general_evaluation'] ?? [],
                'weekend_assignment' => $topicData['weekend_assignment'] ?? [],
                'theory' => $topicData['theory'] ?? [],
            ]);

            foreach ($topicData['sub_topics'] ?? [] as $sub) {
                $topic->subTopics()->create([
                    'title' => $sub['title'],
                    'sub_topic_content_one' => $sub['sub_topic_content_one'] ?? null,
                    'sub_topic_content_two' => $sub['sub_topic_content_two'] ?? null,
                    'sub_topic_content_three' => $sub['sub_topic_content_three'] ?? null,
                    'sub_topic_content_four' => $sub['sub_topic_content_four'] ?? null,
                    'sub_topic_content_five' => $sub['sub_topic_content_five'] ?? null,
                    'sub_topic_content_six' => $sub['sub_topic_content_six'] ?? null,
                    'sub_topic_content_seven' => $sub['sub_topic_content_seven'] ?? null,
                    'sub_topic_content_eight' => $sub['sub_topic_content_eight'] ?? null,
                    'sub_topic_content_nine' => $sub['sub_topic_content_nine'] ?? null,
                    'sub_topic_content_ten' => $sub['sub_topic_content_ten'] ?? null,
                    'sub_topic_evaluation' => $sub['sub_topic_evaluation'] ?? [],
                ]);
            }
        }

        // Reload with relationships
        $lessonNote->load('topics.subTopics');

        return response()->json([
            'status' => true,
            'pld' => [
                'message' => 'Lesson note saved successfully',
                'lesson_note' => $lessonNote,
            ],
        ], 200);
    }




    /**
     * @OA\Get(
     *     path="/api/getLessonNote/{sch_id}/{session}/{term}/{clsm}/{week}",
     *     summary="Retrieve lesson notes based on school, session, term, and class",
     *     description="Returns a list of lesson notes along with their topics and sub-topics.",
     *     tags={"Api"},
     *     security={{"bearerAuth": {}}},
     *     @OA\Parameter(
     *         name="sch_id",
     *         in="path",
     *         required=true,
     *         description="School ID",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Parameter(
     *         name="session",
     *         in="path",
     *         required=true,
     *         description="Academic session (e.g. 2024/2025)",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Parameter(
     *         name="term",
     *         in="path",
     *         required=true,
     *         description="2",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Parameter(
     *         name="clsm",
     *         in="path",
     *         required=true,
     *         description="1",
     *         @OA\Schema(type="string")
     *     ),
     *      @OA\Parameter(
     *         name="week",
     *         in="path",
     *         required=true,
     *         description="Week (e.g., Week 1)",
     *         @OA\Schema(type="string", example="Week")
     *     ),
     *     @OA\Parameter(
     *         name="start",
     *         in="query",
     *         required=false,
     *         description="Pagination start index",
     *         @OA\Schema(type="integer", default=0)
     *     ),
     *     @OA\Parameter(
     *         name="count",
     *         in="query",
     *         required=false,
     *         description="Number of records to retrieve",
     *         @OA\Schema(type="integer", default=20)
     *     ),
     *
     *     @OA\Response(
     *         response=200,
     *         description="Lesson notes retrieved successfully",
     *         @OA\JsonContent(
     *             @OA\Property(property="status", type="boolean", example=true),
     *             @OA\Property(property="message", type="string", example="Lesson notes retrieved successfully"),
     *             @OA\Property(
     *                 property="pld",
     *                 type="array",
     *                 @OA\Items(
     *                     @OA\Property(property="id", type="integer", example=1),
     *                     @OA\Property(property="session", type="string", example="2024/2025"),
     *                     @OA\Property(property="term", type="string", example="1st"),
     *                     @OA\Property(property="clsm", type="string", example="1"),
     *                     @OA\Property(property="week", type="string", example="Week 1"),
     *                     @OA\Property(property="subject", type="string", example="Mathematics"),
     *                     @OA\Property(
     *                         property="topics",
     *                         type="array",
     *                         @OA\Items(
     *                             @OA\Property(property="title", type="string", example="Algebra"),
     *                             @OA\Property(property="references", type="array", @OA\Items(type="string")),
     *                             @OA\Property(property="content", type="array", @OA\Items(type="string")),
     *                             @OA\Property(property="general_evaluation", type="array", @OA\Items(type="string")),
     *                             @OA\Property(property="weekend_assignment", type="array", @OA\Items(type="string")),
     *                             @OA\Property(property="theory", type="array", @OA\Items(type="string")),
     *                             @OA\Property(
     *                                 property="sub_topics",
     *                                 type="array",
     *                                 @OA\Items(
     *                                     @OA\Property(property="title", type="string", example="Simplifying expressions"),
     *                                     @OA\Property(property="sub_topic_content_one", type="string"),
     *                                     @OA\Property(property="sub_topic_content_two", type="string"),
     *                                     @OA\Property(property="sub_topic_content_three", type="string"),
     *                                     @OA\Property(property="sub_topic_evaluation", type="array", @OA\Items(type="string"))
     *                                 )
     *                             )
     *                         )
     *                     )
     *                 )
     *             )
     *         )
     *     ),
     *
     *     @OA\Response(
     *         response=400,
     *         description="Bad request or validation error"
     *     )
     * )
     */

    public function getLessonNote($sch_id, $session, $term, $clsm, $week)
    {
        $start = 0;
        $count = 20;

        if (request()->has('start') && request()->has('count')) {
            $start = request()->input('start');
            $count = request()->input('count');
        }

        $lessonNotes = lesson_note::with('topics.subTopics')
            ->where('sch_id', $sch_id)
            ->where('session', $session)
            ->where('term', $term)
            ->where('clsm', $clsm)
            ->where('week', $week)
            ->skip($start)
            ->take($count)
            ->get();

        return response()->json([
            "status" => true,
            "message" => "Lesson notes retrieved successfully",
            "pld" => $lessonNotes,
        ]);
    }




    /**
     * @OA\Get(
     *     path="/api/getLessonNoteBySubject/{sch_id}/{session}/{term}/{clsm}/{subject}/{week}",
     *     summary="Get lesson notes by subject",
     *     description="Retrieve lesson notes filtered by school ID, session, term, class, and subject. Supports pagination via 'start' and 'count' query parameters.",
     *     tags={"Api"},
     *      security={{"bearerAuth": {}}},
     *
     *     @OA\Parameter(
     *         name="sch_id",
     *         in="path",
     *         required=true,
     *         description="School ID",
     *         @OA\Schema(type="string", example="SCH123")
     *     ),
     *     @OA\Parameter(
     *         name="session",
     *         in="path",
     *         required=true,
     *         description="Academic session (e.g., 2024/2025)",
     *         @OA\Schema(type="string", example="2024/2025")
     *     ),
     *     @OA\Parameter(
     *         name="term",
     *         in="path",
     *         required=true,
     *         description="Term (e.g., 1, 2, 3)",
     *         @OA\Schema(type="string", example="2")
     *     ),
     *     @OA\Parameter(
     *         name="clsm",
     *         in="path",
     *         required=true,
     *         description="Class (e.g., 1, 2)",
     *         @OA\Schema(type="string", example="1")
     *     ),
     *     @OA\Parameter(
     *         name="subject",
     *         in="path",
     *         required=true,
     *         description="Subject (e.g., Mathematics)",
     *         @OA\Schema(type="string", example="Mathematics")
     *     ),
     *      @OA\Parameter(
     *         name="week",
     *         in="path",
     *         required=true,
     *         description="Week (e.g., Week 1)",
     *         @OA\Schema(type="string", example="Week")
     *     ),
     *     @OA\Parameter(
     *         name="start",
     *         in="query",
     *         required=false,
     *         description="Pagination start index",
     *         @OA\Schema(type="integer", default=0)
     *     ),
     *     @OA\Parameter(
     *         name="count",
     *         in="query",
     *         required=false,
     *         description="Number of records to retrieve",
     *         @OA\Schema(type="integer", default=20)
     *     ),
     *
     *     @OA\Response(
     *         response=200,
     *         description="Lesson notes retrieved successfully",
     *         @OA\JsonContent(
     *             @OA\Property(property="status", type="boolean", example=true),
     *             @OA\Property(property="message", type="string", example="Lesson notes retrieved successfully"),
     *             @OA\Property(
     *                 property="pld",
     *                 type="array",
     *                 @OA\Items(
     *                     @OA\Property(property="id", type="integer", example=1),
     *                     @OA\Property(property="sch_id", type="string", example="SCH123"),
     *                     @OA\Property(property="session", type="string", example="2024/2025"),
     *                     @OA\Property(property="term", type="string", example="1st"),
     *                     @OA\Property(property="clsm", type="string", example="1"),
     *                     @OA\Property(property="subject", type="string", example="Mathematics"),
     *                     @OA\Property(property="week", type="string", example="Week 1"),
     *                     @OA\Property(
     *                         property="topics",
     *                         type="array",
     *                         @OA\Items(
     *                             @OA\Property(property="title", type="string", example="Algebra Introduction"),
     *                             @OA\Property(property="references", type="array", @OA\Items(type="string")),
     *                             @OA\Property(property="content", type="array", @OA\Items(type="string")),
     *                             @OA\Property(property="general_evaluation", type="array", @OA\Items(type="string")),
     *                             @OA\Property(property="weekend_assignment", type="array", @OA\Items(type="string")),
     *                             @OA\Property(property="theory", type="array", @OA\Items(type="string")),
     *                             @OA\Property(
     *                                 property="sub_topics",
     *                                 type="array",
     *                                 @OA\Items(
     *                                     @OA\Property(property="title", type="string", example="Like terms"),
     *                                     @OA\Property(property="sub_topic_content_one", type="string", example="Content part 1"),
     *                                     @OA\Property(property="sub_topic_content_two", type="string", example="Content part 2"),
     *                                     @OA\Property(property="sub_topic_content_three", type="string", example="Content part 3"),
     *                                     @OA\Property(property="sub_topic_evaluation", type="array", @OA\Items(type="string"))
     *                                 )
     *                             )
     *                         )
     *                     )
     *                 )
     *             )
     *         )
     *     ),
     *
     *     @OA\Response(
     *         response=400,
     *         description="Invalid input or missing parameters"
     *     ),
     *     @OA\Response(
     *         response=404,
     *         description="Lesson notes not found"
     *     )
     * )
     */

    public function getLessonNoteBySubject($sch_id, $session, $term, $clsm, $subject, $week)
    {
        $start = 0;
        $count = 20;

        if (request()->has('start') && request()->has('count')) {
            $start = request()->input('start');
            $count = request()->input('count');
        }

        $lessonNotes = lesson_note::with('topics.subTopics')
            ->where('sch_id', $sch_id)
            ->where('session', $session)
            ->where('term', $term)
            ->where('clsm', $clsm)
            ->where('subject', $subject)
            ->where('week', $week)
            ->skip($start)
            ->take($count)
            ->get();

        return response()->json([
            "status" => true,
            "message" => "Lesson notes retrieved successfully",
            "pld" => $lessonNotes,
        ]);
    }






    /**
     * @OA\Put(
     *     path="/api/updateLessonNote",
     *     summary="Update an existing lesson note",
     *     description="Updates a lesson note's week and topics if they exist. Deletes existing topics and sub-topics before creating new ones.",
     *     tags={"Api"},
     *     security={{"bearerAuth": {}}},
     *     @OA\RequestBody(
     *         required=true,
     *         @OA\JsonContent(
     *             required={"sch_id", "session", "term", "clsm", "subject"},
     *             @OA\Property(property="sch_id", type="string", example="123"),
     *             @OA\Property(property="session", type="string", example="2024/2025"),
     *             @OA\Property(property="term", type="string", example="2"),
     *             @OA\Property(property="clsm", type="string", example="1"),
     *             @OA\Property(property="subject", type="string", example="Mathematics"),
     *             @OA\Property(property="week", type="string", example="Week 3"),
     *             @OA\Property(
     *                 property="topics",
     *                 type="array",
     *                 @OA\Items(
     *                     @OA\Property(property="title", type="string", example="Algebra"),
     *                     @OA\Property(property="references", type="array", @OA\Items(type="string"), example={"New General Math Book 1"}),
     *                     @OA\Property(property="content", type="array", @OA\Items(type="string"), example={"Introduction", "Solving equations"}),
     *                     @OA\Property(property="general_evaluation", type="array", @OA\Items(type="string"), example={"Evaluate x + 3 = 5"}),
     *                     @OA\Property(property="weekend_assignment", type="array", @OA\Items(type="string"), example={"Page 23 Q1-5"}),
     *                     @OA\Property(property="theory", type="array", @OA\Items(type="string"), example={"Prove x = 2"}),
     *                     @OA\Property(
     *                         property="sub_topics",
     *                         type="array",
     *                         @OA\Items(
     *                             @OA\Property(property="title", type="string", example="Simple Equations"),
     *                             @OA\Property(property="sub_topic_content_one", type="string", example="Definition"),
     *                             @OA\Property(property="sub_topic_content_two", type="string", example="Examples"),
     *                             @OA\Property(property="sub_topic_content_three", type="string", example="More Examples"),
     *                             @OA\Property(property="sub_topic_content_four", type="string", example="Exercises"),
     *                             @OA\Property(property="sub_topic_content_five", type="string", example="Assessment"),
     *                             @OA\Property(property="sub_topic_evaluation", type="array", @OA\Items(type="string"), example={"Q1: Solve 2x=6"})
     *                         )
     *                     )
     *                 )
     *             )
     *         )
     *     ),
     *     @OA\Response(
     *         response=200,
     *         description="Lesson note updated successfully",
     *         @OA\JsonContent(
     *             @OA\Property(property="message", type="string", example="Lesson note updated successfully"),
     *             @OA\Property(property="pld", type="object")
     *         )
     *     ),
     *     @OA\Response(
     *         response=404,
     *         description="Lesson note not found",
     *         @OA\JsonContent(
     *             @OA\Property(property="message", type="string", example="Lesson note not found")
     *         )
     *     )
     * )
     */



    public function updateLessonNote(Request $request)
    {
        $request->validate([
            'sch_id' => 'required',
            'session' => 'required',
            'term' => 'required',
            'clsm' => 'required',
            'subject' => 'required',
            'week' => 'nullable',
            'topics' => 'nullable|array',
        ]);

        // Find the existing lesson note
        $lessonNote = lesson_note::where([
            'sch_id' => $request->sch_id,
            'session' => $request->session,
            'term' => $request->term,
            'clsm' => $request->clsm,
            'subject' => $request->subject,
        ])->first();

        if (!$lessonNote) {
            return response()->json(['message' => 'Lesson note not found'], 404);
        }

        // Update week (optional fields can be handled here as well)
        $lessonNote->update(['week' => $request->week]);

        // Delete existing topics and subtopics
        foreach ($lessonNote->topics as $topic) {
            $topic->subTopics()->delete();
        }
        $lessonNote->topics()->delete();

        // Create new topics and sub-topics
        foreach ($request->topics as $topicData) {
            $topic = $lessonNote->topics()->create([
                'title' => $topicData['title'],
                'references' => $topicData['references'] ?? [],
                'content' => $topicData['content'] ?? [],
                'general_evaluation' => $topicData['general_evaluation'] ?? [],
                'weekend_assignment' => $topicData['weekend_assignment'] ?? [],
                'theory' => $topicData['theory'] ?? [],
            ]);

            foreach ($topicData['sub_topics'] ?? [] as $sub) {
                $topic->subTopics()->create([
                    'title' => $sub['title'],
                    'sub_topic_content_one' => $sub['sub_topic_content_one'] ?? null,
                    'sub_topic_content_two' => $sub['sub_topic_content_two'] ?? null,
                    'sub_topic_content_three' => $sub['sub_topic_content_three'] ?? null,
                    'sub_topic_content_four' => $sub['sub_topic_content_four'] ?? null,
                    'sub_topic_content_five' => $sub['sub_topic_content_five'] ?? null,
                    'sub_topic_evaluation' => $sub['sub_topic_evaluation'] ?? [],
                ]);
            }
        }

        // Load relationships
        $lessonNote->load('topics.subTopics');

        return response()->json([
            'message' => 'Lesson note updated successfully',
            'pld' => $lessonNote
        ]);
    }





    /**
     * @OA\Get(
     *     path="/api/getSingleLessonNote/{sch_id}/{session}/{term}/{clsm}/{week}/{lessonNoteId}",
     *     summary="Get a single lesson note with topics and subtopics",
     *     description="Retrieve a specific lesson note based on school ID, session, term, class, week, and lesson note ID.",
     *     operationId="getSingleLessonNote",
     *     tags={"Api"},
     *     security={{"bearerAuth": {}}},
     *
     *     @OA\Parameter(
     *         name="sch_id",
     *         in="path",
     *         required=true,
     *         description="School ID",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Parameter(
     *         name="session",
     *         in="path",
     *         required=true,
     *         description="Academic session",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Parameter(
     *         name="term",
     *         in="path",
     *         required=true,
     *         description="Academic term (e.g. 1)",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Parameter(
     *         name="clsm",
     *         in="path",
     *         required=true,
     *         description="Class (e.g. 2)",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Parameter(
     *         name="week",
     *         in="path",
     *         required=true,
     *         description="Week 1",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Parameter(
     *         name="lessonNoteId",
     *         in="path",
     *         required=true,
     *         description="The ID of the lesson note",
     *         @OA\Schema(type="integer")
     *     ),
     *
     *     @OA\Response(
     *         response=200,
     *         description="Lesson note retrieved successfully",
     *         @OA\JsonContent(
     *             @OA\Property(property="status", type="boolean", example=true),
     *             @OA\Property(property="message", type="string", example="Lesson note retrieved successfully"),
     *             @OA\Property(property="pld", type="object",
     *                 @OA\Property(property="id", type="integer", example=12),
     *                 @OA\Property(property="sch_id", type="string"),
     *                 @OA\Property(property="session", type="string"),
     *                 @OA\Property(property="term", type="string"),
     *                 @OA\Property(property="clsm", type="string"),
     *                 @OA\Property(property="week", type="string"),
     *                 @OA\Property(property="topics", type="array",
     *                     @OA\Items(
     *                         @OA\Property(property="id", type="integer"),
     *                         @OA\Property(property="title", type="string"),
     *                         @OA\Property(property="references", type="array", @OA\Items(type="string")),
     *                         @OA\Property(property="content", type="array", @OA\Items(type="string")),
     *                         @OA\Property(property="sub_topics", type="array",
     *                             @OA\Items(
     *                                 @OA\Property(property="id", type="integer"),
     *                                 @OA\Property(property="title", type="string"),
     *                                 @OA\Property(property="content", type="string")
     *                             )
     *                         )
     *                     )
     *                 )
     *             )
     *         )
     *     ),
     *
     *     @OA\Response(
     *         response=404,
     *         description="Lesson note not found",
     *         @OA\JsonContent(
     *             @OA\Property(property="status", type="boolean", example=false),
     *             @OA\Property(property="message", type="string", example="Lesson note not found"),
     *             @OA\Property(property="pld", type="string", example=null)
     *         )
     *     )
     * )
     */

    public function getSingleLessonNote($sch_id, $session, $term, $clsm, $week, $lessonNoteId)
    {
        $lessonNote = lesson_note::with('topics.subTopics')
            ->where('sch_id', $sch_id)
            ->where('session', $session)
            ->where('term', $term)
            ->where('clsm', $clsm)
            ->where('week', $week)
            ->where('id', $lessonNoteId)
            ->first();

        if (!$lessonNote) {
            return response()->json([
                "status" => false,
                "message" => "Lesson note not found",
                "pld" => null,
            ], 404);
        }

        return response()->json([
            "status" => true,
            "message" => "Lesson note retrieved successfully",
            "pld" => $lessonNote,
        ]);
    }


    ////////////////////////////////

    /**
     * @OA\Get(
     *     path="/api/getOverallBestStudents/{schid}/{ssn}/{trm}/{clsm}",
     *     summary="Get top 10 overall best students based on average score",
     *     description="Fetches the top 10 students in a school for a given session, term, and class based on their average scores with their rank positions.",
     *     tags={"Api"},
     *     security={{"bearerAuth": {}}},
     *
     *     @OA\Parameter(
     *         name="schid",
     *         in="path",
     *         description="School ID",
     *         required=true,
     *         @OA\Schema(type="integer", example=1)
     *     ),
     *     @OA\Parameter(
     *         name="ssn",
     *         in="path",
     *         description="Session",
     *         required=true,
     *         @OA\Schema(type="string", example="2024/2025")
     *     ),
     *     @OA\Parameter(
     *         name="trm",
     *         in="path",
     *         description="Term ID",
     *         required=true,
     *         @OA\Schema(type="string", example="2")
     *     ),
     *     @OA\Parameter(
     *         name="clsm",
     *         in="path",
     *         description="Class ID",
     *         required=true,
     *         @OA\Schema(type="string", example="1")
     *     ),
     *     @OA\Response(
     *         response=200,
     *         description="List of top 10 best students with ranks",
     *         @OA\JsonContent(
     *             type="object",
     *             @OA\Property(property="status", type="string", example="success"),
     *             @OA\Property(
     *                 property="pld",
     *                 type="array",
     *                 @OA\Items(
     *                     type="object",
     *                     @OA\Property(property="student_id", type="integer", example=123),
     *                     @OA\Property(property="name", type="string", example="Doe John A"),
     *                     @OA\Property(property="average", type="number", format="float", example=89.5),
     *                     @OA\Property(property="clsm", type="string", example="JSS1"),
     *                     @OA\Property(property="classarm", type="string", example="A"),
     *                     @OA\Property(property="position", type="integer", example=1)
     *                 )
     *             )
     *         )
     *     ),
     *     @OA\Response(
     *         response=400,
     *         description="Bad request due to missing or invalid parameters"
     *     ),
     *     @OA\Response(
     *         response=500,
     *         description="Internal server error"
     *     )
     * )
     */


    public function getOverallBestStudents($schid, $ssn, $trm, $clsm)
    {
        $results = student_res::where('schid', $schid)
            ->where('ssn', $ssn)
            ->where('trm', $trm)
            ->where('clsm', $clsm)
            ->orderByDesc('avg')
            ->take(10)
            ->get();

        $students = student::whereIn('sid', $results->pluck('stid'))->get()->keyBy('sid');
        $classArms = sch_cls::all()->keyBy('id');
        $classes = cls::all()->keyBy('id');

        // Initialize position variables
        $position = 1;
        $lastAvg = null;
        $rank = 1;

        $output = $results->map(function ($res) use ($students, $classes, $classArms, &$position, &$lastAvg, &$rank) {
            $student = $students[$res->stid] ?? null;
            $classArm = $classArms[$res->clsa] ?? null;
            $class = $classArm ? ($classes[$classArm->cls_id] ?? null) : null;

            $suid = $student
                ? ($student->sch3 . '/' . $student->year . '/' . $student->term . '/' . strval($student->count))
                : 'Unknown';

            // Update rank if average changes
            if ($lastAvg !== null && $res->avg < $lastAvg) {
                $rank = $position;
            }
            $lastAvg = $res->avg;

            // Convert position to ordinal
            $ordinal = $this->toOrdinal($rank);  // Custom function below

            $position++; // Increment after processing

            return [
                'student_id' => $suid,
                'name' => $student ? trim("{$student->lname} {$student->fname} {$student->mname}") : 'Unknown',
                'average' => $res->avg,
                'class_id' => $res->clsm,
                'class_name' => $class ? $class->name : 'Unknown',
                'class_arm' => $classArm ? $classArm->name : 'Unknown',
                'position' => "Overall $ordinal",
            ];
        });

        return response()->json([
            'status' => 'success',
            'pld' => $output
        ]);
    }




    /**
     * @OA\Get(
     *     path="/api/getBestStudentsInSubject/{schid}/{ssn}/{trm}/{clsm}/{sbj}",
     *     summary="Fetch top best-performing students in a particular subject with pagination",
     *     description="Returns a list of students with the highest total scores in a given subject, class, term, and session. Supports pagination via 'start' and 'count' query parameters.",
     *     operationId="getBestStudentsInSubject",
     *     tags={"Api"},
     *     security={{"bearerAuth": {}}},
     *
     *     @OA\Parameter(
     *         name="schid",
     *         in="path",
     *         required=true,
     *         description="School ID",
     *         @OA\Schema(type="integer")
     *     ),
     *     @OA\Parameter(
     *         name="ssn",
     *         in="path",
     *         required=true,
     *         description="Session (e.g., 2024)",
     *         @OA\Schema(type="integer")
     *     ),
     *     @OA\Parameter(
     *         name="trm",
     *         in="path",
     *         required=true,
     *         description="Term ID (e.g., 1, 2, 3)",
     *         @OA\Schema(type="integer")
     *     ),
     *     @OA\Parameter(
     *         name="clsm",
     *         in="path",
     *         required=true,
     *         description="Class ID",
     *         @OA\Schema(type="integer")
     *     ),
     *     @OA\Parameter(
     *         name="sbj",
     *         in="path",
     *         required=true,
     *         description="Subject ID",
     *         @OA\Schema(type="integer")
     *     ),
     *     @OA\Parameter(
     *         name="start",
     *         in="query",
     *         required=false,
     *         description="Offset for pagination (e.g., 0, 10, 20)",
     *         @OA\Schema(type="integer", default=0)
     *     ),
     *     @OA\Parameter(
     *         name="count",
     *         in="query",
     *         required=false,
     *         description="Number of records to return (e.g., 10, 20)",
     *         @OA\Schema(type="integer", default=20)
     *     ),
     *
     *     @OA\Response(
     *         response=200,
     *         description="List of top students",
     *         @OA\JsonContent(
     *             @OA\Property(property="status", type="string", example="success"),
     *             @OA\Property(property="start", type="integer", example=0),
     *             @OA\Property(property="count", type="integer", example=20),
     *             @OA\Property(
     *                 property="pld",
     *                 type="array",
     *                 @OA\Items(
     *                     @OA\Property(property="student_id", type="string", example="123"),
     *                     @OA\Property(property="full_name", type="string", example="John Doe"),
     *                     @OA\Property(property="total_score", type="number", format="float", example=87.5),
     *                     @OA\Property(property="position", type="integer", example=1),
     *                     @OA\Property(property="class_id", type="integer", example=11),
     *                     @OA\Property(property="class_name", type="string", example="SS2"),
     *                     @OA\Property(property="class_arm", type="string", example="A"),
     *                     @OA\Property(property="subject", type="string", example="Mathematics")
     *                 )
     *             )
     *         )
     *     ),
     *
     *     @OA\Response(
     *         response=404,
     *         description="No scores found for this subject",
     *         @OA\JsonContent(
     *             @OA\Property(property="message", type="string", example="No scores found for this subject")
     *         )
     *     )
     * )
     */


    public function getBestStudentsInSubject($schid, $ssn, $trm, $clsm, $sbj)
    {
        $start = request()->input('start', 0);
        $count = request()->input('count', 20);

        $subject = subj::find($sbj);
        $subjectName = $subject ? $subject->name : 'Unknown Subject';

        $class = cls::find($clsm);
        $className = $class ? $class->name : 'Unknown Class';

        $classArms = sch_cls::where('schid', $schid)->get()->keyBy('id');

        $scores = std_score::select('stid', DB::raw('SUM(scr) as total_score'))
            ->where(compact('schid', 'ssn', 'trm'))
            ->where('clsid', $clsm)
            ->where('sbj', $sbj)
            ->groupBy('stid')
            ->orderByDesc('total_score')
            ->skip($start)
            ->take($count)
            ->get();

        if ($scores->isEmpty()) {
            return response()->json(['message' => 'No scores found for this subject'], 404);
        }

        $studentIds = $scores->pluck('stid');

        $oldStudents = old_student::whereIn('sid', $studentIds)->get()->keyBy('sid');
        $mainStudents = student::whereIn('sid', $studentIds)->get()->keyBy('sid');

        $ranked = $scores->values()->map(function ($item, $index) use ($oldStudents, $mainStudents, $classArms, $className, $clsm, $start, $subjectName) {
            $old = $oldStudents[$item->stid] ?? null;
            $main = $mainStudents[$item->stid] ?? null;

            $armId = $old?->clsa;
            $armName = $armId && isset($classArms[$armId]) ? $classArms[$armId]->name : 'Unknown Class Arm';

            $suid = $main
                ? ($main->sch3 . '/' . $main->year . '/' . $main->term . '/' . strval($main->count))
                : ($old->suid ?? 'Unknown');

            return [
                'student_id' => $suid,
                'full_name' => $old ? trim("{$old->lname} {$old->fname} {$old->mname}") : 'Unknown',
                'total_score' => round($item->total_score, 2),
                'position' => 'Overall ' . $this->toOrdinal($start + $index + 1),
                'class_id' => $clsm,
                'class_name' => $className,
                'class_arm' => $armName,
                'subject' => $subjectName,
            ];
        });

        return response()->json([
            'status' => 'success',
            'start' => $start,
            'count' => $count,
            'results' => $ranked
        ]);
    }


    private function toOrdinal($number)
    {
        $ends = ['th', 'st', 'nd', 'rd', 'th', 'th', 'th', 'th', 'th', 'th'];
        if ((($number % 100) >= 11) && (($number % 100) <= 13)) {
            return $number . 'th';
        }
        return $number . $ends[$number % 10];
    }


    /**
     * @OA\Get(
     *     path="/api/getAllSubjectsPerformance/{schid}/{ssn}/{trm}/{clsm}",
     *     summary="Get performance statistics for all subjects based on school, session, term, and class",
     *     tags={"Api"},
     *     security={{"bearerAuth": {}}},
     *     @OA\Parameter(
     *         name="schid",
     *         in="path",
     *         description="School ID",
     *         required=true,
     *         @OA\Schema(type="integer")
     *     ),
     *     @OA\Parameter(
     *         name="ssn",
     *         in="path",
     *         description="Session (2024)",
     *         required=true,
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Parameter(
     *         name="trm",
     *         in="path",
     *         description="Term ID (e.g., 1, 2, or 3)",
     *         required=true,
     *         @OA\Schema(type="integer")
     *     ),
     *     @OA\Parameter(
     *         name="clsm",
     *         in="path",
     *         description="Class or class ID",
     *         required=true,
     *         @OA\Schema(type="integer")
     *     ),
     *     @OA\Response(
     *         response=200,
     *         description="Subject performance statistics",
     *         @OA\JsonContent(
     *             type="object",
     *             @OA\Property(
     *                 property="status",
     *                 type="string",
     *                 example="success"
     *             ),
     *             @OA\Property(
     *                 property="pld",
     *                 type="array",
     *                 @OA\Items(
     *                     type="object",
     *                     @OA\Property(
     *                         property="subject",
     *                         type="string",
     *                         example="MATHEMATICS"
     *                     ),
     *                     @OA\Property(
     *                         property="total_students",
     *                         type="integer",
     *                         example=120
     *                     ),
     *                     @OA\Property(
     *                         property="grades",
     *                         type="object",
     *                         example={"A":30,"B":40,"C":20,"D":10,"E":10,"F":10},
     *                         @OA\Property(property="A", type="integer"),
     *                         @OA\Property(property="B", type="integer"),
     *                         @OA\Property(property="C", type="integer"),
     *                         @OA\Property(property="D", type="integer"),
     *                         @OA\Property(property="E", type="integer"),
     *                         @OA\Property(property="F", type="integer")
     *                     ),
     *                     @OA\Property(
     *                         property="credits_and_above",
     *                         type="integer",
     *                         example=90
     *                     ),
     *                     @OA\Property(
     *                         property="percentage_pass",
     *                         type="number",
     *                         format="float",
     *                         example=75.00
     *                     )
     *                 )
     *             )
     *         )
     *     )
     * )
     */


    public function getAllSubjectsPerformance($schid, $ssn, $trm, $clsm)
    {
        // Fetch the class name
        $class = cls::find($clsm);
        $className = $class ? $class->name : 'Unknown Class';

        // Get all subject scores grouped by student and subject
        $scores = std_score::select('sbj', 'stid', DB::raw('SUM(scr) as total_score'))
            ->where('schid', $schid)
            ->where('ssn', $ssn)
            ->where('trm', $trm)
            ->where('clsid', $clsm)
            ->groupBy('sbj', 'stid')
            ->get();

        // Get unique subject codes
        $subjectCodes = $scores->pluck('sbj')->unique();

        // Fetch subject names
        $subjectNames = subj::whereIn('id', $subjectCodes)
            ->pluck('name', 'id');

        // Fetch school-defined grade brackets from `sch_grade`
        $grades = sch_grade::where('schid', $schid)
            ->where('clsid', $clsm)
            ->where('ssn', $ssn)
            ->where('trm', $trm)
            ->orderByDesc('g0')
            ->get()
            ->mapWithKeys(function ($item) {
                return [$item->grd => [(float) $item->g0, (float) $item->g1]];
            })
            ->toArray();

        // Temp structure to hold stats per subject
        $subjectStats = [];

        foreach ($scores as $score) {
            $subjectCode = $score->sbj;
            $total = $score->total_score;

            if (!isset($subjectStats[$subjectCode])) {
                // Initialize grade buckets dynamically from school-defined grades
                $subjectStats[$subjectCode] = [
                    'grades' => array_fill_keys(array_keys($grades), 0),
                    'total_students' => 0,
                    'credits_and_above' => 0,
                    'percentage_pass' => 0
                ];
            }

            foreach ($grades as $grade => [$min, $max]) {
                if ($total >= $min && $total <= $max) {
                    $subjectStats[$subjectCode]['grades'][$grade]++;
                    break;
                }
            }
        }

        // Process stats
        foreach ($subjectStats as $subjectCode => &$stats) {
            $stats['total_students'] = array_sum($stats['grades']);

            // Define what counts as a "pass" (customize this logic if needed)
            $credits = ['A', 'B', 'C']; // Change based on your grading labels
            foreach ($credits as $credit) {
                if (isset($stats['grades'][$credit])) {
                    $stats['credits_and_above'] += $stats['grades'][$credit];
                }
            }

            $stats['percentage_pass'] = $stats['total_students'] > 0
                ? round(($stats['credits_and_above'] / $stats['total_students']) * 100, 2)
                : 0;
        }
        unset($stats);

        // Build the response
        $pld = [];
        foreach ($subjectStats as $subjectCode => $stats) {
            $pld[] = [
                'subject_name' => $subjectNames[$subjectCode] ?? 'Unknown',
                'class_id' => $clsm,
                'class_name' => $className,
                'total_students' => $stats['total_students'],
                'grades' => $stats['grades'],
                'credits_and_above' => $stats['credits_and_above'],
                'percentage_pass' => $stats['percentage_pass']
            ];
        }

        return response()->json([
            'status' => 'success',
            'pld' => $pld
        ]);
    }




    /**
     * @OA\Get(
     *     path="/api/getCumulativeResult",
     *     summary="Get a student's cumulative academic result for all terms in a session",
     *     description="Retrieves cumulative results including term scores, averages, grades, positions, and student details.",
     *     operationId="getCumulativeResult",
     *     tags={"Api"},
     *     security={{"bearerAuth": {}}},
     *
     *     @OA\Parameter(
     *         name="schid",
     *         in="query",
     *         required=true,
     *         description="School ID",
     *         @OA\Schema(type="integer", example=12)
     *     ),
     *     @OA\Parameter(
     *         name="ssn",
     *         in="query",
     *         required=true,
     *         description="Session (Academic Year)",
     *         @OA\Schema(type="string", example="2024")
     *     ),
     *     @OA\Parameter(
     *         name="sid",
     *         in="query",
     *         required=true,
     *         description="Student ID",
     *         @OA\Schema(type="string", example="565")
     *     ),
     *
     *     @OA\Response(
     *         response=200,
     *         description="Successful cumulative result retrieved",
     *         @OA\JsonContent(
     *             @OA\Property(property="sid", type="string", example="565"),
     *             @OA\Property(property="clsm", type="string", example="JS3"),
     *             @OA\Property(property="clsa", type="string", example="A"),
     *             @OA\Property(property="basic_info", type="object",
     *                 @OA\Property(property="first_name", type="string", example="John"),
     *                 @OA\Property(property="last_name", type="string", example="Doe"),
     *                 @OA\Property(property="gender", type="string", example="Male")
     *             ),
     *             @OA\Property(property="academic_info", type="object",
     *                 @OA\Property(property="entry_year", type="string", example="2021"),
     *                 @OA\Property(property="current_class", type="string", example="JS3")
     *             ),
     *             @OA\Property(
     *                 property="results",
     *                 type="array",
     *                 @OA\Items(
     *                     @OA\Property(property="subject_id", type="integer", example=1),
     *                     @OA\Property(property="subject", type="string", example="Mathematics"),
     *                     @OA\Property(property="1st_term_total", type="number", format="float", example=78.5),
     *                     @OA\Property(property="2nd_term_total", type="number", format="float", example=82.0),
     *                     @OA\Property(property="3rd_term_total", type="number", format="float", example=85.5),
     *                     @OA\Property(property="yearly_average", type="number", format="float", example=82.0),
     *                     @OA\Property(property="grade", type="string", example="A"),
     *                     @OA\Property(property="position", type="integer", example=1)
     *                 )
     *             )
     *         )
     *     ),
     *
     *     @OA\Response(
     *         response=404,
     *         description="Student not found or no scores available",
     *         @OA\JsonContent(
     *             @OA\Property(property="message", type="string", example="Student not found in specified class/arm")
     *         )
     *     ),
     *
     *     @OA\Response(
     *         response=422,
     *         description="Validation error",
     *         @OA\JsonContent(
     *             @OA\Property(property="message", type="string", example="The given data was invalid."),
     *             @OA\Property(
     *                 property="errors",
     *                 type="object",
     *                 @OA\Property(
     *                     property="schid",
     *                     type="array",
     *                     @OA\Items(type="string", example="The schid field is required.")
     *                 )
     *             )
     *         )
     *     )
     * )
     */


    ////////////////////////////////////////////////////

    public function getCumulativeResult(Request $request)
    {
        $schid = $request->input('schid');
        $ssn = $request->input('ssn');
        $stid = $request->input('sid');

        // Step 1: Get student info
        $studentInfo = old_student::where('sid', $stid)
            ->where('schid', $schid)
            ->where('ssn', $ssn)
            ->first();

        if (!$studentInfo) {
            return response()->json(['message' => 'Student not found'], 404);
        }

        $clsm = $studentInfo->clsm;
        $clsa = $studentInfo->clsa;

        //  Check if broadsheet is locked for this class/arm
        $control = broadsheet_control::where('schid', $schid)
            ->where('sid', $stid)
            ->where('ssn', $ssn)
            ->where('clsm', $clsm)
            ->where('clsa', $clsa)
            ->first();

        if ($control && $control->stat == 0) {
            return response()->json([
                'status' => false,
                'message' => 'Broadsheet is locked for this student.'
            ], 403);
        }

        // Step 2: Get dynamic grading
        $grades = sch_grade::where('schid', $schid)
            ->where('clsid', $clsm)
            ->where('ssn', $ssn)
            ->orderByDesc('g0')
            ->get()
            ->mapWithKeys(function ($item) {
                return [$item->grd => [(float) $item->g0, (float) $item->g1]];
            })
            ->toArray();

        // Updated: Use floor to match range properly
        $assignGrade = function ($average) use ($grades) {
            $check = floor($average);
            foreach ($grades as $grade => [$min, $max]) {
                if ($check >= $min && $check <= $max) {
                    return $grade;
                }
            }
            return 'N/A';
        };

        // Step 3: Additional info
        $className = cls::where('id', $clsm)->value('name');
        $classArmName = sch_cls::where('id', $clsa)->value('name');

        $student = student::where('schid', $schid)
            ->where('sid', $stid)
            ->first();

        $suid = null;
        if ($student) {
            $ssn_real = $student->year;
            $term = $student->term;
            $count = $student->count;
            $suid = $student->sch3 . '/' . $ssn_real . '/' . $term . '/' . strval($count);
        }

        // Step 4: Subjects
        $subjects = std_score::where('schid', $schid)
            ->where('ssn', $ssn)
            ->where('clsid', $clsm)
            ->groupBy('sbj')
            ->pluck('sbj')
            ->toArray();

        $subjectNames = subj::whereIn('id', $subjects)->pluck('name', 'id');

        $result = [];
        $studentSubjectAverages = [];
        $classSubjectAverages = [];

        foreach ($subjects as $subjectId) {
            $subjectAverages = std_score::select(
                'stid',
                DB::raw("SUM(CASE WHEN trm = 1 THEN scr ELSE 0 END) as t1"),
                DB::raw("SUM(CASE WHEN trm = 2 THEN scr ELSE 0 END) as t2"),
                DB::raw("SUM(CASE WHEN trm = 3 THEN scr ELSE 0 END) as t3")
            )
                ->where('sbj', $subjectId)
                ->where('schid', $schid)
                ->where('ssn', $ssn)
                ->where('clsid', $clsm)
                ->groupBy('stid')
                ->get();

            $averagesWithTerms = $subjectAverages->map(function ($item) {
                $termCount = 0;
                $total = 0;
                if ($item->t1 > 0) {
                    $total += $item->t1;
                    $termCount++;
                }
                if ($item->t2 > 0) {
                    $total += $item->t2;
                    $termCount++;
                }
                if ($item->t3 > 0) {
                    $total += $item->t3;
                    $termCount++;
                }
                $average = $termCount > 0 ? $total / $termCount : 0;
                return [
                    'stid' => $item->stid,
                    't1' => $item->t1,
                    't2' => $item->t2,
                    't3' => $item->t3,
                    'average' => round($average, 2)
                ];
            })->sortByDesc('average')->values()->all();

            // Compute class average for subject
            $allAverages = array_column($averagesWithTerms, 'average');
            if (count($allAverages)) {
                $classSubjectAverages[] = array_sum($allAverages) / count($allAverages);
            }

            // Current student's scores
            $current = collect($averagesWithTerms)->firstWhere('stid', $stid);

            if ($current) {
                $grade = $assignGrade($current['average']);
                $studentSubjectAverages[] = $current['average'];

                $positions = [];
                foreach ($averagesWithTerms as $index => $entry) {
                    $positions[$entry['stid']] = $index + 1;
                }

                $result[] = [
                    'subject_id' => $subjectId,
                    'subject_name' => $subjectNames[$subjectId] ?? 'Unknown',
                    '1st_term_total' => $current['t1'],
                    '2nd_term_total' => $current['t2'],
                    '3rd_term_total' => $current['t3'],
                    'yearly_average' => $current['average'],
                    'grade' => $grade,
                    'position' => $positions[$stid] ?? null,
                ];
            }
        }

        // Final averages
        $finalAverage = count($studentSubjectAverages) > 0
            ? number_format(array_sum($studentSubjectAverages) / count($studentSubjectAverages), 2, '.', '')
            : number_format(0, 2, '.', '');

        $finalGrade = $assignGrade($finalAverage);

        $classAverage = count($classSubjectAverages) > 0
            ? number_format(array_sum($classSubjectAverages) / count($classSubjectAverages), 2, '.', '')
            : number_format(0, 2, '.', '');

        $classGrade = $assignGrade($classAverage);

        $studentGender = student_basic_data::where('user_id', $stid)->value('sex');

        return response()->json([
            'sid' => $stid,
            'student_name' => $studentInfo->lname . ' ' . $studentInfo->fname,
            'student_id' => $suid,
            'gender' => $studentGender ?? 'Not specified',
            'class' => $className ?? 'Class ID: ' . $clsm,
            'class_arm' => $classArmName ?? 'Class Arm ID: ' . $clsa,
            'session' => $ssn,
            'school_id' => $schid,
            'final_average' => $finalAverage,
            'final_average_grade' => $finalGrade,
            'class_average' => $classAverage,
            'class_average_grade' => $classGrade,
            'pld' => $result,
        ]);
    }



    /**
     * @OA\Get(
     *     path="/api/getAllStudentCumulativeResult",
     *     summary="Get cumulative result of students for a class",
     *     description="Returns cumulative result (Term 1, Term 2, Term 3 totals, average, and grade) for all students in a specific class and class arm within a school session.",
     *     operationId="getAllStudentCumulativeResult",
     *     tags={"Api"},
     *     security={{"bearerAuth": {}}},
     *
     *     @OA\Parameter(
     *         name="schid",
     *         in="query",
     *         required=true,
     *         description="School ID",
     *         @OA\Schema(type="integer")
     *     ),
     *     @OA\Parameter(
     *         name="ssn",
     *         in="query",
     *         required=true,
     *         description="School session (e.g., 2023/2024)",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Parameter(
     *         name="clsm",
     *         in="query",
     *         required=true,
     *         description="Class ID",
     *         @OA\Schema(type="integer")
     *     ),
     *     @OA\Parameter(
     *         name="clsa",
     *         in="query",
     *         required=true,
     *         description="Class Arm ID",
     *         @OA\Schema(type="integer")
     *     ),
     *     @OA\Parameter(
     *         name="start",
     *         in="query",
     *         required=false,
     *         description="Pagination start index (default 0)",
     *         @OA\Schema(type="integer", default=0)
     *     ),
     *     @OA\Parameter(
     *         name="count",
     *         in="query",
     *         required=false,
     *         description="Number of students to return (default 20)",
     *         @OA\Schema(type="integer", default=20)
     *     ),
     *
     *     @OA\Response(
     *         response=200,
     *         description="List of students with cumulative result",
     *         @OA\JsonContent(
     *             @OA\Property(property="start", type="integer"),
     *             @OA\Property(property="count", type="integer"),
     *             @OA\Property(
     *                 property="students",
     *                 type="array",
     *                 @OA\Items(
     *                     @OA\Property(property="student_id", type="string"),
     *                     @OA\Property(property="student_name", type="string"),
     *                     @OA\Property(property="class", type="string"),
     *                     @OA\Property(property="class_arm", type="string"),
     *                     @OA\Property(property="session", type="string"),
     *                     @OA\Property(property="school_id", type="integer"),
     *                     @OA\Property(
     *                         property="subjects",
     *                         type="array",
     *                         @OA\Items(
     *                             @OA\Property(property="subject_id", type="integer"),
     *                             @OA\Property(property="subject_name", type="string"),
     *                             @OA\Property(property="1st_term_total", type="number", format="float"),
     *                             @OA\Property(property="2nd_term_total", type="number", format="float"),
     *                             @OA\Property(property="3rd_term_total", type="number", format="float"),
     *                             @OA\Property(property="yearly_average", type="number", format="float"),
     *                             @OA\Property(property="grade", type="string")
     *                         )
     *                     )
     *                 )
     *             )
     *         )
     *     ),
     *
     *     @OA\Response(
     *         response=404,
     *         description="No students found",
     *         @OA\JsonContent(
     *             @OA\Property(property="message", type="string", example="No students found")
     *         )
     *     )
     * )
     */



    public function getAllStudentCumulativeResult(Request $request)
    {
        $schid = $request->input('schid');
        $ssn = $request->input('ssn');
        $clsm = $request->input('clsm');
        $clsa = $request->input('clsa');
        $start = $request->input('start', 0);
        $count = $request->input('count', 20);

        $gradeList = sch_grade::where([
            ['schid', $schid],
            ['clsid', $clsm],
            ['ssn', $ssn],
        ])->orderBy('g0', 'desc')->get();

        $grades = [];

        if ($gradeList->isEmpty()) {
            $grades = [
                'A' => [70, 100],
                'B' => [60, 69],
                'C' => [50, 59],
                'D' => [45, 49],
                'E' => [40, 44],
                'F' => [0, 39]
            ];
        } else {
            foreach ($gradeList as $row) {
                $grades[$row->grd] = [$row->g0, $row->g1];
            }
        }

        // $assignGrade = function ($average) use ($grades) {
        //     foreach ($grades as $grade => [$min, $max]) {
        //         if ($average >= $min && $average <= $max) {
        //             return $grade;
        //         }
        //     }
        //     return 'N/A';
        // };

        $assignGrade = function ($average) use ($grades) {
            $check = floor($average); // round down to whole number
            foreach ($grades as $grade => [$min, $max]) {
                if ($check >= $min && $check <= $max) {
                    return $grade;
                }
            }
            return 'N/A';
        };


        $className = cls::where('id', $clsm)->value('name');
        $classArmName = sch_cls::where('id', $clsa)->value('name');

        $students = old_student::where([
            ['schid', $schid],
            ['ssn', $ssn],
            ['clsm', $clsm],
            ['clsa', $clsa]
        ])->offset($start)->limit($count)->get();

        if ($students->isEmpty()) {
            return response()->json(['message' => 'No students found'], 404);
        }

        $subjects = std_score::where([
            ['schid', $schid],
            ['ssn', $ssn],
            ['clsid', $clsm],
        ])->groupBy('sbj')->pluck('sbj')->toArray();

        $subjectNames = subj::whereIn('id', $subjects)->pluck('name', 'id');
        $subjectAverages = [];

        foreach ($subjects as $subjectId) {
            $studentsScores = std_score::where([
                ['sbj', $subjectId],
                ['schid', $schid],
                ['ssn', $ssn],
                ['clsid', $clsm],
            ])->get()
                ->groupBy('stid')
                ->map(function ($scores) {
                    $grouped = $scores->unique(function ($item) {
                        return $item->trm . '-' . $item->aid;
                    });

                    $t1 = $grouped->where('trm', 1)->sum('scr');
                    $t2 = $grouped->where('trm', 2)->sum('scr');
                    $t3 = $grouped->where('trm', 3)->sum('scr');

                    $termCount = collect([$t1, $t2, $t3])->filter(fn($v) => $v > 0)->count();
                    $average = $termCount > 0 ? round(($t1 + $t2 + $t3) / $termCount, 2) : 0;

                    return ['stid' => $scores->first()->stid, 'average' => $average];
                })->sortByDesc('average')->values()->toArray();

            $ranked = [];
            $position = 1;
            $lastAvg = null;
            $sameRankCount = 0;

            foreach ($studentsScores as $index => $row) {
                if ($row['average'] === $lastAvg) {
                    $sameRankCount++;
                } else {
                    $position += $sameRankCount;
                    $sameRankCount = 1;
                }
                $ranked[$row['stid']] = $position;
                $lastAvg = $row['average'];
            }

            $subjectAverages[$subjectId] = $ranked;
        }

        $response = [];
        $classTotalAverage = 0;
        $totalStudentsWithScores = 0;

        foreach ($students as $student) {
            $stid = $student->sid;
            $result = [];

            foreach ($subjects as $subjectId) {
                $scores = std_score::where([
                    ['sbj', $subjectId],
                    ['schid', $schid],
                    ['ssn', $ssn],
                    ['clsid', $clsm],
                    ['stid', $stid]
                ])->get();

                $grouped = $scores->unique(function ($item) {
                    return $item->trm . '-' . $item->aid;
                });

                $t1 = $grouped->where('trm', 1)->sum('scr');
                $t2 = $grouped->where('trm', 2)->sum('scr');
                $t3 = $grouped->where('trm', 3)->sum('scr');

                if (($t1 + $t2 + $t3) == 0)
                    continue;

                $termCount = collect([$t1, $t2, $t3])->filter(fn($v) => $v > 0)->count();
                $average = $termCount > 0 ? number_format(($t1 + $t2 + $t3) / $termCount, 2, '.', '') : number_format(0, 2, '.', '');
                $grade = $assignGrade($average);

                $result[] = [
                    'subject_id' => $subjectId,
                    'subject_name' => $subjectNames[$subjectId] ?? 'Unknown',
                    '1st_term_total' => $t1,
                    '2nd_term_total' => $t2,
                    '3rd_term_total' => $t3,
                    'yearly_average' => $average,
                    'grade' => $grade,
                    'position' => $subjectAverages[$subjectId][$stid] ?? null
                ];
            }

            $stuRecord = student::where('schid', $schid)->where('sid', $stid)->first();
            $suid = null;
            if ($stuRecord) {
                $ssn_real = $stuRecord->year;
                $term = $stuRecord->term;
                $count = $stuRecord->count;
                $suid = $stuRecord->sch3 . '/' . $ssn_real . '/' . $term . '/' . strval($count);
            }

            $gender = student_basic_data::where('user_id', $stid)->value('sex');
            $totalAverage = 0;
            $subjectCount = count($result);

            foreach ($result as $subject) {
                $totalAverage += $subject['yearly_average'];
            }

            $finalAverage = $subjectCount > 0 ? number_format($totalAverage / $subjectCount, 2, '.', '') : number_format(0, 2, '.', '');
            $finalGrade = $assignGrade($finalAverage);

            if ($subjectCount > 0) {
                $classTotalAverage += $finalAverage;
                $totalStudentsWithScores++;
            }

            $response[] = [
                'sid' => $stid,
                'student_id' => $suid,
                'student_name' => $student->lname . ' ' . $student->fname,
                'gender' => $gender ?? 'Unknown',
                'class' => $className ?? 'Class ID: ' . $clsm,
                'class_arm' => $classArmName ?? 'Class Arm ID: ' . $clsa,
                'session' => $ssn,
                'school_id' => $schid,
                'subjects' => $result,
                'final_average' => $finalAverage,
                'final_average_grade' => $finalGrade
            ];
        }

        usort($response, fn($a, $b) => $b['final_average'] <=> $a['final_average']);

        $classAverage = $totalStudentsWithScores > 0
            ? number_format($classTotalAverage / $totalStudentsWithScores, 2, '.', '')
            : '0.00';

        // Inject class average into each student's data
        foreach ($response as &$student) {
            $student['class_average'] = $classAverage;
        }

        return response()->json([
            'start' => $start,
            'count' => $count,
            'pld' => $response
        ]);
    }





    /**
     * @OA\Get(
     *     path="/api/getYearlyAssessmentAverage",
     *     summary="Get yearly psychomotor average and term scores for a student",
     *     tags={"Api"},
     *     security={{"bearerAuth": {}}},
     *     @OA\Parameter(
     *         name="schid",
     *         in="query",
     *         description="School ID",
     *         required=true,
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Parameter(
     *         name="stid",
     *         in="query",
     *         description="Student ID",
     *         required=true,
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Parameter(
     *         name="ssn",
     *         in="query",
     *         description="Academic Session",
     *         required=true,
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Response(
     *         response=200,
     *         description="Successful response with student psychomotor data",
     *         @OA\JsonContent(
     *             @OA\Property(property="student_name", type="string", example="John Doe"),
     *             @OA\Property(property="session", type="string", example="2023/2024"),
     *             @OA\Property(property="class", type="string", example="Primary 4"),
     *             @OA\Property(property="class_arm", type="string", example="A"),
     *             @OA\Property(
     *                 property="psychomotor_term_scores",
     *                 type="object",
     *                 @OA\Property(
     *                     property="term_1",
     *                     type="object",
     *                     @OA\Property(property="punc", type="number", example=4),
     *                     @OA\Property(property="hon", type="number", example=3)
     *                 ),
     *                 @OA\Property(
     *                     property="term_2",
     *                     type="object",
     *                     @OA\Property(property="punc", type="number", example=4),
     *                     @OA\Property(property="hon", type="number", example=3)
     *                 ),
     *                 @OA\Property(
     *                     property="term_3",
     *                     type="object",
     *                     @OA\Property(property="punc", type="number", example=4),
     *                     @OA\Property(property="hon", type="number", example=3)
     *                 )
     *             ),
     *             @OA\Property(
     *                 property="psychomotor_averages",
     *                 type="object",
     *                 @OA\Property(property="punc", type="number", example=3.67),
     *                 @OA\Property(property="hon", type="number", example=4.00)
     *             )
     *         )
     *     ),
     *     @OA\Response(
     *         response=404,
     *         description="No records found for this student",
     *         @OA\JsonContent(
     *             @OA\Property(property="message", type="string", example="No records found for this student.")
     *         )
     *     )
     * )
     */


    public function getYearlyAssessmentAverage(Request $request)
    {
        $validated = $request->validate([
            'schid' => 'required',
            'stid' => 'required',
            'ssn' => 'required'
        ]);

        // Get student from old_student for class info
        $oldStudent = old_student::where('sid', $validated['stid'])
            ->where('schid', $validated['schid'])
            ->where('ssn', $validated['ssn'])
            ->first();

        if (!$oldStudent || !$oldStudent->clsm || !$oldStudent->clsa) {
            return response()->json(['message' => 'Class or class arm information not found for student.'], 404);
        }

        $clsm = $oldStudent->clsm;
        $clsa = $oldStudent->clsa;

        // Fetch psychomotor records
        $psyRecords = student_psy::where('schid', $validated['schid'])
            ->where('stid', $validated['stid'])
            ->where('ssn', $validated['ssn'])
            ->where('clsm', $clsm)
            ->where('clsa', $clsa)
            ->get();

        if ($psyRecords->isEmpty()) {
            return response()->json(['message' => 'No psychomotor records found for this student.'], 404);
        }

        $fields = ['punc', 'hon', 'pol', 'neat', 'pers', 'rel', 'dil', 'cre', 'pat', 'verb', 'gam', 'musc', 'drw', 'wrt'];
        $totals = array_fill_keys($fields, 0);
        $counts = array_fill_keys($fields, 0);
        $termWise = [];

        foreach ([1, 2, 3] as $term) {
            $termRecord = $psyRecords->firstWhere('trm', $term);
            if ($termRecord) {
                $termWise["term_$term"] = [];
                foreach ($fields as $field) {
                    $value = $termRecord->$field ?? null;
                    $termWise["term_$term"][$field] = $value;

                    if (!is_null($value)) {
                        $totals[$field] += $value;
                        $counts[$field]++;
                    }
                }
            }
        }

        $averages = [];
        foreach ($fields as $field) {
            $averages[$field] = $counts[$field] > 0
                ? round($totals[$field] / $counts[$field])
                : null;
        }

        // Get extra info from student table (for SUID and name)
        $student = student::where('sid', $validated['stid'])
            ->where('schid', $validated['schid'])
            ->first();

        $suid = $student
            ? $student->sch3 . '/' . $student->year . '/' . $student->term . '/' . strval($student->count)
            : ($oldStudent->suid ?? null);

        $studentName = $student
            ? trim($student->fname . ' ' . ($student->mname ?? '') . ' ' . $student->lname)
            : trim($oldStudent->fname . ' ' . ($oldStudent->mname ?? '') . ' ' . $oldStudent->lname);

        // Get class and arm names
        $className = \App\Models\cls::where('id', $clsm)->value('name') ?? 'Unknown';
        $classArmName = \App\Models\sch_cls::where('id', $clsa)->value('name') ?? 'Unknown';

        return response()->json([
            'student_id' => $suid,
            'student_name' => $studentName,
            'session' => $validated['ssn'],
            'class' => $className,
            'class_arm' => $classArmName,
            'psychomotor_term_scores' => $termWise,
            'psychomotor_averages' => $averages,
        ]);
    }




    /**
     * @OA\Get(
     *     path="/api/getAllStudentsYearlyAssessmentAverages",
     *     summary="Get all students' yearly psychomotor assessment averages and term scores",
     *     tags={"Api"},
     *     security={{"bearerAuth": {}}},
     *     @OA\Parameter(
     *         name="schid",
     *         in="query",
     *         description="School ID",
     *         required=true,
     *         @OA\Schema(type="integer")
     *     ),
     *     @OA\Parameter(
     *         name="ssn",
     *         in="query",
     *         description="Session (e.g. 2024)",
     *         required=true,
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Parameter(
     *         name="clsm",
     *         in="query",
     *         description="Class main ID (from cls table)",
     *         required=true,
     *         @OA\Schema(type="integer")
     *     ),
     *     @OA\Parameter(
     *         name="clsa",
     *         in="query",
     *         description="Class arm ID (from sch_cls table)",
     *         required=true,
     *         @OA\Schema(type="integer")
     *     ),
     *     @OA\Parameter(
     *         name="start",
     *         in="query",
     *         description="Offset for pagination",
     *         required=false,
     *         @OA\Schema(type="integer", default=0)
     *     ),
     *     @OA\Parameter(
     *         name="count",
     *         in="query",
     *         description="Number of students to return",
     *         required=false,
     *         @OA\Schema(type="integer", default=20)
     *     ),
     *     @OA\Response(
     *         response=200,
     *         description="Successful response with psychomotor scores",
     *         @OA\JsonContent(
     *             @OA\Property(property="class", type="string", example="Primary 5"),
     *             @OA\Property(property="class_arm", type="string", example="Arm A"),
     *             @OA\Property(property="session", type="string", example="2024"),
     *             @OA\Property(property="total_students_returned", type="integer", example=3),
     *             @OA\Property(
     *                 property="students",
     *                 type="array",
     *                 @OA\Items(
     *                     @OA\Property(property="student_name", type="string", example="Jane Doe"),
     *                     @OA\Property(property="student_id", type="string", example="ST12345"),
     *                     @OA\Property(
     *                         property="psychomotor_term_scores",
     *                         type="object",
     *                         @OA\Property(
     *                             property="term_1",
     *                             type="object",
     *                             @OA\Property(property="punc", type="integer", example=4),
     *                             @OA\Property(property="hon", type="integer", example=3),
     *                             @OA\Property(property="pol", type="integer", example=5),
     *                             @OA\Property(property="neat", type="integer", example=4),
     *                             @OA\Property(property="pers", type="integer", example=3),
     *                             @OA\Property(property="rel", type="integer", example=5),
     *                             @OA\Property(property="dil", type="integer", example=4),
     *                             @OA\Property(property="cre", type="integer", example=4),
     *                             @OA\Property(property="pat", type="integer", example=3),
     *                             @OA\Property(property="verb", type="integer", example=5),
     *                             @OA\Property(property="gam", type="integer", example=4),
     *                             @OA\Property(property="musc", type="integer", example=3),
     *                             @OA\Property(property="drw", type="integer", example=2),
     *                             @OA\Property(property="wrt", type="integer", example=4)
     *                         ),
     *                         @OA\Property(property="term_2", ref="#/components/schemas/PsychomotorTermScores"),
     *                         @OA\Property(property="term_3", ref="#/components/schemas/PsychomotorTermScores")
     *                     ),
     *                     @OA\Property(
     *                         property="psychomotor_averages",
     *                         type="object",
     *                         @OA\Property(property="punc", type="integer", example=4),
     *                         @OA\Property(property="hon", type="integer", example=3),
     *                         @OA\Property(property="pol", type="integer", example=5),
     *                         @OA\Property(property="neat", type="integer", example=4),
     *                         @OA\Property(property="pers", type="integer", example=3),
     *                         @OA\Property(property="rel", type="integer", example=5),
     *                         @OA\Property(property="dil", type="integer", example=4),
     *                         @OA\Property(property="cre", type="integer", example=4),
     *                         @OA\Property(property="pat", type="integer", example=3),
     *                         @OA\Property(property="verb", type="integer", example=5),
     *                         @OA\Property(property="gam", type="integer", example=4),
     *                         @OA\Property(property="musc", type="integer", example=3),
     *                         @OA\Property(property="drw", type="integer", example=2),
     *                         @OA\Property(property="wrt", type="integer", example=4)
     *                     )
     *                 )
     *             )
     *         )
     *     ),
     *     @OA\Response(
     *         response=404,
     *         description="No students found.",
     *         @OA\JsonContent(
     *             @OA\Property(property="message", type="string", example="No students found.")
     *         )
     *     )
     * )
     *
     * @OA\Schema(
     *     schema="PsychomotorTermScores",
     *     type="object",
     *     @OA\Property(property="punc", type="integer", example=4),
     *     @OA\Property(property="hon", type="integer", example=3),
     *     @OA\Property(property="pol", type="integer", example=5),
     *     @OA\Property(property="neat", type="integer", example=4),
     *     @OA\Property(property="pers", type="integer", example=3),
     *     @OA\Property(property="rel", type="integer", example=5),
     *     @OA\Property(property="dil", type="integer", example=4),
     *     @OA\Property(property="cre", type="integer", example=4),
     *     @OA\Property(property="pat", type="integer", example=3),
     *     @OA\Property(property="verb", type="integer", example=5),
     *     @OA\Property(property="gam", type="integer", example=4),
     *     @OA\Property(property="musc", type="integer", example=3),
     *     @OA\Property(property="drw", type="integer", example=2),
     *     @OA\Property(property="wrt", type="integer", example=4)
     * )
     */

    public function getAllStudentsYearlyAssessmentAverages(Request $request)
    {
        $validated = $request->validate([
            'schid' => 'required',
            'ssn' => 'required',
            'clsm' => 'required', // class main id (from cls)
            'clsa' => 'required'  // class arm id (from sch_cls)
        ]);

        $start = $request->input('start', 0);
        $count = $request->input('count', 20);

        // Get student IDs from old_student based on class main and class arm
        $studentIds = old_student::where('schid', $validated['schid'])
            ->where('clsm', $validated['clsm'])
            ->where('clsa', $validated['clsa'])
            ->pluck('sid');

        // Fetch students from student table based on those IDs and school id
        $students = student::where('schid', $validated['schid'])
            ->whereIn('sid', $studentIds)
            ->skip($start)
            ->take($count)
            ->get();

        if ($students->isEmpty()) {
            return response()->json(['message' => 'No students found.'], 404);
        }

        $fields = ['punc', 'hon', 'pol', 'neat', 'pers', 'rel', 'dil', 'cre', 'pat', 'verb', 'gam', 'musc', 'drw', 'wrt'];
        $results = [];

        foreach ($students as $student) {
            $psyRecords = student_psy::where('schid', $validated['schid'])
                ->where('stid', $student->sid)
                ->where('ssn', $validated['ssn'])
                ->where('clsm', $validated['clsm'])
                ->where('clsa', $validated['clsa'])
                ->get();

            if ($psyRecords->isEmpty()) {
                continue;
            }

            $totals = array_fill_keys($fields, 0);
            $counts = array_fill_keys($fields, 0);
            $termScores = [];

            foreach ([1, 2, 3] as $term) {
                $termRecord = $psyRecords->firstWhere('trm', $term);
                $termKey = 'term_' . $term;

                $termData = [];
                foreach ($fields as $field) {
                    $value = $termRecord ? $termRecord->$field : null;
                    $termData[$field] = $value;

                    if (!is_null($value)) {
                        $totals[$field] += $value;
                        $counts[$field]++;
                    }
                }

                $termScores[$termKey] = $termData;
            }

            $averages = [];
            foreach ($fields as $field) {
                $averages[$field] = $counts[$field] > 0
                    ? round($totals[$field] / $counts[$field])
                    : null;
            }

            // Generate suid
            $suid = null;
            if ($student) {
                $ssn_real = $student->year;
                $term = $student->term;
                $count_val = $student->count;
                $suid = $student->sch3 . '/' . $ssn_real . '/' . $term . '/' . strval($count_val);
            }

            $results[] = [
                'student_name' => $student->fname . ' ' . $student->lname,
                'student_id' => $suid,
                'psychomotor_term_scores' => $termScores,
                'psychomotor_averages' => $averages,
            ];
        }

        $className = cls::where('id', $validated['clsm'])->value('name');
        $classArmName = sch_cls::where('schid', $validated['schid'])
            ->where('cls_id', $validated['clsa'])
            ->value('name');

        return response()->json([
            'class' => $className,
            'class_arm' => $classArmName,
            'session' => $validated['ssn'],
            'total_students_returned' => count($results),
            'students' => $results
        ]);
    }



    /**
     * @OA\Get(
     *     path="/api/getEveryStudentCumulativeResult",
     *     tags={"Api"},
     *     summary="Get Every Student's Cumulative Result",
     *     description="Returns 1st term, 2nd term, 3rd term and yearly average (excluding totals) for all students",
     *     security={{"bearerAuth": {}}},
     *     @OA\Response(
     *         response=200,
     *         description="Success",
     *         @OA\JsonContent(
     *             @OA\Property(property="status", type="boolean", example=true),
     *             @OA\Property(property="message", type="string", example="Success"),
     *             @OA\Property(
     *                 property="pld",
     *                 type="array",
     *                 @OA\Items(
     *                     @OA\Property(property="no", type="string", example="1"),
     *                     @OA\Property(property="name", type="string", example="First Term"),
     *                     @OA\Property(property="created_at", type="string", format="date-time", example="2024-01-01T00:00:00Z"),
     *                     @OA\Property(property="updated_at", type="string", format="date-time", example="2024-01-01T00:00:00Z")
     *                 )
     *             )
     *         )
     *     ),
     *     @OA\Response(
     *         response=401,
     *         description="Unauthorized"
     *     )
     * )
     */



    public function getEveryStudentCumulativeResult()
    {
        // Sum all scores by term (no grouping)
        $totals = std_score::select(
            DB::raw("SUM(CASE WHEN trm = 1 THEN scr ELSE 0 END) as t1"),
            DB::raw("SUM(CASE WHEN trm = 2 THEN scr ELSE 0 END) as t2"),
            DB::raw("SUM(CASE WHEN trm = 3 THEN scr ELSE 0 END) as t3")
        )->first();

        $t1 = $totals->t1 ?? 0;
        $t2 = $totals->t2 ?? 0;
        $t3 = $totals->t3 ?? 0;

        $yearly_average = round(($t1 + $t2 + $t3) / 3, 2);

        $now = now()->toIso8601String();

        $pld = [
            [
                'no' => '1',
                'name' => 'First Term',
                'created_at' => $now,
                'updated_at' => $now,
            ],
            [
                'no' => '2',
                'name' => 'Second Term',
                'created_at' => $now,
                'updated_at' => $now,
            ],
            [
                'no' => '3',
                'name' => 'Third Term',
                'created_at' => $now,
                'updated_at' => $now,
            ],
            [
                'no' => '4',
                'name' => 'Cummulative',
                'created_at' => $now,
                'updated_at' => $now,
            ]
        ];

        return response()->json([
            'status' => true,
            'message' => 'Success',
            'pld' => $pld
        ]);
    }


    ////////////////////////////

    /**
     * @OA\Get(
     *     path="/api/getLoggedInUserDetails",
     *     summary="Get logged-in user details (with optional session & term filters)",
     *     description="This endpoint retrieves the authenticated user's details along with staff information.
     *     You can optionally pass 'ssn' (session) and 'trm' (term) as query parameters to filter the staff record.
     *     If no matching record is found, the system will return the latest available session/term record.",
     *     operationId="getLoggedInUserDetails",
     *     tags={"Authentication"},
     *     security={{"bearerAuth":{}}},
     *
     *     @OA\Parameter(
     *         name="ssn",
     *         in="query",
     *         required=false,
     *         description="Session to filter staff records (e.g., 2024)",
     *         @OA\Schema(type="string", example="2024")
     *     ),
     *     @OA\Parameter(
     *         name="trm",
     *         in="query",
     *         required=false,
     *         description="Term to filter staff records (e.g., 1)",
     *         @OA\Schema(type="string", example="1")
     *     ),
     *
     *     @OA\Response(
     *         response=200,
     *         description="User details successfully retrieved",
     *         @OA\JsonContent(
     *             type="object",
     *             @OA\Property(property="user", type="object",
     *                 description="Authenticated user data",
     *                 example={
     *                     "id": 1932,
     *                     "email": "user@example.com",
     *                     "name": "John Doe"
     *                 }
     *             ),
     *             @OA\Property(property="profile", type="object",
     *                 description="Staff profile with role names",
     *                 example={
     *                     "id": 15,
     *                     "fname": "Onyinyechi",
     *                     "lname": "Ahiabuike",
     *                     "ssn": "2024",
     *                     "trm": "1",
     *                     "clsm": "11",
     *                     "role": "13",
     *                     "role2": "14",
     *                     "role_name": "Head Teacher",
     *                     "role2_name": "Subject Teacher"
     *                 }
     *             ),
     *             @OA\Property(property="ssn", type="string", example="2024"),
     *             @OA\Property(property="trm", type="string", example="1")
     *         )
     *     ),
     *
     *     @OA\Response(
     *         response=401,
     *         description="Unauthorized - Invalid or missing JWT token",
     *         @OA\JsonContent(
     *             @OA\Property(property="message", type="string", example="Token not provided or invalid")
     *         )
     *     ),
     *
     *     @OA\Response(
     *         response=404,
     *         description="User not found",
     *         @OA\JsonContent(
     *             @OA\Property(property="message", type="string", example="User not found")
     *         )
     *     )
     * )
     */

    public function getLoggedInUserDetails(Request $request)
    {
        try {
            $user = JWTAuth::parseToken()->authenticate();

            if (!$user) {
                return response()->json(['message' => 'User not found'], 404);
            }

            // Get ssn & trm from query
            $ssn = $request->input('ssn');
            $trm = $request->input('trm');

            // ---------------------------------------
            // 1. Try OLD STAFF (existing staff)
            // ---------------------------------------
            $oldStaffQuery = $user->oldStaff();

            if (!empty($ssn)) {
                $oldStaffQuery->where('ssn', $ssn);
            }

            if (!empty($trm)) {
                $oldStaffQuery->where('trm', $trm);
            }

            $staff = $oldStaffQuery->first();

            // If still nothing, load latest ssn/trm
            if (!$staff) {
                $staff = $user->oldStaff()
                    ->orderByDesc('ssn')
                    ->orderByDesc('trm')
                    ->first();
            }

            // ---------------------------------------
            // 2. If NOT FOUND in old_staff  use NEW staff table
            // ---------------------------------------
            if (!$staff) {
                $staff = $user->staff()->first();

                if ($staff) {
                    // Convert NEW STAFF fields to old_staff format
                    $staff = (object) [
                        'uid' => $staff->uid ?? null,
                        'sid' => $staff->sid,          // same as user_id
                        'schid' => $staff->schid,
                        'fname' => $staff->fname,
                        'mname' => $staff->mname,
                        'lname' => $staff->lname,
                        'status' => $staff->status ?? 'active',
                        'suid' => $staff->suid ?? "",
                        'ssn' => $staff->ssn ?? "",
                        'trm' => $staff->trm ?? "",
                        'clsm' => $staff->clsm ?? "",
                        'role' => $staff->role ?? "",
                        'role2' => $staff->role2 ?? "",
                        'more' => $staff->more ?? "",
                        'created_at' => $staff->created_at,
                        'updated_at' => $staff->updated_at
                    ];
                }
            }

            // ---------------------------------------
            // 3. If still no profile, return empty profile
            // ---------------------------------------
            if (!$staff) {
                return response()->json([
                    'user' => $user,
                    'profile' => null,
                    'ssn' => $ssn,
                    'trm' => $trm,
                ]);
            }

            // ---------------------------------------
            // 4. Load Role Names
            // ---------------------------------------
            $role = ltrim($staff->role, '*-');
            $role2 = ltrim($staff->role2, '*-');

            $roleName = \App\Models\sch_staff_role::where('role', $role)
                ->where('schid', $staff->schid)
                ->value('name');

            $role2Name = \App\Models\sch_staff_role::where('role', $role2)
                ->where('schid', $staff->schid)
                ->value('name');

            // ---------------------------------------
            // 5. Build profile in EXACT format you want
            // ---------------------------------------
            $profile = [
                'uid' => $staff->uid,
                'sid' => $staff->sid,
                'schid' => $staff->schid,
                'fname' => $staff->fname,
                'mname' => $staff->mname,
                'lname' => $staff->lname,
                'status' => $staff->status,
                'suid' => $staff->suid,
                'ssn' => $staff->ssn,
                'trm' => $staff->trm,
                'clsm' => $staff->clsm,
                'role' => $staff->role,
                'role2' => $staff->role2,
                'more' => $staff->more,
                'created_at' => $staff->created_at,
                'updated_at' => $staff->updated_at,
                'role_name' => $roleName,
                'role2_name' => $role2Name,
            ];

            return response()->json([
                'user' => $user,
                'profile' => $profile,
                'ssn' => $ssn,
                'trm' => $trm,
            ]);

        } catch (\Exception $e) {
            return response()->json([
                'message' => 'Server Error',
                'error' => $e->getMessage(),
                'line' => $e->getLine(),
                'file' => $e->getFile(),
            ], 500);
        }
    }



    ////////////////////////////////////////////////////////////////////

    /**
     * @OA\Get(
     *     path="/api/getCummulativeBroadsheet/{schid}/{ssn}/{clsm}/{clsa}",
     *     summary="Get cumulative broadsheet for a given school, session, class, and arm",
     *     tags={"Api"},
     *     security={{"bearerAuth":{}}},
     *     @OA\Parameter(
     *         name="schid",
     *         in="path",
     *         required=true,
     *         description="School ID",
     *         @OA\Schema(type="integer")
     *     ),
     *     @OA\Parameter(
     *         name="ssn",
     *         in="path",
     *         required=true,
     *         description="Session ID",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Parameter(
     *         name="clsm",
     *         in="path",
     *         required=true,
     *         description="Class ID",
     *         @OA\Schema(type="integer")
     *     ),
     *     @OA\Parameter(
     *         name="clsa",
     *         in="path",
     *         required=true,
     *         description="Class arm identifier or -1 if not applicable",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Response(
     *         response=200,
     *         description="Successful retrieval of cumulative broadsheet",
     *         @OA\JsonContent(
     *             @OA\Property(property="status", type="boolean", example=true),
     *             @OA\Property(property="message", type="string", example="Success"),
     *             @OA\Property(
     *                 property="data",
     *                 type="array",
     *                 @OA\Items(
     *                     @OA\Property(property="name", type="string", example="DOE JOHN"),
     *                     @OA\Property(property="learner_id", type="string", example="STU123"),
     *                     @OA\Property(property="class_name", type="string", example="Primary 5"),
     *                     @OA\Property(property="class_arm_name", type="string", example="Red"),
     *                     @OA\Property(property="clsm", type="integer", example=5),
     *                     @OA\Property(property="clsa", type="string", example="Red"),
     *                     @OA\Property(property="final_average", type="number", format="float", example=85.6),
     *                     @OA\Property(property="overall_position", type="integer", example=1),
     *                     @OA\Property(property="no_of_subjects", type="integer", example=5),
     *                     @OA\Property(
     *                         property="subjects",
     *                         type="array",
     *                         @OA\Items(
     *                             @OA\Property(property="subject_id", type="integer", example=1),
     *                             @OA\Property(property="subject_name", type="string", example="Mathematics"),
     *                             @OA\Property(property="average", type="number", format="float", example=88.0),
     *                             @OA\Property(property="position", type="integer", example=1),
     *                             @OA\Property(property="ca", type="integer", example=25)
     *                         )
     *                     ),
     *                     @OA\Property(
     *                         property="psychomotor",
     *                         type="object",
     *                         @OA\Property(property="punc", type="string", example="Excellent"),
     *                         @OA\Property(property="hon", type="string", example="Good"),
     *                         @OA\Property(property="pol", type="string", example="Fair"),
     *                         @OA\Property(property="neat", type="string", example="Very Good"),
     *                         @OA\Property(property="pers", type="string", example="Good"),
     *                         @OA\Property(property="rel", type="string", example="Excellent"),
     *                         @OA\Property(property="dil", type="string", example="Good"),
     *                         @OA\Property(property="cre", type="string", example="Fair"),
     *                         @OA\Property(property="pat", type="string", example="Good"),
     *                         @OA\Property(property="verb", type="string", example="Very Good"),
     *                         @OA\Property(property="gam", type="string", example="Fair"),
     *                         @OA\Property(property="musc", type="string", example="Average"),
     *                         @OA\Property(property="drw", type="string", example="Poor"),
     *                         @OA\Property(property="wrt", type="string", example="Good")
     *                     )
     *                 )
     *             )
     *         )
     *     ),
     *     @OA\Response(
     *         response=404,
     *         description="No records found"
     *     )
     * )
     */



    public function getCummulativeBroadsheet($schid, $ssn, $clsm, $clsa)
    {
        // Ensure one row per student (avoid duplicates across terms)
        $students = old_student::where('schid', $schid)
            ->where('ssn', $ssn)
            ->where('clsm', $clsm)
            ->when($clsa != '-1', fn($q) => $q->where('clsa', $clsa))
            ->selectRaw('MIN(uid) as uid, sid, schid, fname, lname, mname, suid, clsm, clsa')
            ->groupBy('sid', 'schid', 'fname', 'lname', 'mname', 'suid', 'clsm', 'clsa')
            ->get();

        // Unique student IDs
        $allClassStudentIds = $students->pluck('sid')->unique()->values();

        // Class/Arm names
        $className = cls::where('id', $clsm)->value('name') ?? "CLS-$clsm";
        $armName = $clsa !== '-1'
            ? sch_cls::where('cls_id', $clsm)
                ->where('schid', $schid)
                ->where('id', $clsa)
                ->value('name')
            : null;

        // Subjects for class
        $subjects = class_subj::where('schid', $schid)
            ->where('clsid', $clsm)
            ->pluck('subj_id')
            ->toArray();

        $subjectPositions = [];
        $subjectAverages = [];

        // $control = broadsheet_control::where('schid', $schid)
        //     ->where('ssn', $ssn)
        //      ->where('sid', $stid) //  VERY IMPORTANT
        //     ->where('clsm', $clsm)
        //     ->where('clsa', $clsa)
        //     ->first();

        // $broadsheetStat = $control->stat ?? 1;  // default = unlocked


        // Process each subject
        foreach ($subjects as $sbj) {
            $subjectScores = std_score::select(
                'stid',
                DB::raw("SUM(CASE WHEN trm = 1 THEN scr ELSE 0 END) as t1"),
                DB::raw("SUM(CASE WHEN trm = 2 THEN scr ELSE 0 END) as t2"),
                DB::raw("SUM(CASE WHEN trm = 3 THEN scr ELSE 0 END) as t3")
            )
                ->where('schid', $schid)
                ->where('ssn', $ssn)
                ->where('clsid', $clsm)
                ->where('sbj', $sbj)
                ->whereIn('stid', $allClassStudentIds)
                ->groupBy('stid')
                ->get()
                ->map(function ($item) {
                    $total = 0;
                    $count = 0;
                    if ($item->t1 > 0) {
                        $total += $item->t1;
                        $count++;
                    }
                    if ($item->t2 > 0) {
                        $total += $item->t2;
                        $count++;
                    }
                    if ($item->t3 > 0) {
                        $total += $item->t3;
                        $count++;
                    }
                    $avg = $count > 0 ? round($total / $count, 2) : 0;
                    return ['stid' => $item->stid, 'average' => $avg];
                })
                ->filter(fn($row) => $row['average'] > 0) //  remove students with 0.00 avg
                ->sortByDesc('average')
                ->values();

            // Ranking
            $rank = [];
            $position = 1;
            $lastAvg = null;
            $sameRankCount = 0;

            foreach ($subjectScores as $row) {
                if ($row['average'] === $lastAvg) {
                    $sameRankCount++;
                } else {
                    $position += $sameRankCount;
                    $sameRankCount = 1;
                }
                $rank[$row['stid']] = $position;
                $lastAvg = $row['average'];
            }

            foreach ($subjectScores as $row) {
                $subjectAverages[$row['stid']][$sbj] = $row['average'];
                $subjectPositions[$row['stid']][$sbj] = $rank[$row['stid']] ?? null;
            }
        }

        // Final averages
        $finalAverages = [];
        foreach ($students as $std) {
            $stid = $std->sid;
            $subjectsTaken = student_subj::where('stid', $stid)->pluck('sbj')->toArray();

            $total = 0;
            $count = 0;
            foreach ($subjectsTaken as $sbj) {
                $avg = $subjectAverages[$stid][$sbj] ?? 0;
                if ($avg > 0) {
                    $total += $avg;
                    $count++;
                }
            }

            if ($count > 0) { //  Exclude students with no subjects or all zero scores
                $finalAverages[$stid] = round($total / $count, 2);
            }
        }

        // Overall ranking
        $overallSorted = collect($finalAverages)->sortDesc();
        $overallPosition = [];
        $rank = 1;
        $last = null;
        $tieCount = 0;

        foreach ($overallSorted as $stid => $avg) {
            if ($avg === $last) {
                $tieCount++;
            } else {
                $rank += $tieCount;
                $tieCount = 1;
            }
            $overallPosition[$stid] = $rank;
            $last = $avg;
        }

        // Final output
        $final = [];

        foreach ($students as $std) {
            $stid = $std->sid;

            $control = broadsheet_control::where('schid', $schid)
                ->where('ssn', $ssn)
                ->where('sid', $stid)
                ->where('clsm', $clsm)
                ->where('clsa', $clsa)
                ->first();

            $broadsheetStat = $control->stat ?? 1;



            // skip students with no average
            if (!isset($finalAverages[$stid]))
                continue;

            $name = strtoupper(trim($std->lname . ' ' . $std->fname));
            $subjectsTaken = student_subj::where('stid', $stid)->pluck('sbj')->toArray();

            $subjectsInfo = [];
            $count = 0;

            foreach ($subjectsTaken as $sbj) {
                $avg = $subjectAverages[$stid][$sbj] ?? 0;
                if ($avg <= 0)
                    continue;

                $pos = $subjectPositions[$stid][$sbj] ?? null;
                $count++;

                $subjectsInfo[] = [
                    'subject_id' => $sbj,
                    'subject_name' => subj::find($sbj)?->name ?? 'Subject',
                    'yearly_average' => number_format($avg, 2),
                    'subject_position' => $pos,
                ];
            }

            // Psychomotor
            $psy = student_psy::where('stid', $stid)
                ->where('schid', $schid)
                ->where('ssn', $ssn)
                ->where('trm', 2)
                ->where('clsm', $clsm)
                ->when($clsa !== '-1', fn($q) => $q->where('clsa', (int) $clsa))
                ->first();

            $psychomotor = $psy ? [
                'punc' => $psy->punc,
                'hon' => $psy->hon,
                'pol' => $psy->pol,
                'neat' => $psy->neat,
                'pers' => $psy->pers,
                'rel' => $psy->rel,
                'dil' => $psy->dil,
                'cre' => $psy->cre,
                'pat' => $psy->pat,
                'verb' => $psy->verb,
                'gam' => $psy->gam,
                'musc' => $psy->musc,
                'drw' => $psy->drw,
                'wrt' => $psy->wrt,
            ] : [];

            $finalAvg = $finalAverages[$stid] ?? 0;
            $final[] = [
                'uid' => $std->uid,
                'sid' => $stid,
                'name' => $name,
                'learner_id' => $std->suid ?? $std->sid,
                'class_name' => $className,
                'class_arm_name' => $armName ?? 'N/A',
                'clsm' => $clsm,
                'clsa' => $clsa,
                'final_average' => number_format($finalAvg, 2),
                'overall_position' => $overallPosition[$stid] ?? null,
                'no_of_subjects' => $count,
                'subjects' => $subjectsInfo,
                'psychomotor' => $psychomotor,
                'broadsheet_status' => $broadsheetStat,

            ];
        }

        $final = collect($final)->sortBy('overall_position')->values()->all();

        return response()->json([
            'status' => true,
            'message' => 'Success',
            'pld' => $final
        ]);
    }





    /**
     * @OA\Get(
     *     path="/api/getComment/{stid}/{schid}/{clsm}/{sesn}",
     *     summary="Get all student comments for a given class, arm, session, and term",
     *     description="Returns all comments for a student based on stid, schid, class, class arm, session, and term",
     *     operationId="getStudentComments",
     *     tags={"Api"},
     *     security={{"bearerAuth":{}}},
     *
     *     @OA\Parameter(
     *         name="stid",
     *         in="path",
     *         required=true,
     *         description="Student ID",
     *         @OA\Schema(type="string", example="ST001")
     *     ),
     *     @OA\Parameter(
     *         name="schid",
     *         in="path",
     *         required=true,
     *         description="School ID",
     *         @OA\Schema(type="string", example="SCH123")
     *     ),
     *     @OA\Parameter(
     *         name="clsm",
     *         in="path",
     *         required=true,
     *         description="Class ID",
     *         @OA\Schema(type="string", example="1")
     *     ),
     *     @OA\Parameter(
     *         name="sesn",
     *         in="path",
     *         required=true,
     *         description="Session (academic year)",
     *         @OA\Schema(type="string", example="2023")
     *     ),

     *     @OA\Response(
     *         response=200,
     *         description="Successful response",
     *         @OA\JsonContent(
     *             type="array",
     *             @OA\Items(
     *                 @OA\Property(property="com", type="string", example="Excellent progress."),
     *                 @OA\Property(property="schid", type="string", example="12"),
     *                 @OA\Property(property="class_id", type="string", example="1"),
     *                 @OA\Property(property="class_name", type="string", example="JSS 2"),
     *                 @OA\Property(property="class_arm_name", type="string", example="Blue")
     *             )
     *         )
     *     ),
     *     @OA\Response(
     *         response=404,
     *         description="No records found",
     *         @OA\JsonContent(
     *             @OA\Property(property="message", type="string", example="No records found")
     *         )
     *     )
     * )
     */


    public function getComment($stid, $schid, $clsm, $sesn)
    {
        // Get all matching result records, including sid
        $records = cummulative_comment::where('sid', $stid)
            ->where('schid', $schid)
            ->where('clsm', $clsm)
            ->where('ssn', $sesn)
            ->select('sid', 'comm', 'clsm', 'schid')
            ->get();

        if ($records->isEmpty()) {
            return response()->json(['message' => 'No records found'], 404);
        }

        // Get class name only
        $className = cls::where('id', $clsm)->value('name');

        // Append extra info to each record
        $results = $records->map(function ($record) use ($className) {
            return [
                'sid' => $record->sid,
                'com' => $record->comm,
                'schid' => $record->schid,
                'class_id' => $record->clsm,
                'class_name' => $className,
            ];
        });

        return response()->json($results);
    }





    /**
     * @OA\Get(
     *     path="/api/getAllComment/{schid}/{clsm}/{clsa}/{ssn}",
     *     summary="Get all comments for a student in a given session and term",
     *     operationId="getAllStudentComments",
     *     tags={"Api"},
     *     security={{"bearerAuth":{}}},
     *     @OA\Parameter(
     *         name="schid",
     *         in="path",
     *         required=true,
     *         description="School ID",
     *         @OA\Schema(type="string", example="SCH123")
     *     ),
     *     @OA\Parameter(
     *         name="clsm",
     *         in="path",
     *         required=true,
     *         description="Class ID",
     *         @OA\Schema(type="string", example="1")
     *     ),
     *     @OA\Parameter(
     *         name="clsa",
     *         in="path",
     *         required=true,
     *         description="Class Arm ID",
     *         @OA\Schema(type="string", example="2")
     *     ),
     *     @OA\Parameter(
     *         name="ssn",
     *         in="path",
     *         required=true,
     *         description="Session",
     *         @OA\Schema(type="string", example="2023")
     *     ),
     *     @OA\Response(
     *         response=200,
     *         description="Success",
     *         @OA\JsonContent(
     *             type="array",
     *             @OA\Items(
     *                 @OA\Property(property="com", type="string", example="Good performance"),
     *                 @OA\Property(property="schid", type="string", example="SCH123"),
     *                 @OA\Property(property="class_id", type="string", example="1"),
     *                 @OA\Property(property="class_name", type="string", example="JSS 2"),
     *                 @OA\Property(property="class_arm_id", type="string", example="2"),
     *                 @OA\Property(property="class_arm_name", type="string", example="Blue")
     *             )
     *         )
     *     ),
     *     @OA\Response(
     *         response=404,
     *         description="Not Found",
     *         @OA\JsonContent(
     *             @OA\Property(property="message", type="string", example="No records found")
     *         )
     *     )
     * )
     */

    public function getAllComment($schid, $clsm, $clsa, $ssn)
    {
        // Get all matching result records, now including sid
        $records = cummulative_comment::where('schid', $schid)
            ->where('clsm', $clsm)
            ->where('clsa', $clsa)
            ->where('ssn', $ssn)
            ->select('sid', 'comm', 'clsm', 'clsa', 'schid')
            ->get();

        if ($records->isEmpty()) {
            return response()->json(['message' => 'No records found'], 404);
        }

        // Get class name once
        $className = cls::where('id', $clsm)->value('name');

        // Get class arm name once
        $classArmName = sch_cls::where('id', $clsa)
            ->where('schid', $schid)
            ->value('name');

        // Add class name and arm name to each result
        $results = $records->map(function ($record) use ($className, $classArmName) {
            return [
                'sid' => $record->sid,
                'com' => $record->comm,
                'schid' => $record->schid,
                'class_id' => $record->clsm,
                'class_name' => $className,
                'class_arm_id' => $record->clsa,
                'class_arm_name' => $classArmName,
            ];
        });

        return response()->json($results);
    }



    /**
     * @OA\Post(
     *     path="/api/storeComment",
     *     summary="Create or update a cumulative comment",
     *     tags={"Api"},
     *     security={{"bearerAuth":{}}},
     *     operationId="storeComment",
     *     @OA\RequestBody(
     *         required=true,
     *         @OA\JsonContent(
     *             required={"uid", "sid", "schid", "clsm", "clsa", "ssn", "comm"},
     *             @OA\Property(property="uid", type="string", example="UID12345"),
     *             @OA\Property(property="sid", type="string", example="565"),
     *             @OA\Property(property="schid", type="string", example="12"),
     *             @OA\Property(property="clsm", type="string", example="11"),
     *             @OA\Property(property="clsa", type="string", example="1"),
     *             @OA\Property(property="ssn", type="string", example="2025"),
     *             @OA\Property(property="comm", type="string", example="Excellent performance this term."),
     *         )
     *     ),
     *     @OA\Response(
     *         response=200,
     *         description="Cumulative comment saved successfully.",
     *         @OA\JsonContent(
     *             @OA\Property(property="status", type="boolean", example=true),
     *             @OA\Property(property="message", type="string", example="Cumulative comment saved successfully."),
     *             @OA\Property(
     *                 property="pld",
     *                 type="object",
     *                 @OA\Property(property="uid", type="string", example="UID12345"),
     *                 @OA\Property(property="sid", type="string", example="565"),
     *                 @OA\Property(property="schid", type="string", example="12"),
     *                 @OA\Property(property="clsm", type="string", example="11"),
     *                 @OA\Property(property="clsa", type="string", example="1"),
     *                 @OA\Property(property="ssn", type="string", example="2025"),
     *                 @OA\Property(property="comm", type="string", example="Excellent performance this term."),
     *                 @OA\Property(property="created_at", type="string", format="date-time"),
     *                 @OA\Property(property="updated_at", type="string", format="date-time"),
     *             )
     *         )
     *     ),
     *     @OA\Response(
     *         response=422,
     *         description="Validation error"
     *     )
     * )
     */



    public function storeComment(Request $request)
    {
        $validated = $request->validate([
            'uid' => 'required|string',
            'sid' => 'required|string',
            'schid' => 'required|string',
            'clsm' => 'required|string',
            'clsa' => 'required|string',
            'ssn' => 'required|string',
            'comm' => 'required|string',
        ]);

        $comment = cummulative_comment::updateOrCreate(
            ['uid' => $validated['uid']], // Match by primary key
            [
                'sid' => $validated['sid'],
                'schid' => $validated['schid'],
                'clsm' => $validated['clsm'],
                'clsa' => $validated['clsa'],
                'ssn' => $validated['ssn'],
                'comm' => $validated['comm'],
            ]
        );

        return response()->json([
            'status' => true,
            'message' => 'Cumulative comment saved successfully.',
            'pld' => $comment
        ]);
    }




    /**
     * @OA\Get(
     *     path="/api/getStudentScoreSummary",
     *     summary="Get a summary of student scores and class positions for a term",
     *     tags={"Api"},
     *     security={{"bearerAuth":{}}},
     *     @OA\Parameter(
     *         name="schid",
     *         in="query",
     *         required=true,
     *         description="School ID",
     *         @OA\Schema(type="integer", example=12)
     *     ),
     *     @OA\Parameter(
     *         name="ssn",
     *         in="query",
     *         required=true,
     *         description="Session (e.g., 2024)",
     *         @OA\Schema(type="integer", example=2024)
     *     ),
     *     @OA\Parameter(
     *         name="trm",
     *         in="query",
     *         required=true,
     *         description="Term number (1, 2, or 3)",
     *         @OA\Schema(type="integer", example=1)
     *     ),
     *     @OA\Parameter(
     *         name="clsm",
     *         in="query",
     *         required=true,
     *         description="Class ID",
     *         @OA\Schema(type="integer", example=11)
     *     ),
     *     @OA\Parameter(
     *         name="clsa",
     *         in="query",
     *         required=true,
     *         description="Class arm ID or -1 to include all arms",
     *         @OA\Schema(type="string", example="-1")
     *     ),
     *     @OA\Response(
     *         response=200,
     *         description="Student score summary retrieved successfully",
     *         @OA\JsonContent(
     *             @OA\Property(property="status", type="boolean", example=true),
     *             @OA\Property(property="message", type="string", example="Student Score Summary"),
     *             @OA\Property(
     *                 property="data",
     *                 type="array",
     *                 @OA\Items(
     *                     @OA\Property(property="uid", type="string", example="a1b2c3d4"),
     *                     @OA\Property(property="sid", type="integer", example=563),
     *                     @OA\Property(property="learner_id", type="string", example="AB78999"),
     *                     @OA\Property(property="name", type="string", example="John Doe"),
     *                     @OA\Property(property="avg_score", type="number", format="float", example=58.75),
     *                     @OA\Property(property="class", type="integer", example=11),
     *                     @OA\Property(property="no_of_subjects", type="integer", example=5),
     *                     @OA\Property(
     *                         property="scores",
     *                         type="object",
     *                         description="Each subject name maps to an array of scores",
     *                         @OA\AdditionalProperties(
     *                             @OA\Schema(
     *                                 type="array",
     *                                 @OA\Items(type="integer", example=45)
     *                             )
     *                         )
     *                     ),
     *                     @OA\Property(property="clsid", type="integer", example=11),
     *                     @OA\Property(property="clsa", type="string", example="2"),
     *                     @OA\Property(property="ssn", type="integer", example=2024),
     *                     @OA\Property(property="trm", type="integer", example=1),
     *                     @OA\Property(property="position", type="integer", example=1)
     *                 )
     *             )
     *         )
     *     ),
     *     @OA\Response(
     *         response=400,
     *         description="Bad request due to invalid or missing parameters"
     *     )
     * )
     */


    public function getStudentScoreSummary(Request $request)
    {
        $schid = $request->schid;
        $ssn = $request->ssn;
        $trm = $request->trm;
        $clsm = $request->clsm;
        $clsa = $request->clsa;

        // Get class name and class arm name
        $className = cls::where('id', $clsm)->value('name') ?? "CLS-$clsm";

        $classArmName = $clsa !== '-1'
            ? sch_cls::where('schid', $schid)
                ->where('cls_id', $clsm)
                ->where('id', $clsa)
                ->value('name') ?? 'N/A'
            : 'All Arms';

        //  Get all active students for this session + term + class (+ arm if specified)
        $students = old_student::where("schid", $schid)
            ->where("status", "active")
            ->where("ssn", $ssn)
            ->where("trm", $trm)   // filter by term to avoid duplicates
            ->where("clsm", $clsm)
            ->when($clsa !== '-1', fn($q) => $q->where("clsa", $clsa))
            ->get();

        $scoreSheet = [];

        foreach ($students as $student) {
            $stid = $student->sid;

            // Get the student's subjects
            $subjects = student_subj::where("stid", $stid)->pluck("sbj")->toArray();

            $grouped = [];
            $totalScore = 0;
            $subjectCount = 0;

            foreach ($subjects as $sbjId) {
                // Get all scores with assessment info for this subject
                $scores = std_score::where("stid", $stid)
                    ->where("sbj", $sbjId)
                    ->where("schid", $schid)
                    ->where("ssn", $ssn)
                    ->where("trm", $trm)
                    ->where("clsid", $clsm)
                    ->get();

                if ($scores->isNotEmpty()) {
                    $grouped[$sbjId] = [];

                    foreach ($scores as $score) {
                        $markName = sch_mark::where('id', $score->aid)
                            ->where('schid', $schid)
                            ->where('clsid', $clsm)
                            ->where('ssn', $ssn)
                            ->where('trm', $trm)
                            ->value('name') ?? 'Unknown';

                        $grouped[$sbjId][] = [
                            'assessment' => $markName,
                            'score' => $score->scr,
                        ];

                        $totalScore += $score->scr;
                    }

                    $subjectCount++;
                }
            }

            // Average = totalScore / number of subjects with scores
            $avg = $subjectCount ? round($totalScore / $subjectCount, 2) : 0;

            // Format scores with subject names
            $formattedScores = [];
            foreach ($grouped as $sbjid => $scrArray) {
                $subjectName = subj::find($sbjid)?->name ?? "Subject-$sbjid";
                $formattedScores[] = [
                    'subject_id' => $sbjid,
                    'subject_name' => $subjectName,
                    'scores' => $scrArray // array of [assessment, score]
                ];
            }

            $scoreSheet[] = [
                'uid' => $student->uid,
                'schid' => $student->schid,
                'sid' => $stid,
                'learner_id' => $student->suid ?? $stid,
                'name' => trim($student->fname . ' ' . $student->lname),
                'avg_score' => $avg,
                'class' => $clsm,
                'class_name' => $className,
                'class_arm_name' => $classArmName,
                'no_of_subjects' => $subjectCount,
                'scores' => $formattedScores,
                'clsid' => $clsm,
                'clsa' => $student->clsa,
                'ssn' => $ssn,
                'trm' => $trm,
                'position' => 0 // placeholder, assigned below
            ];
        }

        //  Rank students by avg_score
        usort($scoreSheet, fn($a, $b) => $b['avg_score'] <=> $a['avg_score']);

        $rank = 1;
        $lastAvg = null;
        $tieCount = 0;

        foreach ($scoreSheet as $index => &$std) {
            if ($std['avg_score'] === $lastAvg) {
                $tieCount++;
            } else {
                $rank += $tieCount;
                $tieCount = 1;
            }
            $std['position'] = $rank;
            $lastAvg = $std['avg_score'];
        }

        return response()->json([
            'status' => true,
            'message' => 'Student Score Summary',
            'data' => $scoreSheet
        ]);
    }





    /**
     * @OA\Post(
     *     path="/api/autoCommentTemplate",
     *     summary="Save or update auto comments by grade for a specific role (Principal, Head Teacher, School Admin)",
     *     tags={"Api"},
     *     security={{"bearerAuth":{}}},
     *     @OA\RequestBody(
     *         required=true,
     *         @OA\JsonContent(
     *             required={"schid", "ssn", "trm", "clsm", "clsa", "role", "comment"},
     *             @OA\Property(property="schid", type="string", example="12"),
     *             @OA\Property(property="ssn", type="string", example="2024"),
     *             @OA\Property(property="trm", type="string", example="1"),
     *             @OA\Property(property="clsm", type="string", example="11"),
     *             @OA\Property(property="clsa", type="string", example="2"),
     *             @OA\Property(
     *                 property="role",
     *                 type="string",
     *                 enum={"Principal", "Head Teacher", "School Admin"},
     *                 example="Principal"
     *             ),
     *             @OA\Property(
     *                 property="comment",
     *                 type="array",
     *                 @OA\Items(
     *                     type="object",
     *                     required={"grade", "comment"},
     *                     @OA\Property(
     *                         property="grade",
     *                         type="string",
     *                         enum={"A","B","C","D","E","F"},
     *                         example="A"
     *                     ),
     *                     @OA\Property(
     *                         property="comment",
     *                         type="string",
     *                         example="Excellent performance"
     *                     )
     *                 )
     *             )
     *         )
     *     ),
     *     @OA\Response(
     *         response=200,
     *         description="Auto comments saved successfully.",
     *         @OA\JsonContent(
     *             @OA\Property(property="status", type="boolean", example=true),
     *             @OA\Property(property="message", type="string", example="Auto comments saved."),
     *             @OA\Property(property="role", type="string", example="Principal"),
     *             @OA\Property(
     *                 property="pld",
     *                 type="array",
     *                 @OA\Items(
     *                     @OA\Property(property="grade", type="string", example="A"),
     *                     @OA\Property(property="comment", type="string", example="Excellent performance")
     *                 )
     *             )
     *         )
     *     ),
     *     @OA\Response(
     *         response=422,
     *         description="Validation error",
     *         @OA\JsonContent(
     *             @OA\Property(property="message", type="string", example="The given data was invalid."),
     *             @OA\Property(
     *                 property="errors",
     *                 type="object",
     *                 example={
     *                     "role": {"The selected role is invalid."}
     *                 }
     *             )
     *         )
     *     )
     * )
     */


    public function autoCommentTemplate(Request $request)
    {
        $validated = $request->validate([
            'schid' => 'required',
            'ssn' => 'required',
            'trm' => 'required',
            'clsm' => 'required',
            'clsa' => 'required',
            'role' => 'required|string|in:Principal,Head Teacher,School Admin',
            'comment' => 'required|array',
            'comment.*.grade' => 'required|string|in:A,B,C,D,E,F',
            'comment.*.comment' => 'nullable|string|max:500',

        ]);

        foreach ($validated['comment'] as $entry) {
            auto_comment_template::updateOrCreate(
                [
                    'schid' => $validated['schid'],
                    'ssn' => $validated['ssn'],
                    'trm' => $validated['trm'],
                    'clsm' => $validated['clsm'],
                    'clsa' => $validated['clsa'],
                    'role' => $validated['role'],
                    'grade' => $entry['grade'],
                ],
                [
                    'comment' => $entry['comment'] ?? ''  // use empty string instead of null
                ]
            );
        }

        // Build response for all 6 grades
        $grades = ['A', 'B', 'C', 'D', 'E', 'F'];
        $response = [];

        foreach ($grades as $grade) {
            $comment = auto_comment_template::where([
                'schid' => $validated['schid'],
                'ssn' => $validated['ssn'],
                'trm' => $validated['trm'],
                'clsm' => $validated['clsm'],
                'clsa' => $validated['clsa'],
                'role' => $validated['role'],
                'grade' => $grade,
            ])->value('comment') ?? '';

            $response[] = [
                'grade' => $grade,
                'comment' => $comment
            ];
        }

        return response()->json([
            'status' => true,
            'message' => 'Auto comments saved.',
            'role' => $validated['role'],
            'pld' => $response
        ]);
    }



    /**
     * @OA\Get(
     *     path="/api/autoCommentTemplate",
     *     summary="Fetch auto comment templates for all grades (AF) for a specific role",
     *     tags={"Api"},
     *     security={{"bearerAuth":{}}},
     *
     *     @OA\Parameter(
     *         name="schid",
     *         in="query",
     *         required=true,
     *         description="School ID",
     *         @OA\Schema(type="string", example="12")
     *     ),
     *     @OA\Parameter(
     *         name="ssn",
     *         in="query",
     *         required=true,
     *         description="Session",
     *         @OA\Schema(type="string", example="2024")
     *     ),
     *     @OA\Parameter(
     *         name="trm",
     *         in="query",
     *         required=true,
     *         description="Term",
     *         @OA\Schema(type="string", example="1")
     *     ),
     *     @OA\Parameter(
     *         name="clsm",
     *         in="query",
     *         required=true,
     *         description="Class main",
     *         @OA\Schema(type="string", example="11")
     *     ),
     *     @OA\Parameter(
     *         name="clsa",
     *         in="query",
     *         required=true,
     *         description="Class arm",
     *         @OA\Schema(type="string", example="2")
     *     ),
     *     @OA\Parameter(
     *         name="role",
     *         in="query",
     *         required=true,
     *         description="Role type",
     *         @OA\Schema(
     *             type="string",
     *             enum={"Principal", "Head Teacher", "School Admin"},
     *             example="Principal"
     *         )
     *     ),
     *
     *     @OA\Response(
     *         response=200,
     *         description="Auto comments fetched successfully.",
     *         @OA\JsonContent(
     *             @OA\Property(property="status", type="boolean", example=true),
     *             @OA\Property(property="message", type="string", example="Auto comments fetched successfully."),
     *             @OA\Property(property="role", type="string", example="Principal"),
     *             @OA\Property(
     *                 property="pld",
     *                 type="array",
     *                 @OA\Items(
     *                     @OA\Property(property="grade", type="string", example="A"),
     *                     @OA\Property(property="comment", type="string", example="Excellent performance")
     *                 )
     *             )
     *         )
     *     ),
     *
     *     @OA\Response(
     *         response=422,
     *         description="Validation error",
     *         @OA\JsonContent(
     *             @OA\Property(property="message", type="string", example="The given data was invalid."),
     *             @OA\Property(
     *                 property="errors",
     *                 type="object",
     *                 example={
     *                     "role": {"The selected role is invalid."},
     *                     "schid": {"The schid field is required."}
     *                 }
     *             )
     *         )
     *     )
     * )
     */

    public function getAutoCommentTemplate(Request $request)
    {
        // Validate GET inputs
        $validated = $request->validate([
            'schid' => 'required|string',
            'ssn' => 'required|string',
            'trm' => 'required|string',
            'clsm' => 'required|string',
            'clsa' => 'required|string',
            'role' => 'required|string|in:Principal,Head Teacher,School Admin',
        ]);

        $grades = ['A', 'B', 'C', 'D', 'E', 'F'];
        $response = [];

        foreach ($grades as $grade) {
            $comment = auto_comment_template::where([
                'schid' => $validated['schid'],
                'ssn' => $validated['ssn'],
                'trm' => $validated['trm'],
                'clsm' => $validated['clsm'],
                'clsa' => $validated['clsa'],
                'role' => $validated['role'],
                'grade' => $grade,
            ])->value('comment') ?? '';

            $response[] = [
                'grade' => $grade,
                'comment' => $comment
            ];
        }

        return response()->json([
            'status' => true,
            'message' => 'Auto comments fetched successfully.',
            'role' => $validated['role'],
            'pld' => $response
        ]);
    }



    /**
     * @OA\Get(
     *     path="/api/filterCommentByRole",
     *     summary="Get auto-comments filtered by role",
     *     tags={"Api"},
     *     security={{"bearerAuth":{}}},
     *     @OA\Parameter(
     *         name="role",
     *         in="query",
     *         required=true,
     *         description="Role ID to filter auto-comments (e.g. 1, 2, 3)",
     *         @OA\Schema(type="string", example="2")
     *     ),
     *     @OA\Response(
     *         response=200,
     *         description="Auto comments returned successfully",
     *         @OA\JsonContent(
     *             @OA\Property(property="status", type="boolean", example=true),
     *             @OA\Property(property="message", type="string", example="Auto comments filtered by role."),
     *             @OA\Property(property="role_name", type="string", example="Principal"),
     *             @OA\Property(property="data", type="array", @OA\Items(
     *                 @OA\Property(property="id", type="integer", example=4),
     *                 @OA\Property(property="schid", type="string", example="12"),
     *                 @OA\Property(property="ssn", type="string", example="2024"),
     *                 @OA\Property(property="trm", type="string", example="2"),
     *                 @OA\Property(property="clsm", type="string", example="11"),
     *                 @OA\Property(property="clsa", type="string", example="2"),
     *                 @OA\Property(property="role", type="string", example="2"),
     *                 @OA\Property(property="grade", type="string", example="A"),
     *                 @OA\Property(property="comment", type="string", example="Excellent performance"),
     *                 @OA\Property(property="created_at", type="string", format="date-time", example="2025-07-15T18:09:48"),
     *                 @OA\Property(property="updated_at", type="string", format="date-time", example="2025-07-15T18:09:48")
     *             ))
     *         )
     *     ),
     *     @OA\Response(
     *         response=422,
     *         description="Validation error",
     *         @OA\JsonContent(
     *             @OA\Property(property="message", type="string", example="The role field is required.")
     *         )
     *     )
     * )
     */

    public function filterCommentByRole(Request $request)
    {
        $request->validate([
            'role' => 'required|string',
        ]);

        $comments = auto_comment_template::where('role', $request->role)
            ->orderBy('grade')
            ->get();

        $roleName = staff_role::where('id', $request->role)->value('name') ?? 'Unknown Role';

        return response()->json([
            'status' => true,
            'message' => 'Auto comments filtered by role.',
            'role_name' => $roleName,
            'pld' => $comments
        ]);
    }






    /**
     * @OA\Post(
     *     path="/api/allStudentResultsComment",
     *     summary="Generate and save student result comments using manual or auto-comment templates",
     *     description="This endpoint auto-generates comments based on average grade and selected role (Principal, Head Teacher, School Admin). Manual comments take priority if they exist.",
     *     tags={"Api"},
     *     security={{"bearerAuth":{}}},
     *     @OA\RequestBody(
     *         required=true,
     *         @OA\JsonContent(
     *             required={"schid", "ssn", "trm", "clsm", "clsa", "role"},
     *             @OA\Property(property="schid", type="string", example="12"),
     *             @OA\Property(property="ssn", type="string", example="2024"),
     *             @OA\Property(property="trm", type="string", example="1"),
     *             @OA\Property(property="clsm", type="string", example="11"),
     *             @OA\Property(property="clsa", type="string", example="2"),
     *             @OA\Property(property="role", type="string", enum={"Principal", "Head Teacher", "School Admin"}, example="Principal")
     *         )
     *     ),
     *     @OA\Response(
     *         response=200,
     *         description="All student results saved with auto-comments.",
     *         @OA\JsonContent(
     *             @OA\Property(property="status", type="boolean", example=true),
     *             @OA\Property(property="message", type="string", example="All student results saved with auto-comments."),
     *             @OA\Property(
     *                 property="pld",
     *                 type="array",
     *                 @OA\Items(
     *                     @OA\Property(property="uid", type="integer", example=101),
     *                     @OA\Property(property="stid", type="integer", example=1001),
     *                     @OA\Property(property="name", type="string", example="John Doe"),
     *                     @OA\Property(property="avg", type="number", format="float", example=87.5),
     *                     @OA\Property(property="grade", type="string", example="A"),
     *                     @OA\Property(property="comment", type="string", example="Excellent performance"),
     *                     @OA\Property(property="position", type="integer", example=1),
     *                     @OA\Property(property="manual_comment_used", type="boolean", example=false)
     *                 )
     *             )
     *         )
     *     ),
     *     @OA\Response(
     *         response=422,
     *         description="Validation error",
     *         @OA\JsonContent(
     *             @OA\Property(property="message", type="string", example="The given data was invalid."),
     *             @OA\Property(
     *                 property="errors",
     *                 type="object",
     *                 example={
     *                     "schid": {"The schid field is required."}
     *                 }
     *             )
     *         )
     *     )
     * )
     */



    public function allStudentResultsComment(Request $request)
    {
        $request->validate([
            'schid' => 'required|string',
            'ssn' => 'required|string',
            'trm' => 'required|string',
            'clsm' => 'required|string',
            'clsa' => 'required|string',
            'role' => 'required|string|in:Principal,Head Teacher,School Admin',
        ]);

        // Get score summary for the selected class
        $students = $this->getStudentScoreSummary($request)->getData(true)['data'];

        $updatedResults = [];

        foreach ($students as $std) {
            $avg = $std['avg_score'];

            // Get grade from dynamic sch_grade table
            $grade = $this->gradeFromAvg($avg, $std['schid'], $std['clsid'], $std['ssn'], $std['trm']);

            // Check for manually entered comment
            $existing = student_res::where([
                'stid' => $std['sid'],
                'schid' => $std['schid'],
                'ssn' => $std['ssn'],
                'trm' => $std['trm'],
                'clsm' => $std['clsid'],
                'clsa' => $std['clsa'],
            ])->first();

            $manualComment = $existing?->com;
            if ($manualComment === 'NIL~NIL' || $manualComment === null) {
                $manualComment = '';
            }

            // Auto comment from configured template
            $autoComment = auto_comment_template::where([
                'schid' => $std['schid'],
                'ssn' => $std['ssn'],
                'trm' => $std['trm'],
                'clsm' => $std['clsid'],
                'clsa' => $std['clsa'],
                'role' => $request->role,
                'grade' => $grade,
            ])->value('comment') ?? 'No comment configured for this grade.';

            // Use manual if exists, else fallback to auto
            $finalComment = !empty($manualComment) ? $manualComment : $autoComment;

            // Save or update the result
            $result = student_res::updateOrCreate(
                ['uid' => $std['uid']],
                [
                    'stid' => $std['sid'],
                    'schid' => $std['schid'],
                    'ssn' => $std['ssn'],
                    'trm' => $std['trm'],
                    'clsm' => $std['clsid'],
                    'clsa' => $std['clsa'],
                    'stat' => '1',
                    'com' => $finalComment,
                    'pos' => $std['position'],
                    'avg' => $avg,
                    'cavg' => $existing?->cavg ?? 0,
                ]
            );

            $updatedResults[] = [
                'uid' => $result->uid,
                'stid' => $result->stid,
                'name' => $std['name'],
                'avg' => $avg,
                'grade' => $grade,
                'comment' => $finalComment,
                'position' => $std['position'],
                'manual_comment_used' => !empty($manualComment),
            ];
        }

        return response()->json([
            'status' => true,
            'message' => 'All student results saved with auto-comments.',
            'pld' => $updatedResults
        ]);
    }

    private function gradeFromAvg($avg, $schid, $clsm, $ssn, $trm)
    {
        $grades = sch_grade::where('schid', $schid)
            ->where('clsid', $clsm)
            ->where('ssn', $ssn)
            ->where('trm', $trm)
            ->orderByDesc('g0') // From highest to lowest
            ->get();

        foreach ($grades as $grade) {
            if ($avg >= $grade->g0 && $avg <= $grade->g1) {
                return $grade->grd;
            }
        }

        return 'N/A'; // If no grade matched..
    }




    /**
     * @OA\Get(
     *     path="/api/getSubjectsByClass/{classId}",
     *     summary="Get subjects by class ID",
     *     description="Returns a list of subjects for a given class.",
     *     operationId="getSubjectsByClass",
     *     tags={"Api"},
     *     security={{"bearerAuth":{}}},
     *
     *     @OA\Parameter(
     *         name="classId",
     *         in="path",
     *         required=true,
     *         description="ID of the class",
     *         @OA\Schema(type="integer")
     *     ),
     *
     *     @OA\Response(
     *         response=200,
     *         description="Successful response",
     *         @OA\JsonContent(
     *             @OA\Property(property="cls", type="integer", example=11),
     *             @OA\Property(
     *                 property="sub",
     *                 type="array",
     *                 @OA\Items(
     *                     type="object",
     *                     @OA\Property(property="subj_id", type="string", example="98"),
     *                     @OA\Property(property="name", type="string", example="FRENCH")
     *                 )
     *             )
     *         )
     *     ),
     *
     *     @OA\Response(
     *         response=404,
     *         description="Class not found"
     *     )
     * )
     */
    public function getSubjectsByClass($classId)
    {
        $subjects = class_subj::where('clsid', $classId)
            ->select('subj_id', 'name')
            ->distinct()
            ->get();

        return response()->json([
            'cls' => $classId,
            'sub' => $subjects
        ]);
    }


    /**
     * @OA\Post(
     *     path="/api/promoteStudent",
     *     summary="Promote a student to the next class",
     *     description="Creates a new promotion record for the student. Previous records remain unchanged.",
     *     operationId="promoteStudent",
     *     tags={"Api"},
     *     security={{"bearerAuth":{}}},
     *     @OA\RequestBody(
     *         required=true,
     *         @OA\JsonContent(
     *             required={"sid","schid","sesn","trm","clsm","clsa"},
     *             @OA\Property(property="sid", type="integer", example=1000, description="Student ID"),
     *             @OA\Property(property="schid", type="integer", example=13, description="School ID"),
     *             @OA\Property(property="sesn", type="string", example="2025", description="Academic session"),
     *             @OA\Property(property="trm", type="integer", example=1, description="Term number"),
     *             @OA\Property(property="clsm", type="integer", example=12, description="Main class ID"),
     *             @OA\Property(property="clsa", type="string", example="1", description="Class arm/section"),
     *             @OA\Property(property="suid", type="string", example="HRS/2025/1/68", description="Student unique ID")
     *         )
     *     ),
     *     @OA\Response(
     *         response=200,
     *         description="Student promoted successfully",
     *         @OA\JsonContent(
     *             @OA\Property(property="status", type="boolean", example=true),
     *             @OA\Property(property="message", type="string", example="Student promoted successfully")
     *         )
     *     ),
     *     @OA\Response(
     *         response=422,
     *         description="Validation error",
     *         @OA\JsonContent(
     *             @OA\Property(property="message", type="string", example="The sid field is required."),
     *             @OA\Property(property="errors", type="object")
     *         )
     *     )
     * )
     */



    public function promoteStudent(Request $request)
    {
        $request->validate([
            'sid' => 'required',
            'schid' => 'required',
            'sesn' => 'required',  // session
            'trm' => 'required',  // term
            'clsm' => 'required',  // new main class
            'clsa' => 'required',  // requested new class arm (sch_cls.id)
            'suid' => 'required',  // student unique id
        ]);

        // 1. Find the student
        $student = student::where('sid', $request->sid)->firstOrFail();

        // 2. Make sure this arm belongs to the new class
        $validArm = DB::table('sch_cls')
            ->where('id', $request->clsa)
            ->where('cls_id', $request->clsm)   // ensure arm belongs to this class
            ->where('schid', $request->schid)
            ->first();

        if (!$validArm) {
            return response()->json([
                'status' => false,
                'message' => 'Invalid class arm for the selected class',
            ], 422);
        }

        // 3. Check if already promoted for this session + term
        $alreadyPromoted = old_student::where('sid', $request->sid)
            ->where('schid', $request->schid)
            ->where('ssn', $request->sesn)
            ->where('trm', $request->trm)
            ->where('clsm', $request->clsm)
            ->where('clsa', $request->clsa)
            ->first();

        if ($alreadyPromoted) {
            return response()->json([
                'status' => false,
                'message' => 'This student has already been promoted for the selected session and term',
            ], 409); // conflict
        }

        // 4. Generate deterministic UID (no random numbers)
        $uid = $request->sesn . $request->trm . $request->sid . $request->clsm;

        // 5. Create promotion record
        $promotion = old_student::updateOrCreate(
            [
                'sid' => $request->sid,
                'schid' => $request->schid,
                'ssn' => $request->sesn,
                'trm' => $request->trm,
                'clsm' => $request->clsm,
                'clsa' => $request->clsa,
            ],
            [
                'uid' => $uid,
                'fname' => $student->fname,
                'mname' => $student->mname,
                'lname' => $student->lname,
                'status' => 'active',
                'suid' => $request->suid,
                'more' => '',
            ]
        );

        // 6. Update student_academic_data table
        student_academic_data::where('user_id', $request->sid)
            ->update([
                'new_class_main' => $request->clsm,
                'new_class' => $validArm->id,
            ]);

        return response()->json([
            'status' => true,
            'message' => 'Student promoted successfully for this term',
            'data' => [
                'sid' => $promotion->sid,
                'suid' => $promotion->suid,
                'ssn' => $promotion->ssn,
                'trm' => $promotion->trm,
                'clsm' => $promotion->clsm,
                'clsa' => $promotion->clsa,
                'clsa_name' => $validArm->name,   // arm name
            ],
        ]);
    }



    /**
     * @OA\Post(
     *     path="/api/exitStudent/{schid}/{stid}",
     *     summary="Exit a student and move them to alumni",
     *     description="Marks a student as inactive and moves them to the alumni database if they are not already present.",
     *     operationId="exitStudent",
     *     tags={"Api"},
     *     security={{"bearerAuth": {}}},
     *     @OA\Parameter(
     *         name="schid",
     *         in="path",
     *         required=true,
     *         description="The school ID",
     *         @OA\Schema(type="integer")
     *     ),
     *     @OA\Parameter(
     *         name="stid",
     *         in="path",
     *         required=true,
     *         description="The student ID",
     *         @OA\Schema(type="integer")
     *     ),
     *     @OA\RequestBody(
     *         required=true,
     *         @OA\JsonContent(
     *             required={"reason_for_exit"},
     *             @OA\Property(property="reason_for_exit", type="string", example="Graduated")
     *         )
     *     ),
     *     @OA\Response(
     *         response=200,
     *         description="Student successfully exited and moved to alumni",
     *         @OA\JsonContent(
     *             @OA\Property(property="status", type="boolean", example=true),
     *             @OA\Property(property="message", type="string", example="Student has been exited successfully and moved to alumni.")
     *         )
     *     ),
     *     @OA\Response(
     *         response=400,
     *         description="Student has already been moved to alumni",
     *         @OA\JsonContent(
     *             @OA\Property(property="status", type="boolean", example=false),
     *             @OA\Property(property="message", type="string", example="Student has already been moved to alumni.")
     *         )
     *     ),
     *     @OA\Response(
     *         response=404,
     *         description="Student not found",
     *         @OA\JsonContent(
     *             @OA\Property(property="status", type="boolean", example=false),
     *             @OA\Property(property="message", type="string", example="Student not found.")
     *         )
     *     )
     * )
     */

    public function exitStudent(Request $request, $schid, $stid)
    {
        $request->validate([
            'reason_for_exit' => 'required|string|max:555',
        ]);

        $student = student::where('schid', $schid)->where('sid', $stid)->first();

        if (!$student) {
            return response()->json([
                'status' => false,
                'message' => 'Student not found.',
            ], 404);
        }

        if (alumni::where('stid', $stid)->where('schid', $schid)->exists()) {
            return response()->json([
                'status' => false,
                'message' => 'Student has already been moved to alumni.',
            ], 400);
        }

        // Retrieve term_of_entry from school table
        $school = school::where('sid', $schid)->first();
        $termOfEntry = null;

        if ($school) {
            $termOfEntry = trm::where('no', $school->ctrm)->value('name'); // Get term name
        }

        // Generate the `suid`
        $ssn = $student->year;
        $term = $student->term;
        $count = $student->count;
        $suid = $student->sch3 . '/' . $ssn . '/' . $term . '/' . strval($count);

        // Fetch class details
        $oldStudent = old_student::where('schid', $schid)->where('sid', $stid)->first();
        $exitClassId = $oldStudent ? $oldStudent->clsm : null;
        $exitClassArmId = $oldStudent ? $oldStudent->clsa : null;

        $classDetails = sch_cls::where('cls_id', $exitClassId)
            ->where('schid', $schid)
            ->first();

        $exitClass = $classDetails ? $classDetails->cls_id : null;
        $exitClassArm = $classDetails ? $classDetails->name : null;

        $className = cls::where('id', $exitClass)->value('name');

        // Fetch session and term names
        $sessionOfEntry = sesn::where('year', $student->year)->value('name'); // Get session name
        $sessionOfExit = sesn::where('year', now()->year)->value('name'); // Get current session name
        $termOfExit = trm::where('no', $student->term)->value('name'); // Same term as entry

        DB::beginTransaction();

        try {
            $student->update([
                'status' => 'inactive',
                'exit_status' => 'exited'
            ]);

            if (DB::table('old_student')->where('schid', $schid)->where('sid', $stid)->exists()) {
                DB::table('old_student')
                    ->where('schid', $schid)
                    ->where('sid', $stid)
                    ->update(['status' => 'inactive']);
            }

            $student->refresh();

            if ($student->status === 'inactive') {
                alumni::create([
                    'stid' => $student->sid,
                    'schid' => $student->schid,
                    'suid' => $suid,
                    'lname' => $student->lname,
                    'fname' => $student->fname,
                    'mname' => $student->mname,
                    'sch3' => $student->sch3,
                    'count' => strval($count),
                    'session_of_entry' => $sessionOfEntry, // Actual session name
                    'term_of_entry' => $termOfEntry, // Fetched from school table
                    'date_of_entry' => $student->created_at->toDateString(),
                    'session_of_exit' => $sessionOfExit, // Actual session name
                    'term_of_exit' => $termOfExit, // Actual term name
                    'date_of_exit' => now()->toDateString(),
                    'reason_for_exit' => $request->input('reason_for_exit'),
                    'exit_class' => $className,
                    'exit_class_arm' => $exitClassArm,
                ]);
            }

            DB::commit();

            return response()->json([
                'status' => true,
                'message' => 'Student has been exited successfully and moved to alumni.',
            ], 200);
        } catch (\Exception $e) {
            DB::rollBack();

            return response()->json([
                'status' => false,
                'message' => 'Failed to exit student. Please try again.',
                'error' => $e->getMessage()
            ], 500);
        }
    }


    /**
     * @OA\Post(
     *     path="/api/repeatStudent",
     *     summary="Mark a student to repeat the same class",
     *     description="Creates a new record for a student to repeat their current class/arm in a new session/term. Previous records remain unchanged.",
     *     operationId="repeatStudent",
     *     tags={"Api"},
     *     security={{"bearerAuth": {}}},
     *     @OA\RequestBody(
     *         required=true,
     *         @OA\JsonContent(
     *             required={"sid","schid","sesn","trm","clsm","clsa","suid"},
     *             @OA\Property(property="sid", type="integer", example=1000, description="Student ID"),
     *             @OA\Property(property="schid", type="integer", example=13, description="School ID"),
     *             @OA\Property(property="sesn", type="string", example="2025", description="Academic session"),
     *             @OA\Property(property="trm", type="integer", example=1, description="Term number"),
     *             @OA\Property(property="clsm", type="integer", example=12, description="Main class ID"),
     *             @OA\Property(property="clsa", type="string", example="1", description="Class arm/section"),
     *             @OA\Property(property="suid", type="string", example="HRS/2025/1/68", description="Student unique ID")
     *         )
     *     ),
     *     @OA\Response(
     *         response=200,
     *         description="Student marked to repeat successfully",
     *         @OA\JsonContent(
     *             @OA\Property(property="status", type="boolean", example=true),
     *             @OA\Property(property="message", type="string", example="Student marked to repeat successfully")
     *         )
     *     ),
     *     @OA\Response(
     *         response=422,
     *         description="Validation error",
     *         @OA\JsonContent(
     *             @OA\Property(property="message", type="string", example="The sid field is required."),
     *             @OA\Property(property="errors", type="object")
     *         )
     *     )
     * )
     */


    public function repeatStudent(Request $request)
    {
        $request->validate([
            'sid' => 'required',
            'schid' => 'required',
            'sesn' => 'required',
            'trm' => 'required',
            'clsm' => 'required', // main class
            'clsa' => 'required', // class arm
            'suid' => 'required|string'
        ]);

        // Find the student
        $student = student::where('sid', $request->sid)->firstOrFail();

        // Generate deterministic UID (no random numbers)
        $uid = $request->sesn . $request->trm . $request->sid . $request->clsm;

        // Create a new old_student record for repeating
        old_student::create([
            'uid' => $uid,
            'sid' => $request->sid,
            'schid' => $request->schid,
            'fname' => $student->fname,
            'mname' => $student->mname,
            'lname' => $student->lname,
            'status' => 'active',
            'suid' => $request->suid,
            'ssn' => $request->sesn,
            'trm' => $request->trm,
            'clsm' => $request->clsm,
            'clsa' => $request->clsa,
            'more' => '', // mark as repeat
        ]);

        return response()->json([
            'status' => true,
            'message' => 'Student marked to repeat successfully',
        ]);
    }




    /**
     * @OA\Post(
     *     path="/api/setSubjStaff",
     *     summary="Assign subject to a staff",
     *     description="This endpoint assigns a subject to a staff member. A unique UID is auto-generated for each record.",
     *     tags={"Api"},
     *     security={{"bearerAuth": {}}},
     *
     *     @OA\RequestBody(
     *         required=true,
     *         @OA\JsonContent(
     *             required={"stid","sbj","schid","sesn","trm"},
     *             @OA\Property(property="stid", type="integer", example=1929, description="Staff ID"),
     *             @OA\Property(property="sbj", type="integer", example=15, description="Subject ID"),
     *             @OA\Property(property="schid", type="integer", example=12, description="School ID"),
     *             @OA\Property(property="sesn", type="integer", example=2024, description="Academic session"),
     *             @OA\Property(property="trm", type="integer", example=1, description="Academic term (1, 2, or 3)")
     *         )
     *     ),
     *
     *     @OA\Response(
     *         response=200,
     *         description="Subject successfully assigned to staff",
     *         @OA\JsonContent(
     *             @OA\Property(property="status", type="boolean", example=true),
     *             @OA\Property(property="message", type="string", example="Subject Successfully Assigned to Staff"),
     *             @OA\Property(property="pld", type="object",
     *                 @OA\Property(property="uid", type="string", example="20241192912345"),
     *                 @OA\Property(property="stid", type="integer", example=1929),
     *                 @OA\Property(property="sbj", type="integer", example=15),
     *                 @OA\Property(property="schid", type="integer", example=12),
     *                 @OA\Property(property="sesn", type="integer", example=2024),
     *                 @OA\Property(property="trm", type="integer", example=1)
     *             )
     *         )
     *     ),
     *
     *     @OA\Response(
     *         response=422,
     *         description="Validation error - Missing required fields"
     *     )
     * )
     */
    public function setSubjStaff(Request $request)
    {
        // Data validation
        $request->validate([
            "stid" => "required",
            "sbj" => "required",
            "schid" => "required",
            "sesn" => "required",
            "trm" => "required",
        ]);

        // Generate deterministic UID (no random numbers)
        $uid = $request->sesn . $request->trm . $request->stid . $request->sbj;

        // Update or create based on UID only
        $pld = subject_dest::updateOrCreate(
            ["uid" => $uid],
            [
                "stid" => $request->stid,
                "sbj" => $request->sbj,
                "schid" => $request->schid,
                "sesn" => $request->sesn,
                "trm" => $request->trm,
            ]
        );

        return response()->json([
            "status" => true,
            "message" => "Subject Successfully Assigned to Staff",
            "pld" => $pld
        ]);
    }





    /**
     * @OA\Get(
     *     path="/api/getSubjStaff/{schid}/{stid}/{sesn}/{trm}",
     *     summary="Get subjects assigned to a staff",
     *     description="Fetches subjects assigned to a staff for a specific session and term. Supports pagination using `start` and `count` query parameters.",
     *     tags={"Api"},
     *     security={{"bearerAuth": {}}},
     *
     *       @OA\Parameter(
     *         name="schid",
     *         in="path",
     *         required=true,
     *         description="Sch ID",
     *         @OA\Schema(type="integer", example=12)
     *     ),
     *
     *     @OA\Parameter(
     *         name="stid",
     *         in="path",
     *         required=true,
     *         description="Staff ID",
     *         @OA\Schema(type="integer", example=1929)
     *     ),
     *     @OA\Parameter(
     *         name="sesn",
     *         in="path",
     *         required=true,
     *         description="Academic session",
     *         @OA\Schema(type="integer", example=2024)
     *     ),
     *     @OA\Parameter(
     *         name="trm",
     *         in="path",
     *         required=true,
     *         description="Academic term (1, 2, or 3)",
     *         @OA\Schema(type="integer", example=1)
     *     ),
     *     @OA\Parameter(
     *         name="start",
     *         in="query",
     *         required=false,
     *         description="Pagination start index (default: 0)",
     *         @OA\Schema(type="integer", example=0)
     *     ),
     *     @OA\Parameter(
     *         name="count",
     *         in="query",
     *         required=false,
     *         description="Number of records to fetch (default: 20)",
     *         @OA\Schema(type="integer", example=20)
     *     ),
     *
     *     @OA\Response(
     *         response=200,
     *         description="Subjects successfully retrieved",
     *         @OA\JsonContent(
     *             @OA\Property(property="status", type="boolean", example=true),
     *             @OA\Property(property="message", type="string", example="Success"),
     *             @OA\Property(property="pld", type="array",
     *                 @OA\Items(
     *                     @OA\Property(property="uid", type="string", example="20241192912345"),
     *                     @OA\Property(property="stid", type="integer", example=1929),
     *                     @OA\Property(property="sbj", type="integer", example=15),
     *                     @OA\Property(property="schid", type="integer", example=12),
     *                     @OA\Property(property="sesn", type="integer", example=2024),
     *                     @OA\Property(property="trm", type="integer", example=1)
     *                 )
     *             )
     *         )
     *     )
     * )
     */
    public function getSubjStaff($schid, $stid, $sesn, $trm)
    {
        $start = request()->input('start', 0);   // default 0
        $count = request()->input('count', 20);  // default 20

        $pld = subject_dest::where("stid", $stid)
            ->where("schid", $schid)
            ->where("sesn", $sesn)
            ->where("trm", $trm)
            ->skip($start)
            ->take($count)
            ->get();

        return response()->json([
            "status" => true,
            "message" => "Success",
            "pld" => $pld,
        ]);
    }




    /**
     * @OA\Post(
     *     path="/api/assignSubjectStaff",
     *     summary="Assign subject to a staff",
     *     description="This endpoint assigns a subject to a staff member. A unique UID is auto-generated for each record.",
     *     tags={"Api"},
     *     security={{"bearerAuth": {}}},
     *
     *     @OA\RequestBody(
     *         required=true,
     *         @OA\JsonContent(
     *             required={"stid","sbj","schid","sesn","trm"},
     *             @OA\Property(property="stid", type="integer", example=1929, description="Staff ID"),
     *             @OA\Property(property="sbj", type="integer", example=15, description="Subject ID"),
     *             @OA\Property(property="schid", type="integer", example=12, description="School ID"),
     *             @OA\Property(property="sesn", type="integer", example=2024, description="Academic session"),
     *             @OA\Property(property="trm", type="integer", example=1, description="Academic term (1, 2, or 3)")
     *         )
     *     ),
     *
     *     @OA\Response(
     *         response=200,
     *         description="Subject successfully assigned to staff",
     *         @OA\JsonContent(
     *             @OA\Property(property="status", type="boolean", example=true),
     *             @OA\Property(property="message", type="string", example="Subject Successfully Assigned to Staff"),
     *             @OA\Property(property="pld", type="object",
     *                 @OA\Property(property="uid", type="string", example="20241192912345"),
     *                 @OA\Property(property="stid", type="integer", example=1929),
     *                 @OA\Property(property="sbj", type="integer", example=15),
     *                 @OA\Property(property="schid", type="integer", example=12),
     *                 @OA\Property(property="sesn", type="integer", example=2024),
     *                 @OA\Property(property="trm", type="integer", example=1)
     *             )
     *         )
     *     ),
     *
     *     @OA\Response(
     *         response=422,
     *         description="Validation error - Missing required fields"
     *     )
     * )
     */
    public function assignSubjectStaff(Request $request)
    {
        // Data validation
        $request->validate([
            "stid" => "required",
            "sbj" => "required",
            "schid" => "required",
            "sesn" => "required",
            "trm" => "required",
        ]);

        // Generate deterministic UID (no random numbers)
        $uid = $request->sesn . $request->trm . $request->stid . $request->sbj;

        // Update or create based on UID only
        $pld = staff_subj::updateOrCreate(
            ["uid" => $uid],
            [
                "stid" => $request->stid,
                "sbj" => $request->sbj,
                "schid" => $request->schid,
                "sesn" => $request->sesn,
                "trm" => $request->trm,
            ]
        );

        return response()->json([
            "status" => true,
            "message" => "Subject Successfully Assigned to Staff",
            "pld" => $pld
        ]);
    }



    /**
     * @OA\Post(
     *     path="/api/setRepostStaff",
     *     tags={"Api"},
     *     security={{"bearerAuth": {}}},
     *     summary="Create or update old staff info",
     *     description="This endpoint creates or updates old staff information. Uniqueness is enforced using the `uid` field only.",
     *     @OA\RequestBody(
     *         required=true,
     *         @OA\JsonContent(
     *             required={"sid","schid","fname","mname","lname","suid","ssn","trm","clsm","role","role2","more"},
     *             @OA\Property(property="sid", type="string", example="12345"),
     *             @OA\Property(property="schid", type="string", example="6789"),
     *             @OA\Property(property="fname", type="string", example="John"),
     *             @OA\Property(property="mname", type="string", example="Michael"),
     *             @OA\Property(property="lname", type="string", example="Doe"),
     *             @OA\Property(property="suid", type="string", example="STF001"),
     *             @OA\Property(property="ssn", type="string", example="2024"),
     *             @OA\Property(property="trm", type="string", example="1"),
     *             @OA\Property(property="clsm", type="string", example="SS2A"),
     *             @OA\Property(property="role", type="string", example="Class Teacher"),
     *             @OA\Property(property="role2", type="string", example="Exam Officer"),
     *             @OA\Property(property="more", type="string", example="Additional notes or duties"),
     *         )
     *     ),
     *     @OA\Response(
     *         response=200,
     *         description="Old staff info successfully created or updated",
     *         @OA\JsonContent(
     *             @OA\Property(property="status", type="boolean", example=true),
     *             @OA\Property(property="message", type="string", example="Info Updated"),
     *             @OA\Property(
     *                 property="pld",
     *                 type="object",
     *                 description="The created/updated staff record",
     *                 @OA\Property(property="uid", type="string", example="202411234512345"),
     *                 @OA\Property(property="sid", type="string", example="12345"),
     *                 @OA\Property(property="schid", type="string", example="6789"),
     *                 @OA\Property(property="fname", type="string", example="John"),
     *                 @OA\Property(property="mname", type="string", example="Michael"),
     *                 @OA\Property(property="lname", type="string", example="Doe"),
     *                 @OA\Property(property="suid", type="string", example="STF001"),
     *                 @OA\Property(property="ssn", type="string", example="2024"),
     *                 @OA\Property(property="trm", type="string", example="1"),
     *                 @OA\Property(property="clsm", type="string", example="SS2A"),
     *                 @OA\Property(property="role", type="string", example="Class Teacher"),
     *                 @OA\Property(property="role2", type="string", example="Exam Officer"),
     *                 @OA\Property(property="more", type="string", example="Additional notes or duties"),
     *             )
     *         )
     *     ),
     *     @OA\Response(
     *         response=422,
     *         description="Validation error",
     *         @OA\JsonContent(
     *             @OA\Property(property="message", type="string", example="The given data was invalid."),
     *             @OA\Property(property="errors", type="object")
     *         )
     *     )
     * )
     */


    public function setRepostStaff(Request $request)
    {
        // Data validation
        $request->validate([
            "sid" => "required",
            "schid" => "required",
            "fname" => "required",
            "mname" => "required",
            "lname" => "required",
            "suid" => "required",
            "ssn" => "required",
            "trm" => "required",
            "clsm" => "required",
            "role" => "required",
            "role2" => "required",
            "more" => "required",
        ]);

        // Generate deterministic UID (no random numbers)
        $uid = $request->ssn . $request->trm . $request->sid . $request->clsm;

        // Update or create record based only on uid
        $pld = old_staff::updateOrCreate(
            ["uid" => $uid],
            [
                "sid" => $request->sid,
                "schid" => $request->schid,
                "fname" => $request->fname,
                "mname" => $request->mname,
                "lname" => $request->lname,
                "suid" => $request->suid,
                "ssn" => $request->ssn,
                "trm" => $request->trm,
                "clsm" => $request->clsm,
                "role" => $request->role,
                "role2" => $request->role2,
                "more" => $request->more,
            ]
        );

        return response()->json([
            "status" => true,
            "message" => "Info Updated",
            "pld" => $pld
        ]);
    }




    /**
     * @OA\Get(
     *     path="/api/getClassArms/{schid}/{cls_id}",
     *     summary="Get all class arms for a specific school and class",
     *     description="Fetch all class arms (id, name, cls_id, schid) based on school ID and class ID",
     *     operationId="getClassArms",
     *     tags={"Api"},
     *     security={{"bearerAuth": {}}},
     *     @OA\Parameter(
     *         name="schid",
     *         in="path",
     *         description="School ID",
     *         required=true,
     *         @OA\Schema(type="integer", example=12)
     *     ),
     *     @OA\Parameter(
     *         name="cls_id",
     *         in="path",
     *         description="Class ID",
     *         required=true,
     *         @OA\Schema(type="integer", example=12)
     *     ),
     *     @OA\Response(
     *         response=200,
     *         description="Successful response",
     *         @OA\JsonContent(
     *             type="object",
     *             @OA\Property(property="status", type="boolean", example=true),
     *             @OA\Property(property="message", type="string", example="Class arms fetched successfully"),
     *             @OA\Property(
     *                 property="pld",
     *                 type="array",
     *                 @OA\Items(
     *                     type="object",
     *                     @OA\Property(property="id", type="integer", example=3),
     *                     @OA\Property(property="name", type="string", example="A"),
     *                     @OA\Property(property="cls_id", type="integer", example=12),
     *                     @OA\Property(property="schid", type="integer", example=12)
     *                 )
     *             )
     *         )
     *     ),
     *     @OA\Response(
     *         response=422,
     *         description="Validation error or bad request"
     *     )
     * )
     */
    public function getClassArms($schid, $cls_id)
    {
        $arms = DB::table('sch_cls')
            ->select('id', 'name', 'cls_id', 'schid')
            ->where('schid', $schid)
            ->where('cls_id', $cls_id)
            ->get();

        return response()->json([
            'status' => true,
            'message' => 'Class arms fetched successfully',
            'pld' => $arms,
        ]);
    }





    /**
     * @OA\Post(
     *     path="/api/rePromoteStudent",
     *     summary="Promote or re-promote a student to a new class",
     *     description="Promotes a student to a new class and updates their academic record.
     *                  A student can only be re-promoted if there are no scores for the given
     *                  session, term, and class.",
     *     tags={"Api"},
     *     security={{"bearerAuth": {}}},
     *
     *     @OA\RequestBody(
     *         required=true,
     *         @OA\JsonContent(
     *             required={"sid","schid","sesn","trm","clsm","clsa","suid"},
     *             @OA\Property(property="sid", type="integer", example=1001, description="Student ID"),
     *             @OA\Property(property="schid", type="integer", example=12, description="School ID"),
     *             @OA\Property(property="sesn", type="string", example="2024", description="Academic session"),
     *             @OA\Property(property="trm", type="integer", example=1, description="Term number"),
     *             @OA\Property(property="clsm", type="integer", example=11, description="New main class ID"),
     *             @OA\Property(property="clsa", type="integer", example=5, description="New class arm ID"),
     *             @OA\Property(property="suid", type="string", example="STU2024001", description="Student unique identifier")
     *         )
     *     ),
     *
     *     @OA\Response(
     *         response=200,
     *         description="Student promoted successfully",
     *         @OA\JsonContent(
     *             @OA\Property(property="status", type="boolean", example=true),
     *             @OA\Property(property="message", type="string", example="Student promoted successfully for this term"),
     *             @OA\Property(property="data", type="object",
     *                 @OA\Property(property="sid", type="integer", example=1001),
     *                 @OA\Property(property="suid", type="string", example="STU2024001"),
     *                 @OA\Property(property="ssn", type="string", example="2024"),
     *                 @OA\Property(property="trm", type="integer", example=1),
     *                 @OA\Property(property="clsm", type="integer", example=11),
     *                 @OA\Property(property="clsa", type="integer", example=5),
     *                 @OA\Property(property="clsa_name", type="string", example="Science A")
     *             )
     *         )
     *     ),
     *
     *     @OA\Response(
     *         response=422,
     *         description="Invalid request or re-promotion blocked",
     *         @OA\JsonContent(
     *             @OA\Property(property="status", type="boolean", example=false),
     *             @OA\Property(property="message", type="string", example="Cannot re-promote student: scores/results already exist for this class, session, and term.")
     *         )
     *     )
     * )
     */

    // public function rePromoteStudent(Request $request)
    // {
    //     $request->validate([
    //         'sid' => 'required',
    //         'schid' => 'required',
    //         'sesn' => 'required',  // session
    //         'trm' => 'required',  // term
    //         'clsm' => 'required',  // new main class
    //         'clsa' => 'required',  // requested new class arm (sch_cls.id)
    //         'suid' => 'required',  // student unique id
    //     ]);

    //     $student = student::where('sid', $request->sid)->firstOrFail();

    //     $validArm = DB::table('sch_cls')
    //         ->where('id', $request->clsa)
    //         ->where('cls_id', $request->clsm)
    //         ->where('schid', $request->schid)
    //         ->first();

    //     if (!$validArm) {
    //         return response()->json([
    //             'status' => false,
    //             'message' => 'Invalid class arm for the selected class',
    //         ], 422);
    //     }

    //     $hasScores = std_score::where('stid', $request->sid)
    //         ->where('ssn', $request->sesn)
    //         ->where('trm', $request->trm)
    //         ->where('clsid', $request->clsm)
    //         ->exists();

    //     if ($hasScores) {
    //         return response()->json([
    //             'status' => false,
    //             'message' => 'Cannot re-promote student: scores/results already exist for this class, session, and term.',
    //         ], 422);
    //     }

    //     // Deterministic UID (no random numbers)
    //     $uid = $request->sesn . $request->trm . $request->sid . $request->clsm;

    //     old_student::where('sid', $request->sid)
    //         ->where('ssn', $request->sesn)
    //         ->where('trm', $request->trm)
    //         ->where(function ($q) use ($request) {
    //             $q->where('clsm', '!=', $request->clsm)
    //                 ->orWhere('clsa', '!=', $request->clsa);
    //         })
    //         ->delete();

    //     $promotion = old_student::updateOrCreate(
    //         [
    //             'sid' => $request->sid,
    //             'ssn' => $request->sesn,
    //             'trm' => $request->trm,
    //         ],
    //         [
    //             'uid' => $uid,
    //             'schid' => $request->schid,
    //             'fname' => $student->fname,
    //             'mname' => $student->mname,
    //             'lname' => $student->lname,
    //             'status' => 'active',
    //             'suid' => $request->suid,
    //             'clsm' => $request->clsm,
    //             'clsa' => $validArm->id,
    //             'more' => '',
    //         ]
    //     );

    //     student_academic_data::where('user_id', $request->sid)
    //         ->update([
    //             'new_class_main' => $request->clsm,
    //             'new_class' => $validArm->id,
    //         ]);

    //     return response()->json([
    //         'status' => true,
    //         'message' => 'Student re-promoted successfully for this term',
    //         'data' => [
    //             'sid' => $promotion->sid,
    //             'suid' => $promotion->suid,
    //             'ssn' => $promotion->ssn,
    //             'trm' => $promotion->trm,
    //             'clsm' => $promotion->clsm,
    //             'clsa' => $promotion->clsa,
    //             'clsa_name' => $validArm->name,
    //         ],
    //     ]);
    // }

    public function rePromoteStudent(Request $request)
    {
        $request->validate([
            'sid' => 'required',
            'schid' => 'required',
            'sesn' => 'required',
            'trm' => 'required',
            'clsm' => 'required',
            'clsa' => 'required',
            'suid' => 'required',
        ]);

        $student = student::where('sid', $request->sid)->firstOrFail();

        $validArm = DB::table('sch_cls')
            ->where('id', $request->clsa)
            ->where('cls_id', $request->clsm)
            ->where('schid', $request->schid)
            ->first();

        if (!$validArm) {
            return response()->json([
                'status' => false,
                'message' => 'Invalid class arm for the selected class',
            ], 422);
        }

        $hasScores = std_score::where('stid', $request->sid)
            ->where('ssn', $request->sesn)
            ->where('trm', $request->trm)
            ->where('clsid', $request->clsm)
            ->exists();

        // if ($hasScores) {
        //     return response()->json([
        //         'status' => false,
        //         'message' => 'Cannot re-promote student: scores/results already exist for this class, session, and term.',
        //     ], 422);
        // }

        $uid = $request->sesn . $request->trm . $request->sid . $request->clsm;

        //  FIXED DELETE LOGIC
        old_student::where('sid', $request->sid)
            ->where('ssn', $request->sesn)
            ->where('trm', $request->trm)
            ->where(function ($q) use ($request) {
                $q->where('clsm', '!=', $request->clsm)
                    ->where('clsa', '!=', $request->clsa);
            })
            ->delete();

        $promotion = old_student::updateOrCreate(
            [
                'sid' => $request->sid,
                'schid' => $request->schid,
                'ssn' => $request->sesn,
                'trm' => $request->trm,
            ],
            [
                'uid' => $uid,
                'fname' => $student->fname,
                'mname' => $student->mname,
                'lname' => $student->lname,
                'status' => 'active',
                'suid' => $request->suid,
                'clsm' => $request->clsm,
                'clsa' => $validArm->id,
                'more' => '',
            ]
        );

        student_academic_data::where('user_id', $request->sid)
            ->update([
                'new_class_main' => $request->clsm,
                'new_class' => $validArm->id,
            ]);

        return response()->json([
            'status' => true,
            'message' => 'Student re-promoted successfully for this term',
            'data' => [
                'sid' => $promotion->sid,
                'suid' => $promotion->suid,
                'ssn' => $promotion->ssn,
                'trm' => $promotion->trm,
                'clsm' => $promotion->clsm,
                'clsa' => $promotion->clsa,
                'clsa_name' => $validArm->name,
            ],
        ]);
    }



    /**
     * @OA\Post(
     *     path="/api/resetPass",
     *     tags={"Api"},
     *     summary="Reset user password (Admin or School only)",
     *     description="Allows an Admin (`typ=a`) or School (`typ=s`) to reset the password of a Student (`typ=z`) or Staff (`typ=w`).",
     *     security={{"bearerAuth":{}}},
     *
     *     @OA\RequestBody(
     *         required=true,
     *         @OA\JsonContent(
     *             required={"user_id","new_password","new_password_confirmation"},
     *             @OA\Property(property="user_id", type="integer", example=123, description="ID of the user whose password is to be reset"),
     *             @OA\Property(property="new_password", type="string", format="password", example="secret123"),
     *             @OA\Property(property="new_password_confirmation", type="string", format="password", example="secret123")
     *         )
     *     ),
     *
     *     @OA\Response(
     *         response=200,
     *         description="Password reset successfully",
     *         @OA\JsonContent(
     *             @OA\Property(property="status", type="boolean", example=true),
     *             @OA\Property(property="message", type="string", example="Password reset successfully for student@example.com")
     *         )
     *     ),
     *
     *     @OA\Response(
     *         response=400,
     *         description="Invalid target user (not Student or Staff)",
     *         @OA\JsonContent(
     *             @OA\Property(property="status", type="boolean", example=false),
     *             @OA\Property(property="message", type="string", example="Only Student or Staff accounts can be reset.")
     *         )
     *     ),
     *
     *     @OA\Response(
     *         response=403,
     *         description="Unauthorized (if caller is not Admin or School)",
     *         @OA\JsonContent(
     *             @OA\Property(property="status", type="boolean", example=false),
     *             @OA\Property(property="message", type="string", example="Unauthorized. Only Admin or School can reset passwords.")
     *         )
     *     ),
     *
     *     @OA\Response(
     *         response=422,
     *         description="Validation error",
     *         @OA\JsonContent(
     *             @OA\Property(property="message", type="string", example="The given data was invalid."),
     *             @OA\Property(property="errors", type="object")
     *         )
     *     )
     * )
     */


    public function resetPass(Request $request)
    {
        $request->validate([
            'user_id' => 'required|exists:users,id',
            'new_password' => 'required|min:6|confirmed',
        ]);

        $actor = auth()->user();

        Log::info('Reset password for user_id: ' . $actor);


        $targetUser = User::find($request->user_id);

        if (!$targetUser) {
            return response()->json([
                'status' => false,
                'message' => 'User not found.'
            ], 404);
        }

        // Only Student or Staff passwords can be reset
        if (!in_array($targetUser->typ, ['z', 'w'])) {
            return response()->json([
                'status' => false,
                'message' => 'Only Student or Staff accounts can be reset.',
            ], 400);
        }

        $targetUser->password = bcrypt($request->new_password);
        $targetUser->save();

        return response()->json([
            'status' => true,
            'message' => "Password reset successfully for",
        ]);
    }






    /**
     * @OA\Get(
     *     path="/api/getSchoolCounts",
     *     tags={"Admin"},
     *     security={{"bearerAuth":{}}},
     *     summary="Get school counts by category",
     *     description="Retrieve the total number of schools, the number of secondary schools, and the number of nursery/primary schools.",
     *
     *     @OA\Response(
     *         response=200,
     *         description="Successful response",
     *         @OA\JsonContent(
     *             type="object",
     *             @OA\Property(property="status", type="boolean", example=true),
     *             @OA\Property(
     *                 property="pld",
     *                 type="object",
     *                 @OA\Property(property="total_schools", type="integer", example=120),
     *                 @OA\Property(property="secondary_schools", type="integer", example=80),
     *                 @OA\Property(property="nursery_schools", type="integer", example=40)
     *             )
     *         )
     *     ),
     *     @OA\Response(response=401, description="Unauthorized"),
     * )
     */

    public function getSchoolCounts()
    {
        // List of secondary classes
        $secondaryClasses = [
            'JSS 1',
            'JSS 2',
            'JSS 3',
            'SSS 1',
            'SSS 2',
            'SSS 3',
            'BASIC 7',
            'BASIC 8',
            'BASIC 9',
            'YEAR 7',
            'YEAR 8',
            'YEAR 9',
            'YEAR 10',
            'YEAR 11',
            'YEAR 12',
            'JSS 3 PR',
            'SSS 2 PW',
            'SSS 3 MOCK',
            'TAHFEEZ UPPER CLASS'
        ];

        // List of nursery/primary classes
        $nurseryClasses = [
            'Kg',
            'NUR 1',
            'NUR 2',
            'NUR 3',
            'PRI 1',
            'PRI 2',
            'PRI 3',
            'PRI 4',
            'PRI 5',
            'PRI 6',
            'BASIC 1',
            'BASIC 2',
            'BASIC 3',
            'BASIC 4',
            'BASIC 5',
            'BASIC 6',
            'PRE-BASIC',
            'PRE-PRIMARY',
            'CRECHE',
            'PRE-NURSERY',
            'SPECIAL PRE-NURSERY',
            'NURSERY 1',
            'NURSERY 2',
            'NURSERY 3 / PRE-PRIMARY',
            'ECCD 1',
            'ECCD 2',
            'PRIMARY 1',
            'PRIMARY 2',
            'PRIMARY 3',
            'PRIMARY 4',
            'PRIMARY 5',
            'PRIMARY 6',
            'YEAR 1',
            'YEAR 2',
            'YEAR 3',
            'YEAR 4',
            'YEAR 5',
            'YEAR 6',
            'TAHFEEZ LOWER CLASS'
        ];

        // Get IDs of secondary classes
        $secondaryClsIds = cls::whereIn('name', $secondaryClasses)->pluck('id');

        // Get IDs of nursery/primary classes
        $nurseryClsIds = cls::whereIn('name', $nurseryClasses)->pluck('id');

        // Get all schools
        $allSchoolIds = school_class::distinct()->pluck('schid');

        $secondarySchools = 0;
        $nurserySchools = 0;

        foreach ($allSchoolIds as $schid) {
            // If school has at least one secondary class  count it
            $hasSecondary = school_class::where('schid', $schid)
                ->whereIn('clsid', $secondaryClsIds)
                ->exists();

            if ($hasSecondary) {
                $secondarySchools++;
            }

            // If school has at least one nursery/primary class  count it
            $hasNursery = school_class::where('schid', $schid)
                ->whereIn('clsid', $nurseryClsIds)
                ->exists();

            if ($hasNursery) {
                $nurserySchools++;
            }
        }

        $totalSchools = $secondarySchools + $nurserySchools;

        return response()->json([
            'status' => true,
            'pld' => [
                'total_schools' => $totalSchools,
                'secondary_schools' => $secondarySchools,
                'nursery_schools' => $nurserySchools,
            ]
        ]);
    }




    /**
     * @OA\Get(
     *     path="/api/getActiveLearnersByGender",
     *     summary="Get total active learners grouped by gender",
     *     tags={"Admin"},
     *     security={{"bearerAuth":{}}},
     *     @OA\Response(
     *         response=200,
     *         description="Successful response",
     *         @OA\JsonContent(
     *             type="object",
     *             @OA\Property(property="status", type="boolean", example=true),
     *             @OA\Property(
     *                 property="pld",
     *                 type="object",
     *                 @OA\Property(property="total_active", type="integer", example=5000),
     *                 @OA\Property(property="male", type="integer", example=2400),
     *                 @OA\Property(property="female", type="integer", example=2600)
     *             )
     *         )
     *     )
     * )
     */

    public function getActiveLearnersByGender()
    {
        $query = DB::table('old_student as os')
            ->join('student_basic_data as sb', 'os.sid', '=', 'sb.user_id')
            ->where('os.status', 'active')
            ->select(
                DB::raw("COUNT(DISTINCT os.sid) as total_active"),
                DB::raw("COUNT(DISTINCT CASE WHEN sb.sex = 'M' THEN os.sid END) as male"),
                DB::raw("COUNT(DISTINCT CASE WHEN sb.sex = 'F' THEN os.sid END) as female")
            )
            ->first();

        return response()->json([
            'status' => true,
            'pld' => [
                'total_active' => (int) $query->total_active,
                'male' => (int) $query->male,
                'female' => (int) $query->female,
            ]
        ]);
    }





    /**
     * @OA\Get(
     *     path="/api/getAlumniByGender",
     *     summary="Get total alumni count by gender",
     *     tags={"Admin"},
     *     security={{"bearerAuth":{}}},
     *     @OA\Response(
     *         response=200,
     *         description="Successful response",
     *         @OA\JsonContent(
     *             type="object",
     *             @OA\Property(property="status", type="boolean", example=true),
     *             @OA\Property(
     *                 property="pld",
     *                 type="object",
     *                 @OA\Property(property="total_alumni", type="integer", example=198),
     *                 @OA\Property(property="male", type="integer", example=110),
     *                 @OA\Property(property="female", type="integer", example=88)
     *             )
     *         )
     *     )
     * )
     */
    public function getAlumniByGender()
    {
        $query = DB::table('alumnis as a')
            ->join('student_basic_data as sb', 'a.stid', '=', 'sb.user_id')
            ->selectRaw('COUNT(*) as total_alumni')
            ->selectRaw("SUM(CASE WHEN sb.sex = 'M' THEN 1 ELSE 0 END) as male")
            ->selectRaw("SUM(CASE WHEN sb.sex = 'F' THEN 1 ELSE 0 END) as female")
            ->first();

        return response()->json([
            'status' => true,
            'pld' => [
                'total_alumni' => (int) $query->total_alumni,
                'male' => (int) $query->male,
                'female' => (int) $query->female,
            ]
        ]);
    }



    /**
     * @OA\Get(
     *     path="/api/getActiveStaffByGender",
     *     summary="Get total active staff count by gender",
     *     tags={"Admin"},
     *     security={{"bearerAuth":{}}},
     *     @OA\Response(
     *         response=200,
     *         description="Successful response",
     *         @OA\JsonContent(
     *             type="object",
     *             @OA\Property(property="status", type="boolean", example=true),
     *             @OA\Property(
     *                 property="pld",
     *                 type="object",
     *                 @OA\Property(property="total_active_staff", type="integer", example=356),
     *                 @OA\Property(property="male", type="integer", example=200),
     *                 @OA\Property(property="female", type="integer", example=156)
     *             )
     *         )
     *     )
     * )
     */


    public function getActiveStaffByGender()
    {
        $query = DB::table('old_staff as os')
            ->join('staff_basic_data as sb', 'os.sid', '=', 'sb.user_id')
            ->where('os.status', 'active')
            ->select(
                DB::raw("COUNT(DISTINCT os.sid) as total_active_staff"),
                DB::raw("COUNT(DISTINCT CASE WHEN sb.sex = 'M' THEN os.sid END) as male"),
                DB::raw("COUNT(DISTINCT CASE WHEN sb.sex = 'F' THEN os.sid END) as female")
            )
            ->first();

        return response()->json([
            'status' => true,
            'pld' => [
                'total_active_staff' => (int) $query->total_active_staff,
                'male' => (int) $query->male,
                'female' => (int) $query->female,
            ]
        ]);
    }





    /**
     * @OA\Get(
     *     path="/api/getAllSchoolsInfo",
     *     summary="Get all schools information",
     *     description="Retrieve a paginated list of schools with optional filters by state and LGA. Includes active learners, staff, alumni, and class information.",
     *     operationId="getAllSchoolsInfo",
     *     tags={"Admin"},
     *      security={{"bearerAuth": {}}},
     *
     *     @OA\Parameter(
     *         name="start",
     *         in="query",
     *         description="Starting record offset for pagination",
     *         required=false,
     *         @OA\Schema(type="integer", example=0)
     *     ),
     *     @OA\Parameter(
     *         name="count",
     *         in="query",
     *         description="Number of records to retrieve per page",
     *         required=false,
     *         @OA\Schema(type="integer", example=20)
     *     ),
     *     @OA\Parameter(
     *         name="state",
     *         in="query",
     *         description="Filter schools by state name",
     *         required=false,
     *         @OA\Schema(type="string", example="Lagos")
     *     ),
     *     @OA\Parameter(
     *         name="lga",
     *         in="query",
     *         description="Filter schools by Local Government Area (LGA)",
     *         required=false,
     *         @OA\Schema(type="string", example="Ikeja")
     *     ),
     *
     *     @OA\Response(
     *         response=200,
     *         description="Successful response",
     *         @OA\JsonContent(
     *             type="object",
     *             @OA\Property(property="status", type="boolean", example=true),
     *             @OA\Property(property="message", type="string", example="Success"),
     *             @OA\Property(
     *                 property="pld",
     *                 type="array",
     *                 @OA\Items(
     *                     type="object",
     *                     @OA\Property(
     *                         property="s",
     *                         type="object",
     *                         @OA\Property(property="sid", type="integer", example=101),
     *                         @OA\Property(property="school_id", type="string", example="SCH/0101"),
     *                         @OA\Property(property="name", type="string", example="Queens College"),
     *                         @OA\Property(property="count", type="integer", example=250),
     *                         @OA\Property(property="s_web", type="string", example="queenscollege.edu.ng"),
     *                         @OA\Property(property="s_info", type="string", example="A top Lagos secondary school"),
     *                         @OA\Property(property="sbd", type="string", example="Public"),
     *                         @OA\Property(property="sch3", type="string", example="QC"),
     *                         @OA\Property(property="cssn", type="string", example="2020QC001"),
     *                         @OA\Property(property="ctrm", type="string", example="10"),
     *                         @OA\Property(property="ctrmn", type="string", example="25"),
     *                         @OA\Property(property="state", type="string", example="Lagos"),
     *                         @OA\Property(property="lga", type="string", example="Ikeja"),
     *                         @OA\Property(property="lattitude", type="string", example="6.6018"),
     *                         @OA\Property(property="longitude", type="string", example="3.3515"),
     *                         @OA\Property(property="created_at", type="string", format="date-time", example="2025-10-06T12:00:00Z"),
     *                         @OA\Property(property="updated_at", type="string", format="date-time", example="2025-10-06T12:30:00Z"),
     *                         @OA\Property(property="active_learners", type="integer", example=350),
     *                         @OA\Property(property="alumni", type="integer", example=220),
     *                         @OA\Property(property="active_staff", type="integer", example=45),
     *                         @OA\Property(
     *                             property="classes",
     *                             type="object",
     *                             example={"1": {"JSS1A", "JSS1B"}, "2": {"JSS2A"}},
     *                             description="Grouped class arms by class ID"
     *                         ),
     *                         @OA\Property(property="total_classes", type="integer", example=12)
     *                     )
     *                 )
     *             )
     *         )
     *     ),
     *
     *     @OA\Response(
     *         response=400,
     *         description="Bad Request",
     *         @OA\JsonContent(
     *             type="object",
     *             @OA\Property(property="status", type="boolean", example=false),
     *             @OA\Property(property="message", type="string", example="Invalid input or parameters")
     *         )
     *     )
     * )
     */


    public function getAllSchoolsInfo(Request $request)
    {
        $start = $request->input('start', 0);
        $count = $request->input('count', 20);
        $state = $request->input('state');
        $lga = $request->input('lga');

        //  Base query with optional filters
        $query = DB::table('school as s')
            ->leftJoin('school_web_data as sw', 's.sid', '=', 'sw.user_id')
            ->select('s.*', 'sw.state as web_state', 'sw.lga as web_lga', 'sw.country as web_country');

        if (!empty($state)) {
            $query->where('sw.state', $state);
        }

        if (!empty($lga)) {
            $query->where('sw.lga', $lga);
        }

        //  Get total records before pagination
        $totalRecords = $query->count();

        //  Apply pagination
        $schools = $query->orderBy('s.name', 'asc')
            ->skip($start)
            ->take($count)
            ->get();

        if ($schools->isEmpty()) {
            return response()->json([
                "status" => true,
                "message" => "No schools found",
                "total_records" => 0,
                "pld" => [],
            ]);
        }

        //  Collect all school IDs for bulk queries
        $schoolIds = $schools->pluck('sid')->toArray();

        //  Bulk fetch active learners
        $learners = DB::table('old_student')
            ->whereIn('schid', $schoolIds)
            ->where('status', 'active')
            ->select('schid', DB::raw('COUNT(DISTINCT sid) as active_learners'))
            ->groupBy('schid')
            ->pluck('active_learners', 'schid');

        //  Bulk fetch alumni counts
        $alumni = DB::table('alumnis')
            ->whereIn('schid', $schoolIds)
            ->select('schid', DB::raw('COUNT(*) as alumni_count'))
            ->groupBy('schid')
            ->pluck('alumni_count', 'schid');

        //  Bulk fetch active staff
        $staff = DB::table('old_staff')
            ->whereIn('schid', $schoolIds)
            ->where('status', 'active')
            ->select('schid', DB::raw('COUNT(DISTINCT sid) as active_staff'))
            ->groupBy('schid')
            ->pluck('active_staff', 'schid');

        //  Bulk fetch classes grouped by school
        $classes = DB::table('sch_cls')
            ->whereIn('schid', $schoolIds)
            ->get(['schid', 'cls_id', 'name'])
            ->groupBy('schid')
            ->map(function ($items) {
                return $items->groupBy('cls_id')->map(fn($i) => $i->pluck('name')->toArray())->toArray();
            });

        //  Bulk fetch web data
        $webData = DB::table('school_web_data')
            ->whereIn('user_id', $schoolIds)
            ->get()
            ->keyBy('user_id');

        $pld = [];

        foreach ($schools as $school) {
            $sid = $school->sid;

            $schoolCode = strtoupper($school->sch3) . '/' . str_pad($sid, 4, '0', STR_PAD_LEFT);

            $pld[] = [
                's' => [
                    'sid' => $sid,
                    'school_id' => $schoolCode,
                    'name' => $school->name,
                    'count' => $school->count,
                    's_web' => $school->s_web,
                    's_info' => $school->s_info,
                    'sbd' => $school->sbd,
                    'sch3' => $school->sch3,
                    'cssn' => $school->cssn,
                    'ctrm' => $school->ctrm,
                    'ctrmn' => $school->ctrmn,
                    'lattitude' => $school->latt,
                    'longitude' => $school->longi,
                    'country' => $school->web_country ?? 'N/A',
                    'state' => $school->web_state ?? 'N/A',
                    'lga' => $school->web_lga ?? 'N/A',
                    'created_at' => $school->created_at,
                    'updated_at' => $school->updated_at,
                    'active_learners' => $learners[$sid] ?? 0,
                    'alumni' => $alumni[$sid] ?? 0,
                    'active_staff' => $staff[$sid] ?? 0,
                    'classes' => $classes[$sid] ?? [],
                    'total_classes' => count($classes[$sid] ?? []),
                ],
                'w' => isset($webData[$sid]) ? [
                    'user_id' => $webData[$sid]->user_id,
                    'school_name' => $webData[$sid]->sname ?? 'N/A',
                    'color' => $webData[$sid]->color ?? 'N/A',
                    'address' => $webData[$sid]->addr ?? 'N/A',
                    'country' => $webData[$sid]->country ?? 'N/A',
                    'state' => $webData[$sid]->state ?? 'N/A',
                    'lga' => $webData[$sid]->lga ?? 'N/A',
                    'phone' => $webData[$sid]->phn ?? 'N/A',
                    'email' => $webData[$sid]->eml ?? 'N/A',
                    'vision' => $webData[$sid]->vision ?? 'N/A',
                    'values' => $webData[$sid]->values ?? 'N/A',
                    'year' => $webData[$sid]->year ?? 'N/A',
                    'about' => $webData[$sid]->about ?? 'N/A',
                    'motto' => $webData[$sid]->motto ?? 'N/A',
                    'facebook' => $webData[$sid]->fb ?? 'N/A',
                    'instagram' => $webData[$sid]->isg ?? 'N/A',
                    'youtube' => $webData[$sid]->yt ?? 'N/A',
                    'whatsapp' => $webData[$sid]->wh ?? 'N/A',
                    'linkedin' => $webData[$sid]->lkd ?? 'N/A',
                    'twitter' => $webData[$sid]->tw ?? 'N/A',
                    'created_at' => $webData[$sid]->created_at,
                    'updated_at' => $webData[$sid]->updated_at,
                ] : null,
            ];
        }

        return response()->json([
            "status" => true,
            "message" => "Success",
            "total_records" => $totalRecords,
            "pld" => $pld,
        ]);
    }



    /**
     * @OA\Post(
     *     path="/api/updateLocation/{schid}",
     *     summary="Update school location (latitude & longitude)",
     *     description="Allows a school to update its latitude and longitude by providing the sid.",
     *     tags={"Api"},
     *     security={{"bearerAuth":{}}},
     *
     *     @OA\Parameter(
     *         name="schid",
     *         in="path",
     *         description="School ID (schid)",
     *         required=true,
     *         @OA\Schema(type="integer", example=12)
     *     ),
     *
     *     @OA\RequestBody(
     *         required=true,
     *         @OA\JsonContent(
     *             required={"latt", "longi"},
     *             @OA\Property(property="latt", type="number", format="float", example=6.5244, description="Latitude (-90 to 90)"),
     *             @OA\Property(property="longi", type="number", format="float", example=3.3792, description="Longitude (-180 to 180)")
     *         )
     *     ),
     *
     *     @OA\Response(
     *         response=200,
     *         description="Location updated successfully",
     *         @OA\JsonContent(
     *             @OA\Property(property="status", type="boolean", example=true),
     *             @OA\Property(property="message", type="string", example="Location updated successfully"),
     *             @OA\Property(
     *                 property="data",
     *                 type="object",
     *                 @OA\Property(property="sid", type="integer", example=11),
     *                 @OA\Property(property="name", type="string", example="HHCJ NURSERY AND PRIMARY SCHOOL"),
     *                 @OA\Property(property="latt", type="string", example="6.5244000"),
     *                 @OA\Property(property="longi", type="string", example="3.3792000"),
     *                 @OA\Property(property="updated_at", type="string", format="date-time", example="2025-09-18T10:45:00.000000Z"),
     *                 @OA\Property(property="created_at", type="string", format="date-time", example="2024-09-09T21:53:24.000000Z")
     *             )
     *         )
     *     ),
     *
     *     @OA\Response(
     *         response=404,
     *         description="School not found",
     *         @OA\JsonContent(
     *             @OA\Property(property="status", type="boolean", example=false),
     *             @OA\Property(property="message", type="string", example="School not found")
     *         )
     *     )
     * )
     */

    public function updateLocation(Request $request, $schid)
    {
        $request->validate([
            'latt' => 'required|numeric|between:-90,900',
            'longi' => 'required|numeric|between:-180,1800',
        ]);

        $school = school::where('sid', $schid)->first();

        if (!$school) {
            return response()->json([
                'status' => false,
                'message' => 'School not found'
            ], 404);
        }

        $school->latt = $request->latt;
        $school->longi = $request->longi;
        $school->save();

        return response()->json([
            'status' => true,
            'message' => 'Location updated successfully',
            'pld' => $school
        ]);
    }





    /**
     * @OA\Get(
     *     path="/api/getExternalExpendituresByAdmin/{ssn}/{trm}",
     *     summary="Get external expenditures (Admin)",
     *     description="Retrieve external expenditures filtered by School (SSN) and Term (TRM). Returns paginated records with totals per record and the overall total.",
     *     operationId="getExternalExpendituresByAdmin",
     *     tags={"Accounting"},
     *     security={{"bearerAuth":{}}},
     *
     *     @OA\Parameter(
     *         name="ssn",
     *         in="path",
     *         required=true,
     *         description="School SSN (set to 0 for all schools)",
     *         @OA\Schema(type="string", example="SCH12345")
     *     ),
     *     @OA\Parameter(
     *         name="trm",
     *         in="path",
     *         required=true,
     *         description="Term (set to 0 for all terms)",
     *         @OA\Schema(type="string", example="TRM2024")
     *     ),
     *
     *     @OA\Parameter(
     *         name="start",
     *         in="query",
     *         required=false,
     *         description="Pagination start index",
     *         @OA\Schema(type="integer", default=0, example=0)
     *     ),
     *     @OA\Parameter(
     *         name="count",
     *         in="query",
     *         required=false,
     *         description="Number of records to fetch",
     *         @OA\Schema(type="integer", default=20, example=20)
     *     ),
     *
     *     @OA\Response(
     *         response=200,
     *         description="Successful response",
     *         @OA\JsonContent(
     *             @OA\Property(property="status", type="boolean", example=true),
     *             @OA\Property(property="message", type="string", example="Success"),
     *             @OA\Property(
     *                 property="pld",
     *                 type="array",
     *                 description="List of expenditures with totals",
     *                 @OA\Items(
     *                     @OA\Property(property="id", type="integer", example=1),
     *                     @OA\Property(property="ssn", type="string", example="SCH12345"),
     *                     @OA\Property(property="trm", type="string", example="TRM2024"),
     *                     @OA\Property(property="time", type="string", format="date", example="2025-01-10"),
     *                     @OA\Property(property="vendor", type="string", example="Vendor A"),
     *                     @OA\Property(property="pv", type="string", example="PV123"),
     *                     @OA\Property(property="mode", type="string", example="Cash"),
     *                     @OA\Property(property="unit", type="number", example=500),
     *                     @OA\Property(property="qty", type="integer", example=10),
     *                     @OA\Property(property="item", type="string", example="Textbook"),
     *                     @OA\Property(property="total", type="number", example=5000)
     *                 )
     *             ),
     *             @OA\Property(property="overall_total", type="number", example=25000)
     *         )
     *     )
     * )
     */

    public function getExternalExpendituresByAdmin($ssn, $trm)
    {
        $baseQuery = ext_expenditure::query()
            ->join('school', 'ext_expenditure.schid', '=', 'school.sid');

        // Apply filters
        if ($ssn !== '0') {
            $baseQuery->where('ext_expenditure.ssn', $ssn);
        }

        if ($trm !== '0') {
            $baseQuery->where('ext_expenditure.trm', $trm);
        }

        // 1. Total expenditure per school (include sch3)
        $schools = (clone $baseQuery)
            ->select(
                'ext_expenditure.schid',
                'school.name as school_name',
                'school.sch3',
                \DB::raw('SUM(ext_expenditure.unit * ext_expenditure.qty) as total_expenditure')
            )
            ->groupBy('ext_expenditure.schid', 'school.name', 'school.sch3')
            ->orderBy('school.name', 'asc')
            ->get();

        // 2. Expenditure details (name/vendor/item per school)
        $expenditures = (clone $baseQuery)
            ->select(
                'ext_expenditure.schid',
                'ext_expenditure.name as expenditure_name',
                'ext_expenditure.vendor',
                'ext_expenditure.item',
                \DB::raw('SUM(ext_expenditure.unit * ext_expenditure.qty) as amount')
            )
            ->groupBy('ext_expenditure.schid', 'ext_expenditure.name', 'ext_expenditure.vendor', 'ext_expenditure.item')
            ->get();

        // 3. Attach breakdown + generate school_id
        $serial = 1; // global counter

        $result = $schools->map(function ($school) use ($expenditures, &$serial) {
            $schoolExpenditures = $expenditures->where('schid', $school->schid)->values();

            return [
                // e.g. AMS/0001 instead of AMB0001
                'school_id' => $school->sch3 . '/' . str_pad($serial++, 4, '0', STR_PAD_LEFT),
                'schid' => $school->schid,
                'school_name' => $school->school_name,
                'sch3' => $school->sch3,
                'total_expenditure' => $school->total_expenditure,
                'expenditures' => $schoolExpenditures,
            ];
        });

        return response()->json([
            "status" => true,
            "message" => "Success",
            "pld" => $result,
        ]);
    }




    /**
     * @OA\Get(
     *     path="/api/getInternalExpendituresByAdmin/{ssn}/{trm}",
     *     tags={"Accounting"},
     *       security={{"bearerAuth":{}}},
     *     summary="Get all expenditures by School, Session and Term",
     *     description="Use this endpoint to get all expenditures by School",
     *
     *     @OA\Parameter(
     *         name="ssn",
     *         in="path",
     *         required=true,
     *         description="Session ID",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Parameter(
     *         name="trm",
     *         in="path",
     *         required=true,
     *         description="Term ID",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Parameter(
     *         name="start",
     *         in="query",
     *         required=false,
     *         description="Index to start at",
     *         @OA\Schema(type="integer")
     *     ),
     *     @OA\Parameter(
     *         name="count",
     *         in="query",
     *         required=false,
     *         description="No of records to retrieve",
     *         @OA\Schema(type="integer")
     *     ),
     *     @OA\Parameter(
     *         name="amt",
     *         in="query",
     *         required=false,
     *         description="Filter by amount",
     *         @OA\Schema(type="integer")
     *     ),
     *     @OA\Parameter(
     *         name="time",
     *         in="query",
     *         required=false,
     *         description="Filter by time",
     *         @OA\Schema(type="integer")
     *     ),
     *     @OA\Parameter(
     *         name="mode",
     *         in="query",
     *         required=false,
     *         description="Filter by mode",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Response(response="200", description="Success", @OA\JsonContent()),
     *     @OA\Response(response="401", description="Unauthorized"),
     * )
     */


    public function getInternalExpendituresByAdmin($ssn, $trm)
    {
        $baseQuery = in_expenditure::query()
            ->join('school', 'in_expenditure.schid', '=', 'school.sid');

        // Apply filters
        if ($ssn !== '0') {
            $baseQuery->where('in_expenditure.ssn', $ssn);
        }
        if ($trm !== '0') {
            $baseQuery->where('in_expenditure.trm', $trm);
        }

        // 1. Get total expenditure per school (including sch3)
        $schools = (clone $baseQuery)
            ->select(
                'in_expenditure.schid',
                'school.sid',
                'school.name as school_name',
                'school.sch3',
                \DB::raw('SUM(in_expenditure.amt) as total_expenditure')
            )
            ->groupBy(
                'in_expenditure.schid',
                'school.sid',
                'school.name',
                'school.sch3'
            )
            ->orderBy('school.name', 'asc')
            ->get();

        // 2. Get breakdown (expenditure name + amount per school)
        $expenditures = (clone $baseQuery)
            ->select(
                'in_expenditure.schid',
                'in_expenditure.purp as expenditure_name',
                \DB::raw('SUM(in_expenditure.amt) as amount')
            )
            ->groupBy('in_expenditure.schid', 'in_expenditure.purp')
            ->get();

        // 3. Attach breakdown + generate school_id
        $serial = 1; // global counter

        $result = $schools->map(function ($school) use ($expenditures, &$serial) {
            $schoolExpenditures = $expenditures
                ->where('schid', $school->schid)
                ->values();

            return [
                // e.g. AMS/0001 instead of AMB0001
                'school_id' => $school->sch3 . '/' . str_pad($serial++, 4, '0', STR_PAD_LEFT),
                'schid' => $school->schid,
                'school_name' => $school->school_name,
                'sch3' => $school->sch3,
                'total_expenditure' => $school->total_expenditure,
                'expenditures' => $schoolExpenditures,
            ];
        });

        return response()->json([
            "status" => true,
            "message" => "Success",
            "pld" => $result,
        ]);
    }





    /**
     * @OA\Get(
     *     path="/api/getVendorsByAdmin",
     *     summary="Get a list of vendors with school details",
     *     description="Fetch vendors joined with school information. Each school has a custom school_id in the format `SCH3/0001`.",
     *     tags={"Accounting"},
     *    security={{"bearerAuth":{}}},
     *
     *     @OA\Parameter(
     *         name="start",
     *         in="query",
     *         required=false,
     *         description="Pagination start offset (default: 0)",
     *         @OA\Schema(type="integer", example=0)
     *     ),
     *     @OA\Parameter(
     *         name="count",
     *         in="query",
     *         required=false,
     *         description="Number of records to return (default: 20)",
     *         @OA\Schema(type="integer", example=20)
     *     ),
     *
     *     @OA\Response(
     *         response=200,
     *         description="Successful response",
     *         @OA\JsonContent(
     *             type="object",
     *             @OA\Property(property="status", type="boolean", example=true),
     *             @OA\Property(property="message", type="string", example="Success"),
     *             @OA\Property(
     *                 property="pld",
     *                 type="array",
     *                 @OA\Items(
     *                     type="object",
     *                     @OA\Property(property="vendor_id", type="integer", example=1),
     *                     @OA\Property(property="vendor_name", type="string", example="ABC Suppliers"),
     *                     @OA\Property(property="schid", type="integer", example=12),
     *                     @OA\Property(property="school_name", type="string", example="Ambassador High School"),
     *                     @OA\Property(property="sch3", type="string", example="AMB"),
     *                     @OA\Property(property="school_id", type="string", example="AMB/0001"),
     *                     @OA\Property(property="created_at", type="string", format="date-time", example="2025-09-25T12:34:56"),
     *                     @OA\Property(property="updated_at", type="string", format="date-time", example="2025-09-25T12:34:56")
     *                 )
     *             )
     *         )
     *     ),
     *
     *     @OA\Response(
     *         response=400,
     *         description="Invalid request parameters"
     *     )
     * )
     */


    public function getVendorsByAdmin()
    {
        $start = 0;
        $count = 20;

        if (request()->has('start') && request()->has('count')) {
            $start = request()->input('start');
            $count = request()->input('count');
        }

        // Join with school to get sch3
        $vendors = vendor::query()
            ->join('school', 'vendor.schid', '=', 'school.sid')
            ->select(
                'vendor.*',
                'school.sch3',
                'school.name as school_name'
            )
            ->skip($start)
            ->take($count)
            ->get();

        // Generate custom school_id (SCH3 + "/" + padded number)
        $serial = 1;
        $pld = $vendors->map(function ($vendor) use (&$serial) {
            return [
                'vendor_id' => $vendor->id,
                'vendor_name' => $vendor->name,
                'schid' => $vendor->schid,
                'school_name' => $vendor->school_name,
                'sch3' => $vendor->sch3,
                'school_id' => $vendor->sch3 . '/' . str_pad($serial++, 4, '0', STR_PAD_LEFT), // AMB/0001
                'created_at' => $vendor->created_at,
                'updated_at' => $vendor->updated_at,
            ];
        });

        // Respond
        return response()->json([
            "status" => true,
            "message" => "Success",
            "pld" => $pld,
        ]);
    }





    /**
     * @OA\Get(
     *     path="/api/getExpensesByAdmin",
     *     tags={"Accounting"},
     *     security={{"bearerAuth":{}}},
     *     summary="Get all expenses with school info",
     *     description="Retrieve a paginated list of expenses joined with school details.
     *                  Each expense includes a custom school_id in the format SCH3/0001 (e.g., AMB/0001).",
     *
     *     @OA\Parameter(
     *         name="start",
     *         in="query",
     *         required=false,
     *         description="Index to start retrieving records (default: 0)",
     *         @OA\Schema(type="integer", example=0)
     *     ),
     *     @OA\Parameter(
     *         name="count",
     *         in="query",
     *         required=false,
     *         description="Number of records to retrieve (default: 20)",
     *         @OA\Schema(type="integer", example=20)
     *     ),
     *
     *     @OA\Response(
     *         response=200,
     *         description="Successful response",
     *         @OA\JsonContent(
     *             type="object",
     *             @OA\Property(property="status", type="boolean", example=true),
     *             @OA\Property(property="message", type="string", example="Success"),
     *             @OA\Property(
     *                 property="pld",
     *                 type="array",
     *                 @OA\Items(
     *                     type="object",
     *                     @OA\Property(property="expense_id", type="integer", example=1),
     *                     @OA\Property(property="expense_name", type="string", example="Stationery"),
     *                     @OA\Property(property="amount", type="number", format="float", example=5000),
     *                     @OA\Property(property="schid", type="integer", example=12),
     *                     @OA\Property(property="school_name", type="string", example="Ambassador High School"),
     *                     @OA\Property(property="sch3", type="string", example="AMB"),
     *                     @OA\Property(property="school_id", type="string", example="AMB/0001"),
     *                     @OA\Property(property="created_at", type="string", format="date-time", example="2025-09-25T10:22:30Z"),
     *                     @OA\Property(property="updated_at", type="string", format="date-time", example="2025-09-25T10:22:30Z")
     *                 )
     *             )
     *         )
     *     ),
     *     @OA\Response(response=401, description="Unauthorized"),
     *     @OA\Response(response=500, description="Internal server error")
     * )
     */


    public function getExpensesByAdmin()
    {
        $start = 0;
        $count = 20;

        if (request()->has('start') && request()->has('count')) {
            $start = request()->input('start');
            $count = request()->input('count');
        }

        // Join with school table
        $expenses = expense::query()
            ->join('school', 'expense.schid', '=', 'school.sid')
            ->select(
                'expense.*',
                'school.sch3',
                'school.name as school_name'
            )
            ->skip($start)
            ->take($count)
            ->get();

        // Generate custom school_id (sch3 + "/" + padded serial)
        $serial = 1;
        $pld = $expenses->map(function ($exp) use (&$serial) {
            return [
                'expense_id' => $exp->id,
                'expense_name' => $exp->name ?? null, // if your table has name field
                'amount' => $exp->amount ?? null,     // if your table has amount column
                'schid' => $exp->schid,
                'school_name' => $exp->school_name,
                'sch3' => $exp->sch3,
                'school_id' => $exp->sch3 . '/' . str_pad($serial++, 4, '0', STR_PAD_LEFT), // AMB/0001
                'created_at' => $exp->created_at,
                'updated_at' => $exp->updated_at,
            ];
        });

        return response()->json([
            "status" => true,
            "message" => "Success",
            "pld" => $pld,
        ]);
    }


    /**
     * @OA\Get(
     *     path="/api/getExternalExpenditureStatByAdmin/{ssn}/{trm}",
     *     tags={"Accounting"},
     *     summary="Get how many expenditure are available",
     *     description="Use this endpoint to get how many expenditure are available",
     *    security={{"bearerAuth":{}}},
     *     @OA\Parameter(
     *         name="ssn",
     *         in="path",
     *         required=true,
     *         description="Session ID",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Parameter(
     *         name="trm",
     *         in="path",
     *         required=true,
     *         description="Term ID",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Response(response="200", description="Success", @OA\JsonContent()),
     *     @OA\Response(response="401", description="Unauthorized"),
     * )
     */
    public function getExternalExpenditureStatByAdmin($ssn, $trm)
    {
        $query = ext_expenditure::query();

        if ($ssn !== '0') {
            $query->where('ssn', $ssn);
        }
        if ($trm !== '0') {
            $query->where('trm', $trm);
        }

        // Count distinct schools
        $total = $query->distinct('schid')->count('schid');

        return response()->json([
            "status" => true,
            "message" => "Success",
            "pld" => [
                "total" => $total,
            ],
        ]);
    }



    /**
     * @OA\Get(
     *     path="/api/getExternalExpendituresByFilterByAdmin/{ssn}/{trm}",
     *     tags={"Accounting"},
     *   security={{"bearerAuth":{}}},
     *     summary="Get all expenditures by School, Session and Term",
     *     description="Use this endpoint to get all expenditures by School",
     *     @OA\Parameter(
     *         name="ssn",
     *         in="path",
     *         required=true,
     *         description="Session ID",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Parameter(
     *         name="trm",
     *         in="path",
     *         required=true,
     *         description="Term ID",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Parameter(
     *         name="start",
     *         in="query",
     *         required=false,
     *         description="Index to start at",
     *         @OA\Schema(type="integer")
     *     ),
     *     @OA\Parameter(
     *         name="count",
     *         in="query",
     *         required=false,
     *         description="No of records to retrieve",
     *         @OA\Schema(type="integer")
     *     ),
     *     @OA\Parameter(
     *         name="vendor",
     *         in="query",
     *         required=false,
     *         description="Filter by vendor",
     *         @OA\Schema(type="integer")
     *     ),
     *     @OA\Parameter(
     *         name="item",
     *         in="query",
     *         required=false,
     *         description="Filter by expense heading",
     *         @OA\Schema(type="integer")
     *     ),
     *     @OA\Parameter(
     *         name="time",
     *         in="query",
     *         required=false,
     *         description="Filter by time",
     *         @OA\Schema(type="integer")
     *     ),
     *     @OA\Parameter(
     *         name="pv",
     *         in="query",
     *         required=false,
     *         description="Filter by pv",
     *         @OA\Schema(type="integer")
     *     ),
     *     @OA\Parameter(
     *         name="mode",
     *         in="query",
     *         required=false,
     *         description="Filter by mode",
     *         @OA\Schema(type="integer")
     *     ),
     *     @OA\Parameter(
     *         name="unit",
     *         in="query",
     *         required=false,
     *         description="Filter by unit",
     *         @OA\Schema(type="integer")
     *     ),
     *     @OA\Parameter(
     *         name="qty",
     *         in="query",
     *         required=false,
     *         description="Filter by qty",
     *         @OA\Schema(type="integer")
     *     ),
     *     @OA\Response(response="200", description="Success", @OA\JsonContent()),
     *     @OA\Response(response="401", description="Unauthorized"),
     * )
     */
    public function getExternalExpendituresByFilterByAdmin($ssn, $trm)
    {
        $start = request()->input('start', 0); // Default start
        $count = request()->input('count', 20); // Default count

        $query = ext_expenditure::query();

        if ($ssn !== '0') {
            $query->where('ssn', $ssn);
        }

        if ($trm !== '0') {
            $query->where('trm', $trm);
        }

        // Filter and sort for fields: time, vendor, pv, mode, unit, qty
        $fields = ['time', 'vendor', 'pv', 'mode', 'unit', 'qty', 'item'];
        foreach ($fields as $field) {
            $qValue = request()->input($field, null);
            if ($qValue !== null && $qValue !== '-1') {
                if ($field === 'time') {
                    if (strpos($qValue, '-') !== false) {
                        $compo = explode("-", $qValue);
                        if (count($compo) == 2) {
                            $frm = $compo[0];
                            $to = $compo[1];
                            $query->where($field, '>=', $frm);
                            $query->where($field, '<=', $to);
                        }
                    }
                } else {
                    $query->where($field, $qValue);
                }
            }
        }

        // Pagination
        $pld = $query->skip($start)->take($count)->get();

        // Respond
        return response()->json([
            "status" => true,
            "message" => "Success",
            "pld" => $pld,
        ]);
    }


    /**
     * @OA\Get(
     *     path="/api/getInternalExpenditureStatByAdmin/{ssn}/{trm}",
     *     summary="Get internal expenditure statistics by admin",
     *     description="Fetch the total number of internal expenditure records, optionally filtered by session (ssn) and term (trm).",
     *     operationId="getInternalExpenditureStatByAdmin",
     *     tags={"Accounting"},
     *    security={{"bearerAuth":{}}},
     *
     *     @OA\Parameter(
     *         name="ssn",
     *         in="path",
     *         required=true,
     *         description="Session ID (use 0 to fetch for all sessions)",
     *         @OA\Schema(type="string", example="2024")
     *     ),
     *     @OA\Parameter(
     *         name="trm",
     *         in="path",
     *         required=true,
     *         description="Term ID (use 0 to fetch for all terms)",
     *         @OA\Schema(type="string", example="1")
     *     ),
     *
     *     @OA\Response(
     *         response=200,
     *         description="Successful response",
     *         @OA\JsonContent(
     *             type="object",
     *             @OA\Property(property="status", type="boolean", example=true),
     *             @OA\Property(property="message", type="string", example="Success"),
     *             @OA\Property(
     *                 property="pld",
     *                 type="object",
     *                 @OA\Property(property="total", type="integer", example=45)
     *             )
     *         )
     *     ),
     *     @OA\Response(
     *         response=400,
     *         description="Invalid request"
     *     )
     * )
     */

    public function getInternalExpenditureStatByAdmin($ssn, $trm)
    {
        $query = in_expenditure::query();

        if ($ssn !== '0') {
            $query->where('ssn', $ssn);
        }
        if ($trm !== '0') {
            $query->where('trm', $trm);
        }

        // Count distinct schools (schid)
        $total = $query->distinct('schid')->count('schid');

        return response()->json([
            "status" => true,
            "message" => "Success",
            "pld" => [
                "total" => $total,
            ],
        ]);
    }




    /**
     * @OA\Post(
     *     path="/api/resetDefaultPasswordAdmin",
     *     summary="Reset school user's password to default",
     *     description="Resets the password of the user account linked to a specific school. The new default password will be '123456'.",
     *     tags={"Admin"},
     *    security={{"bearerAuth":{}}},
     *
     *     @OA\RequestBody(
     *         required=true,
     *         @OA\JsonContent(
     *             required={"schid"},
     *             @OA\Property(
     *                 property="schid",
     *                 type="integer",
     *                 example=12,
     *                 description="The ID of the school (sid in the school table)"
     *             )
     *         )
     *     ),
     *
     *     @OA\Response(
     *         response=200,
     *         description="Password reset successfully",
     *         @OA\JsonContent(
     *             @OA\Property(property="status", type="boolean", example=true),
     *             @OA\Property(property="message", type="string", example="Password for school 'HOLY GHOST COLLEGE' has been reset to default (123456).")
     *         )
     *     ),
     *
     *     @OA\Response(
     *         response=404,
     *         description="School not found or no user account exists",
     *         @OA\JsonContent(
     *             @OA\Property(property="status", type="boolean", example=false),
     *             @OA\Property(property="message", type="string", example="School not found.")
     *         )
     *     )
     * )
     */
    public function resetDefaultPasswordAdmin(Request $request)
    {
        // Validate request
        $request->validate([
            "schid" => "required|integer", // school id
        ]);

        // Find the school first
        $school = school::where("sid", $request->schid)->first();
        if (!$school) {
            return response()->json([
                "status" => false,
                "message" => "School not found.",
            ], 404);
        }

        // Find the user linked to this school
        $user = User::where("id", $school->sid)->first();

        if ($user) {
            $user->update([
                "password" => bcrypt("123456"),
            ]);

            return response()->json([
                "status" => true,
                "message" => "Password for school '{$school->name}' has been reset to default (123456)."
            ]);
        }

        return response()->json([
            "status" => false,
            "message" => "No user account found for this school.",
        ], 404);
    }




    /**
     * @OA\Get(
     *     path="/api/getAllClasses",
     *     tags={"Api"},
     *   security={{"bearerAuth":{}}},
     *     summary="Fetch all classes",
     *     description="Returns a list of all available classes ordered by ID",
     *     @OA\Response(
     *         response=200,
     *         description="Classes fetched successfully",
     *         @OA\JsonContent(
     *             type="object",
     *             @OA\Property(property="status", type="boolean", example=true),
     *             @OA\Property(property="message", type="string", example="Classes fetched successfully"),
     *             @OA\Property(
     *                 property="pld",
     *                 type="array",
     *                 @OA\Items(
     *                     type="object",
     *                     @OA\Property(property="id", type="integer", example=1),
     *                     @OA\Property(property="name", type="string", example="Kg")
     *                 )
     *             )
     *         )
     *     ),
     *     @OA\Response(
     *         response=500,
     *         description="Error fetching classes",
     *         @OA\JsonContent(
     *             type="object",
     *             @OA\Property(property="status", type="boolean", example=false),
     *             @OA\Property(property="message", type="string", example="Error fetching classes"),
     *             @OA\Property(property="error", type="string", example="SQLSTATE[42S02]: Base table or view not found: 1146 Table 'school.cls' doesn't exist")
     *         )
     *     )
     * )
     */
    public function getAllClasses()
    {
        try {
            $classes = cls::orderBy('id', 'asc')->get(['id', 'name']);

            return response()->json([
                "status" => true,
                "message" => "Classes fetched successfully",
                "pld" => $classes
            ]);
        } catch (\Exception $e) {
            return response()->json([
                "status" => false,
                "message" => "Error fetching classes",
                "error" => $e->getMessage()
            ], 500);
        }
    }




    /**
     * @OA\Get(
     *     path="/api/getClassesBySchool/{schid}",
     *     summary="Get all classes by school",
     *     description="Fetches all classes assigned to a given school ID (schid).",
     *     tags={"Api"},
     *   security={{"bearerAuth":{}}},
     *
     *     @OA\Parameter(
     *         name="schid",
     *         in="path",
     *         required=true,
     *         description="School ID",
     *         @OA\Schema(type="integer", example=12)
     *     ),
     *
     *     @OA\Response(
     *         response=200,
     *         description="Classes fetched successfully",
     *         @OA\JsonContent(
     *             @OA\Property(property="status", type="boolean", example=true),
     *             @OA\Property(property="message", type="string", example="Classes fetched successfully"),
     *             @OA\Property(
     *                 property="pld",
     *                 type="array",
     *                 @OA\Items(
     *                     @OA\Property(property="id", type="integer", example=11),
     *                     @OA\Property(property="name", type="string", example="JSS 1"),
     *                     @OA\Property(property="schid", type="integer", example=12)
     *                 )
     *             )
     *         )
     *     ),
     *
     *     @OA\Response(
     *         response=500,
     *         description="Error fetching classes",
     *         @OA\JsonContent(
     *             @OA\Property(property="status", type="boolean", example=false),
     *             @OA\Property(property="message", type="string", example="Error fetching classes"),
     *             @OA\Property(property="error", type="string", example="SQLSTATE[HY000]: General error ...")
     *         )
     *     )
     * )
     */

    public function getClassesBySchool($schid)
    {
        try {
            $classes = \DB::table('school_class')
                ->join('cls', 'school_class.clsid', '=', 'cls.id')
                ->where('school_class.schid', $schid)
                ->orderBy('cls.id', 'asc')
                ->get([
                    'cls.id',
                    'cls.name',
                    'school_class.schid'
                ]);

            return response()->json([
                "status" => true,
                "message" => "Classes fetched successfully",
                "pld" => $classes
            ]);
        } catch (\Exception $e) {
            return response()->json([
                "status" => false,
                "message" => "Error fetching classes",
                "error" => $e->getMessage()
            ], 500);
        }
    }





    /**
     * @OA\Get(
     *     path="/api/getStudentsId/{schid}/{ssn}/{trm}/{clsm}/{clsa}",
     *     summary="Get Old Students",
     *     description="Fetch old students for a given school, session, term, class and class arm.
     *                  If a student's status is inactive, the `status` will be shown as `Alumni` and
     *                  `current_class` will be `Alumni`.",
     *     tags={"Api"},
     *     security={{"bearerAuth":{}}},
     *     @OA\Parameter(
     *         name="schid",
     *         in="path",
     *         required=true,
     *         description="School ID",
     *         @OA\Schema(type="integer", example=13)
     *     ),
     *     @OA\Parameter(
     *         name="ssn",
     *         in="path",
     *         required=true,
     *         description="Session year",
     *         @OA\Schema(type="string", example="2024")
     *     ),
     *     @OA\Parameter(
     *         name="trm",
     *         in="path",
     *         required=true,
     *         description="Term ID",
     *         @OA\Schema(type="integer", example=1)
     *     ),
     *     @OA\Parameter(
     *         name="clsm",
     *         in="path",
     *         required=true,
     *         description="Class main ID",
     *         @OA\Schema(type="integer", example=11)
     *     ),
     *     @OA\Parameter(
     *         name="clsa",
     *         in="path",
     *         required=true,
     *         description="Class arm ID (use -1 to ignore filter)",
     *         @OA\Schema(type="integer", example=2)
     *     ),
     *     @OA\Response(
     *         response=200,
     *         description="Successful response with list of students",
     *         @OA\JsonContent(
     *             type="object",
     *             @OA\Property(property="status", type="boolean", example=true),
     *             @OA\Property(property="message", type="string", example="Success"),
     *             @OA\Property(
     *                 property="pld",
     *                 type="array",
     *                 @OA\Items(
     *                     type="object",
     *                     @OA\Property(property="sid", type="integer", example=1000),
     *                     @OA\Property(property="fname", type="string", example="VICTORIA"),
     *                     @OA\Property(property="lname", type="string", example="KENNETH"),
     *                     @OA\Property(property="status", type="string", example="Alumni"),
     *                     @OA\Property(property="school_name", type="string", example="Holy Grace College"),
     *                     @OA\Property(property="class_id", type="integer", example=11),
     *                     @OA\Property(property="class_name", type="string", example="SS 1"),
     *                     @OA\Property(property="class_arm_id", type="integer", example=2),
     *                     @OA\Property(property="class_arm", type="string", example="B"),
     *                     @OA\Property(property="current_class", type="string", example="Alumni")
     *                 )
     *             )
     *         )
     *     ),
     *     @OA\Response(
     *         response=404,
     *         description="No students found"
     *     )
     * )
     */

    public function getStudentsId($schid, $ssn, $trm, $clsm, $clsa)
    {
        $query = DB::table('old_student as os')
            ->leftJoin('school as s', 'os.schid', '=', 's.sid')
            ->leftJoin('cls as c', 'os.clsm', '=', 'c.id')              // main class
            ->leftJoin('sch_cls as sc', 'os.clsa', '=', 'sc.id')        // class arm
            ->leftJoin('student_basic_data as bd', 'os.sid', '=', 'bd.user_id') // join by sid
            ->leftJoin('school_web_data as swd', 'os.schid', '=', 'swd.user_id') // join school_web_data
            ->where("os.schid", $schid)
            ->where("os.ssn", $ssn)
            ->where("os.trm", $trm)
            ->where("os.clsm", $clsm);

        if ($clsa != '-1') {
            $query->where("os.clsa", $clsa);
        }

        $students = $query->select(
            'os.sid',
            'os.fname',
            'os.lname',
            'os.status',
            'os.suid as student_id',
            's.name as school_name',
            's.sbd as subdomain',
            'swd.phn as school_phone', // get school phone
            'c.id as class_id',
            'c.name as class_name',
            'sc.id as class_arm_id',
            'sc.name as class_arm',
            'bd.dob' // added date of birth
        )
            ->distinct('os.sid')
            ->get();

        $pld = $students->map(function ($student) {
            $status = $student->status === 'inactive' ? 'Alumni' : $student->status;
            $currentClass = $student->status === 'inactive' ? 'Alumni' : $student->class_name;

            // Convert numeric dob (milliseconds) to YYYY-MM-DD
            $dob = null;
            if (!empty($student->dob) && is_numeric($student->dob)) {
                try {
                    $dob = date('Y-m-d', $student->dob / 1000);
                } catch (\Exception $e) {
                    $dob = null;
                }
            }

            return [
                "sid" => $student->sid,
                "fname" => $student->fname,
                "lname" => $student->lname,
                "dob" => $dob,
                "status" => $status,
                "school_name" => $student->school_name,
                "subdomain" => $student->subdomain,
                "school_phone" => $student->school_phone ?? 'N/A', // added to response
                "student_id" => $student->student_id,
                "class_id" => $student->class_id,
                "class_name" => $student->class_name,
                "class_arm_id" => $student->class_arm_id,
                "class_arm" => $student->class_arm,
                "current_class" => $currentClass
            ];
        });

        return response()->json([
            "status" => true,
            "message" => "Success",
            "pld" => $pld,
        ]);
    }


    /**
     * @OA\Get(
     *     path="/api/verifyStudent",
     *     summary="Get Student by Student ID",
     *     description="Fetch a student's details using their Student ID (e.g., HGC/2024/2/367). Returns personal info, school, class, and class arm.",
     *     operationId="getStudentByStudentId",
     *     tags={"Api"},
     *     security={{"bearerAuth":{}}},
     *
     *     @OA\Parameter(
     *         name="studentId",
     *         in="query",
     *         required=true,
     *         description="Unique Student ID (e.g., HGC/2024/2/367)",
     *         @OA\Schema(type="string", example="HGC/2024/2/367")
     *     ),
     *
     *     @OA\Response(
     *         response=200,
     *         description="Successful response with student details",
     *         @OA\JsonContent(
     *             type="object",
     *             @OA\Property(property="status", type="boolean", example=true),
     *             @OA\Property(property="message", type="string", example="Success"),
     *             @OA\Property(
     *                 property="pld",
     *                 type="array",
     *                 @OA\Items(
     *                     type="object",
     *                     @OA\Property(property="sid", type="string", example="2376"),
     *                     @OA\Property(property="fname", type="string", example="JOSHUA"),
     *                     @OA\Property(property="lname", type="string", example="OKECHUKWU"),
     *                     @OA\Property(property="status", type="string", example="active"),
     *                     @OA\Property(property="school_name", type="string", example="HOLY GHOST COLLEGE"),
     *                     @OA\Property(property="student_id", type="string", example="HGC/2024/2/367"),
     *                     @OA\Property(property="class_id", type="integer", example=13),
     *                     @OA\Property(property="class_name", type="string", example="JSS 3"),
     *                     @OA\Property(property="class_arm_id", type="integer", example=5),
     *                     @OA\Property(property="class_arm", type="string", example="A"),
     *                     @OA\Property(property="current_class", type="string", example="JSS 3")
     *                 )
     *             )
     *         )
     *     ),
     *
     *     @OA\Response(
     *         response=400,
     *         description="Bad Request - studentId missing",
     *         @OA\JsonContent(
     *             type="object",
     *             @OA\Property(property="status", type="boolean", example=false),
     *             @OA\Property(property="message", type="string", example="studentId is required"),
     *             @OA\Property(property="pld", type="array", @OA\Items(type="object"))
     *         )
     *     ),
     *
     *     @OA\Response(
     *         response=404,
     *         description="Student not found",
     *         @OA\JsonContent(
     *             type="object",
     *             @OA\Property(property="status", type="boolean", example=false),
     *             @OA\Property(property="message", type="string", example="Student not found"),
     *             @OA\Property(property="pld", type="array", @OA\Items(type="object"))
     *         )
     *     )
     * )
     */

    public function verifyStudent(Request $request)
    {
        $studentId = $request->query('studentId'); // use query param instead of path param

        if (!$studentId) {
            return response()->json([
                "status" => false,
                "message" => "studentId is required",
                "pld" => []
            ], 400);
        }

        $student = DB::table('old_student as os')
            ->leftJoin('school as s', 'os.schid', '=', 's.sid')
            ->leftJoin('school_web_data as sw', 's.sid', '=', 'sw.user_id') // join to get school phone
            ->leftJoin('cls as c', 'os.clsm', '=', 'c.id')                  // main class
            ->leftJoin('sch_cls as sc', 'os.clsa', '=', 'sc.id')            // class arm
            ->leftJoin('student_basic_data as sb', 'os.sid', '=', 'sb.user_id') // join with basic data
            ->where("os.suid", $studentId) // filter by unique student ID
            ->select(
                'os.sid',
                'os.fname',
                'os.lname',
                'os.status',
                'os.suid as student_id',
                's.name as school_name',
                's.sbd as subdomain',
                'c.id as class_id',
                'c.name as class_name',
                'sc.id as class_arm_id',
                'sc.name as class_arm',
                'sb.dob',
                'sb.sex',
                'sb.addr',
                'sw.phn as school_phone' // added school phone
            )
            ->first();

        //  Student not found
        if (!$student) {
            return response()->json([
                "status" => false,
                "message" => "Student not found",
                "pld" => []
            ], 404);
        }

        //  Convert DOB (milliseconds  YYYY-MM-DD)
        $dob = null;
        if (!empty($student->dob) && is_numeric($student->dob)) {
            try {
                $dob = \Carbon\Carbon::createFromTimestamp($student->dob / 1000)->format('Y-m-d');
            } catch (\Exception $e) {
                $dob = null;
            }
        }

        // Alumni handling
        $status = $student->status === 'inactive' ? 'Alumni' : $student->status;
        $currentClass = $student->status === 'inactive' ? 'Alumni' : $student->class_name;

        // Build payload
        $pld = [
            "sid" => (string) $student->sid,
            "fname" => $student->fname,
            "lname" => $student->lname,
            "status" => $status,
            "school_name" => $student->school_name,
            "subdomain" => $student->subdomain,
            "school_phone" => $student->school_phone ?? 'N/A', // display phone number
            "student_id" => $student->student_id,
            "class_id" => $student->class_id,
            "class_name" => $student->class_name,
            "class_arm_id" => $student->class_arm_id,
            "class_arm" => $student->class_arm,
            "current_class" => $currentClass,
            "dob" => $dob ?: 'N/A',
            "sex" => $student->sex ?? 'N/A',
            "address" => $student->addr ?? 'N/A'
        ];

        return response()->json([
            "status" => true,
            "message" => "Student verified successfully",
            "pld" => [$pld],
        ]);
    }




    /**
     * @OA\Get(
     *     path="/api/getStaffId/{schid}/{ssn}/{trm}",
     *     summary="Get Staff IDs for a specific school, session, and term",
     *     description="Generates and retrieves staff IDs including role names, contact details, and other related information for a specific school, session, and term.",
     *     operationId="getStaffId",
     *     tags={"Api"},
     *  security={{"bearerAuth":{}}},
     *
     *     @OA\Parameter(
     *         name="schid",
     *         in="path",
     *         required=true,
     *         description="School ID",
     *         @OA\Schema(type="integer", example=13)
     *     ),
     *     @OA\Parameter(
     *         name="ssn",
     *         in="path",
     *         required=true,
     *         description="Session ID or academic session reference",
     *         @OA\Schema(type="string", example="2025")
     *     ),
     *     @OA\Parameter(
     *         name="trm",
     *         in="path",
     *         required=true,
     *         description="Term identifier (e.g., 1, 2, 3)",
     *         @OA\Schema(type="integer", example=1)
     *     ),
     *
     *     @OA\Response(
     *         response=200,
     *         description="Staff IDs generated successfully",
     *         @OA\JsonContent(
     *             type="object",
     *             @OA\Property(property="status", type="boolean", example=true),
     *             @OA\Property(property="message", type="string", example="Staff IDs generated successfully"),
     *             @OA\Property(
     *                 property="pld",
     *                 type="array",
     *                 @OA\Items(
     *                     type="object",
     *                     @OA\Property(property="sid", type="integer", example=1926),
     *                     @OA\Property(property="full_name", type="string", example="Nwagbo Chikodili Veronica"),
     *                     @OA\Property(property="status", type="string", example="active"),
     *                     @OA\Property(property="role", type="string", example="Principal"),
     *                     @OA\Property(property="role2", type="string", example="Vice Principal Academics"),
     *                     @OA\Property(property="school_code", type="string", example="HRS"),
     *                     @OA\Property(property="school_name", type="string", example="Holy Redeemer School"),
     *                     @OA\Property(property="staff_id", type="string", example="HRS/STAFF/1"),
     *                     @OA\Property(property="sex", type="string", example="F"),
     *                     @OA\Property(property="phone", type="string", example="09168877900"),
     *                     @OA\Property(property="address", type="string", example="Nwagbo's compound, Obeagu village, Nri town"),
     *                     @OA\Property(property="created_at", type="string", example="2024-11-22 00:43:47")
     *                 )
     *             )
     *         )
     *     ),
     *
     *     @OA\Response(
     *         response=404,
     *         description="No staff records found for the given school, session, and term",
     *         @OA\JsonContent(
     *             type="object",
     *             @OA\Property(property="status", type="boolean", example=false),
     *             @OA\Property(property="message", type="string", example="No staff found")
     *         )
     *     ),
     *
     *     @OA\Response(
     *         response=500,
     *         description="Internal server error",
     *         @OA\JsonContent(
     *             type="object",
     *             @OA\Property(property="status", type="boolean", example=false),
     *             @OA\Property(property="message", type="string", example="Something went wrong while generating staff IDs")
     *         )
     *     )
     * )
     */


    public function getStaffId($schid, $ssn, $trm)
    {
        $staff = DB::table('old_staff as os')
            ->leftJoin('staff as s', 'os.sid', '=', 's.sid')
            ->leftJoin('staff_basic_data as sb', 'os.sid', '=', 'sb.user_id')
            ->leftJoin('school as sch', 'os.schid', '=', 'sch.sid')
            ->leftJoin('school_web_data as sw', 'sch.sid', '=', 'sw.user_id') // join to get school phone
            ->leftJoin('staff_role as r1', 'os.role', '=', 'r1.id')
            ->leftJoin('staff_role as r2', 'os.role2', '=', 'r2.id')
            ->where('os.schid', $schid)
            ->where('os.ssn', $ssn)
            ->where('os.trm', $trm)
            ->select(
                'os.sid',
                DB::raw('MIN(os.uid) as uid'),
                DB::raw('MAX(os.status) as status'),
                DB::raw('MAX(os.role) as role'),
                DB::raw('MAX(os.role2) as role2'),
                DB::raw('MAX(r1.name) as role_name'),
                DB::raw('MAX(r2.name) as role2_name'),
                DB::raw('MAX(s.sch3) as sch3'),
                DB::raw('MAX(sb.dob) as dob'),
                DB::raw('MAX(sb.sex) as sex'),
                DB::raw('MAX(sb.phn) as phn'),
                DB::raw('MAX(sb.addr) as addr'),
                DB::raw('MAX(sch.name) as school_name'),
                DB::raw('MAX(sch.sbd) as subdomain'), // include sbd column
                DB::raw('MAX(sw.phn) as school_phone'), // get school phone number
                DB::raw('MAX(os.fname) as fname'),
                DB::raw('MAX(os.mname) as mname'),
                DB::raw('MAX(os.lname) as lname'),
                DB::raw('MAX(os.suid) as suid'),
                DB::raw('MAX(os.created_at) as created_at')
            )
            ->groupBy('os.sid')
            ->orderBy('os.sid', 'asc')
            ->get();

        $existingCount = DB::table('old_staff')
            ->where('schid', $schid)
            ->where('ssn', $ssn)
            ->where('trm', $trm)
            ->whereNotNull('suid')
            ->distinct('sid')
            ->count('sid');

        $counter = $existingCount + 1;

        $pld = $staff->map(function ($stf) use (&$counter, $schid, $ssn, $trm) {
            $schoolCode = $stf->sch3 ?? 'SCH';

            // Convert DOB from milliseconds  YYYY-MM-DD
            $dob = null;
            if (!empty($stf->dob) && is_numeric($stf->dob)) {
                try {
                    $dob = \Carbon\Carbon::createFromTimestamp($stf->dob / 1000)->format('Y-m-d');
                } catch (\Exception $e) {
                    $dob = null;
                }
            }

            // Check if staff is ex-staff
            $isExStaff = DB::table('ex_staffs')->where('stid', $stf->sid)->exists();
            $status = $isExStaff ? 'Ex Staff' : 'Staff';

            // Only assign new suid if missing
            if (empty($stf->suid)) {
                $staffId = sprintf("%s/STAFF/%03d", $schoolCode, $counter);
                DB::table('old_staff')
                    ->where('sid', $stf->sid)
                    ->where('schid', $schid)
                    ->where('ssn', $ssn)
                    ->where('trm', $trm)
                    ->update(['suid' => $staffId]);
                $counter++;
            } else {
                $staffId = $stf->suid;
            }

            return [
                "sid" => $stf->sid,
                "full_name" => trim("{$stf->fname} {$stf->mname} {$stf->lname}"),
                "status" => $status,
                "role" => $stf->role_name ?? 'N/A',
                "role2" => $stf->role2_name ?? 'N/A',
                "school_code" => $schoolCode,
                "school_name" => $stf->school_name,
                "school_phone" => $stf->school_phone ?? 'N/A',
                "subdomain" => $stf->subdomain ?? 'N/A', // include sbd in payload
                "staff_id" => $staffId,
                "dob" => $dob ?: 'N/A',
                "sex" => $stf->sex,
                "phone" => $stf->phn,
                "address" => $stf->addr,
                "created_at" => $stf->created_at,
            ];
        });

        return response()->json([
            "status" => true,
            "message" => "Unique staff IDs generated successfully",
            "pld" => $pld
        ]);
    }


    /**
     * @OA\Get(
     *     path="/api/verifyStaff",
     *     summary="Verify Staff Details",
     *     description="This endpoint verifies a staff member by their unique staff ID and returns staff details including personal information, school, and roles.",
     *     tags={"Api"},
     *   security={{"bearerAuth":{}}},
     *
     *     @OA\Parameter(
     *         name="staffId",
     *         in="query",
     *         required=true,
     *         description="Unique Staff ID (e.g., SCS/STAFF/003)",
     *         @OA\Schema(type="string", example="SCS/STAFF/003")
     *     ),
     *
     *     @OA\Response(
     *         response=200,
     *         description="Staff verified successfully",
     *         @OA\JsonContent(
     *             type="object",
     *             @OA\Property(property="status", type="boolean", example=true),
     *             @OA\Property(property="message", type="string", example="Staff verified successfully"),
     *             @OA\Property(
     *                 property="pld",
     *                 type="array",
     *                 @OA\Items(
     *                     type="object",
     *                     @OA\Property(property="sid", type="string", example="45"),
     *                     @OA\Property(property="full_name", type="string", example="John A. Doe"),
     *                     @OA\Property(property="status", type="string", example="active"),
     *                     @OA\Property(property="school_name", type="string", example="Sunrise High School"),
     *                     @OA\Property(property="staff_id", type="string", example="SCS/STAFF/003"),
     *                     @OA\Property(property="role", type="string", example="Teacher"),
     *                     @OA\Property(property="role2", type="string", example="Head of Department"),
     *                     @OA\Property(property="dob", type="string", example="1985-07-15"),
     *                     @OA\Property(property="sex", type="string", example="Male"),
     *                     @OA\Property(property="phone", type="string", example="+2348012345678"),
     *                     @OA\Property(property="address", type="string", example="12 Victory Road, Lagos, Nigeria"),
     *                     @OA\Property(property="created_at", type="string", format="date-time", example="2025-09-12 14:32:00")
     *                 )
     *             )
     *         )
     *     ),
     *
     *     @OA\Response(
     *         response=400,
     *         description="Missing staffId parameter",
     *         @OA\JsonContent(
     *             @OA\Property(property="status", type="boolean", example=false),
     *             @OA\Property(property="message", type="string", example="staffId is required"),
     *             @OA\Property(property="pld", type="array", @OA\Items(type="object"))
     *         )
     *     ),
     *
     *     @OA\Response(
     *         response=404,
     *         description="Staff not found",
     *         @OA\JsonContent(
     *             @OA\Property(property="status", type="boolean", example=false),
     *             @OA\Property(property="message", type="string", example="Staff not found"),
     *             @OA\Property(property="pld", type="array", @OA\Items(type="object"))
     *         )
     *     )
     * )
     */


    public function verifyStaff(Request $request)
    {
        $staffId = $request->query('staffId'); // ?staffId=SCS/STAFF/003

        if (!$staffId) {
            return response()->json([
                "status" => false,
                "message" => "staffId is required",
                "pld" => []
            ], 400);
        }

        //  Join necessary tables
        $staff = DB::table('old_staff as os')
            ->leftJoin('staff as s', 'os.sid', '=', 's.sid')
            ->leftJoin('staff_basic_data as sb', 'os.sid', '=', 'sb.user_id')
            ->leftJoin('school as sch', 'os.schid', '=', 'sch.sid')
            ->leftJoin('school_web_data as sw', 'sch.sid', '=', 'sw.user_id') // join to get school phone
            ->leftJoin('staff_role as r1', 'os.role', '=', 'r1.id')
            ->leftJoin('staff_role as r2', 'os.role2', '=', 'r2.id')
            ->where('os.suid', $staffId) // Filter by unique staff ID
            ->select(
                'os.sid',
                'os.fname',
                'os.mname',
                'os.lname',
                'os.status',
                'os.suid as staff_id',
                'sch.name as school_name',
                'sch.sbd as subdomain',   // include school.sbd here
                'sw.phn as school_phone',
                'r1.name as role_name',
                'r2.name as role2_name',
                'sb.dob',
                'sb.sex',
                'sb.phn as staff_phone',
                'sb.addr',
                'os.created_at'
            )
            ->first();

        //  Staff not found
        if (!$staff) {
            return response()->json([
                "status" => false,
                "message" => "Staff not found",
                "pld" => []
            ], 404);
        }

        // Check if staff is in ex_staffs table
        $isExStaff = DB::table('ex_staffs')->where('stid', $staff->sid)->exists();
        $currentStatus = $isExStaff ? 'Ex Staff' : 'Staff';

        //  Format date of birth (if numeric milliseconds)
        $dob = null;
        if (!empty($staff->dob) && is_numeric($staff->dob)) {
            try {
                $dob = \Carbon\Carbon::createFromTimestamp($staff->dob / 1000)->format('Y-m-d');
            } catch (\Exception $e) {
                $dob = null;
            }
        }

        // Combine names
        $fullName = trim("{$staff->fname} {$staff->mname} {$staff->lname}");

        // Build payload
        $pld = [
            "sid" => (string) $staff->sid,
            "full_name" => $fullName,
            "status" => $currentStatus,
            "school_name" => $staff->school_name,
            "subdomain" => $staff->subdomain, // Added school.sbd to pld
            "school_phone" => $staff->school_phone ?? 'N/A',
            "staff_id" => $staff->staff_id,
            "role" => $staff->role_name ?? 'N/A',
            "role2" => $staff->role2_name ?? 'N/A',
            "dob" => $dob ?: 'N/A',
            "sex" => $staff->sex,
            "phone" => $staff->staff_phone,
            "address" => $staff->addr,
            "created_at" => $staff->created_at,
        ];

        return response()->json([
            "status" => true,
            "message" => "Staff verified successfully",
            "pld" => [$pld],
        ]);
    }





    /**
     * @OA\Get(
     *     path="/api/getAllSchoolsInfoByState",
     *     operationId="getAllSchoolsInfoByState",
     *     tags={"Admin"},
     *      security={{"bearerAuth":{}}},
     *     summary="Fetch all schools information",
     *     description="Returns a paginated list of schools, with optional filtering by state (case-insensitive). Includes learners, staff, alumni counts, and class details.",
     *
     *     @OA\Parameter(
     *         name="start",
     *         in="query",
     *         description="Starting offset for pagination (default: 0)",
     *         required=false,
     *         @OA\Schema(type="integer", example=0)
     *     ),
     *     @OA\Parameter(
     *         name="count",
     *         in="query",
     *         description="Number of records to return (default: 20)",
     *         required=false,
     *         @OA\Schema(type="integer", example=20)
     *     ),
     *     @OA\Parameter(
     *         name="state",
     *         in="query",
     *         description="Filter schools by state name (case-insensitive). Use 'all' to fetch all states.",
     *         required=false,
     *         @OA\Schema(type="string", example="Abia")
     *     ),
     *
     *     @OA\Response(
     *         response=200,
     *         description="Successful response",
     *         @OA\JsonContent(
     *             type="object",
     *             @OA\Property(property="status", type="boolean", example=true),
     *             @OA\Property(property="message", type="string", example="Success"),
     *             @OA\Property(
     *                 property="pld",
     *                 type="array",
     *                 @OA\Items(
     *                     type="object",
     *                     @OA\Property(
     *                         property="s",
     *                         type="object",
     *                         @OA\Property(property="sid", type="integer", example=1),
     *                         @OA\Property(property="school_id", type="string", example="ABJCE/0001"),
     *                         @OA\Property(property="name", type="string", example="St. Patrick High School"),
     *                         @OA\Property(property="count", type="integer", example=800),
     *                         @OA\Property(property="s_web", type="string", nullable=true),
     *                         @OA\Property(property="s_info", type="string", nullable=true),
     *                         @OA\Property(property="sbd", type="string", example="School Board"),
     *                         @OA\Property(property="sch3", type="string", example="ABJCE"),
     *                         @OA\Property(property="cssn", type="string", example="CSSN12345"),
     *                         @OA\Property(property="ctrm", type="integer", example=25),
     *                         @OA\Property(property="ctrmn", type="integer", example=3),
     *                         @OA\Property(property="lattitude", type="string", example="6.5244"),
     *                         @OA\Property(property="longitude", type="string", example="3.3792"),
     *                         @OA\Property(property="created_at", type="string", format="date-time", example="2025-10-09T12:34:56Z"),
     *                         @OA\Property(property="updated_at", type="string", format="date-time", example="2025-10-09T12:34:56Z"),
     *                         @OA\Property(property="active_learners", type="integer", example=450),
     *                         @OA\Property(property="alumni", type="integer", example=200),
     *                         @OA\Property(property="active_staff", type="integer", example=30),
     *                         @OA\Property(
     *                             property="classes",
     *                             type="object",
     *                             example={"1": {"JSS 1A", "JSS 1B"}, "2": {"SSS 1A"}},
     *                             description="Grouped class arms by class ID"
     *                         ),
     *                         @OA\Property(property="total_classes", type="integer", example=12)
     *                     ),
     *                     @OA\Property(
     *                         property="w",
     *                         type="object",
     *                         nullable=true,
     *                         description="Web-related school data (from school_web_data)",
     *                         example={
     *                             "user_id": 1,
     *                             "state": "Abia",
     *                             "lga": "Umuahia North",
     *                             "phone": "+2348012345678",
     *                             "email": "info@stpatrick.edu.ng",
     *                             "website": "https://stpatrick.edu.ng"
     *                         }
     *                     )
     *                 )
     *             )
     *         )
     *     ),
     *
     *     @OA\Response(
     *         response=400,
     *         description="Bad Request",
     *         @OA\JsonContent(
     *             type="object",
     *             @OA\Property(property="status", type="boolean", example=false),
     *             @OA\Property(property="message", type="string", example="Invalid parameters")
     *         )
     *     ),
     *     @OA\Response(
     *         response=500,
     *         description="Server Error",
     *         @OA\JsonContent(
     *             type="object",
     *             @OA\Property(property="status", type="boolean", example=false),
     *             @OA\Property(property="message", type="string", example="Internal server error")
     *         )
     *     )
     * )
     */


    public function getAllSchoolsInfoByState(Request $request)
    {
        $start = $request->input('start', 0);
        $count = $request->input('count', 20);
        $state = $request->input('state'); // e.g. "Abia", "abia", or "ALL"

        // Base query
        $query = school::orderBy('name', 'asc');

        // Filter by state (case-insensitive)
        if (!empty($state) && strtolower($state) !== 'all') {
            $query->join('school_web_data as swd', 'school.sid', '=', 'swd.user_id')
                ->whereRaw('LOWER(swd.state) = ?', [strtolower($state)])
                ->select('school.*'); // ensure only school columns are returned
        }

        // Count total results (before pagination)
        $totalRecords = $query->count();

        // Pagination
        $schools = $query->skip($start)->take($count)->get();

        $pld = [];

        foreach ($schools as $school) {
            $user_id = $school->sid;

            // Fetch school web data (contains state, lga, phone, etc.)
            $webData = school_web_data::where('user_id', $user_id)->first();

            // Count active learners (unique)
            $activeLearners = old_student::where('schid', $user_id)
                ->where('status', 'active')
                ->distinct('sid')
                ->count('sid');

            // Alumni count
            $alumniCount = alumni::where('schid', $user_id)->count();

            // Active staff count
            $activeStaff = old_staff::where('schid', $user_id)
                ->where('status', 'active')
                ->distinct('sid')
                ->count('sid');

            // Group class arms by class ID
            $classArms = sch_cls::where('schid', $user_id)
                ->get(['cls_id', 'name'])
                ->groupBy('cls_id')
                ->map(fn($items) => $items->pluck('name')->toArray())
                ->toArray();

            $totalClasses = sch_cls::where('schid', $user_id)->count();

            // School code format (e.g., ABJCE/0001)
            $schoolCode = strtoupper($school->sch3) . '/' . str_pad($school->sid, 4, '0', STR_PAD_LEFT);

            $pld[] = [
                's' => [
                    'sid' => $school->sid,
                    'school_id' => $schoolCode,
                    'name' => $school->name,
                    'count' => $school->count,
                    's_web' => $school->s_web,
                    's_info' => $school->s_info,
                    'sbd' => $school->sbd,
                    'sch3' => $school->sch3,
                    'cssn' => $school->cssn,
                    'ctrm' => $school->ctrm,
                    'ctrmn' => $school->ctrmn,
                    'lattitude' => $school->latt,
                    'longitude' => $school->longi,
                    'created_at' => $school->created_at,
                    'updated_at' => $school->updated_at,
                    'active_learners' => $activeLearners,
                    'alumni' => $alumniCount,
                    'active_staff' => $activeStaff,
                    'classes' => $classArms,
                    'total_classes' => $totalClasses,
                ],
                'w' => $webData ? $webData->toArray() : null,
            ];
        }

        // Final response
        return response()->json([
            "status" => true,
            "message" => "Success",
            "total_records" => $totalRecords,
            "pld" => $pld,
        ]);
    }


    /**
     * @OA\Get(
     *     path="/api/getAllSchoolsInfoByStateLga",
     *     summary="Get schools filtered by state and/or LGA",
     *     description="Fetches schools filtered by state and/or LGA. Supports pagination.",
     *     tags={"Admin"},
     *     security={{"bearerAuth":{}}},
     *     @OA\Parameter(name="state", in="query", required=false, @OA\Schema(type="string", example="Abia")),
     *     @OA\Parameter(name="lga", in="query", required=false, @OA\Schema(type="string", example="Umuahia")),
     *     @OA\Parameter(name="start", in="query", required=false, @OA\Schema(type="integer", example=0)),
     *     @OA\Parameter(name="count", in="query", required=false, @OA\Schema(type="integer", example=20)),
     *     @OA\Response(
     *         response=200,
     *         description="Successful response",
     *         @OA\JsonContent(
     *             @OA\Property(property="status", type="boolean", example=true),
     *             @OA\Property(property="message", type="string", example="Success"),
     *             @OA\Property(property="total_records", type="integer", example=42),
     *             @OA\Property(property="records_returned", type="integer", example=20),
     *             @OA\Property(property="pld", type="array", @OA\Items(type="object"))
     *         )
     *     )
     * )
     */

    public function getAllSchoolsInfoByStateLga(Request $request)
    {
        $start = $request->input('start', 0);
        $count = $request->input('count', 20);
        $state = $request->input('state');
        $lga = $request->input('lga');

        $query = school::join('school_web_data as swd', 'school.sid', '=', 'swd.user_id')
            ->orderBy('school.name', 'asc')
            ->select('school.*');

        // Filter by state (if provided)
        if (!empty($state) && strtolower($state) !== 'all') {
            $query->whereRaw('LOWER(swd.state) = ?', [strtolower($state)]);
        }

        // Filter by LGA (if provided)
        if (!empty($lga) && strtolower($lga) !== 'all') {
            $query->whereRaw('LOWER(swd.lga) = ?', [strtolower($lga)]);
        }

        // Count total matching records
        $totalRecords = $query->count();

        // Pagination
        $schools = $query->skip($start)->take($count)->get();

        $pld = [];
        foreach ($schools as $school) {
            $webData = school_web_data::where('user_id', $school->sid)->first();
            $pld[] = [
                's' => $school,
                'w' => $webData ? $webData->toArray() : null,
            ];
        }

        return response()->json([
            "status" => true,
            "message" => "Success",
            "total_records" => $totalRecords,
            "pld" => $pld,
        ]);
    }





    //////////////////////////////////////////////////////////

    /**
     * @OA\Get(
     *     path="/api/getLearnersEnrollmentInfo",
     *     summary="Retrieve learners enrollment information with gender statistics",
     *     description="Fetches all schools and provides detailed enrollment information including active learners, staff, alumni, and gender summary for each school. Supports filtering by state and LGA with pagination.",
     *     tags={"Admin"},
     *     security={{"bearerAuth":{}}},
     *
     *     @OA\Parameter(
     *         name="start",
     *         in="query",
     *         description="The starting index for pagination (default: 0)",
     *         required=false,
     *         @OA\Schema(type="integer", example=0)
     *     ),
     *     @OA\Parameter(
     *         name="count",
     *         in="query",
     *         description="Number of records to retrieve (default: 20)",
     *         required=false,
     *         @OA\Schema(type="integer", example=20)
     *     ),
     *     @OA\Parameter(
     *         name="state",
     *         in="query",
     *         description="Filter schools by state name",
     *         required=false,
     *         @OA\Schema(type="string", example="Abia")
     *     ),
     *     @OA\Parameter(
     *         name="lga",
     *         in="query",
     *         description="Filter schools by LGA name",
     *         required=false,
     *         @OA\Schema(type="string", example="Umuahia")
     *     ),
     *
     *     @OA\Response(
     *         response=200,
     *         description="Successful response with school enrollment and gender data",
     *         @OA\JsonContent(
     *             type="object",
     *             @OA\Property(property="status", type="boolean", example=true),
     *             @OA\Property(property="message", type="string", example="Success"),
     *             @OA\Property(property="total_records", type="integer", example=2),
     *             @OA\Property(
     *                 property="pld",
     *                 type="array",
     *                 @OA\Items(
     *                     type="object",
     *                     @OA\Property(
     *                         property="s",
     *                         type="object",
     *                         @OA\Property(property="sid", type="integer", example=13),
     *                         @OA\Property(property="school_id", type="string", example="HRS/0013"),
     *                         @OA\Property(property="name", type="string", example="HOLY ROSARY SECONDARY SCHOOL"),
     *                         @OA\Property(property="state", type="string", example="Abia"),
     *                         @OA\Property(property="lga", type="string", example="Umuahia"),
     *                         @OA\Property(property="active_learners", type="integer", example=935),
     *                         @OA\Property(property="alumni", type="integer", example=0),
     *                         @OA\Property(property="active_staff", type="integer", example=28),
     *                         @OA\Property(property="total_classes", type="integer", example=26),
     *                         @OA\Property(
     *                             property="gender_summary",
     *                             type="object",
     *                             @OA\Property(property="male", type="integer", example=34),
     *                             @OA\Property(property="female", type="integer", example=43),
     *                             @OA\Property(property="total", type="integer", example=77)
     *                         )
     *                     ),
     *                     @OA\Property(
     *                         property="w",
     *                         type="object",
     *                         nullable=true,
     *                         @OA\Property(property="user_id", type="integer", example=13),
     *                         @OA\Property(property="school_name", type="string", example="HOLY ROSARY SECONDARY SCHOOL"),
     *                         @OA\Property(property="color", type="string", example="#4d0e05"),
     *                         @OA\Property(property="address", type="string", example="Ugunchara Umuahia, Abia State."),
     *                         @OA\Property(property="country", type="string", example="NG"),
     *                         @OA\Property(property="state", type="string", example="Abia"),
     *                         @OA\Property(property="lga", type="string", example="Umuahia"),
     *                         @OA\Property(property="phone", type="string", example="2348038956484"),
     *                         @OA\Property(property="email", type="string", example="hrssu22@gmail.com"),
     *                         @OA\Property(property="year", type="string", example="1961"),
     *                         @OA\Property(property="motto", type="string", example="Semper Unique Monstralucem")
     *                     )
     *                 )
     *             )
     *         )
     *     ),
     *
     *     @OA\Response(
     *         response=400,
     *         description="Bad Request"
     *     ),
     *     @OA\Response(
     *         response=500,
     *         description="Internal Server Error"
     *     )
     * )
     */


    public function getLearnersEnrollmentInfo(Request $request)
    {
        $start = $request->input('start', 0);
        $count = $request->input('count', 20);
        $state = $request->input('state');
        $lga = $request->input('lga');

        //  Join with school_web_data to filter and count
        $query = DB::table('school as s')
            ->leftJoin('school_web_data as sw', 's.sid', '=', 'sw.user_id')
            ->select('s.*', 'sw.state as web_state', 'sw.lga as web_lga', 'sw.country as web_country');

        if (!empty($state)) {
            $query->where('sw.state', $state);
        }

        if (!empty($lga)) {
            $query->where('sw.lga', $lga);
        }

        //  Get total count before pagination
        $totalRecords = $query->count();

        //  Apply pagination
        $schools = $query->orderBy('s.name', 'asc')
            ->skip($start)
            ->take($count)
            ->get();

        $pld = [];

        foreach ($schools as $school) {
            $user_id = $school->sid;

            // Count active learners
            $activeLearners = DB::table('old_student')
                ->where('schid', $user_id)
                ->where('status', 'active')
                ->distinct('sid')
                ->count('sid');

            // Count alumni
            $alumniCount = DB::table('alumnis')
                ->where('schid', $user_id)
                ->count();

            // Count active staff
            $activeStaff = DB::table('old_staff')
                ->where('schid', $user_id)
                ->where('status', 'active')
                ->distinct('sid')
                ->count('sid');

            // Fetch class arms grouped by cls_id
            $classArms = DB::table('sch_cls')
                ->where('schid', $user_id)
                ->get(['cls_id', 'name'])
                ->groupBy('cls_id')
                ->map(fn($items) => $items->pluck('name')->toArray())
                ->toArray();

            // Total class count
            $totalClasses = DB::table('sch_cls')
                ->where('schid', $user_id)
                ->count();

            // Proper school code
            $schoolCode = strtoupper($school->sch3) . '/' . str_pad($school->sid, 4, '0', STR_PAD_LEFT);

            //  Fetch web data
            $webData = DB::table('school_web_data')->where('user_id', $user_id)->first();

            /**
             * GENDER SUMMARY FOR ACTIVE STUDENTS
             */
            $activeStudentIds = DB::table('old_student')
                ->where('schid', $user_id)
                ->where('status', 'active')
                ->pluck('sid')
                ->toArray();

            $activeGender = DB::table('student_basic_data')
                ->whereIn('user_id', $activeStudentIds)
                ->select('sex', DB::raw('count(*) as total'))
                ->groupBy('sex')
                ->pluck('total', 'sex')
                ->toArray();

            $activeMale = $activeGender['M'] ?? 0;
            $activeFemale = $activeGender['F'] ?? 0;
            $totalActive = $activeMale + $activeFemale;

            /**
             * GENDER SUMMARY FOR ALUMNI (INACTIVE)
             */
            $alumniStudentIds = DB::table('alumnis')
                ->where('schid', $user_id)
                ->pluck('stid')
                ->toArray();

            $alumniGender = DB::table('student_basic_data')
                ->whereIn('user_id', $alumniStudentIds)
                ->select('sex', DB::raw('count(*) as total'))
                ->groupBy('sex')
                ->pluck('total', 'sex')
                ->toArray();

            $alumniMale = $alumniGender['M'] ?? 0;
            $alumniFemale = $alumniGender['F'] ?? 0;
            $totalAlumni = $alumniMale + $alumniFemale;

            // Add to payload
            $pld[] = [
                's' => [
                    'sid' => $school->sid,
                    'school_id' => $schoolCode,
                    'name' => $school->name,
                    'count' => $school->count,
                    's_web' => $school->s_web,
                    's_info' => $school->s_info,
                    'sbd' => $school->sbd,
                    'sch3' => $school->sch3,
                    'cssn' => $school->cssn,
                    'ctrm' => $school->ctrm,
                    'ctrmn' => $school->ctrmn,
                    'lattitude' => $school->latt,
                    'longitude' => $school->longi,
                    'country' => $school->web_country ?? 'N/A',
                    'state' => $school->web_state ?? 'N/A',
                    'lga' => $school->web_lga ?? 'N/A',
                    'created_at' => $school->created_at,
                    'updated_at' => $school->updated_at,
                    'active_learners' => $activeLearners,
                    'alumni' => $alumniCount,
                    'active_staff' => $activeStaff,
                    'classes' => $classArms,
                    'total_classes' => $totalClasses,
                    //  Gender data added here
                    'gender_summary' => [
                        'active_students' => [
                            'male' => $activeMale,
                            'female' => $activeFemale,
                            'total' => $totalActive,
                        ],
                        'alumni' => [
                            'male' => $alumniMale,
                            'female' => $alumniFemale,
                            'total' => $totalAlumni,
                        ]
                    ],
                ],
                'w' => $webData ? [
                    'user_id' => $webData->user_id,
                    'school_name' => $webData->sname ?? 'N/A',
                    'color' => $webData->color ?? 'N/A',
                    'address' => $webData->addr ?? 'N/A',
                    'country' => $webData->country ?? 'N/A',
                    'state' => $webData->state ?? 'N/A',
                    'lga' => $webData->lga ?? 'N/A',
                    'phone' => $webData->phn ?? 'N/A',
                    'email' => $webData->eml ?? 'N/A',
                    'vision' => $webData->vision ?? 'N/A',
                    'values' => $webData->values ?? 'N/A',
                    'year' => $webData->year ?? 'N/A',
                    'about' => $webData->about ?? 'N/A',
                    'motto' => $webData->motto ?? 'N/A',
                    'facebook' => $webData->fb ?? 'N/A',
                    'instagram' => $webData->isg ?? 'N/A',
                    'youtube' => $webData->yt ?? 'N/A',
                    'whatsapp' => $webData->wh ?? 'N/A',
                    'linkedin' => $webData->lkd ?? 'N/A',
                    'twitter' => $webData->tw ?? 'N/A',
                    'created_at' => $webData->created_at,
                    'updated_at' => $webData->updated_at,
                ] : null
            ];
        }

        return response()->json([
            "status" => true,
            "message" => "Success",
            "total_records" => $totalRecords,
            "pld" => $pld,
        ]);
    }





    /**
     * @OA\Get(
     *     path="/api/getLearnersEnrollmentInfoGender",
     *     summary="Get learners' enrollment information filtered by gender, location, and school",
     *     description="Fetch active learners filtered by gender, state, LGA, and optionally school ID, with pagination.",
     *     tags={"Admin"},
     *    security={{"bearerAuth":{}}},
     *     @OA\Parameter(
     *         name="start",
     *         in="query",
     *         required=false,
     *         description="Starting offset for pagination (default 0)",
     *         @OA\Schema(type="integer", example=0)
     *     ),
     *     @OA\Parameter(
     *         name="count",
     *         in="query",
     *         required=false,
     *         description="Number of records to fetch (default 20)",
     *         @OA\Schema(type="integer", example=20)
     *     ),
     *     @OA\Parameter(
     *         name="state",
     *         in="query",
     *         required=false,
     *         description="Filter by school state",
     *         @OA\Schema(type="string", example="Abia")
     *     ),
     *     @OA\Parameter(
     *         name="lga",
     *         in="query",
     *         required=false,
     *         description="Filter by school LGA",
     *         @OA\Schema(type="string", example="Umuahia")
     *     ),
     *     @OA\Parameter(
     *         name="gender",
     *         in="query",
     *         required=false,
     *         description="Filter by student gender ('M' or 'F')",
     *         @OA\Schema(type="string", example="M")
     *     ),
     *     @OA\Parameter(
     *         name="schid",
     *         in="query",
     *         required=false,
     *         description="Filter by specific school ID",
     *         @OA\Schema(type="integer", example=13)
     *     ),
     *     @OA\Response(
     *         response=200,
     *         description="Successful response with learners' data",
     *         @OA\JsonContent(
     *             @OA\Property(property="status", type="boolean", example=true),
     *             @OA\Property(property="message", type="string", example="Success"),
     *             @OA\Property(property="total_records", type="integer", example=117),
     *             @OA\Property(
     *                 property="pld",
     *                 type="array",
     *                 @OA\Items(
     *                     @OA\Property(property="student_id", type="string", example="HGC/2024/1/310"),
     *                     @OA\Property(property="fname", type="string", example="FAVOUR"),
     *                     @OA\Property(property="mname", type="string", example="UKAMAKA"),
     *                     @OA\Property(property="lname", type="string", example="AGBO"),
     *                     @OA\Property(property="dob", type="string", example="2008-06-19"),
     *                     @OA\Property(property="gender", type="string", example="M"),
     *                     @OA\Property(property="student_state", type="string", example="00"),
     *                     @OA\Property(property="student_lga", type="string", example="15"),
     *                     @OA\Property(property="school_country", type="string", example="NG"),
     *                     @OA\Property(property="school_state", type="string", example="Abia"),
     *                     @OA\Property(property="school_lga", type="string", example="Umuahia"),
     *                     @OA\Property(property="class_name", type="string", example="SSS 3"),
     *                     @OA\Property(property="class_arm_name", type="string", example="B"),
     *                     @OA\Property(property="school_name", type="string", example="HOLY GHOST COLLEGE")
     *                 )
     *             )
     *         )
     *     )
     * )
     */
    public function getLearnersEnrollmentInfoGender(Request $request)
    {
        $start = $request->input('start', 0);
        $count = $request->input('count', 20);
        $state = $request->input('state');
        $lga = $request->input('lga');
        $gender = $request->input('gender');
        $schid = $request->input('schid');

        // Subquery: get latest unique record for each student by uid
        $latestStudents = DB::table('old_student as os2')
            ->select(DB::raw('MAX(os2.uid) as latest_uid'))
            ->where('os2.status', 'active')
            ->groupBy('os2.sid');

        // Join with main table on latest uid (ensures one record per student)
        $query = DB::table('old_student as os')
            ->joinSub($latestStudents, 'latest', function ($join) {
                $join->on('os.uid', '=', 'latest.latest_uid');
            })
            ->join('student_basic_data as sbd', 'os.sid', '=', 'sbd.user_id')
            ->join('school as sc', 'os.schid', '=', 'sc.sid')
            ->join('school_web_data as swd', 'sc.sid', '=', 'swd.user_id')
            ->leftJoin('cls as c', 'os.clsm', '=', 'c.id')
            ->leftJoin('sch_cls as scl', 'os.clsa', '=', 'scl.id')
            ->select(
                'os.sid as student_id',
                'os.fname',
                'os.mname',
                'os.lname',
                'sbd.dob',
                'sbd.sex as gender',
                'sbd.state as student_state',
                'sbd.lga as student_lga',
                'swd.country as school_country',
                'swd.state as school_state',
                'swd.lga as school_lga',
                'c.name as class_name',
                'scl.name as class_arm_name',
                'sc.name as school_name'
            )
            ->where('os.status', 'active');

        // Apply filters dynamically
        if (!empty($state))
            $query->where('swd.state', $state);
        if (!empty($lga))
            $query->where('swd.lga', $lga);
        if (!empty($gender))
            $query->where('sbd.sex', $gender);
        if (!empty($schid))
            $query->where('os.schid', $schid);

        // Count unique students
        $totalRecords = $query->count();

        // Fetch paginated data
        $students = $query
            ->orderBy('os.lname', 'asc')
            ->skip($start)
            ->take($count)
            ->get();

        // Format date of birth properly
        foreach ($students as $student) {
            if (!empty($student->dob)) {
                try {
                    $student->dob = is_numeric($student->dob)
                        ? \Carbon\Carbon::createFromTimestamp($student->dob / 1000)->format('Y-m-d')
                        : \Carbon\Carbon::parse($student->dob)->format('Y-m-d');
                } catch (\Exception $e) {
                    $student->dob = null;
                }
            } else {
                $student->dob = null;
            }
        }

        return response()->json([
            'status' => true,
            'message' => 'Success',
            'total_records' => $totalRecords,
            'pld' => $students,
        ]);
    }



    /**
     * @OA\Get(
     *     path="/api/getStaffsEnrollmentInfo",
     *     summary="Get staff employment information for all schools",
     *     description="Fetches employment data for all schools including staff count, gender summary, and job role distribution. Supports filtering by state and LGA, and includes pagination.",
     *     operationId="getStaffEmploymentInfo",
     *     tags={"Admin"},
     *    security={{"bearerAuth":{}}},
     *
     *     @OA\Parameter(
     *         name="start",
     *         in="query",
     *         description="Pagination start index (default: 0)",
     *         required=false,
     *         @OA\Schema(type="integer", example=0)
     *     ),
     *     @OA\Parameter(
     *         name="count",
     *         in="query",
     *         description="Number of records to retrieve (default: 20)",
     *         required=false,
     *         @OA\Schema(type="integer", example=20)
     *     ),
     *     @OA\Parameter(
     *         name="state",
     *         in="query",
     *         description="Filter schools by state (optional)",
     *         required=false,
     *         @OA\Schema(type="string", example="Lagos")
     *     ),
     *     @OA\Parameter(
     *         name="lga",
     *         in="query",
     *         description="Filter schools by local government area (optional)",
     *         required=false,
     *         @OA\Schema(type="string", example="Ikeja")
     *     ),
     *
     *     @OA\Response(
     *         response=200,
     *         description="Successful response",
     *         @OA\JsonContent(
     *             type="object",
     *             @OA\Property(property="status", type="boolean", example=true),
     *             @OA\Property(property="message", type="string", example="Success"),
     *             @OA\Property(property="total_records", type="integer", example=154),
     *             @OA\Property(
     *                 property="pld",
     *                 type="array",
     *                 @OA\Items(
     *                     type="object",
     *                     @OA\Property(
     *                         property="s",
     *                         type="object",
     *                         @OA\Property(property="sid", type="integer", example=12),
     *                         @OA\Property(property="school_id", type="string", example="ABJCE/0012"),
     *                         @OA\Property(property="name", type="string", example="Springfield Academy"),
     *                         @OA\Property(property="s_info", type="string", example="Leading secondary school in Lagos"),
     *                         @OA\Property(property="sch3", type="string", example="ABJCE"),
     *                         @OA\Property(property="country", type="string", example="Nigeria"),
     *                         @OA\Property(property="state", type="string", example="Lagos"),
     *                         @OA\Property(property="lga", type="string", example="Ikeja"),
     *                         @OA\Property(property="total_staff", type="integer", example=50),
     *                         @OA\Property(property="active_staff", type="integer", example=45),
     *                         @OA\Property(property="inactive_staff", type="integer", example=5),
     *                         @OA\Property(
     *                             property="gender_summary",
     *                             type="object",
     *                             @OA\Property(property="male", type="integer", example=30),
     *                             @OA\Property(property="female", type="integer", example=20),
     *                             @OA\Property(property="total", type="integer", example=50)
     *                         ),
     *                         @OA\Property(
     *                             property="role_summary",
     *                             type="object",
     *                             example={"teacher": 40, "principal": 1, "admin": 9}
     *                         ),
     *                         @OA\Property(property="created_at", type="string", format="date-time", example="2025-01-03T12:00:00Z"),
     *                         @OA\Property(property="updated_at", type="string", format="date-time", example="2025-03-10T10:15:00Z")
     *                     ),
     *                     @OA\Property(
     *                         property="w",
     *                         type="object",
     *                         nullable=true,
     *                         @OA\Property(property="user_id", type="integer", example=12),
     *                         @OA\Property(property="school_name", type="string", example="Springfield Academy"),
     *                         @OA\Property(property="address", type="string", example="12 Broad Street, Ikeja, Lagos"),
     *                         @OA\Property(property="state", type="string", example="Lagos"),
     *                         @OA\Property(property="lga", type="string", example="Ikeja"),
     *                         @OA\Property(property="email", type="string", example="info@springfieldacademy.ng"),
     *                         @OA\Property(property="phone", type="string", example="+2348123456789"),
     *                         @OA\Property(property="website", type="string", example="https://springfieldacademy.ng"),
     *                         @OA\Property(property="created_at", type="string", format="date-time", example="2024-12-20T08:45:00Z"),
     *                         @OA\Property(property="updated_at", type="string", format="date-time", example="2025-01-15T09:30:00Z")
     *                     )
     *                 )
     *             )
     *         )
     *     ),
     *
     *     @OA\Response(
     *         response=400,
     *         description="Invalid request parameters"
     *     ),
     *     @OA\Response(
     *         response=500,
     *         description="Server error"
     *     )
     * )
     */


    public function getStaffsEnrollmentInfo(Request $request)
    {
        $start = $request->input('start', 0);
        $count = $request->input('count', 20);
        $state = $request->input('state');
        $lga = $request->input('lga');

        //  Base school query with optional filters
        $schoolQuery = DB::table('school as s')
            ->leftJoin('school_web_data as sw', 's.sid', '=', 'sw.user_id')
            ->select('s.*', 'sw.state as web_state', 'sw.lga as web_lga', 'sw.country as web_country');

        if (!empty($state)) {
            $schoolQuery->where('sw.state', $state);
        }
        if (!empty($lga)) {
            $schoolQuery->where('sw.lga', $lga);
        }

        $totalRecords = $schoolQuery->count();

        $schools = $schoolQuery->orderBy('s.name', 'asc')
            ->skip($start)
            ->take($count)
            ->get();

        $schoolIds = $schools->pluck('sid')->toArray();

        //  Preload staff counts and gender breakdowns in one query
        $staffData = DB::table('old_staff as os')
            ->join('staff_basic_data as sb', 'os.sid', '=', 'sb.user_id')
            ->select(
                'os.schid',
                'os.status',
                'sb.sex',
                DB::raw('COUNT(DISTINCT os.sid) as total')
            )
            ->whereIn('os.schid', $schoolIds)
            ->groupBy('os.schid', 'os.status', 'sb.sex')
            ->get();

        // Map staff data properly
        $staffDataProcessed = [];
        foreach ($staffData as $item) {
            $sid = $item->schid;
            $status = strtolower($item->status); // 'active' or 'inactive'
            $gender = $item->sex === 'M' ? 'male' : 'female';

            if (!isset($staffDataProcessed[$sid])) {
                $staffDataProcessed[$sid] = [
                    'active' => ['male' => 0, 'female' => 0, 'total' => 0],
                    'inactive' => ['male' => 0, 'female' => 0, 'total' => 0],
                ];
            }

            $staffDataProcessed[$sid][$status][$gender] = $item->total;
            $staffDataProcessed[$sid][$status]['total'] =
                $staffDataProcessed[$sid][$status]['male'] +
                $staffDataProcessed[$sid][$status]['female'];
        }

        //  Preload role summaries in one query
        $roleData = DB::table('old_staff')
            ->select('schid', 'role', DB::raw('COUNT(DISTINCT sid) as total'))
            ->whereIn('schid', $schoolIds)
            ->groupBy('schid', 'role')
            ->get();

        // Map role data properly
        $roleDataProcessed = [];
        foreach ($roleData as $item) {
            $sid = $item->schid;
            if (!isset($roleDataProcessed[$sid])) {
                $roleDataProcessed[$sid] = [];
            }
            $roleDataProcessed[$sid][$item->role] = $item->total;
        }

        //  Preload web data for all schools
        $webData = DB::table('school_web_data')
            ->whereIn('user_id', $schoolIds)
            ->get()
            ->keyBy('user_id');

        $pld = [];

        foreach ($schools as $school) {
            $sid = $school->sid;

            $genderSummary = $staffDataProcessed[$sid] ?? [
                'active' => ['male' => 0, 'female' => 0, 'total' => 0],
                'inactive' => ['male' => 0, 'female' => 0, 'total' => 0],
            ];

            $totalStaff = $genderSummary['active']['total'] + $genderSummary['inactive']['total'];
            $roles = $roleDataProcessed[$sid] ?? [];

            $schoolCode = strtoupper($school->sch3) . '/' . str_pad($school->sid, 4, '0', STR_PAD_LEFT);
            $w = $webData[$sid] ?? null;

            $pld[] = [
                's' => [
                    'sid' => $school->sid,
                    'school_id' => $schoolCode,
                    'name' => $school->name,
                    's_info' => $school->s_info,
                    'sch3' => $school->sch3,
                    'created_at' => $school->created_at,
                    'updated_at' => $school->updated_at,
                    'country' => $school->web_country ?? 'N/A',
                    'state' => $school->web_state ?? 'N/A',
                    'lga' => $school->web_lga ?? 'N/A',
                    'total_staff' => $totalStaff,
                    'active_staff' => $genderSummary['active']['total'],
                    'inactive_staff' => $genderSummary['inactive']['total'],
                    'gender_summary' => $genderSummary,
                    'role_summary' => $roles,
                ],
                'w' => $w ? [
                    'user_id' => $w->user_id,
                    'school_name' => $w->sname ?? 'N/A',
                    'address' => $w->addr ?? 'N/A',
                    'state' => $w->state ?? 'N/A',
                    'lga' => $w->lga ?? 'N/A',
                    'email' => $w->eml ?? 'N/A',
                    'phone' => $w->phn ?? 'N/A',
                    'website' => $w->website ?? 'N/A',
                    'created_at' => $w->created_at,
                    'updated_at' => $w->updated_at,
                ] : null,
            ];
        }

        return response()->json([
            "status" => true,
            "message" => "Success",
            "total_records" => $totalRecords,
            "pld" => $pld,
        ]);
    }



    /**
     * @OA\Get(
     *     path="/api/getStaffsEnrollmentInfoGender",
     *     summary="Get staff enrollment information by gender, school, and location",
     *     description="Retrieve a paginated list of active staff filtered by gender, school, state, and LGA.",
     *     operationId="getStaffsEnrollmentInfoGender",
     *     tags={"Admin"},
     *    security={{"bearerAuth":{}}},
     *
     *     @OA\Parameter(
     *         name="start",
     *         in="query",
     *         required=false,
     *         description="Starting index for pagination (default is 0)",
     *         @OA\Schema(type="integer", example=0)
     *     ),
     *     @OA\Parameter(
     *         name="count",
     *         in="query",
     *         required=false,
     *         description="Number of records to fetch per page (default is 20)",
     *         @OA\Schema(type="integer", example=20)
     *     ),
     *     @OA\Parameter(
     *         name="state",
     *         in="query",
     *         required=false,
     *         description="State where the school is located",
     *         @OA\Schema(type="string", example="Abia")
     *     ),
     *     @OA\Parameter(
     *         name="lga",
     *         in="query",
     *         required=false,
     *         description="Local Government Area (LGA) where the school is located",
     *         @OA\Schema(type="string", example="Umuahia")
     *     ),
     *     @OA\Parameter(
     *         name="gender",
     *         in="query",
     *         required=false,
     *         description="Gender of the staff to filter by (M or F)",
     *         @OA\Schema(type="string", example="M")
     *     ),
     *     @OA\Parameter(
     *         name="schid",
     *         in="query",
     *         required=false,
     *         description="School ID to filter staff records by a specific school",
     *         @OA\Schema(type="integer", example=12)
     *     ),
     *
     *     @OA\Response(
     *         response=200,
     *         description="Successful staff list retrieval",
     *         @OA\JsonContent(
     *             @OA\Property(property="status", type="boolean", example=true),
     *             @OA\Property(property="message", type="string", example="Success"),
     *             @OA\Property(property="total_records", type="integer", example=2),
     *             @OA\Property(
     *                 property="pld",
     *                 type="array",
     *                 @OA\Items(
     *                     @OA\Property(property="sid", type="string", example="2091"),
     *                     @OA\Property(property="staff_id", type="string", example="HGC/STAFF/18"),
     *                     @OA\Property(property="fname", type="string", example="Paschael"),
     *                     @OA\Property(property="mname", type="string", example="NIL"),
     *                     @OA\Property(property="lname", type="string", example="Ajuomiwe"),
     *                     @OA\Property(property="status", type="string", example="active"),
     *                     @OA\Property(property="role", type="string", example="*14"),
     *                     @OA\Property(property="role2", type="string", example="-1"),
     *                     @OA\Property(property="role1_clean", type="string", example="14"),
     *                     @OA\Property(property="role2_clean", type="string", example="-1"),
     *                     @OA\Property(property="role1_name", type="string", example="Subject Teacher"),
     *                     @OA\Property(property="role2_name", type="string", example=null),
     *                     @OA\Property(property="dob", type="string", example="1984-07-30"),
     *                     @OA\Property(property="gender", type="string", example="M"),
     *                     @OA\Property(property="staff_state", type="string", example="00"),
     *                     @OA\Property(property="staff_lga", type="string", example="15"),
     *                     @OA\Property(property="school_country", type="string", example="NG"),
     *                     @OA\Property(property="school_state", type="string", example="Abia"),
     *                     @OA\Property(property="school_lga", type="string", example="Umuahia"),
     *                     @OA\Property(property="school_name", type="string", example="HOLY GHOST COLLEGE")
     *                 )
     *             )
     *         )
     *     ),
     *
     *     @OA\Response(
     *         response=400,
     *         description="Invalid parameters supplied"
     *     ),
     *     @OA\Response(
     *         response=500,
     *         description="Internal server error"
     *     )
     * )
     */

    public function getStaffsEnrollmentInfoGender(Request $request)
    {
        $start = $request->input('start', 0);
        $count = $request->input('count', 20);
        $state = $request->input('state');
        $lga = $request->input('lga');
        $gender = $request->input('gender'); // 'M' or 'F'
        $schid = $request->input('schid');  // School ID filter

        // Build query
        $query = DB::table('old_staff as os')
            ->join('staff_basic_data as sbd', 'os.sid', '=', 'sbd.user_id')
            ->join('school_web_data as swd', 'os.schid', '=', 'swd.user_id')
            // Join for role1 and role2
            ->leftJoin('staff_role as sr1', DB::raw('REPLACE(os.role, "*", "")'), '=', 'sr1.id')
            ->leftJoin('staff_role as sr2', DB::raw('REPLACE(os.role2, "*", "")'), '=', 'sr2.id')
            ->select(
                'os.sid',
                'os.suid as staff_id',
                'os.fname',
                'os.mname',
                'os.lname',
                'os.status',
                'os.role',
                'os.role2',
                DB::raw('REPLACE(os.role, "*", "") as role1_clean'),
                DB::raw('REPLACE(os.role2, "*", "") as role2_clean'),
                'sr1.name as role1_name',
                'sr2.name as role2_name',
                'sbd.dob',
                'sbd.sex as gender',
                'sbd.state as staff_state',
                'sbd.lga as staff_lga',
                'swd.country as school_country',
                'swd.state as school_state',
                DB::raw('TRIM(swd.lga) as school_lga'),
                'swd.sname as school_name'
            )
            ->where('os.status', 'active');

        // Apply filters
        if (!empty($schid)) {
            $query->where('os.schid', $schid); //  Filter by specific school
        }

        if (!empty($state)) {
            $query->where('swd.state', $state);
        }

        if (!empty($lga)) {
            $query->whereRaw('TRIM(swd.lga) = ?', [$lga]);
        }

        if (!empty($gender)) {
            $query->where('sbd.sex', $gender);
        }

        // Avoid duplicates
        $query->groupBy(
            'os.sid',
            'os.suid',
            'os.fname',
            'os.mname',
            'os.lname',
            'os.role',
            'os.role2',
            'os.status',
            'sbd.dob',
            'sbd.sex',
            'sbd.state',
            'sbd.lga',
            'swd.country',
            'swd.state',
            'swd.lga',
            'swd.sname',
            'sr1.name',
            'sr2.name'
        );

        // Count total records
        $totalRecords = $query->count(DB::raw('distinct os.sid'));

        // Fetch paginated results
        $staff = $query->orderBy('os.lname', 'asc')
            ->skip($start)
            ->take($count)
            ->get();

        // Format DOBs
        foreach ($staff as $member) {
            $dob = null;
            if (!empty($member->dob)) {
                try {
                    $dob = is_numeric($member->dob)
                        ? \Carbon\Carbon::createFromTimestamp($member->dob / 1000)->format('Y-m-d')
                        : \Carbon\Carbon::parse($member->dob)->format('Y-m-d');
                } catch (\Exception $e) {
                    $dob = null;
                }
            }
            $member->dob = $dob;
        }

        // Return response
        return response()->json([
            'status' => true,
            'message' => 'Success',
            'total_records' => $totalRecords,
            'pld' => $staff->unique('sid')->values()
        ]);
    }





    /**
     * @OA\Get(
     *     path="/api/getLearnersStaffRatioInfo",
     *     tags={"Admin"},
     *    operationId="getLearnersStaffRatioInfo",
     *   security={{"bearerAuth":{}}},
     *     summary="Fetch Learners-to-Staff Ratio Information",
     *     description="Retrieve detailed learners, staff, and gender ratio information for schools within a specified location and academic session.",
     *
     *     @OA\Parameter(
     *         name="start",
     *         in="query",
     *         required=false,
     *         description="Pagination start offset (default: 0)",
     *         @OA\Schema(type="integer", example=0)
     *     ),
     *     @OA\Parameter(
     *         name="count",
     *         in="query",
     *         required=false,
     *         description="Number of records to retrieve per page (default: 20)",
     *         @OA\Schema(type="integer", example=20)
     *     ),
     *     @OA\Parameter(
     *         name="state",
     *         in="query",
     *         required=false,
     *         description="Filter by state name",
     *         @OA\Schema(type="string", example="Abia")
     *     ),
     *     @OA\Parameter(
     *         name="lga",
     *         in="query",
     *         required=false,
     *         description="Filter by local government area",
     *         @OA\Schema(type="string", example="Umuahia")
     *     ),
     *     @OA\Parameter(
     *         name="ssn",
     *         in="query",
     *         required=true,
     *         description="Academic session identifier (required)",
     *         @OA\Schema(type="string", example="2024/2025")
     *     ),
     *
     *     @OA\Response(
     *         response=200,
     *         description="Successful Response",
     *         @OA\JsonContent(
     *             type="object",
     *             example={
     *                 "status": true,
     *                 "message": "Success",
     *                 "total_records": 2,
     *                 "pld": {
     *                     {
     *                         "sid": "12",
     *                         "school_id": "HGC/0012",
     *                         "school_name": "HOLY GHOST COLLEGE",
     *                         "school_country": "NG",
     *                         "school_state": "Abia",
     *                         "school_lga": "Umuahia",
     *                         "active_learners": 250,
     *                         "alumni": 45,
     *                         "active_staff": 20,
     *                         "inactive_staff": 0,
     *                         "total_staff": 20,
     *                         "total_classes": 12,
     *                         "classes": {
     *                             "1": {"JSS1A", "JSS1B"},
     *                             "2": {"SS1A", "SS1B"}
     *                         },
     *                         "student_gender_summary": {
     *                             "active": {
     *                                 "male": 120,
     *                                 "female": 130,
     *                                 "total": 250
     *                             },
     *                             "alumni": {
     *                                 "male": 20,
     *                                 "female": 25,
     *                                 "total": 45
     *                             }
     *                         },
     *                         "staff_gender_summary": {
     *                             "active": {
     *                                 "male": 11,
     *                                 "female": 9,
     *                                 "total": 20
     *                             },
     *                             "inactive": {
     *                                 "male": 0,
     *                                 "female": 0,
     *                                 "total": 0
     *                             },
     *                             "overall_total": 20
     *                         },
     *                         "web_data": {
     *                             "address": "HOLY GHOST COLLEGE, OLOKORO ROAD, UMUAHIA, ABIA STATE NIGERIA",
     *                             "phone": "2348034623324",
     *                             "email": "collegeholyghost@gmail.com",
     *                             "about": "N/A"
     *                         }
     *                     },
     *                     {
     *                         "sid": "13",
     *                         "school_id": "HRS/0013",
     *                         "school_name": "HOLY ROSARY SECONDARY SCHOOL",
     *                         "school_country": "NG",
     *                         "school_state": "Abia",
     *                         "school_lga": "Umuahia",
     *                         "active_learners": 300,
     *                         "alumni": 80,
     *                         "active_staff": 28,
     *                         "inactive_staff": 0,
     *                         "total_staff": 28,
     *                         "total_classes": 15,
     *                         "classes": {
     *                             "1": {"JSS2A", "JSS2B"},
     *                             "2": {"SS2A", "SS2B"}
     *                         },
     *                         "student_gender_summary": {
     *                             "active": {
     *                                 "male": 150,
     *                                 "female": 150,
     *                                 "total": 300
     *                             },
     *                             "alumni": {
     *                                 "male": 40,
     *                                 "female": 40,
     *                                 "total": 80
     *                             }
     *                         },
     *                         "staff_gender_summary": {
     *                             "active": {
     *                                 "male": 13,
     *                                 "female": 15,
     *                                 "total": 28
     *                             },
     *                             "inactive": {
     *                                 "male": 0,
     *                                 "female": 0,
     *                                 "total": 0
     *                             },
     *                             "overall_total": 28
     *                         },
     *                         "web_data": {
     *                             "address": "Ugunchara Umuahia, Abia State.",
     *                             "phone": "2348038956484",
     *                             "email": "hrssu22@gmail.com",
     *                             "about": "N/A"
     *                         }
     *                     }
     *                 }
     *             }
     *         )
     *     ),
     *
     *     @OA\Response(
     *         response=400,
     *         description="Invalid Request Parameters",
     *         @OA\JsonContent(
     *             type="object",
     *             example={
     *                 "status": false,
     *                 "message": "Invalid or missing parameters"
     *             }
     *         )
     *     ),
     *
     *     @OA\Response(
     *         response=500,
     *         description="Internal Server Error",
     *         @OA\JsonContent(
     *             type="object",
     *             example={
     *                 "status": false,
     *                 "message": "An unexpected error occurred"
     *             }
     *         )
     *     )
     * )
     */

    public function getLearnersStaffRatioInfo(Request $request)
    {
        $start = $request->input('start', 0);
        $count = $request->input('count', 20);
        $state = $request->input('state');
        $lga = $request->input('lga');
        $ssn = $request->input('ssn'); // academic session

        // Base school query with optional filters
        $query = DB::table('school as s')
            ->leftJoin('school_web_data as sw', 's.sid', '=', 'sw.user_id')
            ->select('s.*', 'sw.state as web_state', 'sw.lga as web_lga', 'sw.country as web_country');

        if (!empty($state))
            $query->where('sw.state', $state);
        if (!empty($lga))
            $query->where('sw.lga', $lga);

        $totalRecords = $query->count();

        $schools = $query->orderBy('s.name', 'asc')
            ->skip($start)
            ->take($count)
            ->get();

        $schoolIds = $schools->pluck('sid')->toArray();

        if (empty($schoolIds)) {
            return response()->json([
                "status" => true,
                "message" => "Success",
                "total_records" => 0,
                "pld" => [],
            ], 200, [], JSON_PRETTY_PRINT);
        }

        //  Bulk fetch active students
        $activeStudents = DB::table('old_student as os')
            ->join('student_basic_data as sb', 'os.sid', '=', 'sb.user_id')
            ->select('os.schid', 'sb.sex', DB::raw('COUNT(*) as total'))
            ->whereIn('os.schid', $schoolIds)
            ->where('os.status', 'active')
            ->where('os.ssn', $ssn)
            ->groupBy('os.schid', 'sb.sex')
            ->get()
            ->groupBy('schid');

        //  Bulk fetch alumni
        $alumni = DB::table('alumnis as a')
            ->join('student_basic_data as sb', 'a.stid', '=', 'sb.user_id')
            ->select('a.schid', 'sb.sex', DB::raw('COUNT(*) as total'))
            ->whereIn('a.schid', $schoolIds)
            ->groupBy('a.schid', 'sb.sex')
            ->get()
            ->groupBy('schid');

        //  Bulk fetch active staff
        $activeStaff = DB::table('old_staff as os')
            ->join('staff_basic_data as sb', 'os.sid', '=', 'sb.user_id')
            ->select('os.schid', 'sb.sex', DB::raw('COUNT(*) as total'))
            ->whereIn('os.schid', $schoolIds)
            ->where('os.status', 'active')
            ->where('os.ssn', $ssn)
            ->groupBy('os.schid', 'sb.sex')
            ->get()
            ->groupBy('schid');

        //  Bulk fetch classes
        $classes = DB::table('sch_cls')
            ->whereIn('schid', $schoolIds)
            ->get()
            ->groupBy('schid')
            ->map(fn($items) => $items->groupBy('cls_id')->map(fn($cls) => $cls->pluck('name')->toArray())->toArray());

        //  Bulk fetch web data
        $webData = DB::table('school_web_data')
            ->whereIn('user_id', $schoolIds)
            ->get()
            ->keyBy('user_id');

        $pld = [];

        foreach ($schools as $school) {
            $sid = $school->sid;
            $schoolCode = strtoupper($school->sch3) . '/' . str_pad($sid, 4, '0', STR_PAD_LEFT);

            // Active students gender summary
            $as = collect($activeStudents[$sid] ?? []);
            $activeMale = $as->firstWhere('sex', 'M')->total ?? 0;
            $activeFemale = $as->firstWhere('sex', 'F')->total ?? 0;

            // Alumni gender summary
            $al = collect($alumni[$sid] ?? []);
            $alumniMale = $al->firstWhere('sex', 'M')->total ?? 0;
            $alumniFemale = $al->firstWhere('sex', 'F')->total ?? 0;

            // Active staff gender summary
            $st = collect($activeStaff[$sid] ?? []);
            $activeStaffMale = $st->firstWhere('sex', 'M')->total ?? 0;
            $activeStaffFemale = $st->firstWhere('sex', 'F')->total ?? 0;

            $pld[] = [
                "s" => [
                    "sid" => (string) $sid,
                    "school_id" => $schoolCode,
                    "name" => $school->name,
                    "count" => $school->count,
                    "s_web" => $school->s_web,
                    "s_info" => $school->s_info,
                    "sbd" => $school->sbd,
                    "sch3" => $school->sch3,
                    "cssn" => $school->cssn,
                    "ctrm" => $school->ctrm,
                    "ctrmn" => $school->ctrmn,
                    "lattitude" => $school->latt,
                    "longitude" => $school->longi,
                    "country" => $school->web_country ?? "NG",
                    "state" => $school->web_state ?? "N/A",
                    "lga" => $school->web_lga ?? "N/A",
                    "created_at" => $school->created_at,
                    "updated_at" => $school->updated_at,
                    "active_learners" => $activeMale + $activeFemale,
                    "alumni" => $alumniMale + $alumniFemale,
                    "active_staff" => $activeStaffMale + $activeStaffFemale,
                    "classes" => $classes[$sid] ?? [],
                    "total_classes" => count($classes[$sid] ?? []),
                    "gender_summary" => [
                        "active_students" => [
                            "male" => $activeMale,
                            "female" => $activeFemale,
                            "total" => $activeMale + $activeFemale,
                        ],
                        "alumni" => [
                            "male" => $alumniMale,
                            "female" => $alumniFemale,
                            "total" => $alumniMale + $alumniFemale,
                        ],
                        "active_staff" => [
                            "male" => $activeStaffMale,
                            "female" => $activeStaffFemale,
                            "total" => $activeStaffMale + $activeStaffFemale,
                        ],
                    ],
                ],
                "w" => $webData[$sid] ?? null
            ];
        }

        return response()->json([
            "status" => true,
            "message" => "Success",
            "total_records" => $totalRecords,
            "pld" => $pld,
        ], 200, [], JSON_PRETTY_PRINT);
    }


    /**
     * @OA\Post(
     *     path="/api/getLearnersStaffDetails",
     *     summary="Fetch learner and staff ratio for each class in a school",
     *     description="Returns detailed learner and staff statistics (male/female/total) per class and an overall summary for a given school and session.",
     *     operationId="getLearnersStaffDetails",
     *     tags={"Admin"},
     *   security={{"bearerAuth":{}}},
     *
     *     @OA\RequestBody(
     *         required=true,
     *         description="School and session details",
     *         @OA\JsonContent(
     *             required={"schid", "ssn"},
     *             @OA\Property(property="schid", type="integer", example=12, description="School ID"),
     *             @OA\Property(property="ssn", type="string", example="2024", description="Academic session")
     *         )
     *     ),
     *
     *     @OA\Response(
     *         response=200,
     *         description="Learner/Staff Ratio fetched successfully",
     *         @OA\JsonContent(
     *             @OA\Property(property="status", type="boolean", example=true),
     *             @OA\Property(property="message", type="string", example="Learner/Staff Ratio fetched successfully"),
     *             @OA\Property(
     *                 property="pld",
     *                 type="object",
     *                 @OA\Property(
     *                     property="details",
     *                     type="array",
     *                     @OA\Items(
     *                         @OA\Property(property="clsid", type="integer", example=11),
     *                         @OA\Property(property="school_id", type="integer", example=12),
     *                         @OA\Property(property="session", type="string", example="2024"),
     *                         @OA\Property(property="class", type="string", example="JSS 1"),
     *                         @OA\Property(
     *                             property="learners",
     *                             type="object",
     *                             @OA\Property(property="male", type="integer", example=15),
     *                             @OA\Property(property="female", type="integer", example=9),
     *                             @OA\Property(property="total", type="integer", example=24)
     *                         ),
     *                         @OA\Property(
     *                             property="staff",
     *                             type="object",
     *                             @OA\Property(property="male", type="integer", example=5),
     *                             @OA\Property(property="female", type="integer", example=6),
     *                             @OA\Property(property="total", type="integer", example=11)
     *                         )
     *                     )
     *                 ),
     *                 @OA\Property(
     *                     property="summary",
     *                     type="object",
     *                     @OA\Property(property="total_male_students", type="integer", example=55),
     *                     @OA\Property(property="total_female_students", type="integer", example=29),
     *                     @OA\Property(property="total_students", type="integer", example=84),
     *                     @OA\Property(property="total_male_staff", type="integer", example=18),
     *                     @OA\Property(property="total_female_staff", type="integer", example=17),
     *                     @OA\Property(property="total_staff", type="integer", example=35),
     *                     @OA\Property(property="overall_male", type="integer", example=73),
     *                     @OA\Property(property="overall_female", type="integer", example=46),
     *                     @OA\Property(property="overall_total", type="integer", example=119)
     *                 )
     *             )
     *         )
     *     ),
     *
     *     @OA\Response(
     *         response=400,
     *         description="Missing required parameters",
     *         @OA\JsonContent(
     *             @OA\Property(property="status", type="boolean", example=false),
     *             @OA\Property(property="message", type="string", example="School ID and session are required.")
     *         )
     *     )
     * )
     */

    public function getLearnersStaffDetails(Request $request)
    {
        $schid = $request->input('schid');
        $ssn = $request->input('ssn'); // academic session (required)

        // Validate required parameters
        if (empty($schid) || empty($ssn)) {
            return response()->json([
                'status' => false,
                'message' => 'School ID and session are required.'
            ], 400);
        }

        // Fetch all unique classes for the given school only
        $classes = DB::table('sch_cls')
            ->join('cls', 'cls.id', '=', 'sch_cls.cls_id')
            ->where('sch_cls.schid', $schid)
            ->select(
                'cls.id as clsid',
                'cls.name as class_name'
            )
            ->distinct()
            ->orderBy('cls.id', 'asc')
            ->get();

        $data = [];

        // Initialize totals
        $totalMaleStudents = 0;
        $totalFemaleStudents = 0;
        $totalMaleStaff = 0;
        $totalFemaleStaff = 0;

        foreach ($classes as $class) {
            $clsid = $class->clsid;
            $className = $class->class_name;

            /**
             * ===========================
             * STUDENT SECTION (By School)
             * ===========================
             */
            $studentIds = DB::table('old_student')
                ->where('schid', $schid)
                ->where('status', 'active')
                ->where('ssn', $ssn)
                ->where('clsm', $clsid)
                ->distinct()
                ->pluck('sid')
                ->toArray();

            $studentGender = DB::table('student_basic_data')
                ->whereIn('user_id', $studentIds)
                ->whereNotNull('sex')
                ->select('sex', DB::raw('COUNT(*) as total'))
                ->groupBy('sex')
                ->pluck('total', 'sex')
                ->toArray();

            $maleStudents = $studentGender['M'] ?? 0;
            $femaleStudents = $studentGender['F'] ?? 0;
            $totalStudents = $maleStudents + $femaleStudents;

            $totalMaleStudents += $maleStudents;
            $totalFemaleStudents += $femaleStudents;

            /**
             * ===========================
             * STAFF SECTION (By School)
             * ===========================
             */
            $staffIds = DB::table('old_staff')
                ->where('schid', $schid)
                ->where('status', 'active')
                ->where('ssn', $ssn)
                ->where('clsm', $clsid)
                ->distinct()
                ->pluck('sid')
                ->toArray();

            $staffGender = DB::table('staff_basic_data')
                ->whereIn('user_id', $staffIds)
                ->whereNotNull('sex')
                ->select('sex', DB::raw('COUNT(*) as total'))
                ->groupBy('sex')
                ->pluck('total', 'sex')
                ->toArray();

            $maleStaff = $staffGender['M'] ?? 0;
            $femaleStaff = $staffGender['F'] ?? 0;
            $totalStaff = $maleStaff + $femaleStaff;

            $totalMaleStaff += $maleStaff;
            $totalFemaleStaff += $femaleStaff;

            /**
             * ===========================
             * CLASS-LEVEL RATIO
             * ===========================
             */
            $data[] = [
                'clsid' => $clsid,
                'school_id' => $schid,
                'session' => $ssn,
                'class' => $className,
                'learners' => [
                    'male' => $maleStudents,
                    'female' => $femaleStudents,
                    'total' => $totalStudents,
                ],
                'staff' => [
                    'male' => $maleStaff,
                    'female' => $femaleStaff,
                    'total' => $totalStaff,
                ],
            ];
        }

        /**
         * ===========================
         * OVERALL SUMMARY
         * ===========================
         */
        $overallSummary = [
            'total_male_students' => $totalMaleStudents,
            'total_female_students' => $totalFemaleStudents,
            'total_students' => $totalMaleStudents + $totalFemaleStudents,

            'total_male_staff' => $totalMaleStaff,
            'total_female_staff' => $totalFemaleStaff,
            'total_staff' => $totalMaleStaff + $totalFemaleStaff,

            'overall_male' => $totalMaleStudents + $totalMaleStaff,
            'overall_female' => $totalFemaleStudents + $totalFemaleStaff,
            'overall_total' => $totalMaleStudents + $totalFemaleStudents + $totalMaleStaff + $totalFemaleStaff,
        ];

        return response()->json([
            'status' => true,
            'message' => 'Learner/Staff Ratio fetched successfully',
            'pld' => [
                'details' => $data,
                'summary' => $overallSummary
            ]
        ], 200, [], JSON_PRETTY_PRINT);
    }


    /**
     * @OA\Get(
     *     path="/api/getStudentGenderDetails",
     *     tags={"Admin"},
     *    operationId="getStudentGenderDetails",
     *   security={{"bearerAuth":{}}},
     *     summary="Fetch student gender details for a given class and session",
     *     description="Returns a list of students filtered by gender, session, and class for a given school.",
     *     @OA\Parameter(
     *         name="schid",
     *         in="query",
     *         required=true,
     *         description="School ID",
     *         @OA\Schema(type="integer")
     *     ),
     *     @OA\Parameter(
     *         name="ssn",
     *         in="query",
     *         required=true,
     *         description="Academic Session (e.g. 2024)",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Parameter(
     *         name="class",
     *         in="query",
     *         required=true,
     *         description="Class ID (clsm)",
     *         @OA\Schema(type="integer")
     *     ),
     *     @OA\Parameter(
     *         name="gender",
     *         in="query",
     *         required=true,
     *         description="Gender (M or F)",
     *         @OA\Schema(type="string", enum={"M", "F"})
     *     ),
     *     @OA\Response(
     *         response=200,
     *         description="Student list fetched successfully",
     *         @OA\JsonContent(
     *             @OA\Property(property="status", type="boolean", example=true),
     *             @OA\Property(property="message", type="string", example="Student list fetched successfully"),
     *             @OA\Property(property="count", type="integer", example=5),
     *             @OA\Property(
     *                 property="pld",
     *                 type="array",
     *                 @OA\Items(
     *                     @OA\Property(property="student_id", type="integer", example=1000),
     *                     @OA\Property(property="suid", type="string", example="HRS/2024/1/68"),
     *                     @OA\Property(property="full_name", type="string", example="Victoria Ngozika Kenneth"),
     *                     @OA\Property(property="sex", type="string", example="F"),
     *                     @OA\Property(property="date_of_birth", type="string", example="2008-05-14"),
     *                     @OA\Property(property="class_name", type="string", example="JSS 1"),
     *                     @OA\Property(property="class_arm", type="string", example="A")
     *                 )
     *             )
     *         )
     *     ),
     *     @OA\Response(response=400, description="Missing parameters")
     * )
     */
    public function getStudentGenderDetails(Request $request)
    {
        $schid = $request->input('schid');   // school_id
        $ssn = $request->input('ssn');     // session
        $class = $request->input('class');   // cls_id
        $gender = $request->input('gender');  // 'M' or 'F'

        if (!$schid || !$ssn || !$class || !$gender) {
            return response()->json([
                'status' => false,
                'message' => 'Missing parameters: schid, ssn, class, gender'
            ], 400);
        }

        $records = DB::table('old_student as os')
            ->join('student_basic_data as sbd', 'os.sid', '=', 'sbd.user_id')
            ->join('sch_cls as sc', function ($join) {
                $join->on('os.clsa', '=', 'sc.id')  // Join class arms
                    ->on('os.schid', '=', 'sc.schid');
            })
            ->join('cls as c', 'os.clsm', '=', 'c.id') // Join main class table
            ->select(
                'os.sid as student_id',
                'os.suid',
                'os.fname',
                'os.mname',
                'os.lname',
                'sbd.sex',
                DB::raw("DATE(FROM_UNIXTIME(sbd.dob / 1000)) as date_of_birth"),
                'c.name as class_name',
                'sc.name as class_arm'
            )
            ->where('os.schid', $schid)
            ->where('os.ssn', $ssn)
            ->where('c.id', $class)
            ->where('sbd.sex', $gender)
            ->where('os.status', 'active')
            ->groupBy(
                'os.sid',
                'os.suid',
                'os.fname',
                'os.mname',
                'os.lname',
                'sbd.sex',
                'sbd.dob',
                'c.name',
                'sc.name'
            )
            ->orderBy('os.lname', 'asc')
            ->get();

        return response()->json([
            'status' => true,
            'message' => 'Student list fetched successfully',
            'count' => $records->count(),
            'pld' => $records
        ], 200, [], JSON_PRETTY_PRINT);
    }



    /**
     * @OA\Get(
     *     path="/api/getStaffGenderDetails",
     *     tags={"Admin"},
     *    operationId="getStaffGenderDetails",
     *  security={{"bearerAuth":{}}},
     *     summary="Get staff gender details by school, session (ssn), and class (clsm)",
     *     description="Fetches a unique list of active staff filtered by school ID, session (ssn), class (clsm), and gender.",
     *     @OA\Parameter(
     *         name="school_id",
     *         in="query",
     *         required=true,
     *         description="The ID of the school (maps to os.schid)",
     *         @OA\Schema(type="integer", example=12)
     *     ),
     *     @OA\Parameter(
     *         name="ssn",
     *         in="query",
     *         required=true,
     *         description="The academic session (maps to os.ssn)",
     *         @OA\Schema(type="integer", example=2024)
     *     ),
     *     @OA\Parameter(
     *         name="clsm",
     *         in="query",
     *         required=true,
     *         description="The class ID (maps to os.clsm)",
     *         @OA\Schema(type="integer", example=11)
     *     ),
     *     @OA\Parameter(
     *         name="gender",
     *         in="query",
     *         required=true,
     *         description="Gender of the staff (M or F)",
     *         @OA\Schema(type="string", example="M")
     *     ),
     *     @OA\Response(
     *         response=200,
     *         description="Staff list fetched successfully",
     *         @OA\JsonContent(
     *             @OA\Property(property="status", type="boolean", example=true),
     *             @OA\Property(property="message", type="string", example="Staff list fetched successfully"),
     *             @OA\Property(property="count", type="integer", example=5),
     *             @OA\Property(
     *                 property="pld",
     *                 type="array",
     *                 @OA\Items(
     *                     @OA\Property(property="staff_id", type="integer", example=1932),
     *                     @OA\Property(property="suid", type="string", example="SCS/STAFF/9"),
     *                     @OA\Property(property="full_name", type="string", example="Onyinyechi Bertha Ahiabuike"),
     *                     @OA\Property(property="sex", type="string", example="F"),
     *                     @OA\Property(property="class_name", type="string", example="Primary 1")
     *                 )
     *             )
     *         )
     *     ),
     *     @OA\Response(
     *         response=400,
     *         description="Missing parameters"
     *     )
     * )
     */
    public function getStaffGenderDetails(Request $request)
    {
        $schoolId = $request->input('school_id');
        $session = $request->input('ssn'); // academic session
        $class = $request->input('clsm'); // class ID
        $gender = $request->input('gender'); // 'M' or 'F'

        if (!$schoolId || !$session || !$class || !$gender) {
            return response()->json([
                'status' => false,
                'message' => 'Missing parameters: school_id, ssn, clsm, gender'
            ], 400);
        }

        $records = DB::table('old_staff as os')
            ->join('staff_basic_data as sbd', 'os.sid', '=', 'sbd.user_id')
            ->join('cls as c', 'os.clsm', '=', 'c.id')
            ->select(
                'os.sid as staff_id',
                'os.suid',
                DB::raw("CONCAT(os.fname, ' ', os.mname, ' ', os.lname) as full_name"),
                'sbd.sex',
                'c.name as class_name',
                // Convert dob from milliseconds timestamp to readable date
                DB::raw("FROM_UNIXTIME(sbd.dob / 1000, '%Y-%m-%d') as dob")
            )
            ->where('os.schid', $schoolId)
            ->where('os.ssn', $session)
            ->where('os.clsm', $class)
            ->where('sbd.sex', $gender)
            ->where('os.status', 'active')
            ->groupBy('os.sid', 'os.suid', 'os.fname', 'os.mname', 'os.lname', 'sbd.sex', 'c.name', 'sbd.dob')
            ->orderBy('full_name', 'asc')
            ->get();

        return response()->json([
            'status' => true,
            'message' => 'Staff list fetched successfully',
            'count' => $records->count(),
            'pld' => $records
        ]);
    }




    /**
     * @OA\Post(
     *     path="/api/rePostStaff",
     *     summary="Repost a staff for a specific session and term",
     *     description="This endpoint re-posts a staff member into the `old_staff` table for the specified session, term, and class. It does not modify any other tables. Optional roles can be updated if provided.",
     *     tags={"Api"},
     *     security={{"bearerAuth":{}}},
     *     operationId="rePostStaff",
     *
     *     @OA\RequestBody(
     *         required=true,
     *         @OA\JsonContent(
     *             required={"stid", "schid", "sesn", "trm", "clsm", "suid"},
     *             @OA\Property(property="stid", type="integer", example=2073, description="Staff ID"),
     *             @OA\Property(property="schid", type="integer", example=12, description="School ID"),
     *             @OA\Property(property="sesn", type="integer", example=2025, description="Academic session (e.g., 2025)"),
     *             @OA\Property(property="trm", type="integer", example=1, description="Term number (1, 2, or 3)"),
     *             @OA\Property(property="clsm", type="integer", example=16, description="New main class ID"),
     *             @OA\Property(property="suid", type="string", example="HGC/STAFF/4", description="Unique staff code or identifier"),
     *             @OA\Property(property="role", type="string", nullable=true, example="Form Teacher", description="(Optional) Primary role for the reposted staff"),
     *             @OA\Property(property="role2", type="string", nullable=true, example="Subject Coordinator", description="(Optional) Secondary role for the reposted staff")
     *         )
     *     ),
     *
     *     @OA\Response(
     *         response=200,
     *         description="Staff successfully re-posted",
     *         @OA\JsonContent(
     *             @OA\Property(property="status", type="boolean", example=true),
     *             @OA\Property(property="message", type="string", example="Staff re-posted successfully"),
     *             @OA\Property(
     *                 property="pld",
     *                 type="object",
     *                 @OA\Property(property="stid", type="integer", example=2073),
     *                 @OA\Property(property="suid", type="string", example="HGC/STAFF/4"),
     *                 @OA\Property(property="ssn", type="integer", example=2025),
     *                 @OA\Property(property="trm", type="integer", example=1),
     *                 @OA\Property(property="clsm", type="integer", example=16),
     *                 @OA\Property(property="role", type="string", example="Form Teacher"),
     *                 @OA\Property(property="role2", type="string", example="Subject Coordinator")
     *             )
     *         )
     *     ),
     *
     *     @OA\Response(
     *         response=404,
     *         description="Staff not found",
     *         @OA\JsonContent(
     *             @OA\Property(property="status", type="boolean", example=false),
     *             @OA\Property(property="message", type="string", example="Staff not found")
     *         )
     *     ),
     *
     *     @OA\Response(
     *         response=422,
     *         description="Validation error or invalid data",
     *         @OA\JsonContent(
     *             @OA\Property(property="message", type="string", example="The given data was invalid."),
     *             @OA\Property(property="errors", type="object")
     *         )
     *     )
     * )
     */


    public function rePostStaff(Request $request)
    {
        $request->validate([
            'stid' => 'required',   // staff id
            'schid' => 'required',  // school id
            'sesn' => 'required',   // session
            'trm' => 'required',    // term
            'clsm' => 'required',   // main class
            'suid' => 'required',   // staff unique id
            'role' => 'nullable',
            'role2' => 'nullable',
        ]);

        // 1 Find the staff record
        $staff = DB::table('staff')->where('sid', $request->stid)->first();
        if (!$staff) {
            return response()->json([
                'status' => false,
                'message' => 'Staff not found',
            ], 404);
        }

        // 2 Generate deterministic UID for staff_class & old_staff
        $uid = $request->sesn . $request->trm . $request->stid . $request->clsm;

        // 3 Check if staff_class already has this combination
        $existingClass = DB::table('staff_class')->where([
            'stid' => $request->stid,
            'cls' => $request->clsm,
            'ssn' => $request->sesn,
            'trm' => $request->trm,
        ])->first();

        // 4 UPDATE OR CREATE staff_class
        if ($existingClass) {
            DB::table('staff_class')->where('uid', $existingClass->uid)->update([
                'uid' => $uid,
                'updated_at' => now(),
            ]);
        } else {
            DB::table('staff_class')->insert([
                'uid' => $uid,
                'stid' => $request->stid,
                'cls' => $request->clsm,
                'schid' => $request->schid,
                'ssn' => $request->sesn,
                'trm' => $request->trm,
                'created_at' => now(),
                'updated_at' => now(),
            ]);
        }

        // 5 Prepare role values
        $roleValue = $request->role ?? $staff->role;
        $role2Value = $request->role2 ?? $staff->role2;

        // 6 Check if old_staff already has a record for this staff, session, and term
        $existingOld = DB::table('old_staff')->where([
            'sid' => $request->stid,
            'ssn' => $request->sesn,
            'trm' => $request->trm,
        ])->first();

        // 7 UPDATE OR CREATE old_staff
        if ($existingOld) {
            DB::table('old_staff')->where('uid', $existingOld->uid)->update([
                'uid' => $uid,
                'suid' => $request->suid,
                'clsm' => $request->clsm,
                'role' => $roleValue,
                'role2' => $role2Value,
                'updated_at' => now(),
            ]);
        } else {
            DB::table('old_staff')->insert([
                'uid' => $uid,
                'sid' => $request->stid,
                'schid' => $request->schid,
                'fname' => $staff->fname,
                'mname' => $staff->mname,
                'lname' => $staff->lname,
                'status' => 'active',
                'suid' => $request->suid,
                'ssn' => $request->sesn,
                'trm' => $request->trm,
                'clsm' => $request->clsm,
                'role' => $roleValue,
                'role2' => $role2Value,
                'more' => '',
                'created_at' => now(),
                'updated_at' => now(),
            ]);
        }

        // 8 Return JSON response in your requested format
        return response()->json([
            'status' => true,
            'message' => $existingClass
                ? 'Staff record updated successfully.'
                : 'Staff posted successfully.',
            'pld' => [
                'stid' => $request->stid,
                'suid' => $request->suid,
                'ssn' => $request->sesn,
                'trm' => $request->trm,
                'clsm' => $request->clsm,
                'role' => $roleValue,
                'role2' => $role2Value,
            ],
        ]);
    }




    /**
     * @OA\Get(
     *     path="/api/getAllSchoolsInfoRecord",
     *     summary="Retrieve all school information records with optional filters",
     *     description="Returns a paginated list of schools with statistics such as active learners, alumni, staff, and web data information.",
     *     tags={"Admin"},
     *     security={{"bearerAuth":{}}},
     *
     *     @OA\Parameter(
     *         name="start",
     *         in="query",
     *         description="The offset (starting point) for pagination. Default is 0.",
     *         required=false,
     *         @OA\Schema(type="integer", example=0)
     *     ),
     *     @OA\Parameter(
     *         name="count",
     *         in="query",
     *         description="Number of records to return. Default is 20.",
     *         required=false,
     *         @OA\Schema(type="integer", example=20)
     *     ),
     *     @OA\Parameter(
     *         name="state",
     *         in="query",
     *         description="Filter schools by state.",
     *         required=false,
     *         @OA\Schema(type="string", example="Lagos")
     *     ),
     *     @OA\Parameter(
     *         name="lga",
     *         in="query",
     *         description="Filter schools by LGA (Local Government Area).",
     *         required=false,
     *         @OA\Schema(type="string", example="Ikeja")
     *     ),
     *     @OA\Parameter(
     *         name="ssn",
     *         in="query",
     *         description="Filter results by academic session.",
     *         required=false,
     *         @OA\Schema(type="string", example="2024/2025")
     *     ),
     *     @OA\Parameter(
     *         name="trm",
     *         in="query",
     *         description="Filter results by academic term.",
     *         required=false,
     *         @OA\Schema(type="string", example="First Term")
     *     ),
     *
     *     @OA\Response(
     *         response=200,
     *         description="Successful response with school records",
     *         @OA\JsonContent(
     *             type="object",
     *             @OA\Property(property="status", type="boolean", example=true),
     *             @OA\Property(property="message", type="string", example="Success"),
     *             @OA\Property(property="total_records", type="integer", example=56),
     *             @OA\Property(
     *                 property="pld",
     *                 type="array",
     *                 @OA\Items(
     *                     type="object",
     *                     @OA\Property(
     *                         property="s",
     *                         type="object",
     *                         @OA\Property(property="sid", type="string", example="2439"),
     *                         @OA\Property(property="school_id", type="string", example="AHS/2439"),
     *                         @OA\Property(property="name", type="string", example="ABC High School"),
     *                         @OA\Property(property="count", type="string", example="48"),
     *                         @OA\Property(property="s_web", type="string", example="0"),
     *                         @OA\Property(property="s_info", type="string", example="0"),
     *                         @OA\Property(property="sbd", type="string", example="abchs"),
     *                         @OA\Property(property="sch3", type="string", example="AHS"),
     *                         @OA\Property(property="cssn", type="string", example="0"),
     *                         @OA\Property(property="ctrm", type="string", example="0"),
     *                         @OA\Property(property="ctrmn", type="string", example="0"),
     *                         @OA\Property(property="lattitude", type="string", nullable=true, example=null),
     *                         @OA\Property(property="longitude", type="string", nullable=true, example=null),
     *                         @OA\Property(property="country", type="string", example="N/A"),
     *                         @OA\Property(property="state", type="string", example="N/A"),
     *                         @OA\Property(property="lga", type="string", example="N/A"),
     *                         @OA\Property(property="created_at", type="string", example="2025-09-23 05:00:21"),
     *                         @OA\Property(property="updated_at", type="string", example="2025-09-23 05:00:21"),
     *                         @OA\Property(property="active_learners", type="integer", example=0),
     *                         @OA\Property(property="alumni", type="integer", example=0),
     *                         @OA\Property(property="active_staff", type="integer", example=0),
     *                         @OA\Property(
     *                             property="classes",
     *                             type="array",
     *                             @OA\Items(type="string", example="JSS1A")
     *                         ),
     *                         @OA\Property(property="total_classes", type="integer", example=4)
     *                     ),
     *                     @OA\Property(
     *                         property="w",
     *                         type="object",
     *                         nullable=true,
     *                         @OA\Property(property="user_id", type="string", example="2439"),
     *                         @OA\Property(property="school_name", type="string", example="ABC High School"),
     *                         @OA\Property(property="color", type="string", example="#123456"),
     *                         @OA\Property(property="address", type="string", example="12 Palm Street, Ikeja"),
     *                         @OA\Property(property="country", type="string", example="Nigeria"),
     *                         @OA\Property(property="state", type="string", example="Lagos"),
     *                         @OA\Property(property="lga", type="string", example="Ikeja"),
     *                         @OA\Property(property="phone", type="string", example="+2348012345678"),
     *                         @OA\Property(property="email", type="string", example="info@abchs.edu.ng"),
     *                         @OA\Property(property="vision", type="string", example="To be the best learning institution."),
     *                         @OA\Property(property="values", type="string", example="Discipline, Excellence, Innovation"),
     *                         @OA\Property(property="year", type="string", example="2005"),
     *                         @OA\Property(property="about", type="string", example="ABC High School is committed to academic excellence."),
     *                         @OA\Property(property="motto", type="string", example="Knowledge is Power"),
     *                         @OA\Property(property="facebook", type="string", example="facebook.com/abchs"),
     *                         @OA\Property(property="instagram", type="string", example="instagram.com/abchs"),
     *                         @OA\Property(property="youtube", type="string", example="youtube.com/abchs"),
     *                         @OA\Property(property="whatsapp", type="string", example="+2348012345678"),
     *                         @OA\Property(property="linkedin", type="string", example="linkedin.com/company/abchs"),
     *                         @OA\Property(property="twitter", type="string", example="@abchs"),
     *                         @OA\Property(property="created_at", type="string", example="2025-09-23 05:00:21"),
     *                         @OA\Property(property="updated_at", type="string", example="2025-09-23 05:00:21")
     *                     )
     *                 )
     *             )
     *         )
     *     ),
     *
     *     @OA\Response(
     *         response=500,
     *         description="Server error",
     *         @OA\JsonContent(
     *             @OA\Property(property="status", type="boolean", example=false),
     *             @OA\Property(property="message", type="string", example="Error: Database connection failed")
     *         )
     *     )
     * )
     */


    public function getAllSchoolsInfoRecord(Request $request)
    {
        try {
            //  Filters
            $start = $request->input('start', 0);
            $count = $request->input('count', 20);
            $state = $request->input('state');
            $lga = $request->input('lga');
            $ssnYear = $request->input('ssn'); // academic year
            $trmNo = $request->input('trm');   // term number

            //  Resolve session name (e.g., "2024"  "2024/2025")
            $sessionName = null;
            if (!empty($ssnYear)) {
                $sessionRecord = DB::table('sesn')->where('year', $ssnYear)->first();
                $sessionName = $sessionRecord ? $sessionRecord->name : null;
            }

            //  Resolve term name (e.g., "1"  "First Term")
            $termName = null;
            if (!empty($trmNo)) {
                $termRecord = DB::table('trm')->where('no', $trmNo)->first();
                $termName = $termRecord ? $termRecord->name : null;
            }

            //  Base query with join
            $query = DB::table('school as s')
                ->leftJoin('school_web_data as sw', 's.sid', '=', 'sw.user_id')
                ->select('s.*', 'sw.state as web_state', 'sw.lga as web_lga', 'sw.country as web_country');

            if (!empty($state))
                $query->where('sw.state', $state);
            if (!empty($lga))
                $query->where('sw.lga', $lga);

            //  Get total before pagination
            $totalRecords = $query->count();

            //  Apply pagination
            $schools = $query->orderBy('s.name', 'asc')
                ->skip($start)
                ->take($count)
                ->get();

            if ($schools->isEmpty()) {
                return response()->json([
                    "status" => true,
                    "message" => "No schools found",
                    "total_records" => 0,
                    "pld" => [],
                ]);
            }

            //  Collect all school IDs for bulk queries
            $schoolIds = $schools->pluck('sid')->toArray();

            //  Bulk fetch active learners with optional session/term
            $learnersQuery = DB::table('old_student')
                ->whereIn('schid', $schoolIds)
                ->where('status', 'active');

            if ($sessionName)
                $learnersQuery->where('ssn', $sessionName);
            if ($termName)
                $learnersQuery->where('trm', $termName);

            $learners = $learnersQuery
                ->select('schid', DB::raw('COUNT(DISTINCT sid) as active_learners'))
                ->groupBy('schid')
                ->pluck('active_learners', 'schid');

            //  Bulk fetch alumni
            $alumni = DB::table('alumnis')
                ->whereIn('schid', $schoolIds)
                ->select('schid', DB::raw('COUNT(*) as alumni_count'))
                ->groupBy('schid')
                ->pluck('alumni_count', 'schid');

            //  Bulk fetch active staff with optional session/term
            $staffQuery = DB::table('old_staff')
                ->whereIn('schid', $schoolIds)
                ->where('status', 'active');

            if ($sessionName)
                $staffQuery->where('ssn', $sessionName);
            if ($termName)
                $staffQuery->where('trm', $termName);

            $staff = $staffQuery
                ->select('schid', DB::raw('COUNT(DISTINCT sid) as active_staff'))
                ->groupBy('schid')
                ->pluck('active_staff', 'schid');

            //  Bulk fetch classes grouped by school
            $classes = DB::table('sch_cls')
                ->whereIn('schid', $schoolIds)
                ->get(['schid', 'cls_id', 'name'])
                ->groupBy('schid')
                ->map(function ($items) {
                    return $items->groupBy('cls_id')
                        ->map(fn($i) => $i->pluck('name')->toArray())
                        ->toArray();
                });

            //  Bulk fetch web data
            $webData = DB::table('school_web_data')
                ->whereIn('user_id', $schoolIds)
                ->get()
                ->keyBy('user_id');

            $pld = [];

            foreach ($schools as $school) {
                $sid = $school->sid;
                $schoolCode = strtoupper($school->sch3) . '/' . str_pad($sid, 4, '0', STR_PAD_LEFT);

                $pld[] = [
                    's' => [
                        'sid' => (string) $sid,
                        'school_id' => $schoolCode,
                        'name' => $school->name,
                        'count' => (string) $school->count,
                        's_web' => $school->s_web,
                        's_info' => $school->s_info,
                        'sbd' => $school->sbd,
                        'sch3' => $school->sch3,
                        'cssn' => $school->cssn,
                        'ctrm' => $school->ctrm,
                        'ctrmn' => $school->ctrmn,
                        'lattitude' => $school->latt,
                        'longitude' => $school->longi,
                        'country' => $school->web_country ?? 'N/A',
                        'state' => $school->web_state ?? 'N/A',
                        'lga' => $school->web_lga ?? 'N/A',
                        'created_at' => $school->created_at,
                        'updated_at' => $school->updated_at,
                        'active_learners' => $learners[$sid] ?? 0,
                        'alumni' => $alumni[$sid] ?? 0,
                        'active_staff' => $staff[$sid] ?? 0,
                        'classes' => $classes[$sid] ?? [],
                        'total_classes' => count($classes[$sid] ?? []),
                    ],
                    'w' => isset($webData[$sid]) ? [
                        'user_id' => $webData[$sid]->user_id,
                        'school_name' => $webData[$sid]->sname ?? 'N/A',
                        'color' => $webData[$sid]->color ?? 'N/A',
                        'address' => $webData[$sid]->addr ?? 'N/A',
                        'country' => $webData[$sid]->country ?? 'N/A',
                        'state' => $webData[$sid]->state ?? 'N/A',
                        'lga' => $webData[$sid]->lga ?? 'N/A',
                        'phone' => $webData[$sid]->phn ?? 'N/A',
                        'email' => $webData[$sid]->eml ?? 'N/A',
                        'vision' => $webData[$sid]->vision ?? 'N/A',
                        'values' => $webData[$sid]->values ?? 'N/A',
                        'year' => $webData[$sid]->year ?? 'N/A',
                        'about' => $webData[$sid]->about ?? 'N/A',
                        'motto' => $webData[$sid]->motto ?? 'N/A',
                        'facebook' => $webData[$sid]->fb ?? 'N/A',
                        'instagram' => $webData[$sid]->isg ?? 'N/A',
                        'youtube' => $webData[$sid]->yt ?? 'N/A',
                        'whatsapp' => $webData[$sid]->wh ?? 'N/A',
                        'linkedin' => $webData[$sid]->lkd ?? 'N/A',
                        'twitter' => $webData[$sid]->tw ?? 'N/A',
                        'created_at' => $webData[$sid]->created_at,
                        'updated_at' => $webData[$sid]->updated_at,
                    ] : null,
                ];
            }

            return response()->json([
                "status" => true,
                "message" => "Success",
                "total_records" => $totalRecords,
                "session_used" => $sessionName ?? 'All Sessions',
                "term_used" => $termName ?? 'All Terms',
                "pld" => $pld,
            ]);

        } catch (\Exception $e) {
            return response()->json([
                "status" => false,
                "message" => "Error: " . $e->getMessage(),
            ], 500);
        }
    }



    /**
     * @OA\Post(
     *     path="/api/updateAccountsBySchoolAndClass",
     *     summary="Update accounts and subaccounts for a school and class",
     *     tags={"Accounts"},
     *    security={{"bearerAuth":{}}},
     *     description="Updates clsid and optionally pay_head_id for all accounts and subaccounts for a given school and current class",
     *     @OA\RequestBody(
     *         required=true,
     *         @OA\JsonContent(
     *             required={"schid","clsid","new_clsid"},
     *             @OA\Property(property="schid", type="integer", example=74, description="School ID"),
     *             @OA\Property(property="clsid", type="integer", example=2, description="Current Class ID to match"),
     *             @OA\Property(property="new_clsid", type="integer", example=5, description="New Class ID to update to"),
     *             @OA\Property(property="pay_head_id", type="integer", example=214, description="Optional pay head ID")
     *         )
     *     ),
     *     @OA\Response(
     *         response=200,
     *         description="Accounts and subaccounts updated successfully",
     *         @OA\JsonContent(
     *             @OA\Property(property="status", type="boolean", example=true),
     *             @OA\Property(property="message", type="string", example="Accounts and subaccounts updated successfully."),
     *             @OA\Property(property="updated_count", type="integer", example=3)
     *         )
     *     ),
     *     @OA\Response(
     *         response=404,
     *         description="No accounts found for this school and class",
     *         @OA\JsonContent(
     *             @OA\Property(property="status", type="boolean", example=false),
     *             @OA\Property(property="message", type="string", example="No accounts found for this school and class.")
     *         )
     *     ),
     *     @OA\Response(
     *         response=422,
     *         description="Validation error",
     *         @OA\JsonContent(
     *             @OA\Property(property="message", type="string", example="The schid field is required."),
     *             @OA\Property(property="errors", type="object")
     *         )
     *     )
     * )
     */

    public function updateAccountsBySchoolAndClass(Request $request)
    {
        // Validate request
        $request->validate([
            'schid' => 'required|integer',          // school id
            'clsid' => 'required|integer',          // current class id to match
            'new_clsid' => 'required|integer',      // new class id to update to
            'pay_head_id' => 'nullable|integer',    // new pay_head_id (optional)
        ]);

        $schid = $request->schid;
        $clsid = $request->clsid;
        $newClsid = $request->new_clsid;
        $newPayHeadId = $request->pay_head_id;

        // Fetch all accounts for the school with the selected class.
        $accounts = accts::where('schid', $schid)
            ->where('clsid', $clsid)
            ->get();

        if ($accounts->isEmpty()) {
            return response()->json([
                'status' => false,
                'message' => 'No accounts found for this school and class.'
            ], 404);
        }

        foreach ($accounts as $acct) {
            // Update the accts table
            $acct->update([
                'clsid' => $newClsid,
                'pay_head_id' => $newPayHeadId ?? $acct->pay_head_id,
            ]);

            // Update all related sub_accounts
            $acct->subAccounts()->update([
                'clsid' => $newClsid,
                'pay_head_id' => $newPayHeadId ?? $acct->pay_head_id,
            ]);
        }

        return response()->json([
            'status' => true,
            'message' => 'Accounts and subaccounts updated successfully.',
            'updated_count' => $accounts->count()
        ]);
    }




    /**
     * @OA\Post(
     *     path="/api/addAdmissionInfo",
     *     summary="Add or update admission information for an existing student",
     *     description="Updates the admission details (session, term, class, and date) for a specific student based on `sid` and `schid`.",
     *     tags={"Api"},
     *     security={{"bearerAuth":{}}},
     *     operationId="addAdmissionInfo",
     *     @OA\RequestBody(
     *         required=true,
     *         @OA\JsonContent(
     *             required={"sid","schid","adm_ssn","adm_trm","cls_of_adm","date_of_adm"},
     *             @OA\Property(property="sid", type="string", example="1000", description="Unique student ID"),
     *             @OA\Property(property="schid", type="string", example="13", description="School ID"),
     *             @OA\Property(property="adm_ssn", type="string", example="2024/2025", description="Admission Session"),
     *             @OA\Property(property="adm_trm", type="string", example="2nd Term", description="Admission Term"),
     *             @OA\Property(property="cls_of_adm", type="string", example="JSS1", description="Class of Admission"),
     *             @OA\Property(property="date_of_adm", type="string", format="date", example="2025-11-13", description="Date of Admission")
     *         )
     *     ),
     *     @OA\Response(
     *         response=200,
     *         description="Admission information added successfully",
     *         @OA\JsonContent(
     *             @OA\Property(property="status", type="boolean", example=true),
     *             @OA\Property(property="message", type="string", example="Admission information added successfully.")
     *         )
     *     ),
     *     @OA\Response(
     *         response=404,
     *         description="No record found or update failed",
     *         @OA\JsonContent(
     *             @OA\Property(property="status", type="boolean", example=false),
     *             @OA\Property(property="message", type="string", example="No record found for this student and school or update failed.")
     *         )
     *     ),
     *     @OA\Response(
     *         response=422,
     *         description="Validation error",
     *         @OA\JsonContent(
     *             @OA\Property(property="message", type="string", example="The adm_ssn field is required.")
     *         )
     *     )
     * )
     */


    public function addAdmissionInfo(Request $request)
    {
        //  Validate input
        $request->validate([
            "sid" => "required|integer",
            "schid" => "required|integer",
            "adm_ssn" => "required|string",       // Admission Session
            "adm_trm" => "required|string",       // Admission Term
            "cls_of_adm" => "required|string",    // Class of Admission
            "date_of_adm" => "required|date"      // Date of Admission
        ]);

        // Data to update in both tables
        $updateData = [
            'adm_ssn' => $request->adm_ssn,
            'adm_trm' => $request->adm_trm,
            'cls_of_adm' => $request->cls_of_adm,
            'date_of_adm' => $request->date_of_adm,
        ];

        // Update old_student table
        $oldStudentUpdated = old_student::where('sid', $request->sid)
            ->where('schid', $request->schid)
            ->update($updateData);

        // Update student table
        $studentUpdated = student::where('sid', $request->sid)
            ->where('schid', $request->schid)
            ->update($updateData);

        // Handle no record updated
        if (!$oldStudentUpdated && !$studentUpdated) {
            return response()->json([
                "status" => false,
                "message" => "No matching record found in either table or update failed."
            ], 404);
        }

        return response()->json([
            "status" => true,
            "message" => "Admission information updated successfully in both tables."
        ]);
    }





    /**
     * @OA\Put(
     *     path="/api/approveAdmission",
     *     summary="Approve a student's admission",
     *     description="Updates the adm_status to true when the user clicks the approve button.",
     *     operationId="approveAdmission",
     *     tags={"Api"},
     *    security={{"bearerAuth":{}}},
     *     @OA\RequestBody(
     *         required=true,
     *         @OA\JsonContent(
     *             required={"sid", "schid"},
     *             @OA\Property(property="sid", type="integer", example=1000),
     *             @OA\Property(property="schid", type="integer", example=13)
     *         )
     *     ),
     *     @OA\Response(
     *         response=200,
     *         description="Admission approved successfully",
     *         @OA\JsonContent(
     *             @OA\Property(property="status", type="boolean", example=true),
     *             @OA\Property(property="message", type="string", example="Admission approved successfully.")
     *         )
     *     ),
     *     @OA\Response(
     *         response=404,
     *         description="Student record not found or update failed"
     *     ),
     *     @OA\Response(
     *         response=500,
     *         description="Internal server error"
     *     )
     * )
     */
    public function approveAdmission(Request $request)
    {
        // Validate input
        $request->validate([
            "sid" => "required|integer",
            "schid" => "required|integer"
        ]);

        $updated = student::where('sid', $request->sid)
            ->where('schid', $request->schid)
            ->update(['adm_status' => 1]);

        // Update adm_status to 1 (approved)
        $updatedOld = old_student::where('sid', $request->sid)
            ->where('schid', $request->schid)
            ->update(['adm_status' => 1]);

        //  Handle case where no record was updated
        if (!$updated && !$updatedOld) {
            return response()->json([
                "status" => false,
                "message" => "No record found for this student or update failed."
            ], 404);
        }

        return response()->json([
            "status" => true,
            "message" => "Admission approved successfully."
        ]);
    }




    /**
     * @OA\Get(
     *     path="/api/getOldStudentsAndSubjects/{schid}/{ssn}/{trm}/{clsm}/{clsa}/{stf}",
     *     summary="Get old students and their subjects",
     *     tags={"Api"},
     *    security={{"bearerAuth":{}}},
     *
     *     @OA\Parameter(
     *         name="schid",
     *         in="path",
     *         required=true,
     *         description="School ID",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Parameter(
     *         name="ssn",
     *         in="path",
     *         required=true,
     *         description="Session (academic year)",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Parameter(
     *         name="trm",
     *         in="path",
     *         required=true,
     *         description="Term number",
     *         @OA\Schema(type="integer")
     *     ),
     *     @OA\Parameter(
     *         name="clsm",
     *         in="path",
     *         required=true,
     *         description="Class (e.g., 11)",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Parameter(
     *         name="clsa",
     *         in="path",
     *         required=true,
     *         description="Class section (`-1` means all sections)",
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Parameter(
     *         name="stf",
     *         in="path",
     *         required=true,
     *         description="Staff ID (`-1` if not used)",
     *         @OA\Schema(type="string")
     *     ),
     *
     *     @OA\Response(
     *         response=200,
     *         description="Success"
     *     )
     * )
     */
    public function getOldStudentsAndSubjects($schid, $ssn, $trm, $clsm, $clsa, $stf)
    {
        //  Pagination
        $start = request()->input('start', 0);   // default 0
        $count = request()->input('count', 20);  // default 20

        //  Get students with filters
        $ostdQuery = old_student::where("schid", $schid)
            ->where("ssn", $ssn)
            ->where("trm", $trm)
            ->where("clsm", $clsm)
            ->when($clsa != '-1', function ($q) use ($clsa) {
                $q->where("clsa", $clsa);
            })
            ->where("status", "active")
            ->orderBy('lname', 'asc');

        $totalStudents = $ostdQuery->count();

        // Apply pagination
        $ostd = $ostdQuery->skip($start)->take($count)->get();

        //  Get class subjects (IDs + details)
        $classSubjects = class_subj::where("schid", $schid)
            ->where("clsid", $clsm)
            ->where("sesn", $ssn)
            ->where("trm", $trm)
            ->get();

        $classSubjectIds = $classSubjects->pluck('subj_id')->map(fn($id) => (string) $id)->toArray();

        // Get all student subjects at once (include term/session)
        $studentSubjectsMap = student_subj::whereIn('stid', $ostd->pluck('sid'))
            ->where("schid", $schid)
            ->where("clsid", $clsm)
            ->where("ssn", $ssn)
            ->where("trm", $trm)
            ->get()
            ->groupBy('stid')
            ->map(function ($items) {
                return $items->pluck('sbj')->map(fn($id) => (string) $id)->toArray();
            });

        // Prepare student payload
        $stdPld = [];
        foreach ($ostd as $std) {
            $user_id = $std->sid;

            // Get subjects actually assigned to this student
            $studentSubjects = $studentSubjectsMap[$user_id] ?? [];

            // Only include subjects that are both in classSubjects and actually assigned
            $filteredSubjects = array_values(array_filter($classSubjectIds, fn($id) => in_array($id, $studentSubjects)));

            $stdPld[] = [
                'std' => $std,
                'sbj' => $filteredSubjects,
            ];
        }

        // Prepare class subject payload
        $clsSbj = $classSubjects->map(function ($subj) {
            return [
                'id' => (string) $subj->subj_id,
                'name' => $subj->name,
                'comp' => (string) $subj->comp,
            ];
        });

        // 6 Return structured JSON
        return response()->json([
            "status" => true,
            "message" => "Success",
            "pld" => [
                "std-pld" => $stdPld,
                "cls-sbj" => $clsSbj,
            ],
            "pagination" => [
                "start" => $start,
                "count" => $count,
                "total" => $totalStudents,
                "returned" => count($stdPld),
            ],
        ]);
    }



    /**
     * @OA\Post(
     *     path="/api/setStudentSubjectBulk",
     *     summary="Assign multiple subjects to multiple students",
     *     description="Bulk assign subjects to students. It checks for existing assignments and only inserts new ones. Also updates class subjects if needed.",
     *     operationId="setStudentSubjectBulk",
     *     tags={"Api"},
     *   security={{"bearerAuth":{}}},
     *     @OA\RequestBody(
     *         required=true,
     *         @OA\JsonContent(
     *             type="object",
     *             required={"uid","stid","sbj","comp","schid"},
     *             @OA\Property(
     *                 property="uid",
     *                 type="string",
     *                 description="UID of the user performing the action"
     *             ),
     *             @OA\Property(
     *                 property="stid",
     *                 type="array",
     *                 description="Array of student IDs to assign subjects",
     *                 @OA\Items(type="integer")
     *             ),
     *             @OA\Property(
     *                 property="sbj",
     *                 type="array",
     *                 description="Array of subject IDs to assign",
     *                 @OA\Items(type="integer")
     *             ),
     *             @OA\Property(
     *                 property="comp",
     *                 type="integer",
     *                 description="Subject component"
     *             ),
     *             @OA\Property(
     *                 property="schid",
     *                 type="integer",
     *                 description="School ID"
     *             ),
     *             @OA\Property(
     *                 property="clsid",
     *                 type="integer",
     *                 description="Class ID (optional)"
     *             ),
     *             @OA\Property(
     *                 property="trm",
     *                 type="integer",
     *                 description="Term (optional)"
     *             ),
     *             @OA\Property(
     *                 property="ssn",
     *                 type="integer",
     *                 description="Session (optional)"
     *             )
     *         )
     *     ),
     *     @OA\Response(
     *         response=200,
     *         description="Subjects assignment completed successfully",
     *         @OA\JsonContent(
     *             type="object",
     *             @OA\Property(property="status", type="boolean", example=true),
     *             @OA\Property(property="message", type="string", example="Subjects assignment completed."),
     *             @OA\Property(
     *                 property="assigned",
     *                 type="array",
     *                 description="List of newly assigned student-subject pairs",
     *                 @OA\Items(
     *                     type="object",
     *                     @OA\Property(property="stid", type="integer", example=564),
     *                     @OA\Property(property="sbj", type="integer", example=1)
     *                 )
     *             ),
     *             @OA\Property(
     *                 property="skipped",
     *                 type="array",
     *                 description="List of skipped student-subject pairs that already existed",
     *                 @OA\Items(
     *                     type="object",
     *                     @OA\Property(property="stid", type="integer", example=564),
     *                     @OA\Property(property="sbj", type="integer", example=126)
     *                 )
     *             )
     *         )
     *     ),
     *     @OA\Response(
     *         response=422,
     *         description="Validation error",
     *         @OA\JsonContent(
     *             type="object",
     *             @OA\Property(property="message", type="string", example="The stid field is required."),
     *             @OA\Property(property="errors", type="object")
     *         )
     *     )
     * )
     */

    public function setStudentSubjectBulk(Request $request)
    {
        // Validate request
        $request->validate([
            "stid" => "required", // single or array of student IDs
            "sbj" => "required",  // single or array of subject IDs
            "comp" => "required",
            "schid" => "required",
            "clsid" => "nullable",
            "trm" => "nullable",
            "ssn" => "nullable"
        ]);

        $students = is_array($request->stid) ? $request->stid : [$request->stid];
        $subjects = is_array($request->sbj) ? $request->sbj : [$request->sbj];

        $assigned = [];
        $skipped = [];

        $bulkInsert = [];

        // 1 Prepare all student-subject records with generated UID
        foreach ($students as $stid) {
            foreach ($subjects as $sbj) {
                $uid = $request->schid
                    . ($request->clsid ?? '00')
                    . ($request->ssn ?? '0000')
                    . ($request->trm ?? '0')
                    . $sbj
                    . $stid; // optional: include student ID to make UID unique per student

                $bulkInsert[] = [
                    "uid" => $uid, //  generated UID
                    "stid" => $stid,
                    "sbj" => $sbj,
                    "comp" => $request->comp,
                    "schid" => $request->schid,
                    "clsid" => $request->clsid,
                    "trm" => $request->trm,
                    "ssn" => $request->ssn,
                    "created_at" => now(),
                    "updated_at" => now(),
                ];
            }
        }

        // 2 Fetch existing student-subject records to avoid duplicates
        $existing = student_subj::whereIn('stid', $students)
            ->whereIn('sbj', $subjects)
            ->where('schid', $request->schid)
            ->when($request->clsid, fn($q) => $q->where('clsid', $request->clsid))
            ->when($request->trm, fn($q) => $q->where('trm', $request->trm))
            ->when($request->ssn, fn($q) => $q->where('ssn', $request->ssn))
            ->get(['stid', 'sbj'])
            ->map(fn($row) => $row->stid . '-' . $row->sbj)
            ->toArray();

        // 3 Filter out existing records
        $toInsert = array_filter($bulkInsert, function ($item) use ($existing, &$assigned, &$skipped) {
            $key = $item['stid'] . '-' . $item['sbj'];
            if (in_array($key, $existing)) {
                $skipped[] = ["stid" => $item['stid'], "sbj" => $item['sbj']];
                return false;
            } else {
                $assigned[] = ["stid" => $item['stid'], "sbj" => $item['sbj']];
                return true;
            }
        });

        // 4 Bulk insert new student-subject records
        if (!empty($toInsert)) {
            student_subj::insert($toInsert);
        }

        // 5 Handle class subjects (updateOrCreate) with UID based on schema
        foreach ($subjects as $sbj) {
            $uid = $request->schid
                . ($request->clsid ?? '00')
                . ($request->ssn ?? '0000')
                . ($request->trm ?? '0')
                . $sbj;

            class_subj::updateOrCreate(
                [
                    "subj_id" => $sbj,
                    "schid" => $request->schid,
                    "clsid" => $request->clsid,
                    "sesn" => $request->ssn,
                    "trm" => $request->trm,
                ],
                [
                    "uid" => $uid, //  UID now in desired format
                    "comp" => $request->comp,
                    "name" => subj::find($sbj)?->name, // optional
                ]
            );
        }

        return response()->json([
            "status" => true,
            "message" => "Subjects assignment completed.",
            "assigned" => $assigned,
            "skipped" => $skipped,
        ]);
    }




    /**
     * @OA\Get(
     *     path="/api/getStudentSubjectBulk",
     *     summary="Retrieve bulk student subject records",
     *     description="Retrieve student subjects with optional filters: school, class, class arm, session, term, and pagination.",
     *     tags={"Api"},
     *      security={{"bearerAuth":{}}},
     *     @OA\Parameter(
     *         name="schid",
     *         in="query",
     *         description="School ID",
     *         required=false,
     *         @OA\Schema(type="integer")
     *     ),
     *     @OA\Parameter(
     *         name="clsid",
     *         in="query",
     *         description="Class ID",
     *         required=false,
     *         @OA\Schema(type="integer")
     *     ),
     *     @OA\Parameter(
     *         name="clsa",
     *         in="query",
     *         description="Class arm ID",
     *         required=false,
     *         @OA\Schema(type="integer")
     *     ),
     *     @OA\Parameter(
     *         name="ssn",
     *         in="query",
     *         description="Session (e.g., 2025)",
     *         required=false,
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Parameter(
     *         name="trm",
     *         in="query",
     *         description="Term (e.g., 1)",
     *         required=false,
     *         @OA\Schema(type="string")
     *     ),
     *     @OA\Parameter(
     *         name="start",
     *         in="query",
     *         description="Pagination start index",
     *         required=false,
     *         @OA\Schema(type="integer", default=0)
     *     ),
     *     @OA\Parameter(
     *         name="count",
     *         in="query",
     *         description="Number of records to return",
     *         required=false,
     *         @OA\Schema(type="integer", default=200)
     *     ),
     *     @OA\Response(
     *         response=200,
     *         description="Successful response",
     *         @OA\JsonContent(
     *             type="object",
     *             @OA\Property(property="status", type="boolean", example=true),
     *             @OA\Property(property="message", type="string", example="Success"),
     *             @OA\Property(
     *                 property="pld",
     *                 type="array",
     *                 @OA\Items(
     *                     type="object",
     *                     @OA\Property(property="id", type="integer", example=1),
     *                     @OA\Property(property="stid", type="integer", example=207),
     *                     @OA\Property(property="sbj", type="string", example="Mathematics"),
     *                     @OA\Property(property="comp", type="integer", example=1),
     *                     @OA\Property(property="trm", type="integer", example=1),
     *                     @OA\Property(property="ssn", type="string", example="2025"),
     *                     @OA\Property(property="schid", type="integer", example=13),
     *                     @OA\Property(property="clsid", type="integer", example=10),
     *                     @OA\Property(property="clsa", type="integer", example=1),
     *                     @OA\Property(property="created_at", type="string", format="date-time", example="2025-03-04T14:04:57"),
     *                     @OA\Property(property="updated_at", type="string", format="date-time", example="2025-03-04T14:04:57")
     *                 )
     *             )
     *         )
     *     ),
     *     @OA\Response(
     *         response=400,
     *         description="Bad request"
     *     )
     * )
     */


    public function getStudentSubjectBulk(Request $request)
    {
        // Optional input parameters
        $schid = $request->input('schid');
        $clsid = $request->input('clsid');
        $clsa = $request->input('clsa'); // class arm (old_student.clsa)
        $ssn = $request->input('ssn');
        $trm = $request->input('trm');

        // Pagination optional
        $start = $request->input('start', 0);
        $count = $request->input('count', 200);

        // Base query
        $query = student_subj::query()
            ->join("subj", "subj.id", "=", "student_subj.sbj")
            ->join("old_student", function ($join) {
                $join->on("old_student.sid", "=", "student_subj.stid");
            });

        // Apply filters only when provided
        if (!empty($schid)) {
            $query->where("student_subj.schid", $schid);
        }

        if (!empty($clsid)) {
            $query->where("student_subj.clsid", $clsid);
            $query->where("old_student.clsm", $clsid);
        }

        if (!empty($clsa)) {
            $query->where("old_student.clsa", $clsa); // only old_student.clsa
        }

        if (!empty($ssn)) {
            $query->where("student_subj.ssn", $ssn);
            $query->where("old_student.ssn", $ssn);
        }

        if (!empty($trm)) {
            $query->where("student_subj.trm", $trm);
            $query->where("old_student.trm", $trm);
        }

        // Select columns (removed student_subj.clsa)
        $query->select(
            "student_subj.id",
            "student_subj.stid",
            "subj.name as sbj",
            "student_subj.comp",
            "student_subj.trm",
            "student_subj.ssn",
            "student_subj.schid",
            "student_subj.clsid",
            "old_student.clsa", // include clsa from old_student
            "student_subj.created_at",
            "student_subj.updated_at"
        );

        // Execute query with pagination
        $pld = $query
            ->orderBy("student_subj.stid")
            ->skip($start)
            ->take($count)
            ->get();

        return response()->json([
            "status" => true,
            "message" => "Success",
            "pld" => $pld
        ]);
    }


    /**
     * @OA\Post(
     *     path="/api/toggleResultStatus",
     *     operationId="toggleResultStatus",
     *     tags={"Api"},
     *     summary="Toggle result publication status by class parameters",
     *     description="Toggles the `stat` field (published/unpublished) for a result based on school, class arm, class, session, and term.",
     *     security={{"bearerAuth":{}}},
     *
     *     @OA\RequestBody(
     *         required=true,
     *         @OA\JsonContent(
     *             required={"schid","clsa","clsm","ssn","trm"},
     *             @OA\Property(property="schid", type="integer", example=12, description="School ID"),
     *             @OA\Property(property="clsa", type="integer", example=3, description="Class Arm ID"),
     *             @OA\Property(property="clsm", type="integer", example=11, description="Class ID"),
     *             @OA\Property(property="ssn", type="integer", example=2024, description="Session / Academic Year"),
     *             @OA\Property(property="trm", type="integer", example=1, description="Term")
     *         )
     *     ),
     *
     *     @OA\Response(
     *         response=200,
     *         description="Result status toggled successfully",
     *         @OA\JsonContent(
     *             @OA\Property(property="status", type="boolean", example=true),
     *             @OA\Property(property="message", type="string", example="Result status updated successfully."),
     *             @OA\Property(
     *                 property="pld",
     *                 type="array",
     *                 @OA\Items(
     *                     type="object",
     *                     @OA\Property(property="clsa", type="integer", example=3),
     *                     @OA\Property(property="schid", type="integer", example=12),
     *                     @OA\Property(property="clsm", type="integer", example=11),
     *                     @OA\Property(property="ssn", type="integer", example=2024),
     *                     @OA\Property(property="trm", type="integer", example=1),
     *                     @OA\Property(
     *                         property="new_stat",
     *                         type="integer",
     *                         example=1,
     *                         description="New result status (1 = published, 0 = unpublished)"
     *                     )
     *                 )
     *             )
     *         )
     *     ),
     *
     *     @OA\Response(
     *         response=404,
     *         description="Result not found",
     *         @OA\JsonContent(
     *             @OA\Property(property="status", type="boolean", example=false),
     *             @OA\Property(property="message", type="string", example="Result not found.")
     *         )
     *     ),
     *
     *     @OA\Response(
     *         response=422,
     *         description="Validation error",
     *         @OA\JsonContent(
     *             @OA\Property(property="message", type="string", example="The given data was invalid."),
     *             @OA\Property(property="errors", type="object")
     *         )
     *     )
     * )
     */


    public function toggleResultStatus(Request $request)
    {
        $request->validate([
            'schid' => 'required',
            'clsa' => 'required',
            'clsm' => 'required',
            'ssn' => 'required',
            'trm' => 'required',
        ]);

        $schid = $request->schid;
        $clsa = $request->clsa;
        $clsm = $request->clsm;
        $ssn = $request->ssn;
        $trm = $request->trm;

        // Fetch the student result
        $result = student_res::where([
            ['schid', $schid],
            ['clsa', $clsa],
            ['clsm', $clsm],
            ['ssn', $ssn],
            ['trm', $trm],
        ])->first();

        if (!$result) {
            return response()->json([
                'status' => false,
                'message' => 'Result not found.'
            ], 404);
        }

        // Toggle the status
        $result->stat = $result->stat == 1 ? 0 : 1;
        $result->save();

        return response()->json([
            'status' => true,
            'message' => 'Result status updated successfully.',
            'pld' => [
                [
                    'clsa' => $clsa,
                    'schid' => $schid,
                    'clsm' => $clsm,
                    'ssn' => $ssn,
                    'trm' => $trm,
                    'new_stat' => $result->stat,
                ]
            ]
        ]);
    }



/**
 * @OA\Post(
 *     path="/api/assignClassSubject",
 *     operationId="assignClassSubjects",
 *     tags={"Api"},
 *     summary="Assign multiple subjects to a class",
 *     description="Assigns multiple subjects to a class for a specific session and term. Existing subject assignments are ignored.",
 *     security={{"bearerAuth":{}}},
 *
 *     @OA\RequestBody(
 *         required=true,
 *         @OA\JsonContent(
 *             required={"schid","clsid","sesn","trm","subjects"},
 *             @OA\Property(property="schid", type="string", example="1"),
 *             @OA\Property(property="clsid", type="string", example="A"),
 *             @OA\Property(property="sesn", type="string", example="2024"),
 *             @OA\Property(property="trm", type="string", example="1"),
 *             @OA\Property(
 *                 property="subjects",
 *                 type="array",
 *                 minItems=1,
 *                 @OA\Items(
 *                     type="object",
 *                     required={"subj_id","name","comp"},
 *                     @OA\Property(property="subj_id", type="string", example="100"),
 *                     @OA\Property(property="name", type="string", example="Mathematics"),
 *                     @OA\Property(property="comp", type="string", example="Core")
 *                 )
 *             )
 *         )
 *     ),
 *
 *     @OA\Response(
 *         response=200,
 *         description="Subjects assignment completed",
 *         @OA\JsonContent(
 *             @OA\Property(property="status", type="boolean", example=true),
 *             @OA\Property(property="message", type="string", example="Subjects assignment completed"),
 *             @OA\Property(
 *                 property="assigned",
 *                 type="array",
 *                 @OA\Items(type="object")
 *             ),
 *             @OA\Property(
 *                 property="skipped",
 *                 type="array",
 *                 @OA\Items(type="object")
 *             )
 *         )
 *     ),
 *
 *     @OA\Response(
 *         response=422,
 *         description="Validation error",
 *         @OA\JsonContent(
 *             @OA\Property(property="message", type="string", example="The given data was invalid."),
 *             @OA\Property(property="errors", type="object")
 *         )
 *     )
 * )
 */

public function assignClassSubject(Request $request)
{
    // Validation
    $request->validate([
        "schid" => "required",
        "clsid" => "required",
        "sesn" => "required",
        "trm" => "required",
        "subjects" => "required|array|min:1",
        "subjects.*.subj_id" => "required",
        "subjects.*.name" => "required",
        "subjects.*.comp" => "required",
    ]);

    $inserted = [];
    $skipped = [];

    foreach ($request->subjects as $subject) {

        // Check duplicate
        $exists = class_subj::where('schid', $request->schid)
            ->where('clsid', $request->clsid)
            ->where('subj_id', $subject['subj_id'])
            ->where('sesn', $request->sesn)
            ->where('trm', $request->trm)
            ->exists();

        if ($exists) {
            $skipped[] = $subject;
            continue;
        }

        // Generate UID
        $uid = $request->schid . '-' .
               $request->clsid . '-' .
               $subject['subj_id'] . '-' .
               $request->sesn . '-' .
               $request->trm;

        $inserted[] = class_subj::create([
            "uid" => $uid,
            "schid" => $request->schid,
            "clsid" => $request->clsid,
            "subj_id" => $subject['subj_id'],
            "name" => $subject['name'],
            "comp" => $subject['comp'],
            "sesn" => $request->sesn,
            "trm" => $request->trm,
        ]);
    }

    return response()->json([
        "status" => true,
        "message" => "Subjects assignment completed",
        "assigned" => $inserted,
        "skipped" => $skipped
    ]);
}




}

